{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/demo.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { DemoResponse } from \"@shared/api\";\r\n\r\nexport const handleDemo: RequestHandler = (req, res) => {\r\n  const response: DemoResponse = {\r\n    message: \"Hello from Express server\",\r\n  };\r\n  res.status(200).json(response);\r\n};\r\n"],"names":[],"mappings":";;;;AAGO,MAAM,aAA6B,CAAC,KAAK;IAC9C,MAAM,WAAyB;QAC7B,SAAS;IACX;IACA,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;AACvB"}},
    {"offset": {"line": 30, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/utils/ecwid.ts"],"sourcesContent":["// Ecwid API utility for server-side operations\r\nconst ECWID_API_URL = \"https://api.ecwid.com/api/v3\";\r\n\r\ninterface EcwidCustomer {\r\n  email: string;\r\n  firstName: string;\r\n  lastName: string;\r\n  phone?: string;\r\n  companyName?: string;\r\n  password?: string;\r\n}\r\n\r\ninterface EcwidAddress {\r\n  name: string;\r\n  street: string;\r\n  city: string;\r\n  stateOrProvinceCode: string;\r\n  postalCode: string;\r\n  countryCode: string;\r\n  companyName?: string;\r\n}\r\n\r\ninterface EcwidOrder {\r\n  id: number;\r\n  customerId: number;\r\n  email: string;\r\n  createDate: string;\r\n  total: number;\r\n  status?: string;\r\n  fulfillmentStatus?: string;\r\n  paymentStatus?: string;\r\n  items?: any[];\r\n  attributes?: any[];\r\n  shippingTrackingCode?: string;\r\n  shippingCarrier?: string;\r\n  estimatedDeliveryDate?: string;\r\n}\r\n\r\ninterface EcwidProduct {\r\n  id: number;\r\n  name: string;\r\n  description?: string;\r\n  price?: number;\r\n  sku?: string;\r\n  defaultDisplayedPrice?: number;\r\n}\r\n\r\ninterface EcwidProductVariation {\r\n  id: number;\r\n  name: string;\r\n  options: Array<{\r\n    name: string;\r\n    value: string;\r\n  }>;\r\n}\r\n\r\nclass EcwidAPI {\r\n  private storeId: string;\r\n  private apiToken: string;\r\n\r\n  constructor() {\r\n    this.storeId = process.env.ECWID_STORE_ID || \"\";\r\n    this.apiToken = process.env.ECWID_API_TOKEN || \"\";\r\n\r\n    if (!this.storeId || !this.apiToken) {\r\n      console.warn(\"Ecwid credentials not fully configured\");\r\n    }\r\n  }\r\n\r\n  private getAuthUrl(endpoint: string): string {\r\n    return `${ECWID_API_URL}/${this.storeId}${endpoint}?token=${this.apiToken}`;\r\n  }\r\n\r\n  /**\r\n   * Create a new customer in Ecwid\r\n   */\r\n  async createCustomer(customer: EcwidCustomer): Promise<any> {\r\n    const url = this.getAuthUrl(\"/customers\");\r\n\r\n    const customerData: any = {\r\n      email: customer.email,\r\n      firstName: customer.firstName,\r\n      lastName: customer.lastName,\r\n    };\r\n\r\n    if (customer.phone) {\r\n      customerData.phone = customer.phone;\r\n    }\r\n\r\n    if (customer.companyName) {\r\n      customerData.companyName = customer.companyName;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(customerData),\r\n      });\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse Ecwid response:\", parseError);\r\n        throw new Error(\r\n          `Failed to parse Ecwid response: ${response.statusText}`,\r\n        );\r\n      }\r\n\r\n      if (!response.ok) {\r\n        console.error(\"Customer creation failed:\", {\r\n          status: response.status,\r\n          statusText: response.statusText,\r\n          error: data,\r\n        });\r\n        throw new Error(\r\n          data?.errorMessage ||\r\n            data?.error ||\r\n            \"Failed to create customer in Ecwid\",\r\n        );\r\n      }\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error(\"Customer creation error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get customer by ID\r\n   */\r\n  async getCustomer(customerId: number): Promise<any> {\r\n    const url = this.getAuthUrl(`/customers/${customerId}`);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 404) {\r\n          return null;\r\n        }\r\n        console.error(\"Get customer failed:\", {\r\n          status: response.status,\r\n          statusText: response.statusText,\r\n        });\r\n        throw new Error(\r\n          `Failed to fetch customer from Ecwid: ${response.statusText}`,\r\n        );\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse customer response:\", parseError);\r\n        throw new Error(\"Failed to parse customer data from Ecwid\");\r\n      }\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error(\"Get customer error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get customer by email\r\n   */\r\n  async getCustomerByEmail(email: string): Promise<any> {\r\n    const encodedEmail = encodeURIComponent(email);\r\n    const url = this.getAuthUrl(`/customers?email=${encodedEmail}`);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 404) {\r\n          return null;\r\n        }\r\n        console.error(\"Get customer by email failed:\", {\r\n          status: response.status,\r\n          statusText: response.statusText,\r\n        });\r\n        return null;\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse customer response:\", parseError);\r\n        return null;\r\n      }\r\n\r\n      return data?.items && data.items.length > 0 ? data.items[0] : null;\r\n    } catch (error) {\r\n      console.error(\"Get customer by email error:\", error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update customer information\r\n   */\r\n  async updateCustomer(customerId: number, updates: any): Promise<any> {\r\n    const url = this.getAuthUrl(`/customers/${customerId}`);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"PUT\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(updates),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        let errorData: any;\r\n        try {\r\n          errorData = await response.json();\r\n        } catch {\r\n          errorData = { statusText: response.statusText };\r\n        }\r\n        console.error(\"Update customer failed:\", {\r\n          status: response.status,\r\n          error: errorData,\r\n        });\r\n        throw new Error(\r\n          errorData?.errorMessage ||\r\n            errorData?.error ||\r\n            \"Failed to update customer\",\r\n        );\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse update response:\", parseError);\r\n        throw new Error(\"Failed to parse customer update response\");\r\n      }\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error(\"Update customer error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get customer's orders\r\n   */\r\n  async getCustomerOrders(customerId: number): Promise<EcwidOrder[]> {\r\n    const url = this.getAuthUrl(`/orders?customerId=${customerId}`);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        console.error(\"Get orders failed:\", {\r\n          status: response.status,\r\n          statusText: response.statusText,\r\n        });\r\n        throw new Error(\r\n          `Failed to fetch orders from Ecwid: ${response.statusText}`,\r\n        );\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse orders response:\", parseError);\r\n        throw new Error(\"Failed to parse orders data from Ecwid\");\r\n      }\r\n\r\n      // Extract tracking and shipping info from items\r\n      const orders = (data?.items || []).map((order: any) => ({\r\n        ...order,\r\n        shippingTrackingCode: order.shippingTrackingCode,\r\n        shippingCarrier: this.extractShippingCarrier(order),\r\n        estimatedDeliveryDate: this.extractEstimatedDeliveryDate(order),\r\n      }));\r\n\r\n      return orders;\r\n    } catch (error) {\r\n      console.error(\"Get customer orders error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Extract shipping carrier from order shipping info\r\n   */\r\n  private extractShippingCarrier(order: any): string | undefined {\r\n    if (order.shippingPerson?.company) {\r\n      return order.shippingPerson.company;\r\n    }\r\n    if (order.shippingCarrier) {\r\n      return order.shippingCarrier;\r\n    }\r\n    // Try to infer from tracking code patterns or shipping method\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * Extract estimated delivery date from shipping info\r\n   */\r\n  private extractEstimatedDeliveryDate(order: any): string | undefined {\r\n    if (order.deliveryDateFrom) {\r\n      return order.deliveryDateFrom;\r\n    }\r\n    if (order.estimatedDeliveryDate) {\r\n      return order.estimatedDeliveryDate;\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * Get order by ID with full tracking and shipping details\r\n   */\r\n  async getOrder(orderId: number): Promise<any> {\r\n    const url = this.getAuthUrl(`/orders/${orderId}`);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 404) {\r\n          return null;\r\n        }\r\n        console.error(\"Get order failed:\", {\r\n          status: response.status,\r\n          statusText: response.statusText,\r\n        });\r\n        throw new Error(\r\n          `Failed to fetch order from Ecwid: ${response.statusText}`,\r\n        );\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse order response:\", parseError);\r\n        throw new Error(\"Failed to parse order data from Ecwid\");\r\n      }\r\n\r\n      // Extract and enhance order with tracking info\r\n      return {\r\n        ...data,\r\n        shippingTrackingCode: data.shippingTrackingCode,\r\n        shippingCarrier: this.extractShippingCarrier(data),\r\n        estimatedDeliveryDate: this.extractEstimatedDeliveryDate(data),\r\n      };\r\n    } catch (error) {\r\n      console.error(\"Get order error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create an order\r\n   */\r\n  async createOrder(orderData: any): Promise<any> {\r\n    const url = this.getAuthUrl(\"/orders\");\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(orderData),\r\n      });\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse order response:\", parseError);\r\n        throw new Error(\"Failed to parse order data from Ecwid\");\r\n      }\r\n\r\n      if (!response.ok) {\r\n        console.error(\"Order creation failed:\", {\r\n          status: response.status,\r\n          error: data,\r\n        });\r\n        throw new Error(\r\n          data?.errorMessage ||\r\n            data?.error ||\r\n            \"Failed to create order in Ecwid\",\r\n        );\r\n      }\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error(\"Create order error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get product by ID\r\n   */\r\n  async getProduct(productId: number): Promise<EcwidProduct | null> {\r\n    const url = this.getAuthUrl(`/products/${productId}`);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 404) {\r\n          return null;\r\n        }\r\n        console.error(\"Get product failed:\", {\r\n          status: response.status,\r\n          statusText: response.statusText,\r\n        });\r\n        return null;\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse product response:\", parseError);\r\n        return null;\r\n      }\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error(\"Get product error:\", error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get product options/variations\r\n   */\r\n  async getProductVariations(productId: number): Promise<any[]> {\r\n    const url = this.getAuthUrl(`/products/${productId}/combinations`);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 404) {\r\n          return [];\r\n        }\r\n        console.error(\"Get product variations failed:\", {\r\n          status: response.status,\r\n          statusText: response.statusText,\r\n        });\r\n        return [];\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse variations response:\", parseError);\r\n        return [];\r\n      }\r\n\r\n      return data?.items || [];\r\n    } catch (error) {\r\n      console.error(\"Get product variations error:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get product with variations\r\n   */\r\n  async getProductWithVariations(productId: number): Promise<any> {\r\n    try {\r\n      const product = await this.getProduct(productId);\r\n      if (!product) {\r\n        return null;\r\n      }\r\n\r\n      const variations = await this.getProductVariations(productId);\r\n\r\n      return {\r\n        ...product,\r\n        variations,\r\n      };\r\n    } catch (error) {\r\n      console.error(\"Get product with variations error:\", error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete customer account\r\n   */\r\n  async deleteCustomer(customerId: number): Promise<void> {\r\n    const url = this.getAuthUrl(`/customers/${customerId}`);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"DELETE\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      if (!response.ok && response.status !== 404) {\r\n        let errorData: any;\r\n        try {\r\n          errorData = await response.json();\r\n        } catch {\r\n          errorData = { statusText: response.statusText };\r\n        }\r\n        console.error(\"Delete customer failed:\", {\r\n          status: response.status,\r\n          error: errorData,\r\n        });\r\n        throw new Error(\r\n          errorData?.errorMessage ||\r\n            errorData?.error ||\r\n            \"Failed to delete customer account\",\r\n        );\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Delete customer error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Search products\r\n   */\r\n  async searchProducts(keyword: string): Promise<any[]> {\r\n    const encodedKeyword = encodeURIComponent(keyword);\r\n    const url = this.getAuthUrl(`/products?keyword=${encodedKeyword}`);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        console.error(\"Search products failed:\", {\r\n          status: response.status,\r\n          statusText: response.statusText,\r\n        });\r\n        return [];\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse search response:\", parseError);\r\n        return [];\r\n      }\r\n\r\n      return data?.items || [];\r\n    } catch (error) {\r\n      console.error(\"Search products error:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all products\r\n   */\r\n  async getAllProducts(limit = 100): Promise<any[]> {\r\n    const url = this.getAuthUrl(`/products?limit=${limit}`);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        console.error(\"Get products failed:\", {\r\n          status: response.status,\r\n          statusText: response.statusText,\r\n        });\r\n        return [];\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse products response:\", parseError);\r\n        return [];\r\n      }\r\n\r\n      return data?.items || [];\r\n    } catch (error) {\r\n      console.error(\"Get all products error:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get store information\r\n   */\r\n  async getStoreInfo(): Promise<any> {\r\n    const url = this.getAuthUrl(\"/\");\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        console.error(\"Get store info failed:\", {\r\n          status: response.status,\r\n          statusText: response.statusText,\r\n        });\r\n        throw new Error(\"Failed to fetch store information\");\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse store info response:\", parseError);\r\n        throw new Error(\"Failed to parse store info response\");\r\n      }\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error(\"Get store info error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all orders from the store with optional filtering\r\n   */\r\n  async getAllOrders(fulfillmentStatus?: string, limit = 100): Promise<any[]> {\r\n    let endpoint = `/orders?limit=${limit}`;\r\n\r\n    if (fulfillmentStatus) {\r\n      endpoint += `&fulfillmentStatus=${fulfillmentStatus}`;\r\n    }\r\n\r\n    const url = this.getAuthUrl(endpoint);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        console.error(\"Get all orders failed:\", {\r\n          status: response.status,\r\n          statusText: response.statusText,\r\n        });\r\n        return [];\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse orders response:\", parseError);\r\n        return [];\r\n      }\r\n\r\n      return (data?.items || []).map((order: any) => ({\r\n        ...order,\r\n        shippingTrackingCode: order.shippingTrackingCode,\r\n        shippingCarrier: this.extractShippingCarrier(order),\r\n        estimatedDeliveryDate: this.extractEstimatedDeliveryDate(order),\r\n      }));\r\n    } catch (error) {\r\n      console.error(\"Get all orders error:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update order status\r\n   */\r\n  async updateOrderStatus(orderId: number, status: string): Promise<any> {\r\n    const url = this.getAuthUrl(`/orders/${orderId}`);\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: \"PUT\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({ fulfillmentStatus: status }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        let errorData: any;\r\n        try {\r\n          errorData = await response.json();\r\n        } catch {\r\n          errorData = { statusText: response.statusText };\r\n        }\r\n        console.error(\"Update order status failed:\", {\r\n          status: response.status,\r\n          error: errorData,\r\n        });\r\n        throw new Error(\r\n          errorData?.errorMessage ||\r\n            errorData?.error ||\r\n            \"Failed to update order status\",\r\n        );\r\n      }\r\n\r\n      let data: any;\r\n      try {\r\n        data = await response.json();\r\n      } catch (parseError) {\r\n        console.error(\"Failed to parse status update response:\", parseError);\r\n        throw new Error(\"Failed to parse order status update response\");\r\n      }\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error(\"Update order status error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const ecwidAPI = new EcwidAPI();\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 634, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/emails/order-confirmation.ts"],"sourcesContent":["export function generateOrderConfirmationEmail(params: {\r\n  customerName: string;\r\n  orderNumber: string;\r\n  orderDate: string;\r\n  items: Array<{\r\n    name: string;\r\n    quantity: number;\r\n    price: number;\r\n    designFileUrl?: string;\r\n    options?: Array<{ option_id: string; option_value: string }>;\r\n  }>;\r\n  subtotal: number;\r\n  tax: number;\r\n  shipping: number;\r\n  discount?: number;\r\n  discountCode?: string;\r\n  total: number;\r\n  estimatedDelivery: string;\r\n  orderLink: string;\r\n  shippingAddress?: {\r\n    firstName: string;\r\n    lastName: string;\r\n    street: string;\r\n    street2?: string;\r\n    city: string;\r\n    state: string;\r\n    postalCode: string;\r\n    country: string;\r\n  };\r\n  policies?: {\r\n    returnAndRefund: boolean;\r\n    privacy: boolean;\r\n    gdpr: boolean;\r\n    ccpa: boolean;\r\n    terms: boolean;\r\n    shipping: boolean;\r\n  };\r\n}): string {\r\n  const {\r\n    customerName,\r\n    orderNumber,\r\n    orderDate,\r\n    items,\r\n    subtotal,\r\n    tax,\r\n    shipping,\r\n    discount,\r\n    discountCode,\r\n    total,\r\n    estimatedDelivery,\r\n    orderLink,\r\n    shippingAddress,\r\n    policies,\r\n  } = params;\r\n\r\n  const itemsHtml = items\r\n    .map((item) => {\r\n      const designThumbnail = item.designFileUrl\r\n        ? `<div style=\"margin-top: 12px; padding-top: 12px; border-top: 1px solid #f3f4f6;\">\r\n              <p style=\"margin: 0 0 8px 0; font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;\">Design Preview</p>\r\n              <div style=\"background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; padding: 8px; text-align: center;\">\r\n                ${\r\n                  item.designFileUrl.match(/\\.(jpg|jpeg|png|gif|webp)$/i) ||\r\n                  item.designFileUrl.startsWith(\"data:image\")\r\n                    ? `<img src=\"${item.designFileUrl}\" alt=\"Design thumbnail\" style=\"max-width: 100%; max-height: 120px; border-radius: 3px;\" />`\r\n                    : `<p style=\"margin: 0; font-size: 12px; color: #9ca3af;\">Design file uploaded</p>`\r\n                }\r\n              </div>\r\n            </div>`\r\n        : \"\";\r\n\r\n      const optionsDisplay =\r\n        item.options && item.options.length > 0\r\n          ? `<div style=\"margin-top: 8px; padding-top: 8px; border-top: 1px solid #f3f4f6;\">\r\n              <p style=\"margin: 0 0 4px 0; font-size: 11px; color: #9ca3af; text-transform: uppercase;\">Specifications</p>\r\n              <div style=\"font-size: 13px; color: #6b7280;\">\r\n                ${item.options.map((opt) => `<div>‚Ä¢ ${opt.option_value}</div>`).join(\"\")}\r\n              </div>\r\n            </div>`\r\n          : \"\";\r\n\r\n      return `\r\n    <tr>\r\n      <td style=\"padding: 12px; border-bottom: 1px solid #e5e7eb; color: #374151;\">\r\n        <div>\r\n          <strong>${item.name}</strong>\r\n          ${optionsDisplay}\r\n          ${designThumbnail}\r\n        </div>\r\n      </td>\r\n      <td style=\"padding: 12px; border-bottom: 1px solid #e5e7eb; color: #374151; text-align: center;\">${item.quantity}</td>\r\n      <td style=\"padding: 12px; border-bottom: 1px solid #e5e7eb; color: #374151; text-align: right;\">$${item.price.toFixed(2)}</td>\r\n    </tr>\r\n  `;\r\n    })\r\n    .join(\"\");\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Order Confirmation - Stickerland</title>\r\n  <style>\r\n    body {\r\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\r\n      margin: 0;\r\n      padding: 0;\r\n      background-color: #f9fafb;\r\n    }\r\n    .container {\r\n      max-width: 600px;\r\n      margin: 0 auto;\r\n      padding: 20px;\r\n    }\r\n    .header {\r\n      background-color: #ffffff;\r\n      padding: 30px;\r\n      border-radius: 8px 8px 0 0;\r\n      border-bottom: 2px solid #10b981;\r\n      text-align: center;\r\n      margin-bottom: 20px;\r\n    }\r\n    .header h1 {\r\n      margin: 0 0 10px 0;\r\n      color: #1f2937;\r\n      font-size: 28px;\r\n      font-weight: bold;\r\n    }\r\n    .header p {\r\n      margin: 5px 0 0 0;\r\n      color: #6b7280;\r\n      font-size: 14px;\r\n    }\r\n    .content {\r\n      background-color: #ffffff;\r\n      padding: 30px;\r\n      margin-bottom: 20px;\r\n      border-radius: 8px;\r\n    }\r\n    .order-number {\r\n      background-color: #f0fdf4;\r\n      border-left: 4px solid #10b981;\r\n      padding: 15px;\r\n      margin-bottom: 20px;\r\n      border-radius: 4px;\r\n    }\r\n    .order-number p {\r\n      margin: 0;\r\n      color: #374151;\r\n    }\r\n    .order-number strong {\r\n      color: #059669;\r\n      font-size: 18px;\r\n      display: block;\r\n      margin-top: 5px;\r\n    }\r\n    table {\r\n      width: 100%;\r\n      margin: 20px 0;\r\n      border-collapse: collapse;\r\n    }\r\n    th {\r\n      background-color: #f3f4f6;\r\n      padding: 12px;\r\n      text-align: left;\r\n      color: #374151;\r\n      font-weight: 600;\r\n      border-bottom: 2px solid #e5e7eb;\r\n    }\r\n    .summary {\r\n      background-color: #f9fafb;\r\n      padding: 20px;\r\n      border-radius: 6px;\r\n      margin: 20px 0;\r\n    }\r\n    .summary-row {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      padding: 8px 0;\r\n      color: #374151;\r\n    }\r\n    .summary-row.total {\r\n      border-top: 2px solid #e5e7eb;\r\n      padding-top: 12px;\r\n      margin-top: 12px;\r\n      font-weight: bold;\r\n      font-size: 18px;\r\n      color: #1f2937;\r\n    }\r\n    .cta-button {\r\n      display: inline-block;\r\n      padding: 12px 30px;\r\n      background-color: #10b981;\r\n      color: white;\r\n      text-decoration: none;\r\n      border-radius: 6px;\r\n      font-weight: bold;\r\n      text-align: center;\r\n      margin: 20px 0;\r\n    }\r\n    .cta-button:hover {\r\n      background-color: #059669;\r\n    }\r\n    .delivery-info {\r\n      background-color: #eff6ff;\r\n      border-left: 4px solid #3b82f6;\r\n      padding: 15px;\r\n      margin: 20px 0;\r\n      border-radius: 4px;\r\n    }\r\n    .delivery-info p {\r\n      margin: 0;\r\n      color: #1e40af;\r\n      font-size: 14px;\r\n    }\r\n    .delivery-info strong {\r\n      color: #1e40af;\r\n      display: block;\r\n      font-size: 16px;\r\n      margin-bottom: 5px;\r\n    }\r\n    .footer {\r\n      text-align: center;\r\n      padding: 20px;\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      border-top: 1px solid #e5e7eb;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <!-- Header -->\r\n    <div class=\"header\">\r\n      <img src=\"https://cdn.builder.io/api/v1/image/assets%2F1e00ee8c48924560b1c928d354e4521b%2Ff76c51c7227242dc8bd4b1757ab321af\" alt=\"Stickerland Logo\" style=\"max-width: 200px; height: auto; margin-bottom: 15px;\" />\r\n      <h1>‚úì Order Confirmed</h1>\r\n      <p>Thank you for your order! We're preparing your custom stickers.</p>\r\n    </div>\r\n\r\n    <!-- Main Content -->\r\n    <div class=\"content\">\r\n      <p>Hi <strong>${customerName}</strong>,</p>\r\n\r\n      <div class=\"order-number\">\r\n        <p>Order Number:</p>\r\n        <strong>#${orderNumber}</strong>\r\n        <p style=\"margin-top: 8px; font-size: 13px;\">Placed on ${orderDate}</p>\r\n      </div>\r\n\r\n      <p>We've received your order and it's now being prepared for production. Your custom stickers will be carefully crafted with attention to detail and quality.</p>\r\n\r\n      <h3 style=\"color: #1f2937; margin-top: 25px; margin-bottom: 15px;\">Order Summary</h3>\r\n      <table>\r\n        <thead>\r\n          <tr>\r\n            <th>Item</th>\r\n            <th style=\"text-align: center;\">Qty</th>\r\n            <th style=\"text-align: right;\">Price</th>\r\n          </tr>\r\n        </thead>\r\n        <tbody>\r\n          ${itemsHtml}\r\n        </tbody>\r\n      </table>\r\n\r\n      <div class=\"summary\">\r\n        <div class=\"summary-row\">\r\n          <span>Subtotal:</span>\r\n          <span>$${subtotal.toFixed(2)}</span>\r\n        </div>\r\n        <div class=\"summary-row\">\r\n          <span>Shipping:</span>\r\n          <span>$${shipping.toFixed(2)}</span>\r\n        </div>\r\n        ${\r\n          discount && discount > 0\r\n            ? `\r\n        <div class=\"summary-row\" style=\"color: #10b981;\">\r\n          <span>Discount${discountCode ? ` (${discountCode})` : \"\"}:</span>\r\n          <span>-$${discount.toFixed(2)}</span>\r\n        </div>\r\n        `\r\n            : \"\"\r\n        }\r\n        <div class=\"summary-row\">\r\n          <span>Tax:</span>\r\n          <span>$${tax.toFixed(2)}</span>\r\n        </div>\r\n        <div class=\"summary-row total\">\r\n          <span>Total:</span>\r\n          <span>$${total.toFixed(2)}</span>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"delivery-info\">\r\n        <strong>üì¶ Estimated Delivery</strong>\r\n        <p>${estimatedDelivery}</p>\r\n      </div>\r\n\r\n      <a href=\"${orderLink}\" class=\"cta-button\">Track Your Order</a>\r\n\r\n      <p style=\"margin-top: 30px; color: #6b7280; font-size: 14px;\">\r\n        <strong>What happens next?</strong><br>\r\n        Our team will prepare your design for production. You'll receive a proof for approval before we begin printing. Once approved, your stickers will be printed, quality checked, and shipped to your address.\r\n      </p>\r\n\r\n      ${\r\n        shippingAddress\r\n          ? `\r\n      <div style=\"background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 20px; margin-top: 30px;\">\r\n        <h3 style=\"color: #1f2937; margin-top: 0; margin-bottom: 15px; font-size: 16px;\">üì¶ Shipping Address</h3>\r\n        <div style=\"color: #374151; font-size: 14px; line-height: 1.6;\">\r\n          <strong>${shippingAddress.firstName} ${shippingAddress.lastName}</strong><br>\r\n          ${shippingAddress.street}${shippingAddress.street2 ? `<br>${shippingAddress.street2}` : \"\"}<br>\r\n          ${shippingAddress.city}, ${shippingAddress.state} ${shippingAddress.postalCode}<br>\r\n          ${shippingAddress.country}\r\n        </div>\r\n      </div>\r\n      `\r\n          : \"\"\r\n      }\r\n\r\n      ${\r\n        policies\r\n          ? `\r\n      <div style=\"background-color: #f0fdf4; border: 1px solid #86efac; border-radius: 6px; padding: 20px; margin-top: 30px;\">\r\n        <h3 style=\"color: #166534; margin-top: 0; margin-bottom: 15px; font-size: 16px;\">‚úì Policies & Agreements</h3>\r\n        <div style=\"color: #365314; font-size: 13px; line-height: 1.8; space-y: 8px;\">\r\n          ${policies.returnAndRefund ? `<div style=\"margin-bottom: 8px;\">‚úì Return & Refund Policy acknowledged</div>` : \"\"}\r\n          ${policies.privacy ? `<div style=\"margin-bottom: 8px;\">‚úì Privacy Policy agreed</div>` : \"\"}\r\n          ${policies.terms ? `<div style=\"margin-bottom: 8px;\">‚úì Terms of Service agreed</div>` : \"\"}\r\n          ${policies.shipping ? `<div style=\"margin-bottom: 0;\">‚úì Shipping Policy agreed</div>` : \"\"}\r\n        </div>\r\n      </div>\r\n      `\r\n          : \"\"\r\n      }\r\n    </div>\r\n\r\n    <!-- Footer -->\r\n    <div class=\"footer\">\r\n      <p>¬© 2024 Stickerland. All rights reserved.</p>\r\n      <p>Questions? Contact our support team anytime.</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,+BAA+B,MAqC9C;IACC,MAAM,EACJ,YAAY,EACZ,WAAW,EACX,SAAS,EACT,KAAK,EACL,QAAQ,EACR,GAAG,EACH,QAAQ,EACR,QAAQ,EACR,YAAY,EACZ,KAAK,EACL,iBAAiB,EACjB,SAAS,EACT,eAAe,EACf,QAAQ,EACT,GAAG;IAEJ,MAAM,YAAY,MACf,GAAG,CAAC,CAAC;QACJ,MAAM,kBAAkB,KAAK,aAAa,GACtC,CAAC;;;gBAGK,EACE,KAAK,aAAa,CAAC,KAAK,CAAC,kCACzB,KAAK,aAAa,CAAC,UAAU,CAAC,gBAC1B,CAAC,UAAU,EAAE,KAAK,aAAa,CAAC,2FAA2F,CAAC,GAC5H,CAAC,+EAA+E,CAAC,CACtF;;kBAEC,CAAC,GACT;QAEJ,MAAM,iBACJ,KAAK,OAAO,IAAI,KAAK,OAAO,CAAC,MAAM,GAAG,IAClC,CAAC;;;gBAGG,EAAE,KAAK,OAAO,CAAC,GAAG,CAAC,CAAC,MAAQ,CAAC,OAAO,EAAE,IAAI,YAAY,CAAC,MAAM,CAAC,EAAE,IAAI,CAAC,IAAI;;kBAEvE,CAAC,GACP;QAEN,OAAO,CAAC;;;;kBAII,EAAE,KAAK,IAAI,CAAC;UACpB,EAAE,eAAe;UACjB,EAAE,gBAAgB;;;uGAG2E,EAAE,KAAK,QAAQ,CAAC;uGAChB,EAAE,KAAK,KAAK,CAAC,OAAO,CAAC,GAAG;;EAE7H,CAAC;IACC,GACC,IAAI,CAAC;IAER,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;oBAkJU,EAAE,aAAa;;;;iBAIlB,EAAE,YAAY;+DACgC,EAAE,UAAU;;;;;;;;;;;;;;;UAejE,EAAE,UAAU;;;;;;;iBAOL,EAAE,SAAS,OAAO,CAAC,GAAG;;;;iBAItB,EAAE,SAAS,OAAO,CAAC,GAAG;;QAE/B,EACE,YAAY,WAAW,IACnB,CAAC;;wBAES,EAAE,eAAe,CAAC,EAAE,EAAE,aAAa,CAAC,CAAC,GAAG,GAAG;kBACjD,EAAE,SAAS,OAAO,CAAC,GAAG;;QAEhC,CAAC,GACK,GACL;;;iBAGQ,EAAE,IAAI,OAAO,CAAC,GAAG;;;;iBAIjB,EAAE,MAAM,OAAO,CAAC,GAAG;;;;;;WAMzB,EAAE,kBAAkB;;;eAGhB,EAAE,UAAU;;;;;;;MAOrB,EACE,kBACI,CAAC;;;;kBAIK,EAAE,gBAAgB,SAAS,CAAC,CAAC,EAAE,gBAAgB,QAAQ,CAAC;UAChE,EAAE,gBAAgB,MAAM,GAAG,gBAAgB,OAAO,GAAG,CAAC,IAAI,EAAE,gBAAgB,OAAO,EAAE,GAAG,GAAG;UAC3F,EAAE,gBAAgB,IAAI,CAAC,EAAE,EAAE,gBAAgB,KAAK,CAAC,CAAC,EAAE,gBAAgB,UAAU,CAAC;UAC/E,EAAE,gBAAgB,OAAO,CAAC;;;MAG9B,CAAC,GACK,GACL;;MAED,EACE,WACI,CAAC;;;;UAIH,EAAE,SAAS,eAAe,GAAG,CAAC,4EAA4E,CAAC,GAAG,GAAG;UACjH,EAAE,SAAS,OAAO,GAAG,CAAC,8DAA8D,CAAC,GAAG,GAAG;UAC3F,EAAE,SAAS,KAAK,GAAG,CAAC,gEAAgE,CAAC,GAAG,GAAG;UAC3F,EAAE,SAAS,QAAQ,GAAG,CAAC,6DAA6D,CAAC,GAAG,GAAG;;;MAG/F,CAAC,GACK,GACL;;;;;;;;;;;EAWL,CAAC;AACH"}},
    {"offset": {"line": 913, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/emails/password-reset.ts"],"sourcesContent":["export function generatePasswordResetEmail(params: {\r\n  customerName: string;\r\n  resetLink: string;\r\n  expiresIn: string;\r\n}): string {\r\n  const { customerName, resetLink, expiresIn } = params;\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Reset Your Password - Stickerland</title>\r\n  <style>\r\n    body {\r\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\r\n      margin: 0;\r\n      padding: 0;\r\n      background-color: #f9fafb;\r\n    }\r\n    .container {\r\n      max-width: 600px;\r\n      margin: 0 auto;\r\n      padding: 20px;\r\n    }\r\n    .header {\r\n      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);\r\n      color: white;\r\n      padding: 40px 20px;\r\n      border-radius: 8px 8px 0 0;\r\n      text-align: center;\r\n    }\r\n    .header h1 {\r\n      margin: 0 0 10px 0;\r\n      font-size: 28px;\r\n      font-weight: bold;\r\n    }\r\n    .header p {\r\n      margin: 0;\r\n      opacity: 0.9;\r\n      font-size: 14px;\r\n    }\r\n    .content {\r\n      background-color: #ffffff;\r\n      padding: 40px 30px;\r\n      margin-bottom: 20px;\r\n      border-radius: 0 0 8px 8px;\r\n    }\r\n    .content p {\r\n      margin: 0 0 20px 0;\r\n      color: #374151;\r\n      font-size: 16px;\r\n      line-height: 1.6;\r\n    }\r\n    .warning-box {\r\n      background-color: #fef2f2;\r\n      border-left: 4px solid #f87171;\r\n      padding: 15px;\r\n      margin: 20px 0;\r\n      border-radius: 4px;\r\n    }\r\n    .warning-box p {\r\n      color: #991b1b;\r\n      font-size: 14px;\r\n      margin: 0;\r\n    }\r\n    .cta-button {\r\n      display: inline-block;\r\n      padding: 14px 35px;\r\n      background-color: #f59e0b;\r\n      color: white;\r\n      text-decoration: none;\r\n      border-radius: 6px;\r\n      font-weight: bold;\r\n      text-align: center;\r\n      margin: 25px 0;\r\n      font-size: 16px;\r\n    }\r\n    .cta-button:hover {\r\n      background-color: #d97706;\r\n    }\r\n    .info-box {\r\n      background-color: #f0f9ff;\r\n      border-left: 4px solid #3b82f6;\r\n      padding: 15px;\r\n      margin: 20px 0;\r\n      border-radius: 4px;\r\n    }\r\n    .info-box p {\r\n      color: #1e40af;\r\n      font-size: 13px;\r\n      margin: 5px 0;\r\n    }\r\n    .footer {\r\n      text-align: center;\r\n      padding: 20px;\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      border-top: 1px solid #e5e7eb;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <!-- Header -->\r\n    <div class=\"header\">\r\n      <h1>üîê Reset Your Password</h1>\r\n      <p>We received a request to reset your Stickerland account password</p>\r\n    </div>\r\n\r\n    <!-- Content -->\r\n    <div class=\"content\">\r\n      <p>Hi <strong>${customerName}</strong>,</p>\r\n\r\n      <p>We received a request to reset the password for your Stickerland account. Click the button below to create a new password.</p>\r\n\r\n      <a href=\"${resetLink}\" class=\"cta-button\">Reset Password</a>\r\n\r\n      <p style=\"text-align: center; color: #6b7280; font-size: 13px;\">\r\n        Or copy and paste this link in your browser:<br>\r\n        <code style=\"background-color: #f3f4f6; padding: 8px 12px; border-radius: 4px; display: inline-block; word-break: break-all;\">${resetLink}</code>\r\n      </p>\r\n\r\n      <!-- Warning Box -->\r\n      <div class=\"warning-box\">\r\n        <p>\r\n          <strong>‚ö†Ô∏è Important:</strong> This link will expire in ${expiresIn}. \r\n          If you didn't request a password reset, you can safely ignore this email. \r\n          Your account is secure.\r\n        </p>\r\n      </div>\r\n\r\n      <!-- Info Box -->\r\n      <div class=\"info-box\">\r\n        <p><strong>Security Tips:</strong></p>\r\n        <p>‚Ä¢ Never share your password with anyone</p>\r\n        <p>‚Ä¢ Use a strong, unique password</p>\r\n        <p>‚Ä¢ Enable two-factor authentication for added security</p>\r\n      </div>\r\n\r\n      <p style=\"margin-top: 30px; color: #6b7280; font-size: 14px;\">\r\n        If you have any questions or didn't request this reset, please contact our support team immediately.\r\n      </p>\r\n    </div>\r\n\r\n    <!-- Footer -->\r\n    <div class=\"footer\">\r\n      <p>¬© 2024 Stickerland. All rights reserved.</p>\r\n      <p>This is an automated message. Please do not reply to this email.</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,2BAA2B,MAI1C;IACC,MAAM,EAAE,YAAY,EAAE,SAAS,EAAE,SAAS,EAAE,GAAG;IAE/C,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;oBA0GU,EAAE,aAAa;;;;eAIpB,EAAE,UAAU;;;;sIAI2G,EAAE,UAAU;;;;;;kEAMhF,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;;;EA2B5E,CAAC;AACH"}},
    {"offset": {"line": 1074, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/utils/email.ts"],"sourcesContent":["import { Resend } from \"resend\";\r\nimport { generateOrderConfirmationEmail } from \"../emails/order-confirmation\";\r\nimport { generatePasswordResetEmail } from \"../emails/password-reset\";\r\n\r\nconst resend = process.env.RESEND_API_KEY\r\n  ? new Resend(process.env.RESEND_API_KEY)\r\n  : null;\r\n\r\nconst ORDER_EMAIL_FROM = \"orders@stickerland.com\";\r\nconst SUPPORT_EMAIL_FROM = \"support@stickerland.com\";\r\n\r\nexport async function sendTicketCreationEmail(\r\n  customerEmail: string,\r\n  customerName: string,\r\n  ticketId: string,\r\n  subject: string,\r\n): Promise<boolean> {\r\n  try {\r\n    if (!resend) {\r\n      console.warn(\r\n        \"Resend API key not configured. Email sending disabled. Set RESEND_API_KEY environment variable to enable.\",\r\n      );\r\n      return true; // Return true to not block the ticket creation\r\n    }\r\n\r\n    await resend.emails.send({\r\n      from: \"support@stickerland.com\",\r\n      to: customerEmail,\r\n      subject: `Support Ticket Confirmation - ${subject}`,\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n          <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;\">\r\n            <h1 style=\"margin: 0;\">Support Ticket Created</h1>\r\n          </div>\r\n          <div style=\"background: #f9fafb; padding: 40px 20px; border-radius: 0 0 8px 8px; border: 1px solid #e5e7eb;\">\r\n            <p style=\"color: #374151; font-size: 16px; line-height: 1.6;\">Hi ${customerName},</p>\r\n            \r\n            <p style=\"color: #374151; font-size: 16px; line-height: 1.6;\">\r\n              Thank you for reaching out! We've received your support request and will get back to you as soon as possible.\r\n            </p>\r\n            \r\n            <div style=\"background: white; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0; border-radius: 4px;\">\r\n              <p style=\"color: #6b7280; font-size: 12px; margin: 0 0 5px 0; text-transform: uppercase;\">Ticket ID</p>\r\n              <p style=\"color: #1f2937; font-size: 18px; font-weight: bold; margin: 0; font-family: monospace;\">${ticketId}</p>\r\n            </div>\r\n            \r\n            <div style=\"background: white; border: 1px solid #e5e7eb; padding: 15px; margin: 20px 0; border-radius: 4px;\">\r\n              <p style=\"color: #6b7280; font-size: 12px; margin: 0 0 5px 0; text-transform: uppercase;\">Subject</p>\r\n              <p style=\"color: #1f2937; font-size: 16px; margin: 0;\">${subject}</p>\r\n            </div>\r\n            \r\n            <p style=\"color: #374151; font-size: 16px; line-height: 1.6;\">\r\n              Our support team is working on your request. You'll receive an email notification as soon as we have an update.\r\n            </p>\r\n            \r\n            <p style=\"color: #374151; font-size: 16px; line-height: 1.6;\">\r\n              Please keep your Ticket ID for reference when following up on this request.\r\n            </p>\r\n            \r\n            <div style=\"background: #f3f4f6; padding: 15px; border-radius: 4px; margin: 20px 0;\">\r\n              <p style=\"color: #6b7280; font-size: 12px; margin: 0;\">\r\n                Typical response time: 2-4 business hours\r\n              </p>\r\n            </div>\r\n            \r\n            <p style=\"color: #6b7280; font-size: 14px; line-height: 1.6; margin-top: 30px;\">\r\n              Best regards,<br>\r\n              <strong>Stickerland Support Team</strong>\r\n            </p>\r\n          </div>\r\n        </div>\r\n      `,\r\n    });\r\n\r\n    console.log(`Ticket creation email sent to ${customerEmail}`);\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"Error sending ticket creation email:\", error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function sendTicketReplyEmail(\r\n  customerEmail: string,\r\n  customerName: string,\r\n  ticketId: string,\r\n  subject: string,\r\n  replyMessage: string,\r\n  adminName: string,\r\n): Promise<boolean> {\r\n  try {\r\n    if (!resend) {\r\n      console.warn(\r\n        \"Resend API key not configured. Email sending disabled. Set RESEND_API_KEY environment variable to enable.\",\r\n      );\r\n      return true; // Return true to not block the reply\r\n    }\r\n\r\n    await resend.emails.send({\r\n      from: \"support@stickerland.com\",\r\n      to: customerEmail,\r\n      subject: `Re: ${subject} - Support Response`,\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n          <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;\">\r\n            <h1 style=\"margin: 0;\">New Support Response</h1>\r\n          </div>\r\n          <div style=\"background: #f9fafb; padding: 40px 20px; border-radius: 0 0 8px 8px; border: 1px solid #e5e7eb;\">\r\n            <p style=\"color: #374151; font-size: 16px; line-height: 1.6;\">Hi ${customerName},</p>\r\n\r\n            <p style=\"color: #374151; font-size: 16px; line-height: 1.6;\">\r\n              ${adminName} from our support team has replied to your ticket:\r\n            </p>\r\n\r\n            <div style=\"background: white; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0; border-radius: 4px;\">\r\n              <p style=\"color: #6b7280; font-size: 12px; margin: 0 0 5px 0; text-transform: uppercase;\">Ticket ID</p>\r\n              <p style=\"color: #1f2937; font-size: 14px; font-weight: bold; margin: 0; font-family: monospace;\">${ticketId}</p>\r\n            </div>\r\n\r\n            <div style=\"background: white; border: 1px solid #e5e7eb; padding: 20px; margin: 20px 0; border-radius: 4px;\">\r\n              <p style=\"color: #1f2937; font-size: 16px; line-height: 1.8; white-space: pre-wrap;\">${replyMessage}</p>\r\n            </div>\r\n\r\n            <div style=\"background: #eff6ff; border-left: 4px solid #3b82f6; padding: 15px; margin: 20px 0; border-radius: 4px;\">\r\n              <p style=\"color: #1e40af; font-size: 14px; margin: 0;\">\r\n                Log in to your account to view the full conversation and respond if needed.\r\n              </p>\r\n            </div>\r\n\r\n            <p style=\"color: #6b7280; font-size: 14px; line-height: 1.6; margin-top: 30px;\">\r\n              Best regards,<br>\r\n              <strong>Stickerland Support Team</strong>\r\n            </p>\r\n          </div>\r\n        </div>\r\n      `,\r\n    });\r\n\r\n    console.log(`Ticket reply email sent to ${customerEmail}`);\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"Error sending ticket reply email:\", error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function sendOrderConfirmationEmail(params: {\r\n  customerEmail: string;\r\n  customerName: string;\r\n  orderNumber: string;\r\n  orderDate: string;\r\n  items: Array<{\r\n    name: string;\r\n    quantity: number;\r\n    price: number;\r\n    designFileUrl?: string;\r\n    options?: Array<{ option_id: string; option_value: string }>;\r\n  }>;\r\n  subtotal: number;\r\n  tax: number;\r\n  shipping: number;\r\n  discount?: number;\r\n  discountCode?: string;\r\n  total: number;\r\n  estimatedDelivery: string;\r\n  orderLink: string;\r\n  shippingAddress?: {\r\n    firstName: string;\r\n    lastName: string;\r\n    street: string;\r\n    street2?: string;\r\n    city: string;\r\n    state: string;\r\n    postalCode: string;\r\n    country: string;\r\n  };\r\n  policies?: {\r\n    returnAndRefund: boolean;\r\n    privacy: boolean;\r\n    gdpr: boolean;\r\n    ccpa: boolean;\r\n    terms: boolean;\r\n    shipping: boolean;\r\n  };\r\n}): Promise<boolean> {\r\n  try {\r\n    if (!resend) {\r\n      console.warn(\r\n        \"Resend API key not configured. Email sending disabled. Set RESEND_API_KEY environment variable to enable.\",\r\n      );\r\n      return true; // Return true to not block order creation\r\n    }\r\n\r\n    const emailHtml = generateOrderConfirmationEmail(params);\r\n\r\n    await resend.emails.send({\r\n      from: ORDER_EMAIL_FROM,\r\n      to: params.customerEmail,\r\n      subject: `Order Confirmation - Order #${params.orderNumber}`,\r\n      html: emailHtml,\r\n    });\r\n\r\n    console.log(`Order confirmation email sent to ${params.customerEmail}`, {\r\n      orderNumber: params.orderNumber,\r\n      itemCount: params.items.length,\r\n    });\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"Error sending order confirmation email:\", error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function sendPasswordResetEmail(\r\n  customerEmail: string,\r\n  customerName: string,\r\n  resetLink: string,\r\n): Promise<boolean> {\r\n  try {\r\n    if (!resend) {\r\n      console.warn(\r\n        \"Resend API key not configured. Email sending disabled. Set RESEND_API_KEY environment variable to enable.\",\r\n      );\r\n      return true; // Return true to not block the password reset request\r\n    }\r\n\r\n    const emailHtml = generatePasswordResetEmail({\r\n      customerName,\r\n      resetLink,\r\n      expiresIn: \"1 hour\",\r\n    });\r\n\r\n    await resend.emails.send({\r\n      from: SUPPORT_EMAIL_FROM,\r\n      to: customerEmail,\r\n      subject: \"Reset Your Password - Stickerland\",\r\n      html: emailHtml,\r\n    });\r\n\r\n    console.log(`Password reset email sent to ${customerEmail}`);\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"Error sending password reset email:\", error);\r\n    return false;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;;;;;;;;AAEA,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc,GACrC,IAAI,mKAAM,CAAC,QAAQ,GAAG,CAAC,cAAc,IACrC;AAEJ,MAAM,mBAAmB;AACzB,MAAM,qBAAqB;AAEpB,eAAe,wBACpB,aAAqB,EACrB,YAAoB,EACpB,QAAgB,EAChB,OAAe;IAEf,IAAI;QACF,IAAI,CAAC,QAAQ;YACX,QAAQ,IAAI,CACV;YAEF,OAAO,MAAM,+CAA+C;QAC9D;QAEA,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC;YACvB,MAAM;YACN,IAAI;YACJ,SAAS,CAAC,8BAA8B,EAAE,SAAS;YACnD,MAAM,CAAC;;;;;;6EAMgE,EAAE,aAAa;;;;;;;;gHAQoB,EAAE,SAAS;;;;;qEAKtD,EAAE,QAAQ;;;;;;;;;;;;;;;;;;;;;;;MAuBzE,CAAC;QACH;QAEA,QAAQ,GAAG,CAAC,CAAC,8BAA8B,EAAE,eAAe;QAC5D,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,OAAO;IACT;AACF;AAEO,eAAe,qBACpB,aAAqB,EACrB,YAAoB,EACpB,QAAgB,EAChB,OAAe,EACf,YAAoB,EACpB,SAAiB;IAEjB,IAAI;QACF,IAAI,CAAC,QAAQ;YACX,QAAQ,IAAI,CACV;YAEF,OAAO,MAAM,qCAAqC;QACpD;QAEA,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC;YACvB,MAAM;YACN,IAAI;YACJ,SAAS,CAAC,IAAI,EAAE,QAAQ,mBAAmB,CAAC;YAC5C,MAAM,CAAC;;;;;;6EAMgE,EAAE,aAAa;;;cAG9E,EAAE,UAAU;;;;;gHAKsF,EAAE,SAAS;;;;mGAIxB,EAAE,aAAa;;;;;;;;;;;;;;;MAe5G,CAAC;QACH;QAEA,QAAQ,GAAG,CAAC,CAAC,2BAA2B,EAAE,eAAe;QACzD,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,OAAO;IACT;AACF;AAEO,eAAe,2BAA2B,MAsChD;IACC,IAAI;QACF,IAAI,CAAC,QAAQ;YACX,QAAQ,IAAI,CACV;YAEF,OAAO,MAAM,0CAA0C;QACzD;QAEA,MAAM,YAAY,IAAA,oKAA8B,EAAC;QAEjD,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC;YACvB,MAAM;YACN,IAAI,OAAO,aAAa;YACxB,SAAS,CAAC,4BAA4B,EAAE,OAAO,WAAW,EAAE;YAC5D,MAAM;QACR;QAEA,QAAQ,GAAG,CAAC,CAAC,iCAAiC,EAAE,OAAO,aAAa,EAAE,EAAE;YACtE,aAAa,OAAO,WAAW;YAC/B,WAAW,OAAO,KAAK,CAAC,MAAM;QAChC;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2CAA2C;QACzD,OAAO;IACT;AACF;AAEO,eAAe,uBACpB,aAAqB,EACrB,YAAoB,EACpB,SAAiB;IAEjB,IAAI;QACF,IAAI,CAAC,QAAQ;YACX,QAAQ,IAAI,CACV;YAEF,OAAO,MAAM,sDAAsD;QACrE;QAEA,MAAM,YAAY,IAAA,4JAA0B,EAAC;YAC3C;YACA;YACA,WAAW;QACb;QAEA,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC;YACvB,MAAM;YACN,IAAI;YACJ,SAAS;YACT,MAAM;QACR;QAEA,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,eAAe;QAC3D,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uCAAuC;QACrD,OAAO;IACT;AACF"}},
    {"offset": {"line": 1264, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/utils/supabase.ts"],"sourcesContent":["import { createClient, SupabaseClient } from \"@supabase/supabase-js\";\r\n\r\nconst supabaseUrl =\r\n  process.env.SUPABASE_URL ||\r\n  process.env.VITE_SUPABASE_URL ||\r\n  \"https://bxkphaslciswfspuqdgo.supabase.co\";\r\nconst supabaseServiceKey =\r\n  process.env.SUPABASE_SERVICE_KEY || process.env.VITE_SUPABASE_ANON_KEY || \"\";\r\n\r\nconsole.log(\"Supabase Client Initialization:\");\r\nconsole.log(\"  URL:\", supabaseUrl);\r\nconsole.log(\r\n  \"  Key Length:\",\r\n  supabaseServiceKey ? supabaseServiceKey.length : \"0 (Missing)\",\r\n);\r\n\r\nif (!supabaseServiceKey) {\r\n  console.warn(\r\n    \"SUPABASE_SERVICE_KEY not configured - Supabase operations may fail\",\r\n  );\r\n}\r\n\r\n// Use a placeholder key during build/initialization if no key is provided\r\n// This prevents errors during module evaluation\r\nconst buildTimeKey =\r\n  \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1idWlsZC1wbGFjZWhvbGRlciJ9.dummy\";\r\nconst keyToUse = supabaseServiceKey || buildTimeKey;\r\n\r\n/**\r\n * Service role client - ONLY for background jobs and migrations\r\n * SECURITY: This client bypasses RLS. Use sparingly and document why.\r\n */\r\nexport const supabase = createClient(supabaseUrl, keyToUse, {\r\n  auth: {\r\n    persistSession: false,\r\n  },\r\n  global: {\r\n    fetch: (url, options) => {\r\n      return fetch(url, { ...options, timeout: 20000 } as any);\r\n    },\r\n  },\r\n});\r\n\r\n/**\r\n * Create a scoped Supabase client using user's JWT token\r\n * SECURITY: This enforces Row Level Security (RLS) by using the authenticated user's JWT\r\n *\r\n * Use this for all customer-facing API routes to ensure RLS policies are enforced.\r\n * RLS policies will check that the authenticated user can only access their own data.\r\n *\r\n * @param userJwt - The user's JWT token from the Authorization header\r\n * @returns Scoped Supabase client with RLS enforcement\r\n *\r\n * Example usage in a route:\r\n * ```typescript\r\n * const scopedSupabase = createScopedSupabaseClient(req.userJwt);\r\n * const { data } = await scopedSupabase.from('orders').select('*'); // RLS enforced\r\n * ```\r\n */\r\nexport function createScopedSupabaseClient(userJwt: string): SupabaseClient {\r\n  return createClient(supabaseUrl, userJwt, {\r\n    auth: {\r\n      persistSession: false,\r\n    },\r\n    global: {\r\n      fetch: (url, options) => {\r\n        return fetch(url, { ...options, timeout: 20000 } as any);\r\n      },\r\n    },\r\n  });\r\n}\r\n\r\n/**\n * Get or create a scoped Supabase client from request\n * SECURITY: Enforces RLS by using the user's JWT token\n *\n * @param req - Express request with userJwt from auth middleware\n * @returns Scoped Supabase client with RLS enforcement\n */\nexport function getScopedSupabaseClient(req: any): SupabaseClient {\n  const userJwt = req.userJwt;\n  \n  if (!userJwt) {\n    throw new Error(\"Authentication required for database access\");\n  }\n  \n  // Create scoped client with user's JWT to enforce RLS\n  return createScopedSupabaseClient(userJwt);\n}\n\r\n// Verify connection\r\n(async () => {\r\n  try {\r\n    const { error } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"count\", { count: \"exact\", head: true });\r\n\r\n    if (error) {\r\n      console.error(\"Supabase connection check failed:\", error.message);\r\n    } else {\r\n      console.log(\"Supabase connection check successful\");\r\n    }\r\n  } catch (err) {\r\n    console.error(\"Supabase connection check error:\", err);\r\n  }\r\n})();\r\n\r\ninterface CustomerData {\r\n  id: number;\r\n  email: string;\r\n  first_name?: string;\r\n  last_name?: string;\r\n  phone?: string;\r\n  company?: string;\r\n  store_credit?: number;\r\n}\r\n\r\nexport async function syncCustomerToSupabase(\r\n  customer: CustomerData,\r\n): Promise<void> {\r\n  try {\r\n    const { data: existingCustomer, error: fetchError } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"*\")\r\n      .eq(\"id\", customer.id)\r\n      .single();\r\n\r\n    if (fetchError && fetchError.code !== \"PGRST116\") {\r\n      console.error(\"Error checking existing customer:\", fetchError);\r\n      throw fetchError;\r\n    }\r\n\r\n    if (existingCustomer) {\r\n      // Update existing customer\r\n      const { error: updateError } = await supabase\r\n        .from(\"customers\")\r\n        .update({\r\n          email: customer.email,\r\n          first_name: customer.first_name,\r\n          last_name: customer.last_name,\r\n          phone: customer.phone,\r\n          company: customer.company,\r\n          store_credit: customer.store_credit || 0,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", customer.id);\r\n\r\n      if (updateError) {\r\n        console.error(\"Error updating customer:\", updateError);\r\n        throw updateError;\r\n      }\r\n\r\n      console.log(\"Customer updated in Supabase:\", customer.id);\r\n    } else {\r\n      // Insert new customer\r\n      const { error: insertError } = await supabase.from(\"customers\").insert({\r\n        id: customer.id,\r\n        email: customer.email,\r\n        first_name: customer.first_name,\r\n        last_name: customer.last_name,\r\n        phone: customer.phone,\r\n        company: customer.company,\r\n        store_credit: customer.store_credit || 0,\r\n      });\r\n\r\n      if (insertError) {\r\n        console.error(\"Error inserting customer:\", insertError);\r\n        throw insertError;\r\n      }\r\n\r\n      console.log(\"Customer inserted in Supabase:\", customer.id);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error syncing customer to Supabase:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nexport async function getCustomerStoreCredit(\r\n  customerId: number,\r\n): Promise<number> {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"store_credit\")\r\n      .eq(\"id\", customerId)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching store credit from Supabase:\", error);\r\n      return 0;\r\n    }\r\n\r\n    return data?.store_credit || 0;\r\n  } catch (error) {\r\n    console.error(\"Error getting customer store credit:\", error);\r\n    return 0;\r\n  }\r\n}\r\n\r\nexport async function updateCustomerStoreCredit(\r\n  customerId: number,\r\n  amount: number,\r\n  reason: string,\r\n): Promise<boolean> {\r\n  try {\r\n    const currentBalance = await getCustomerStoreCredit(customerId);\r\n    const newBalance = Math.max(0, currentBalance + amount);\r\n\r\n    const { error: updateError } = await supabase\r\n      .from(\"customers\")\r\n      .update({ store_credit: newBalance })\r\n      .eq(\"id\", customerId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Error updating store credit:\", updateError);\r\n      return false;\r\n    }\r\n\r\n    const { error: transactionError } = await supabase\r\n      .from(\"store_credit_transactions\")\r\n      .insert({\r\n        customer_id: customerId,\r\n        amount,\r\n        reason,\r\n        new_balance: newBalance,\r\n        created_at: new Date().toISOString(),\r\n      });\r\n\r\n    if (transactionError) {\r\n      console.error(\"Error recording transaction:\", transactionError);\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"Error updating customer store credit:\", error);\r\n    return false;\r\n  }\r\n}\r\n\r\ninterface OrderData {\r\n  customer_id: number;\r\n  status: string;\r\n  total: number;\r\n  subtotal?: number;\r\n  tax?: number;\r\n  shipping?: number;\r\n  discount?: number;\r\n  discount_code?: string;\r\n  billing_address?: any;\r\n  shipping_address?: any;\r\n  items?: any[];\r\n  bigcommerce_order_id?: number;\r\n  estimated_delivery_date?: string;\r\n}\r\n\r\n/**\r\n * Normalize address format from camelCase to snake_case for database storage\r\n * Handles both formats to be flexible with different input sources\r\n */\r\nfunction normalizeAddressFormat(address: any): any {\r\n  if (!address) return null;\r\n\r\n  return {\r\n    first_name: address.first_name || address.firstName || \"\",\r\n    last_name: address.last_name || address.lastName || \"\",\r\n    street_1: address.street_1 || address.street || \"\",\r\n    street_2: address.street_2 || address.street2 || undefined,\r\n    city: address.city || \"\",\r\n    state_or_province: address.state_or_province || address.state || \"\",\r\n    postal_code: address.postal_code || address.postalCode || \"\",\r\n    country_iso2: address.country_iso2 || address.country || \"\",\r\n    phone: address.phone || undefined,\r\n  };\r\n}\r\n\r\nexport async function createSupabaseOrder(\r\n  orderData: OrderData,\r\n): Promise<{ id: number; success: boolean }> {\r\n  try {\r\n    // Build order object with only columns that exist in the schema\r\n    const orderToInsert: any = {\r\n      customer_id: orderData.customer_id,\r\n      status: orderData.status || \"paid\",\r\n      total: orderData.total,\r\n      subtotal: orderData.subtotal || 0,\r\n      tax: orderData.tax || 0,\r\n      shipping: orderData.shipping || 0,\r\n      items: orderData.items || [],\r\n    };\r\n\r\n    // Add optional fields if they exist and column exists in schema\r\n    if (orderData.bigcommerce_order_id) {\r\n      orderToInsert.bigcommerce_order_id = orderData.bigcommerce_order_id;\r\n    }\r\n    // Note: discount and discount_code columns don't exist yet in the database\r\n    // They are tracked but not persisted to the orders table at this time\r\n    if (orderData.estimated_delivery_date) {\r\n      orderToInsert.estimated_delivery_date = orderData.estimated_delivery_date;\r\n    }\r\n    if (orderData.shipping_address) {\r\n      orderToInsert.shipping_address = normalizeAddressFormat(\r\n        orderData.shipping_address,\r\n      );\r\n    }\r\n    if (orderData.billing_address) {\r\n      orderToInsert.billing_address = normalizeAddressFormat(\r\n        orderData.billing_address,\r\n      );\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"orders\")\r\n      .insert(orderToInsert)\r\n      .select(\"id\")\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error(\"Error creating order in Supabase:\", error);\r\n      throw error;\r\n    }\r\n\r\n    console.log(\"Order created in Supabase:\", data?.id);\r\n    return { id: data?.id, success: true };\r\n  } catch (error) {\r\n    console.error(\"Error creating Supabase order:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nexport async function createOrderItems(\r\n  orderId: number,\r\n  items: any[],\r\n): Promise<void> {\r\n  try {\r\n    const itemsData = items.map((item) => ({\r\n      order_id: orderId,\r\n      product_id: item.product_id,\r\n      product_name: item.product_name || \"Custom Sticker\",\r\n      quantity: item.quantity,\r\n      price: item.price || 0.25,\r\n      options: item.options || null,\r\n      design_file_url: item.design_file_url || null,\r\n    }));\r\n\r\n    const { error } = await supabase.from(\"order_items\").insert(itemsData);\r\n\r\n    if (error) {\r\n      console.error(\"Error creating order items:\", error);\r\n      throw error;\r\n    }\r\n\r\n    console.log(\"Order items created:\", orderId);\r\n  } catch (error) {\r\n    console.error(\"Error creating order items:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nexport async function getOrderById(\r\n  orderId: number,\r\n  customerId: number,\r\n): Promise<any> {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"orders\")\r\n      .select(\r\n        `\r\n        *,\r\n        order_items (*)\r\n      `,\r\n      )\r\n      .eq(\"id\", orderId)\r\n      .eq(\"customer_id\", customerId)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching order:\", error);\r\n      throw error;\r\n    }\r\n\r\n    return data;\r\n  } catch (error) {\r\n    console.error(\"Error getting order:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nexport async function getCustomerOrders(customerId: number): Promise<any[]> {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"orders\")\r\n      .select(\r\n        \"*, customers(id, first_name, last_name, email, phone), order_items(*)\",\r\n      )\r\n      .eq(\"customer_id\", customerId)\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching customer orders:\", error);\r\n      throw error;\r\n    }\r\n\r\n    return data || [];\r\n  } catch (error) {\r\n    console.error(\"Error getting customer orders:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nexport async function getPendingOrders(): Promise<any[]> {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"*, customers(*), order_items(*)\")\r\n      .eq(\"status\", \"pending\")\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching pending orders:\", error);\r\n      throw error;\r\n    }\r\n\r\n    return data || [];\r\n  } catch (error) {\r\n    console.error(\"Error getting pending orders:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nexport async function getActiveOrders(): Promise<any[]> {\r\n  try {\r\n    const activeStatuses = [\r\n      \"pending\",\r\n      \"processing\",\r\n      \"printing\",\r\n      \"in transit\",\r\n      \"paid\",\r\n      \"pending_payment\",\r\n    ];\r\n    // Simplified query - only fetch what's needed\r\n    const { data, error } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"id, customer_id, status, total, created_at\")\r\n      .in(\"status\", activeStatuses)\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(50); // Reduced limit for better performance\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching active orders:\", error);\r\n      return [];\r\n    }\r\n\r\n    return data || [];\r\n  } catch (error) {\r\n    console.error(\"Error getting active orders:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Get count of active orders (for badge/notification)\r\n * Much faster than fetching full orders\r\n */\r\nexport async function getActiveOrdersCount(): Promise<number> {\r\n  try {\r\n    const activeStatuses = [\r\n      \"pending\",\r\n      \"processing\",\r\n      \"printing\",\r\n      \"in transit\",\r\n      \"paid\",\r\n      \"pending_payment\",\r\n    ];\r\n    const { count, error } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"id\", { count: \"exact\", head: true })\r\n      .in(\"status\", activeStatuses);\r\n\r\n    if (error) {\r\n      console.error(\"Error counting active orders:\", error);\r\n      return 0;\r\n    }\r\n\r\n    return count || 0;\r\n  } catch (error) {\r\n    console.error(\"Error getting active orders count:\", error);\r\n    return 0;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1630, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/auth.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport bcrypt from \"bcryptjs\";\r\nimport { ecwidAPI } from \"../utils/ecwid\";\r\nimport { sendPasswordResetEmail } from \"../utils/email\";\r\n\r\nimport { supabase } from \"../utils/supabase\";\r\n\r\n// Removed local Supabase initialization in favor of shared client\r\n// const supabase = createClient(...)\r\n\r\ninterface LoginRequest {\r\n  email: string;\r\n  password: string;\r\n}\r\n\r\ninterface SignupRequest {\r\n  firstName: string;\r\n  lastName: string;\r\n  email: string;\r\n  password: string;\r\n}\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET;\nif (!JWT_SECRET) {\n  throw new Error(\n    \"JWT_SECRET environment variable is not configured. This is required for authentication. Set JWT_SECRET in your environment variables.\",\n  );\n}\n\n// Admin setup key - MUST be set in production\nconst ADMIN_SETUP_KEY = process.env.ADMIN_SETUP_KEY;\nif (process.env.NODE_ENV === 'production' && !ADMIN_SETUP_KEY) {\n  throw new Error(\n    \"ADMIN_SETUP_KEY environment variable is required in production. Set a strong random value.\",\n  );\n}\n\r\n/**\n * Validate password strength\n * Requires: 8+ chars, uppercase, lowercase, number, special char\n */\nfunction validatePasswordStrength(password: string): { valid: boolean; message: string } {\n  if (password.length < 8) {\n    return { valid: false, message: \"Password must be at least 8 characters long\" };\n  }\n  if (!/[A-Z]/.test(password)) {\n    return { valid: false, message: \"Password must contain at least one uppercase letter\" };\n  }\n  if (!/[a-z]/.test(password)) {\n    return { valid: false, message: \"Password must contain at least one lowercase letter\" };\n  }\n  if (!/[0-9]/.test(password)) {\n    return { valid: false, message: \"Password must contain at least one number\" };\n  }\n  if (!/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/.test(password)) {\n    return { valid: false, message: \"Password must contain at least one special character\" };\n  }\n  return { valid: true, message: \"\" };\n}\n\n/**\n * Generate JWT token for session\n */\nfunction generateToken(customerId: number, email: string): string {\n  return jwt.sign(\n    { customerId, email, iat: Math.floor(Date.now() / 1000) },\n    JWT_SECRET,\n    { expiresIn: \"7d\" }, // Reduced from 30d for security\n  );\n}\n\r\nexport const handleLogin: RequestHandler = async (req, res) => {\r\n  try {\r\n    console.log(\"LOGIN ATTEMPT:\", {\r\n      headers: {\r\n        \"content-type\": req.headers[\"content-type\"],\r\n        \"content-length\": req.headers[\"content-length\"],\r\n      },\r\n      bodyKeys: Object.keys(req.body || {}),\r\n      bodyType: typeof req.body,\r\n      emailMap: req.body?.email ? \"present\" : \"missing\",\r\n    });\r\n\r\n    const { email, password } = req.body as LoginRequest;\r\n\r\n    if (!email || !password) {\r\n      console.log(\"LOGIN FAILED: Missing credentials\", {\r\n        hasEmail: !!email,\r\n        hasPassword: !!password,\r\n      });\r\n      return res.status(400).json({\n        error: \"Email and password required\",\n        debug: {\n          receivedBodyType: typeof req.body,\n          receivedBodyKeys: Object.keys(req.body || {}),\n          // SECURITY: Never expose request body or password in responses\n          hasEmail: !!req.body?.email,\n          hasPassword: !!req.body?.password,\n          contentType: req.headers[\"content-type\"],\n        },\n      });\n    }\r\n\r\n    // Get customer from Supabase\r\n    const { data: customer, error } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"*\")\r\n      .eq(\"email\", email)\r\n      .single();\r\n\r\n    if (error || !customer) {\r\n      console.log(\"LOGIN FAILED: Customer not found or error\", {\r\n        email,\r\n        error: error?.message,\r\n      });\r\n      return res.status(401).json({ error: \"Invalid email or password\" });\r\n    }\r\n\r\n    // Verify password\r\n    const passwordMatch = await bcrypt.compare(\r\n      password,\r\n      customer.password_hash || \"\",\r\n    );\r\n    if (!passwordMatch) {\r\n      return res.status(401).json({ error: \"Invalid email or password\" });\r\n    }\r\n\r\n    // Generate JWT token\r\n    const token = generateToken(customer.id, customer.email);\r\n\r\n    res.json({\r\n      success: true,\r\n      token,\r\n      customer: {\r\n        id: customer.id,\r\n        email: customer.email,\r\n        firstName: customer.first_name,\r\n        lastName: customer.last_name,\r\n        isAdmin: customer.is_admin || false,\r\n      },\r\n      message: \"Login successful\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Login error:\", error);\r\n    res.status(500).json({ error: \"Login failed\" });\r\n  }\r\n};\r\n\r\nexport const handleSignup: RequestHandler = async (req, res) => {\r\n  try {\r\n    console.log(\"Signup request received:\", {\n      method: req.method,\n      url: req.url,\n      headers: {\n        \"Content-Type\": req.get(\"Content-Type\"),\n        \"Content-Length\": req.get(\"Content-Length\"),\n      },\n      bodyType: typeof req.body,\n      // SECURITY: Never log request body as it may contain passwords\n      bodyKeys: Object.keys(req.body || {}),\n      hasEmail: !!req.body?.email,\n      hasPassword: !!req.body?.password,\n    });\n\r\n    const { firstName, lastName, email, password } = req.body as SignupRequest;\r\n\r\n    if (!firstName || !lastName || !email || !password) {\r\n      console.log(\"Missing required fields:\", {\r\n        firstName: !!firstName,\r\n        lastName: !!lastName,\r\n        email: !!email,\r\n        password: !!password,\r\n      });\r\n      return res.status(400).json({\r\n        error: \"First name, last name, email, and password are required\",\r\n        received: { firstName, lastName, email, password },\r\n      });\r\n    }\r\n\r\n    // Validate password strength\n    const passwordValidation = validatePasswordStrength(password);\n    if (!passwordValidation.valid) {\n      return res.status(400).json({ \n        error: passwordValidation.message \n      });\n    }\n\r\n    console.log(\"Signup attempt for:\", email);\r\n\r\n    // Check if customer already exists in Supabase\r\n    const { data: existingCustomer } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"id, ecwid_customer_id, password_hash\")\r\n      .eq(\"email\", email)\r\n      .single();\r\n\r\n    if (existingCustomer) {\r\n      // If they already have a password, reject signup\r\n      if (existingCustomer.password_hash) {\r\n        console.log(\"Email already registered with password:\", email);\r\n        return res.status(409).json({ error: \"Email already registered\" });\r\n      }\r\n      // If they came from Ecwid but haven't set password yet, update their account\r\n      if (existingCustomer.ecwid_customer_id) {\r\n        const passwordHash = await bcrypt.hash(password, 10);\r\n        const { data: updatedCustomer, error: updateError } = await supabase\r\n          .from(\"customers\")\r\n          .update({ password_hash: passwordHash })\r\n          .eq(\"id\", existingCustomer.id)\r\n          .select()\r\n          .single();\r\n\r\n        if (updateError || !updatedCustomer) {\r\n          console.error(\"Error updating Ecwid customer account:\", updateError);\r\n          return res.status(500).json({ error: \"Failed to create account\" });\r\n        }\r\n\r\n        const token = generateToken(updatedCustomer.id, updatedCustomer.email);\r\n        return res.json({\r\n          success: true,\r\n          token,\r\n          customer: {\r\n            id: updatedCustomer.id,\r\n            email: updatedCustomer.email,\r\n            firstName: updatedCustomer.first_name,\r\n            lastName: updatedCustomer.last_name,\r\n            isAdmin: updatedCustomer.is_admin || false,\r\n          },\r\n          message: \"Account activated with password\",\r\n        });\r\n      }\r\n    }\r\n\r\n    // Hash password\r\n    const passwordHash = await bcrypt.hash(password, 10);\r\n\r\n    console.log(\"Creating customer in Supabase and Ecwid:\", {\r\n      email,\r\n      firstName,\r\n      lastName,\r\n    });\r\n\r\n    // Check admin status - only allow specific admin emails from environment\n    const adminEmails = process.env.ADMIN_EMAILS?.split(',').map(e => e.trim().toLowerCase()) || [];\n    const isAdminEmail = adminEmails.includes(email.toLowerCase());\n\r\n    // Create customer in Supabase\r\n    const { data: newCustomer, error } = await supabase\r\n      .from(\"customers\")\r\n      .insert({\r\n        email,\r\n        first_name: firstName,\r\n        last_name: lastName,\r\n        password_hash: passwordHash,\r\n        store_credit: 0,\r\n        is_admin: isAdminEmail,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (error || !newCustomer) {\r\n      console.error(\"Supabase Customer Creation Error:\", error);\r\n      throw new Error(`Failed to create customer account: ${error?.message || \"Unknown error\"}`);\r\n    }\r\n\r\n    console.log(\"Customer created in Supabase:\", newCustomer.id);\r\n\r\n    // Create customer in Ecwid\r\n    let ecwidCustomerId: number | null = null;\r\n    try {\r\n      const ecwidCustomer = await ecwidAPI.createCustomer({\r\n        email,\r\n        firstName,\r\n        lastName,\r\n      });\r\n      ecwidCustomerId = ecwidCustomer.id;\r\n      console.log(\"Customer created in Ecwid:\", ecwidCustomerId);\r\n    } catch (ecwidError) {\r\n      console.warn(\"Warning: Failed to create customer in Ecwid:\", ecwidError);\r\n      // Don't fail the signup if Ecwid creation fails\r\n      // But log it for monitoring\r\n    }\r\n\r\n    // Generate JWT token\r\n    const token = generateToken(newCustomer.id, newCustomer.email);\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      token,\r\n      customer: {\r\n        id: newCustomer.id,\r\n        email: newCustomer.email,\r\n        firstName: newCustomer.first_name,\r\n        lastName: newCustomer.last_name,\r\n        isAdmin: newCustomer.is_admin || false,\r\n        ecwidId: ecwidCustomerId,\r\n      },\r\n      message: \"Account created successfully\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Signup error:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Signup failed\";\r\n    res.status(500).json({ error: errorMessage });\r\n  }\r\n};\r\n\r\n// Admin setup - creates or updates admin user\nexport const handleAdminSetup: RequestHandler = async (req, res) => {\n  try {\n    const { email, password, firstName, lastName } = req.body;\n    const setupKey = req.headers[\"x-admin-setup-key\"];\n\n    // Validate setup key is configured\n    if (!ADMIN_SETUP_KEY) {\n      console.error(\"[SECURITY] ADMIN_SETUP_KEY not configured\");\n      return res.status(503).json({ error: \"Admin setup is not configured\" });\n    }\n\n    if (setupKey !== ADMIN_SETUP_KEY) {\n      console.warn(\"[SECURITY] Invalid admin setup key attempt\");\n      return res.status(403).json({ error: \"Invalid setup key\" });\n    }\n\r\n    if (!email || !password) {\r\n      return res.status(400).json({ error: \"Email and password are required\" });\r\n    }\r\n\r\n    // Check if admin already exists\r\n    const { data: existingAdmin } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"id\")\r\n      .eq(\"email\", email)\r\n      .single();\r\n\r\n    const passwordHash = await bcrypt.hash(password, 10);\r\n\r\n    if (existingAdmin) {\r\n      // Update existing user to admin\r\n      const { data: updated, error } = await supabase\r\n        .from(\"customers\")\r\n        .update({\r\n          password_hash: passwordHash,\r\n          is_admin: true,\r\n        })\r\n        .eq(\"email\", email)\r\n        .select()\r\n        .single();\r\n\r\n      if (error || !updated) {\r\n        throw new Error(\"Failed to update admin user\");\r\n      }\r\n\r\n      const token = generateToken(updated.id, updated.email);\r\n      return res.json({\r\n        success: true,\r\n        message: \"Admin user updated successfully\",\r\n        token,\r\n        customer: {\r\n          id: updated.id,\r\n          email: updated.email,\r\n          firstName: updated.first_name,\r\n          lastName: updated.last_name,\r\n          isAdmin: true,\r\n        },\r\n      });\r\n    }\r\n\r\n    // Create new admin user\r\n    const { data: newAdmin, error } = await supabase\r\n      .from(\"customers\")\r\n      .insert({\r\n        email,\r\n        first_name: firstName || \"Admin\",\r\n        last_name: lastName || \"User\",\r\n        password_hash: passwordHash,\r\n        is_admin: true,\r\n        store_credit: 0,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (error || !newAdmin) {\r\n      throw new Error(\"Failed to create admin user\");\r\n    }\r\n\r\n    const token = generateToken(newAdmin.id, newAdmin.email);\r\n    res.status(201).json({\r\n      success: true,\r\n      message: \"Admin user created successfully\",\r\n      token,\r\n      customer: {\r\n        id: newAdmin.id,\r\n        email: newAdmin.email,\r\n        firstName: newAdmin.first_name,\r\n        lastName: newAdmin.last_name,\r\n        isAdmin: true,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Admin setup error:\", error);\r\n    res.status(500).json({\r\n      error: error instanceof Error ? error.message : \"Admin setup failed\",\r\n    });\r\n  }\r\n};\r\n\r\n\r\n\r\nexport const handleLogout: RequestHandler = (req, res) => {\r\n  try {\r\n    // JWT tokens are stateless, so logout is handled client-side\r\n    // Client should remove token from localStorage\r\n    res.json({ success: true, message: \"Logged out successfully\" });\r\n  } catch (error) {\r\n    console.error(\"Logout error:\", error);\r\n    res.status(500).json({ error: \"Logout failed\" });\r\n  }\r\n};\r\n\r\nexport const handleRequestPasswordReset: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { email } = req.body;\r\n\r\n    if (!email) {\r\n      return res.status(400).json({ error: \"Email is required\" });\r\n    }\r\n\r\n    // Get customer from Supabase\r\n    const { data: customer } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"*\")\r\n      .eq(\"email\", email)\r\n      .single();\r\n\r\n    // Don't reveal if email exists (security best practice)\r\n    if (!customer) {\r\n      return res.json({\r\n        success: true,\r\n        message:\r\n          \"If an account exists with this email, a password reset link has been sent\",\r\n      });\r\n    }\r\n\r\n    // Generate password reset token (expires in 1 hour)\r\n    const resetToken = jwt.sign(\r\n      { customerId: customer.id, email: customer.email, type: \"password-reset\" },\r\n      JWT_SECRET,\r\n      { expiresIn: \"1h\" },\r\n    );\r\n\r\n    // Get frontend URL from environment or request\r\n    const frontendUrl =\r\n      process.env.FRONTEND_URL ||\r\n      `${req.protocol}://${req.get(\"host\").replace(\":8080\", \":5173\")}`;\r\n    const resetLink = `${frontendUrl}/reset-password?token=${resetToken}`;\r\n\r\n    // Send password reset email\r\n    await sendPasswordResetEmail(\r\n      customer.email,\r\n      customer.first_name || \"Customer\",\r\n      resetLink,\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      message:\r\n        \"If an account exists with this email, a password reset link has been sent\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Password reset request error:\", error);\r\n    res.status(500).json({ error: \"Failed to process password reset request\" });\r\n  }\r\n};\r\n\r\nexport const handleResetPassword: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { token, newPassword } = req.body;\r\n\r\n    if (!token || !newPassword) {\r\n      return res\r\n        .status(400)\r\n        .json({ error: \"Token and new password are required\" });\r\n    }\r\n\r\n    const passwordValidation = validatePasswordStrength(newPassword);\n    if (!passwordValidation.valid) {\n      return res.status(400).json({ error: passwordValidation.message });\n    }\n\r\n    // Verify reset token\r\n    let decoded;\r\n    try {\r\n      decoded = jwt.verify(token, JWT_SECRET) as {\r\n        customerId: number;\r\n        email: string;\r\n        type: string;\r\n      };\r\n    } catch (error) {\r\n      return res.status(401).json({ error: \"Invalid or expired reset token\" });\r\n    }\r\n\r\n    if (decoded.type !== \"password-reset\") {\r\n      return res.status(401).json({ error: \"Invalid token type\" });\r\n    }\r\n\r\n    // Hash new password\r\n    const passwordHash = await bcrypt.hash(newPassword, 10);\r\n\r\n    // Update customer password in Supabase\r\n    const { data: updatedCustomer, error } = await supabase\r\n      .from(\"customers\")\r\n      .update({ password_hash: passwordHash })\r\n      .eq(\"id\", decoded.customerId)\r\n      .select()\r\n      .single();\r\n\r\n    if (error || !updatedCustomer) {\r\n      throw new Error(\"Failed to update password\");\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Password reset successfully\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Password reset error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to reset password\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2117, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/middleware/rate-limit.ts"],"sourcesContent":["import rateLimit from \"express-rate-limit\";\r\n\r\n// Custom error handler that returns JSON instead of plain text\r\nconst handleRateLimitError = (req: any, res: any, options: any) => {\r\n  res.status(options.statusCode).json({\r\n    error: options.message,\r\n    retryAfter: Math.ceil(options.windowMs / 1000),\r\n  });\r\n};\r\n\r\n/**\r\n * General API rate limiter\r\n * 15 minutes window, max 150 requests per IP\r\n */\r\nexport const apiLimiter = rateLimit({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  max: 150, // Limit each IP to 150 requests per windowMs\r\n  message: \"Too many requests from this IP address, please try again later.\",\r\n  standardHeaders: true, // Return rate limit info in the `RateLimit-*` headers\r\n  legacyHeaders: false, // Disable the `X-RateLimit-*` headers\r\n  handler: handleRateLimitError, // Use JSON response handler\r\n  skip: (req) => {\r\n    // Skip rate limiting for:\r\n    // 1. Health checks\r\n    // 2. Webhook endpoints\r\n    // 3. CORS preflight requests\r\n    return (\r\n      req.path === \"/health\" ||\r\n      req.path.includes(\"/webhooks/\") ||\r\n      req.method === \"OPTIONS\"\r\n    );\r\n  },\r\n});\r\n\r\n/**\r\n * Strict rate limiter for authentication endpoints\r\n * 15 minutes window, max 5 login/signup attempts per IP\r\n */\r\nexport const authLimiter = rateLimit({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  max: 5, // Limit each IP to 5 requests per windowMs\r\n  message: \"Too many login/signup attempts. Please try again after 15 minutes.\",\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n  handler: handleRateLimitError, // Use JSON response handler\r\n  skipSuccessfulRequests: true, // Don't count successful requests\r\n  skipFailedRequests: false, // Count failed requests\r\n});\r\n\r\n/**\r\n * Strict rate limiter for payment endpoints\r\n * 5 minutes window, max 10 payment attempts per IP\r\n */\r\nexport const paymentLimiter = rateLimit({\r\n  windowMs: 5 * 60 * 1000, // 5 minutes\r\n  max: 10, // Limit each IP to 10 requests per windowMs\r\n  message: \"Too many payment attempts. Please try again after 5 minutes.\",\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n  handler: handleRateLimitError, // Use JSON response handler\r\n});\r\n\r\n/**\r\n * Moderate rate limiter for checkout endpoints\r\n * 5 minutes window, max 20 checkout attempts per IP\r\n */\r\nexport const checkoutLimiter = rateLimit({\r\n  windowMs: 5 * 60 * 1000, // 5 minutes\r\n  max: 20, // Limit each IP to 20 requests per windowMs\r\n  message: \"Too many checkout attempts. Please try again after 5 minutes.\",\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n  handler: handleRateLimitError, // Use JSON response handler\r\n});\r\n\r\n/**\r\n * Admin rate limiter\r\n * 5 minutes window, max 50 requests per IP for admin operations\r\n */\r\nexport const adminLimiter = rateLimit({\r\n  windowMs: 5 * 60 * 1000, // 5 minutes\r\n  max: 50, // Limit each IP to 50 requests per windowMs\r\n  message: \"Too many admin operations. Please try again after 5 minutes.\",\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n  handler: handleRateLimitError, // Use JSON response handler\r\n});\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;AAEA,+DAA+D;AAC/D,MAAM,uBAAuB,CAAC,KAAU,KAAU;IAChD,IAAI,MAAM,CAAC,QAAQ,UAAU,EAAE,IAAI,CAAC;QAClC,OAAO,QAAQ,OAAO;QACtB,YAAY,KAAK,IAAI,CAAC,QAAQ,QAAQ,GAAG;IAC3C;AACF;AAMO,MAAM,aAAa,IAAA,0NAAS,EAAC;IAClC,UAAU,KAAK,KAAK;IACpB,KAAK;IACL,SAAS;IACT,iBAAiB;IACjB,eAAe;IACf,SAAS;IACT,MAAM,CAAC;QACL,0BAA0B;QAC1B,mBAAmB;QACnB,uBAAuB;QACvB,6BAA6B;QAC7B,OACE,IAAI,IAAI,KAAK,aACb,IAAI,IAAI,CAAC,QAAQ,CAAC,iBAClB,IAAI,MAAM,KAAK;IAEnB;AACF;AAMO,MAAM,cAAc,IAAA,0NAAS,EAAC;IACnC,UAAU,KAAK,KAAK;IACpB,KAAK;IACL,SAAS;IACT,iBAAiB;IACjB,eAAe;IACf,SAAS;IACT,wBAAwB;IACxB,oBAAoB;AACtB;AAMO,MAAM,iBAAiB,IAAA,0NAAS,EAAC;IACtC,UAAU,IAAI,KAAK;IACnB,KAAK;IACL,SAAS;IACT,iBAAiB;IACjB,eAAe;IACf,SAAS;AACX;AAMO,MAAM,kBAAkB,IAAA,0NAAS,EAAC;IACvC,UAAU,IAAI,KAAK;IACnB,KAAK;IACL,SAAS;IACT,iBAAiB;IACjB,eAAe;IACf,SAAS;AACX;AAMO,MAAM,eAAe,IAAA,0NAAS,EAAC;IACpC,UAAU,IAAI,KAAK;IACnB,KAAK;IACL,SAAS;IACT,iBAAiB;IACjB,eAAe;IACf,SAAS;AACX"}},
    {"offset": {"line": 2198, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/auth.router.ts"],"sourcesContent":["import { Router } from \"express\";\r\nimport {\r\n  handleLogin,\r\n  handleSignup,\r\n  handleLogout,\r\n  handleAdminSetup,\r\n  handleRequestPasswordReset,\r\n  handleResetPassword,\r\n} from \"./auth\";\r\nimport { authLimiter } from \"../middleware/rate-limit\";\r\n\r\n/**\r\n * Authentication Routes\r\n * Handles user login, signup, password reset, and admin setup\r\n */\r\nexport function createAuthRouter() {\r\n  const router = Router();\r\n\r\n  // POST /api/auth/login - User login\r\n  router.post(\"/login\", authLimiter, handleLogin);\r\n\r\n  // POST /api/auth/signup - User registration\r\n  router.post(\"/signup\", authLimiter, handleSignup);\r\n\r\n  // POST /api/auth/logout - User logout\r\n  router.post(\"/logout\", handleLogout);\r\n\r\n  // POST /api/auth/admin-setup - Initial admin setup\r\n  router.post(\"/admin-setup\", authLimiter, handleAdminSetup);\r\n\r\n  // POST /api/auth/request-password-reset - Request password reset\r\n  router.post(\r\n    \"/request-password-reset\",\r\n    authLimiter,\r\n    handleRequestPasswordReset,\r\n  );\r\n\r\n  // POST /api/auth/reset-password - Reset password with token\r\n  router.post(\"/reset-password\", handleResetPassword);\r\n\r\n  return router;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AAQA;;;;;;;;;AAMO,SAAS;IACd,MAAM,SAAS,IAAA,+JAAM;IAErB,oCAAoC;IACpC,OAAO,IAAI,CAAC,UAAU,6IAAW,EAAE,gIAAW;IAE9C,4CAA4C;IAC5C,OAAO,IAAI,CAAC,WAAW,6IAAW,EAAE,iIAAY;IAEhD,sCAAsC;IACtC,OAAO,IAAI,CAAC,WAAW,iIAAY;IAEnC,mDAAmD;IACnD,OAAO,IAAI,CAAC,gBAAgB,6IAAW,EAAE,qIAAgB;IAEzD,iEAAiE;IACjE,OAAO,IAAI,CACT,2BACA,6IAAW,EACX,+IAA0B;IAG5B,4DAA4D;IAC5D,OAAO,IAAI,CAAC,mBAAmB,wIAAmB;IAElD,OAAO;AACT"}},
    {"offset": {"line": 2236, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/middleware/auth.ts"],"sourcesContent":["import { Request, Response, NextFunction } from \"express\";\r\nimport jwt from \"jsonwebtoken\";\r\n// import { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET;\r\nif (!JWT_SECRET) {\r\n  throw new Error(\r\n    \"JWT_SECRET environment variable is not configured. This is required for authentication. Set JWT_SECRET in your environment variables.\",\r\n  );\r\n}\r\n\r\ndeclare global {\r\n  namespace Express {\r\n    interface Request {\r\n      customerId?: number;\r\n      email?: string;\r\n      isAdmin?: boolean;\r\n      userJwt?: string; // JWT token for creating scoped Supabase clients\r\n    }\r\n  }\r\n}\r\n\r\nimport { supabase } from \"../utils/supabase\";\r\n\r\n// Removed local Supabase initialization in favor of shared client\r\n// const supabase = createClient(...)\r\n\r\n/**\r\n * Middleware to verify JWT token and extract customer info\r\n * SECURITY: Stores JWT in request for creating scoped Supabase clients in routes\r\n */\r\nexport const verifyToken = async (\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction,\r\n): Promise<void> => {\r\n  try {\r\n    const authHeader = req.headers.authorization;\r\n\r\n    if (!authHeader || !authHeader.startsWith(\"Bearer \")) {\r\n      res.status(401).json({ error: \"No authorization token provided\" });\r\n      return;\r\n    }\r\n\r\n    const token = authHeader.substring(7);\r\n\r\n    const decoded = jwt.verify(token, JWT_SECRET) as {\r\n      customerId: number;\r\n      email: string;\r\n    };\r\n\r\n    req.customerId = decoded.customerId;\r\n    req.email = decoded.email;\r\n    req.userJwt = token; // Store JWT for creating scoped Supabase clients\r\n\r\n    // Fetch customer to get isAdmin status\r\n    try {\r\n      const { data: customer } = await supabase\r\n        .from(\"customers\")\r\n        .select(\"is_admin\")\r\n        .eq(\"id\", decoded.customerId)\r\n        .single();\r\n\r\n      req.isAdmin = customer?.is_admin || false;\r\n    } catch (error) {\r\n      // If we can't fetch from DB, default to false\r\n      req.isAdmin = false;\r\n    }\r\n\r\n    next();\r\n  } catch (error) {\r\n    console.error(\"Token verification error:\", error);\r\n    res.status(401).json({ error: \"Invalid or expired token\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Middleware to optionally verify token (doesn't fail if missing)\r\n * SECURITY: Stores JWT in request for creating scoped Supabase clients in routes\r\n */\r\nexport const optionalVerifyToken = async (\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction,\r\n): Promise<void> => {\r\n  try {\r\n    const authHeader = req.headers.authorization;\r\n\r\n    if (authHeader && authHeader.startsWith(\"Bearer \")) {\r\n      const token = authHeader.substring(7);\r\n      const decoded = jwt.verify(token, JWT_SECRET) as {\r\n        customerId: number;\r\n        email: string;\r\n      };\r\n\r\n      req.customerId = decoded.customerId;\r\n      req.email = decoded.email;\r\n      req.userJwt = token; // Store JWT for creating scoped Supabase clients\r\n\r\n      // Fetch customer to get isAdmin status\r\n      try {\r\n        const { data: customer } = await supabase\r\n          .from(\"customers\")\r\n          .select(\"is_admin\")\r\n          .eq(\"id\", decoded.customerId)\r\n          .single();\r\n\r\n        req.isAdmin = customer?.is_admin || false;\r\n      } catch (error) {\r\n        // If we can't fetch from DB, default to false\r\n        req.isAdmin = false;\r\n      }\r\n    }\r\n\r\n    next();\r\n  } catch (error) {\r\n    // Token verification failed, but we continue\r\n    // This is useful for endpoints that work with or without auth\r\n    next();\r\n  }\r\n};\r\n\r\n/**\r\n * Middleware to require admin role\r\n * Must be used after verifyToken middleware\r\n */\r\nexport const requireAdmin = (\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction,\r\n): void => {\r\n  if (!req.customerId) {\r\n    res.status(401).json({ error: \"Authentication required\" });\r\n    return;\r\n  }\r\n\r\n  if (!req.isAdmin) {\r\n    res.status(403).json({ error: \"Admin access required\" });\r\n    return;\r\n  }\r\n\r\n  next();\r\n};\r\n"],"names":[],"mappings":";;;;;;;;AACA;AAqBA;;;;;;AApBA,wDAAwD;AAExD,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU;AACzC,IAAI,CAAC,YAAY;IACf,MAAM,IAAI,MACR;AAEJ;;AAsBO,MAAM,cAAc,OACzB,KACA,KACA;IAEA,IAAI;QACF,MAAM,aAAa,IAAI,OAAO,CAAC,aAAa;QAE5C,IAAI,CAAC,cAAc,CAAC,WAAW,UAAU,CAAC,YAAY;YACpD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkC;YAChE;QACF;QAEA,MAAM,QAAQ,WAAW,SAAS,CAAC;QAEnC,MAAM,UAAU,+KAAG,CAAC,MAAM,CAAC,OAAO;QAKlC,IAAI,UAAU,GAAG,QAAQ,UAAU;QACnC,IAAI,KAAK,GAAG,QAAQ,KAAK;QACzB,IAAI,OAAO,GAAG,OAAO,iDAAiD;QAEtE,uCAAuC;QACvC,IAAI;YACF,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,gIAAQ,CACtC,IAAI,CAAC,aACL,MAAM,CAAC,YACP,EAAE,CAAC,MAAM,QAAQ,UAAU,EAC3B,MAAM;YAET,IAAI,OAAO,GAAG,UAAU,YAAY;QACtC,EAAE,OAAO,OAAO;YACd,8CAA8C;YAC9C,IAAI,OAAO,GAAG;QAChB;QAEA;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA2B;IAC3D;AACF;AAMO,MAAM,sBAAsB,OACjC,KACA,KACA;IAEA,IAAI;QACF,MAAM,aAAa,IAAI,OAAO,CAAC,aAAa;QAE5C,IAAI,cAAc,WAAW,UAAU,CAAC,YAAY;YAClD,MAAM,QAAQ,WAAW,SAAS,CAAC;YACnC,MAAM,UAAU,+KAAG,CAAC,MAAM,CAAC,OAAO;YAKlC,IAAI,UAAU,GAAG,QAAQ,UAAU;YACnC,IAAI,KAAK,GAAG,QAAQ,KAAK;YACzB,IAAI,OAAO,GAAG,OAAO,iDAAiD;YAEtE,uCAAuC;YACvC,IAAI;gBACF,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,gIAAQ,CACtC,IAAI,CAAC,aACL,MAAM,CAAC,YACP,EAAE,CAAC,MAAM,QAAQ,UAAU,EAC3B,MAAM;gBAET,IAAI,OAAO,GAAG,UAAU,YAAY;YACtC,EAAE,OAAO,OAAO;gBACd,8CAA8C;gBAC9C,IAAI,OAAO,GAAG;YAChB;QACF;QAEA;IACF,EAAE,OAAO,OAAO;QACd,6CAA6C;QAC7C,8DAA8D;QAC9D;IACF;AACF;AAMO,MAAM,eAAe,CAC1B,KACA,KACA;IAEA,IAAI,CAAC,IAAI,UAAU,EAAE;QACnB,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA0B;QACxD;IACF;IAEA,IAAI,CAAC,IAAI,OAAO,EAAE;QAChB,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAwB;QACtD;IACF;IAEA;AACF"}},
    {"offset": {"line": 2332, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/utils/image-processor.ts"],"sourcesContent":["/**\r\n * Optional image processor using sharp\r\n * Falls back gracefully if sharp is not available (e.g., in Netlify Functions)\r\n */\r\n\r\ninterface ProcessedImage {\r\n  buffer: Buffer;\r\n  width: number;\r\n  height: number;\r\n  format: string;\r\n}\r\n\r\nlet sharpAvailable = false;\r\nlet Sharp: any = null;\r\n\r\n// Try to load sharp, but don't fail if it's not available\r\ntry {\r\n  Sharp = require(\"sharp\");\r\n  sharpAvailable = true;\r\n} catch (error) {\r\n  console.warn(\r\n    \"Sharp not available - using original image format. This is expected in serverless environments like Netlify.\",\r\n  );\r\n}\r\n\r\n/**\r\n * Process image: resize and compress using sharp (if available)\r\n * If sharp is not available, returns the original buffer unchanged\r\n * @param buffer - Image buffer to process\r\n * @param maxWidth - Maximum width (default: 500)\r\n * @param maxHeight - Maximum height (default: 500)\r\n * @returns Processed image buffer or original if sharp unavailable\r\n */\r\nexport async function processImage(\r\n  buffer: Buffer,\r\n  maxWidth: number = 500,\r\n  maxHeight: number = 500,\r\n): Promise<Buffer> {\r\n  if (!sharpAvailable || !Sharp) {\r\n    console.log(\r\n      \"Image processing skipped - sharp not available. Image will be uploaded as-is.\",\r\n    );\r\n    return buffer;\r\n  }\r\n\r\n  try {\r\n    const processed = await Sharp(buffer)\r\n      .resize(maxWidth, maxHeight, {\r\n        fit: \"cover\",\r\n        withoutEnlargement: false,\r\n      })\r\n      .webp({ quality: 80 })\r\n      .toBuffer();\r\n\r\n    console.log(\r\n      `Image processed successfully: ${buffer.length} -> ${processed.length} bytes`,\r\n    );\r\n    return processed;\r\n  } catch (error) {\r\n    console.error(\"Error processing image with sharp:\", error);\r\n    // Return original buffer if processing fails\r\n    return buffer;\r\n  }\r\n}\r\n\r\n/**\r\n * Check if sharp is available in current environment\r\n */\r\nexport function isSharpAvailable(): boolean {\r\n  return sharpAvailable && Sharp !== null;\r\n}\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;AASD,IAAI,iBAAiB;AACrB,IAAI,QAAa;AAEjB,0DAA0D;AAC1D,IAAI;IACF;IACA,iBAAiB;AACnB,EAAE,OAAO,OAAO;IACd,QAAQ,IAAI,CACV;AAEJ;AAUO,eAAe,aACpB,MAAc,EACd,WAAmB,GAAG,EACtB,YAAoB,GAAG;IAEvB,IAAI,CAAC,kBAAkB,CAAC,OAAO;QAC7B,QAAQ,GAAG,CACT;QAEF,OAAO;IACT;IAEA,IAAI;QACF,MAAM,YAAY,MAAM,MAAM,QAC3B,MAAM,CAAC,UAAU,WAAW;YAC3B,KAAK;YACL,oBAAoB;QACtB,GACC,IAAI,CAAC;YAAE,SAAS;QAAG,GACnB,QAAQ;QAEX,QAAQ,GAAG,CACT,CAAC,8BAA8B,EAAE,OAAO,MAAM,CAAC,IAAI,EAAE,UAAU,MAAM,CAAC,MAAM,CAAC;QAE/E,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sCAAsC;QACpD,6CAA6C;QAC7C,OAAO;IACT;AACF;AAKO,SAAS;IACd,OAAO,kBAAkB,UAAU;AACrC"}},
    {"offset": {"line": 2379, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/customers.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\nimport { v2 as cloudinary } from \"cloudinary\";\nimport { processImage } from \"../utils/image-processor\";\nimport {\n  supabase,\n  getCustomerStoreCredit,\n  getScopedSupabaseClient,\n} from \"../utils/supabase\";\nimport { ecwidAPI } from \"../utils/ecwid\";\n\n/**\n * Get current customer profile with addresses\n * Requires: customerId in JWT token\n * SECURITY: Uses scoped Supabase client with RLS enforcement\n */\nexport const handleGetCustomer: RequestHandler = async (req, res) => {\n  try {\n    const customerId = (req as any).customerId;\n\n    if (!customerId) {\n      return res.status(401).json({ error: \"Unauthorized - No customerId in token\" });\n    }\n\n    // Using service role client - the auth middleware already verified the token\n    const { data: customer, error } = await supabase\n      .from(\"customers\")\n      .select(\"*\")\n      .eq(\"id\", customerId)\n      .single();\n\n    if (error) {\n      console.error(\"Supabase error fetching customer:\", error);\n      return res.status(404).json({ error: \"Customer not found\", details: error.message });\n    }\n\n    if (!customer) {\n      return res.status(404).json({ error: \"Customer not found - No data returned\" });\n    }\n\n    const { data: addresses, error: addressError } = await supabase\n      .from(\"addresses\")\n      .select(\"*\")\n      .eq(\"customer_id\", customerId)\n      .order(\"is_default\", { ascending: false })\n      .order(\"created_at\", { ascending: false });\n\n    res.json({\n      success: true,\n      customer: {\n        id: customer.id,\n        email: customer.email,\n        firstName: customer.first_name,\n        lastName: customer.last_name,\n        phone: customer.phone,\n        companyName: customer.company,\n        avatarUrl: customer.avatar_url,\n        addresses: addresses || [],\n      },\n    });\n  } catch (error) {\n    console.error(\"Get customer error:\", error);\n    const message =\n      error instanceof Error ? error.message : \"Failed to fetch customer\";\n    res.status(500).json({ error: message });\n  }\n};\n\n/**\n * Update customer profile\n * Requires: customerId in JWT token\n * SECURITY: Uses scoped Supabase client with RLS enforcement\n */\nexport const handleUpdateCustomer: RequestHandler = async (req, res) => {\n  try {\n    const customerId = (req as any).customerId;\n\n    if (!customerId) {\n      return res.status(401).json({ error: \"Unauthorized\" });\n    }\n\n    const { firstName, lastName, phone, email } = req.body;\n\n    // Build update payload\n    const updateData: any = {\n      updated_at: new Date().toISOString(),\n    };\n    if (firstName) updateData.first_name = firstName;\n    if (lastName) updateData.last_name = lastName;\n    if (phone) updateData.phone = phone;\n    if (email) updateData.email = email;\n\n    if (Object.keys(updateData).length === 1) {\n      return res.status(400).json({ error: \"No fields to update\" });\n    }\n\n    // SECURITY: Use scoped client to enforce RLS policies\n    // Customer can only update their own record\n    const scoped = supabase;\n\n    // Update customer in Supabase\n    const { data: updatedCustomer, error } = await scoped\n      .from(\"customers\")\n      .update(updateData)\n      .eq(\"id\", customerId)\n      .select()\n      .single();\n\n    if (error || !updatedCustomer) {\n      console.error(\"Customer update error details:\", {\n        customerId,\n        updateData,\n        error: error\n          ? {\n              message: error.message,\n              code: error.code,\n              details: error.details,\n            }\n          : null,\n        updatedCustomer,\n      });\n      return res.status(500).json({\n        error: \"Failed to update customer\",\n        details: error?.message || \"Unknown error\",\n      });\n    }\n\n    res.json({\n      success: true,\n      message: \"Customer updated successfully\",\n      customer: {\n        id: updatedCustomer.id,\n        email: updatedCustomer.email,\n        firstName: updatedCustomer.first_name,\n        lastName: updatedCustomer.last_name,\n        phone: updatedCustomer.phone,\n      },\n    });\n  } catch (error) {\n    console.error(\"Update customer error:\", error);\n    const message =\n      error instanceof Error ? error.message : \"Failed to update customer\";\n    res.status(500).json({ error: message });\n  }\n};\n\n/**\n * Get customer addresses\n * Requires: customerId in JWT token\n * SECURITY: Uses scoped Supabase client with RLS enforcement\n */\nexport const handleGetCustomerAddresses: RequestHandler = async (req, res) => {\n  try {\n    const customerId = (req as any).customerId;\n\n    if (!customerId) {\n      return res.status(401).json({ error: \"Unauthorized\" });\n    }\n\n    // SECURITY: Use scoped client to enforce RLS policies\n    const scoped = supabase;\n\n    const { data: customer, error: customerError } = await scoped\n      .from(\"customers\")\n      .select(\"id\")\n      .eq(\"id\", customerId)\n      .single();\n\n    if (customerError || !customer) {\n      return res.status(404).json({ error: \"Customer not found\" });\n    }\n\n    const { data: addresses, error } = await scoped\n      .from(\"addresses\")\n      .select(\"*\")\n      .eq(\"customer_id\", customerId)\n      .order(\"is_default\", { ascending: false })\n      .order(\"created_at\", { ascending: false });\n\n    if (error) {\n      return res.status(500).json({ error: \"Failed to fetch addresses\" });\n    }\n\n    res.json({\n      success: true,\n      addresses: addresses || [],\n    });\n  } catch (error) {\n    console.error(\"Get addresses error:\", error);\n    const message =\n      error instanceof Error ? error.message : \"Failed to fetch addresses\";\n    res.status(500).json({ error: message });\n  }\n};\n\n/**\n * Create customer address\n * Requires: customerId in JWT token\n * SECURITY: Uses scoped Supabase client with RLS enforcement\n */\nexport const handleCreateCustomerAddress: RequestHandler = async (req, res) => {\n  try {\n    const customerId = (req as any).customerId;\n\n    if (!customerId) {\n      return res.status(401).json({ error: \"Unauthorized\" });\n    }\n\n    const {\n      firstName,\n      lastName,\n      street1,\n      street2,\n      city,\n      stateOrProvince,\n      postalCode,\n      countryCode,\n    } = req.body;\n\n    if (\n      !firstName ||\n      !lastName ||\n      !street1 ||\n      !city ||\n      !stateOrProvince ||\n      !postalCode ||\n      !countryCode\n    ) {\n      return res.status(400).json({ error: \"Missing required address fields\" });\n    }\n\n    // SECURITY: Use scoped client to enforce RLS policies\n    // Customer can only create addresses for themselves\n    const scoped = supabase;\n\n    const { data: address, error } = await scoped\n      .from(\"addresses\")\n      .insert({\n        customer_id: customerId,\n        first_name: firstName,\n        last_name: lastName,\n        street_1: street1,\n        street_2: street2 || null,\n        city,\n        state_or_province: stateOrProvince,\n        postal_code: postalCode,\n        country_code: countryCode,\n      })\n      .select()\n      .single();\n\n    if (error || !address) {\n      return res.status(500).json({ error: \"Failed to create address\" });\n    }\n\n    res.json({\n      success: true,\n      message: \"Address created successfully\",\n      address: {\n        id: address.id,\n        first_name: address.first_name,\n        last_name: address.last_name,\n        street_1: address.street_1,\n        street_2: address.street_2,\n        city: address.city,\n        state_or_province: address.state_or_province,\n        postal_code: address.postal_code,\n        country_code: address.country_code,\n      },\n    });\n  } catch (error) {\n    console.error(\"Create address error:\", error);\n    const message =\n      error instanceof Error ? error.message : \"Failed to create address\";\n    res.status(500).json({ error: message });\n  }\n};\n\n/**\n * Update customer address\n * Requires: customerId in JWT token\n * SECURITY: Uses scoped Supabase client with RLS enforcement\n */\nexport const handleUpdateCustomerAddress: RequestHandler = async (req, res) => {\n  try {\n    const customerId = (req as any).customerId;\n    const { addressId } = req.params;\n\n    if (!customerId) {\n      return res.status(401).json({ error: \"Unauthorized\" });\n    }\n\n    if (!addressId) {\n      return res.status(400).json({ error: \"Address ID is required\" });\n    }\n\n    const parsedAddressId = parseInt(addressId, 10);\n    if (isNaN(parsedAddressId)) {\n      return res.status(400).json({ error: \"Invalid address ID format\" });\n    }\n\n    const {\n      firstName,\n      lastName,\n      street1,\n      street2,\n      city,\n      stateOrProvince,\n      postalCode,\n      countryCode,\n    } = req.body;\n\n    if (\n      !firstName ||\n      !lastName ||\n      !street1 ||\n      !city ||\n      !stateOrProvince ||\n      !postalCode ||\n      !countryCode\n    ) {\n      return res.status(400).json({ error: \"Missing required address fields\" });\n    }\n\n    // SECURITY: Use scoped client to enforce RLS policies\n    const scoped = supabase;\n\n    // Verify address belongs to customer\n    const { data: existingAddress, error: checkError } = await scoped\n      .from(\"addresses\")\n      .select(\"id\")\n      .eq(\"id\", parsedAddressId)\n      .eq(\"customer_id\", customerId)\n      .single();\n\n    if (checkError || !existingAddress) {\n      return res\n        .status(404)\n        .json({ error: \"Address not found or unauthorized\" });\n    }\n\n    const { data: address, error } = await scoped\n      .from(\"addresses\")\n      .update({\n        first_name: firstName,\n        last_name: lastName,\n        street_1: street1,\n        street_2: street2 || null,\n        city,\n        state_or_province: stateOrProvince,\n        postal_code: postalCode,\n        country_code: countryCode,\n        updated_at: new Date().toISOString(),\n      })\n      .eq(\"id\", parsedAddressId)\n      .select()\n      .single();\n\n    if (error || !address) {\n      return res.status(500).json({ error: \"Failed to update address\" });\n    }\n\n    res.json({\n      success: true,\n      message: \"Address updated successfully\",\n      address: {\n        id: address.id,\n        first_name: address.first_name,\n        last_name: address.last_name,\n        street_1: address.street_1,\n        street_2: address.street_2,\n        city: address.city,\n        state_or_province: address.state_or_province,\n        postal_code: address.postal_code,\n        country_code: address.country_code,\n      },\n    });\n  } catch (error) {\n    console.error(\"Update address error:\", error);\n    const message =\n      error instanceof Error ? error.message : \"Failed to update address\";\n    res.status(500).json({ error: message });\n  }\n};\n\n/**\n * Delete customer address\n * Requires: customerId in JWT token\n * SECURITY: Uses scoped Supabase client with RLS enforcement\n */\nexport const handleDeleteCustomerAddress: RequestHandler = async (req, res) => {\n  try {\n    const customerId = (req as any).customerId;\n    const { addressId } = req.params;\n\n    if (!customerId) {\n      return res.status(401).json({ error: \"Unauthorized\" });\n    }\n\n    if (!addressId) {\n      return res.status(400).json({ error: \"Address ID is required\" });\n    }\n\n    const parsedAddressId = parseInt(addressId, 10);\n    if (isNaN(parsedAddressId)) {\n      return res.status(400).json({ error: \"Invalid address ID format\" });\n    }\n\n    // SECURITY: Use scoped client to enforce RLS policies\n    const scoped = supabase;\n\n    // Verify address belongs to customer\n    const { data: existingAddress, error: checkError } = await scoped\n      .from(\"addresses\")\n      .select(\"id\")\n      .eq(\"id\", parsedAddressId)\n      .eq(\"customer_id\", customerId)\n      .single();\n\n    if (checkError || !existingAddress) {\n      return res\n        .status(404)\n        .json({ error: \"Address not found or unauthorized\" });\n    }\n\n    const { error } = await scoped\n      .from(\"addresses\")\n      .delete()\n      .eq(\"id\", parsedAddressId);\n\n    if (error) {\n      return res.status(500).json({ error: \"Failed to delete address\" });\n    }\n\n    res.json({\n      success: true,\n      message: \"Address deleted successfully\",\n    });\n  } catch (error) {\n    console.error(\"Delete address error:\", error);\n    const message =\n      error instanceof Error ? error.message : \"Failed to delete address\";\n    res.status(500).json({ error: message });\n  }\n};\n\n/**\n * Delete customer account\n * Requires: customerId in JWT token\n * SECURITY: Uses scoped Supabase client with RLS enforcement\n */\nexport const handleDeleteCustomerAccount: RequestHandler = async (req, res) => {\n  try {\n    const customerId = (req as any).customerId;\n\n    if (!customerId) {\n      return res.status(401).json({ error: \"Unauthorized\" });\n    }\n\n    // SECURITY: Use scoped client to enforce RLS policies\n    // Customer can only delete their own account\n    const scoped = supabase;\n\n    // Delete from Supabase\n    const { error } = await scoped\n      .from(\"customers\")\n      .delete()\n      .eq(\"id\", customerId);\n\n    if (error) {\n      return res.status(500).json({ error: \"Failed to delete account\" });\n    }\n\n    // Try to delete from Ecwid (non-blocking)\n    try {\n      await ecwidAPI.deleteCustomer(customerId);\n    } catch (ecwidError) {\n      console.warn(\n        \"Warning: Failed to delete customer from Ecwid:\",\n        ecwidError,\n      );\n      // Don't fail the deletion if Ecwid deletion fails\n    }\n\n    res.json({\n      success: true,\n      message: \"Account deleted successfully\",\n    });\n  } catch (error) {\n    console.error(\"Delete account error:\", error);\n    const message =\n      error instanceof Error ? error.message : \"Failed to delete account\";\n    res.status(500).json({ error: message });\n  }\n};\n\n/**\n * Get customer store credit\n * Requires: customerId in JWT token\n */\nexport const handleGetStoreCredit: RequestHandler = async (req, res) => {\n  try {\n    const customerId = (req as any).customerId;\n\n    if (!customerId) {\n      return res.status(401).json({ error: \"Unauthorized\" });\n    }\n\n    const storeCredit = await getCustomerStoreCredit(customerId);\n\n    res.json({\n      success: true,\n      storeCredit: storeCredit || 0,\n    });\n  } catch (error) {\n    console.error(\"Get store credit error:\", error);\n    const message =\n      error instanceof Error ? error.message : \"Failed to fetch store credit\";\n    res.status(500).json({ error: message });\n  }\n};\n\n/**\n * Upload customer avatar\n * Requires: customerId in JWT token, image file\n */\nexport const handleUploadAvatar: RequestHandler = async (req, res) => {\n  try {\n    const customerId = (req as any).customerId;\n\n    if (!customerId) {\n      return res.status(401).json({ error: \"Unauthorized\" });\n    }\n\n    cloudinary.config({\n      cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\n      api_key: process.env.CLOUDINARY_API_KEY,\n      api_secret: process.env.CLOUDINARY_API_SECRET,\n    });\n\n    if (!req.file) {\n      return res.status(400).json({ error: \"No file provided\" });\n    }\n\n    // Compress and resize image for avatar (square format)\n    // Uses sharp if available, falls back to original buffer in serverless environments\n    const compressedBuffer = await processImage(req.file.buffer, 500, 500);\n\n    const b64 = compressedBuffer.toString(\"base64\");\n    const dataURI = `data:image/jpeg;base64,${b64}`;\n\n    const result = await cloudinary.uploader.upload(dataURI, {\n      folder: \"sticky-shuttle/avatars\",\n      resource_type: \"auto\",\n    });\n\n    // Update customer with avatar URL\n    const { data: updatedCustomer, error } = await supabase\n      .from(\"customers\")\n      .update({\n        avatar_url: result.secure_url,\n        updated_at: new Date().toISOString(),\n      })\n      .eq(\"id\", customerId)\n      .select()\n      .single();\n\n    if (error || !updatedCustomer) {\n      return res.status(500).json({ error: \"Failed to update avatar\" });\n    }\n\n    res.json({\n      success: true,\n      message: \"Avatar updated successfully\",\n      customer: {\n        id: updatedCustomer.id,\n        email: updatedCustomer.email,\n        firstName: updatedCustomer.first_name,\n        lastName: updatedCustomer.last_name,\n        phone: updatedCustomer.phone,\n        avatarUrl: updatedCustomer.avatar_url,\n      },\n    });\n  } catch (error) {\n    console.error(\"Upload avatar error:\", error);\n    const message =\n      error instanceof Error ? error.message : \"Failed to upload avatar\";\n    res.status(500).json({ error: message });\n  }\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2858, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/customer.router.ts"],"sourcesContent":["import { Router } from \"express\";\r\nimport { verifyToken } from \"../middleware/auth\";\r\nimport {\r\n  handleGetCustomer,\r\n  handleUpdateCustomer,\r\n  handleGetCustomerAddresses,\r\n  handleCreateCustomerAddress,\r\n  handleUpdateCustomerAddress,\r\n  handleDeleteCustomerAddress,\r\n  handleDeleteCustomerAccount,\r\n  handleGetStoreCredit,\r\n  handleUploadAvatar,\r\n} from \"./customers\";\r\nimport multer from \"multer\";\r\n\r\n/**\r\n * Customer Routes - All protected routes for customer profile management\r\n * All routes require authentication via verifyToken middleware\r\n */\r\nexport function createCustomerRouter(upload: multer.Multer) {\r\n  const router = Router();\r\n\r\n  // GET /api/customers/me - Get current customer profile\r\n  router.get(\"/me\", verifyToken, handleGetCustomer);\r\n\r\n  // PATCH /api/customers/me - Update customer profile\r\n  router.patch(\"/me\", verifyToken, handleUpdateCustomer);\r\n\r\n  // POST /api/customers/me/avatar - Upload customer avatar\r\n  router.post(\r\n    \"/me/avatar\",\r\n    verifyToken,\r\n    upload.single(\"avatar\"),\r\n    handleUploadAvatar,\r\n  );\r\n\r\n  // GET /api/customers/me/addresses - Get customer addresses\r\n  router.get(\"/me/addresses\", verifyToken, handleGetCustomerAddresses);\r\n\r\n  // POST /api/customers/me/addresses - Create new address\r\n  router.post(\"/me/addresses\", verifyToken, handleCreateCustomerAddress);\r\n\r\n  // PATCH /api/customers/me/addresses/:addressId - Update address\r\n  router.patch(\r\n    \"/me/addresses/:addressId\",\r\n    verifyToken,\r\n    handleUpdateCustomerAddress,\r\n  );\r\n\r\n  // DELETE /api/customers/me/addresses/:addressId - Delete address\r\n  router.delete(\r\n    \"/me/addresses/:addressId\",\r\n    verifyToken,\r\n    handleDeleteCustomerAddress,\r\n  );\r\n\r\n  // DELETE /api/customers/me/account - Delete customer account\r\n  router.delete(\"/me/account\", verifyToken, handleDeleteCustomerAccount);\r\n\r\n  // GET /api/customers/me/store-credit - Get store credit balance\r\n  router.get(\"/me/store-credit\", verifyToken, handleGetStoreCredit);\r\n\r\n  return router;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;AAiBO,SAAS,qBAAqB,MAAqB;IACxD,MAAM,SAAS,IAAA,+JAAM;IAErB,uDAAuD;IACvD,OAAO,GAAG,CAAC,OAAO,oIAAW,EAAE,2IAAiB;IAEhD,oDAAoD;IACpD,OAAO,KAAK,CAAC,OAAO,oIAAW,EAAE,8IAAoB;IAErD,yDAAyD;IACzD,OAAO,IAAI,CACT,cACA,oIAAW,EACX,OAAO,MAAM,CAAC,WACd,4IAAkB;IAGpB,2DAA2D;IAC3D,OAAO,GAAG,CAAC,iBAAiB,oIAAW,EAAE,oJAA0B;IAEnE,wDAAwD;IACxD,OAAO,IAAI,CAAC,iBAAiB,oIAAW,EAAE,qJAA2B;IAErE,gEAAgE;IAChE,OAAO,KAAK,CACV,4BACA,oIAAW,EACX,qJAA2B;IAG7B,iEAAiE;IACjE,OAAO,MAAM,CACX,4BACA,oIAAW,EACX,qJAA2B;IAG7B,6DAA6D;IAC7D,OAAO,MAAM,CAAC,eAAe,oIAAW,EAAE,qJAA2B;IAErE,gEAAgE;IAChE,OAAO,GAAG,CAAC,oBAAoB,oIAAW,EAAE,8IAAoB;IAEhE,OAAO;AACT"}},
    {"offset": {"line": 2900, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/utils/order.ts"],"sourcesContent":["/**\r\n * Order utilities for consistent order number formatting across the app\r\n */\r\n\r\n/**\r\n * Format an order ID to the display format: SY-5XXXXX\r\n * Formula: SY-5 + (4001 + orderId)\r\n * Example: orderId 10 ‚Üí SY-54011\r\n */\r\nexport function formatOrderNumber(orderId: number | string): string {\r\n  const id = typeof orderId === \"string\" ? parseInt(orderId, 10) : orderId;\r\n  if (isNaN(id) || id <= 0) {\r\n    throw new Error(\"Invalid order ID\");\r\n  }\r\n  const displayNumber = 4001 + id;\r\n  return `SY-5${displayNumber}`;\r\n}\r\n\r\n/**\r\n * Parse a formatted order number (SY-XXXXX) back to the numeric ID\r\n * Handles both SY-XXXXX format and plain numeric format for backward compatibility\r\n * Example: \"SY-54011\" ‚Üí 10 or \"10\" ‚Üí 10\r\n */\r\nexport function parseOrderNumber(orderNumber: string): number {\r\n  const trimmed = orderNumber.trim();\r\n\r\n  if (trimmed.toUpperCase().startsWith(\"SY-5\")) {\r\n    // Format: SY-54011 where 54011 = 4001 + id, so id = 54011 - 54001\r\n    // Extract everything after \"SY-\" (position 3 onwards)\r\n    const displayNumber = parseInt(trimmed.substring(3), 10);\r\n    if (isNaN(displayNumber)) {\r\n      throw new Error(\"Invalid order number format\");\r\n    }\r\n    const id = displayNumber - 54001;\r\n    if (id <= 0) {\r\n      throw new Error(\"Invalid order number format\");\r\n    }\r\n    return id;\r\n  } else {\r\n    // Plain numeric format\r\n    const id = parseInt(trimmed, 10);\r\n    if (isNaN(id)) {\r\n      throw new Error(\"Invalid order number format\");\r\n    }\r\n    return id;\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;CAEC,GAED;;;;CAIC;;;;;;AACM,SAAS,kBAAkB,OAAwB;IACxD,MAAM,KAAK,OAAO,YAAY,WAAW,SAAS,SAAS,MAAM;IACjE,IAAI,MAAM,OAAO,MAAM,GAAG;QACxB,MAAM,IAAI,MAAM;IAClB;IACA,MAAM,gBAAgB,OAAO;IAC7B,OAAO,CAAC,IAAI,EAAE,eAAe;AAC/B;AAOO,SAAS,iBAAiB,WAAmB;IAClD,MAAM,UAAU,YAAY,IAAI;IAEhC,IAAI,QAAQ,WAAW,GAAG,UAAU,CAAC,SAAS;QAC5C,kEAAkE;QAClE,sDAAsD;QACtD,MAAM,gBAAgB,SAAS,QAAQ,SAAS,CAAC,IAAI;QACrD,IAAI,MAAM,gBAAgB;YACxB,MAAM,IAAI,MAAM;QAClB;QACA,MAAM,KAAK,gBAAgB;QAC3B,IAAI,MAAM,GAAG;YACX,MAAM,IAAI,MAAM;QAClB;QACA,OAAO;IACT,OAAO;QACL,uBAAuB;QACvB,MAAM,KAAK,SAAS,SAAS;QAC7B,IAAI,MAAM,KAAK;YACb,MAAM,IAAI,MAAM;QAClB;QACA,OAAO;IACT;AACF"}},
    {"offset": {"line": 2949, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/schemas/validation.ts"],"sourcesContent":["import { z } from \"zod\";\r\n\r\n/**\r\n * Validate data against a Zod schema\r\n * Used within route handlers for conditional or complex validation\r\n */\r\nexport async function validate<T>(\r\n  schema: z.ZodSchema<T>,\r\n  data: unknown,\r\n): Promise<\r\n  | { success: true; data: T }\r\n  | { success: false; errors: Array<{ field: string; message: string }> }\r\n> {\r\n  try {\r\n    const validated = await schema.parseAsync(data);\r\n    return { success: true, data: validated };\r\n  } catch (error) {\r\n    if (error instanceof z.ZodError) {\r\n      const errors = error.errors.map((err) => ({\r\n        field: err.path.join(\".\") || \"unknown\",\r\n        message: err.message,\r\n      }));\r\n      return { success: false, errors };\r\n    }\r\n\r\n    console.error(\"Validation error:\", error);\r\n    return {\r\n      success: false,\r\n      errors: [\r\n        {\r\n          field: \"unknown\",\r\n          message: \"An unexpected validation error occurred\",\r\n        },\r\n      ],\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * COMMON SCHEMAS\r\n * Reusable base schemas for addresses, contact info, etc.\r\n */\r\n\r\nexport const AddressSchema = z.object({\r\n  first_name: z.string().min(1, \"First name is required\"),\r\n  last_name: z.string().min(1, \"Last name is required\"),\r\n  street_1: z.string().min(1, \"Street address is required\"),\r\n  street_2: z.string().optional().nullable(),\r\n  city: z.string().min(1, \"City is required\"),\r\n  state_or_province: z.string().min(1, \"State or province is required\"),\r\n  postal_code: z.string().min(1, \"Postal code is required\"),\r\n  country_iso2: z.string().min(2).max(2, \"Country code must be 2 characters\"),\r\n  phone: z.string().optional().nullable(),\r\n});\r\n\r\nexport const EmailSchema = z\r\n  .string()\r\n  .email(\"Invalid email format\")\r\n  .toLowerCase();\r\n\r\nexport const PhoneSchema = z\r\n  .string()\r\n  .regex(/^\\+?[0-9\\s\\-\\(\\)]+$/, \"Invalid phone number format\")\r\n  .optional()\r\n  .nullable();\r\n\r\n/**\r\n * CUSTOMER SCHEMAS\r\n */\r\n\r\nexport const UpdateCustomerSchema = z.object({\r\n  firstName: z.string().min(1, \"First name is required\").optional(),\r\n  lastName: z.string().min(1, \"Last name is required\").optional(),\r\n  phone: PhoneSchema,\r\n  email: EmailSchema.optional(),\r\n});\r\n\r\nexport const CreateCustomerAddressSchema = z.object({\r\n  firstName: z.string().min(1, \"First name is required\"),\r\n  lastName: z.string().min(1, \"Last name is required\"),\r\n  street1: z.string().min(1, \"Street address is required\"),\r\n  street2: z.string().optional().nullable(),\r\n  city: z.string().min(1, \"City is required\"),\r\n  stateOrProvince: z.string().min(1, \"State or province is required\"),\r\n  postalCode: z.string().min(1, \"Postal code is required\"),\r\n  countryCode: z.string().min(2).max(2, \"Country code must be 2 characters\"),\r\n});\r\n\r\nexport const UpdateCustomerAddressSchema = CreateCustomerAddressSchema;\r\n\r\n/**\r\n * ORDER SCHEMAS\r\n */\r\n\r\nexport const CreateOrderItemSchema = z.object({\r\n  product_id: z.number().int(\"Product ID must be an integer\"),\r\n  product_name: z.string().optional(),\r\n  quantity: z.number().int().min(1, \"Quantity must be at least 1\"),\r\n  price: z.number().optional(),\r\n  price_inc_tax: z.number().optional(),\r\n  options: z.record(z.unknown()).optional(),\r\n  design_file_url: z\r\n    .string()\r\n    .url(\"Invalid design file URL\")\r\n    .optional()\r\n    .nullable(),\r\n});\r\n\r\nexport const CheckoutSchema = z.object({\r\n  customer_id: z.number().int(\"Customer ID must be an integer\"),\r\n  billing_address: AddressSchema,\r\n  shipping_addresses: z\r\n    .array(AddressSchema)\r\n    .min(1, \"At least one shipping address is required\"),\r\n  products: z\r\n    .array(CreateOrderItemSchema)\r\n    .min(1, \"At least one product is required\"),\r\n  discount_amount: z.number().min(0).optional().default(0),\r\n  discount_code: z.string().optional().nullable(),\r\n});\r\n\r\nexport const VerifyOrderAccessSchema = z.object({\r\n  order_number: z\r\n    .string()\r\n    .min(1, \"Order number is required\")\r\n    .regex(/^\\d+$/, \"Order number must contain only digits\"),\r\n  verification_field: z.string().min(1, \"Email or phone is required\"),\r\n});\r\n\r\n/**\r\n * DESIGN SCHEMAS\r\n */\r\n\r\nexport const UploadDesignFileSchema = z.object({\r\n  order_id: z.number().int(\"Order ID must be an integer\").optional(),\r\n  order_item_id: z.number().int(\"Order item ID must be an integer\").optional(),\r\n  design_name: z.string().min(1, \"Design name is required\").max(255),\r\n  file_type: z\r\n    .enum([\"image/png\", \"image/jpeg\", \"image/gif\", \"application/pdf\"])\r\n    .refine(\r\n      (type) => type,\r\n      \"Unsupported file type. Allowed: PNG, JPG, GIF, PDF\",\r\n    ),\r\n});\r\n\r\n/**\r\n * PRODUCT SCHEMAS\r\n */\r\n\r\nexport const ProductImageSchema = z.object({\r\n  id: z.string().uuid().optional(),\r\n  url: z.string().url(\"Invalid image URL\"),\r\n  name: z.string().min(1, \"Image name is required\"),\r\n  preview: z.string().optional(),\r\n});\r\n\r\nexport const VariantValueSchema = z.object({\r\n  id: z.string().min(1, \"Variant ID is required\"),\r\n  name: z.string().min(1, \"Variant name is required\"),\r\n  priceModifier: z.number().default(0),\r\n  image: ProductImageSchema.optional(),\r\n});\r\n\r\nexport const ProductOptionSchema = z.object({\r\n  id: z.string().min(1, \"Option ID is required\"),\r\n  name: z.string().min(1, \"Option name is required\"),\r\n  type: z.enum([\"dropdown\", \"swatch\", \"radio\", \"text\"]),\r\n  required: z.boolean().default(false),\r\n  values: z.array(VariantValueSchema),\r\n  defaultValueId: z.string().optional(),\r\n  displayOrder: z.number().int().default(0),\r\n});\r\n\r\nexport const PricingRuleSchema = z.object({\r\n  id: z.string().uuid().optional(),\r\n  conditions: z.array(\r\n    z.object({\r\n      optionId: z.string().min(1),\r\n      valueId: z.string().min(1),\r\n    }),\r\n  ),\r\n  price: z.number().min(0, \"Price must be non-negative\"),\r\n});\r\n\r\nexport const SharedVariantSchema = z.object({\r\n  id: z.string().min(1, \"Variant ID is required\"),\r\n  name: z.string().min(1, \"Variant name is required\"),\r\n  description: z.string().optional(),\r\n  optionSelections: z.array(\r\n    z.object({\r\n      optionId: z.string().min(1),\r\n      optionName: z.string().min(1),\r\n      selectedValueIds: z.array(z.string().min(1)),\r\n    }),\r\n  ),\r\n  price: z.number().min(0, \"Price must be non-negative\"),\r\n});\r\n\r\nexport const TaxConfigSchema = z.object({\r\n  id: z.string().uuid().optional(),\r\n  name: z.string().min(1, \"Tax name is required\"),\r\n  rate: z.number().min(0).max(100, \"Tax rate must be between 0 and 100\"),\r\n  enabled: z.boolean().default(true),\r\n});\r\n\r\nexport const SEOSchema = z.object({\r\n  productUrl: z.string().url(\"Invalid product URL\").optional(),\r\n  pageTitle: z\r\n    .string()\r\n    .max(60, \"Page title must be 60 characters or less\")\r\n    .optional(),\r\n  metaDescription: z\r\n    .string()\r\n    .max(160, \"Meta description must be 160 characters or less\")\r\n    .optional(),\r\n});\r\n\r\nexport const CreateProductSchema = z.object({\r\n  name: z.string().min(1, \"Product name is required\").max(255),\r\n  basePrice: z\r\n    .number()\r\n    .min(0, \"Base price must be non-negative\")\r\n    .optional()\r\n    .default(0),\r\n  description: z.string().optional().default(\"\"),\r\n  sku: z.string().optional().default(\"\"),\r\n  weight: z.number().min(0).optional().default(0),\r\n  images: z.array(ProductImageSchema).optional().default([]),\r\n  options: z.array(ProductOptionSchema).optional().default([]),\r\n  pricingRules: z.array(PricingRuleSchema).optional().default([]),\r\n  sharedVariants: z.array(SharedVariantSchema).optional().default([]),\r\n  customerUploadConfig: z\r\n    .object({\r\n      enabled: z.boolean(),\r\n      maxFileSize: z.number().int().min(1),\r\n      allowedFormats: z.array(z.string()),\r\n      description: z.string().optional(),\r\n    })\r\n    .optional(),\r\n  optionalFields: z\r\n    .array(\r\n      z.object({\r\n        name: z.string().min(1),\r\n        type: z.string().min(1),\r\n      }),\r\n    )\r\n    .optional()\r\n    .default([]),\r\n  textArea: z.string().optional().default(\"\"),\r\n  uploadedFiles: z.array(z.any()).optional().default([]),\r\n  conditionLogic: z.string().optional().default(\"all\"),\r\n  taxes: z.array(TaxConfigSchema).optional().default([]),\r\n  seo: SEOSchema.optional(),\r\n  categories: z.array(z.string()).optional().default([]),\r\n  availability: z.boolean().optional().default(true),\r\n  showQuantityPanel: z.boolean().optional().default(true),\r\n  fixedQuantity: z.number().int().min(1).optional().nullable(),\r\n});\r\n\r\nexport const UpdateProductSchema = CreateProductSchema;\r\n\r\n/**\r\n * ADMIN SCHEMAS\r\n */\r\n\r\nexport const CreateInvoiceSchema = z.object({\r\n  customer_name: z.string().min(1, \"Customer name is required\"),\r\n  customer_email: EmailSchema,\r\n  invoice_type: z.enum([\"Standard\", \"ArtworkUpload\"]),\r\n  issue_date: z.string().datetime().optional(),\r\n  due_date: z.string().datetime(),\r\n  notes: z.string().optional().nullable(),\r\n  subtotal: z.number().min(0),\r\n  tax_rate: z.number().min(0).max(100).optional().default(0),\r\n  tax_amount: z.number().min(0).optional().default(0),\r\n  shipping: z.number().min(0).optional().default(0),\r\n  discount_amount: z.number().min(0).optional().default(0),\r\n  discount_type: z.enum([\"fixed\", \"percentage\"]).optional(),\r\n  items: z.array(\r\n    z.object({\r\n      description: z.string().min(1),\r\n      quantity: z.number().int().min(1),\r\n      unit_price: z.number().min(0),\r\n      amount: z.number().min(0),\r\n    }),\r\n  ),\r\n});\r\n\r\nexport const UpdateInvoiceSchema = CreateInvoiceSchema.partial();\r\n\r\nexport const UpdateOrderStatusSchema = z.object({\r\n  status: z.enum([\r\n    \"pending\",\r\n    \"processing\",\r\n    \"printing\",\r\n    \"in transit\",\r\n    \"delivered\",\r\n    \"paid\",\r\n    \"pending_payment\",\r\n    \"canceled\",\r\n  ]),\r\n  notes: z.string().optional().nullable(),\r\n});\r\n\r\n/**\r\n * SUPPORT/CONTACT SCHEMAS\r\n */\r\n\r\nexport const SupportSubmissionSchema = z.object({\r\n  name: z.string().min(1, \"Name is required\").max(255),\r\n  email: EmailSchema,\r\n  subject: z.string().min(1, \"Subject is required\").max(255),\r\n  category: z.string().min(1, \"Category is required\"),\r\n  priority: z.enum([\"low\", \"medium\", \"high\"]).optional().default(\"medium\"),\r\n  message: z.string().min(10, \"Message must be at least 10 characters\"),\r\n  customerId: z.number().int().optional(),\r\n});\r\n\r\n/**\r\n * REVIEW SCHEMAS\r\n */\r\n\r\nexport const SubmitReviewSchema = z.object({\r\n  product_id: z.string().min(1, \"Product ID is required\"),\r\n  reviewer_name: z.string().min(1, \"Name is required\").max(255),\r\n  reviewer_email: EmailSchema,\r\n  rating: z.number().int().min(1, \"Rating must be 1-5\").max(5),\r\n  title: z.string().max(255).optional(),\r\n  comment: z.string().max(5000).optional(),\r\n  images: z.array(z.string()).optional().default([]),\r\n});\r\n\r\n/**\r\n * AUTH SCHEMAS\r\n */\r\n\r\nexport const LoginSchema = z.object({\r\n  email: EmailSchema,\r\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\r\n});\r\n\r\nexport const SignupSchema = z.object({\n  email: EmailSchema,\n  password: z.string()\n    .min(8, \"Password must be at least 8 characters\")\n    .regex(/[A-Z]/, \"Password must contain at least one uppercase letter\")\n    .regex(/[a-z]/, \"Password must contain at least one lowercase letter\")\n    .regex(/[0-9]/, \"Password must contain at least one number\")\n    .regex(/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/, \"Password must contain at least one special character\"),\n  firstName: z.string().min(1, \"First name is required\").max(255),\n  lastName: z.string().min(1, \"Last name is required\").max(255),\n});\n\r\nexport const ResetPasswordSchema = z.object({\n  token: z.string().min(1, \"Reset token is required\"),\n  newPassword: z.string()\n    .min(8, \"Password must be at least 8 characters\")\n    .regex(/[A-Z]/, \"Password must contain at least one uppercase letter\")\n    .regex(/[a-z]/, \"Password must contain at least one lowercase letter\")\n    .regex(/[0-9]/, \"Password must contain at least one number\")\n    .regex(/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/, \"Password must contain at least one special character\"),\n});\n\r\nexport const RequestPasswordResetSchema = z.object({\r\n  email: EmailSchema,\r\n});\r\n\r\n/**\r\n * STORE CREDIT SCHEMAS\r\n */\r\n\r\nexport const ModifyStoreCreditSchema = z.object({\r\n  customer_id: z.number().int(\"Customer ID must be an integer\"),\r\n  amount: z.number(\"Amount must be a number\"),\r\n  reason: z.string().min(1, \"Reason is required\").max(500),\r\n});\r\n\r\n/**\r\n * Type exports for use in route handlers\r\n */\r\n\r\nexport type UpdateCustomerInput = z.infer<typeof UpdateCustomerSchema>;\r\nexport type CreateCustomerAddressInput = z.infer<\r\n  typeof CreateCustomerAddressSchema\r\n>;\r\nexport type CheckoutInput = z.infer<typeof CheckoutSchema>;\r\nexport type VerifyOrderAccessInput = z.infer<typeof VerifyOrderAccessSchema>;\r\nexport type UploadDesignFileInput = z.infer<typeof UploadDesignFileSchema>;\r\nexport type CreateProductInput = z.infer<typeof CreateProductSchema>;\r\nexport type UpdateProductInput = z.infer<typeof UpdateProductSchema>;\r\nexport type CreateInvoiceInput = z.infer<typeof CreateInvoiceSchema>;\r\nexport type UpdateInvoiceInput = z.infer<typeof UpdateInvoiceSchema>;\r\nexport type UpdateOrderStatusInput = z.infer<typeof UpdateOrderStatusSchema>;\r\nexport type SupportSubmissionInput = z.infer<typeof SupportSubmissionSchema>;\r\nexport type SubmitReviewInput = z.infer<typeof SubmitReviewSchema>;\r\nexport type LoginInput = z.infer<typeof LoginSchema>;\r\nexport type SignupInput = z.infer<typeof SignupSchema>;\r\nexport type ResetPasswordInput = z.infer<typeof ResetPasswordSchema>;\r\nexport type ModifyStoreCreditInput = z.infer<typeof ModifyStoreCreditSchema>;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3293, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/utils/public-access-tokens.ts"],"sourcesContent":["import crypto from \"crypto\";\r\nimport { supabase } from \"./supabase\";\r\n\r\n/**\r\n * Public Access Token System\r\n *\r\n * SECURITY MODEL:\r\n * - Tokens are 32-byte (64 hex char) cryptographically secure random values\r\n * - Tokens are resource-type and resource-id locked\r\n * - Tokens can expire and support one-time use\r\n * - Validation is atomic: token lookup + resource verification in single query\r\n * - All public operations return generic 404 to prevent enumeration\r\n * - Tokens are never logged or exposed after creation\r\n */\r\n\r\nexport interface PublicAccessTokenConfig {\r\n  resourceType: \"proof\" | \"order\" | \"invoice\" | \"design\";\r\n  resourceId: string;\r\n  expiresInHours?: number; // Default: 48 hours\r\n  oneTimeUse?: boolean; // Default: false\r\n  createdBy?: string; // Email or identifier of who created the token\r\n}\r\n\r\nexport interface TokenValidationResult {\r\n  success: boolean;\r\n  resourceId?: string;\r\n  resourceType?: string;\r\n  error?: string; // Generic error - never reveal specifics\r\n}\r\n\r\n/**\r\n * Generate a cryptographically secure public access token\r\n * Returns the token to be stored/sent in links/emails\r\n * Token format: 64 hex characters (32 bytes)\r\n */\r\nexport function generatePublicAccessToken(): string {\r\n  return crypto.randomBytes(32).toString(\"hex\");\r\n}\r\n\r\n/**\r\n * Create and store a public access token in the database\r\n * SECURITY: Token is stored hashed (TODO: implement hashing for production)\r\n *\r\n * @returns The token string to be sent to the user\r\n */\r\nexport async function createPublicAccessToken(\r\n  config: PublicAccessTokenConfig,\r\n): Promise<{\r\n  success: boolean;\r\n  token?: string;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const token = generatePublicAccessToken();\r\n    const expiresInHours = config.expiresInHours || 48;\r\n    const expiresAt = new Date(\r\n      Date.now() + expiresInHours * 60 * 60 * 1000,\r\n    ).toISOString();\r\n\r\n    const { error } = await supabase.from(\"public_access_tokens\").insert({\r\n      token,\r\n      resource_type: config.resourceType,\r\n      resource_id: config.resourceId,\r\n      expires_at: expiresAt,\r\n      one_time_use: config.oneTimeUse ?? false,\r\n      created_by: config.createdBy,\r\n      metadata: {\r\n        createdAt: new Date().toISOString(),\r\n      },\r\n    });\r\n\r\n    if (error) {\r\n      console.error(\"Error creating public access token:\", error);\r\n      return { success: false, error: \"Failed to create access token\" };\r\n    }\r\n\r\n    // Token successfully created\r\n    console.log(\r\n      `[SECURITY] Created public access token for ${config.resourceType}:${config.resourceId} (expires in ${expiresInHours}h, one-time: ${config.oneTimeUse || false})`,\r\n    );\r\n\r\n    return { success: true, token };\r\n  } catch (error) {\r\n    console.error(\"Error in createPublicAccessToken:\", error);\r\n    return { success: false, error: \"Failed to create access token\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Validate a public access token atomically\r\n * SECURITY:\r\n * - Returns generic 404 result on ANY failure (token not found, expired, already used, wrong resource)\r\n * - Marks one-time-use tokens as used in the same query (prevents race conditions)\r\n * - Logs suspicious activity but never exposes details\r\n *\r\n * @returns { success: true, resourceId } on valid token\r\n *         { success: false, error: \"Not found\" } on any failure\r\n */\r\nexport async function validatePublicAccessToken(\r\n  token: string,\r\n  expectedResourceType: \"proof\" | \"order\" | \"invoice\" | \"design\",\r\n): Promise<TokenValidationResult> {\r\n  try {\r\n    if (!token || token.length !== 64) {\r\n      // Invalid token format - generic error\r\n      console.warn(\"[SECURITY] Invalid token format attempted\");\r\n      return { success: false, error: \"Not found\" };\r\n    }\r\n\r\n    // Step 1: Find the token and validate all conditions atomically\r\n    const { data: tokenRecord, error: lookupError } = await supabase\r\n      .from(\"public_access_tokens\")\r\n      .select(\r\n        \"token, resource_type, resource_id, expires_at, one_time_use, used_at\",\r\n      )\r\n      .eq(\"token\", token)\r\n      .maybeSingle();\r\n\r\n    // Token not found\r\n    if (lookupError || !tokenRecord) {\r\n      console.warn(\"[SECURITY] Public token lookup failed or not found\", {\r\n        tokenPrefix: token.substring(0, 8),\r\n        error: lookupError?.message,\r\n      });\r\n      return { success: false, error: \"Not found\" };\r\n    }\r\n\r\n    // Token expired\r\n    if (new Date(tokenRecord.expires_at) < new Date()) {\r\n      console.warn(\"[SECURITY] Expired public access token used\", {\r\n        resourceType: tokenRecord.resource_type,\r\n        resourceId: tokenRecord.resource_id,\r\n      });\r\n      return { success: false, error: \"Not found\" };\r\n    }\r\n\r\n    // Token already used (one-time use)\r\n    if (tokenRecord.one_time_use && tokenRecord.used_at) {\r\n      console.warn(\"[SECURITY] One-time-use public token reused\", {\r\n        resourceType: tokenRecord.resource_type,\r\n        resourceId: tokenRecord.resource_id,\r\n        usedAt: tokenRecord.used_at,\r\n      });\r\n      return { success: false, error: \"Not found\" };\r\n    }\r\n\r\n    // Resource type mismatch - suspicious\r\n    if (tokenRecord.resource_type !== expectedResourceType) {\r\n      console.warn(\"[SECURITY] Public token resource type mismatch\", {\r\n        expected: expectedResourceType,\r\n        actual: tokenRecord.resource_type,\r\n      });\r\n      return { success: false, error: \"Not found\" };\r\n    }\r\n\r\n    // Step 2: If one-time-use, mark as used atomically\r\n    if (tokenRecord.one_time_use) {\r\n      const { error: updateError } = await supabase\r\n        .from(\"public_access_tokens\")\r\n        .update({ used_at: new Date().toISOString() })\r\n        .eq(\"token\", token)\r\n        .eq(\"used_at\", null); // Only update if not already used (race condition guard)\r\n\r\n      if (updateError) {\r\n        console.error(\"Error marking token as used:\", updateError);\r\n        // Still return success since token was valid, but log the issue\r\n        // In production, this would need better handling\r\n      }\r\n    }\r\n\r\n    // Token is valid\r\n    console.log(\r\n      `[SECURITY] Public access token validated for ${expectedResourceType}:${tokenRecord.resource_id}`,\r\n    );\r\n\r\n    return {\r\n      success: true,\r\n      resourceId: tokenRecord.resource_id,\r\n      resourceType: tokenRecord.resource_type,\r\n    };\r\n  } catch (error) {\r\n    console.error(\"Error validating public access token:\", error);\r\n    return { success: false, error: \"Not found\" };\r\n  }\r\n}\r\n\r\n/**\r\n * Revoke a public access token (before expiration)\r\n * Used when a resource is deleted or access is explicitly revoked\r\n */\r\nexport async function revokePublicAccessToken(token: string): Promise<boolean> {\r\n  try {\r\n    const { error } = await supabase\r\n      .from(\"public_access_tokens\")\r\n      .delete()\r\n      .eq(\"token\", token);\r\n\r\n    if (error) {\r\n      console.error(\"Error revoking public access token:\", error);\r\n      return false;\r\n    }\r\n\r\n    console.log(\"[SECURITY] Public access token revoked\");\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"Error in revokePublicAccessToken:\", error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Revoke all tokens for a specific resource\r\n * Used when a resource is deleted or access is completely revoked\r\n */\r\nexport async function revokeResourceTokens(\r\n  resourceType: \"proof\" | \"order\" | \"invoice\" | \"design\",\r\n  resourceId: string,\r\n): Promise<boolean> {\r\n  try {\r\n    const { error } = await supabase\r\n      .from(\"public_access_tokens\")\r\n      .delete()\r\n      .eq(\"resource_type\", resourceType)\r\n      .eq(\"resource_id\", resourceId);\r\n\r\n    if (error) {\r\n      console.error(\"Error revoking resource tokens:\", error);\r\n      return false;\r\n    }\r\n\r\n    console.log(\r\n      `[SECURITY] Revoked all tokens for ${resourceType}:${resourceId}`,\r\n    );\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"Error in revokeResourceTokens:\", error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Clean up expired tokens (run periodically via cron job)\r\n * SECURITY: This is a background operation - no response needed\r\n */\r\nexport async function cleanupExpiredTokens(): Promise<number> {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"public_access_tokens\")\r\n      .delete()\r\n      .lt(\"expires_at\", new Date().toISOString())\r\n      .neq(\"used_at\", null) // Don't delete unexpired tokens even if used\r\n      .select(\"id\", { count: \"exact\", head: true });\r\n\r\n    if (error) {\r\n      console.error(\"Error cleaning up expired tokens:\", error);\r\n      return 0;\r\n    }\r\n\r\n    console.log(\"[SECURITY] Cleaned up expired public access tokens\");\r\n    return data?.length || 0;\r\n  } catch (error) {\r\n    console.error(\"Error in cleanupExpiredTokens:\", error);\r\n    return 0;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AACA;;;;;;;AAkCO,SAAS;IACd,OAAO,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;AACzC;AAQO,eAAe,wBACpB,MAA+B;IAM/B,IAAI;QACF,MAAM,QAAQ;QACd,MAAM,iBAAiB,OAAO,cAAc,IAAI;QAChD,MAAM,YAAY,IAAI,KACpB,KAAK,GAAG,KAAK,iBAAiB,KAAK,KAAK,MACxC,WAAW;QAEb,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,gIAAQ,CAAC,IAAI,CAAC,wBAAwB,MAAM,CAAC;YACnE;YACA,eAAe,OAAO,YAAY;YAClC,aAAa,OAAO,UAAU;YAC9B,YAAY;YACZ,cAAc,OAAO,UAAU,IAAI;YACnC,YAAY,OAAO,SAAS;YAC5B,UAAU;gBACR,WAAW,IAAI,OAAO,WAAW;YACnC;QACF;QAEA,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,uCAAuC;YACrD,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAgC;QAClE;QAEA,6BAA6B;QAC7B,QAAQ,GAAG,CACT,CAAC,2CAA2C,EAAE,OAAO,YAAY,CAAC,CAAC,EAAE,OAAO,UAAU,CAAC,aAAa,EAAE,eAAe,aAAa,EAAE,OAAO,UAAU,IAAI,MAAM,CAAC,CAAC;QAGnK,OAAO;YAAE,SAAS;YAAM;QAAM;IAChC,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,OAAO;YAAE,SAAS;YAAO,OAAO;QAAgC;IAClE;AACF;AAYO,eAAe,0BACpB,KAAa,EACb,oBAA8D;IAE9D,IAAI;QACF,IAAI,CAAC,SAAS,MAAM,MAAM,KAAK,IAAI;YACjC,uCAAuC;YACvC,QAAQ,IAAI,CAAC;YACb,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAY;QAC9C;QAEA,gEAAgE;QAChE,MAAM,EAAE,MAAM,WAAW,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,gIAAQ,CAC7D,IAAI,CAAC,wBACL,MAAM,CACL,wEAED,EAAE,CAAC,SAAS,OACZ,WAAW;QAEd,kBAAkB;QAClB,IAAI,eAAe,CAAC,aAAa;YAC/B,QAAQ,IAAI,CAAC,sDAAsD;gBACjE,aAAa,MAAM,SAAS,CAAC,GAAG;gBAChC,OAAO,aAAa;YACtB;YACA,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAY;QAC9C;QAEA,gBAAgB;QAChB,IAAI,IAAI,KAAK,YAAY,UAAU,IAAI,IAAI,QAAQ;YACjD,QAAQ,IAAI,CAAC,+CAA+C;gBAC1D,cAAc,YAAY,aAAa;gBACvC,YAAY,YAAY,WAAW;YACrC;YACA,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAY;QAC9C;QAEA,oCAAoC;QACpC,IAAI,YAAY,YAAY,IAAI,YAAY,OAAO,EAAE;YACnD,QAAQ,IAAI,CAAC,+CAA+C;gBAC1D,cAAc,YAAY,aAAa;gBACvC,YAAY,YAAY,WAAW;gBACnC,QAAQ,YAAY,OAAO;YAC7B;YACA,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAY;QAC9C;QAEA,sCAAsC;QACtC,IAAI,YAAY,aAAa,KAAK,sBAAsB;YACtD,QAAQ,IAAI,CAAC,kDAAkD;gBAC7D,UAAU;gBACV,QAAQ,YAAY,aAAa;YACnC;YACA,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAY;QAC9C;QAEA,mDAAmD;QACnD,IAAI,YAAY,YAAY,EAAE;YAC5B,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,gIAAQ,CAC1C,IAAI,CAAC,wBACL,MAAM,CAAC;gBAAE,SAAS,IAAI,OAAO,WAAW;YAAG,GAC3C,EAAE,CAAC,SAAS,OACZ,EAAE,CAAC,WAAW,OAAO,yDAAyD;YAEjF,IAAI,aAAa;gBACf,QAAQ,KAAK,CAAC,gCAAgC;YAC9C,gEAAgE;YAChE,iDAAiD;YACnD;QACF;QAEA,iBAAiB;QACjB,QAAQ,GAAG,CACT,CAAC,6CAA6C,EAAE,qBAAqB,CAAC,EAAE,YAAY,WAAW,EAAE;QAGnG,OAAO;YACL,SAAS;YACT,YAAY,YAAY,WAAW;YACnC,cAAc,YAAY,aAAa;QACzC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yCAAyC;QACvD,OAAO;YAAE,SAAS;YAAO,OAAO;QAAY;IAC9C;AACF;AAMO,eAAe,wBAAwB,KAAa;IACzD,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,gIAAQ,CAC7B,IAAI,CAAC,wBACL,MAAM,GACN,EAAE,CAAC,SAAS;QAEf,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,uCAAuC;YACrD,OAAO;QACT;QAEA,QAAQ,GAAG,CAAC;QACZ,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,OAAO;IACT;AACF;AAMO,eAAe,qBACpB,YAAsD,EACtD,UAAkB;IAElB,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,gIAAQ,CAC7B,IAAI,CAAC,wBACL,MAAM,GACN,EAAE,CAAC,iBAAiB,cACpB,EAAE,CAAC,eAAe;QAErB,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,mCAAmC;YACjD,OAAO;QACT;QAEA,QAAQ,GAAG,CACT,CAAC,kCAAkC,EAAE,aAAa,CAAC,EAAE,YAAY;QAEnE,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kCAAkC;QAChD,OAAO;IACT;AACF;AAMO,eAAe;IACpB,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,gIAAQ,CACnC,IAAI,CAAC,wBACL,MAAM,GACN,EAAE,CAAC,cAAc,IAAI,OAAO,WAAW,IACvC,GAAG,CAAC,WAAW,MAAM,6CAA6C;SAClE,MAAM,CAAC,MAAM;YAAE,OAAO;YAAS,MAAM;QAAK;QAE7C,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,qCAAqC;YACnD,OAAO;QACT;QAEA,QAAQ,GAAG,CAAC;QACZ,OAAO,MAAM,UAAU;IACzB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kCAAkC;QAChD,OAAO;IACT;AACF"}},
    {"offset": {"line": 3491, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/orders.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport {\r\n  getCustomerOrders,\r\n  getOrderById,\r\n  getPendingOrders,\r\n  supabase,\r\n  getScopedSupabaseClient,\r\n} from \"../utils/supabase\";\r\nimport { ecwidAPI } from \"../utils/ecwid\";\r\nimport { parseOrderNumber, formatOrderNumber } from \"../utils/order\";\r\nimport { VerifyOrderAccessSchema, validate } from \"../schemas/validation\";\r\nimport {\r\n  validatePublicAccessToken,\r\n  createPublicAccessToken,\r\n} from \"../utils/public-access-tokens\";\r\n\r\n/**\r\n * Get customer's orders from Ecwid, BigCommerce, and Supabase with pagination\r\n * Requires: customerId in JWT token\r\n * Supports page and limit query parameters for pagination\r\n * SECURITY: Uses scoped Supabase client with RLS enforcement\r\n */\r\nexport const handleGetOrders: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n\r\n    if (!customerId) {\r\n      return res.status(401).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Get pagination params from query string\r\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\r\n    const limit = Math.min(\r\n      20,\r\n      Math.max(1, parseInt(req.query.limit as string) || 20),\r\n    ); // Max 20 per page\r\n    const offset = (page - 1) * limit;\r\n\r\n    console.log(\r\n      `Fetching orders for customer ${customerId} - Page: ${page}, Limit: ${limit}`,\r\n    );\r\n\r\n    // SECURITY: Use scoped client to enforce RLS policies\r\n    // Customer can only access their own orders\r\n    const scoped = getScopedSupabaseClient(req);\r\n\r\n    // Fetch orders from Ecwid\r\n    let ecwidOrders = [];\r\n    try {\r\n      ecwidOrders = await ecwidAPI.getCustomerOrders(customerId);\r\n    } catch (ecwidError) {\r\n      console.warn(\"Failed to fetch orders from Ecwid:\", ecwidError);\r\n      // Continue without Ecwid orders if API fails\r\n    }\r\n\r\n    // Fetch from Supabase for local orders\r\n    let supabaseOrders = [];\r\n    try {\r\n      supabaseOrders = await getCustomerOrders(customerId);\r\n    } catch (supabaseError) {\r\n      console.warn(\"Failed to fetch orders from Supabase:\", supabaseError);\r\n    }\r\n\r\n    // Fetch digital files for Ecwid orders from Supabase\r\n    let ecwidDigitalFilesMap = new Map();\r\n    if (ecwidOrders.length > 0) {\r\n      try {\r\n        const { data: digitalFilesData } = await scoped\r\n          .from(\"digital_files\")\r\n          .select(\"*\")\r\n          .in(\r\n            \"order_id\",\r\n            ecwidOrders.map((o: any) => o.id),\r\n          );\r\n\r\n        if (digitalFilesData) {\r\n          digitalFilesData.forEach((file: any) => {\r\n            if (!ecwidDigitalFilesMap.has(file.order_id)) {\r\n              ecwidDigitalFilesMap.set(file.order_id, []);\r\n            }\r\n            ecwidDigitalFilesMap.get(file.order_id).push({\r\n              id: file.id,\r\n              file_name: file.file_name,\r\n              file_url: file.file_url,\r\n              file_type: file.file_type,\r\n              file_size: file.file_size,\r\n              uploaded_at: file.uploaded_at,\r\n            });\r\n          });\r\n        }\r\n      } catch (filesError) {\r\n        console.warn(\r\n          \"Failed to fetch digital files for Ecwid orders:\",\r\n          filesError,\r\n        );\r\n      }\r\n    }\r\n\r\n    // Format Ecwid orders with tracking and design file info\r\n    const formattedEcwidOrders = ecwidOrders.map((order: any) => ({\r\n      id: order.id,\r\n      customerId: order.customerId,\r\n      status:\r\n        order.status ||\r\n        order.fulfillmentStatus ||\r\n        order.paymentStatus ||\r\n        \"processing\",\r\n      total: order.total,\r\n      subtotal: order.subtotal || 0,\r\n      tax: order.tax || 0,\r\n      shipping: order.shippingCost || 0,\r\n      dateCreated: order.createDate,\r\n      source: \"ecwid\",\r\n      itemCount: order.items?.length || 0,\r\n      items: order.items || [],\r\n      tracking_number: order.shippingTrackingCode,\r\n      tracking_carrier: order.shippingCarrier,\r\n      tracking_url: order.trackingUrl,\r\n      shipped_date: order.shippingDate,\r\n      estimated_delivery_date: order.estimatedDeliveryDate,\r\n      digital_files: ecwidDigitalFilesMap.get(order.id) || [],\r\n      shippingAddress: order.shippingPerson,\r\n      customerName: order.customerName,\r\n      customerEmail: order.email,\r\n      customerPhone: order.customerPhone,\r\n    }));\r\n\r\n    // Fetch digital files for all orders\r\n    const { data: digitalFilesData } = await scoped\r\n      .from(\"digital_files\")\r\n      .select(\"*\")\r\n      .in(\r\n        \"order_id\",\r\n        supabaseOrders.map((o: any) => o.id),\r\n      );\r\n\r\n    const filesMap = new Map();\r\n    if (digitalFilesData) {\r\n      digitalFilesData.forEach((file: any) => {\r\n        if (!filesMap.has(file.order_id)) {\r\n          filesMap.set(file.order_id, []);\r\n        }\r\n        filesMap.get(file.order_id).push({\r\n          id: file.id,\r\n          file_name: file.file_name,\r\n          file_url: file.file_url,\r\n          file_type: file.file_type,\r\n          file_size: file.file_size,\r\n          uploaded_at: file.uploaded_at,\r\n        });\r\n      });\r\n    }\r\n\r\n    // Format Supabase orders with digital files and customer info\r\n    const formattedSupabaseOrders = supabaseOrders.map((order: any) => {\r\n      // Fetch customer info for this order\r\n      const customerInfo = order.customers || {};\r\n\r\n      return {\r\n        id: order.id,\r\n        customerId: order.customer_id,\r\n        status: order.status || \"paid\",\r\n        total: order.total,\r\n        subtotal: order.subtotal || 0,\r\n        tax: order.tax || 0,\r\n        shipping: order.shipping || 0,\r\n        dateCreated: order.created_at,\r\n        source: \"supabase\",\r\n        itemCount: order.order_items?.length || 0,\r\n        items: order.order_items || [],\r\n        estimated_delivery_date: order.estimated_delivery_date,\r\n        tracking_number: order.tracking_number,\r\n        tracking_carrier: order.tracking_carrier,\r\n        tracking_url: order.tracking_url,\r\n        shipped_date: order.shipped_date,\r\n        digital_files: filesMap.get(order.id) || [],\r\n        shippingAddress: order.shipping_address,\r\n        customerName:\r\n          `${customerInfo.first_name || \"\"} ${customerInfo.last_name || \"\"}`.trim(),\r\n        customerEmail: customerInfo.email,\r\n        customerPhone: customerInfo.phone,\r\n      };\r\n    });\r\n\r\n    // Combine and sort by date\r\n    const allOrders = [\r\n      ...formattedEcwidOrders,\r\n      ...formattedSupabaseOrders,\r\n    ].sort(\r\n      (a, b) =>\r\n        new Date(b.dateCreated).getTime() - new Date(a.dateCreated).getTime(),\r\n    );\r\n\r\n    // Get paginated results\r\n    const paginatedOrders = allOrders.slice(offset, offset + limit);\r\n    const totalCount = allOrders.length;\r\n    const hasMore = offset + limit < totalCount;\r\n\r\n    console.log(\r\n      `Fetched ${allOrders.length} total orders, returning page ${page} with ${paginatedOrders.length} orders`,\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      orders: paginatedOrders,\r\n      count: paginatedOrders.length,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        offset,\r\n        totalCount,\r\n        totalPages: Math.ceil(totalCount / limit),\r\n        hasMore,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get orders error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to fetch orders\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Get single order details from Ecwid or Supabase\r\n * Requires: customerId in JWT token, orderId in params\r\n * VALIDATION: Order ID must be a valid integer\r\n */\r\nexport const handleGetOrder: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n    const { orderId } = req.params;\r\n\r\n    if (!customerId) {\r\n      return res.status(401).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // VALIDATION: Parse and validate orderId is a positive integer\r\n    const orderIdNum = parseInt(orderId, 10);\r\n    if (isNaN(orderIdNum) || orderIdNum <= 0) {\r\n      return res.status(400).json({\r\n        error: \"Request validation failed\",\r\n        details: [\r\n          { field: \"orderId\", message: \"Order ID must be a positive integer\" },\r\n        ],\r\n      });\r\n    }\r\n    let order = null;\r\n\r\n    // Try Ecwid first\r\n    try {\r\n      order = await ecwidAPI.getOrder(orderIdNum);\r\n      if (order && order.customerId === customerId) {\r\n        // Fetch digital files for this Ecwid order\r\n        let digitalFiles = [];\r\n        try {\r\n          const { data: digitalFilesData } = await supabase\r\n            .from(\"digital_files\")\r\n            .select(\"*\")\r\n            .eq(\"order_id\", orderIdNum);\r\n\r\n          if (digitalFilesData) {\r\n            digitalFiles = digitalFilesData.map((file: any) => ({\r\n              id: file.id,\r\n              file_name: file.file_name,\r\n              file_url: file.file_url,\r\n              file_type: file.file_type,\r\n              file_size: file.file_size,\r\n              uploaded_at: file.uploaded_at,\r\n            }));\r\n          }\r\n        } catch (filesError) {\r\n          console.warn(\r\n            \"Failed to fetch digital files for Ecwid order:\",\r\n            filesError,\r\n          );\r\n        }\r\n\r\n        return res.json({\r\n          success: true,\r\n          source: \"ecwid\",\r\n          order: {\r\n            id: order.id,\r\n            customerId: order.customerId,\r\n            status:\r\n              order.fulfillmentStatus || order.paymentStatus || \"processing\",\r\n            dateCreated: order.createDate,\r\n            total: order.total,\r\n            subtotal: order.subtotal || 0,\r\n            tax: order.tax || 0,\r\n            shipping: order.shippingCost || 0,\r\n            items: order.items || [],\r\n            shippingAddress: order.shippingPerson,\r\n            billingAddress: order.billingPerson,\r\n            tracking_number: order.shippingTrackingCode,\r\n            tracking_carrier: order.shippingCarrier,\r\n            estimated_delivery_date: order.estimatedDeliveryDate,\r\n            digital_files: digitalFiles,\r\n          },\r\n        });\r\n      }\r\n    } catch (ecwidError) {\r\n      console.warn(\"Failed to fetch order from Ecwid:\", ecwidError);\r\n    }\r\n\r\n    // Fallback to Supabase\r\n    order = await getOrderById(orderIdNum, customerId);\r\n\r\n    if (!order) {\r\n      return res.status(404).json({ error: \"Order not found\" });\r\n    }\r\n\r\n    // Fetch digital files for this order\r\n    const { data: digitalFilesData } = await supabase\r\n      .from(\"digital_files\")\r\n      .select(\"*\")\r\n      .eq(\"order_id\", order.id);\r\n\r\n    const digitalFiles = (digitalFilesData || []).map((file: any) => ({\r\n      id: file.id,\r\n      file_name: file.file_name,\r\n      file_url: file.file_url,\r\n      file_type: file.file_type,\r\n      file_size: file.file_size,\r\n      uploaded_at: file.uploaded_at,\r\n    }));\r\n\r\n    res.json({\r\n      success: true,\r\n      source: \"supabase\",\r\n      order: {\r\n        id: order.id,\r\n        customerId: order.customer_id,\r\n        status: order.status,\r\n        dateCreated: order.created_at,\r\n        total: order.total,\r\n        subtotal: order.subtotal,\r\n        tax: order.tax,\r\n        shipping: order.shipping,\r\n        items: order.order_items || [],\r\n        shippingAddress: order.shipping_address,\r\n        billingAddress: order.billing_address,\r\n        estimated_delivery_date: order.estimated_delivery_date,\r\n        tracking_number: order.tracking_number,\r\n        tracking_carrier: order.tracking_carrier,\r\n        tracking_url: order.tracking_url,\r\n        shipped_date: order.shipped_date,\r\n        digital_files: digitalFiles,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get order error:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch order\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Create a new order in Supabase\r\n * Requires: customerId in JWT token\r\n * Note: Most orders are created via the /api/checkout endpoint\r\n */\r\nexport const handleCreateOrder: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n\r\n    if (!customerId) {\r\n      return res.status(401).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    const { items, shippingAddress, billingAddress, total } = req.body;\r\n\r\n    if (!items || !Array.isArray(items) || items.length === 0) {\r\n      return res.status(400).json({ error: \"Order items required\" });\r\n    }\r\n\r\n    if (!shippingAddress || !billingAddress) {\r\n      return res\r\n        .status(400)\r\n        .json({ error: \"Shipping and billing addresses required\" });\r\n    }\r\n\r\n    // This endpoint is primarily for API use; checkout is the main flow\r\n    res.status(501).json({\r\n      error: \"Use /api/checkout endpoint to create orders\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Create order error:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to create order\";\r\n    res.status(500).json({ error: errorMessage });\r\n  }\r\n};\r\n\r\n/**\r\n * Get order by ID (admin/internal use)\r\n * Protected by verifyToken middleware\r\n * Note: In a real implementation, verify admin role before granting access\r\n */\r\nexport const handleAdminGetOrder: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { orderId } = req.params;\r\n\r\n    if (!orderId) {\r\n      return res.status(400).json({ error: \"Order ID required\" });\r\n    }\r\n\r\n    // TODO: Add admin role verification\r\n    res.status(501).json({\r\n      error: \"Admin order retrieval endpoint coming soon\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Admin get order error:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch order\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Get all pending orders (admin use)\r\n * Protected by verifyToken middleware\r\n */\r\nexport const handleGetPendingOrders: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n\r\n    if (!customerId) {\r\n      return res.status(401).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    const pendingOrders = await getPendingOrders();\r\n\r\n    const formattedOrders = pendingOrders.map((order) => ({\r\n      id: order.id,\r\n      customerId: order.customer_id,\r\n      customerName: order.customers\r\n        ? `${order.customers.first_name || \"\"} ${order.customers.last_name || \"\"}`.trim()\r\n        : \"Unknown\",\r\n      customerEmail: order.customers?.email || \"N/A\",\r\n      status: order.status,\r\n      total: order.total,\r\n      subtotal: order.subtotal,\r\n      tax: order.tax,\r\n      shipping: order.shipping,\r\n      dateCreated: order.created_at,\r\n      itemCount: 0,\r\n    }));\r\n\r\n    res.json({\r\n      success: true,\r\n      orders: formattedOrders,\r\n      count: formattedOrders.length,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get pending orders error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to fetch pending orders\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Get order by ID for public access (guest orders after checkout)\r\n * No authentication required - used for order confirmation after payment\r\n * VALIDATION: Order ID must be a valid positive integer\r\n */\r\nexport const handleGetOrderPublic: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { orderId } = req.params;\r\n    const { token } = req.query;\r\n\r\n    let orderIdNum: number;\r\n\r\n    // 1. Parse the Order ID\r\n    if (token && typeof token === \"string\") {\r\n      const validation = await validatePublicAccessToken(token, \"order\");\r\n      if (!validation.success) {\r\n        return res.status(404).json({ error: \"Order not found (Invalid Token)\" });\r\n      }\r\n      orderIdNum = parseInt(validation.resourceId, 10);\r\n    } else if (orderId && typeof orderId === \"string\") {\r\n      try {\r\n        orderIdNum = parseOrderNumber(orderId);\r\n      } catch (parseError) {\r\n        orderIdNum = parseInt(orderId, 10);\r\n      }\r\n    } else {\r\n      return res.status(404).json({ error: \"Order ID missing\" });\r\n    }\r\n\r\n    if (!orderIdNum || isNaN(orderIdNum) || orderIdNum <= 0) {\r\n      return res.status(404).json({ error: \"Invalid Order ID\" });\r\n    }\r\n\r\n    console.log(`[Public Access] Attempting to fetch Order ID: ${orderIdNum}`);\r\n\r\n    // 2. SETUP ADMIN CLIENT (Crucial Step)\r\n    const { createClient } = await import(\"@supabase/supabase-js\");\r\n\r\n    // Check for both common naming conventions for the Service Role Key\r\n    const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_SERVICE_KEY;\r\n\r\n    if (!supabaseUrl || !supabaseServiceKey) {\r\n      console.error(\"CRITICAL ERROR: Missing SUPABASE_SERVICE_ROLE_KEY. Cannot bypass RLS.\");\r\n      console.error(\"Available env vars:\", {\r\n        hasUrl: !!process.env.SUPABASE_URL,\r\n        hasServiceRoleKey: !!process.env.SUPABASE_SERVICE_ROLE_KEY,\r\n        hasServiceKey: !!process.env.SUPABASE_SERVICE_KEY,\r\n      });\r\n      return res.status(500).json({ error: \"Server configuration error\" });\r\n    }\r\n\r\n    // Create a fresh admin client for this request\r\n    const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\r\n      auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false,\r\n      }\r\n    });\r\n\r\n    // 3. Fetch Order using Admin Client\r\n    const { data: order, error: orderError } = await supabaseAdmin\r\n      .from(\"orders\")\r\n      .select(\r\n        `\r\n        id,\r\n        customer_id,\r\n        status,\r\n        created_at,\r\n        total,\r\n        subtotal,\r\n        tax,\r\n        shipping,\r\n        shipping_address,\r\n        billing_address,\r\n        estimated_delivery_date,\r\n        tracking_number,\r\n        tracking_carrier,\r\n        tracking_url,\r\n        shipped_date,\r\n        square_payment_details,\r\n        order_items (\r\n          id,\r\n          product_id,\r\n          product_name,\r\n          quantity,\r\n          price,\r\n          design_file_url\r\n        )\r\n      `,\r\n      )\r\n      .eq(\"id\", orderIdNum)\r\n      .single();\r\n\r\n    if (orderError || !order) {\r\n      console.warn(`[Public Access] Order ${orderIdNum} not found. Error:`, orderError?.message);\r\n      // If error is PGRST116, it means no rows found (RLS or ID doesn't exist)\r\n      return res.status(404).json({ error: \"Order not found\" });\r\n    }\r\n\r\n    console.log(`[Public Access] Successfully found Order ${orderIdNum}`);\r\n\r\n    // 4. Fetch Digital Files (using Admin Client)\r\n    const { data: digitalFilesData } = await supabaseAdmin\r\n      .from(\"digital_files\")\r\n      .select(\"*\")\r\n      .eq(\"order_id\", orderIdNum);\r\n\r\n    const digitalFiles = (digitalFilesData || []).map((file: any) => ({\r\n      id: file.id,\r\n      file_name: file.file_name,\r\n      file_url: file.file_url,\r\n      file_type: file.file_type,\r\n      file_size: file.file_size,\r\n      uploaded_at: file.uploaded_at,\r\n    }));\r\n\r\n    // 5. Return Response\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        id: order.id,\r\n        customer_id: order.customer_id,\r\n        status: order.status,\r\n        date_created: order.created_at,\r\n        total: order.total,\r\n        subtotal: order.subtotal,\r\n        tax: order.tax,\r\n        shipping: order.shipping,\r\n        products: (order.order_items || []).map((item: any) => ({\r\n          ...item,\r\n          name: item.product_name,\r\n        })),\r\n        shipping_addresses: order.shipping_address\r\n          ? [order.shipping_address]\r\n          : [],\r\n        billing_address: order.billing_address,\r\n        estimated_delivery_date: order.estimated_delivery_date,\r\n        tracking_number: order.tracking_number,\r\n        tracking_carrier: order.tracking_carrier,\r\n        tracking_url: order.tracking_url,\r\n        shipped_date: order.shipped_date,\r\n        square_payment_id: order.square_payment_details?.payment_id || null,\r\n        digital_files: digitalFiles,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get order public error:\", error);\r\n    const errorMsg =\r\n      error instanceof Error ? error.message : \"Failed to fetch order\";\r\n    res.status(500).json({ error: errorMsg });\r\n  }\r\n};\r\n\r\n/**\r\n * Verify public order access with customer verification (email or phone)\r\n * No authentication required - customers verify with order number and email/phone\r\n * VALIDATION: Request body validated against VerifyOrderAccessSchema\r\n */\r\nexport const handleVerifyOrderAccess: RequestHandler = async (req, res) => {\r\n  try {\r\n    // VALIDATION: Validate request body (order_number and verification_field)\r\n    const validationResult = await validate(VerifyOrderAccessSchema, req.body);\r\n    if (!validationResult.success) {\r\n      return res.status(400).json({\r\n        error: \"Request validation failed\",\r\n        details: validationResult.errors,\r\n      });\r\n    }\r\n\r\n    const { order_number, verification_field } = validationResult.data;\r\n\r\n    // Parse order number to numeric ID\r\n    let orderIdNum: number;\r\n    try {\r\n      orderIdNum = parseOrderNumber(order_number);\r\n    } catch (err) {\r\n      // Return 404 for invalid format - don't reveal format issues\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Order not found\",\r\n      });\r\n    }\r\n\r\n    const { supabase } = await import(\"../utils/supabase\");\r\n\r\n    // Get the order by ID\r\n    const { data: order, error: orderError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"id, customer_id, public_access_token\")\r\n      .eq(\"id\", orderIdNum)\r\n      .maybeSingle();\r\n\r\n    if (orderError || !order) {\r\n      // Return 404 for any lookup failure - don't reveal if order exists\r\n      console.warn(\"Order not found for ID:\", orderIdNum);\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Order not found\",\r\n      });\r\n    }\r\n\r\n    // Verify customer info (email or phone) matches order\r\n    const { data: customer, error: customerError } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"email, phone\")\r\n      .eq(\"id\", order.customer_id)\r\n      .maybeSingle();\r\n\r\n    if (customerError || !customer) {\r\n      console.warn(\"Customer not found for order:\", order.id);\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Order not found\",\r\n      });\r\n    }\r\n\r\n    // Verify that the provided field matches customer email or phone\r\n    const emailMatch =\r\n      customer.email &&\r\n      customer.email.toLowerCase() === verification_field.toLowerCase();\r\n    const phoneMatch =\r\n      customer.phone &&\r\n      customer.phone.replace(/\\D/g, \"\") ===\r\n      verification_field.replace(/\\D/g, \"\");\r\n\r\n    if (!emailMatch && !phoneMatch) {\r\n      // Log suspicious activity but return generic error\r\n      console.warn(\"Failed verification attempt for order:\", order.id);\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Order not found\",\r\n      });\r\n    }\r\n\r\n    // Verification successful - return public access token\r\n    return res.status(200).json({\r\n      success: true,\r\n      verified: true,\r\n      orderId: order.id,\r\n      publicAccessToken: order.public_access_token,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Verify order access error:\", error);\r\n    return res.status(404).json({\r\n      success: false,\r\n      error: \"Order not found\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Look up order by public access token with prior verification\r\n * Requires prior successful verification via handleVerifyOrderAccess\r\n */\r\nexport const handleGetOrderStatus: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { publicAccessToken } = req.query;\r\n\r\n    if (!publicAccessToken) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Public access token is required\",\r\n      });\r\n    }\r\n\r\n    const { supabase } = await import(\"../utils/supabase\");\r\n\r\n    // Get the order by public access token (after verification)\r\n    // Try with tracking columns first, fall back to basic columns if they don't exist\r\n    let order: any;\r\n    let orderError: any;\r\n\r\n    const { data: fullOrder, error: fullError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\r\n        `\r\n        id,\r\n        customer_id,\r\n        public_access_token,\r\n        status,\r\n        created_at,\r\n        total,\r\n        subtotal,\r\n        tax,\r\n        shipping,\r\n        shipping_address,\r\n        billing_address,\r\n        tracking_number,\r\n        tracking_carrier,\r\n        tracking_url,\r\n        shipped_date,\r\n        order_items (\r\n          id,\r\n          product_id,\r\n          quantity,\r\n          price,\r\n          options,\r\n          design_file_url\r\n        )\r\n      `,\r\n      )\r\n      .eq(\"public_access_token\", publicAccessToken)\r\n      .maybeSingle();\r\n\r\n    if (fullOrder) {\r\n      order = fullOrder;\r\n      orderError = null;\r\n    } else if (\r\n      fullError &&\r\n      (fullError.message.includes(\"column\") || fullError.code === \"42703\")\r\n    ) {\r\n      // If tracking columns don't exist yet, try without them\r\n      console.log(\"Tracking columns not available yet, fetching basic order\");\r\n      const { data: basicOrder, error: basicError } = await supabase\r\n        .from(\"orders\")\r\n        .select(\r\n          `\r\n          id,\r\n          customer_id,\r\n          public_access_token,\r\n          status,\r\n          created_at,\r\n          total,\r\n          subtotal,\r\n          tax,\r\n          shipping,\r\n          shipping_address,\r\n          billing_address,\r\n          order_items (\r\n            id,\r\n            product_id,\r\n            quantity,\r\n            price,\r\n            options,\r\n            design_file_url\r\n          )\r\n        `,\r\n        )\r\n        .eq(\"public_access_token\", publicAccessToken)\r\n        .maybeSingle();\r\n\r\n      order = basicOrder;\r\n      orderError = basicError;\r\n    } else {\r\n      order = fullOrder;\r\n      orderError = fullError;\r\n    }\r\n\r\n    if (orderError || !order) {\r\n      console.warn(\r\n        \"Order not found for public access token:\",\r\n        publicAccessToken,\r\n      );\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Order not found\",\r\n      });\r\n    }\r\n\r\n    console.log(\"Order found:\", {\r\n      id: order.id,\r\n      customer_id: order.customer_id,\r\n    });\r\n\r\n    // Fetch customer info for display\r\n    let customerEmail = \"\";\r\n    let customerName = \"\";\r\n\r\n    if (order.customer_id) {\r\n      const { data: customer, error: customerError } = await supabase\r\n        .from(\"customers\")\r\n        .select(\"email, name\")\r\n        .eq(\"id\", order.customer_id)\r\n        .single();\r\n\r\n      if (customer) {\r\n        customerEmail = customer.email || \"\";\r\n        customerName = customer.name || \"\";\r\n        console.log(\"Customer found:\", {\r\n          email: customerEmail,\r\n          name: customerName,\r\n        });\r\n      }\r\n    }\r\n\r\n    // Enrich order items with product details\r\n    const enrichedItems = await Promise.all(\r\n      (order.order_items || []).map(async (item: any) => {\r\n        let productName = `Product #${item.product_id}`;\r\n        let productSku = \"\";\r\n        let productDescription = \"\";\r\n\r\n        if (item.product_id) {\r\n          try {\r\n            // Handle both numeric and string IDs (e.g., \"admin_11\" or 11)\r\n            let queryId = item.product_id;\r\n            if (typeof queryId === \"string\" && queryId.includes(\"admin_\")) {\r\n              // Extract numeric part from \"admin_11\" -> 11\r\n              const numericPart = queryId.replace(\"admin_\", \"\");\r\n              queryId = parseInt(numericPart, 10);\r\n            }\r\n\r\n            console.log(\r\n              `Fetching product with ID: ${queryId} (original: ${item.product_id})`,\r\n            );\r\n\r\n            const { data: product, error: productError } = await supabase\r\n              .from(\"admin_products\")\r\n              .select(\"name, sku, description\")\r\n              .eq(\"id\", queryId)\r\n              .single();\r\n\r\n            if (product && product.name) {\r\n              productName = product.name;\r\n              productSku = product.sku || \"\";\r\n              productDescription = product.description || \"\";\r\n              console.log(`Product found: ${productName}`);\r\n            } else if (productError) {\r\n              console.warn(`Failed to fetch product ${queryId}:`, productError);\r\n            }\r\n          } catch (err) {\r\n            console.warn(`Error fetching product ${item.product_id}:`, err);\r\n          }\r\n        }\r\n\r\n        return {\r\n          ...item,\r\n          product_name: productName,\r\n          product_sku: productSku,\r\n          product_description: productDescription,\r\n          options: item.options || null,\r\n          design_file_url: item.design_file_url || null,\r\n          line_total: (item.price || 0) * (item.quantity || 0),\r\n        };\r\n      }),\r\n    );\r\n\r\n    // Fetch digital files if any exist\r\n    const { data: digitalFilesData } = await supabase\r\n      .from(\"digital_files\")\r\n      .select(\"*\")\r\n      .eq(\"order_id\", order.id);\r\n\r\n    const digitalFiles = (digitalFilesData || []).map((file: any) => ({\r\n      id: file.id,\r\n      file_name: file.file_name,\r\n      file_url: file.file_url,\r\n      file_type: file.file_type,\r\n      file_size: file.file_size,\r\n      uploaded_at: file.uploaded_at,\r\n    }));\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        id: order.id,\r\n        status: order.status,\r\n        dateCreated: order.created_at,\r\n        total: order.total,\r\n        subtotal: order.subtotal,\r\n        tax: order.tax,\r\n        shipping: order.shipping,\r\n        customerName: customerName || \"\",\r\n        customerEmail: customerEmail,\r\n        products: enrichedItems,\r\n        shippingAddress: order.shipping_address,\r\n        billingAddress: order.billing_address,\r\n        trackingNumber: order.tracking_number || undefined,\r\n        trackingCarrier: order.tracking_carrier || undefined,\r\n        trackingUrl: order.tracking_url || undefined,\r\n        shippedDate: order.shipped_date || undefined,\r\n        digitalFiles: digitalFiles,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get order status error:\", error);\r\n    const errorMsg =\r\n      error instanceof Error ? error.message : \"Failed to fetch order status\";\r\n    res.status(500).json({\r\n      success: false,\r\n      error: errorMsg,\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4269, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/admin-orders.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport {\r\n  supabase,\r\n  getPendingOrders,\r\n  getActiveOrders,\r\n  getActiveOrdersCount,\r\n} from \"../utils/supabase\";\r\n\r\ninterface OrderItem {\r\n  id?: number;\r\n  quantity?: number;\r\n  product_name?: string;\r\n  options?: Record<string, any>;\r\n  design_file_url?: string;\r\n}\r\n\r\ninterface ProofStatus {\r\n  id: string;\r\n  status: \"pending\" | \"approved\" | \"revisions_requested\";\r\n  description?: string;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\ninterface OrderWithCustomer {\r\n  id: number;\r\n  customerId: number;\r\n  customerName: string;\r\n  customerEmail: string;\r\n  status: string;\r\n  total: number;\r\n  dateCreated: string;\r\n  source: \"ecwid\" | \"supabase\";\r\n  orderItems?: OrderItem[];\r\n}\r\n\r\n/**\r\n * Test endpoint to verify admin orders endpoint is working\r\n */\r\nexport const handleTestAdminOrders: RequestHandler = async (req, res) => {\r\n  try {\r\n    const token = req.headers.authorization;\r\n    const hasToken = !!token;\r\n\r\n    res.set(\"Content-Type\", \"application/json\");\r\n    res.json({\r\n      status: \"ok\",\r\n      timestamp: new Date().toISOString(),\r\n      message: \"Admin orders endpoint is accessible\",\r\n      auth: {\r\n        hasToken,\r\n        isAdmin: req.isAdmin || false,\r\n        customerId: req.customerId || null,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    res.status(500).json({ error: \"Test failed\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Debug endpoint to test Supabase order structure\r\n */\r\nexport const handleDebugOrders: RequestHandler = async (req, res) => {\r\n  try {\r\n    console.log(\"=== DEBUG ORDERS ENDPOINT ===\");\r\n\r\n    // Fetch first order\r\n    const { data: orders, error: ordersError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"id, status, total\")\r\n      .limit(1);\r\n\r\n    console.log(\"Orders query result:\", { orders, error: ordersError });\r\n\r\n    if (!orders || orders.length === 0) {\r\n      return res.json({\r\n        message: \"No orders found\",\r\n        error: ordersError,\r\n      });\r\n    }\r\n\r\n    const firstOrderId = orders[0].id;\r\n    console.log(\"First order ID:\", firstOrderId, \"Type:\", typeof firstOrderId);\r\n\r\n    // Try to fetch with order_items\r\n    const { data: orderWithItems, error: itemsError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\r\n        `\r\n        id,\r\n        status,\r\n        total,\r\n        order_items(id, product_name, options)\r\n      `,\r\n      )\r\n      .eq(\"id\", firstOrderId)\r\n      .single();\r\n\r\n    console.log(\"Order with items result:\", {\r\n      data: orderWithItems,\r\n      error: itemsError,\r\n    });\r\n\r\n    res.json({\r\n      firstOrder: orders[0],\r\n      orderWithItems,\r\n      itemsError,\r\n      debug: {\r\n        orderId: firstOrderId,\r\n        orderIdType: typeof firstOrderId,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Debug endpoint error:\", error);\r\n    res.status(500).json({\r\n      error: error instanceof Error ? error.message : \"Unknown error\",\r\n      stack: error instanceof Error ? error.stack : undefined,\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Get a single order detail from Supabase (admin only)\r\n * Fetches complete order information including design files\r\n * Returns full order data with all nested relationships\r\n */\r\nexport const handleGetOrderDetail: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { orderId } = req.params;\r\n\r\n    if (!orderId) {\r\n      return res.status(400).json({ error: \"Order ID is required\" });\r\n    }\r\n\r\n    // Convert orderId to number since it comes as a string from params\r\n    const orderIdNumber = parseInt(orderId, 10);\r\n    if (isNaN(orderIdNumber)) {\r\n      return res.status(400).json({ error: \"Invalid order ID format\" });\r\n    }\r\n\r\n    console.log(`Fetching order detail for ID: ${orderIdNumber}`);\r\n\r\n    // Try to fetch with all columns, fall back to basic columns if some don't exist\r\n    let order: any;\r\n    let error: any;\r\n\r\n    // First try with all columns\r\n    const { data: fullOrder, error: fullError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\r\n        `\r\n        id,\r\n        customer_id,\r\n        status,\r\n        total,\r\n        subtotal,\r\n        tax,\r\n        shipping,\r\n        created_at,\r\n        updated_at,\r\n        shipping_address,\r\n        tracking_number,\r\n        tracking_carrier,\r\n        tracking_url,\r\n        shipped_date,\r\n        customers(id,first_name,last_name,email,phone),\r\n        order_items(id,quantity,product_name,options,design_file_url),\r\n        proofs(id,status,description,created_at,updated_at)\r\n        `,\r\n      )\r\n      .eq(\"id\", orderIdNumber)\r\n      .single();\r\n\r\n    if (fullOrder) {\r\n      order = fullOrder;\r\n      error = null;\r\n    } else if (\r\n      fullError &&\r\n      (fullError.message.includes(\"column\") || fullError.code === \"42703\")\r\n    ) {\r\n      // If column doesn't exist (code 42703 is PostgreSQL \"column does not exist\"), try without the new columns\r\n      console.log(\"New columns not available yet, fetching with basic columns\");\r\n      const { data: basicOrder, error: basicError } = await supabase\r\n        .from(\"orders\")\r\n        .select(\r\n          `\r\n          id,\r\n          customer_id,\r\n          status,\r\n          total,\r\n          subtotal,\r\n          tax,\r\n          shipping,\r\n          created_at,\r\n          updated_at,\r\n          customers(id,first_name,last_name,email,phone),\r\n          order_items(id,quantity,product_name,options,design_file_url),\r\n          proofs(id,status,description,created_at,updated_at)\r\n          `,\r\n        )\r\n        .eq(\"id\", orderIdNumber)\r\n        .single();\r\n\r\n      order = basicOrder;\r\n      error = basicError;\r\n\r\n      if (basicOrder) {\r\n        console.log(\r\n          `Successfully fetched order ${orderIdNumber} with basic columns`,\r\n        );\r\n      }\r\n    } else {\r\n      order = fullOrder;\r\n      error = fullError;\r\n    }\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching order detail:\", {\r\n        orderId: orderIdNumber,\r\n        errorCode: error.code,\r\n        errorMessage: error.message,\r\n        errorDetails: error.details,\r\n      });\r\n\r\n      // Provide more specific error messages\r\n      if (error.code === \"PGRST301\") {\r\n        return res\r\n          .status(403)\r\n          .json({ error: \"Permission denied - check your access level\" });\r\n      }\r\n\r\n      return res.status(404).json({\r\n        error: \"Order not found\",\r\n        debug:\r\n          process.env.NODE_ENV === \"development\" ? error.message : undefined,\r\n      });\r\n    }\r\n\r\n    if (!order) {\r\n      console.warn(`Order not found for ID: ${orderIdNumber}`);\r\n      return res.status(404).json({ error: \"Order not found\" });\r\n    }\r\n\r\n    console.log(`Successfully fetched order ${orderIdNumber}`);\r\n\r\n    // Format the response\r\n    const customerName =\r\n      order.customers && Array.isArray(order.customers)\r\n        ? `${order.customers[0]?.first_name || \"\"} ${order.customers[0]?.last_name || \"\"}`.trim()\r\n        : order.customers\r\n          ? `${order.customers.first_name || \"\"} ${order.customers.last_name || \"\"}`.trim()\r\n          : \"Guest\";\r\n\r\n    const customerEmail =\r\n      order.customers && Array.isArray(order.customers)\r\n        ? order.customers[0]?.email || \"N/A\"\r\n        : order.customers?.email || \"N/A\";\r\n\r\n    const customerPhone =\r\n      order.customers && Array.isArray(order.customers)\r\n        ? order.customers[0]?.phone || undefined\r\n        : order.customers?.phone || undefined;\r\n\r\n    const customerRecordId =\r\n      order.customers && Array.isArray(order.customers)\r\n        ? order.customers[0]?.id\r\n        : order.customers?.id;\r\n\r\n    const formattedOrder = {\r\n      id: order.id,\r\n      customerId: order.customer_id,\r\n      customerRecordId,\r\n      customerName,\r\n      customerEmail,\r\n      customerPhone,\r\n      status: order.status,\r\n      total: order.total || 0,\r\n      subtotal: order.subtotal || 0,\r\n      tax: order.tax || 0,\r\n      shipping: order.shipping || 0,\r\n      dateCreated: order.created_at || new Date().toISOString(),\r\n      dateUpdated: order.updated_at || new Date().toISOString(),\r\n      source: \"supabase\" as const,\r\n      shippingAddress: order.shipping_address || undefined,\r\n      trackingNumber: order.tracking_number || undefined,\r\n      trackingCarrier: order.tracking_carrier || undefined,\r\n      trackingUrl: order.tracking_url || undefined,\r\n      shippedDate: order.shipped_date || undefined,\r\n      squarePaymentId: undefined,\r\n      orderItems: (order.order_items || []).map((item: any) => ({\r\n        id: item.id,\r\n        quantity: item.quantity,\r\n        product_name: item.product_name,\r\n        options: item.options,\r\n        design_file_url: item.design_file_url,\r\n      })),\r\n      proofs: (order.proofs || []).map((proof: any) => ({\r\n        id: proof.id,\r\n        status: proof.status,\r\n        description: proof.description,\r\n        createdAt: proof.created_at,\r\n        updatedAt: proof.updated_at,\r\n      })),\r\n    };\r\n\r\n    res.json({\r\n      success: true,\r\n      order: formattedOrder,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get order detail error:\", {\r\n      error,\r\n      message: error instanceof Error ? error.message : String(error),\r\n      stack: error instanceof Error ? error.stack : undefined,\r\n    });\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to fetch order\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Get all orders from Supabase (admin only) with pagination\r\n * Fetches orders regardless of status with pagination to reduce response size\r\n * Returns orders with customer details and tracking info\r\n * Supports page, limit, and date query parameters for pagination and filtering\r\n */\r\nexport const handleGetAllAdminOrders: RequestHandler = async (req, res) => {\r\n  try {\r\n    // Get pagination params from query string\r\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\r\n    const limit = Math.min(\r\n      20,\r\n      Math.max(1, parseInt(req.query.limit as string) || 20),\r\n    ); // Max 20 per page\r\n    const offset = (page - 1) * limit;\r\n    const dateFilter = (req.query.date as string) || null;\r\n\r\n    console.log(\r\n      `Fetching orders - Page: ${page}, Limit: ${limit}, Offset: ${offset}, Date: ${dateFilter || \"all\"}`,\r\n    );\r\n\r\n    // Build the initial query\r\n    let countQuery = supabase\r\n      .from(\"orders\")\r\n      .select(\"id\", { count: \"exact\", head: true });\r\n    let dataQuery = supabase\r\n      .from(\"orders\")\r\n      .select(\r\n        `\r\n        id,\r\n        customer_id,\r\n        status,\r\n        total,\r\n        subtotal,\r\n        tax,\r\n        shipping,\r\n        created_at,\r\n        updated_at,\r\n        customers(id,first_name,last_name,email),\r\n        order_items(id,quantity,product_name,options),\r\n        proofs(id,status)\r\n        `,\r\n      )\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    // Apply date filter if provided\r\n    if (dateFilter) {\r\n      // Filter by date (created_at between start and end of day)\r\n      const startOfDay = `${dateFilter}T00:00:00.000Z`;\r\n      const endOfDay = `${dateFilter}T23:59:59.999Z`;\r\n      countQuery = countQuery\r\n        .gte(\"created_at\", startOfDay)\r\n        .lte(\"created_at\", endOfDay);\r\n      dataQuery = dataQuery\r\n        .gte(\"created_at\", startOfDay)\r\n        .lte(\"created_at\", endOfDay);\r\n    }\r\n\r\n    // First, get the total count of orders\r\n    const { count: totalCount, error: countError } = await countQuery;\r\n\r\n    if (countError) {\r\n      console.error(\"Error getting order count:\", countError);\r\n      throw countError;\r\n    }\r\n\r\n    // Fetch paginated orders from Supabase\r\n    let supabaseOrders: any[] = [];\r\n    try {\r\n      const result = await dataQuery.range(offset, offset + limit - 1); // Paginate\r\n\r\n      supabaseOrders = result.data || [];\r\n\r\n      if (result.error) {\r\n        console.error(\"Supabase error:\", result.error);\r\n      }\r\n\r\n      console.log(`Fetched ${supabaseOrders.length} orders for page ${page}`);\r\n    } catch (queryError) {\r\n      console.error(\"Supabase query exception:\", queryError);\r\n    }\r\n\r\n    // Format Supabase orders\r\n    const formattedSupabaseOrders = supabaseOrders.map((order: any) => {\r\n      try {\r\n        const customerName =\r\n          order.customers && Array.isArray(order.customers)\r\n            ? `${order.customers[0]?.first_name || \"\"} ${order.customers[0]?.last_name || \"\"}`.trim()\r\n            : order.customers\r\n              ? `${order.customers.first_name || \"\"} ${order.customers.last_name || \"\"}`.trim()\r\n              : \"Guest\";\r\n\r\n        const customerEmail =\r\n          order.customers && Array.isArray(order.customers)\r\n            ? order.customers[0]?.email || \"N/A\"\r\n            : order.customers?.email || \"N/A\";\r\n\r\n        return {\r\n          id: order.id,\r\n          customerId: order.customer_id,\r\n          customerName,\r\n          customerEmail,\r\n          status: order.status,\r\n          total: order.total || 0,\r\n          subtotal: order.subtotal || 0,\r\n          tax: order.tax || 0,\r\n          shipping: order.shipping || 0,\r\n          dateCreated: order.created_at || new Date().toISOString(),\r\n          source: \"supabase\" as const,\r\n          orderItems: (order.order_items || []).map((item: any) => ({\r\n            id: item.id,\r\n            quantity: item.quantity,\r\n            product_name: item.product_name,\r\n            options: item.options,\r\n          })),\r\n          proofs: (order.proofs || []).map((proof: any) => ({\r\n            id: proof.id,\r\n            status: proof.status,\r\n          })),\r\n        };\r\n      } catch (formatError) {\r\n        console.error(\"Error formatting order:\", {\r\n          orderId: order.id,\r\n          formatError,\r\n        });\r\n        return {\r\n          id: order.id,\r\n          customerId: order.customer_id,\r\n          customerName: \"Unknown\",\r\n          customerEmail: \"Unknown\",\r\n          status: order.status,\r\n          total: order.total || 0,\r\n          subtotal: order.subtotal || 0,\r\n          tax: order.tax || 0,\r\n          shipping: order.shipping || 0,\r\n          dateCreated: order.created_at || new Date().toISOString(),\r\n          source: \"supabase\" as const,\r\n          orderItems: [],\r\n          proofs: [],\r\n        };\r\n      }\r\n    });\r\n\r\n    const hasMore = offset + limit < (totalCount || 0);\r\n\r\n    res.json({\r\n      success: true,\r\n      orders: formattedSupabaseOrders,\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        offset,\r\n        totalCount: totalCount || 0,\r\n        totalPages: Math.ceil((totalCount || 0) / limit),\r\n        hasMore,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get all admin orders error:\", {\r\n      error,\r\n      message: error instanceof Error ? error.message : String(error),\r\n      stack: error instanceof Error ? error.stack : undefined,\r\n    });\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to fetch orders\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Get all active orders from Supabase only (admin only)\r\n * Fetches orders with statuses: pending, processing, printing, in transit\r\n * Returns orders with customer details\r\n * Note: Only fetches from Supabase database, not from Ecwid\r\n */\r\nexport const handleGetAdminPendingOrders: RequestHandler = async (req, res) => {\r\n  try {\r\n    console.log(\"Fetching admin pending orders count...\");\r\n\r\n    // For the navbar badge, we only need the count, not full order details\r\n    // This is much faster than fetching all order data\r\n    const count = await getActiveOrdersCount();\r\n\r\n    console.log(`Admin pending orders count: ${count}`);\r\n\r\n    // Set explicit content type and ensure proper JSON response\r\n    res.set(\"Content-Type\", \"application/json\");\r\n    res.set(\"Cache-Control\", \"no-cache, no-store, must-revalidate\");\r\n\r\n    res.json({\r\n      success: true,\r\n      orders: [],\r\n      count: count,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get admin pending orders count error:\", {\r\n      message: error instanceof Error ? error.message : String(error),\r\n      stack: error instanceof Error ? error.stack : undefined,\r\n    });\r\n    // Don't fail - just return 0 count\r\n    res.set(\"Content-Type\", \"application/json\");\r\n    res.json({\r\n      success: true,\r\n      orders: [],\r\n      count: 0,\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Update order status and/or tracking information\r\n * Allows admins to change order status and add tracking details\r\n */\r\nexport const handleUpdateOrderStatus: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { orderId } = req.params;\r\n    const {\r\n      status,\r\n      tracking_number,\r\n      tracking_carrier,\r\n      tracking_url,\r\n      shipping_address,\r\n    } = req.body;\r\n\r\n    if (!orderId) {\r\n      return res.status(400).json({ error: \"Order ID is required\" });\r\n    }\r\n\r\n    // Convert orderId to number\r\n    const orderIdNumber = parseInt(orderId, 10);\r\n    if (isNaN(orderIdNumber)) {\r\n      return res.status(400).json({ error: \"Invalid order ID format\" });\r\n    }\r\n\r\n    const updateData: any = {};\r\n    const validStatuses = [\r\n      \"pending_payment\",\r\n      \"paid\",\r\n      \"pending\",\r\n      \"processing\",\r\n      \"printing\",\r\n      \"cutting\",\r\n      \"preparing for shipping\",\r\n      \"in transit\",\r\n      \"shipped\",\r\n      \"delivered\",\r\n      \"cancelled\",\r\n      \"payment_failed\",\r\n      \"completed\",\r\n    ];\r\n\r\n    // Validate status if provided\r\n    if (status) {\r\n      if (!validStatuses.includes(status)) {\r\n        return res.status(400).json({\r\n          error: `Invalid status. Valid statuses are: ${validStatuses.join(\", \")}`,\r\n        });\r\n      }\r\n      updateData.status = status;\r\n    }\r\n\r\n    // Add shipping address if provided\r\n    if (shipping_address !== undefined) {\r\n      updateData.shipping_address = shipping_address || null;\r\n    }\r\n\r\n    // Add tracking information if provided\r\n    if (tracking_number !== undefined) {\r\n      updateData.tracking_number = tracking_number || null;\r\n    }\r\n    if (tracking_carrier !== undefined) {\r\n      updateData.tracking_carrier = tracking_carrier || null;\r\n    }\r\n    if (tracking_url !== undefined) {\r\n      updateData.tracking_url = tracking_url || null;\r\n    }\r\n\r\n    // If tracking information is provided, set the shipped date\r\n    if (tracking_number) {\r\n      updateData.shipped_date = new Date().toISOString();\r\n    }\r\n\r\n    updateData.updated_at = new Date().toISOString();\r\n\r\n    // Update the order in Supabase\r\n    const { data, error } = await supabase\r\n      .from(\"orders\")\r\n      .update(updateData)\r\n      .eq(\"id\", orderIdNumber)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error(\"Error updating order:\", {\r\n        orderId: orderIdNumber,\r\n        error: error.message,\r\n        code: error.code,\r\n      });\r\n\r\n      // If error is about missing column (shipped_date), try updating without it\r\n      if (error.code === \"42703\" && error.message.includes(\"shipped_date\")) {\r\n        console.log(\r\n          \"shipped_date column not available yet, retrying without it\",\r\n        );\r\n\r\n        // Remove shipped_date and try again\r\n        delete updateData.shipped_date;\r\n\r\n        const { data: retryData, error: retryError } = await supabase\r\n          .from(\"orders\")\r\n          .update(updateData)\r\n          .eq(\"id\", orderIdNumber)\r\n          .select()\r\n          .single();\r\n\r\n        if (retryError) {\r\n          console.error(\"Retry error updating order:\", retryError);\r\n          return res.status(500).json({ error: \"Failed to update order\" });\r\n        }\r\n\r\n        return res.json({\r\n          success: true,\r\n          message: \"Order updated successfully\",\r\n          order: retryData,\r\n        });\r\n      }\r\n\r\n      return res.status(500).json({ error: \"Failed to update order\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Order updated successfully\",\r\n      order: data,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Update order status error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to update order\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Update shipping address for an order\r\n * Allows admins to edit shipping address details\r\n */\r\nexport const handleUpdateShippingAddress: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { orderId } = req.params;\r\n    const {\r\n      first_name,\r\n      last_name,\r\n      street_1,\r\n      street_2,\r\n      city,\r\n      state_or_province,\r\n      postal_code,\r\n      country_iso2,\r\n      phone,\r\n    } = req.body;\r\n\r\n    if (!orderId) {\r\n      return res.status(400).json({ error: \"Order ID is required\" });\r\n    }\r\n\r\n    // Convert orderId to number\r\n    const orderIdNumber = parseInt(orderId, 10);\r\n    if (isNaN(orderIdNumber)) {\r\n      return res.status(400).json({ error: \"Invalid order ID format\" });\r\n    }\r\n\r\n    // Validate required fields\r\n    if (\r\n      !first_name ||\r\n      !last_name ||\r\n      !street_1 ||\r\n      !city ||\r\n      !state_or_province ||\r\n      !postal_code ||\r\n      !country_iso2\r\n    ) {\r\n      return res.status(400).json({\r\n        error:\r\n          \"Missing required fields: first_name, last_name, street_1, city, state_or_province, postal_code, country_iso2\",\r\n      });\r\n    }\r\n\r\n    const shippingAddress = {\r\n      first_name,\r\n      last_name,\r\n      street_1,\r\n      street_2: street_2 || undefined,\r\n      city,\r\n      state_or_province,\r\n      postal_code,\r\n      country_iso2,\r\n      phone: phone || undefined,\r\n    };\r\n\r\n    // Update the order in Supabase\r\n    const { data, error } = await supabase\r\n      .from(\"orders\")\r\n      .update({\r\n        shipping_address: shippingAddress,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", orderIdNumber)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error(\"Error updating shipping address:\", {\r\n        orderId: orderIdNumber,\r\n        error: error.message,\r\n        code: error.code,\r\n      });\r\n\r\n      // If column doesn't exist (code 42703 is PostgreSQL \"column does not exist\")\r\n      if (\r\n        error.code === \"42703\" &&\r\n        error.message.includes(\"shipping_address\")\r\n      ) {\r\n        console.error(\r\n          \"shipping_address column not available - migration not applied\",\r\n        );\r\n        return res.status(500).json({\r\n          error:\r\n            \"Database migration not applied. The shipping_address column does not exist yet. Please contact administrator.\",\r\n        });\r\n      }\r\n\r\n      return res\r\n        .status(500)\r\n        .json({ error: \"Failed to update shipping address\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Shipping address updated successfully\",\r\n      order: data,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Update shipping address error:\", error);\r\n    const message =\r\n      error instanceof Error\r\n        ? error.message\r\n        : \"Failed to update shipping address\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Update order item option costs\r\n * Allows admins to edit the price of individual options for an order item\r\n */\r\nexport const handleUpdateOrderItemOptions: RequestHandler = async (\r\n  req,\r\n  res,\r\n) => {\r\n  try {\r\n    const { orderId, itemId, options } = req.body;\r\n\r\n    console.log(\"Update order item options - received:\", {\r\n      orderId,\r\n      itemId,\r\n      optionsCount: options?.length,\r\n    });\r\n\r\n    if (!orderId) {\r\n      console.error(\"Missing orderId in request body\");\r\n      return res.status(400).json({ error: \"Order ID is required\" });\r\n    }\r\n\r\n    if (!Array.isArray(options)) {\r\n      console.error(\"Options is not an array:\", typeof options);\r\n      return res.status(400).json({ error: \"Options must be an array\" });\r\n    }\r\n\r\n    // Convert orderId to number\r\n    const numOrderId =\r\n      typeof orderId === \"string\" ? parseInt(orderId, 10) : orderId;\r\n\r\n    console.log(\r\n      \"Fetching order_items with orderId:\",\r\n      numOrderId,\r\n      \"itemId:\",\r\n      itemId,\r\n    );\r\n\r\n    // Query the order_items table directly instead of through the orders relation\r\n    const { data: allItems, error: itemsError } = await supabase\r\n      .from(\"order_items\")\r\n      .select(\"*\")\r\n      .eq(\"order_id\", numOrderId);\r\n\r\n    console.log(\"Order items query:\", {\r\n      count: allItems?.length,\r\n      items: allItems?.map((i: any) => ({\r\n        id: i.id,\r\n        product_name: i.product_name,\r\n        optionsCount: i.options ? Object.keys(i.options).length : 0,\r\n      })),\r\n      error: itemsError,\r\n      itemsError: itemsError\r\n        ? {\r\n            message: itemsError.message,\r\n            code: itemsError.code,\r\n          }\r\n        : null,\r\n    });\r\n\r\n    if (itemsError) {\r\n      console.error(\"Error fetching order items:\", itemsError);\r\n      return res.status(500).json({\r\n        error: \"Failed to fetch order items\",\r\n        details: itemsError.message,\r\n      });\r\n    }\r\n\r\n    if (!allItems || allItems.length === 0) {\r\n      console.error(\"No items found for order:\", numOrderId);\r\n      return res.status(404).json({ error: \"No items found for this order\" });\r\n    }\r\n\r\n    // Find the item to update (by UUID ID or index)\r\n    let itemToUpdate = null;\r\n    let itemIndex = -1;\r\n\r\n    // First try to match by UUID\r\n    for (let i = 0; i < allItems.length; i++) {\r\n      const itemUuid = String(allItems[i].id).toLowerCase();\r\n      const searchId = String(itemId).toLowerCase();\r\n\r\n      if (itemUuid === searchId) {\r\n        itemToUpdate = allItems[i];\r\n        itemIndex = i;\r\n        console.log(\"Found item by UUID match at index:\", i);\r\n        break;\r\n      }\r\n    }\r\n\r\n    // If not found by UUID, try by array index\r\n    if (!itemToUpdate && !isNaN(Number(itemId))) {\r\n      const numItemId = Number(itemId);\r\n      if (numItemId >= 0 && numItemId < allItems.length) {\r\n        itemToUpdate = allItems[numItemId];\r\n        itemIndex = numItemId;\r\n        console.log(\"Found item by index match at:\", numItemId);\r\n      }\r\n    }\r\n\r\n    if (!itemToUpdate) {\r\n      console.error(\r\n        \"Item not found with ID:\",\r\n        itemId,\r\n        \"Available items:\",\r\n        allItems.map((i: any) => i.id),\r\n      );\r\n      return res.status(404).json({ error: \"Item not found in this order\" });\r\n    }\r\n\r\n    console.log(\"Found item to update at index:\", itemIndex);\r\n\r\n    // Update the options with new prices\r\n    let updatedOptions = itemToUpdate.options || {};\r\n\r\n    if (Array.isArray(updatedOptions)) {\r\n      updatedOptions = updatedOptions.map((opt: any, idx: number) => {\r\n        const newOption = options[idx];\r\n        if (newOption) {\r\n          return {\r\n            ...opt,\r\n            price: newOption.price || 0,\r\n            modifier_price: newOption.price || 0,\r\n          };\r\n        }\r\n        return opt;\r\n      });\r\n    } else if (typeof updatedOptions === \"object\") {\r\n      updatedOptions = Object.entries(updatedOptions).reduce(\r\n        (acc: any, [key, val]: [string, any], idx: number) => {\r\n          const newOption = options[idx];\r\n          acc[key] = newOption\r\n            ? {\r\n                ...(typeof val === \"object\" ? val : { value: val }),\r\n                price: newOption.price || 0,\r\n                modifier_price: newOption.price || 0,\r\n              }\r\n            : val;\r\n          return acc;\r\n        },\r\n        {},\r\n      );\r\n    }\r\n\r\n    // Update the item in Supabase\r\n    const { data: updatedItem, error: updateError } = await supabase\r\n      .from(\"order_items\")\r\n      .update({\r\n        options: updatedOptions,\r\n      })\r\n      .eq(\"id\", itemToUpdate.id)\r\n      .select()\r\n      .single();\r\n\r\n    if (updateError) {\r\n      console.error(\"Error updating order item:\", {\r\n        message: updateError.message,\r\n        code: updateError.code,\r\n        details: updateError.details,\r\n      });\r\n      return res.status(500).json({\r\n        error: \"Failed to update order item\",\r\n        details: updateError.message,\r\n      });\r\n    }\r\n\r\n    console.log(\"Successfully updated order item\");\r\n    res.json({\r\n      success: true,\r\n      message: \"Option costs updated successfully\",\r\n      item: updatedItem,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Update order item options error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to update option costs\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4983, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/order.router.ts"],"sourcesContent":["import { Router } from \"express\";\r\nimport { verifyToken, requireAdmin } from \"../middleware/auth\";\r\nimport {\r\n  handleGetOrders,\r\n  handleGetOrder,\r\n  handleCreateOrder,\r\n  handleGetPendingOrders,\r\n  handleGetOrderPublic,\r\n  handleGetOrderStatus,\r\n  handleVerifyOrderAccess,\r\n} from \"./orders\";\r\nimport {\r\n  handleGetOrderDetail,\r\n  handleUpdateOrderStatus,\r\n  handleGetAllAdminOrders,\r\n  handleGetAdminPendingOrders,\r\n  handleUpdateShippingAddress,\r\n  handleUpdateOrderItemOptions,\r\n  handleTestAdminOrders,\r\n  handleDebugOrders,\r\n} from \"./admin-orders\";\r\n\r\n/**\r\n * Order Routes - Customer, Admin, and Public order management\r\n *\r\n * Customer routes: /api/orders/* - require authentication\r\n * Admin routes: /api/admin/orders/* - require authentication + admin role\r\n * Public routes: /api/public/orders/* - no authentication (order tracking)\r\n */\r\nexport function createOrderRouter() {\r\n  const router = Router();\r\n\r\n  // ===== CUSTOMER ROUTES (Protected) =====\r\n  // GET /api/orders - Get customer's orders\r\n  router.get(\"/\", verifyToken, handleGetOrders);\r\n\r\n  // POST /api/orders - Create new order\r\n  router.post(\"/\", verifyToken, handleCreateOrder);\r\n\r\n  // GET /api/orders/:orderId - Get specific order details\r\n  router.get(\"/:orderId\", verifyToken, handleGetOrder);\r\n\r\n  // ===== ADMIN ROUTES (Protected - admin only) =====\r\n  // IMPORTANT: Specific routes MUST come before parameterized routes like /:orderId\r\n\r\n  // GET /api/admin/orders/test - Test admin orders endpoint\r\n  router.get(\"/test\", verifyToken, requireAdmin, handleTestAdminOrders);\r\n\r\n  // GET /api/admin/orders/debug - Debug orders (admin only)\r\n  router.get(\"/debug\", verifyToken, requireAdmin, handleDebugOrders);\r\n\r\n  // GET /api/admin/orders/pending - Get pending orders\r\n  router.get(\r\n    \"/pending\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetAdminPendingOrders,\r\n  );\r\n\r\n  // GET /api/admin/all-orders - Get all orders\r\n  router.get(\"/all\", verifyToken, requireAdmin, handleGetAllAdminOrders);\r\n\r\n  // POST /api/admin/update-order-item-options - Update order item options\r\n  router.post(\r\n    \"/update-item-options\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateOrderItemOptions,\r\n  );\r\n\r\n  // GET /api/admin/orders/:orderId - Get order details (admin)\r\n  router.get(\r\n    \"/:orderId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetOrderDetail,\r\n  );\r\n\r\n  // PUT /api/admin/orders/:orderId/status - Update order status\r\n  router.put(\r\n    \"/:orderId/status\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateOrderStatus,\r\n  );\r\n\r\n  // PUT /api/admin/orders/:orderId/shipping-address - Update shipping address\r\n  router.put(\r\n    \"/:orderId/shipping-address\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateShippingAddress,\r\n  );\r\n\r\n  return router;\r\n}\r\n\r\n/**\r\n * Public Order Routes - No authentication required\r\n * Used for guest order tracking and confirmation pages\r\n */\r\nexport function createPublicOrderRouter() {\r\n  const router = Router();\r\n\r\n  // GET /api/public/orders/:orderId - Get public order summary\r\n  router.get(\"/:orderId\", handleGetOrderPublic);\r\n\r\n  // POST /api/public/orders/verify - Verify order access with email/phone\r\n  router.post(\"/verify\", handleVerifyOrderAccess);\r\n\r\n  // GET /api/public/orders/status - Get order status by token\r\n  router.get(\"/status\", handleGetOrderStatus);\r\n\r\n  return router;\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AASA;;;;;;;;;;;AAkBO,SAAS;IACd,MAAM,SAAS,IAAA,+JAAM;IAErB,0CAA0C;IAC1C,0CAA0C;IAC1C,OAAO,GAAG,CAAC,KAAK,oIAAW,EAAE,sIAAe;IAE5C,sCAAsC;IACtC,OAAO,IAAI,CAAC,KAAK,oIAAW,EAAE,wIAAiB;IAE/C,wDAAwD;IACxD,OAAO,GAAG,CAAC,aAAa,oIAAW,EAAE,qIAAc;IAEnD,oDAAoD;IACpD,kFAAkF;IAElF,0DAA0D;IAC1D,OAAO,GAAG,CAAC,SAAS,oIAAW,EAAE,qIAAY,EAAE,qJAAqB;IAEpE,0DAA0D;IAC1D,OAAO,GAAG,CAAC,UAAU,oIAAW,EAAE,qIAAY,EAAE,iJAAiB;IAEjE,qDAAqD;IACrD,OAAO,GAAG,CACR,YACA,oIAAW,EACX,qIAAY,EACZ,2JAA2B;IAG7B,6CAA6C;IAC7C,OAAO,GAAG,CAAC,QAAQ,oIAAW,EAAE,qIAAY,EAAE,uJAAuB;IAErE,wEAAwE;IACxE,OAAO,IAAI,CACT,wBACA,oIAAW,EACX,qIAAY,EACZ,4JAA4B;IAG9B,6DAA6D;IAC7D,OAAO,GAAG,CACR,aACA,oIAAW,EACX,qIAAY,EACZ,oJAAoB;IAGtB,8DAA8D;IAC9D,OAAO,GAAG,CACR,oBACA,oIAAW,EACX,qIAAY,EACZ,uJAAuB;IAGzB,4EAA4E;IAC5E,OAAO,GAAG,CACR,8BACA,oIAAW,EACX,qIAAY,EACZ,2JAA2B;IAG7B,OAAO;AACT;AAMO,SAAS;IACd,MAAM,SAAS,IAAA,+JAAM;IAErB,6DAA6D;IAC7D,OAAO,GAAG,CAAC,aAAa,2IAAoB;IAE5C,wEAAwE;IACxE,OAAO,IAAI,CAAC,WAAW,8IAAuB;IAE9C,4DAA4D;IAC5D,OAAO,GAAG,CAAC,WAAW,2IAAoB;IAE1C,OAAO;AACT"}},
    {"offset": {"line": 5047, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/products.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { ecwidAPI } from \"../utils/ecwid\";\r\n\r\nexport const handleGetProduct: RequestHandler = async (req, res) => {\r\n  const { productId } = req.params;\r\n\r\n  if (!productId) {\r\n    return res.status(400).json({ error: \"Product ID is required\" });\r\n  }\r\n\r\n  try {\r\n    const product = await ecwidAPI.getProductWithVariations(\r\n      parseInt(productId, 10),\r\n    );\r\n\r\n    if (!product) {\r\n      return res.status(404).json({ error: \"Product not found\" });\r\n    }\r\n\r\n    res.json({ data: product });\r\n  } catch (error) {\r\n    console.error(\"Get product error:\", error);\r\n    res.status(500).json({\r\n      error: error instanceof Error ? error.message : \"Failed to get product\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleGetProductOptions: RequestHandler = async (req, res) => {\r\n  const { productId } = req.params;\r\n\r\n  if (!productId) {\r\n    return res.status(400).json({ error: \"Product ID is required\" });\r\n  }\r\n\r\n  try {\r\n    const variations = await ecwidAPI.getProductVariations(\r\n      parseInt(productId, 10),\r\n    );\r\n\r\n    res.json({ data: variations });\r\n  } catch (error) {\r\n    console.error(\"Get product options error:\", error);\r\n    res.status(500).json({\r\n      error:\r\n        error instanceof Error\r\n          ? error.message\r\n          : \"Failed to get product options\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;;;AACA;;AAEO,MAAM,mBAAmC,OAAO,KAAK;IAC1D,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,MAAM;IAEhC,IAAI,CAAC,WAAW;QACd,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAyB;IAChE;IAEA,IAAI;QACF,MAAM,UAAU,MAAM,6HAAQ,CAAC,wBAAwB,CACrD,SAAS,WAAW;QAGtB,IAAI,CAAC,SAAS;YACZ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAoB;QAC3D;QAEA,IAAI,IAAI,CAAC;YAAE,MAAM;QAAQ;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sBAAsB;QACpC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAClD;IACF;AACF;AAEO,MAAM,0BAA0C,OAAO,KAAK;IACjE,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,MAAM;IAEhC,IAAI,CAAC,WAAW;QACd,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAyB;IAChE;IAEA,IAAI;QACF,MAAM,aAAa,MAAM,6HAAQ,CAAC,oBAAoB,CACpD,SAAS,WAAW;QAGtB,IAAI,IAAI,CAAC;YAAE,MAAM;QAAW;IAC9B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OACE,iBAAiB,QACb,MAAM,OAAO,GACb;QACR;IACF;AACF"}},
    {"offset": {"line": 5104, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/admin-products.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport {\r\n  CreateProductSchema,\r\n  UpdateProductSchema,\r\n  validate,\r\n} from \"../schemas/validation\";\r\n\r\nconst supabaseUrl = process.env.SUPABASE_URL || \"\";\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_KEY || \"\";\r\n\r\n/**\r\n * SECURITY: Service Role Key is required for this route\r\n *\r\n * Justification:\r\n * - Admin operations need to manage ALL products, not just their own\r\n * - RLS policies cannot enforce product ownership (products are shared admin resource)\r\n * - Alternative: Use scoped client would require complex RLS with admin exemptions\r\n *\r\n * Mitigation:\r\n * - All endpoints using this client have verifyToken + requireAdmin middleware\r\n * - All product operations are admin-only and audit logged\r\n * - No customer data is accessed (only shared product catalog)\r\n *\r\n * See: docs/RLS_SCOPING.md for security architecture\r\n */\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\ninterface ProductImage {\r\n  id: string;\r\n  url: string;\r\n  name: string;\r\n  preview?: string;\r\n}\r\n\r\ninterface VariantValue {\r\n  id: string;\r\n  name: string;\r\n  priceModifier: number;\r\n  image?: {\r\n    id: string;\r\n    url: string;\r\n    name: string;\r\n    preview?: string;\r\n  };\r\n}\r\n\r\ninterface ProductOption {\r\n  id: string;\r\n  name: string;\r\n  type: \"dropdown\" | \"swatch\" | \"radio\" | \"text\";\r\n  required: boolean;\r\n  values: VariantValue[];\r\n  defaultValueId?: string;\r\n  displayOrder: number;\r\n}\r\n\r\ninterface OptionSelection {\r\n  optionId: string;\r\n  optionName: string;\r\n  selectedValueIds: string[];\r\n}\r\n\r\ninterface SharedVariant {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  optionSelections: OptionSelection[];\r\n  price: number;\r\n}\r\n\r\ninterface PricingRule {\r\n  id: string;\r\n  conditions: { optionId: string; valueId: string }[];\r\n  price: number;\r\n}\r\n\r\ninterface CustomerUploadConfig {\r\n  enabled: boolean;\r\n  maxFileSize: number;\r\n  allowedFormats: string[];\r\n  description: string;\r\n}\r\n\r\ninterface TaxConfig {\r\n  id: string;\r\n  name: string;\r\n  rate: number;\r\n  enabled: boolean;\r\n}\r\n\r\ninterface ProductFormData {\r\n  name: string;\r\n  basePrice: number;\r\n  description: string;\r\n  sku: string;\r\n  weight: number;\r\n  images: ProductImage[];\r\n  options: ProductOption[];\r\n  pricingRules: PricingRule[];\r\n  sharedVariants: SharedVariant[];\r\n  customerUploadConfig: CustomerUploadConfig;\r\n  optionalFields: { name: string; type: string }[];\r\n  textArea: string;\r\n  uploadedFiles: { name: string; file: File }[];\r\n  conditionLogic: string;\r\n  taxes: TaxConfig[];\r\n  seo: {\r\n    productUrl: string;\r\n    pageTitle: string;\r\n    metaDescription: string;\r\n  };\r\n  categories: string[];\r\n  availability: boolean;\r\n  showQuantityPanel: boolean;\r\n  fixedQuantity: number | null;\r\n}\r\n\r\n/**\r\n * Create a new product in admin catalog\r\n * VALIDATION: All request fields validated against CreateProductSchema\r\n * SECURITY: Requires verifyToken + requireAdmin middleware\r\n */\r\nexport const handleCreateProduct: RequestHandler = async (req, res) => {\r\n  try {\r\n    // VALIDATION: Validate entire product request\r\n    const validationResult = await validate(CreateProductSchema, req.body);\r\n    if (!validationResult.success) {\r\n      return res.status(400).json({\r\n        error: \"Request validation failed\",\r\n        details: validationResult.errors,\r\n      });\r\n    }\r\n\r\n    const productData = validationResult.data;\r\n\r\n    // Build complete product object with all supported columns\r\n    const dbProduct: any = {\r\n      // Core fields\r\n      name: productData.name,\r\n      base_price: productData.basePrice || 0,\r\n      description: productData.description || \"\",\r\n      sku: productData.sku || \"\",\r\n      weight: productData.weight || 0,\r\n      availability: productData.availability !== false,\r\n      created_at: new Date().toISOString(),\r\n\r\n      // JSON fields\r\n      images: productData.images || [],\r\n      options: productData.options || [],\r\n      shared_variants: productData.sharedVariants || [],\r\n      pricing_rules: productData.pricingRules || [],\r\n      customer_upload_config: productData.customerUploadConfig || {\r\n        enabled: false,\r\n        maxFileSize: 5,\r\n        allowedFormats: [\"png\", \"jpg\", \"jpeg\", \"gif\"],\r\n        description: \"\",\r\n      },\r\n      optional_fields: productData.optionalFields || [],\r\n      categories: productData.categories || [],\r\n      taxes: productData.taxes || [],\r\n      seo: productData.seo || {\r\n        productUrl: \"\",\r\n        pageTitle: \"\",\r\n        metaDescription: \"\",\r\n      },\r\n\r\n      // Text fields\r\n      text_area: productData.textArea || \"\",\r\n      condition_logic: productData.conditionLogic || \"all\",\r\n\r\n      // Quantity panel settings\r\n      show_quantity_panel: productData.showQuantityPanel !== false,\r\n      fixed_quantity: productData.fixedQuantity || null,\r\n    };\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"admin_products\")\r\n      .insert([dbProduct])\r\n      .select();\r\n\r\n    if (error) {\r\n      console.error(\"Database error creating product:\", {\r\n        message: error.message,\r\n        code: error.code,\r\n        details: error.details,\r\n        hint: error.hint,\r\n      });\r\n      return res.status(500).json({\r\n        error: \"Failed to create product\",\r\n        details: error.message,\r\n        code: error.code,\r\n      });\r\n    }\r\n\r\n    res.json({\r\n      message: \"Product created successfully\",\r\n      product: data?.[0],\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error creating product:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to create product\",\r\n      details:\r\n        error instanceof Error ? error.message : \"Unknown error occurred\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Update an existing product in admin catalog\r\n * VALIDATION: All request fields validated against UpdateProductSchema\r\n * SECURITY: Requires verifyToken + requireAdmin middleware\r\n */\r\nexport const handleUpdateProduct: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { productId } = req.params;\r\n\r\n    // VALIDATION: Validate product ID\r\n    const id = parseInt(productId, 10);\r\n    if (isNaN(id) || id <= 0) {\r\n      return res.status(400).json({\r\n        error: \"Request validation failed\",\r\n        details: [\r\n          {\r\n            field: \"productId\",\r\n            message: \"Product ID must be a positive integer\",\r\n          },\r\n        ],\r\n      });\r\n    }\r\n\r\n    // VALIDATION: Validate entire product request\r\n    const validationResult = await validate(UpdateProductSchema, req.body);\r\n    if (!validationResult.success) {\r\n      return res.status(400).json({\r\n        error: \"Request validation failed\",\r\n        details: validationResult.errors,\r\n      });\r\n    }\r\n\r\n    const productData = validationResult.data;\r\n\r\n    // Build complete product object with all supported columns\r\n    const dbProduct: any = {\r\n      // Core fields\r\n      name: productData.name,\r\n      base_price: productData.basePrice || 0,\r\n      description: productData.description || \"\",\r\n      sku: productData.sku || \"\",\r\n      weight: productData.weight || 0,\r\n      availability: productData.availability !== false,\r\n      updated_at: new Date().toISOString(),\r\n\r\n      // JSON fields\r\n      images: productData.images || [],\r\n      options: productData.options || [],\r\n      shared_variants: productData.sharedVariants || [],\r\n      pricing_rules: productData.pricingRules || [],\r\n      customer_upload_config: productData.customerUploadConfig || {\r\n        enabled: false,\r\n        maxFileSize: 5,\r\n        allowedFormats: [\"png\", \"jpg\", \"jpeg\", \"gif\"],\r\n        description: \"\",\r\n      },\r\n      optional_fields: productData.optionalFields || [],\r\n      categories: productData.categories || [],\r\n      taxes: productData.taxes || [],\r\n      seo: productData.seo || {\r\n        productUrl: \"\",\r\n        pageTitle: \"\",\r\n        metaDescription: \"\",\r\n      },\r\n\r\n      // Text fields\r\n      text_area: productData.textArea || \"\",\r\n      condition_logic: productData.conditionLogic || \"all\",\r\n\r\n      // Quantity panel settings\r\n      show_quantity_panel: productData.showQuantityPanel !== false,\r\n      fixed_quantity: productData.fixedQuantity || null,\r\n    };\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"admin_products\")\r\n      .update(dbProduct)\r\n      .eq(\"id\", id)\r\n      .select();\r\n\r\n    if (error) {\r\n      console.error(\"Database error updating product:\", {\r\n        message: error.message,\r\n        code: error.code,\r\n        details: error.details,\r\n        hint: error.hint,\r\n        productId: id,\r\n      });\r\n      return res.status(500).json({\r\n        error: \"Failed to update product\",\r\n        details: error.message,\r\n        code: error.code,\r\n      });\r\n    }\r\n\r\n    if (!data || data.length === 0) {\r\n      return res.status(404).json({ error: \"Product not found\" });\r\n    }\r\n\r\n    const product = {\r\n      ...data[0],\r\n      show_quantity_panel: data[0].show_quantity_panel !== false ? true : false,\r\n      fixed_quantity: data[0].fixed_quantity ?? null,\r\n    };\r\n\r\n    res.json({\r\n      message: \"Product updated successfully\",\r\n      product,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error updating product:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to update product\",\r\n      details:\r\n        error instanceof Error ? error.message : \"Unknown error occurred\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleGetAdminProducts: RequestHandler = async (_req, res) => {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"admin_products\")\r\n      .select(\r\n        \"id, name, base_price, description, images, options, shared_variants, customer_upload_config, optional_fields, availability, sku, created_at, updated_at, show_quantity_panel, fixed_quantity\",\r\n      )\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) {\r\n      console.error(\"Database error:\", error);\r\n      return res\r\n        .status(500)\r\n        .json({ error: \"Failed to fetch products\", details: error.message });\r\n    }\r\n\r\n    const products = (data || []).map((product) => ({\r\n      ...product,\r\n      show_quantity_panel: product.show_quantity_panel !== false ? true : false,\r\n      fixed_quantity: product.fixed_quantity ?? null,\r\n    }));\r\n\r\n    res.json({ products });\r\n  } catch (error) {\r\n    console.error(\"Error fetching products:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to fetch products\",\r\n      details:\r\n        error instanceof Error ? error.message : \"Unknown error occurred\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Get a single product by ID\r\n * VALIDATION: Product ID must be a positive integer\r\n */\r\nexport const handleGetAdminProduct: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { productId } = req.params;\r\n\r\n    // VALIDATION: Validate product ID\r\n    const id = parseInt(productId, 10);\r\n    if (isNaN(id) || id <= 0) {\r\n      return res.status(400).json({\r\n        error: \"Request validation failed\",\r\n        details: [\r\n          {\r\n            field: \"productId\",\r\n            message: \"Product ID must be a positive integer\",\r\n          },\r\n        ],\r\n      });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"admin_products\")\r\n      .select(\r\n        \"id, name, base_price, description, images, options, shared_variants, customer_upload_config, optional_fields, availability, sku, created_at, updated_at, show_quantity_panel, fixed_quantity\",\r\n      )\r\n      .eq(\"id\", id)\r\n      .single();\r\n\r\n    if (error) {\r\n      if (error.code === \"PGRST116\") {\r\n        return res.status(404).json({ error: \"Product not found\" });\r\n      }\r\n      console.error(\"Database error fetching admin product:\", {\r\n        message: error.message,\r\n        code: error.code,\r\n        details: error.details,\r\n        hint: error.hint,\r\n        productId: id,\r\n      });\r\n      return res.status(500).json({\r\n        error: \"Failed to fetch product\",\r\n        details: error.message,\r\n        code: error.code,\r\n      });\r\n    }\r\n\r\n    const product = {\r\n      ...data,\r\n      show_quantity_panel: data.show_quantity_panel !== false ? true : false,\r\n      fixed_quantity: data.fixed_quantity ?? null,\r\n    };\r\n\r\n    res.json({ product });\r\n  } catch (error) {\r\n    console.error(\"Error fetching product:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to fetch product\",\r\n      details:\r\n        error instanceof Error ? error.message : \"Unknown error occurred\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Delete a product by ID\r\n * VALIDATION: Product ID must be a positive integer\r\n */\r\nexport const handleDeleteAdminProduct: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { productId } = req.params;\r\n\r\n    // VALIDATION: Validate product ID\r\n    const id = parseInt(productId, 10);\r\n    if (isNaN(id) || id <= 0) {\r\n      return res.status(400).json({\r\n        error: \"Request validation failed\",\r\n        details: [\r\n          {\r\n            field: \"productId\",\r\n            message: \"Product ID must be a positive integer\",\r\n          },\r\n        ],\r\n      });\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from(\"admin_products\")\r\n      .delete()\r\n      .eq(\"id\", id);\r\n\r\n    if (error) {\r\n      console.error(\"Database error:\", error);\r\n      return res\r\n        .status(500)\r\n        .json({ error: \"Failed to delete product\", details: error.message });\r\n    }\r\n\r\n    res.json({ message: \"Product deleted successfully\" });\r\n  } catch (error) {\r\n    console.error(\"Error deleting product:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to delete product\",\r\n      details:\r\n        error instanceof Error ? error.message : \"Unknown error occurred\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleGetPublicProduct: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { productId } = req.params;\r\n\r\n    if (!productId) {\r\n      return res.status(400).json({ error: \"Product ID is required\" });\r\n    }\r\n\r\n    // Try parsing as numeric ID first\r\n    const numericId = parseInt(productId, 10);\r\n    let query = supabase\r\n      .from(\"admin_products\")\r\n      .select(\r\n        \"id, name, base_price, description, images, options, shared_variants, customer_upload_config, optional_fields, availability, created_at, updated_at, show_quantity_panel, fixed_quantity\",\r\n      )\r\n      .eq(\"availability\", true);\r\n\r\n    // Use numeric ID if valid, otherwise treat as SKU\r\n    if (!isNaN(numericId)) {\r\n      query = query.eq(\"id\", numericId);\r\n    } else {\r\n      query = query.eq(\"sku\", productId);\r\n    }\r\n\r\n    const { data, error } = await query.single();\r\n\r\n    if (error) {\r\n      if (error.code === \"PGRST116\") {\r\n        return res.status(404).json({ error: \"Product not found\" });\r\n      }\r\n      console.error(\"Database error fetching public product:\", {\r\n        message: error.message,\r\n        code: error.code,\r\n        details: error.details,\r\n        hint: error.hint,\r\n        productId: id,\r\n      });\r\n      return res.status(500).json({\r\n        error: \"Failed to fetch product\",\r\n        details: error.message,\r\n        code: error.code,\r\n      });\r\n    }\r\n\r\n    if (!data) {\r\n      return res\r\n        .status(404)\r\n        .json({ error: \"Product not found or not available\" });\r\n    }\r\n\r\n    // Ensure proper data types for JSON fields and set defaults for quantity panel settings\r\n    const product = {\r\n      ...data,\r\n      images: Array.isArray(data.images) ? data.images : [],\r\n      options: Array.isArray(data.options) ? data.options : [],\r\n      shared_variants: Array.isArray(data.shared_variants)\r\n        ? data.shared_variants\r\n        : [],\r\n      customer_upload_config:\r\n        typeof data.customer_upload_config === \"object\"\r\n          ? data.customer_upload_config\r\n          : {\r\n              enabled: false,\r\n              maxFileSize: 5,\r\n              allowedFormats: [\"pdf\", \"png\", \"jpg\"],\r\n              description: \"\",\r\n            },\r\n      optional_fields: Array.isArray(data.optional_fields)\r\n        ? data.optional_fields\r\n        : [],\r\n      show_quantity_panel: data.show_quantity_panel !== false ? true : false,\r\n      fixed_quantity: data.fixed_quantity ?? null,\r\n    };\r\n\r\n    res.json({ product });\r\n  } catch (error) {\r\n    console.error(\"Error fetching product:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to fetch product\",\r\n      details:\r\n        error instanceof Error ? error.message : \"Unknown error occurred\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleImportAdminProduct: RequestHandler = async (req, res) => {\r\n  try {\r\n    const {\r\n      name,\r\n      basePrice,\r\n      sku,\r\n      description,\r\n      images,\r\n      options,\r\n      categories,\r\n      availability,\r\n      customerUploadConfig,\r\n    } = req.body;\r\n\r\n    if (!name?.trim()) {\r\n      return res.status(400).json({ error: \"Product name is required\" });\r\n    }\r\n\r\n    const dbProduct: any = {\r\n      // Core fields\r\n      name,\r\n      base_price: basePrice || 0,\r\n      sku: sku || \"\",\r\n      description: description || \"\",\r\n      availability: availability !== false,\r\n      created_at: new Date().toISOString(),\r\n\r\n      // JSON fields\r\n      images: images || [],\r\n      options: options || [],\r\n      customer_upload_config: customerUploadConfig || {\r\n        enabled: false,\r\n        maxFileSize: 5,\r\n        allowedFormats: [\"png\", \"jpg\", \"jpeg\", \"gif\"],\r\n        description: \"\",\r\n      },\r\n      categories: categories || [],\r\n    };\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"admin_products\")\r\n      .insert([dbProduct])\r\n      .select();\r\n\r\n    if (error) {\r\n      console.error(\"Database error creating product:\", {\r\n        message: error.message,\r\n        code: error.code,\r\n        details: error.details,\r\n      });\r\n      return res.status(500).json({\r\n        error: \"Failed to create product\",\r\n        details: error.message,\r\n      });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      product: data?.[0],\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error importing product:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to import product\",\r\n      details:\r\n        error instanceof Error ? error.message : \"Unknown error occurred\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleGetAdminProductPublic: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    if (!id) {\r\n      return res.status(400).json({ error: \"Product ID is required\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"admin_products\")\r\n      .select(\r\n        \"id, name, base_price, description, images, options, shared_variants, customer_upload_config, optional_fields, availability, created_at, updated_at, show_quantity_panel, fixed_quantity\",\r\n      )\r\n      .eq(\"id\", parseInt(id))\r\n      .eq(\"availability\", true)\r\n      .single();\r\n\r\n    if (error) {\r\n      if (error.code === \"PGRST116\") {\r\n        return res.status(404).json({ error: \"Product not found\" });\r\n      }\r\n      console.error(\"Database error fetching admin product:\", error);\r\n      return res.status(500).json({ error: \"Failed to fetch product\" });\r\n    }\r\n\r\n    if (!data) {\r\n      return res\r\n        .status(404)\r\n        .json({ error: \"Product not found or not available\" });\r\n    }\r\n\r\n    res.json({\r\n      id: data.id,\r\n      name: data.name,\r\n      base_price: data.base_price,\r\n      description: data.description,\r\n      images: Array.isArray(data.images) ? data.images : [],\r\n      options: Array.isArray(data.options) ? data.options : [],\r\n      availability: data.availability,\r\n      show_quantity_panel: data.show_quantity_panel !== false ? true : false,\r\n      fixed_quantity: data.fixed_quantity ?? null,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching admin product:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to fetch product\",\r\n      details:\r\n        error instanceof Error ? error.message : \"Unknown error occurred\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleGetImportedProductPublic: RequestHandler = async (\r\n  req,\r\n  res,\r\n) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    if (!id) {\r\n      return res.status(400).json({ error: \"Product ID is required\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"products\")\r\n      .select(\r\n        \"id, name, price, min_price, max_price, description, image_url, options, rating, reviews_count\",\r\n      )\r\n      .eq(\"id\", parseInt(id))\r\n      .eq(\"is_active\", true)\r\n      .single();\r\n\r\n    if (error) {\r\n      if (error.code === \"PGRST116\") {\r\n        return res.status(404).json({ error: \"Product not found\" });\r\n      }\r\n      console.error(\"Database error fetching imported product:\", error);\r\n      return res.status(500).json({ error: \"Failed to fetch product\" });\r\n    }\r\n\r\n    if (!data) {\r\n      return res\r\n        .status(404)\r\n        .json({ error: \"Product not found or not available\" });\r\n    }\r\n\r\n    res.json({\r\n      id: data.id,\r\n      name: data.name,\r\n      price: data.price,\r\n      min_price: data.min_price,\r\n      max_price: data.max_price,\r\n      description: data.description,\r\n      image_url: data.image_url,\r\n      options: Array.isArray(data.options) ? data.options : [],\r\n      rating: data.rating,\r\n      reviews_count: data.reviews_count,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching imported product:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to fetch product\",\r\n      details:\r\n        error instanceof Error ? error.message : \"Unknown error occurred\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleGetStorefrontProducts: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { limit = 100, offset = 0 } = req.query;\r\n\r\n    // Fetch admin products (with group assignments)\r\n    const { data: adminProducts, error: adminError } = await supabase\r\n      .from(\"admin_products\")\r\n      .select(\"id, name, base_price, sku, images, categories, availability\")\r\n      .eq(\"availability\", true)\r\n      .order(\"created_at\", { ascending: false })\r\n      .range(\r\n        parseInt(offset as string) || 0,\r\n        (parseInt(offset as string) || 0) +\r\n          (parseInt(limit as string) || 100) -\r\n          1,\r\n      );\r\n\r\n    if (adminError) {\r\n      console.error(\"Error fetching admin products:\", adminError);\r\n      return res.status(500).json({ error: \"Failed to fetch admin products\" });\r\n    }\r\n\r\n    // Format admin products\r\n    const formattedAdminProducts = (adminProducts || []).map(\r\n      (product: any) => ({\r\n        id: `admin_${product.id}`,\r\n        name: product.name,\r\n        price: product.base_price || 0,\r\n        sku: product.sku || \"\",\r\n        image_url: product.images?.[0]?.url || null,\r\n        group: product.categories?.[0] || null,\r\n        source: \"admin\",\r\n        availability: product.availability,\r\n      }),\r\n    );\r\n\r\n    // Fetch imported products\r\n    const { data: importedProducts, error: importedError } = await supabase\r\n      .from(\"products\")\r\n      .select(\r\n        \"id, name, price, min_price, max_price, sku, image_url, rating, reviews_count\",\r\n      )\r\n      .eq(\"is_active\", true)\r\n      .order(\"created_at\", { ascending: false })\r\n      .range(\r\n        parseInt(offset as string) || 0,\r\n        (parseInt(offset as string) || 0) +\r\n          (parseInt(limit as string) || 100) -\r\n          1,\r\n      );\r\n\r\n    if (importedError) {\r\n      console.error(\"Error fetching imported products:\", importedError);\r\n      return res\r\n        .status(500)\r\n        .json({ error: \"Failed to fetch imported products\" });\r\n    }\r\n\r\n    // Format imported products\r\n    const formattedImportedProducts = (importedProducts || []).map(\r\n      (product: any) => ({\r\n        id: `imported_${product.id}`,\r\n        name: product.name,\r\n        price: product.min_price || product.price || 0,\r\n        min_price: product.min_price,\r\n        max_price: product.max_price,\r\n        sku: product.sku || \"\",\r\n        image_url: product.image_url || null,\r\n        group: null,\r\n        source: \"imported\",\r\n        rating: product.rating || 0,\r\n        reviews_count: product.reviews_count || 0,\r\n      }),\r\n    );\r\n\r\n    // Combine and return\r\n    const allProducts = [\r\n      ...formattedAdminProducts,\r\n      ...formattedImportedProducts,\r\n    ];\r\n\r\n    res.json({\r\n      items: allProducts,\r\n      count: allProducts.length,\r\n      limit: parseInt(limit as string) || 100,\r\n      offset: parseInt(offset as string) || 0,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error fetching storefront products:\", error);\r\n    res.status(500).json({\r\n      error:\r\n        error instanceof Error ? error.message : \"Failed to fetch products\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AACA;AACA;;;;;;;;AAMA,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY,IAAI;AAChD,MAAM,cAAc,QAAQ,GAAG,CAAC,oBAAoB,IAAI;AAExD;;;;;;;;;;;;;;CAcC,GACD,MAAM,WAAW,IAAA,2OAAY,EAAC,aAAa;AAiGpC,MAAM,sBAAsC,OAAO,KAAK;IAC7D,IAAI;QACF,8CAA8C;QAC9C,MAAM,mBAAmB,MAAM,IAAA,oIAAQ,EAAC,+IAAmB,EAAE,IAAI,IAAI;QACrE,IAAI,CAAC,iBAAiB,OAAO,EAAE;YAC7B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS,iBAAiB,MAAM;YAClC;QACF;QAEA,MAAM,cAAc,iBAAiB,IAAI;QAEzC,2DAA2D;QAC3D,MAAM,YAAiB;YACrB,cAAc;YACd,MAAM,YAAY,IAAI;YACtB,YAAY,YAAY,SAAS,IAAI;YACrC,aAAa,YAAY,WAAW,IAAI;YACxC,KAAK,YAAY,GAAG,IAAI;YACxB,QAAQ,YAAY,MAAM,IAAI;YAC9B,cAAc,YAAY,YAAY,KAAK;YAC3C,YAAY,IAAI,OAAO,WAAW;YAElC,cAAc;YACd,QAAQ,YAAY,MAAM,IAAI,EAAE;YAChC,SAAS,YAAY,OAAO,IAAI,EAAE;YAClC,iBAAiB,YAAY,cAAc,IAAI,EAAE;YACjD,eAAe,YAAY,YAAY,IAAI,EAAE;YAC7C,wBAAwB,YAAY,oBAAoB,IAAI;gBAC1D,SAAS;gBACT,aAAa;gBACb,gBAAgB;oBAAC;oBAAO;oBAAO;oBAAQ;iBAAM;gBAC7C,aAAa;YACf;YACA,iBAAiB,YAAY,cAAc,IAAI,EAAE;YACjD,YAAY,YAAY,UAAU,IAAI,EAAE;YACxC,OAAO,YAAY,KAAK,IAAI,EAAE;YAC9B,KAAK,YAAY,GAAG,IAAI;gBACtB,YAAY;gBACZ,WAAW;gBACX,iBAAiB;YACnB;YAEA,cAAc;YACd,WAAW,YAAY,QAAQ,IAAI;YACnC,iBAAiB,YAAY,cAAc,IAAI;YAE/C,0BAA0B;YAC1B,qBAAqB,YAAY,iBAAiB,KAAK;YACvD,gBAAgB,YAAY,aAAa,IAAI;QAC/C;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,kBACL,MAAM,CAAC;YAAC;SAAU,EAClB,MAAM;QAET,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,oCAAoC;gBAChD,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;gBAChB,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;YAClB;YACA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;YAClB;QACF;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,SAAS,MAAM,CAAC,EAAE;QACpB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SACE,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC7C;IACF;AACF;AAOO,MAAM,sBAAsC,OAAO,KAAK;IAC7D,IAAI;QACF,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,MAAM;QAEhC,kCAAkC;QAClC,MAAM,MAAK,SAAS,WAAW;QAC/B,IAAI,MAAM,QAAO,OAAM,GAAG;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS;oBACP;wBACE,OAAO;wBACP,SAAS;oBACX;iBACD;YACH;QACF;QAEA,8CAA8C;QAC9C,MAAM,mBAAmB,MAAM,IAAA,oIAAQ,EAAC,+IAAmB,EAAE,IAAI,IAAI;QACrE,IAAI,CAAC,iBAAiB,OAAO,EAAE;YAC7B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS,iBAAiB,MAAM;YAClC;QACF;QAEA,MAAM,cAAc,iBAAiB,IAAI;QAEzC,2DAA2D;QAC3D,MAAM,YAAiB;YACrB,cAAc;YACd,MAAM,YAAY,IAAI;YACtB,YAAY,YAAY,SAAS,IAAI;YACrC,aAAa,YAAY,WAAW,IAAI;YACxC,KAAK,YAAY,GAAG,IAAI;YACxB,QAAQ,YAAY,MAAM,IAAI;YAC9B,cAAc,YAAY,YAAY,KAAK;YAC3C,YAAY,IAAI,OAAO,WAAW;YAElC,cAAc;YACd,QAAQ,YAAY,MAAM,IAAI,EAAE;YAChC,SAAS,YAAY,OAAO,IAAI,EAAE;YAClC,iBAAiB,YAAY,cAAc,IAAI,EAAE;YACjD,eAAe,YAAY,YAAY,IAAI,EAAE;YAC7C,wBAAwB,YAAY,oBAAoB,IAAI;gBAC1D,SAAS;gBACT,aAAa;gBACb,gBAAgB;oBAAC;oBAAO;oBAAO;oBAAQ;iBAAM;gBAC7C,aAAa;YACf;YACA,iBAAiB,YAAY,cAAc,IAAI,EAAE;YACjD,YAAY,YAAY,UAAU,IAAI,EAAE;YACxC,OAAO,YAAY,KAAK,IAAI,EAAE;YAC9B,KAAK,YAAY,GAAG,IAAI;gBACtB,YAAY;gBACZ,WAAW;gBACX,iBAAiB;YACnB;YAEA,cAAc;YACd,WAAW,YAAY,QAAQ,IAAI;YACnC,iBAAiB,YAAY,cAAc,IAAI;YAE/C,0BAA0B;YAC1B,qBAAqB,YAAY,iBAAiB,KAAK;YACvD,gBAAgB,YAAY,aAAa,IAAI;QAC/C;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,kBACL,MAAM,CAAC,WACP,EAAE,CAAC,MAAM,KACT,MAAM;QAET,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,oCAAoC;gBAChD,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;gBAChB,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;gBAChB,WAAW;YACb;YACA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;YAClB;QACF;QAEA,IAAI,CAAC,QAAQ,KAAK,MAAM,KAAK,GAAG;YAC9B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAoB;QAC3D;QAEA,MAAM,UAAU;YACd,GAAG,IAAI,CAAC,EAAE;YACV,qBAAqB,IAAI,CAAC,EAAE,CAAC,mBAAmB,KAAK,QAAQ,OAAO;YACpE,gBAAgB,IAAI,CAAC,EAAE,CAAC,cAAc,IAAI;QAC5C;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SACE,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC7C;IACF;AACF;AAEO,MAAM,yBAAyC,OAAO,MAAM;IACjE,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,kBACL,MAAM,CACL,gMAED,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM;QAE1C,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,mBAAmB;YACjC,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBAAE,OAAO;gBAA4B,SAAS,MAAM,OAAO;YAAC;QACtE;QAEA,MAAM,WAAW,CAAC,QAAQ,EAAE,EAAE,GAAG,CAAC,CAAC,UAAY,CAAC;gBAC9C,GAAG,OAAO;gBACV,qBAAqB,QAAQ,mBAAmB,KAAK,QAAQ,OAAO;gBACpE,gBAAgB,QAAQ,cAAc,IAAI;YAC5C,CAAC;QAED,IAAI,IAAI,CAAC;YAAE;QAAS;IACtB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SACE,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC7C;IACF;AACF;AAMO,MAAM,wBAAwC,OAAO,KAAK;IAC/D,IAAI;QACF,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,MAAM;QAEhC,kCAAkC;QAClC,MAAM,MAAK,SAAS,WAAW;QAC/B,IAAI,MAAM,QAAO,OAAM,GAAG;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS;oBACP;wBACE,OAAO;wBACP,SAAS;oBACX;iBACD;YACH;QACF;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,kBACL,MAAM,CACL,gMAED,EAAE,CAAC,MAAM,KACT,MAAM;QAET,IAAI,OAAO;YACT,IAAI,MAAM,IAAI,KAAK,YAAY;gBAC7B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAoB;YAC3D;YACA,QAAQ,KAAK,CAAC,0CAA0C;gBACtD,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;gBAChB,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;gBAChB,WAAW;YACb;YACA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;YAClB;QACF;QAEA,MAAM,UAAU;YACd,GAAG,IAAI;YACP,qBAAqB,KAAK,mBAAmB,KAAK,QAAQ,OAAO;YACjE,gBAAgB,KAAK,cAAc,IAAI;QACzC;QAEA,IAAI,IAAI,CAAC;YAAE;QAAQ;IACrB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SACE,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC7C;IACF;AACF;AAMO,MAAM,2BAA2C,OAAO,KAAK;IAClE,IAAI;QACF,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,MAAM;QAEhC,kCAAkC;QAClC,MAAM,MAAK,SAAS,WAAW;QAC/B,IAAI,MAAM,QAAO,OAAM,GAAG;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS;oBACP;wBACE,OAAO;wBACP,SAAS;oBACX;iBACD;YACH;QACF;QAEA,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,kBACL,MAAM,GACN,EAAE,CAAC,MAAM;QAEZ,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,mBAAmB;YACjC,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBAAE,OAAO;gBAA4B,SAAS,MAAM,OAAO;YAAC;QACtE;QAEA,IAAI,IAAI,CAAC;YAAE,SAAS;QAA+B;IACrD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SACE,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC7C;IACF;AACF;AAEO,MAAM,yBAAyC,OAAO,KAAK;IAChE,IAAI;QACF,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,MAAM;QAEhC,IAAI,CAAC,WAAW;YACd,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,kCAAkC;QAClC,MAAM,YAAY,SAAS,WAAW;QACtC,IAAI,QAAQ,SACT,IAAI,CAAC,kBACL,MAAM,CACL,2LAED,EAAE,CAAC,gBAAgB;QAEtB,kDAAkD;QAClD,IAAI,CAAC,MAAM,YAAY;YACrB,QAAQ,MAAM,EAAE,CAAC,MAAM;QACzB,OAAO;YACL,QAAQ,MAAM,EAAE,CAAC,OAAO;QAC1B;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,MAAM,MAAM;QAE1C,IAAI,OAAO;YACT,IAAI,MAAM,IAAI,KAAK,YAAY;gBAC7B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAoB;YAC3D;YACA,QAAQ,KAAK,CAAC,2CAA2C;gBACvD,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;gBAChB,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;gBAChB,WAAW;YACb;YACA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;YAClB;QACF;QAEA,IAAI,CAAC,MAAM;YACT,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBAAE,OAAO;YAAqC;QACxD;QAEA,wFAAwF;QACxF,MAAM,UAAU;YACd,GAAG,IAAI;YACP,QAAQ,MAAM,OAAO,CAAC,KAAK,MAAM,IAAI,KAAK,MAAM,GAAG,EAAE;YACrD,SAAS,MAAM,OAAO,CAAC,KAAK,OAAO,IAAI,KAAK,OAAO,GAAG,EAAE;YACxD,iBAAiB,MAAM,OAAO,CAAC,KAAK,eAAe,IAC/C,KAAK,eAAe,GACpB,EAAE;YACN,wBACE,OAAO,KAAK,sBAAsB,KAAK,WACnC,KAAK,sBAAsB,GAC3B;gBACE,SAAS;gBACT,aAAa;gBACb,gBAAgB;oBAAC;oBAAO;oBAAO;iBAAM;gBACrC,aAAa;YACf;YACN,iBAAiB,MAAM,OAAO,CAAC,KAAK,eAAe,IAC/C,KAAK,eAAe,GACpB,EAAE;YACN,qBAAqB,KAAK,mBAAmB,KAAK,QAAQ,OAAO;YACjE,gBAAgB,KAAK,cAAc,IAAI;QACzC;QAEA,IAAI,IAAI,CAAC;YAAE;QAAQ;IACrB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SACE,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC7C;IACF;AACF;AAEO,MAAM,2BAA2C,OAAO,KAAK;IAClE,IAAI;QACF,MAAM,EACJ,IAAI,EACJ,SAAS,EACT,GAAG,EACH,WAAW,EACX,MAAM,EACN,OAAO,EACP,UAAU,EACV,YAAY,EACZ,oBAAoB,EACrB,GAAG,IAAI,IAAI;QAEZ,IAAI,CAAC,MAAM,QAAQ;YACjB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA2B;QAClE;QAEA,MAAM,YAAiB;YACrB,cAAc;YACd;YACA,YAAY,aAAa;YACzB,KAAK,OAAO;YACZ,aAAa,eAAe;YAC5B,cAAc,iBAAiB;YAC/B,YAAY,IAAI,OAAO,WAAW;YAElC,cAAc;YACd,QAAQ,UAAU,EAAE;YACpB,SAAS,WAAW,EAAE;YACtB,wBAAwB,wBAAwB;gBAC9C,SAAS;gBACT,aAAa;gBACb,gBAAgB;oBAAC;oBAAO;oBAAO;oBAAQ;iBAAM;gBAC7C,aAAa;YACf;YACA,YAAY,cAAc,EAAE;QAC9B;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,kBACL,MAAM,CAAC;YAAC;SAAU,EAClB,MAAM;QAET,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,oCAAoC;gBAChD,SAAS,MAAM,OAAO;gBACtB,MAAM,MAAM,IAAI;gBAChB,SAAS,MAAM,OAAO;YACxB;YACA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS,MAAM,OAAO;YACxB;QACF;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,SAAS,MAAM,CAAC,EAAE;QACpB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SACE,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC7C;IACF;AACF;AAEO,MAAM,8BAA8C,OAAO,KAAK;IACrE,IAAI;QACF,MAAM,EAAE,IAAA,GAAE,EAAE,GAAG,IAAI,MAAM;QAEzB,IAAI,CAAC,KAAI;YACP,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,kBACL,MAAM,CACL,2LAED,EAAE,CAAC,MAAM,SAAS,MAClB,EAAE,CAAC,gBAAgB,MACnB,MAAM;QAET,IAAI,OAAO;YACT,IAAI,MAAM,IAAI,KAAK,YAAY;gBAC7B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAoB;YAC3D;YACA,QAAQ,KAAK,CAAC,0CAA0C;YACxD,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA0B;QACjE;QAEA,IAAI,CAAC,MAAM;YACT,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBAAE,OAAO;YAAqC;QACxD;QAEA,IAAI,IAAI,CAAC;YACP,IAAI,KAAK,EAAE;YACX,MAAM,KAAK,IAAI;YACf,YAAY,KAAK,UAAU;YAC3B,aAAa,KAAK,WAAW;YAC7B,QAAQ,MAAM,OAAO,CAAC,KAAK,MAAM,IAAI,KAAK,MAAM,GAAG,EAAE;YACrD,SAAS,MAAM,OAAO,CAAC,KAAK,OAAO,IAAI,KAAK,OAAO,GAAG,EAAE;YACxD,cAAc,KAAK,YAAY;YAC/B,qBAAqB,KAAK,mBAAmB,KAAK,QAAQ,OAAO;YACjE,gBAAgB,KAAK,cAAc,IAAI;QACzC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SACE,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC7C;IACF;AACF;AAEO,MAAM,iCAAiD,OAC5D,KACA;IAEA,IAAI;QACF,MAAM,EAAE,IAAA,GAAE,EAAE,GAAG,IAAI,MAAM;QAEzB,IAAI,CAAC,KAAI;YACP,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,YACL,MAAM,CACL,iGAED,EAAE,CAAC,MAAM,SAAS,MAClB,EAAE,CAAC,aAAa,MAChB,MAAM;QAET,IAAI,OAAO;YACT,IAAI,MAAM,IAAI,KAAK,YAAY;gBAC7B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAoB;YAC3D;YACA,QAAQ,KAAK,CAAC,6CAA6C;YAC3D,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA0B;QACjE;QAEA,IAAI,CAAC,MAAM;YACT,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBAAE,OAAO;YAAqC;QACxD;QAEA,IAAI,IAAI,CAAC;YACP,IAAI,KAAK,EAAE;YACX,MAAM,KAAK,IAAI;YACf,OAAO,KAAK,KAAK;YACjB,WAAW,KAAK,SAAS;YACzB,WAAW,KAAK,SAAS;YACzB,aAAa,KAAK,WAAW;YAC7B,WAAW,KAAK,SAAS;YACzB,SAAS,MAAM,OAAO,CAAC,KAAK,OAAO,IAAI,KAAK,OAAO,GAAG,EAAE;YACxD,QAAQ,KAAK,MAAM;YACnB,eAAe,KAAK,aAAa;QACnC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oCAAoC;QAClD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SACE,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC7C;IACF;AACF;AAEO,MAAM,8BAA8C,OAAO,KAAK;IACrE,IAAI;QACF,MAAM,EAAE,QAAQ,GAAG,EAAE,SAAS,CAAC,EAAE,GAAG,IAAI,KAAK;QAE7C,gDAAgD;QAChD,MAAM,EAAE,MAAM,aAAa,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SACtD,IAAI,CAAC,kBACL,MAAM,CAAC,+DACP,EAAE,CAAC,gBAAgB,MACnB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CACJ,SAAS,WAAqB,GAC9B,CAAC,SAAS,WAAqB,CAAC,IAC9B,CAAC,SAAS,UAAoB,GAAG,IACjC;QAGN,IAAI,YAAY;YACd,QAAQ,KAAK,CAAC,kCAAkC;YAChD,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAiC;QACxE;QAEA,wBAAwB;QACxB,MAAM,yBAAyB,CAAC,iBAAiB,EAAE,EAAE,GAAG,CACtD,CAAC,UAAiB,CAAC;gBACjB,IAAI,CAAC,MAAM,EAAE,QAAQ,EAAE,EAAE;gBACzB,MAAM,QAAQ,IAAI;gBAClB,OAAO,QAAQ,UAAU,IAAI;gBAC7B,KAAK,QAAQ,GAAG,IAAI;gBACpB,WAAW,QAAQ,MAAM,EAAE,CAAC,EAAE,EAAE,OAAO;gBACvC,OAAO,QAAQ,UAAU,EAAE,CAAC,EAAE,IAAI;gBAClC,QAAQ;gBACR,cAAc,QAAQ,YAAY;YACpC,CAAC;QAGH,0BAA0B;QAC1B,MAAM,EAAE,MAAM,gBAAgB,EAAE,OAAO,aAAa,EAAE,GAAG,MAAM,SAC5D,IAAI,CAAC,YACL,MAAM,CACL,gFAED,EAAE,CAAC,aAAa,MAChB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CACJ,SAAS,WAAqB,GAC9B,CAAC,SAAS,WAAqB,CAAC,IAC9B,CAAC,SAAS,UAAoB,GAAG,IACjC;QAGN,IAAI,eAAe;YACjB,QAAQ,KAAK,CAAC,qCAAqC;YACnD,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBAAE,OAAO;YAAoC;QACvD;QAEA,2BAA2B;QAC3B,MAAM,4BAA4B,CAAC,oBAAoB,EAAE,EAAE,GAAG,CAC5D,CAAC,UAAiB,CAAC;gBACjB,IAAI,CAAC,SAAS,EAAE,QAAQ,EAAE,EAAE;gBAC5B,MAAM,QAAQ,IAAI;gBAClB,OAAO,QAAQ,SAAS,IAAI,QAAQ,KAAK,IAAI;gBAC7C,WAAW,QAAQ,SAAS;gBAC5B,WAAW,QAAQ,SAAS;gBAC5B,KAAK,QAAQ,GAAG,IAAI;gBACpB,WAAW,QAAQ,SAAS,IAAI;gBAChC,OAAO;gBACP,QAAQ;gBACR,QAAQ,QAAQ,MAAM,IAAI;gBAC1B,eAAe,QAAQ,aAAa,IAAI;YAC1C,CAAC;QAGH,qBAAqB;QACrB,MAAM,cAAc;eACf;eACA;SACJ;QAED,IAAI,IAAI,CAAC;YACP,OAAO;YACP,OAAO,YAAY,MAAM;YACzB,OAAO,SAAS,UAAoB;YACpC,QAAQ,SAAS,WAAqB;QACxC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uCAAuC;QACrD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OACE,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC7C;IACF;AACF"}},
    {"offset": {"line": 5743, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/product.router.ts"],"sourcesContent":["import { Router } from \"express\";\r\nimport { verifyToken, requireAdmin } from \"../middleware/auth\";\r\nimport { handleGetProduct, handleGetProductOptions } from \"./products\";\r\nimport {\r\n  handleCreateProduct,\r\n  handleUpdateProduct,\r\n  handleGetAdminProducts,\r\n  handleGetAdminProduct,\r\n  handleDeleteAdminProduct,\r\n  handleImportAdminProduct,\r\n  handleGetAdminProductPublic,\r\n  handleGetImportedProductPublic,\r\n  handleGetPublicProduct,\r\n  handleGetStorefrontProducts,\r\n} from \"./admin-products\";\r\n\r\n/**\r\n * Product Routes - Public product management and retrieval\r\n *\r\n * Mounted at: /api/products\r\n *\r\n * Public routes for fetching Ecwid products\r\n */\r\nexport function createProductRouter() {\r\n  const router = Router();\r\n\r\n  // GET /api/products/:productId - Get product details\r\n  router.get(\"/:productId\", handleGetProduct);\r\n\r\n  // GET /api/products/:productId/options - Get product options\r\n  router.get(\"/:productId/options\", handleGetProductOptions);\r\n\r\n  return router;\r\n}\r\n\r\n/**\r\n * Admin Product Routes - Create, update, delete products\r\n *\r\n * Mounted at: /api/admin/products\r\n * Requires: verifyToken + requireAdmin middleware\r\n */\r\nexport function createAdminProductRouter() {\r\n  const router = Router();\r\n\r\n  // POST /api/admin/products - Create product\r\n  router.post(\"/\", verifyToken, requireAdmin, handleCreateProduct);\r\n\r\n  // GET /api/admin/products - Get all admin products\r\n  router.get(\"/\", verifyToken, requireAdmin, handleGetAdminProducts);\r\n\r\n  // POST /api/admin/products/import - Import product\r\n  router.post(\"/import\", verifyToken, requireAdmin, handleImportAdminProduct);\r\n\r\n  // GET /api/admin/products/:productId - Get product (admin)\r\n  router.get(\"/:productId\", verifyToken, requireAdmin, handleGetAdminProduct);\r\n\r\n  // PUT /api/admin/products/:productId - Update product\r\n  router.put(\"/:productId\", verifyToken, requireAdmin, handleUpdateProduct);\r\n\r\n  // DELETE /api/admin/products/:productId - Delete product\r\n  router.delete(\r\n    \"/:productId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleDeleteAdminProduct,\r\n  );\r\n\r\n  return router;\r\n}\r\n\r\n/**\r\n * Public Product Display Routes - Customer-facing product pages\r\n *\r\n * Mounted at: /api/public/products\r\n * No authentication required\r\n */\r\nexport function createPublicProductRouter() {\r\n  const router = Router();\r\n\r\n  // GET /api/public/products/:productId - Get public product\r\n  router.get(\"/:productId\", handleGetPublicProduct);\r\n\r\n  // GET /api/public/products/admin/:id - Get admin product (public)\r\n  router.get(\"/admin/:id\", handleGetAdminProductPublic);\r\n\r\n  // GET /api/public/products/imported/:id - Get imported product (public)\r\n  router.get(\"/imported/:id\", handleGetImportedProductPublic);\r\n\r\n  return router;\r\n}\r\n\r\n/**\r\n * Storefront Products Router - Merged product listings\r\n *\r\n * Mounted at: /api/storefront\r\n * No authentication required\r\n */\r\nexport function createStorefrontRouter() {\r\n  const router = Router();\r\n\r\n  // GET /api/storefront/products - Get all storefront products (merged admin + imported)\r\n  router.get(\"/products\", handleGetStorefrontProducts);\r\n\r\n  return router;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;;;;;;;;;;AAoBO,SAAS;IACd,MAAM,SAAS,IAAA,+JAAM;IAErB,qDAAqD;IACrD,OAAO,GAAG,CAAC,eAAe,yIAAgB;IAE1C,6DAA6D;IAC7D,OAAO,GAAG,CAAC,uBAAuB,gJAAuB;IAEzD,OAAO;AACT;AAQO,SAAS;IACd,MAAM,SAAS,IAAA,+JAAM;IAErB,4CAA4C;IAC5C,OAAO,IAAI,CAAC,KAAK,oIAAW,EAAE,qIAAY,EAAE,qJAAmB;IAE/D,mDAAmD;IACnD,OAAO,GAAG,CAAC,KAAK,oIAAW,EAAE,qIAAY,EAAE,wJAAsB;IAEjE,mDAAmD;IACnD,OAAO,IAAI,CAAC,WAAW,oIAAW,EAAE,qIAAY,EAAE,0JAAwB;IAE1E,2DAA2D;IAC3D,OAAO,GAAG,CAAC,eAAe,oIAAW,EAAE,qIAAY,EAAE,uJAAqB;IAE1E,sDAAsD;IACtD,OAAO,GAAG,CAAC,eAAe,oIAAW,EAAE,qIAAY,EAAE,qJAAmB;IAExE,yDAAyD;IACzD,OAAO,MAAM,CACX,eACA,oIAAW,EACX,qIAAY,EACZ,0JAAwB;IAG1B,OAAO;AACT;AAQO,SAAS;IACd,MAAM,SAAS,IAAA,+JAAM;IAErB,2DAA2D;IAC3D,OAAO,GAAG,CAAC,eAAe,wJAAsB;IAEhD,kEAAkE;IAClE,OAAO,GAAG,CAAC,cAAc,6JAA2B;IAEpD,wEAAwE;IACxE,OAAO,GAAG,CAAC,iBAAiB,gKAA8B;IAE1D,OAAO;AACT;AAQO,SAAS;IACd,MAAM,SAAS,IAAA,+JAAM;IAErB,uFAAuF;IACvF,OAAO,GAAG,CAAC,aAAa,6JAA2B;IAEnD,OAAO;AACT"}},
    {"offset": {"line": 5813, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/designs.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { supabase } from \"../utils/supabase\";\r\nimport { v2 as cloudinary } from \"cloudinary\";\r\nimport { z } from \"zod\";\r\nimport { validate } from \"../schemas/validation\";\r\n\r\n// Configure Cloudinary\r\ncloudinary.config({\r\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\r\n  api_key: process.env.CLOUDINARY_API_KEY,\r\n  api_secret: process.env.CLOUDINARY_API_SECRET,\r\n});\r\n\r\n/**\r\n * Schema for design file upload requests\r\n * Validates file data format, size limits, and content type\r\n */\r\nconst UploadDesignRequestSchema = z.object({\r\n  fileData: z.string().min(1, \"File data is required\"),\r\n  fileName: z.string().min(1, \"File name is required\").max(255),\r\n  fileType: z.string().optional(),\r\n});\r\n\r\ninterface OrderDesign {\r\n  orderId: number;\r\n  orderDate: string;\r\n  orderStatus: string;\r\n  designs: Array<{\r\n    id: string;\r\n    name: string;\r\n    url?: string;\r\n    description?: string;\r\n    type: string;\r\n    size?: string;\r\n    createdAt?: string;\r\n  }>;\r\n}\r\n\r\n/**\r\n * Get all designs from customer's orders stored in Supabase\r\n * Requires: customerId in JWT token\r\n */\r\nexport const handleGetDesigns: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n\r\n    if (!customerId) {\r\n      return res.status(401).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Get all orders for the customer from Supabase\r\n    const { data: orders, error: ordersError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"id, customer_id, status, created_at\")\r\n      .eq(\"customer_id\", customerId)\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (ordersError) {\r\n      console.error(\"Failed to fetch orders from Supabase:\", ordersError);\r\n      return res.status(500).json({ error: \"Failed to fetch orders\" });\r\n    }\r\n\r\n    if (!orders || orders.length === 0) {\r\n      return res.json({\r\n        success: true,\r\n        designs: [],\r\n        totalOrders: 0,\r\n        ordersWithDesigns: 0,\r\n      });\r\n    }\r\n\r\n    const orderIds = orders.map((o) => o.id);\r\n\r\n    // Fetch both order items with designs and proofs in parallel\r\n    const [\r\n      { data: orderItems, error: itemsError },\r\n      { data: proofs, error: proofsError },\r\n    ] = await Promise.all([\r\n      supabase\r\n        .from(\"order_items\")\r\n        .select(\r\n          \"id, order_id, product_name, design_file_url, quantity, created_at\",\r\n        )\r\n        .in(\"order_id\", orderIds)\r\n        .not(\"design_file_url\", \"is\", null)\r\n        .order(\"created_at\", { ascending: false }),\r\n      supabase\r\n        .from(\"proofs\")\r\n        .select(\r\n          \"id, order_id, file_url, file_name, description, status, created_at\",\r\n        )\r\n        .eq(\"customer_id\", customerId)\r\n        .not(\"file_url\", \"is\", null)\r\n        .order(\"created_at\", { ascending: false }),\r\n    ]);\r\n\r\n    if (itemsError) {\r\n      console.error(\"Failed to fetch order items from Supabase:\", itemsError);\r\n      return res.status(500).json({ error: \"Failed to fetch designs\" });\r\n    }\r\n\r\n    if (proofsError) {\r\n      console.error(\"Failed to fetch proofs from Supabase:\", proofsError);\r\n      return res.status(500).json({ error: \"Failed to fetch proofs\" });\r\n    }\r\n\r\n    // Group designs by order\r\n    const designsByOrder: OrderDesign[] = [];\r\n    const ordersWithDesigns = new Set<number>();\r\n\r\n    // Add order items (uploaded designs)\r\n    if (orderItems && orderItems.length > 0) {\r\n      for (const item of orderItems) {\r\n        const order = orders.find((o) => o.id === item.order_id);\r\n        if (!order) continue;\r\n\r\n        ordersWithDesigns.add(item.order_id);\r\n\r\n        // Find or create the order design group\r\n        let orderDesignGroup = designsByOrder.find(\r\n          (og) => og.orderId === item.order_id,\r\n        );\r\n        if (!orderDesignGroup) {\r\n          orderDesignGroup = {\r\n            orderId: item.order_id,\r\n            orderDate: order.created_at || new Date().toISOString(),\r\n            orderStatus: order.status || \"processing\",\r\n            designs: [],\r\n          };\r\n          designsByOrder.push(orderDesignGroup);\r\n        }\r\n\r\n        // Add design to the order group\r\n        if (item.design_file_url) {\r\n          orderDesignGroup.designs.push({\r\n            id: `${item.order_id}-${item.id}`,\r\n            name: item.product_name || \"Design File\",\r\n            url: item.design_file_url,\r\n            description: `Design from order #${item.order_id}`,\r\n            type: \"design\",\r\n            size: item.quantity ? `Qty: ${item.quantity}` : undefined,\r\n            createdAt: item.created_at || order.created_at,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Add proofs (design approvals)\r\n    if (proofs && proofs.length > 0) {\r\n      for (const proof of proofs) {\r\n        const order = orders.find((o) => o.id === proof.order_id);\r\n        if (!order) continue;\r\n\r\n        ordersWithDesigns.add(proof.order_id);\r\n\r\n        // Find or create the order design group\r\n        let orderDesignGroup = designsByOrder.find(\r\n          (og) => og.orderId === proof.order_id,\r\n        );\r\n        if (!orderDesignGroup) {\r\n          orderDesignGroup = {\r\n            orderId: proof.order_id,\r\n            orderDate: order.created_at || new Date().toISOString(),\r\n            orderStatus: order.status || \"processing\",\r\n            designs: [],\r\n          };\r\n          designsByOrder.push(orderDesignGroup);\r\n        }\r\n\r\n        // Add proof to the order group\r\n        if (proof.file_url) {\r\n          const isDenied = proof.status === \"denied\";\r\n          orderDesignGroup.designs.push({\r\n            id: `proof-${proof.id}`,\r\n            name: proof.file_name || \"Design Proof\",\r\n            url: proof.file_url,\r\n            description: proof.description || \"Design proof for approval\",\r\n            type: isDenied ? \"proof_denied\" : \"proof\",\r\n            createdAt: proof.created_at || order.created_at,\r\n            approved: proof.status === \"approved\",\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Sort orders by date\r\n    designsByOrder.sort(\r\n      (a, b) =>\r\n        new Date(b.orderDate).getTime() - new Date(a.orderDate).getTime(),\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      designs: designsByOrder,\r\n      totalOrders: orders.length,\r\n      ordersWithDesigns: designsByOrder.length,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get designs error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to fetch designs\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Get designs for a specific order from Supabase\r\n * Requires: customerId in JWT token, orderId in params\r\n * VALIDATION: Order ID parameter validated as positive integer\r\n */\r\nexport const handleGetOrderDesigns: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n    const { orderId } = req.params;\r\n\r\n    if (!customerId) {\r\n      return res.status(401).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // VALIDATION: Validate orderId is a positive integer\r\n    const orderIdNum = parseInt(orderId, 10);\r\n    if (isNaN(orderIdNum) || orderIdNum <= 0) {\r\n      return res.status(400).json({\r\n        error: \"Request validation failed\",\r\n        details: [\r\n          { field: \"orderId\", message: \"Order ID must be a positive integer\" },\r\n        ],\r\n      });\r\n    }\r\n\r\n    // Get the order and verify it belongs to the customer\r\n    const { data: order, error: orderError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"id, customer_id, status, created_at\")\r\n      .eq(\"id\", orderIdNum)\r\n      .single();\r\n\r\n    if (orderError || !order) {\r\n      return res.status(404).json({ error: \"Order not found\" });\r\n    }\r\n\r\n    // Verify order belongs to customer\r\n    if (order.customer_id !== customerId) {\r\n      return res.status(403).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Get all order items with design files for this order\r\n    const { data: orderItems, error: itemsError } = await supabase\r\n      .from(\"order_items\")\r\n      .select(\"id, product_name, design_file_url, quantity, created_at\")\r\n      .eq(\"order_id\", orderIdNum)\r\n      .not(\"design_file_url\", \"is\", null);\r\n\r\n    if (itemsError) {\r\n      console.error(\"Failed to fetch order items:\", itemsError);\r\n      return res.status(500).json({ error: \"Failed to fetch designs\" });\r\n    }\r\n\r\n    const designs: OrderDesign[\"designs\"] = [];\r\n\r\n    if (orderItems && orderItems.length > 0) {\r\n      for (const item of orderItems) {\r\n        if (item.design_file_url) {\r\n          designs.push({\r\n            id: `${order.id}-${item.id}`,\r\n            name: item.product_name || \"Design File\",\r\n            url: item.design_file_url,\r\n            description: `Design from order #${order.id}`,\r\n            type: \"design\",\r\n            size: item.quantity ? `Qty: ${item.quantity}` : undefined,\r\n            createdAt: item.created_at || order.created_at,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      orderId: order.id,\r\n      orderDate: order.created_at || new Date().toISOString(),\r\n      orderStatus: order.status || \"processing\",\r\n      designs,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get order designs error:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch order designs\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Upload a design file to Cloudinary\r\n * Accepts base64-encoded file data and returns a secure cloud URL\r\n * Used during checkout to store customer artwork files\r\n *\r\n * VALIDATION: All request fields validated with Zod schemas\r\n * SECURITY NOTES:\r\n * - NEVER fallback to base64 data URLs when upload fails (prevents database bloat)\r\n * - File size limited to 50MB to prevent large payloads in database\r\n * - Cloudinary is required for file storage - no local fallback available\r\n */\r\nexport const handleUploadDesignFile: RequestHandler = async (req, res) => {\r\n  try {\r\n    // VALIDATION: Validate request body against schema\r\n    const validationResult = await validate(\r\n      UploadDesignRequestSchema,\r\n      req.body,\r\n    );\r\n    if (!validationResult.success) {\r\n      return res.status(400).json({\r\n        error: \"Request validation failed\",\r\n        details: validationResult.errors,\r\n      });\r\n    }\r\n\r\n    const { fileData, fileName, fileType } = validationResult.data;\r\n\r\n    // Validate file size (50MB max) BEFORE processing\r\n    let buffer: Buffer;\r\n    try {\r\n      buffer = Buffer.from(fileData, \"base64\");\r\n    } catch (e) {\r\n      return res.status(400).json({\r\n        error: \"Request validation failed\",\r\n        details: [{ field: \"fileData\", message: \"Invalid base64 file data\" }],\r\n      });\r\n    }\r\n\r\n    // Guard: Reject oversized files to prevent database bloat\r\n    const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB\r\n    if (buffer.length > MAX_FILE_SIZE) {\r\n      console.warn(\"File size validation failed:\", {\r\n        fileName,\r\n        attemptedSize: buffer.length,\r\n        maxSize: MAX_FILE_SIZE,\r\n      });\r\n      return res.status(413).json({\r\n        error: \"Request validation failed\",\r\n        details: [\r\n          {\r\n            field: \"fileData\",\r\n            message: `File size exceeds ${MAX_FILE_SIZE / 1024 / 1024}MB limit`,\r\n          },\r\n        ],\r\n      });\r\n    }\r\n\r\n    // Validate Cloudinary is configured\r\n    if (!process.env.CLOUDINARY_CLOUD_NAME) {\r\n      console.error(\"Cloudinary not configured - cannot process uploads\");\r\n      return res.status(503).json({\r\n        error: \"File upload service is temporarily unavailable\",\r\n      });\r\n    }\r\n\r\n    // Generate unique filename with timestamp\r\n    const timestamp = Date.now();\r\n    const randomId = Math.random().toString(36).substring(7);\r\n    const sanitizedFileName = fileName\r\n      .replace(/[^a-zA-Z0-9.-]/g, \"_\")\r\n      .substring(0, 100);\r\n    const publicId = `sticker-designs/${timestamp}-${randomId}`;\r\n\r\n    // Upload to Cloudinary (no fallback)\r\n    try {\r\n      const uploadResult = await new Promise<any>((resolve, reject) => {\r\n        const stream = cloudinary.uploader.upload_stream(\r\n          {\r\n            public_id: publicId,\r\n            resource_type: \"auto\",\r\n            folder: \"sticker-designs\",\r\n            tags: [\"design-upload\", \"customer\"],\r\n          },\r\n          (error, result) => {\r\n            if (error) reject(error);\r\n            else resolve(result);\r\n          },\r\n        );\r\n\r\n        stream.end(buffer);\r\n      });\r\n\r\n      if (!uploadResult?.secure_url) {\r\n        console.error(\"Cloudinary upload failed - no URL returned:\", {\r\n          fileName,\r\n          publicId,\r\n        });\r\n        return res.status(502).json({\r\n          error: \"Failed to upload design file to cloud storage\",\r\n          details:\r\n            process.env.NODE_ENV === \"development\"\r\n              ? \"Cloudinary did not return a valid URL\"\r\n              : undefined,\r\n        });\r\n      }\r\n\r\n      console.log(\"Design file uploaded successfully to Cloudinary:\", {\r\n        fileName,\r\n        publicId,\r\n        url: uploadResult.secure_url,\r\n        size: buffer.length,\r\n      });\r\n\r\n      // Success response\r\n      res.status(200).json({\r\n        success: true,\r\n        fileUrl: uploadResult.secure_url,\r\n        fileName: sanitizedFileName,\r\n        size: buffer.length,\r\n        uploadedAt: new Date().toISOString(),\r\n      });\r\n    } catch (uploadError) {\r\n      // Log the error for debugging but don't expose internals\r\n      console.error(\"Cloudinary upload error:\", {\r\n        fileName,\r\n        error:\r\n          uploadError instanceof Error\r\n            ? uploadError.message\r\n            : String(uploadError),\r\n      });\r\n\r\n      // Return error - NO fallback to base64 data URLs\r\n      // Client must retry or handle the failure gracefully\r\n      return res.status(502).json({\r\n        error: \"Failed to upload design file to cloud storage\",\r\n        details:\r\n          process.env.NODE_ENV === \"development\"\r\n            ? \"Check that Cloudinary credentials are configured correctly\"\r\n            : undefined,\r\n        code: \"CLOUDINARY_UPLOAD_FAILED\",\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Upload design file error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to upload design\";\r\n    res.status(500).json({\r\n      error: message,\r\n      code: \"DESIGN_UPLOAD_ERROR\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6179, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/cart.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { randomUUID } from \"crypto\";\r\nimport { supabase } from \"../utils/supabase\";\r\n\r\n/**\r\n * Validate UUID format (v4 and general UUID)\r\n * Matches format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\r\n */\r\nfunction isValidUUID(uuid: string): boolean {\r\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n  return uuidRegex.test(uuid);\r\n}\r\n\r\ninterface CartItem {\r\n  product_id: number;\r\n  quantity: number;\r\n  price?: number;\r\n  product_name?: string;\r\n  product_options?: Array<{\r\n    option_id: number;\r\n    option_value: string;\r\n  }>;\r\n}\r\n\r\ninterface Cart {\r\n  id: string;\r\n  line_items: CartItem[];\r\n  created_at: string;\r\n  updated_at: string;\r\n  subtotal: number;\r\n  total: number;\r\n}\r\n\r\n/**\r\n * Create a new cart\r\n */\r\nexport const handleCreateCart: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { line_items = [] } = req.body;\r\n\r\n    const cartId = randomUUID();\r\n    const now = new Date().toISOString();\r\n\r\n    const subtotal = calculateSubtotal(line_items);\r\n    const cart = {\r\n      id: cartId,\r\n      line_items: line_items || [],\r\n      subtotal,\r\n      total: subtotal,\r\n      created_at: now,\r\n      updated_at: now,\r\n    };\r\n\r\n    const { error } = await supabase.from(\"carts\").insert({\r\n      id: cartId,\r\n      line_items,\r\n      subtotal,\r\n      total: subtotal,\r\n      created_at: now,\r\n      updated_at: now,\r\n    });\r\n\r\n    if (error) {\r\n      console.error(\"Create cart error:\", error);\r\n      throw error;\r\n    }\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      data: cart,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Create cart error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to create cart\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Get cart by ID\r\n */\r\nexport const handleGetCart: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { cartId } = req.params;\r\n\r\n    if (!cartId) {\r\n      console.error(\"Cart ID is required\");\r\n      return res.status(400).json({ error: \"Cart ID is required\" });\r\n    }\r\n\r\n    if (!isValidUUID(cartId)) {\r\n      console.error(\"Invalid cart ID format:\", cartId);\r\n      return res.status(400).json({ error: \"Invalid cart ID format\" });\r\n    }\r\n\r\n    console.log(\"Fetching cart:\", cartId);\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"carts\")\r\n      .select(\"*\")\r\n      .eq(\"id\", cartId)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error(\"Get cart error - Supabase error:\", {\r\n        code: error.code,\r\n        message: error.message,\r\n        details: error.details,\r\n        cartId,\r\n      });\r\n      if (error.code === \"PGRST116\") {\r\n        return res.status(404).json({ error: \"Cart not found\" });\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (!data) {\r\n      console.warn(\"Get cart - no data returned for cartId:\", cartId);\r\n      return res.status(404).json({ error: \"Cart not found\" });\r\n    }\r\n\r\n    console.log(\"Cart found successfully:\", cartId);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        id: data.id,\r\n        line_items: data.line_items || [],\r\n        subtotal: data.subtotal || 0,\r\n        total: data.total || 0,\r\n        created_at: data.created_at,\r\n        updated_at: data.updated_at,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get cart error - caught exception:\", {\r\n      message: error instanceof Error ? error.message : String(error),\r\n      error,\r\n    });\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to get cart\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Add items to cart\r\n */\r\nexport const handleAddToCart: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { cartId } = req.params;\r\n    const { line_items } = req.body;\r\n\r\n    if (!cartId) {\r\n      return res.status(400).json({ error: \"Cart ID is required\" });\r\n    }\r\n\r\n    if (!isValidUUID(cartId)) {\r\n      return res.status(400).json({ error: \"Invalid cart ID format\" });\r\n    }\r\n\r\n    if (!line_items || !Array.isArray(line_items)) {\r\n      return res.status(400).json({ error: \"line_items is required\" });\r\n    }\r\n\r\n    const { data: cart, error: fetchError } = await supabase\r\n      .from(\"carts\")\r\n      .select(\"*\")\r\n      .eq(\"id\", cartId)\r\n      .single();\r\n\r\n    if (fetchError) {\r\n      console.error(\"Fetch cart error:\", fetchError);\r\n      if (fetchError.code === \"PGRST116\") {\r\n        return res.status(404).json({ error: \"Cart not found\" });\r\n      }\r\n      throw fetchError;\r\n    }\r\n\r\n    if (!cart) {\r\n      return res.status(404).json({ error: \"Cart not found\" });\r\n    }\r\n\r\n    const updatedItems = [...(cart.line_items || []), ...line_items];\r\n    const subtotal = calculateSubtotal(updatedItems);\r\n    const now = new Date().toISOString();\r\n\r\n    const { error: updateError } = await supabase\r\n      .from(\"carts\")\r\n      .update({\r\n        line_items: updatedItems,\r\n        subtotal,\r\n        total: subtotal,\r\n        updated_at: now,\r\n      })\r\n      .eq(\"id\", cartId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Update cart error:\", updateError);\r\n      throw updateError;\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        id: cartId,\r\n        line_items: updatedItems,\r\n        subtotal,\r\n        total: subtotal,\r\n        created_at: cart.created_at,\r\n        updated_at: now,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Add to cart error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to add to cart\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Update cart item quantity\r\n */\r\nexport const handleUpdateCartItem: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { cartId, itemIndex } = req.params;\r\n    const { quantity } = req.body;\r\n\r\n    if (!cartId) {\r\n      return res.status(400).json({ error: \"Cart ID is required\" });\r\n    }\r\n\r\n    if (!isValidUUID(cartId)) {\r\n      return res.status(400).json({ error: \"Invalid cart ID format\" });\r\n    }\r\n\r\n    const { data: cart, error: fetchError } = await supabase\r\n      .from(\"carts\")\r\n      .select(\"*\")\r\n      .eq(\"id\", cartId)\r\n      .single();\r\n\r\n    if (fetchError) {\r\n      console.error(\"Fetch cart error:\", fetchError);\r\n      if (fetchError.code === \"PGRST116\") {\r\n        return res.status(404).json({ error: \"Cart not found\" });\r\n      }\r\n      throw fetchError;\r\n    }\r\n\r\n    if (!cart) {\r\n      return res.status(404).json({ error: \"Cart not found\" });\r\n    }\r\n\r\n    const idx = parseInt(itemIndex);\r\n    const items = cart.line_items || [];\r\n\r\n    if (isNaN(idx) || idx < 0 || idx >= items.length) {\r\n      return res.status(400).json({ error: \"Invalid item index\" });\r\n    }\r\n\r\n    if (quantity <= 0) {\r\n      items.splice(idx, 1);\r\n    } else {\r\n      items[idx].quantity = quantity;\r\n    }\r\n\r\n    const subtotal = calculateSubtotal(items);\r\n    const now = new Date().toISOString();\r\n\r\n    const { error: updateError } = await supabase\r\n      .from(\"carts\")\r\n      .update({\r\n        line_items: items,\r\n        subtotal,\r\n        total: subtotal,\r\n        updated_at: now,\r\n      })\r\n      .eq(\"id\", cartId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Update cart error:\", updateError);\r\n      throw updateError;\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        id: cartId,\r\n        line_items: items,\r\n        subtotal,\r\n        total: subtotal,\r\n        created_at: cart.created_at,\r\n        updated_at: now,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Update cart item error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to update cart item\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Remove item from cart\r\n */\r\nexport const handleRemoveFromCart: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { cartId, itemIndex } = req.params;\r\n\r\n    if (!cartId) {\r\n      return res.status(400).json({ error: \"Cart ID is required\" });\r\n    }\r\n\r\n    if (!isValidUUID(cartId)) {\r\n      return res.status(400).json({ error: \"Invalid cart ID format\" });\r\n    }\r\n\r\n    const { data: cart, error: fetchError } = await supabase\r\n      .from(\"carts\")\r\n      .select(\"*\")\r\n      .eq(\"id\", cartId)\r\n      .single();\r\n\r\n    if (fetchError) {\r\n      console.error(\"Fetch cart error:\", fetchError);\r\n      if (fetchError.code === \"PGRST116\") {\r\n        return res.status(404).json({ error: \"Cart not found\" });\r\n      }\r\n      throw fetchError;\r\n    }\r\n\r\n    if (!cart) {\r\n      return res.status(404).json({ error: \"Cart not found\" });\r\n    }\r\n\r\n    const idx = parseInt(itemIndex);\r\n    const items = cart.line_items || [];\r\n\r\n    if (isNaN(idx) || idx < 0 || idx >= items.length) {\r\n      return res.status(400).json({ error: \"Invalid item index\" });\r\n    }\r\n\r\n    items.splice(idx, 1);\r\n    const subtotal = calculateSubtotal(items);\r\n    const now = new Date().toISOString();\r\n\r\n    const { error: updateError } = await supabase\r\n      .from(\"carts\")\r\n      .update({\r\n        line_items: items,\r\n        subtotal,\r\n        total: subtotal,\r\n        updated_at: now,\r\n      })\r\n      .eq(\"id\", cartId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Update cart error:\", updateError);\r\n      throw updateError;\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        id: cartId,\r\n        line_items: items,\r\n        subtotal,\r\n        total: subtotal,\r\n        created_at: cart.created_at,\r\n        updated_at: now,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Remove from cart error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to remove from cart\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Clear cart\r\n */\r\nexport const handleClearCart: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { cartId } = req.params;\r\n\r\n    if (!cartId) {\r\n      return res.status(400).json({ error: \"Cart ID is required\" });\r\n    }\r\n\r\n    if (!isValidUUID(cartId)) {\r\n      return res.status(400).json({ error: \"Invalid cart ID format\" });\r\n    }\r\n\r\n    const { data: cart, error: fetchError } = await supabase\r\n      .from(\"carts\")\r\n      .select(\"*\")\r\n      .eq(\"id\", cartId)\r\n      .single();\r\n\r\n    if (fetchError) {\r\n      console.error(\"Fetch cart error:\", fetchError);\r\n      if (fetchError.code === \"PGRST116\") {\r\n        return res.status(404).json({ error: \"Cart not found\" });\r\n      }\r\n      throw fetchError;\r\n    }\r\n\r\n    if (!cart) {\r\n      return res.status(404).json({ error: \"Cart not found\" });\r\n    }\r\n\r\n    const now = new Date().toISOString();\r\n\r\n    const { error: updateError } = await supabase\r\n      .from(\"carts\")\r\n      .update({\r\n        line_items: [],\r\n        subtotal: 0,\r\n        total: 0,\r\n        updated_at: now,\r\n      })\r\n      .eq(\"id\", cartId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Update cart error:\", updateError);\r\n      throw updateError;\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        id: cartId,\r\n        line_items: [],\r\n        subtotal: 0,\r\n        total: 0,\r\n        created_at: cart.created_at,\r\n        updated_at: now,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Clear cart error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to clear cart\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Helper function to calculate subtotal\r\n */\r\nfunction calculateSubtotal(lineItems: CartItem[]): number {\r\n  return lineItems.reduce((total, item) => {\r\n    const itemPrice = item.price || 0.25;\r\n    return total + itemPrice * item.quantity;\r\n  }, 0);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AACA;AACA;;;;;;;AAEA;;;CAGC,GACD,SAAS,YAAY,IAAY;IAC/B,MAAM,YAAY;IAClB,OAAO,UAAU,IAAI,CAAC;AACxB;AAyBO,MAAM,mBAAmC,OAAO,KAAK;IAC1D,IAAI;QACF,MAAM,EAAE,aAAa,EAAE,EAAE,GAAG,IAAI,IAAI;QAEpC,MAAM,SAAS,IAAA,mHAAU;QACzB,MAAM,MAAM,IAAI,OAAO,WAAW;QAElC,MAAM,WAAW,kBAAkB;QACnC,MAAM,OAAO;YACX,IAAI;YACJ,YAAY,cAAc,EAAE;YAC5B;YACA,OAAO;YACP,YAAY;YACZ,YAAY;QACd;QAEA,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,gIAAQ,CAAC,IAAI,CAAC,SAAS,MAAM,CAAC;YACpD,IAAI;YACJ;YACA;YACA,OAAO;YACP,YAAY;YACZ,YAAY;QACd;QAEA,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,sBAAsB;YACpC,MAAM;QACR;QAEA,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,MAAM;QACR;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sBAAsB;QACpC,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAQ;IACxC;AACF;AAKO,MAAM,gBAAgC,OAAO,KAAK;IACvD,IAAI;QACF,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,MAAM;QAE7B,IAAI,CAAC,QAAQ;YACX,QAAQ,KAAK,CAAC;YACd,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAsB;QAC7D;QAEA,IAAI,CAAC,YAAY,SAAS;YACxB,QAAQ,KAAK,CAAC,2BAA2B;YACzC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,QAAQ,GAAG,CAAC,kBAAkB;QAE9B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,gIAAQ,CACnC,IAAI,CAAC,SACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,QACT,MAAM;QAET,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,oCAAoC;gBAChD,MAAM,MAAM,IAAI;gBAChB,SAAS,MAAM,OAAO;gBACtB,SAAS,MAAM,OAAO;gBACtB;YACF;YACA,IAAI,MAAM,IAAI,KAAK,YAAY;gBAC7B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAiB;YACxD;YACA,MAAM;QACR;QAEA,IAAI,CAAC,MAAM;YACT,QAAQ,IAAI,CAAC,2CAA2C;YACxD,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAiB;QACxD;QAEA,QAAQ,GAAG,CAAC,4BAA4B;QAExC,IAAI,IAAI,CAAC;YACP,SAAS;YACT,MAAM;gBACJ,IAAI,KAAK,EAAE;gBACX,YAAY,KAAK,UAAU,IAAI,EAAE;gBACjC,UAAU,KAAK,QAAQ,IAAI;gBAC3B,OAAO,KAAK,KAAK,IAAI;gBACrB,YAAY,KAAK,UAAU;gBAC3B,YAAY,KAAK,UAAU;YAC7B;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sCAAsC;YAClD,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;YACzD;QACF;QACA,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAQ;IACxC;AACF;AAKO,MAAM,kBAAkC,OAAO,KAAK;IACzD,IAAI;QACF,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,MAAM;QAC7B,MAAM,EAAE,UAAU,EAAE,GAAG,IAAI,IAAI;QAE/B,IAAI,CAAC,QAAQ;YACX,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAsB;QAC7D;QAEA,IAAI,CAAC,YAAY,SAAS;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,IAAI,CAAC,cAAc,CAAC,MAAM,OAAO,CAAC,aAAa;YAC7C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,MAAM,EAAE,MAAM,IAAI,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,gIAAQ,CACrD,IAAI,CAAC,SACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,QACT,MAAM;QAET,IAAI,YAAY;YACd,QAAQ,KAAK,CAAC,qBAAqB;YACnC,IAAI,WAAW,IAAI,KAAK,YAAY;gBAClC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAiB;YACxD;YACA,MAAM;QACR;QAEA,IAAI,CAAC,MAAM;YACT,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAiB;QACxD;QAEA,MAAM,eAAe;eAAK,KAAK,UAAU,IAAI,EAAE;eAAM;SAAW;QAChE,MAAM,WAAW,kBAAkB;QACnC,MAAM,MAAM,IAAI,OAAO,WAAW;QAElC,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,gIAAQ,CAC1C,IAAI,CAAC,SACL,MAAM,CAAC;YACN,YAAY;YACZ;YACA,OAAO;YACP,YAAY;QACd,GACC,EAAE,CAAC,MAAM;QAEZ,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,sBAAsB;YACpC,MAAM;QACR;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,MAAM;gBACJ,IAAI;gBACJ,YAAY;gBACZ;gBACA,OAAO;gBACP,YAAY,KAAK,UAAU;gBAC3B,YAAY;YACd;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sBAAsB;QACpC,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAQ;IACxC;AACF;AAKO,MAAM,uBAAuC,OAAO,KAAK;IAC9D,IAAI;QACF,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,MAAM;QACxC,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,IAAI;QAE7B,IAAI,CAAC,QAAQ;YACX,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAsB;QAC7D;QAEA,IAAI,CAAC,YAAY,SAAS;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,MAAM,EAAE,MAAM,IAAI,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,gIAAQ,CACrD,IAAI,CAAC,SACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,QACT,MAAM;QAET,IAAI,YAAY;YACd,QAAQ,KAAK,CAAC,qBAAqB;YACnC,IAAI,WAAW,IAAI,KAAK,YAAY;gBAClC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAiB;YACxD;YACA,MAAM;QACR;QAEA,IAAI,CAAC,MAAM;YACT,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAiB;QACxD;QAEA,MAAM,MAAM,SAAS;QACrB,MAAM,QAAQ,KAAK,UAAU,IAAI,EAAE;QAEnC,IAAI,MAAM,QAAQ,MAAM,KAAK,OAAO,MAAM,MAAM,EAAE;YAChD,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAqB;QAC5D;QAEA,IAAI,YAAY,GAAG;YACjB,MAAM,MAAM,CAAC,KAAK;QACpB,OAAO;YACL,KAAK,CAAC,IAAI,CAAC,QAAQ,GAAG;QACxB;QAEA,MAAM,WAAW,kBAAkB;QACnC,MAAM,MAAM,IAAI,OAAO,WAAW;QAElC,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,gIAAQ,CAC1C,IAAI,CAAC,SACL,MAAM,CAAC;YACN,YAAY;YACZ;YACA,OAAO;YACP,YAAY;QACd,GACC,EAAE,CAAC,MAAM;QAEZ,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,sBAAsB;YACpC,MAAM;QACR;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,MAAM;gBACJ,IAAI;gBACJ,YAAY;gBACZ;gBACA,OAAO;gBACP,YAAY,KAAK,UAAU;gBAC3B,YAAY;YACd;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAQ;IACxC;AACF;AAKO,MAAM,uBAAuC,OAAO,KAAK;IAC9D,IAAI;QACF,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,MAAM;QAExC,IAAI,CAAC,QAAQ;YACX,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAsB;QAC7D;QAEA,IAAI,CAAC,YAAY,SAAS;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,MAAM,EAAE,MAAM,IAAI,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,gIAAQ,CACrD,IAAI,CAAC,SACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,QACT,MAAM;QAET,IAAI,YAAY;YACd,QAAQ,KAAK,CAAC,qBAAqB;YACnC,IAAI,WAAW,IAAI,KAAK,YAAY;gBAClC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAiB;YACxD;YACA,MAAM;QACR;QAEA,IAAI,CAAC,MAAM;YACT,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAiB;QACxD;QAEA,MAAM,MAAM,SAAS;QACrB,MAAM,QAAQ,KAAK,UAAU,IAAI,EAAE;QAEnC,IAAI,MAAM,QAAQ,MAAM,KAAK,OAAO,MAAM,MAAM,EAAE;YAChD,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAqB;QAC5D;QAEA,MAAM,MAAM,CAAC,KAAK;QAClB,MAAM,WAAW,kBAAkB;QACnC,MAAM,MAAM,IAAI,OAAO,WAAW;QAElC,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,gIAAQ,CAC1C,IAAI,CAAC,SACL,MAAM,CAAC;YACN,YAAY;YACZ;YACA,OAAO;YACP,YAAY;QACd,GACC,EAAE,CAAC,MAAM;QAEZ,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,sBAAsB;YACpC,MAAM;QACR;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,MAAM;gBACJ,IAAI;gBACJ,YAAY;gBACZ;gBACA,OAAO;gBACP,YAAY,KAAK,UAAU;gBAC3B,YAAY;YACd;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAQ;IACxC;AACF;AAKO,MAAM,kBAAkC,OAAO,KAAK;IACzD,IAAI;QACF,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,MAAM;QAE7B,IAAI,CAAC,QAAQ;YACX,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAsB;QAC7D;QAEA,IAAI,CAAC,YAAY,SAAS;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,MAAM,EAAE,MAAM,IAAI,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,gIAAQ,CACrD,IAAI,CAAC,SACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,QACT,MAAM;QAET,IAAI,YAAY;YACd,QAAQ,KAAK,CAAC,qBAAqB;YACnC,IAAI,WAAW,IAAI,KAAK,YAAY;gBAClC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAiB;YACxD;YACA,MAAM;QACR;QAEA,IAAI,CAAC,MAAM;YACT,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAiB;QACxD;QAEA,MAAM,MAAM,IAAI,OAAO,WAAW;QAElC,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,gIAAQ,CAC1C,IAAI,CAAC,SACL,MAAM,CAAC;YACN,YAAY,EAAE;YACd,UAAU;YACV,OAAO;YACP,YAAY;QACd,GACC,EAAE,CAAC,MAAM;QAEZ,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,sBAAsB;YACpC,MAAM;QACR;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,MAAM;gBACJ,IAAI;gBACJ,YAAY,EAAE;gBACd,UAAU;gBACV,OAAO;gBACP,YAAY,KAAK,UAAU;gBAC3B,YAAY;YACd;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAQ;IACxC;AACF;AAEA;;CAEC,GACD,SAAS,kBAAkB,SAAqB;IAC9C,OAAO,UAAU,MAAM,CAAC,CAAC,OAAO;QAC9B,MAAM,YAAY,KAAK,KAAK,IAAI;QAChC,OAAO,QAAQ,YAAY,KAAK,QAAQ;IAC1C,GAAG;AACL"}},
    {"offset": {"line": 6587, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/checkout.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { z } from \"zod\";\r\nimport {\r\n  createSupabaseOrder,\r\n  createOrderItems,\r\n  getScopedSupabaseClient,\r\n  supabase,\r\n} from \"../utils/supabase\";\r\nimport { CheckoutSchema, validate } from \"../schemas/validation\";\r\n\r\n/**\r\n * Extended checkout schema with optional fields for backward compatibility\r\n * Allows extra fields from Ecwid/BigCommerce integrations\r\n */\r\nconst ExtendedCheckoutSchema = CheckoutSchema.extend({\r\n  order_total: z.number().optional(),\r\n  subtotal_inc_tax: z.number().optional(),\r\n  subtotal_ex_tax: z.number().optional(),\r\n  total_inc_tax: z.number().optional(),\r\n  total_ex_tax: z.number().optional(),\r\n  total_tax: z.number().optional(),\r\n  total_shipping: z.number().optional(),\r\n  status_id: z.number().optional(),\r\n  shipping_option_id: z.number().optional(),\r\n}).passthrough(); // Allow unknown fields from integrations\r\n\r\n/**\r\n * Create an order from checkout\r\n * Primary: Supabase (always succeeds)\r\n * Secondary: Ecwid (optional, errors are logged but don't fail the order)\r\n * VALIDATION: All request fields validated against schema before processing\r\n */\r\nexport const handleCheckout: RequestHandler = async (req, res) => {\r\n  try {\r\n    const requestCustomerId = (req as any).customerId;\r\n\r\n    // VALIDATION: Validate entire checkout request\r\n    // This replaces all manual if (!field) checks\r\n    const validationResult = await validate(ExtendedCheckoutSchema, req.body);\r\n    if (!validationResult.success) {\r\n      return res.status(400).json({\r\n        error: \"Request validation failed\",\r\n        details: validationResult.errors,\r\n      });\r\n    }\r\n\r\n    const checkoutData = validationResult.data;\r\n\r\n    // Use customer_id from request (auth) or from body (guest/provided), default to null for guests\r\n    const customerId = requestCustomerId || checkoutData.customer_id || null;\r\n\r\n    // At this point, all required fields are validated and present\r\n    const billingAddr = checkoutData.billing_address;\r\n    const shippingAddr = checkoutData.shipping_addresses[0];\r\n\r\n    // Calculate totals\r\n    const subtotal = checkoutData.subtotal_inc_tax || 0;\r\n    const total =\r\n      checkoutData.order_total || checkoutData.total_inc_tax || subtotal;\r\n    const tax = checkoutData.total_tax || 0;\r\n    const shipping = checkoutData.total_shipping || 0;\r\n\r\n    // Calculate estimated delivery date based on shipping option\r\n    let estimatedDeliveryDate: string | null = null;\r\n    if (checkoutData.shipping_option_id) {\r\n      try {\r\n        const { data: shippingOption } = await supabase\r\n          .from(\"shipping_options\")\r\n          .select(\"processing_time_days, estimated_delivery_days_min\")\r\n          .eq(\"id\", checkoutData.shipping_option_id)\r\n          .single();\r\n\r\n        if (shippingOption) {\r\n          const processingDays = shippingOption.processing_time_days || 0;\r\n          const deliveryDays = shippingOption.estimated_delivery_days_min || 1;\r\n          const totalDays = processingDays + deliveryDays;\r\n\r\n          const deliveryDate = new Date();\r\n          deliveryDate.setDate(deliveryDate.getDate() + totalDays);\r\n          estimatedDeliveryDate = deliveryDate.toISOString().split(\"T\")[0];\r\n        }\r\n      } catch (error) {\r\n        console.warn(\r\n          \"Failed to fetch shipping option for delivery date:\",\r\n          error,\r\n        );\r\n      }\r\n    }\r\n\r\n    // Create order in Supabase (PRIMARY - must succeed)\r\n    console.log(\"Creating order in Supabase:\", {\r\n      customerId,\r\n      total,\r\n      productCount: checkoutData.products.length,\r\n      estimatedDeliveryDate,\r\n    });\r\n\r\n    const supabaseOrder = await createSupabaseOrder({\r\n      customer_id: customerId,\r\n      status: \"pending\",\r\n      total,\r\n      subtotal,\r\n      tax,\r\n      shipping,\r\n      billing_address: billingAddr,\r\n      shipping_address: shippingAddr,\r\n      items: checkoutData.products,\r\n      estimated_delivery_date: estimatedDeliveryDate,\r\n    });\r\n\r\n    // Create order items in Supabase\r\n    if (supabaseOrder.success) {\r\n      const itemsWithPrices = checkoutData.products.map((item) => ({\r\n        product_id: item.product_id,\r\n        product_name: item.product_name || \"Custom Product\",\r\n        quantity: item.quantity,\r\n        price: item.price || item.price_inc_tax || 0.25,\r\n        design_file_url: item.design_file_url || null,\r\n        options: item.options || null,\r\n      }));\r\n      await createOrderItems(supabaseOrder.id, itemsWithPrices);\r\n    }\r\n\r\n    console.log(\"Order created successfully:\", {\r\n      supabaseId: supabaseOrder.id,\r\n    });\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      message: \"Order created successfully\",\r\n      data: {\r\n        id: supabaseOrder.id,\r\n        customer_id: customerId,\r\n        total,\r\n        status: \"pending\",\r\n        date_created: new Date().toISOString(),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Checkout error:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to create order\";\r\n    res.status(500).json({\r\n      error: errorMessage,\r\n      details:\r\n        process.env.NODE_ENV === \"development\" ? String(error) : undefined,\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Get checkout details (for validation/preview)\r\n */\r\nexport const handleGetCheckoutDetails: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { cartId } = req.params;\r\n\r\n    if (!cartId) {\r\n      return res.status(400).json({ error: \"Cart ID is required\" });\r\n    }\r\n\r\n    if (!isValidUUID(cartId)) {\r\n      return res.status(400).json({ error: \"Invalid cart ID format\" });\r\n    }\r\n\r\n    // This would typically fetch cart details and shipping estimates\r\n    // For now, return placeholder data\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        cart_id: cartId,\r\n        shipping_methods: [\r\n          {\r\n            id: \"standard\",\r\n            name: \"Standard Shipping\",\r\n            cost: 9.99,\r\n            estimated_days: \"5-7 business days\",\r\n          },\r\n          {\r\n            id: \"express\",\r\n            name: \"Express Shipping\",\r\n            cost: 19.99,\r\n            estimated_days: \"2-3 business days\",\r\n          },\r\n          {\r\n            id: \"overnight\",\r\n            name: \"Overnight Shipping\",\r\n            cost: 39.99,\r\n            estimated_days: \"Next business day\",\r\n          },\r\n        ],\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get checkout details error:\", error);\r\n    res.status(500).json({ error: \"Failed to get checkout details\" });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6768, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/store-credit.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL || \"\",\r\n  process.env.SUPABASE_SERVICE_KEY || \"\",\r\n);\r\n\r\ninterface AddCreditRequest {\r\n  customer_id: number;\r\n  amount: number;\r\n  reason: string;\r\n  notes?: string;\r\n}\r\n\r\ninterface GetCustomerCreditRequest {\r\n  customer_id: number;\r\n}\r\n\r\n/**\n * Get customer's store credit balance\n * SECURITY: Users can only access their own credit (unless admin)\n */\nexport const handleGetCustomerCredit: RequestHandler = async (req, res) => {\n  try {\n    const { customerId } = req.params;\n    const requestingCustomerId = (req as any).customerId;\n    const isAdmin = (req as any).isAdmin;\n\n    if (!customerId) {\n      return res.status(400).json({ error: \"Customer ID required\" });\n    }\n\n    // SECURITY: Verify user can only access their own data (unless admin)\n    if (parseInt(customerId) !== requestingCustomerId && !isAdmin) {\n      return res.status(403).json({ error: \"Unauthorized\" });\n    }\n\n    const { data: customer, error } = await supabase\n      .from(\"customers\")\n      .select(\"id, email, store_credit\")\n      .eq(\"id\", customerId)\n      .single();\n\n    if (error || !customer) {\n      return res.status(404).json({ error: \"Customer not found\" });\n    }\n\n    res.json({\n      success: true,\n      data: {\n        customer_id: customer.id,\n        email: customer.email,\n        balance: parseFloat(customer.store_credit || \"0\"),\n      },\n    });\n  } catch (error) {\n    console.error(\"Get customer credit error:\", error);\n    res.status(500).json({ error: \"Failed to get customer credit\" });\n  }\n};\n\r\n/**\r\n * Get all customers with their credit balances\r\n */\r\nexport const handleGetAllCustomersCredit: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { data: customers, error } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"id, email, first_name, last_name, store_credit, created_at\")\r\n      .order(\"store_credit\", { ascending: false });\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    const formattedCustomers = customers.map((c) => ({\r\n      id: c.id,\r\n      email: c.email,\r\n      name: `${c.first_name || \"\"} ${c.last_name || \"\"}`.trim(),\r\n      balance: parseFloat(c.store_credit || \"0\"),\r\n      created_at: c.created_at,\r\n    }));\r\n\r\n    res.json({\r\n      success: true,\r\n      data: formattedCustomers,\r\n      count: formattedCustomers.length,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get all customers credit error:\", error);\r\n    res.status(500).json({ error: \"Failed to get customers\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Add or subtract store credit\r\n */\r\nexport const handleModifyStoreCredit: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { customer_id, amount, reason, notes } = req.body as AddCreditRequest;\r\n    const adminId = (req as any).customerId;\r\n\r\n    if (!customer_id || amount === undefined || !reason) {\r\n      return res\r\n        .status(400)\r\n        .json({ error: \"Customer ID, amount, and reason are required\" });\r\n    }\r\n\r\n    if (isNaN(amount) || amount === 0) {\r\n      return res\r\n        .status(400)\r\n        .json({ error: \"Amount must be a non-zero number\" });\r\n    }\r\n\r\n    // Get current balance\r\n    const { data: customer, error: fetchError } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"store_credit\")\r\n      .eq(\"id\", customer_id)\r\n      .single();\r\n\r\n    if (fetchError || !customer) {\r\n      return res.status(404).json({ error: \"Customer not found\" });\r\n    }\r\n\r\n    const currentBalance = parseFloat(customer.store_credit || \"0\");\r\n    const newBalance = currentBalance + amount;\r\n\r\n    // Prevent negative balance\r\n    if (newBalance < 0) {\r\n      return res.status(400).json({\r\n        error: `Insufficient credit. Current balance: $${currentBalance.toFixed(2)}`,\r\n      });\r\n    }\r\n\r\n    // Update customer balance\r\n    const { error: updateError } = await supabase\r\n      .from(\"customers\")\r\n      .update({ store_credit: newBalance })\r\n      .eq(\"id\", customer_id);\r\n\r\n    if (updateError) {\r\n      throw updateError;\r\n    }\r\n\r\n    // Record transaction\r\n    const transactionType = amount > 0 ? \"add\" : \"subtract\";\r\n    const { error: transactionError } = await supabase\r\n      .from(\"store_credit_transactions\")\r\n      .insert({\r\n        customer_id,\r\n        amount,\r\n        transaction_type: transactionType,\r\n        reason,\r\n        admin_id: adminId,\r\n        notes,\r\n      });\r\n\r\n    if (transactionError) {\r\n      console.error(\"Transaction record error:\", transactionError);\r\n      // Don't fail the request if transaction logging fails\r\n    }\r\n\r\n    console.log(`Store credit updated for customer ${customer_id}:`, {\r\n      amount,\r\n      reason,\r\n      oldBalance: currentBalance,\r\n      newBalance,\r\n    });\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: `Credit ${amount > 0 ? \"added\" : \"removed\"} successfully`,\r\n      data: {\r\n        customer_id,\r\n        old_balance: currentBalance,\r\n        new_balance: newBalance,\r\n        amount,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Modify store credit error:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to modify store credit\";\r\n    res.status(500).json({ error: errorMessage });\r\n  }\r\n};\r\n\r\n/**\r\n * Get credit transaction history for a customer\r\n */\r\nexport const handleGetCreditHistory: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { customerId } = req.params;\r\n    const { limit = 50, offset = 0 } = req.query;\r\n\r\n    if (!customerId) {\r\n      return res.status(400).json({ error: \"Customer ID required\" });\r\n    }\r\n\r\n    const {\r\n      data: transactions,\r\n      error,\r\n      count,\r\n    } = await supabase\r\n      .from(\"store_credit_transactions\")\r\n      .select(\"*\", { count: \"exact\" })\r\n      .eq(\"customer_id\", customerId)\r\n      .order(\"created_at\", { ascending: false })\r\n      .range(Number(offset), Number(offset) + Number(limit) - 1);\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    const formattedTransactions = transactions.map((t) => ({\r\n      id: t.id,\r\n      amount: parseFloat(t.amount),\r\n      type: t.transaction_type,\r\n      reason: t.reason,\r\n      notes: t.notes,\r\n      order_id: t.order_id,\r\n      created_at: t.created_at,\r\n    }));\r\n\r\n    res.json({\r\n      success: true,\r\n      data: formattedTransactions,\r\n      pagination: {\r\n        limit: Number(limit),\r\n        offset: Number(offset),\r\n        total: count,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get credit history error:\", error);\r\n    res.status(500).json({ error: \"Failed to get credit history\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Apply store credit to an order (deduct from customer balance)\r\n */\r\nexport const handleApplyStoreCreditToOrder: RequestHandler = async (\r\n  req,\r\n  res,\r\n) => {\r\n  try {\r\n    const { customer_id, order_id, amount } = req.body;\r\n\r\n    if (!customer_id || !order_id || !amount) {\r\n      return res\r\n        .status(400)\r\n        .json({ error: \"Customer ID, order ID, and amount are required\" });\r\n    }\r\n\r\n    // Get current balance\r\n    const { data: customer, error: fetchError } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"store_credit\")\r\n      .eq(\"id\", customer_id)\r\n      .single();\r\n\r\n    if (fetchError || !customer) {\r\n      return res.status(404).json({ error: \"Customer not found\" });\r\n    }\r\n\r\n    const currentBalance = parseFloat(customer.store_credit || \"0\");\r\n\r\n    if (currentBalance < amount) {\r\n      return res.status(400).json({\r\n        error: \"Insufficient store credit\",\r\n        available: currentBalance,\r\n        requested: amount,\r\n      });\r\n    }\r\n\r\n    const newBalance = currentBalance - amount;\r\n\r\n    // Update customer balance\r\n    const { error: updateError } = await supabase\r\n      .from(\"customers\")\r\n      .update({ store_credit: newBalance })\r\n      .eq(\"id\", customer_id);\r\n\r\n    if (updateError) {\r\n      throw updateError;\r\n    }\r\n\r\n    // Record transaction\r\n    const { error: transactionError } = await supabase\r\n      .from(\"store_credit_transactions\")\r\n      .insert({\r\n        customer_id,\r\n        amount: -amount,\r\n        transaction_type: \"subtract\",\r\n        reason: \"Applied to order\",\r\n        order_id,\r\n      });\r\n\r\n    if (transactionError) {\r\n      console.error(\"Transaction record error:\", transactionError);\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Store credit applied to order\",\r\n      data: {\r\n        customer_id,\r\n        order_id,\r\n        amount_used: amount,\r\n        remaining_balance: newBalance,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Apply store credit error:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to apply store credit\";\r\n    res.status(500).json({ error: errorMessage });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7034, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/support.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { sendTicketCreationEmail, sendTicketReplyEmail } from \"../utils/email\";\r\n\r\nconst supabaseUrl = process.env.SUPABASE_URL || \"\";\r\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_KEY || \"\";\r\n\r\n/**\r\n * SECURITY: Service Role Key fallback for this route\r\n *\r\n * Justification:\r\n * - Support tickets are public submissions (don't require authentication)\r\n * - Guests can create tickets without login\r\n * - Admin endpoints require explicit verifyToken + requireAdmin middleware\r\n * - RLS policies can still protect customer tickets (customer_id based)\r\n *\r\n * Current Implementation:\r\n * - Falls back to anon key if SERVICE_KEY unavailable\r\n * - Public endpoints use this client for guest submissions\r\n * - Admin endpoints (admin replies) require authentication\r\n *\r\n * TODO: Refactor to use getScopedSupabaseClient for authenticated endpoints\r\n * See: docs/RLS_SCOPING.md for security architecture\r\n */\r\nconst supabase = createClient(\r\n  supabaseUrl,\r\n  supabaseServiceKey || process.env.SUPABASE_ANON_KEY || \"\",\r\n);\r\n\r\ninterface SupportSubmission {\r\n  name: string;\r\n  email: string;\r\n  subject: string;\r\n  category: string;\r\n  priority: string;\r\n  message: string;\r\n  customerId?: number;\r\n}\r\n\r\nexport interface SupportResponse {\r\n  success: boolean;\r\n  message: string;\r\n  ticketId?: string;\r\n}\r\n\r\nexport const handleSupportSubmit: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { name, email, subject, category, priority, message, customerId } =\r\n      req.body as SupportSubmission;\r\n\r\n    // Validate required fields\r\n    if (!name || !email || !subject || !message) {\r\n      res.status(400).json({\r\n        success: false,\r\n        error: \"Missing required fields: name, email, subject, and message\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Validate email format\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    if (!emailRegex.test(email)) {\r\n      res.status(400).json({\r\n        success: false,\r\n        error: \"Invalid email format\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Insert ticket into Supabase\r\n    const { data, error } = await supabase\r\n      .from(\"support_tickets\")\r\n      .insert({\r\n        customer_id: customerId || 0,\r\n        customer_email: email,\r\n        customer_name: name,\r\n        subject,\r\n        category,\r\n        priority,\r\n        message,\r\n        status: \"open\",\r\n      })\r\n      .select(\"id\")\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error(\"Error inserting ticket:\", error);\r\n      res.status(500).json({\r\n        success: false,\r\n        error: \"Failed to create support ticket\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    console.log(\"Support Ticket Created:\", {\r\n      ticketId: data.id,\r\n      timestamp: new Date().toISOString(),\r\n      name,\r\n      email,\r\n      subject,\r\n      category,\r\n      priority,\r\n    });\r\n\r\n    // Send confirmation email\r\n    await sendTicketCreationEmail(email, name, data.id, subject);\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: \"Support request submitted successfully\",\r\n      ticketId: data.id,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error handling support submission:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: \"Failed to process support request\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleGetTickets: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = req.query.customerId as string;\r\n\r\n    if (!customerId) {\r\n      res.status(400).json({\r\n        error: \"Customer ID is required\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"support_tickets\")\r\n      .select(\"*\")\r\n      .eq(\"customer_id\", parseInt(customerId))\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching tickets from Supabase:\", {\r\n        message: error.message,\r\n        code: (error as any).code,\r\n        details: (error as any).details,\r\n      });\r\n      res.status(500).json({\r\n        error: \"Failed to fetch tickets\",\r\n        details: error.message,\r\n      });\r\n      return;\r\n    }\r\n\r\n    console.log(\r\n      `Successfully fetched ${data?.length || 0} tickets for customer ${customerId}`,\r\n    );\r\n    res.json({ tickets: data || [] });\r\n  } catch (error) {\r\n    console.error(\"Error in handleGetTickets:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to fetch tickets\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleGetTicketDetails: RequestHandler = async (req, res) => {\n  try {\n    const { ticketId } = req.params;\n    // SECURITY: Use authenticated customer ID from request, not query parameter\n    const customerId = (req as any).customerId;\n    const isAdmin = (req as any).isAdmin;\n\n    if (!ticketId) {\n      res.status(400).json({\n        error: \"Ticket ID is required\",\n      });\n      return;\n    }\n\n    if (!customerId) {\n      res.status(401).json({\n        error: \"Authentication required\",\n      });\n      return;\n    }\n\n    const { data: ticket, error: ticketError } = await supabase\n      .from(\"support_tickets\")\n      .select(\"*\")\n      .eq(\"id\", ticketId)\n      .single();\n\n    if (ticketError || !ticket) {\n      res.status(404).json({\n        error: \"Ticket not found\",\n      });\n      return;\n    }\n\n    // SECURITY: Verify customer owns the ticket (admins can view all)\n    if (!isAdmin && ticket.customer_id !== customerId) {\n      res.status(403).json({\n        error: \"Unauthorized: You can only view your own tickets\",\n      });\n      return;\n    }\n\r\n    const { data: replies, error: repliesError } = await supabase\r\n      .from(\"ticket_replies\")\r\n      .select(\"*\")\r\n      .eq(\"ticket_id\", ticketId)\r\n      .order(\"created_at\", { ascending: true });\r\n\r\n    if (repliesError) {\r\n      console.error(\"Error fetching replies:\", repliesError);\r\n      res.status(500).json({\r\n        error: \"Failed to fetch ticket replies\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    res.json({\r\n      ticket,\r\n      replies: replies || [],\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error in handleGetTicketDetails:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to fetch ticket details\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleAdminGetAllTickets: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { status, priority } = req.query;\r\n\r\n    let query = supabase.from(\"support_tickets\").select(\"*\");\r\n\r\n    if (status) {\r\n      query = query.eq(\"status\", status);\r\n    }\r\n\r\n    if (priority) {\r\n      query = query.eq(\"priority\", priority);\r\n    }\r\n\r\n    const { data, error } = await query.order(\"created_at\", {\r\n      ascending: false,\r\n    });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching all tickets:\", error);\r\n      res.status(500).json({\r\n        error: \"Failed to fetch tickets\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    res.json(data || []);\r\n  } catch (error) {\r\n    console.error(\"Error in handleAdminGetAllTickets:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to fetch tickets\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleAdminReplyToTicket: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { ticketId } = req.params;\r\n    const { message, adminName } = req.body;\r\n\r\n    if (!ticketId || !message || !adminName) {\r\n      res.status(400).json({\r\n        error: \"Missing required fields: ticketId, message, adminName\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Get ticket details for customer email\r\n    const { data: ticket, error: ticketError } = await supabase\r\n      .from(\"support_tickets\")\r\n      .select(\"customer_email, customer_name\")\r\n      .eq(\"id\", ticketId)\r\n      .single();\r\n\r\n    if (ticketError || !ticket) {\r\n      res.status(404).json({\r\n        error: \"Ticket not found\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Insert reply\r\n    const { data: reply, error: replyError } = await supabase\r\n      .from(\"ticket_replies\")\r\n      .insert({\r\n        ticket_id: ticketId,\r\n        sender_type: \"admin\",\r\n        sender_name: adminName,\r\n        sender_email: \"support@stickerland.com\",\r\n        message,\r\n      })\r\n      .select(\"id\")\r\n      .single();\r\n\r\n    if (replyError) {\r\n      console.error(\"Error inserting reply:\", replyError);\r\n      res.status(500).json({\r\n        error: \"Failed to send reply\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Update ticket status to in-progress\r\n    const { data: updatedTicket } = await supabase\r\n      .from(\"support_tickets\")\r\n      .update({ status: \"in-progress\", updated_at: new Date().toISOString() })\r\n      .eq(\"id\", ticketId)\r\n      .select(\"subject\")\r\n      .single();\r\n\r\n    console.log(\"Admin Reply Created:\", {\r\n      ticketId,\r\n      replyId: reply.id,\r\n      customerEmail: ticket.customer_email,\r\n      message,\r\n    });\r\n\r\n    // Send email notification to customer\r\n    await sendTicketReplyEmail(\r\n      ticket.customer_email,\r\n      ticket.customer_name,\r\n      ticketId,\r\n      updatedTicket?.subject || \"Your Support Ticket\",\r\n      message,\r\n      adminName,\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      replyId: reply.id,\r\n      message: \"Reply sent successfully and customer notified\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error in handleAdminReplyToTicket:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to send reply\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleCustomerReplyToTicket: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { ticketId } = req.params;\r\n    const { message, customerId } = req.body;\r\n\r\n    if (!ticketId || !message || !customerId) {\r\n      res.status(400).json({\r\n        error: \"Missing required fields: ticketId, message, customerId\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Get ticket details to verify ownership\r\n    const { data: ticket, error: ticketError } = await supabase\r\n      .from(\"support_tickets\")\r\n      .select(\"customer_id, customer_name, customer_email\")\r\n      .eq(\"id\", ticketId)\r\n      .single();\r\n\r\n    if (ticketError || !ticket) {\r\n      res.status(404).json({\r\n        error: \"Ticket not found\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Verify customer owns this ticket\r\n    if (ticket.customer_id !== customerId) {\r\n      res.status(403).json({\r\n        error: \"Unauthorized: You can only reply to your own tickets\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Insert reply\r\n    const { data: reply, error: replyError } = await supabase\r\n      .from(\"ticket_replies\")\r\n      .insert({\r\n        ticket_id: ticketId,\r\n        sender_type: \"customer\",\r\n        sender_name: ticket.customer_name,\r\n        sender_email: ticket.customer_email,\r\n        message,\r\n      })\r\n      .select(\"id\")\r\n      .single();\r\n\r\n    if (replyError) {\r\n      console.error(\"Error inserting customer reply:\", replyError);\r\n      res.status(500).json({\r\n        error: \"Failed to send reply\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Update ticket updated_at timestamp\r\n    await supabase\r\n      .from(\"support_tickets\")\r\n      .update({ updated_at: new Date().toISOString() })\r\n      .eq(\"id\", ticketId);\r\n\r\n    console.log(\"Customer Reply Created:\", {\r\n      ticketId,\r\n      replyId: reply.id,\r\n      customerId,\r\n      message,\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      replyId: reply.id,\r\n      message: \"Reply sent successfully\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error in handleCustomerReplyToTicket:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to send reply\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleUpdateTicketStatus: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { ticketId } = req.params;\r\n    const { status } = req.body;\r\n\r\n    if (!ticketId || !status) {\r\n      res.status(400).json({\r\n        error: \"Missing required fields\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    const validStatuses = [\"open\", \"in-progress\", \"resolved\", \"closed\"];\r\n    if (!validStatuses.includes(status)) {\r\n      res.status(400).json({\r\n        error: \"Invalid status\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from(\"support_tickets\")\r\n      .update({ status, updated_at: new Date().toISOString() })\r\n      .eq(\"id\", ticketId);\r\n\r\n    if (error) {\r\n      console.error(\"Error updating ticket:\", error);\r\n      res.status(500).json({\r\n        error: \"Failed to update ticket\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Ticket status updated\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error in handleUpdateTicketStatus:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to update ticket\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7426, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/payments.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { ecwidAPI } from \"../utils/ecwid\";\r\n\r\ninterface PaymentRequest {\r\n  amount: number;\r\n  currency: string;\r\n  payment_method_id: string;\r\n  payment_instrument?: {\r\n    type: string;\r\n    number?: string;\r\n    expiry_month?: number;\r\n    expiry_year?: number;\r\n    cvv?: string;\r\n    cardholder_name?: string;\r\n  };\r\n  description?: string;\r\n  reference_id?: string;\r\n  order_id?: number;\r\n}\r\n\r\n/**\r\n * Get available payment methods\r\n */\r\nexport const handleGetPaymentMethods: RequestHandler = async (req, res) => {\r\n  try {\r\n    // Return standard payment methods for Ecwid\r\n    const methods = [\r\n      {\r\n        id: \"stripe\",\r\n        name: \"Credit Card (Stripe)\",\r\n        type: \"card\",\r\n      },\r\n      {\r\n        id: \"paypal\",\r\n        name: \"PayPal\",\r\n        type: \"paypal\",\r\n      },\r\n      {\r\n        id: \"bank_transfer\",\r\n        name: \"Bank Transfer\",\r\n        type: \"bank\",\r\n      },\r\n    ];\r\n\r\n    res.json({\r\n      success: true,\r\n      data: methods,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get payment methods error:\", error);\r\n    res.status(500).json({\r\n      error:\r\n        error instanceof Error\r\n          ? error.message\r\n          : \"Failed to get payment methods\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Process a payment via Ecwid\r\n * Note: Actual payment processing is typically handled by Ecwid's payment gateway\r\n */\r\nexport const handleProcessPayment: RequestHandler = async (req, res) => {\r\n  try {\r\n    const paymentData = req.body as PaymentRequest;\r\n\r\n    // Validate required fields\r\n    if (\r\n      !paymentData.amount ||\r\n      !paymentData.currency ||\r\n      !paymentData.payment_method_id\r\n    ) {\r\n      return res.status(400).json({\r\n        error: \"Missing required fields: amount, currency, payment_method_id\",\r\n      });\r\n    }\r\n\r\n    // Log payment for record-keeping\r\n    console.log(\"Processing payment via Ecwid:\", {\r\n      amount: paymentData.amount,\r\n      currency: paymentData.currency,\r\n      method: paymentData.payment_method_id,\r\n      orderId: paymentData.order_id,\r\n    });\r\n\r\n    // In production, this would integrate with Ecwid's payment gateway\r\n    // For now, we acknowledge the payment and return success\r\n    res.status(201).json({\r\n      success: true,\r\n      data: {\r\n        id: `payment_${Date.now()}`,\r\n        amount: paymentData.amount,\r\n        currency: paymentData.currency,\r\n        payment_method_id: paymentData.payment_method_id,\r\n        status: \"processing\",\r\n        created_at: new Date().toISOString(),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Process payment error:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to process payment\";\r\n    res.status(400).json({\r\n      error: errorMessage,\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;;;AAuBO,MAAM,0BAA0C,OAAO,KAAK;IACjE,IAAI;QACF,4CAA4C;QAC5C,MAAM,UAAU;YACd;gBACE,IAAI;gBACJ,MAAM;gBACN,MAAM;YACR;YACA;gBACE,IAAI;gBACJ,MAAM;gBACN,MAAM;YACR;YACA;gBACE,IAAI;gBACJ,MAAM;gBACN,MAAM;YACR;SACD;QAED,IAAI,IAAI,CAAC;YACP,SAAS;YACT,MAAM;QACR;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OACE,iBAAiB,QACb,MAAM,OAAO,GACb;QACR;IACF;AACF;AAMO,MAAM,uBAAuC,OAAO,KAAK;IAC9D,IAAI;QACF,MAAM,cAAc,IAAI,IAAI;QAE5B,2BAA2B;QAC3B,IACE,CAAC,YAAY,MAAM,IACnB,CAAC,YAAY,QAAQ,IACrB,CAAC,YAAY,iBAAiB,EAC9B;YACA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;YACT;QACF;QAEA,iCAAiC;QACjC,QAAQ,GAAG,CAAC,iCAAiC;YAC3C,QAAQ,YAAY,MAAM;YAC1B,UAAU,YAAY,QAAQ;YAC9B,QAAQ,YAAY,iBAAiB;YACrC,SAAS,YAAY,QAAQ;QAC/B;QAEA,mEAAmE;QACnE,yDAAyD;QACzD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,MAAM;gBACJ,IAAI,CAAC,QAAQ,EAAE,KAAK,GAAG,IAAI;gBAC3B,QAAQ,YAAY,MAAM;gBAC1B,UAAU,YAAY,QAAQ;gBAC9B,mBAAmB,YAAY,iBAAiB;gBAChD,QAAQ;gBACR,YAAY,IAAI,OAAO,WAAW;YACpC;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0BAA0B;QACxC,MAAM,eACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;QACT;IACF;AACF"}},
    {"offset": {"line": 7506, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/webhooks.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport crypto from \"crypto\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL || \"\",\r\n  process.env.SUPABASE_SERVICE_KEY || \"\",\r\n);\r\n\r\n/**\r\n * Map Ecwid fulfillment status to internal order status\r\n */\r\nfunction mapEcwidStatusToOrderStatus(fulfillmentStatus: string | undefined, paymentStatus: string | undefined): string {\r\n  const statusMap: Record<string, string> = {\r\n    \"AWAITING_PAYMENT\": \"pending\",\r\n    \"PAID\": \"processing\",\r\n    \"PROCESSING\": \"processing\",\r\n    \"SHIPPED\": \"completed\",\r\n    \"DELIVERED\": \"completed\",\r\n    \"CANCELLED\": \"cancelled\",\r\n  };\r\n\r\n  const ecwidStatus = fulfillmentStatus || paymentStatus || \"PROCESSING\";\r\n  return statusMap[ecwidStatus] || \"pending\";\r\n}\r\n\r\n/**\r\n * Verify Ecwid webhook signature\r\n * Ecwid sends an X-Ecwid-Webhook-Signature header\r\n */\r\nfunction verifyEcwidSignature(body: string, signature: string): boolean {\r\n  const secret = process.env.ECWID_API_TOKEN || \"\";\r\n\r\n  // Create HMAC SHA256 hash\r\n  const hash = crypto.createHmac(\"sha256\", secret).update(body).digest(\"hex\");\r\n\r\n  // Compare signatures\r\n  return hash === signature;\r\n}\r\n\r\n/**\r\n * Handle Ecwid order.completed webhook\r\n * Sync order data to Supabase\r\n */\r\nexport const handleEcwidOrderWebhook: RequestHandler = async (req, res) => {\r\n  try {\r\n    const signature = req.headers[\"x-ecwid-webhook-signature\"] as string;\r\n    const body = JSON.stringify(req.body);\r\n\r\n    // Verify webhook signature\r\n    if (!verifyEcwidSignature(body, signature)) {\r\n      console.warn(\"Invalid webhook signature\");\r\n      return res.status(401).json({ error: \"Invalid signature\" });\r\n    }\r\n\r\n    const event = req.body;\r\n    console.log(\"Ecwid webhook received:\", {\r\n      eventType: event.eventType,\r\n      orderId: event.data?.orderId,\r\n      customerId: event.data?.customerId,\r\n    });\r\n\r\n    // Handle different event types\r\n    switch (event.eventType) {\r\n      case \"order.completed\":\r\n        await handleOrderCompleted(event.data);\r\n        break;\r\n      case \"order.updated\":\r\n        await handleOrderUpdated(event.data);\r\n        break;\r\n      case \"customer.created\":\r\n        await handleCustomerCreated(event.data);\r\n        break;\r\n      case \"customer.updated\":\r\n        await handleCustomerUpdated(event.data);\r\n        break;\r\n      default:\r\n        console.log(\"Unhandled event type:\", event.eventType);\r\n    }\r\n\r\n    // Always return success to Ecwid\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error(\"Webhook error:\", error);\r\n    // Still return 200 to prevent Ecwid from retrying\r\n    res.status(200).json({ error: \"Webhook processed with errors\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Handle order completion\r\n */\r\nasync function handleOrderCompleted(data: any): Promise<void> {\r\n  try {\r\n    console.log(\r\n      \"Processing Ecwid order completion:\",\r\n      data.orderId,\r\n      \"Customer:\",\r\n      data.customerId,\r\n    );\r\n\r\n    // Check if order exists in Supabase by Ecwid order ID\r\n    const { data: existingOrder } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"id\")\r\n      .eq(\"ecwid_order_id\", data.orderId)\r\n      .single();\r\n\r\n    if (existingOrder) {\r\n      // Don't overwrite status on order.completed if order already exists\r\n      // Just update the timestamp to mark as processed\r\n      await supabase\r\n        .from(\"orders\")\r\n        .update({\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", existingOrder.id);\r\n\r\n      console.log(\"Ecwid order already exists in Supabase:\", existingOrder.id);\r\n    } else {\r\n      // Find customer by Ecwid customer ID\r\n      const { data: customer } = await supabase\r\n        .from(\"customers\")\r\n        .select(\"id\")\r\n        .eq(\"ecwid_customer_id\", data.customerId)\r\n        .single();\r\n\r\n      // Create new order record - use Ecwid's fulfillment status if available\r\n      const orderStatus = mapEcwidStatusToOrderStatus(data.fulfillmentStatus, data.paymentStatus);\r\n\r\n      const orderData = {\r\n        customer_id: customer?.id || null,\r\n        status: orderStatus,\r\n        total: data.total || 0,\r\n        subtotal: data.subtotal || 0,\r\n        tax: data.tax || 0,\r\n        shipping: data.shipping || 0,\r\n        billing_address: data.billingPerson,\r\n        shipping_address: data.shippingPerson,\r\n        ecwid_order_id: data.orderId,\r\n        ecwid_customer_id: data.customerId,\r\n        items: data.items || [],\r\n        created_at: data.createDate || new Date().toISOString(),\r\n        estimated_delivery_date: data.estimatedDeliveryDate || null,\r\n        tracking_number: data.trackingNumber || null,\r\n        tracking_carrier: data.trackingCarrier || null,\r\n        tracking_url: data.trackingUrl || null,\r\n      };\r\n\r\n      const { data: newOrder, error } = await supabase\r\n        .from(\"orders\")\r\n        .insert(orderData)\r\n        .select()\r\n        .single();\r\n\r\n      if (!error && newOrder) {\r\n        console.log(\"Ecwid order created in Supabase:\", newOrder.id);\r\n      } else if (error) {\r\n        console.error(\"Error creating order in Supabase:\", error);\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error processing order completion:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle order update\r\n */\r\nasync function handleOrderUpdated(data: any): Promise<void> {\r\n  try {\r\n    console.log(\"Processing Ecwid order update:\", data.orderId);\r\n\r\n    const updateData: any = {\r\n      status: mapEcwidStatusToOrderStatus(data.fulfillmentStatus, data.paymentStatus),\r\n      updated_at: new Date().toISOString(),\r\n    };\r\n\r\n    // Update estimated delivery date if provided\r\n    if (data.estimatedDeliveryDate) {\r\n      updateData.estimated_delivery_date = data.estimatedDeliveryDate;\r\n    }\r\n\r\n    // Update tracking information if provided\r\n    if (data.trackingNumber) {\r\n      updateData.tracking_number = data.trackingNumber;\r\n      updateData.tracking_carrier = data.trackingCarrier || null;\r\n      updateData.tracking_url = data.trackingUrl || null;\r\n      updateData.shipped_date = new Date().toISOString();\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from(\"orders\")\r\n      .update(updateData)\r\n      .eq(\"ecwid_order_id\", data.orderId);\r\n\r\n    if (!error) {\r\n      console.log(\"Ecwid order updated in Supabase:\", data.orderId);\r\n    } else {\r\n      console.error(\"Error updating order in Supabase:\", error);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error processing order update:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle customer creation\r\n */\r\nasync function handleCustomerCreated(data: any): Promise<void> {\r\n  try {\r\n    console.log(\r\n      \"Processing customer creation from Ecwid:\",\r\n      data.id,\r\n      data.email,\r\n    );\r\n\r\n    // Check if customer exists by Ecwid ID\r\n    const { data: existingCustomer } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"id, ecwid_customer_id\")\r\n      .eq(\"ecwid_customer_id\", data.id)\r\n      .single();\r\n\r\n    if (!existingCustomer) {\r\n      // Create customer in Supabase with Ecwid customer ID\r\n      const { data: newCustomer, error } = await supabase\r\n        .from(\"customers\")\r\n        .insert({\r\n          email: data.email,\r\n          first_name: data.firstName || \"\",\r\n          last_name: data.lastName || \"\",\r\n          phone: data.phone || \"\",\r\n          company: data.companyName || \"\",\r\n          store_credit: 0,\r\n          ecwid_customer_id: data.id,\r\n          // Customer will set password when they first log in\r\n          password_hash: null,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error(\"Error creating customer in Supabase:\", error);\r\n      } else {\r\n        console.log(\"Ecwid customer synced to Supabase:\", newCustomer.id);\r\n      }\r\n    } else {\r\n      console.log(\r\n        \"Ecwid customer already exists in Supabase:\",\r\n        existingCustomer.id,\r\n      );\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error processing customer creation:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle customer update\r\n */\r\nasync function handleCustomerUpdated(data: any): Promise<void> {\r\n  try {\r\n    console.log(\"Processing customer update from Ecwid:\", data.id);\r\n\r\n    // Find customer by Ecwid ID\r\n    const { data: existingCustomer } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"id\")\r\n      .eq(\"ecwid_customer_id\", data.id)\r\n      .single();\r\n\r\n    if (existingCustomer) {\r\n      await supabase\r\n        .from(\"customers\")\r\n        .update({\r\n          email: data.email,\r\n          first_name: data.firstName || \"\",\r\n          last_name: data.lastName || \"\",\r\n          phone: data.phone || \"\",\r\n          company: data.companyName || \"\",\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", existingCustomer.id);\r\n\r\n      console.log(\"Ecwid customer updated in Supabase:\", existingCustomer.id);\r\n    } else {\r\n      // Customer doesn't exist, create them\r\n      await handleCustomerCreated(data);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error processing customer update:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Get webhook URL - for easy reference when setting up Ecwid webhooks\r\n */\r\nexport const handleGetWebhookUrl: RequestHandler = (req, res) => {\r\n  const host = req.get(\"host\") || \"your-domain.com\";\r\n  const protocol = req.header(\"x-forwarded-proto\") || req.protocol || \"https\";\r\n  const webhookUrl = `${protocol}://${host}/api/webhooks/ecwid`;\r\n\r\n  res.json({\r\n    webhookUrl,\r\n    instructions: \"Paste this URL into your Ecwid admin panel under Settings ‚Üí Integration ‚Üí Webhooks\",\r\n    events: [\"order.completed\", \"order.updated\", \"customer.created\", \"customer.updated\"],\r\n  });\r\n};\r\n\r\n/**\r\n * Health check for webhooks\r\n */\r\nexport const handleWebhookHealth: RequestHandler = (req, res) => {\r\n  res.json({\r\n    status: \"ok\",\r\n    timestamp: new Date().toISOString(),\r\n  });\r\n};\r\n\r\n/**\r\n * Diagnostic endpoint to verify Ecwid API connectivity and webhook configuration\r\n */\r\nexport const handleEcwidDiagnostic: RequestHandler = async (req, res) => {\r\n  try {\r\n    const ECWID_API_TOKEN = process.env.ECWID_API_TOKEN || \"\";\r\n    const ECWID_STORE_ID = process.env.ECWID_STORE_ID || \"\";\r\n\r\n    const diagnostics: any = {\r\n      timestamp: new Date().toISOString(),\r\n      configStatus: {\r\n        hasApiToken: !!ECWID_API_TOKEN,\r\n        hasStoreId: !!ECWID_STORE_ID,\r\n        storeId: ECWID_STORE_ID,\r\n      },\r\n      apiConnectivity: {\r\n        status: \"unknown\",\r\n        message: \"\",\r\n      },\r\n      webhookUrl: `${req.header(\"x-forwarded-proto\") || req.protocol || \"https\"}://${req.get(\"host\") || \"your-domain.com\"}/api/webhooks/ecwid`,\r\n      webhookSetupInstructions: {\r\n        step1: \"Log in to your Ecwid admin panel\",\r\n        step2: \"Go to Settings ‚Üí Integration ‚Üí Webhooks (or Settings ‚Üí API ‚Üí Webhooks)\",\r\n        step3: \"Add a new webhook with the URL above\",\r\n        step4: \"Select events: order.completed, order.updated, customer.created, customer.updated\",\r\n        step5: \"Save and test the webhook\",\r\n      },\r\n      supabaseConnection: {\r\n        status: \"unknown\",\r\n        message: \"\",\r\n      },\r\n      recentOrders: {\r\n        count: 0,\r\n        lastOrder: null,\r\n      },\r\n    };\r\n\r\n    // Check API connectivity\r\n    if (!ECWID_API_TOKEN || !ECWID_STORE_ID) {\r\n      diagnostics.apiConnectivity.status = \"error\";\r\n      diagnostics.apiConnectivity.message =\r\n        \"Missing ECWID_API_TOKEN or ECWID_STORE_ID environment variables\";\r\n    } else {\r\n      try {\r\n        // Try to fetch a single order to verify connectivity\r\n        const response = await fetch(\r\n          `https://api.ecwid.com/api/v3/${ECWID_STORE_ID}/orders?limit=1&token=${ECWID_API_TOKEN}`,\r\n          {\r\n            method: \"GET\",\r\n            headers: {\r\n              \"Content-Type\": \"application/json\",\r\n            },\r\n          },\r\n        );\r\n\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          diagnostics.apiConnectivity.status = \"connected\";\r\n          diagnostics.apiConnectivity.message =\r\n            \"Successfully connected to Ecwid API\";\r\n          diagnostics.recentOrders.count = data.total || 0;\r\n\r\n          if (data.items && data.items.length > 0) {\r\n            diagnostics.recentOrders.lastOrder = {\r\n              id: data.items[0].id,\r\n              number: data.items[0].number,\r\n              createdDate: data.items[0].createdDate,\r\n              status: data.items[0].status,\r\n            };\r\n          }\r\n        } else {\r\n          diagnostics.apiConnectivity.status = \"error\";\r\n          diagnostics.apiConnectivity.message = `Ecwid API returned ${response.status}: ${response.statusText}`;\r\n        }\r\n      } catch (error) {\r\n        diagnostics.apiConnectivity.status = \"error\";\r\n        diagnostics.apiConnectivity.message = `Network error: ${error instanceof Error ? error.message : \"Unknown error\"}`;\r\n      }\r\n    }\r\n\r\n    // Check Supabase connection and recent webhooks\r\n    try {\r\n      const { data: recentWebhooks, error } = await supabase\r\n        .from(\"orders\")\r\n        .select(\"id, ecwid_order_id, created_at, status\")\r\n        .order(\"created_at\", { ascending: false })\r\n        .limit(5);\r\n\r\n      if (!error) {\r\n        diagnostics.supabaseConnection.status = \"connected\";\r\n        diagnostics.supabaseConnection.message =\r\n          \"Successfully connected to Supabase\";\r\n      } else {\r\n        diagnostics.supabaseConnection.status = \"error\";\r\n        diagnostics.supabaseConnection.message = `Supabase error: ${error.message}`;\r\n      }\r\n    } catch (error) {\r\n      diagnostics.supabaseConnection.status = \"error\";\r\n      diagnostics.supabaseConnection.message = `Connection error: ${error instanceof Error ? error.message : \"Unknown error\"}`;\r\n    }\r\n\r\n    res.json(diagnostics);\r\n  } catch (error) {\r\n    console.error(\"Diagnostic error:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to run diagnostics\",\r\n      message: error instanceof Error ? error.message : \"Unknown error\",\r\n      timestamp: new Date().toISOString(),\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Test webhook endpoint - for testing webhook payload handling without requiring Ecwid to send real data\r\n * This is useful for development and debugging\r\n */\r\nexport const handleTestWebhook: RequestHandler = async (req, res) => {\r\n  try {\r\n    const testPayload = req.body;\r\n\r\n    // Add test signature for validation (we'll skip verification for test endpoint)\r\n    console.log(\"Test webhook payload received:\", testPayload);\r\n\r\n    // Process based on event type\r\n    if (testPayload.eventType === \"order.completed\") {\r\n      await handleOrderCompleted(testPayload.data);\r\n      res.json({\r\n        success: true,\r\n        message: \"Test order webhook processed\",\r\n        eventType: \"order.completed\",\r\n      });\r\n    } else if (testPayload.eventType === \"customer.created\") {\r\n      await handleCustomerCreated(testPayload.data);\r\n      res.json({\r\n        success: true,\r\n        message: \"Test customer webhook processed\",\r\n        eventType: \"customer.created\",\r\n      });\r\n    } else {\r\n      res.json({\r\n        success: true,\r\n        message: \"Test webhook received and logged\",\r\n        eventType: testPayload.eventType || \"unknown\",\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Test webhook error:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to process test webhook\",\r\n      message: error instanceof Error ? error.message : \"Unknown error\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7888, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/zapier.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL || \"\",\r\n  process.env.SUPABASE_SERVICE_KEY || \"\",\r\n);\r\n\r\n/**\n * Handle Zapier webhook from Ecwid\n * Receives order data from Zapier trigger and syncs to Supabase\n * SECURITY: Requires API key authentication\n */\nexport const handleZapierEcwidWebhook: RequestHandler = async (req, res) => {\n  try {\n    // SECURITY: Verify API key\n    const apiKey = req.headers['x-api-key'];\n    const expectedKey = process.env.ZAPIER_WEBHOOK_API_KEY;\n    \n    if (!expectedKey) {\n      console.error(\"[SECURITY] ZAPIER_WEBHOOK_API_KEY not configured\");\n      return res.status(503).json({ error: \"Webhook not configured\" });\n    }\n    \n    if (!apiKey || apiKey !== expectedKey) {\n      console.warn(\"[SECURITY] Invalid Zapier webhook API key attempt\");\n      return res.status(401).json({ error: \"Unauthorized\" });\n    }\n\n    const zapierData = req.body;\n\n    console.log(\"Zapier webhook received from Ecwid:\", {\n      orderId: zapierData.order_id || zapierData.id,\n      customerEmail: zapierData.customer_email || zapierData.email,\n      total: zapierData.order_total || zapierData.total,\n    });\n\r\n    // Extract order data from Zapier payload\r\n    const ecwidOrderId = zapierData.order_id || zapierData.id;\r\n    const ecwidCustomerId = zapierData.customer_id || zapierData.customer?.id;\r\n\r\n    if (!ecwidOrderId) {\r\n      return res.status(400).json({ \r\n        error: \"Missing order_id in Zapier payload\" \r\n      });\r\n    }\r\n\r\n    // Check if order already exists in Supabase\r\n    const { data: existingOrder } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"id\")\r\n      .eq(\"ecwid_order_id\", ecwidOrderId)\r\n      .single();\r\n\r\n    if (existingOrder) {\r\n      console.log(\"Order already exists in Supabase:\", existingOrder.id);\r\n      return res.json({ \r\n        success: true, \r\n        message: \"Order already exists\",\r\n        orderId: existingOrder.id \r\n      });\r\n    }\r\n\r\n    // Find or get customer\r\n    let customerId: string | null = null;\r\n    if (ecwidCustomerId) {\r\n      const { data: customer } = await supabase\r\n        .from(\"customers\")\r\n        .select(\"id\")\r\n        .eq(\"ecwid_customer_id\", ecwidCustomerId)\r\n        .single();\r\n\r\n      customerId = customer?.id || null;\r\n    }\r\n\r\n    // Prepare order data\r\n    const orderData = {\r\n      customer_id: customerId,\r\n      status: \"processing\", // Default to processing for new orders from Zapier\r\n      total: zapierData.order_total || zapierData.total || 0,\r\n      subtotal: zapierData.order_subtotal || zapierData.subtotal || 0,\r\n      tax: zapierData.order_tax || zapierData.tax || 0,\r\n      shipping: zapierData.order_shipping || zapierData.shipping || 0,\r\n      billing_address: zapierData.billing_address || {\r\n        name: zapierData.billing_name,\r\n        email: zapierData.billing_email,\r\n        phone: zapierData.billing_phone,\r\n        address: zapierData.billing_address_1,\r\n        city: zapierData.billing_city,\r\n        state: zapierData.billing_state,\r\n        postal_code: zapierData.billing_postal_code,\r\n        country: zapierData.billing_country,\r\n      },\r\n      shipping_address: zapierData.shipping_address || {\r\n        name: zapierData.shipping_name,\r\n        email: zapierData.shipping_email,\r\n        phone: zapierData.shipping_phone,\r\n        address: zapierData.shipping_address_1,\r\n        city: zapierData.shipping_city,\r\n        state: zapierData.shipping_state,\r\n        postal_code: zapierData.shipping_postal_code,\r\n        country: zapierData.shipping_country,\r\n      },\r\n      ecwid_order_id: ecwidOrderId,\r\n      ecwid_customer_id: ecwidCustomerId || null,\r\n      items: zapierData.items || [],\r\n      created_at: zapierData.created_date || zapierData.date_created || new Date().toISOString(),\r\n      estimated_delivery_date: zapierData.estimated_delivery_date || null,\r\n      tracking_number: zapierData.tracking_number || null,\r\n      tracking_carrier: zapierData.tracking_carrier || null,\r\n      tracking_url: zapierData.tracking_url || null,\r\n      source: \"zapier\",\r\n    };\r\n\r\n    // Create order in Supabase\r\n    const { data: newOrder, error: orderError } = await supabase\r\n      .from(\"orders\")\r\n      .insert([orderData])\r\n      .select()\r\n      .single();\r\n\r\n    if (orderError) {\r\n      console.error(\"Error creating order in Supabase:\", orderError);\r\n      return res.status(500).json({ \r\n        error: \"Failed to create order\",\r\n        details: orderError.message \r\n      });\r\n    }\r\n\r\n    console.log(\"Order successfully created from Zapier:\", newOrder.id);\r\n\r\n    // Also sync customer if provided\r\n    if (ecwidCustomerId) {\r\n      const { data: existingCustomer } = await supabase\r\n        .from(\"customers\")\r\n        .select(\"id\")\r\n        .eq(\"ecwid_customer_id\", ecwidCustomerId)\r\n        .single();\r\n\r\n      if (!existingCustomer) {\r\n        const customerData = {\r\n          email: zapierData.customer_email || zapierData.email,\r\n          ecwid_customer_id: ecwidCustomerId,\r\n          name: zapierData.customer_name || zapierData.name || \"\",\r\n          phone: zapierData.phone || \"\",\r\n        };\r\n\r\n        const { error: customerError } = await supabase\r\n          .from(\"customers\")\r\n          .insert([customerData]);\r\n\r\n        if (customerError) {\r\n          console.warn(\"Error creating customer from Zapier:\", customerError);\r\n          // Don't fail the request if customer sync fails - order is already created\r\n        }\r\n      }\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Order synced from Zapier to Supabase\",\r\n      orderId: newOrder.id,\r\n      ecwidOrderId: ecwidOrderId,\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error(\"Zapier webhook error:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to process Zapier webhook\",\r\n      message: error instanceof Error ? error.message : \"Unknown error\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Health check endpoint for Zapier integration\r\n */\r\nexport const handleZapierHealth: RequestHandler = (req, res) => {\r\n  res.json({\r\n    status: \"healthy\",\r\n    service: \"zapier-ecwid-integration\",\r\n    endpoint: \"/api/zapier/webhook\",\r\n    timestamp: new Date().toISOString(),\r\n  });\r\n};\r\n\r\n/**\r\n * Get Zapier webhook URL for setup instructions\r\n */\r\nexport const handleGetZapierWebhookUrl: RequestHandler = (req, res) => {\r\n  const host = req.get(\"host\") || \"your-domain.com\";\r\n  const protocol = req.header(\"x-forwarded-proto\") || req.protocol || \"https\";\r\n  const zapierWebhookUrl = `${protocol}://${host}/api/zapier/webhook`;\r\n\r\n  res.json({\r\n    webhookUrl: zapierWebhookUrl,\r\n    instructions: {\r\n      step1: \"In Zapier, create a new Zap with Ecwid as trigger\",\r\n      step2: \"Choose 'New Order' or 'Updated Order' event\",\r\n      step3: \"For the action, select 'Webhooks by Zapier' ‚Üí 'POST'\",\r\n      step4: \"Paste this URL into the webhook URL field\",\r\n      step5: \"Map the following Ecwid fields to the webhook body:\",\r\n      fieldMappings: {\r\n        order_id: \"Use Ecwid's Order ID field\",\r\n        customer_id: \"Use Ecwid's Customer ID field\",\r\n        customer_email: \"Use Ecwid's Customer Email field\",\r\n        order_total: \"Use Ecwid's Order Total field\",\r\n        order_subtotal: \"Use Ecwid's Order Subtotal field\",\r\n        order_tax: \"Use Ecwid's Tax field\",\r\n        order_shipping: \"Use Ecwid's Shipping Cost field\",\r\n        items: \"Use Ecwid's Order Items field\",\r\n        created_date: \"Use Ecwid's Date Created field\",\r\n      },\r\n      step6: \"Save and test your Zap\",\r\n    },\r\n  });\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8073, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/utils/square.ts"],"sourcesContent":["// Valid ISO 3166-1 alpha-2 country codes\r\nconst VALID_COUNTRY_CODES = new Set([\r\n  \"US\",\r\n  \"GB\",\r\n  \"CA\",\r\n  \"AU\",\r\n  \"DE\",\r\n  \"FR\",\r\n  \"IT\",\r\n  \"ES\",\r\n  \"NL\",\r\n  \"BE\",\r\n  \"CH\",\r\n  \"AT\",\r\n  \"SE\",\r\n  \"NO\",\r\n  \"DK\",\r\n  \"FI\",\r\n  \"PL\",\r\n  \"CZ\",\r\n  \"SK\",\r\n  \"HU\",\r\n  \"RO\",\r\n  \"BG\",\r\n  \"GR\",\r\n  \"PT\",\r\n  \"IE\",\r\n  \"NZ\",\r\n  \"SG\",\r\n  \"HK\",\r\n  \"JP\",\r\n  \"KR\",\r\n  \"TW\",\r\n  \"CN\",\r\n  \"IN\",\r\n  \"BR\",\r\n  \"MX\",\r\n  \"AR\",\r\n  \"CO\",\r\n  \"PE\",\r\n  \"CL\",\r\n  \"ZA\",\r\n  \"KE\",\r\n  \"NG\",\r\n  \"EG\",\r\n  \"IL\",\r\n  \"AE\",\r\n  \"SA\",\r\n  \"QA\",\r\n  \"TH\",\r\n  \"MY\",\r\n  \"ID\",\r\n  \"PH\",\r\n  \"VN\",\r\n  \"TW\",\r\n  \"GR\",\r\n  \"CY\",\r\n  \"MT\",\r\n  \"LU\",\r\n  \"IS\",\r\n  \"HR\",\r\n  \"SI\",\r\n  \"LV\",\r\n  \"LT\",\r\n  \"EE\",\r\n  \"GE\",\r\n  \"KZ\",\r\n  \"UA\",\r\n  \"BY\",\r\n  \"RU\",\r\n  \"TR\",\r\n  \"LB\",\r\n  \"JO\",\r\n  \"AE\",\r\n]);\r\n\r\n/**\r\n * Validate if a country code is a valid ISO 3166-1 alpha-2 code\r\n */\r\nexport function isValidCountryCode(code: string | undefined): boolean {\r\n  if (!code) return true; // Allow empty/undefined\r\n  return VALID_COUNTRY_CODES.has(code.toUpperCase());\r\n}\r\n\r\n/**\r\n * Validate email format\r\n */\r\nexport function isValidEmail(email: string | undefined): boolean {\r\n  if (!email) return false;\r\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n  return emailRegex.test(email) && email.length <= 255;\r\n}\r\n\r\n/**\r\n * Validate phone number format (basic - allows digits, +, -, parentheses, spaces)\r\n */\r\nexport function isValidPhone(phone: string | undefined): boolean {\r\n  if (!phone) return true; // Phone is optional\r\n  const phoneRegex = /^[\\d+\\-().\\s]{7,20}$/;\r\n  return phoneRegex.test(phone);\r\n}\r\n\r\n/**\r\n * Sanitize string input - remove potential XSS characters\r\n */\r\nexport function sanitizeInput(input: string | undefined): string {\r\n  if (!input) return \"\";\r\n  // Remove any HTML/script tags and dangerous characters\r\n  return input\r\n    .replace(/[<>\"{};]/g, \"\")\r\n    .trim()\r\n    .slice(0, 255);\r\n}\r\n\r\n/**\r\n * Validate address field\r\n */\r\nexport function isValidAddress(address: string | undefined): boolean {\r\n  if (!address) return false;\r\n  // Address should be 1-255 characters, no dangerous characters\r\n  return (\r\n    address.length > 0 && address.length <= 255 && !/[<>\"{};]/.test(address)\r\n  );\r\n}\r\n\r\nlet squareClient: any = null;\r\n\r\nexport async function getSquareClient() {\r\n  if (!squareClient) {\r\n    try {\r\n      console.log(\"Initializing Square SDK...\");\r\n\r\n      // Check environment variables - token is required\r\n      const accessToken = process.env.SQUARE_ACCESS_TOKEN;\r\n      if (!accessToken) {\r\n        throw new Error(\r\n          \"SQUARE_ACCESS_TOKEN environment variable is not configured. This is required for Square API operations.\",\r\n        );\r\n      }\r\n\r\n      console.log(\"Access token found, length:\", accessToken.length);\r\n\r\n      // Import Square SDK - the correct export is SquareClient\r\n      let SquareClientClass;\r\n      try {\r\n        // First try ES module import\r\n        const squareModule = await import(\"square\");\r\n        SquareClientClass = squareModule.SquareClient || squareModule.default;\r\n      } catch (importError) {\r\n        console.warn(\r\n          \"ES module import failed, falling back to require:\",\r\n          importError,\r\n        );\r\n        // Fallback to CommonJS require\r\n        const squareModule = require(\"square\");\r\n        SquareClientClass = squareModule.SquareClient;\r\n      }\r\n\r\n      if (!SquareClientClass || typeof SquareClientClass !== \"function\") {\r\n        throw new Error(\r\n          `Square SquareClient not found or not a constructor. Received: ${typeof SquareClientClass}`,\r\n        );\r\n      }\r\n\r\n      // Initialize with correct environment string\r\n      squareClient = new SquareClientClass({\r\n        accessToken: accessToken,\r\n        environment: \"sandbox\",\r\n      });\r\n\r\n      console.log(\"Square SDK client initialized successfully\");\r\n\r\n      // Verify APIs are accessible (v43.2.1+ exposes APIs as objects)\r\n      if (!squareClient.payments) {\r\n        throw new Error(\"payments API not accessible on Square client\");\r\n      }\r\n\r\n      if (!squareClient.orders) {\r\n        throw new Error(\"orders API not accessible on Square client\");\r\n      }\r\n\r\n      console.log(\"Square APIs verified - payments and orders APIs accessible\");\r\n    } catch (error) {\r\n      console.error(\"Failed to initialize Square client:\", error);\r\n      throw new Error(\r\n        `Square SDK initialization failed: ${error instanceof Error ? error.message : String(error)}`,\r\n      );\r\n    }\r\n  }\r\n  return squareClient;\r\n}\r\n\r\nexport async function getPaymentsApi() {\r\n  const client = await getSquareClient();\r\n  if (!client.payments) {\r\n    throw new Error(\"Square payments API is not available\");\r\n  }\r\n  return client.payments;\r\n}\r\n\r\nexport async function getLocationsApi() {\r\n  const client = await getSquareClient();\r\n  if (!client.locations) {\r\n    throw new Error(\"Square locations API is not available\");\r\n  }\r\n  return client.locations;\r\n}\r\n\r\nexport async function getOrdersApi() {\r\n  const client = await getSquareClient();\r\n  if (!client.orders) {\r\n    throw new Error(\"Square orders API is not available\");\r\n  }\r\n  return client.orders;\r\n}\r\n\r\nexport async function getCheckoutApi() {\r\n  const client = await getSquareClient();\r\n  if (!client.checkout) {\r\n    throw new Error(\"Square checkout API is not available\");\r\n  }\r\n  return client.checkout;\r\n}\r\n\r\nimport { formatOrderNumber } from \"./order\";\r\n\r\nexport async function processSquarePayment(paymentData: {\r\n  sourceId: string;\r\n  amount: number;\r\n  currency: string;\r\n  orderId?: string;\r\n  customerEmail?: string;\r\n  customerName?: string;\r\n}): Promise<any> {\r\n  try {\r\n    // Amount should be in the smallest currency unit (cents for USD)\r\n    const amountInCents = Math.round(paymentData.amount * 100);\r\n\r\n    const paymentBody = {\r\n      sourceId: paymentData.sourceId,\r\n      amountMoney: {\r\n        amount: amountInCents,\r\n        currency: paymentData.currency || \"USD\",\r\n      },\r\n      autocomplete: true,\r\n      idempotencyKey: `${Date.now()}-${Math.random()}`,\r\n      ...(paymentData.orderId && { orderId: paymentData.orderId.toString() }),\r\n      ...(paymentData.customerName && {\r\n        customerId: paymentData.customerName,\r\n      }),\r\n      ...(paymentData.customerEmail && {\r\n        receiptEmail: paymentData.customerEmail,\r\n      }),\r\n    };\r\n\r\n    console.log(\r\n      \"Processing Square payment with amount:\",\r\n      amountInCents,\r\n      \"cents\",\r\n    );\r\n\r\n    const paymentsApi = await getPaymentsApi();\r\n    const response = await paymentsApi.createPayment(paymentBody);\r\n\r\n    if (response.result) {\r\n      console.log(\"Square payment processed successfully:\", response.result.id);\r\n      return {\r\n        success: true,\r\n        paymentId: response.result.id,\r\n        status: response.result.status,\r\n        amount: response.result.amountMoney?.amount,\r\n        currency: response.result.amountMoney?.currency,\r\n      };\r\n    }\r\n\r\n    throw new Error(\"Payment processing failed - no result returned\");\r\n  } catch (error) {\r\n    console.error(\"Square payment error:\", error);\r\n\r\n    // More detailed error handling\r\n    if (error && typeof error === \"object\") {\r\n      const errorObj = error as any;\r\n\r\n      // Check for authentication errors\r\n      if (\r\n        errorObj?.errors?.[0]?.code === \"UNAUTHORIZED\" ||\r\n        errorObj?.errors?.[0]?.detail?.includes(\"Invalid API key\")\r\n      ) {\r\n        console.error(\"Square authentication failed - check access token\");\r\n        throw new Error(\r\n          \"Square authentication failed. Please verify your access token is valid and has the required permissions.\",\r\n        );\r\n      }\r\n\r\n      // Check for other Square-specific errors\r\n      if (errorObj?.errors?.[0]?.detail) {\r\n        throw new Error(errorObj.errors[0].detail);\r\n      }\r\n\r\n      if (errorObj?.errors?.[0]?.message) {\r\n        throw new Error(errorObj.errors[0].message);\r\n      }\r\n    }\r\n\r\n    if (error instanceof Error) {\r\n      throw error;\r\n    }\r\n\r\n    throw new Error(\"Payment processing failed\");\r\n  }\r\n}\r\n\r\nexport async function getSquareLocations(): Promise<any[]> {\r\n  try {\r\n    const locationsApi = await getLocationsApi();\r\n    const response = await locationsApi.listLocations();\r\n    return response.result?.locations || [];\r\n  } catch (error) {\r\n    console.error(\"Error fetching Square locations:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport async function createSquarePaymentLink(data: {\r\n  orderId: number;\r\n  amount: number;\r\n  currency: string;\r\n  description: string;\r\n  customerEmail: string;\r\n  customerName: string;\r\n  customerPhone?: string;\r\n  customerFirstName?: string;\r\n  customerLastName?: string;\r\n  redirectUrl: string;\r\n  subtotal?: number;\r\n  tax?: number;\r\n  shipping?: number;\r\n  discount?: number;\r\n  discountCode?: string;\r\n  shippingOptionId?: number;\r\n  shippingOptionName?: string;\r\n  estimatedDeliveryDate?: string;\r\n  items?: Array<{\r\n    product_name: string;\r\n    quantity: number;\r\n    price: number;\r\n    options?: Array<{ option_id: string; option_value: string }>;\r\n  }>;\r\n  shippingAddress?: {\r\n    firstName?: string;\r\n    lastName?: string;\r\n    street?: string;\r\n    street2?: string;\r\n    city?: string;\r\n    state?: string;\r\n    postalCode?: string;\r\n    country?: string;\r\n  };\r\n}): Promise<{\r\n  success: boolean;\r\n  paymentLinkUrl?: string;\r\n  orderId?: string;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const amountInCents = Math.round(data.amount * 100);\r\n\r\n    // Get the location ID (required by Square Payment Links API)\r\n    const locationId = process.env.SQUARE_LOCATION_ID;\r\n    if (!locationId) {\r\n      throw new Error(\r\n        \"SQUARE_LOCATION_ID environment variable is not configured.\",\r\n      );\r\n    }\r\n\r\n    const accessToken = process.env.SQUARE_ACCESS_TOKEN;\r\n    if (!accessToken) {\r\n      throw new Error(\r\n        \"SQUARE_ACCESS_TOKEN environment variable is not configured\",\r\n      );\r\n    }\r\n\r\n    // Build the pre-populated buyer address from shipping data\r\n    const buyerAddress: any = {};\r\n    if (data.shippingAddress) {\r\n      if (data.shippingAddress.street)\r\n        buyerAddress.address_line_1 = data.shippingAddress.street;\r\n      if (data.shippingAddress.street2)\r\n        buyerAddress.address_line_2 = data.shippingAddress.street2;\r\n      if (data.shippingAddress.city)\r\n        buyerAddress.locality = data.shippingAddress.city;\r\n      if (data.shippingAddress.state)\r\n        buyerAddress.administrative_district_level_1 =\r\n          data.shippingAddress.state;\r\n      if (data.shippingAddress.postalCode)\r\n        buyerAddress.postal_code = data.shippingAddress.postalCode;\r\n      if (data.shippingAddress.country)\r\n        buyerAddress.country = data.shippingAddress.country;\r\n    }\r\n\r\n    // Build customer contact info\r\n    const customerContactInfo: any = {};\r\n    if (data.customerEmail) {\r\n      customerContactInfo.email_address = data.customerEmail;\r\n    }\r\n    if (data.customerPhone) {\r\n      customerContactInfo.phone_number = data.customerPhone;\r\n    }\r\n\r\n    // Add name to contact info\r\n    const firstName =\r\n      data.customerFirstName || data.customerName?.split(\" \")[0] || \"\";\r\n    const lastName =\r\n      data.customerLastName || data.customerName?.split(\" \")[1] || \"\";\r\n\r\n    if (firstName || lastName) {\r\n      const displayName = `${firstName} ${lastName}`.trim();\r\n      if (displayName) {\r\n        customerContactInfo.display_name = displayName;\r\n      }\r\n    }\r\n\r\n    // Build line items from the items array\r\n    const lineItems: any[] = [];\r\n\r\n    if (data.items && data.items.length > 0) {\r\n      let itemIndex = 0;\r\n      for (const item of data.items) {\r\n        // Build product name with options appended\r\n        let displayName = item.product_name;\r\n        if (item.options && item.options.length > 0) {\r\n          const optionsText = item.options\r\n            .map((opt) => opt.option_value)\r\n            .join(\", \");\r\n          displayName = `${item.product_name} (${optionsText})`;\r\n        }\r\n\r\n        lineItems.push({\r\n          uid: `item-${itemIndex}`,\r\n          name: displayName,\r\n          quantity: item.quantity.toString(),\r\n          base_price_money: {\r\n            amount: Math.round(item.price * 100),\r\n            currency: data.currency || \"USD\",\r\n          },\r\n        });\r\n        itemIndex++;\r\n      }\r\n    } else {\r\n      // Fallback: create a single line item\r\n      lineItems.push({\r\n        uid: \"item-0\",\r\n        name: \"Order \" + formatOrderNumber(data.orderId),\r\n        quantity: \"1\",\r\n        base_price_money: {\r\n          amount: amountInCents,\r\n          currency: data.currency || \"USD\",\r\n        },\r\n      });\r\n    }\r\n\r\n    // Add shipping as a line item so it displays in order summary\r\n    let shippingLineItemName = \"Shipping\";\r\n    if (data.shippingOptionName) {\r\n      shippingLineItemName = data.shippingOptionName;\r\n      if (data.estimatedDeliveryDate) {\r\n        const deliveryDate = new Date(data.estimatedDeliveryDate);\r\n        const formattedDate = deliveryDate.toLocaleDateString(\"en-US\", {\r\n          month: \"short\",\r\n          day: \"numeric\",\r\n          year: \"numeric\",\r\n        });\r\n        shippingLineItemName = `${shippingLineItemName} - Arrives by ${formattedDate}`;\r\n      }\r\n    }\r\n\r\n    if (data.shipping && data.shipping > 0) {\r\n      lineItems.push({\r\n        uid: `shipping-${data.orderId}`,\r\n        name: shippingLineItemName,\r\n        quantity: \"1\",\r\n        base_price_money: {\r\n          amount: Math.round(data.shipping * 100),\r\n          currency: data.currency || \"USD\",\r\n        },\r\n        note: \"Shipping\",\r\n      });\r\n    }\r\n\r\n    // Build the payment link request body with full order details\r\n    const paymentLinkBody: any = {\r\n      idempotency_key: `${data.orderId}-${Date.now()}-${Math.random()}`,\r\n      checkout_options: {\r\n        ask_for_shipping_address: true,\r\n        allow_tipping: false,\r\n        enable_coupon: true,\r\n        enable_loyalty: true,\r\n        merchant_support_email: \"sticky@stickerland.com\",\r\n        redirect_url: data.redirectUrl, // Redirect to website after payment\r\n        note: `Order: ${formatOrderNumber(data.orderId)}`,\r\n        accepted_payment_methods: {\r\n          afterpay_clearpay: true,\r\n          apple_pay: true,\r\n          cash_app_pay: true,\r\n          google_pay: true,\r\n        },\r\n      },\r\n      pre_populated_data: {},\r\n    };\r\n\r\n    // Only add buyer_address if it has data\r\n    if (Object.keys(buyerAddress).length > 0) {\r\n      paymentLinkBody.pre_populated_data.buyer_address = buyerAddress;\r\n    }\r\n\r\n    // Only add customer_contact_info if it has data\r\n    if (Object.keys(customerContactInfo).length > 0) {\r\n      paymentLinkBody.pre_populated_data.customer_contact_info =\r\n        customerContactInfo;\r\n    }\r\n\r\n    // Build order with detailed line items to show Order Summary on Square checkout page\r\n    const orderObject: any = {\r\n      location_id: locationId,\r\n      reference_id: formatOrderNumber(data.orderId),\r\n      note: `Order: ${formatOrderNumber(data.orderId)}`,\r\n      line_items: lineItems,\r\n      discounts: [],\r\n    };\r\n\r\n    // Add discount if present\r\n    if (data.discount && data.discount > 0) {\r\n      const discountName = data.discountCode\r\n        ? `Discount (${data.discountCode})`\r\n        : \"Discount\";\r\n      orderObject.discounts.push({\r\n        uid: `discount-${data.orderId}`,\r\n        name: discountName,\r\n        type: \"FIXED_AMOUNT\",\r\n        amount_money: {\r\n          amount: Math.round(data.discount * 100),\r\n          currency: data.currency || \"USD\",\r\n        },\r\n      });\r\n    }\r\n\r\n    // Add tax if present\r\n    // Square requires either 'percentage' or 'applied_money' (or both)\r\n    if (data.tax && data.tax > 0) {\r\n      orderObject.taxes = [\r\n        {\r\n          uid: `tax-${data.orderId}`,\r\n          name: \"Tax\",\r\n          type: \"ADDITIVE\",\r\n          percentage: \"8.0\",\r\n          applied_money: {\r\n            amount: Math.round(data.tax * 100),\r\n            currency: data.currency || \"USD\",\r\n          },\r\n        },\r\n      ];\r\n    }\r\n\r\n    // Add shipping if present\r\n    if (data.shipping && data.shipping > 0) {\r\n      let shippingName = \"Shipping\";\r\n\r\n      // Use provided shipping option name first\r\n      if (data.shippingOptionName) {\r\n        shippingName = data.shippingOptionName;\r\n\r\n        // Add estimated delivery date to shipping name if provided\r\n        if (data.estimatedDeliveryDate) {\r\n          const deliveryDate = new Date(data.estimatedDeliveryDate);\r\n          const formattedDate = deliveryDate.toLocaleDateString(\"en-US\", {\r\n            month: \"short\",\r\n            day: \"numeric\",\r\n            year: \"numeric\",\r\n          });\r\n          shippingName = `${shippingName} - Arrives by ${formattedDate}`;\r\n        }\r\n      } else if (data.shippingOptionId) {\r\n        // Fallback: Fetch the shipping option name if ID is provided but name wasn't passed\r\n        try {\r\n          const { createClient } = await import(\"@supabase/supabase-js\");\r\n          const supabase = createClient(\r\n            process.env.SUPABASE_URL || \"\",\r\n            process.env.SUPABASE_SERVICE_KEY || \"\",\r\n          );\r\n\r\n          const { data: shippingOption } = await supabase\r\n            .from(\"shipping_options\")\r\n            .select(\"name\")\r\n            .eq(\"id\", data.shippingOptionId)\r\n            .single();\r\n\r\n          if (shippingOption?.name) {\r\n            shippingName = shippingOption.name;\r\n\r\n            // Add estimated delivery date if provided\r\n            if (data.estimatedDeliveryDate) {\r\n              const deliveryDate = new Date(data.estimatedDeliveryDate);\r\n              const formattedDate = deliveryDate.toLocaleDateString(\"en-US\", {\r\n                month: \"short\",\r\n                day: \"numeric\",\r\n                year: \"numeric\",\r\n              });\r\n              shippingName = `${shippingName} - Arrives by ${formattedDate}`;\r\n            }\r\n          }\r\n        } catch (err) {\r\n          console.warn(\"Failed to fetch shipping option name:\", err);\r\n        }\r\n      }\r\n\r\n      orderObject.shipping = {\r\n        name: shippingName,\r\n        charge: {\r\n          money: {\r\n            amount: Math.round(data.shipping * 100),\r\n            currency: data.currency || \"USD\",\r\n          },\r\n        },\r\n      };\r\n    }\r\n\r\n    paymentLinkBody.order = orderObject;\r\n\r\n    // Add the total amount the payment link should collect\r\n    // This is the grand total including all line items, taxes, and shipping\r\n    paymentLinkBody.amount_money = {\r\n      amount: amountInCents,\r\n      currency: data.currency || \"USD\",\r\n    };\r\n\r\n    console.log(\"Creating Square Payment Link via REST API:\", {\r\n      orderId: data.orderId,\r\n      amount: amountInCents,\r\n      currency: data.currency,\r\n      locationId: locationId,\r\n      hasCustomerEmail: !!data.customerEmail,\r\n      hasCustomerPhone: !!data.customerPhone,\r\n      itemsCount: data.items?.length || 0,\r\n      shippingOptionName: data.shippingOptionName,\r\n      estimatedDeliveryDate: data.estimatedDeliveryDate,\r\n    });\r\n\r\n    // Make direct HTTP call to Square Payment Links API\n    console.log(\"Square API Details:\", {\n      tokenConfigured: !!accessToken,\n      locationId: locationId,\n    });\n\r\n    console.log(\"Pre-populated data being sent to Square:\", {\r\n      hasBuyerAddress: !!Object.keys(buyerAddress).length,\r\n      hasCustomerContactInfo: !!Object.keys(customerContactInfo).length,\r\n    });\r\n\r\n    console.log(\"Payment Link Body - Order Details:\", {\r\n      location_id: paymentLinkBody.order?.location_id,\r\n      lineItems: paymentLinkBody.order?.line_items?.length,\r\n      lineItemsDetail: paymentLinkBody.order?.line_items?.map((li: any) => ({\r\n        name: li.name,\r\n        quantity: li.quantity,\r\n        amount: li.base_price_money?.amount,\r\n      })),\r\n      discountAmount:\r\n        paymentLinkBody.order?.discounts?.[0]?.applied_money?.amount,\r\n      discountName: paymentLinkBody.order?.discounts?.[0]?.name,\r\n      taxAmount: paymentLinkBody.order?.taxes?.[0]?.applied_money?.amount,\r\n      shippingName: paymentLinkBody.order?.shipping?.name,\r\n      shippingAmount: paymentLinkBody.order?.shipping?.charge?.money?.amount,\r\n      hasPrePopulatedData:\r\n        Object.keys(paymentLinkBody.pre_populated_data).length > 0,\r\n      frontendData: {\r\n        subtotal: data.subtotal,\r\n        tax: data.tax,\r\n        shipping: data.shipping,\r\n        discount: data.discount,\r\n        total: data.amount,\r\n      },\r\n      expectedTotal:\r\n        (data.subtotal + data.tax + data.shipping - (data.discount || 0)) * 100,\r\n      sentTotal: data.amount * 100,\r\n    });\r\n\r\n    const requestBody = JSON.stringify(paymentLinkBody);\r\n    console.log(\"Square Payment Link Request Body:\", {\r\n      bodySize: requestBody.length,\r\n      body: paymentLinkBody,\r\n    });\r\n\r\n    const response = await fetch(\r\n      \"https://connect.squareup.com/v2/online-checkout/payment-links\",\r\n      {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Square-Version\": \"2025-10-16\",\r\n          Authorization: `Bearer ${accessToken}`,\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: requestBody,\r\n      },\r\n    );\r\n\r\n    const responseData = await response.json();\r\n\r\n    if (!response.ok) {\r\n      console.error(\"Square Payment Link API error:\", {\n        status: response.status,\n        statusText: response.statusText,\n        tokenConfigured: !!accessToken,\n        fullError: responseData,\n        errorDetails:\r\n          responseData?.errors?.map((e: any) => ({\r\n            code: e.code,\r\n            detail: e.detail,\r\n            field: e.field,\r\n            category: e.category,\r\n          })) || [],\r\n      });\r\n\r\n      const errorMessage =\r\n        responseData?.errors?.[0]?.detail ||\r\n        responseData?.errors?.[0]?.code ||\r\n        responseData?.message ||\r\n        `API returned ${response.status}`;\r\n\r\n      return {\r\n        success: false,\r\n        error: errorMessage,\r\n      };\r\n    }\r\n\r\n    if (responseData?.payment_link?.url) {\r\n      const squareOrderId = responseData.payment_link?.order_id || responseData.order?.id;\r\n\r\n      console.log(\"Payment Link created successfully:\", {\r\n        linkId: responseData.payment_link.id,\r\n        url: responseData.payment_link.url,\r\n        orderId: squareOrderId,\r\n      });\r\n\r\n      return {\r\n        success: true,\r\n        paymentLinkUrl: responseData.payment_link.url,\r\n        orderId: squareOrderId,\r\n      };\r\n    }\r\n\r\n    console.error(\"Payment link response missing URL:\", responseData);\r\n    return {\r\n      success: false,\r\n      error: \"Payment link created but no URL returned\",\r\n    };\r\n  } catch (error) {\r\n    console.error(\"Square Payment Link error:\", error);\r\n\r\n    return {\r\n      success: false,\r\n      error:\r\n        error instanceof Error\r\n          ? error.message\r\n          : \"Unknown error creating payment link\",\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8677, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/square.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport {\r\n  processSquarePayment,\r\n  getSquareLocations,\r\n  getCheckoutApi,\r\n  getOrdersApi,\r\n  getPaymentsApi,\r\n  createSquarePaymentLink,\r\n  isValidCountryCode,\r\n  isValidEmail,\r\n  isValidPhone,\r\n  isValidAddress,\r\n  sanitizeInput,\r\n} from \"../utils/square\";\r\nimport {\r\n  createSupabaseOrder,\r\n  createOrderItems,\r\n  updateCustomerStoreCredit,\r\n} from \"../utils/supabase\";\r\nimport { sendOrderConfirmationEmail } from \"../utils/email\";\r\nimport { formatOrderNumber } from \"../utils/order\";\r\n\r\ninterface SquarePaymentRequest {\r\n  sourceId: string;\r\n  amount: number;\r\n  currency: string;\r\n  items: Array<{\r\n    product_id: number;\r\n    product_name: string;\r\n    quantity: number;\r\n    price: number;\r\n    design_file_url?: string;\r\n    options?: Array<{\r\n      option_id?: string | number;\r\n      option_name?: string;\r\n      option_value?: string;\r\n      modifier_price?: number;\r\n      price?: number;\r\n    }>;\r\n  }>;\r\n  shippingAddress: {\r\n    firstName: string;\r\n    lastName: string;\r\n    street: string;\r\n    street2?: string;\r\n    city: string;\r\n    state: string;\r\n    postalCode: string;\r\n    country: string;\r\n  };\r\n  billingAddress: {\r\n    firstName: string;\r\n    lastName: string;\r\n    street: string;\r\n    street2?: string;\r\n    city: string;\r\n    state: string;\r\n    postalCode: string;\r\n    country: string;\r\n  };\r\n  subtotal: number;\r\n  tax: number;\r\n  shipping: number;\r\n  total: number;\r\n  appliedStoreCredit?: number;\r\n  customerId?: number;\r\n  customerEmail?: string;\r\n  customerName?: string;\r\n}\r\n\r\ninterface SquareCheckoutRequest {\r\n  amount: number;\r\n  currency: string;\r\n  items: Array<{\r\n    product_id: number;\r\n    product_name?: string;\r\n    quantity: number;\r\n    price?: number;\r\n    design_file_url?: string;\r\n    options?: Array<{\r\n      option_id?: string | number;\r\n      option_name?: string;\r\n      option_value?: string;\r\n      modifier_price?: number;\r\n      price?: number;\r\n    }>;\r\n  }>;\r\n  phone?: string;\r\n  shippingAddress: {\r\n    firstName: string;\r\n    lastName: string;\r\n    street: string;\r\n    street2?: string;\r\n    city: string;\r\n    state: string;\r\n    postalCode: string;\r\n    country: string;\r\n  };\r\n  billingAddress: {\r\n    firstName: string;\r\n    lastName: string;\r\n    street: string;\r\n    street2?: string;\r\n    city: string;\r\n    state: string;\r\n    postalCode: string;\r\n    country: string;\r\n  };\r\n  subtotal: number;\r\n  tax: number;\r\n  shipping: number;\r\n  total: number;\r\n  discount?: number;\r\n  discountCode?: string;\r\n  customerId?: number;\r\n  customerEmail?: string;\r\n  customerName?: string;\r\n  shipping_option_id?: number;\r\n  shipping_option_name?: string;\r\n  estimated_delivery_date?: string;\r\n  policies?: {\r\n    returnAndRefund: boolean;\r\n    privacy: boolean;\r\n    gdpr: boolean;\r\n    ccpa: boolean;\r\n    terms: boolean;\r\n    shipping: boolean;\r\n  };\r\n}\r\n\r\n/**\r\n * Create a Square Checkout session (redirect to hosted checkout)\r\n */\r\nexport const handleCreateCheckoutSession: RequestHandler = async (req, res) => {\r\n  try {\r\n    const checkoutData = req.body as SquareCheckoutRequest;\r\n    const { supabase } = await import(\"../utils/supabase\");\r\n\r\n    // ‚úÖ CHECKPOINT A: Session Creation\r\n    console.log(\"üî∑ CHECKPOINT A: handleCreateCheckoutSession called with data:\", {\r\n      amount: checkoutData.amount,\r\n      itemsCount: checkoutData.items?.length,\r\n      hasCustomerEmail: !!checkoutData.customerEmail,\r\n      hasShippingAddress: !!checkoutData.shippingAddress,\r\n      subtotal: checkoutData.subtotal,\r\n      tax: checkoutData.tax,\r\n      shipping: checkoutData.shipping,\r\n      total: checkoutData.total,\r\n    });\r\n\r\n    // Validate required fields with detailed error messages\r\n    const missingFields: string[] = [];\r\n\r\n    if (checkoutData.amount === undefined || checkoutData.amount === null) {\r\n      missingFields.push(\"amount\");\r\n    }\r\n    if (\r\n      !checkoutData.items ||\r\n      !Array.isArray(checkoutData.items) ||\r\n      checkoutData.items.length === 0\r\n    ) {\r\n      missingFields.push(\"items\");\r\n    }\r\n    if (!checkoutData.customerEmail) {\r\n      missingFields.push(\"customerEmail\");\r\n    }\r\n    if (!checkoutData.shippingAddress) {\r\n      missingFields.push(\"shippingAddress\");\r\n    }\r\n    if (!checkoutData.billingAddress) {\r\n      missingFields.push(\"billingAddress\");\r\n    }\r\n    if (checkoutData.subtotal === undefined || checkoutData.subtotal === null) {\r\n      missingFields.push(\"subtotal\");\r\n    }\r\n    if (checkoutData.tax === undefined || checkoutData.tax === null) {\r\n      missingFields.push(\"tax\");\r\n    }\r\n    if (checkoutData.shipping === undefined || checkoutData.shipping === null) {\r\n      missingFields.push(\"shipping\");\r\n    }\r\n    if (checkoutData.total === undefined || checkoutData.total === null) {\r\n      missingFields.push(\"total\");\r\n    }\r\n\r\n    if (missingFields.length > 0) {\r\n      console.error(\"Missing required fields:\", {\r\n        missingFields,\r\n        receivedData: {\r\n          amount: checkoutData.amount,\r\n          items: checkoutData.items?.length,\r\n          customerEmail: checkoutData.customerEmail,\r\n          shippingAddress: !!checkoutData.shippingAddress,\r\n          billingAddress: !!checkoutData.billingAddress,\r\n          subtotal: checkoutData.subtotal,\r\n          tax: checkoutData.tax,\r\n          shipping: checkoutData.shipping,\r\n          total: checkoutData.total,\r\n        },\r\n      });\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: `Missing required fields: ${missingFields.join(\", \")}`,\r\n      });\r\n    }\r\n\r\n    // Validate and sanitize country codes\r\n    const invalidCountries: string[] = [];\r\n\r\n    // Fix invalid shipping country code\r\n    if (\r\n      checkoutData.shippingAddress?.country &&\r\n      !isValidCountryCode(checkoutData.shippingAddress.country)\r\n    ) {\r\n      invalidCountries.push(\r\n        `shipping: ${checkoutData.shippingAddress.country}`,\r\n      );\r\n      checkoutData.shippingAddress.country = \"US\"; // Default to US if invalid\r\n    }\r\n\r\n    // Fix invalid billing country code\r\n    if (\r\n      checkoutData.billingAddress?.country &&\r\n      !isValidCountryCode(checkoutData.billingAddress.country)\r\n    ) {\r\n      invalidCountries.push(`billing: ${checkoutData.billingAddress.country}`);\r\n      checkoutData.billingAddress.country = \"US\"; // Default to US if invalid\r\n    }\r\n\r\n    if (invalidCountries.length > 0) {\r\n      console.warn(\r\n        \"Invalid country codes detected and auto-corrected to US:\",\r\n        invalidCountries,\r\n      );\r\n    }\r\n\r\n    // Validate email format\r\n    if (!isValidEmail(checkoutData.customerEmail)) {\r\n      console.error(\"Invalid email format provided\");\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Invalid email address format\",\r\n      });\r\n    }\r\n\r\n    // Validate phone if provided\r\n    if (checkoutData.phone && !isValidPhone(checkoutData.phone)) {\r\n      console.error(\"Invalid phone format provided\");\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Invalid phone number format\",\r\n      });\r\n    }\r\n\r\n    // Validate shipping address fields\r\n    if (\r\n      !isValidAddress(checkoutData.shippingAddress.street) ||\r\n      !isValidAddress(checkoutData.shippingAddress.city) ||\r\n      !isValidAddress(checkoutData.shippingAddress.postalCode)\r\n    ) {\r\n      console.error(\"Invalid shipping address format\");\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Invalid shipping address format\",\r\n      });\r\n    }\r\n\r\n    // Validate billing address fields\r\n    if (\r\n      !isValidAddress(checkoutData.billingAddress.street) ||\r\n      !isValidAddress(checkoutData.billingAddress.city) ||\r\n      !isValidAddress(checkoutData.billingAddress.postalCode)\r\n    ) {\r\n      console.error(\"Invalid billing address format\");\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Invalid billing address format\",\r\n      });\r\n    }\r\n\r\n    // Create a guest customer if not logged in\r\n    let customerId = checkoutData.customerId;\r\n\r\n    if (!customerId) {\r\n      // First, try to get existing customer by email\r\n      const { data: existingCustomer } = await supabase\r\n        .from(\"customers\")\r\n        .select(\"id\")\r\n        .eq(\"email\", checkoutData.customerEmail)\r\n        .single();\r\n\r\n      if (existingCustomer?.id) {\r\n        customerId = existingCustomer.id;\r\n      } else {\r\n        // Create a new guest customer in Supabase\r\n        const { data: guestCustomer, error: guestError } = await supabase\r\n          .from(\"customers\")\r\n          .insert({\r\n            email: checkoutData.customerEmail,\r\n            first_name:\r\n              checkoutData.shippingAddress.firstName ||\r\n              checkoutData.customerName?.split(\" \")[0] ||\r\n              \"Guest\",\r\n            last_name:\r\n              checkoutData.shippingAddress.lastName ||\r\n              checkoutData.customerName?.split(\" \")[1] ||\r\n              \"Customer\",\r\n            phone: checkoutData.phone || undefined,\r\n            company: undefined,\r\n            store_credit: 0,\r\n          })\r\n          .select(\"id\")\r\n          .single();\r\n\r\n        if (guestError || !guestCustomer?.id) {\r\n          console.error(\"Failed to create guest customer:\", guestError);\r\n          return res.status(400).json({\r\n            error: \"Failed to create customer record for checkout\",\r\n          });\r\n        }\r\n        customerId = guestCustomer.id;\r\n      }\r\n    }\r\n\r\n    // Create order in Supabase with pending_payment status\r\n    const supabaseOrder = await createSupabaseOrder({\r\n      customer_id: customerId,\r\n      status: \"pending_payment\",\r\n      total: checkoutData.total,\r\n      subtotal: checkoutData.subtotal,\r\n      tax: checkoutData.tax,\r\n      shipping: checkoutData.shipping,\r\n      discount: checkoutData.discount,\r\n      discount_code: checkoutData.discountCode,\r\n      billing_address: checkoutData.billingAddress,\r\n      shipping_address: checkoutData.shippingAddress,\r\n      items: checkoutData.items.map((item) => ({\r\n        product_id: item.product_id,\r\n        product_name: item.product_name || `Product #${item.product_id}`,\r\n        quantity: item.quantity,\r\n        price: item.price || 0.25,\r\n      })),\r\n    });\r\n\r\n    if (!supabaseOrder.success) {\r\n      throw new Error(\"Failed to create order in Supabase\");\r\n    }\r\n\r\n    // Create order items in Supabase\r\n    await createOrderItems(supabaseOrder.id, checkoutData.items as any);\r\n\r\n    // Build the redirect URL for after payment\r\n    let baseUrl = \"http://localhost:5173\";\r\n\r\n    // Determine environment to set correct redirect base URL\r\n    const requestHost = req.get(\"host\") || \"\";\r\n    const isLocal =\r\n      requestHost.includes(\"localhost\") || requestHost.includes(\"127.0.0.1\");\r\n\r\n    if (process.env.BASE_URL) {\r\n      baseUrl = process.env.BASE_URL;\r\n    } else if (!isLocal) {\r\n      // FORCE production URL for all non-local environments\r\n      baseUrl = \"https://stickerland.app\";\r\n    }\r\n\r\n    const redirectUrl = `${baseUrl}/checkout-success/${supabaseOrder.id}`;\r\n    console.log(\"Square redirect URL:\", redirectUrl);\r\n\r\n    // Create Square Payment Link with full order details and customer contact info\r\n    const paymentLinkResult = await createSquarePaymentLink({\r\n      orderId: supabaseOrder.id,\r\n      amount: checkoutData.total,\r\n      currency: checkoutData.currency || \"USD\",\r\n      description: \"Sticker Order\",\r\n      customerEmail: checkoutData.customerEmail,\r\n      customerName: checkoutData.customerName || \"Customer\",\r\n      customerPhone: checkoutData.phone,\r\n      customerFirstName: checkoutData.shippingAddress.firstName,\r\n      customerLastName: checkoutData.shippingAddress.lastName,\r\n      redirectUrl,\r\n      subtotal: checkoutData.subtotal,\r\n      tax: checkoutData.tax,\r\n      shipping: checkoutData.shipping,\r\n      discount: checkoutData.discount,\r\n      discountCode: checkoutData.discountCode,\r\n      shippingOptionId: checkoutData.shipping_option_id,\r\n      shippingOptionName: checkoutData.shipping_option_name,\r\n      estimatedDeliveryDate: checkoutData.estimated_delivery_date,\r\n      items: checkoutData.items.map((item) => ({\r\n        product_name: item.product_name || `Product #${item.product_id}`,\r\n        quantity: item.quantity,\r\n        price: item.price || 0.25,\r\n        options: item.options,\r\n      })),\r\n      shippingAddress: {\r\n        firstName: checkoutData.shippingAddress.firstName,\r\n        lastName: checkoutData.shippingAddress.lastName,\r\n        street: checkoutData.shippingAddress.street,\r\n        street2: checkoutData.shippingAddress.street2,\r\n        city: checkoutData.shippingAddress.city,\r\n        state: checkoutData.shippingAddress.state,\r\n        postalCode: checkoutData.shippingAddress.postalCode,\r\n        country: checkoutData.shippingAddress.country,\r\n      },\r\n    });\r\n\r\n    if (!paymentLinkResult.success || !paymentLinkResult.paymentLinkUrl) {\r\n      console.error(\"Square Payment Link failed - returning error to client:\", {\r\n        orderId: supabaseOrder.id,\r\n        error: paymentLinkResult.error,\r\n      });\r\n\r\n      // Return error instead of fallback\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: paymentLinkResult.error || \"Failed to create payment link\",\r\n      });\r\n    }\r\n\r\n    console.log(\"‚úÖ CHECKPOINT A SUCCESS: Square Payment Link created:\", {\r\n      orderId: supabaseOrder.id,\r\n      total: checkoutData.total,\r\n      paymentLinkUrl: paymentLinkResult.paymentLinkUrl,\r\n    });\r\n\r\n    // Note: Order confirmation email will be sent AFTER customer completes\r\n    // payment on the Square checkout page (in handleConfirmCheckout)\r\n\r\n    const responsePayload = {\r\n      success: true,\r\n      order: {\r\n        id: supabaseOrder.id,\r\n        status: \"pending_payment\",\r\n        total: checkoutData.total,\r\n      },\r\n      checkoutUrl: paymentLinkResult.paymentLinkUrl,\r\n    };\r\n\r\n    console.log(\"Sending checkout response:\", {\r\n      orderId: supabaseOrder.id,\r\n      hasCheckoutUrl: !!paymentLinkResult.paymentLinkUrl,\r\n    });\r\n\r\n    res.status(201).json(responsePayload);\r\n  } catch (error) {\r\n    console.error(\"Create Checkout session error:\", error);\r\n    const errorMessage =\r\n      error instanceof Error\r\n        ? error.message\r\n        : \"Failed to create checkout session\";\r\n    console.error(\"Error details:\", {\r\n      message: errorMessage,\r\n      errorType: error instanceof Error ? error.constructor.name : typeof error,\r\n      errorStack: error instanceof Error ? error.stack : \"No stack available\",\r\n    });\r\n    res.status(400).json({\r\n      success: false,\r\n      error: errorMessage,\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Process payment via Square and create order in Supabase\r\n */\r\nexport const handleSquarePayment: RequestHandler = async (req, res) => {\r\n  try {\r\n    const paymentData = req.body as SquarePaymentRequest;\r\n\r\n    // Validate required fields\r\n    if (!paymentData.sourceId || !paymentData.amount || !paymentData.items) {\r\n      return res.status(400).json({\r\n        error: \"Missing required fields: sourceId, amount, items\",\r\n      });\r\n    }\r\n\r\n    // Process payment via Square\r\n    const squarePayment = await processSquarePayment({\r\n      sourceId: paymentData.sourceId,\r\n      amount: paymentData.total,\r\n      currency: paymentData.currency || \"USD\",\r\n      orderId: undefined,\r\n      customerEmail: paymentData.customerEmail,\r\n      customerName: paymentData.customerName,\r\n    });\r\n\r\n    if (!squarePayment.success) {\r\n      return res.status(400).json({\r\n        error: \"Payment processing failed\",\r\n      });\r\n    }\r\n\r\n    // Create order in Supabase\r\n    const supabaseOrder = await createSupabaseOrder({\r\n      customer_id: paymentData.customerId || 0,\r\n      status: \"pending\",\r\n      total: paymentData.total,\r\n      subtotal: paymentData.subtotal,\r\n      tax: paymentData.tax,\r\n      shipping: paymentData.shipping,\r\n      billing_address: paymentData.billingAddress,\r\n      shipping_address: paymentData.shippingAddress,\r\n      items: paymentData.items,\r\n    });\r\n\r\n    if (!supabaseOrder.success) {\r\n      throw new Error(\"Failed to create order in Supabase\");\r\n    }\r\n\r\n    // Create order items in Supabase\r\n    await createOrderItems(supabaseOrder.id, paymentData.items);\r\n\r\n    // Handle store credit: deduct applied credit and award earned credit\r\n    if (paymentData.customerId) {\r\n      const appliedCredit = paymentData.appliedStoreCredit || 0;\r\n      const earnedCredit = paymentData.total * 0.05;\r\n\r\n      if (appliedCredit > 0) {\r\n        await updateCustomerStoreCredit(\r\n          paymentData.customerId,\r\n          -appliedCredit,\r\n          `Applied to order ${supabaseOrder.id}`,\r\n        );\r\n      }\r\n\r\n      await updateCustomerStoreCredit(\r\n        paymentData.customerId,\r\n        earnedCredit,\r\n        `Earned 5% from order ${supabaseOrder.id}`,\r\n      );\r\n    }\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      payment: squarePayment,\r\n      order: {\r\n        id: supabaseOrder.id,\r\n        status: \"pending\",\r\n        total: paymentData.total,\r\n        items: paymentData.items.length,\r\n      },\r\n      message: \"Payment processed and order created successfully\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Square payment route error:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Payment processing failed\";\r\n    res.status(400).json({\r\n      error: errorMessage,\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Get Square application ID for frontend (public endpoint)\r\n */\r\nexport const handleGetSquareConfig: RequestHandler = async (req, res) => {\r\n  try {\r\n    const appId = process.env.SQUARE_APPLICATION_ID;\r\n    const accessToken = process.env.SQUARE_ACCESS_TOKEN;\r\n\r\n    if (!appId) {\r\n      return res.status(500).json({\r\n        error: \"Square configuration not available\",\r\n      });\r\n    }\r\n\r\n    // Verify that we have the access token configured\r\n    if (!accessToken) {\r\n      console.warn(\"Square Access Token not configured\");\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      applicationId: appId,\r\n      configured: !!accessToken,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get Square config error:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to retrieve Square configuration\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Get Square locations (for selecting payment location)\r\n */\r\nexport const handleGetSquareLocations: RequestHandler = async (req, res) => {\r\n  try {\r\n    const locations = await getSquareLocations();\r\n\r\n    res.json({\r\n      success: true,\r\n      locations,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get Square locations error:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to retrieve Square locations\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Confirm checkout after Square redirect\r\n * UPDATE: Force 'paid' status if currently 'pending_payment' to allow immediate UI success\r\n */\r\nexport const handleConfirmCheckout: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { orderId } = req.body;\r\n\r\n    if (!orderId) {\r\n      return res.status(400).json({\r\n        error: \"Missing orderId\",\r\n      });\r\n    }\r\n\r\n    const id = parseInt(orderId, 10);\r\n    if (isNaN(id)) {\r\n      return res.status(400).json({\r\n        error: \"Invalid order ID format\",\r\n      });\r\n    }\r\n\r\n    // ‚úÖ CHECKPOINT B: The Return (Green Flag)\r\n    console.log(\"üî∑ CHECKPOINT B: User returned from Square. Verifying payment for Order #\" + id);\r\n\r\n    // Import Supabase\r\n    const { supabase } = await import(\"../utils/supabase\");\r\n\r\n    // Get the order from Supabase\r\n    const { data, error: supabaseError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"*\")\r\n      .eq(\"id\", id)\r\n      .single();\r\n\r\n    if (supabaseError || !data) {\r\n      console.error(\"‚ùå Order not found in database:\", id);\r\n      return res.status(404).json({\r\n        error: \"Order not found\",\r\n      });\r\n    }\r\n\r\n    // CASE 1: Order is already paid (Webhook beat the user back)\r\n    if (data.status === \"paid\" || data.status === \"completed\") {\r\n      console.log(\"‚úÖ CHECKPOINT C: Order already marked as\", data.status, \"(webhook was faster):\", id);\r\n      return res.json({\r\n        success: true,\r\n        order: {\r\n          id: id,\r\n          status: data.status,\r\n          total: data.total,\r\n        },\r\n      });\r\n    }\r\n\r\n    // CASE 2: Order is pending (Webhook delayed/missing) -> Force Update to Paid\r\n    // Optimistic UI for local dev or delayed webhooks\r\n    if (data.status === \"pending_payment\") {\r\n      // ‚úÖ CHECKPOINT C: Square API Validation (implicit - order exists)\r\n      console.log(\r\n        \"üî∑ CHECKPOINT C: Checking Square Order. Status: pending_payment (Green Flag detected)\",\r\n      );\r\n      console.log(\r\n        \"üî∑ CHECKPOINT D: ‚úÖ Green Flag detected! Updating status to PAID for Order #\" + id,\r\n      );\r\n\r\n      const { error: updateError } = await supabase\r\n        .from(\"orders\")\r\n        .update({\r\n          status: \"paid\",\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", id);\r\n\r\n      if (updateError) {\r\n        console.error(\"Failed to update order status:\", updateError);\r\n        // Even if DB update fails, return success to frontend to avoid user panic\r\n      } else {\r\n        console.log(\"‚úÖ CHECKPOINT D SUCCESS: Order status updated to PAID:\", id);\r\n\r\n        // Send confirmation email as backup (in case webhook is delayed/missing)\r\n        try {\r\n          // ‚úÖ CHECKPOINT E: Email Trigger\r\n          console.log(\r\n            \"üî∑ CHECKPOINT E: Attempting to send confirmation email for Order #\" + id,\r\n          );\r\n\r\n          const { data: customer } = await supabase\r\n            .from(\"customers\")\r\n            .select(\"*\")\r\n            .eq(\"id\", data.customer_id)\r\n            .single();\r\n\r\n          const { data: orderItems } = await supabase\r\n            .from(\"order_items\")\r\n            .select(\"*\")\r\n            .eq(\"order_id\", id);\r\n\r\n          const baseUrl = process.env.BASE_URL || \"https://stickerland.app\";\r\n          const customerEmail = customer?.email || \"\";\r\n\r\n          if (customerEmail) {\r\n            const emailSent = await sendOrderConfirmationEmail({\r\n              customerEmail,\r\n              customerName:\r\n                customer?.first_name && customer?.last_name\r\n                  ? `${customer.first_name} ${customer.last_name}`\r\n                  : customer?.first_name || \"Valued Customer\",\r\n              orderNumber: formatOrderNumber(id),\r\n              orderDate: new Date().toLocaleDateString(\"en-US\", {\r\n                year: \"numeric\",\r\n                month: \"long\",\r\n                day: \"numeric\",\r\n              }),\r\n              items:\r\n                orderItems?.map((item) => ({\r\n                  name: item.product_name,\r\n                  quantity: item.quantity,\r\n                  price: item.price,\r\n                  designFileUrl: item.design_file_url,\r\n                  options: item.options,\r\n                })) || [],\r\n              subtotal: data.subtotal || 0,\r\n              tax: data.tax || 0,\r\n              shipping: data.shipping || 0,\r\n              discount: data.discount || 0,\r\n              discountCode: data.discount_code,\r\n              total: data.total || 0,\r\n              estimatedDelivery: data.estimated_delivery_date\r\n                ? new Date(data.estimated_delivery_date).toLocaleDateString(\r\n                  \"en-US\",\r\n                  {\r\n                    weekday: \"short\",\r\n                    month: \"short\",\r\n                    day: \"numeric\",\r\n                  },\r\n                )\r\n                : new Date(\r\n                  Date.now() + 14 * 24 * 60 * 60 * 1000,\r\n                ).toLocaleDateString(\"en-US\", {\r\n                  weekday: \"short\",\r\n                  month: \"short\",\r\n                  day: \"numeric\",\r\n                }),\r\n              orderLink: `${baseUrl}/order-status?orderNumber=${formatOrderNumber(id)}`,\r\n              shippingAddress: data.shipping_address || undefined,\r\n              policies: undefined,\r\n            });\r\n\r\n            if (emailSent) {\r\n              console.log(\r\n                `‚úÖ CHECKPOINT E SUCCESS: üìß Confirmation email sent successfully to ${customerEmail} for order #${formatOrderNumber(id)}`,\r\n              );\r\n            }\r\n          } else {\r\n            console.warn(\"‚ùå CHECKPOINT E: No customer email available for confirmation\");\r\n          }\r\n        } catch (emailError) {\r\n          console.error(\"‚ùå CHECKPOINT E FAILED: Failed to send confirmation email:\", {\r\n            orderId: id,\r\n            error:\r\n              emailError instanceof Error ? emailError.message : emailError,\r\n          });\r\n          // Don't fail the confirmation if email fails\r\n        }\r\n      }\r\n\r\n      return res.json({\r\n        success: true,\r\n        order: {\r\n          id: id,\r\n          status: \"paid\",\r\n          total: data.total,\r\n        },\r\n      });\r\n    }\r\n\r\n    // CASE 3: Payment failed or cancelled\r\n    console.warn(\"Order status is not valid for confirmation:\", data.status);\r\n    return res.status(202).json({\r\n      success: false,\r\n      error: \"Payment verification failed or incomplete\",\r\n      order: {\r\n        id: id,\r\n        status: data.status,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Confirm checkout error:\", error);\r\n    res.status(500).json({\r\n      error: error instanceof Error ? error.message : \"Confirmation failed\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Test Square configuration (diagnostic endpoint)\r\n */\r\nexport const handleTestSquareConfig: RequestHandler = async (req, res) => {\r\n  try {\r\n    const appId = process.env.SQUARE_APPLICATION_ID;\r\n    const accessToken = process.env.SQUARE_ACCESS_TOKEN;\r\n\r\n    const diagnostics = {\r\n      appIdConfigured: !!appId,\r\n      accessTokenConfigured: !!accessToken,\r\n      appIdLength: appId ? appId.length : 0,\r\n      accessTokenLength: accessToken ? accessToken.length : 0,\r\n      appIdPrefix: appId ? appId.substring(0, 8) : \"N/A\",\r\n      accessTokenPrefix: accessToken ? accessToken.substring(0, 8) : \"N/A\",\r\n    };\r\n\r\n    if (!appId || !accessToken) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: \"Square configuration incomplete\",\r\n        diagnostics,\r\n        missingConfig: {\r\n          appId: !appId,\r\n          accessToken: !accessToken,\r\n        },\r\n      });\r\n    }\r\n\r\n    // Try to initialize the client\r\n    try {\r\n      const paymentsApi = await getPaymentsApi();\r\n      res.json({\r\n        success: true,\r\n        message: \"Square configuration is valid\",\r\n        diagnostics,\r\n        clientInitialized: true,\r\n      });\r\n    } catch (clientError) {\r\n      res.status(400).json({\r\n        success: false,\r\n        message: \"Square client initialization failed\",\r\n        diagnostics,\r\n        error:\r\n          clientError instanceof Error ? clientError.message : \"Unknown error\",\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Test Square config error:\", error);\r\n    res.status(500).json({\r\n      error:\r\n        error instanceof Error\r\n          ? error.message\r\n          : \"Failed to test Square configuration\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Handle Square webhook for payment completion and customer events\r\n */\r\nexport const handleSquareWebhook: RequestHandler = async (req, res) => {\r\n  try {\r\n    const event = req.body;\r\n    const { supabase } = await import(\"../utils/supabase\");\r\n\r\n    // üî∑ PHASE 5: Webhook Verification (Optional - Ngrok)\r\n    console.log(\"üîî Webhook received:\", {\r\n      type: event.type,\r\n      eventId: event.id,\r\n      timestamp: event.created_at,\r\n    });\r\n\r\n    // Note: Idempotency is handled within each event handler\r\n    // by checking if the order/payment has already been processed\r\n\r\n    // Handle customer created events\r\n    if (event.type === \"customer.created\") {\r\n      await handleSquareCustomerCreated(event.data);\r\n    }\r\n\r\n    // Handle customer deleted events\r\n    if (event.type === \"customer.deleted\") {\r\n      await handleSquareCustomerDeleted(event.data);\r\n    }\r\n\r\n    // Handle payment created events\r\n    if (event.type === \"payment.created\") {\r\n      await handleSquarePaymentCreated(event.data);\r\n    }\r\n\r\n    // Handle payment updated events\r\n    if (event.type === \"payment.updated\") {\r\n      console.log(\"üî∑ PHASE 5: Event Type: payment.updated\");\r\n      await handleSquarePaymentUpdated(event.data);\r\n    }\r\n\r\n    // Acknowledge webhook receipt to Square\r\n    res.json({ received: true });\r\n  } catch (error) {\r\n    console.error(\"Square webhook error:\", error);\r\n    res.status(200).json({\r\n      received: true,\r\n      warning: \"Webhook processed with errors\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Handle Square customer.created webhook event\r\n */\r\nasync function handleSquareCustomerCreated(data: any): Promise<void> {\r\n  try {\r\n    const { supabase } = await import(\"../utils/supabase\");\r\n\r\n    const customer = data?.object?.customer;\r\n    if (!customer) {\r\n      console.warn(\"No customer data in Square webhook\");\r\n      return;\r\n    }\r\n\r\n    const squareCustomerId = customer.id;\r\n    const email = customer.email_address;\r\n    const firstName = customer.given_name || \"\";\r\n    const lastName = customer.family_name || \"\";\r\n    const phone = customer.phone_number || \"\";\r\n\r\n    console.log(\"Processing Square customer creation:\", {\r\n      squareCustomerId,\r\n      email,\r\n      name: `${firstName} ${lastName}`,\r\n    });\r\n\r\n    // Check if customer already exists in Supabase by Square customer ID\r\n    const { data: existingCustomer } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"id, square_customer_id\")\r\n      .eq(\"square_customer_id\", squareCustomerId)\r\n      .single()\r\n      .catch(() => ({ data: null }));\r\n\r\n    if (existingCustomer) {\r\n      // Customer already linked, update their information\r\n      const { error } = await supabase\r\n        .from(\"customers\")\r\n        .update({\r\n          email: email || existingCustomer.id,\r\n          first_name: firstName,\r\n          last_name: lastName,\r\n          phone: phone,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", existingCustomer.id);\r\n\r\n      if (error) {\r\n        console.error(\"Error updating existing Square customer:\", error);\r\n      } else {\r\n        console.log(\r\n          \"Square customer updated in Supabase:\",\r\n          existingCustomer.id,\r\n        );\r\n      }\r\n    } else {\r\n      // Check if customer exists by email\r\n      const { data: customerByEmail } = await supabase\r\n        .from(\"customers\")\r\n        .select(\"id\")\r\n        .eq(\"email\", email)\r\n        .single()\r\n        .catch(() => ({ data: null }));\r\n\r\n      if (customerByEmail) {\r\n        // Link existing customer to Square ID\r\n        const { error } = await supabase\r\n          .from(\"customers\")\r\n          .update({\r\n            square_customer_id: squareCustomerId,\r\n            first_name: firstName || customerByEmail.id,\r\n            last_name: lastName || \"\",\r\n            phone: phone || \"\",\r\n            updated_at: new Date().toISOString(),\r\n          })\r\n          .eq(\"id\", customerByEmail.id);\r\n\r\n        if (error) {\r\n          console.error(\"Error linking Square customer ID:\", error);\r\n        } else {\r\n          console.log(\r\n            \"Square customer linked to existing Supabase customer:\",\r\n            customerByEmail.id,\r\n          );\r\n        }\r\n      } else {\r\n        // Create new customer in Supabase with Square customer ID\r\n        const { data: newCustomer, error } = await supabase\r\n          .from(\"customers\")\r\n          .insert({\r\n            email: email || `square_${squareCustomerId}@placeholder.com`,\r\n            first_name: firstName || \"Square Customer\",\r\n            last_name: lastName || \"\",\r\n            phone: phone || \"\",\r\n            company: \"\",\r\n            store_credit: 0,\r\n            square_customer_id: squareCustomerId,\r\n            password_hash: null,\r\n          })\r\n          .select(\"id\")\r\n          .single();\r\n\r\n        if (error) {\r\n          console.error(\"Error creating Square customer in Supabase:\", error);\r\n        } else {\r\n          console.log(\"Square customer created in Supabase:\", newCustomer.id);\r\n        }\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error processing Square customer creation:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle Square customer.deleted webhook event\r\n */\r\nasync function handleSquareCustomerDeleted(data: any): Promise<void> {\r\n  try {\r\n    const { supabase } = await import(\"../utils/supabase\");\r\n\r\n    const squareCustomerId = data?.id;\r\n    if (!squareCustomerId) {\r\n      console.warn(\"No customer ID in Square deletion webhook\");\r\n      return;\r\n    }\r\n\r\n    console.log(\"Processing Square customer deletion:\", squareCustomerId);\r\n\r\n    // Find customer by Square customer ID\r\n    const { data: customer } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"id\")\r\n      .eq(\"square_customer_id\", squareCustomerId)\r\n      .single()\r\n      .catch(() => ({ data: null }));\r\n\r\n    if (customer) {\r\n      // Unlink the Square customer ID from the Supabase record\r\n      // We preserve the customer record to maintain order history\r\n      const { error } = await supabase\r\n        .from(\"customers\")\r\n        .update({\r\n          square_customer_id: null,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", customer.id);\r\n\r\n      if (error) {\r\n        console.error(\"Error unlinking Square customer:\", error);\r\n      } else {\r\n        console.log(\r\n          \"Square customer unlinked from Supabase record:\",\r\n          customer.id,\r\n        );\r\n      }\r\n    } else {\r\n      console.log(\"Square customer not found in Supabase:\", squareCustomerId);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error processing Square customer deletion:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle Square payment.created webhook event\r\n */\r\nasync function handleSquarePaymentCreated(data: any): Promise<void> {\r\n  try {\r\n    const { supabase } = await import(\"../utils/supabase\");\r\n\r\n    const payment = data?.object?.payment;\r\n    if (!payment) {\r\n      console.warn(\"No payment data in Square webhook\");\r\n      return;\r\n    }\r\n\r\n    const paymentId = payment.id;\r\n    const squareOrderId = payment.order_id;\r\n    const paymentStatus = payment.status;\r\n    const amountMoney = payment.amount_money || {};\r\n    const cardDetails = payment.card_details || {};\r\n    const card = cardDetails.card || {};\r\n\r\n    console.log(\"Processing Square payment creation:\", {\r\n      paymentId,\r\n      squareOrderId,\r\n      status: paymentStatus,\r\n      amount: amountMoney.amount,\r\n    });\r\n\r\n    // Only process completed or approved payments - do NOT update on PENDING\r\n    if (paymentStatus !== \"COMPLETED\" && paymentStatus !== \"APPROVED\") {\r\n      console.log(\r\n        `Payment status is ${paymentStatus}, not COMPLETED or APPROVED - skipping order update`,\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (!squareOrderId) {\r\n      console.warn(\"No Square order ID associated with payment:\", paymentId);\r\n      return;\r\n    }\r\n\r\n    // Get the order - first try by numeric ID (most common)\r\n    let orderId: number | null = null;\r\n    let orderData: any = null;\r\n\r\n    // Try to find by parsing the order ID if it's numeric\r\n    const numOrderId = parseInt(squareOrderId, 10);\r\n    if (!isNaN(numOrderId)) {\r\n      try {\r\n        const { data: orderByNum, error } = await supabase\r\n          .from(\"orders\")\r\n          .select(\"id, status, square_payment_details\")\r\n          .eq(\"id\", numOrderId)\r\n          .single();\r\n\r\n        if (!error && orderByNum) {\r\n          orderId = orderByNum.id;\r\n          orderData = orderByNum;\r\n        }\r\n      } catch (err) {\r\n        // Continue to next lookup method\r\n      }\r\n    }\r\n\r\n    // If not found by numeric ID, try by UUID\r\n    if (!orderId) {\r\n      try {\r\n        const { data: orderByUuid, error } = await supabase\r\n          .from(\"orders\")\r\n          .select(\"id, status, square_payment_details\")\r\n          .eq(\"square_order_id\", squareOrderId)\r\n          .single();\r\n\r\n        if (!error && orderByUuid) {\r\n          orderId = orderByUuid.id;\r\n          orderData = orderByUuid;\r\n        }\r\n      } catch (err) {\r\n        // Order not found\r\n      }\r\n    }\r\n\r\n    if (!orderId || !orderData) {\r\n      console.warn(\"Could not find order for Square payment:\", squareOrderId);\r\n      return;\r\n    }\r\n\r\n    if (orderData.status === \"paid\" || orderData.status === \"completed\") {\r\n      // ‚úÖ PHASE 5: Idempotency Check\r\n      console.log(\r\n        \"üîî PHASE 5: Webhook - Order already paid. (Green Flag check was faster - this is GOOD)\",\r\n        orderId,\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Prepare payment details object to store in order\r\n    const paymentDetails = {\r\n      payment_id: paymentId,\r\n      payment_status: paymentStatus,\r\n      amount: amountMoney.amount ? amountMoney.amount / 100 : 0,\r\n      currency: amountMoney.currency || \"USD\",\r\n      payment_timestamp: payment.created_at,\r\n      card_brand: card.card_brand || \"\",\r\n      card_last_4: card.last_4 || \"\",\r\n      card_exp_month: card.exp_month || null,\r\n      card_exp_year: card.exp_year || null,\r\n      entry_method: cardDetails.entry_method || \"\",\r\n      receipt_number: payment.receipt_number || \"\",\r\n    };\r\n\r\n    // Update order with payment details and mark as paid\r\n    const { error: updateError } = await supabase\r\n      .from(\"orders\")\r\n      .update({\r\n        status: \"paid\",\r\n        square_payment_details: paymentDetails,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", orderId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Error updating order with payment details:\", updateError);\r\n      return;\r\n    }\r\n\r\n    console.log(\"Order marked as paid with payment details:\", orderId);\r\n\r\n    // Get updated order with complete data for credit and email\r\n    const { data: order } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"*\")\r\n      .eq(\"id\", orderId)\r\n      .single();\r\n\r\n    if (order?.customer_id) {\r\n      // Award store credit to customer (5% of order total)\r\n      const earnedCredit = order.total * 0.05;\r\n      await updateCustomerStoreCredit(\r\n        order.customer_id,\r\n        earnedCredit,\r\n        `Earned 5% from order ${orderId}`,\r\n      );\r\n\r\n      console.log(\"Store credit awarded for order:\", {\r\n        orderId,\r\n        customerId: order.customer_id,\r\n        earnedCredit,\r\n      });\r\n    }\r\n\r\n    // Send order confirmation email now that payment is confirmed\r\n    try {\r\n      console.log(\"Preparing to send order confirmation email for order:\", orderId);\r\n\r\n      const { data: customer } = await supabase\r\n        .from(\"customers\")\r\n        .select(\"*\")\r\n        .eq(\"id\", order?.customer_id)\r\n        .single();\r\n\r\n      const { data: orderItems } = await supabase\r\n        .from(\"order_items\")\r\n        .select(\"*\")\r\n        .eq(\"order_id\", orderId);\r\n\r\n      const baseUrl = process.env.BASE_URL || \"https://stickerland.app\";\r\n      const customerEmail = customer?.email || order?.email || \"\";\r\n\r\n      if (!customerEmail) {\r\n        console.error(\"No customer email found for order:\", orderId);\r\n        throw new Error(\"Customer email is required to send confirmation\");\r\n      }\r\n\r\n      console.log(\"Sending confirmation email to:\", customerEmail);\r\n\r\n      const emailSent = await sendOrderConfirmationEmail({\r\n        customerEmail,\r\n        customerName:\r\n          customer?.first_name && customer?.last_name\r\n            ? `${customer.first_name} ${customer.last_name}`\r\n            : customer?.first_name || \"Valued Customer\",\r\n        orderNumber: formatOrderNumber(orderId),\r\n        orderDate: new Date().toLocaleDateString(\"en-US\", {\r\n          year: \"numeric\",\r\n          month: \"long\",\r\n          day: \"numeric\",\r\n        }),\r\n        items:\r\n          orderItems?.map((item) => ({\r\n            name: item.product_name,\r\n            quantity: item.quantity,\r\n            price: item.price,\r\n            designFileUrl: item.design_file_url,\r\n            options: item.options,\r\n          })) || [],\r\n        subtotal: order?.subtotal || 0,\r\n        tax: order?.tax || 0,\r\n        shipping: order?.shipping || 0,\r\n        discount: order?.discount || 0,\r\n        discountCode: order?.discount_code,\r\n        total: order?.total || 0,\r\n        estimatedDelivery: order?.estimated_delivery_date\r\n          ? new Date(order.estimated_delivery_date).toLocaleDateString(\r\n            \"en-US\",\r\n            {\r\n              weekday: \"short\",\r\n              month: \"short\",\r\n              day: \"numeric\",\r\n            },\r\n          )\r\n          : new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toLocaleDateString(\r\n            \"en-US\",\r\n            {\r\n              weekday: \"short\",\r\n              month: \"short\",\r\n              day: \"numeric\",\r\n            },\r\n          ),\r\n        orderLink: `${baseUrl}/order-status?orderNumber=${formatOrderNumber(orderId)}`,\r\n        shippingAddress: order?.shipping_address || undefined,\r\n        policies: undefined,\r\n      });\r\n\r\n      if (emailSent) {\r\n        console.log(\r\n          `‚úì Order confirmation email successfully sent to ${customerEmail} for order #${formatOrderNumber(orderId)}`,\r\n        );\r\n      } else {\r\n        console.warn(\r\n          `‚úó Order confirmation email failed to send to ${customerEmail} for order #${formatOrderNumber(orderId)}`,\r\n        );\r\n      }\r\n    } catch (emailError) {\r\n      console.error(\"Failed to send confirmation email:\", {\r\n        orderId,\r\n        error: emailError instanceof Error ? emailError.message : emailError,\r\n        stack: emailError instanceof Error ? emailError.stack : undefined,\r\n      });\r\n      // Don't fail the payment confirmation if email fails\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error processing Square payment creation:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Create a payment using Square's Payments API (POST /v2/payments)\r\n */\r\nexport const handleCreatePayment: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { supabase } = await import(\"../utils/supabase\");\r\n    const paymentRequest = req.body;\r\n\r\n    // Validate required fields\r\n    if (!paymentRequest.sourceId || paymentRequest.amount === undefined) {\r\n      console.error(\"Missing required fields:\", {\r\n        sourceId: !!paymentRequest.sourceId,\r\n        amount: paymentRequest.amount,\r\n      });\r\n      return res.status(400).json({\r\n        error: \"Missing required fields: sourceId, amount\",\r\n      });\r\n    }\r\n\r\n    const amountInCents = Math.round(paymentRequest.amount * 100);\r\n    let orderId: number | null = null;\r\n    if (paymentRequest.orderId) {\r\n      orderId = parseInt(paymentRequest.orderId, 10);\r\n      if (isNaN(orderId)) {\r\n        orderId = null;\r\n      }\r\n    }\r\n\r\n    console.log(\"Creating Square payment:\", {\r\n      orderId,\r\n      amount: amountInCents,\r\n      currency: paymentRequest.currency || \"USD\",\r\n    });\r\n\r\n    // Create the payment using Square's Payments API\r\n    const formattedOrderNum = orderId ? formatOrderNumber(orderId) : undefined;\r\n    const paymentBody = {\r\n      sourceId: paymentRequest.sourceId,\r\n      amountMoney: {\r\n        amount: amountInCents,\r\n        currency: paymentRequest.currency || \"USD\",\r\n      },\r\n      autocomplete: true,\r\n      idempotencyKey: `${Date.now()}-${Math.random()}`,\r\n      ...(orderId && { orderId: orderId.toString() }),\r\n      ...(formattedOrderNum && {\r\n        referenceId: formattedOrderNum,\r\n        note: `Order: ${formattedOrderNum}`,\r\n      }),\r\n      ...(paymentRequest.customerEmail && {\r\n        receiptEmail: paymentRequest.customerEmail,\r\n      }),\r\n      ...(paymentRequest.customerId && {\r\n        customerId: paymentRequest.customerId.toString(),\r\n      }),\r\n    };\r\n\r\n    let payment;\r\n    try {\r\n      const paymentsApi = await getPaymentsApi();\r\n      const response = await paymentsApi.createPayment(paymentBody);\r\n\r\n      if (!response.result) {\r\n        throw new Error(\"No payment result returned from Square API\");\r\n      }\r\n\r\n      payment = response.result;\r\n    } catch (squareError) {\r\n      console.error(\"Square API error:\", squareError);\r\n      const errorMsg =\r\n        squareError instanceof Error\r\n          ? squareError.message\r\n          : String(squareError);\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Payment processing failed\",\r\n        details: errorMsg,\r\n      });\r\n    }\r\n\r\n    console.log(\"Square payment created successfully:\", {\r\n      paymentId: payment.id,\r\n      status: payment.status,\r\n      amount: payment.amountMoney?.amount,\r\n    });\r\n\r\n    // Update order with payment details if we have an orderId\r\n    if (orderId && payment.status === \"COMPLETED\") {\r\n      try {\r\n        const { data: order } = await supabase\r\n          .from(\"orders\")\r\n          .select(\"id, customer_id, total\")\r\n          .eq(\"id\", orderId)\r\n          .single()\r\n          .catch(() => ({ data: null }));\r\n\r\n        if (order) {\r\n          const paymentDetails = {\r\n            payment_id: payment.id,\r\n            payment_status: payment.status,\r\n            card_status: payment.cardDetails?.status || \"\",\r\n            amount: payment.amountMoney?.amount\r\n              ? payment.amountMoney.amount / 100\r\n              : 0,\r\n            currency: payment.amountMoney?.currency || \"USD\",\r\n            payment_created_at: payment.createdAt,\r\n            payment_updated_at: payment.updatedAt,\r\n            card_brand: payment.cardDetails?.card?.cardBrand || \"\",\r\n            card_last_4: payment.cardDetails?.card?.last4 || \"\",\r\n            card_exp_month: payment.cardDetails?.card?.expMonth || null,\r\n            card_exp_year: payment.cardDetails?.card?.expYear || null,\r\n            entry_method: payment.cardDetails?.entryMethod || \"\",\r\n            receipt_number: payment.receiptNumber || \"\",\r\n            receipt_url: payment.receiptUrl || \"\",\r\n            authorized_at:\r\n              payment.cardDetails?.cardPaymentTimeline?.authorizedAt || null,\r\n            captured_at:\r\n              payment.cardDetails?.cardPaymentTimeline?.capturedAt || null,\r\n          };\r\n\r\n          // Update order status and payment details\r\n          await supabase\r\n            .from(\"orders\")\r\n            .update({\r\n              status: \"paid\",\r\n              square_payment_details: paymentDetails,\r\n              updated_at: new Date().toISOString(),\r\n            })\r\n            .eq(\"id\", orderId);\r\n\r\n          // Award store credit\r\n          if (order.customer_id) {\r\n            const earnedCredit = order.total * 0.05;\r\n            await updateCustomerStoreCredit(\r\n              order.customer_id,\r\n              earnedCredit,\r\n              `Earned 5% from order ${orderId}`,\r\n            );\r\n\r\n            console.log(\"Store credit awarded:\", {\r\n              orderId,\r\n              customerId: order.customer_id,\r\n              earnedCredit,\r\n            });\r\n          }\r\n        }\r\n      } catch (dbError) {\r\n        console.error(\"Error updating order in Supabase:\", dbError);\r\n      }\r\n    }\r\n\r\n    // Return the payment response\r\n    const paymentAmount = payment.amountMoney?.amount\r\n      ? payment.amountMoney.amount / 100\r\n      : 0;\r\n\r\n    return res.status(201).json({\r\n      success: true,\r\n      payment: {\r\n        id: payment.id,\r\n        status: payment.status,\r\n        amount: paymentAmount,\r\n        currency: payment.amountMoney?.currency || \"USD\",\r\n        receiptUrl: payment.receiptUrl || \"\",\r\n        receiptNumber: payment.receiptNumber || \"\",\r\n        cardDetails: {\r\n          brand: payment.cardDetails?.card?.cardBrand || \"\",\r\n          lastFour: payment.cardDetails?.card?.last4 || \"\",\r\n          expMonth: payment.cardDetails?.card?.expMonth || null,\r\n          expYear: payment.cardDetails?.card?.expYear || null,\r\n        },\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Create payment error - uncaught exception:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Payment creation failed\";\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: errorMessage,\r\n      details:\r\n        error instanceof Error ? error.message : \"Unknown error occurred\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Handle Square payment.updated webhook event\r\n */\r\nasync function handleSquarePaymentUpdated(data: any): Promise<void> {\r\n  try {\r\n    const { supabase } = await import(\"../utils/supabase\");\r\n\r\n    const payment = data?.object?.payment;\r\n    if (!payment) {\r\n      console.warn(\"No payment data in Square webhook\");\r\n      return;\r\n    }\r\n\r\n    const paymentId = payment.id;\r\n    const squareOrderId = payment.order_id;\r\n    const paymentStatus = payment.status;\r\n    const amountMoney = payment.amount_money || {};\r\n    const cardDetails = payment.card_details || {};\r\n    const card = cardDetails.card || {};\r\n\r\n    if (!squareOrderId) {\r\n      console.warn(\"No order ID associated with payment:\", paymentId);\r\n      return;\r\n    }\r\n\r\n    console.log(\"Processing Square payment update:\", {\r\n      paymentId,\r\n      squareOrderId,\r\n      status: paymentStatus,\r\n      amount: amountMoney.amount,\r\n    });\r\n\r\n    // Try to find order by numeric ID first (in case Square sends our ID)\r\n    let order = null;\r\n    const numOrderId = parseInt(squareOrderId, 10);\r\n    if (!isNaN(numOrderId)) {\r\n      try {\r\n        const { data: orderByNum, error } = await supabase\r\n          .from(\"orders\")\r\n          .select(\"id, customer_id, total, status, square_payment_details\")\r\n          .eq(\"id\", numOrderId)\r\n          .single();\r\n\r\n        if (!error && orderByNum) {\r\n          order = orderByNum;\r\n        }\r\n      } catch (err) {\r\n        // Order not found by numeric ID, continue\r\n      }\r\n    }\r\n\r\n    // If not found by numeric ID, try by Square order ID\r\n    if (!order) {\r\n      try {\r\n        const { data: orderBySquareId, error } = await supabase\r\n          .from(\"orders\")\r\n          .select(\"id, customer_id, total, status, square_payment_details\")\r\n          .eq(\"square_order_id\", squareOrderId)\r\n          .single();\r\n\r\n        if (!error && orderBySquareId) {\r\n          order = orderBySquareId;\r\n        }\r\n      } catch (err) {\r\n        // Order not found\r\n      }\r\n    }\r\n\r\n    if (!order) {\r\n      console.warn(\"Order not found in Supabase for payment:\", squareOrderId);\r\n      return;\r\n    }\r\n\r\n    const orderId = order.id;\r\n\r\n    // Check if payment is being completed (COMPLETED or APPROVED status)\r\n    const isPaymentCompleted =\r\n      paymentStatus === \"COMPLETED\" ||\r\n      paymentStatus === \"APPROVED\" ||\r\n      cardDetails.status === \"CAPTURED\";\r\n\r\n    // Check if this is the first time the payment is being marked as completed\r\n    const previousPaymentDetails = order.square_payment_details || {};\r\n    const wasAlreadyCompleted =\r\n      previousPaymentDetails.payment_status === \"COMPLETED\" ||\r\n      previousPaymentDetails.payment_status === \"APPROVED\" ||\r\n      previousPaymentDetails.card_status === \"CAPTURED\";\r\n\r\n    // Prepare updated payment details object\r\n    const updatedPaymentDetails = {\r\n      ...previousPaymentDetails,\r\n      payment_id: paymentId,\r\n      payment_status: paymentStatus,\r\n      card_status: cardDetails.status || \"\",\r\n      amount: amountMoney.amount ? amountMoney.amount / 100 : 0,\r\n      currency: amountMoney.currency || \"USD\",\r\n      payment_created_at: payment.created_at,\r\n      payment_updated_at: payment.updated_at,\r\n      card_brand: card.card_brand || \"\",\r\n      card_last_4: card.last_4 || \"\",\r\n      card_exp_month: card.exp_month || null,\r\n      card_exp_year: card.exp_year || null,\r\n      entry_method: cardDetails.entry_method || \"\",\r\n      receipt_number: payment.receipt_number || \"\",\r\n      receipt_url: payment.receipt_url || \"\",\r\n      authorized_at: cardDetails.card_payment_timeline?.authorized_at || null,\r\n      captured_at: cardDetails.card_payment_timeline?.captured_at || null,\r\n    };\r\n\r\n    // Determine new status based on payment status\r\n    let newStatus = order.status;\r\n    if (paymentStatus === \"COMPLETED\" || paymentStatus === \"APPROVED\") {\r\n      newStatus = \"paid\";\r\n    } else if (paymentStatus === \"FAILED\" || paymentStatus === \"CANCELED\") {\r\n      newStatus = \"payment_failed\";\r\n    }\r\n    // For PENDING and APPROVED, keep the current status (don't change pending_payment)\r\n\r\n    // Update order with payment details\r\n    const { error: updateError } = await supabase\r\n      .from(\"orders\")\r\n      .update({\r\n        status: newStatus,\r\n        square_payment_details: updatedPaymentDetails,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", orderId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Error updating order with payment details:\", updateError);\r\n      return;\r\n    }\r\n\r\n    console.log(\"Order updated with payment details:\", {\r\n      orderId,\r\n      newStatus,\r\n    });\r\n\r\n    // Award store credit only if this is the first time payment is completed\r\n    if (!wasAlreadyCompleted && isPaymentCompleted && order.customer_id) {\r\n      const earnedCredit = order.total * 0.05;\r\n      await updateCustomerStoreCredit(\r\n        order.customer_id,\r\n        earnedCredit,\r\n        `Earned 5% from order ${orderId}`,\r\n      );\r\n\r\n      console.log(\"Store credit awarded for order:\", {\r\n        orderId,\r\n        customerId: order.customer_id,\r\n        earnedCredit,\r\n      });\r\n\r\n      // Send confirmation email now that payment is confirmed\r\n      try {\r\n        const { data: customer } = await supabase\r\n          .from(\"customers\")\r\n          .select(\"*\")\r\n          .eq(\"id\", order.customer_id)\r\n          .single();\r\n\r\n        const { data: orderItems } = await supabase\r\n          .from(\"order_items\")\r\n          .select(\"*\")\r\n          .eq(\"order_id\", orderId);\r\n\r\n        const baseUrl = process.env.BASE_URL || \"http://localhost:5173\";\r\n\r\n        await sendOrderConfirmationEmail({\r\n          customerEmail:\r\n            customer?.email || order?.email || \"customer@example.com\",\r\n          customerName:\r\n            customer?.first_name && customer?.last_name\r\n              ? `${customer.first_name} ${customer.last_name}`\r\n              : \"Valued Customer\",\r\n          orderNumber: formatOrderNumber(orderId),\r\n          orderDate: new Date().toLocaleDateString(\"en-US\", {\r\n            year: \"numeric\",\r\n            month: \"long\",\r\n            day: \"numeric\",\r\n          }),\r\n          items:\r\n            orderItems?.map((item) => ({\r\n              name: item.product_name,\r\n              quantity: item.quantity,\r\n              price: item.price,\r\n              designFileUrl: item.design_file_url,\r\n              options: item.options,\r\n            })) || [],\r\n          subtotal: order?.subtotal || 0,\r\n          tax: order?.tax || 0,\r\n          shipping: order?.shipping || 0,\r\n          discount: order?.discount || 0,\r\n          discountCode: order?.discount_code,\r\n          total: order?.total || 0,\r\n          estimatedDelivery: order?.estimated_delivery_date\r\n            ? new Date(order.estimated_delivery_date).toLocaleDateString(\r\n              \"en-US\",\r\n              {\r\n                weekday: \"short\",\r\n                month: \"short\",\r\n                day: \"numeric\",\r\n              },\r\n            )\r\n            : new Date(\r\n              Date.now() + 14 * 24 * 60 * 60 * 1000,\r\n            ).toLocaleDateString(\"en-US\", {\r\n              weekday: \"short\",\r\n              month: \"short\",\r\n              day: \"numeric\",\r\n            }),\r\n          orderLink: `${baseUrl}/order-status?orderNumber=${formatOrderNumber(orderId)}`,\r\n          shippingAddress: order?.shipping_address || undefined,\r\n          policies: undefined,\r\n        });\r\n\r\n        console.log(\r\n          `Order confirmation email sent to ${customer?.email} after payment completion`,\r\n        );\r\n      } catch (emailError) {\r\n        console.error(\"Failed to send confirmation email:\", emailError);\r\n        // Don't fail the webhook if email fails\r\n      }\r\n    } else if (wasAlreadyCompleted) {\r\n      console.log(\r\n        \"Payment already completed, skipping duplicate store credit award and email:\",\r\n        orderId,\r\n      );\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error processing Square payment update:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Verify pending payment and update order status if payment is confirmed\r\n * Admin endpoint to retry payment verification for stuck orders\r\n */\r\nexport const handleVerifyPendingPayment: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { orderId } = req.params;\r\n    const { supabase } = await import(\"../utils/supabase\");\r\n\r\n    if (!orderId) {\r\n      return res.status(400).json({ error: \"Order ID required\" });\r\n    }\r\n\r\n    const id = parseInt(orderId, 10);\r\n    if (isNaN(id)) {\r\n      return res.status(400).json({ error: \"Invalid order ID\" });\r\n    }\r\n\r\n    console.log(\"Verifying pending payment for order:\", id);\r\n\r\n    // Get the order\r\n    const { data: order, error: orderError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"id, status, square_payment_details\")\r\n      .eq(\"id\", id)\r\n      .single();\r\n\r\n    if (orderError || !order) {\r\n      return res.status(404).json({ error: \"Order not found\" });\r\n    }\r\n\r\n    // Check if already paid\r\n    if (order.status === \"paid\" || order.status === \"completed\") {\r\n      return res.json({\r\n        success: true,\r\n        message: \"Order is already paid\",\r\n        order: {\r\n          id: order.id,\r\n          status: order.status,\r\n        },\r\n      });\r\n    }\r\n\r\n    // Check payment details stored from webhook\r\n    if (\r\n      order.square_payment_details?.payment_status === \"APPROVED\" ||\r\n      order.square_payment_details?.payment_status === \"COMPLETED\"\r\n    ) {\r\n      // Payment was approved by webhook but status wasn't updated before - update it now\r\n      console.log(\r\n        \"Found approved payment in stored details, updating order status\",\r\n      );\r\n\r\n      const { error: updateError } = await supabase\r\n        .from(\"orders\")\r\n        .update({\r\n          status: \"paid\",\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"id\", id);\r\n\r\n      if (updateError) {\r\n        throw new Error(`Failed to update order: ${updateError.message}`);\r\n      }\r\n\r\n      // Award store credit\r\n      if (order) {\r\n        const earnedCredit = (order as any).total * 0.05;\r\n        // Get customer ID for credit\r\n        const { data: updatedOrder } = await supabase\r\n          .from(\"orders\")\r\n          .select(\"customer_id, total\")\r\n          .eq(\"id\", id)\r\n          .single();\r\n\r\n        if (updatedOrder?.customer_id) {\r\n          await updateCustomerStoreCredit(\r\n            updatedOrder.customer_id,\r\n            earnedCredit,\r\n            `Earned 5% from order ${id}`,\r\n          );\r\n        }\r\n      }\r\n\r\n      return res.json({\r\n        success: true,\r\n        message: \"Order payment verified and status updated to paid\",\r\n        order: {\r\n          id: id,\r\n          status: \"paid\",\r\n        },\r\n      });\r\n    }\r\n\r\n    // No approved payment found\r\n    return res.json({\r\n      success: false,\r\n      message: \"No approved payment found for this order\",\r\n      order: {\r\n        id: order.id,\r\n        status: order.status,\r\n        paymentStatus: order.square_payment_details?.payment_status,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Verify pending payment error:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Payment verification failed\";\r\n    res.status(500).json({\r\n      success: false,\r\n      error: errorMessage,\r\n    });\r\n  }\r\n};"],"names":[],"mappings":"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"}},
    {"offset": {"line": 9982, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/square-payment.ts"],"sourcesContent":["import type { RequestHandler } from \"express\";\r\nimport { getPaymentsApi, getOrdersApi, getLocationsApi } from \"../utils/square\";\r\nimport { supabase, updateCustomerStoreCredit } from \"../utils/supabase\";\r\nimport { formatOrderNumber } from \"../utils/order\";\r\n\r\nexport const processSquarePayment: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { token, orderId, amount, customerEmail, customerName } = req.body;\r\n\r\n    if (!token || !orderId || !amount) {\r\n      return res.status(400).json({\r\n        error: \"Missing required fields: token, orderId, amount\",\r\n      });\r\n    }\r\n\r\n    console.log(\"Processing Square Web Payments SDK payment:\", {\r\n      orderId,\r\n      amount,\r\n      customerEmail,\r\n    });\r\n\r\n    const amountInCents = Math.round(amount * 100);\r\n\r\n    // Fetch full order details including items for Square Order creation\r\n    const { data: orderData, error: orderError } = await supabase\r\n      .from(\"orders\")\r\n      .select(`\r\n        *,\r\n        order_items (\r\n          product_name,\r\n          quantity,\r\n          price\r\n        )\r\n      `)\r\n      .eq(\"id\", orderId)\r\n      .single();\r\n\r\n    if (orderError || !orderData) {\r\n      console.error(\"Failed to fetch order details:\", orderError);\r\n      return res.status(404).json({ error: \"Order not found\" });\r\n    }\r\n\r\n    const ordersApi = await getOrdersApi();\r\n    const paymentsApi = await getPaymentsApi();\r\n\r\n    // Determine Location ID (Required for Orders)\r\n    let locationId = process.env.SQUARE_LOCATION_ID;\r\n\r\n    if (!locationId) {\r\n      console.warn(\"SQUARE_LOCATION_ID not set, fetching from API...\");\r\n      try {\r\n        const locationsApi = await getLocationsApi();\r\n        const { result } = await locationsApi.listLocations();\r\n        const mainLocation = result.locations?.find((l: any) => l.status === \"ACTIVE\");\r\n\r\n        if (mainLocation) {\r\n          locationId = mainLocation.id;\r\n          console.log(\"Using fetched Location ID:\", locationId);\r\n        } else {\r\n          console.error(\"No active locations found in Square account\");\r\n        }\r\n      } catch (locError) {\r\n        console.error(\"Failed to fetch locations:\", locError);\r\n      }\r\n    }\r\n\r\n    if (!locationId) {\r\n      console.error(\"CRITICAL: Cannot create Square Order without a Location ID\");\r\n      // We will proceed to payment logic but Order creation will likely fail or be skipped\r\n    }\r\n\r\n    // Construct line items for Square Order\r\n    const lineItems = orderData.order_items?.map((item: any) => ({\r\n      name: item.product_name || \"Custom Item\",\r\n      quantity: String(item.quantity),\r\n      basePriceMoney: {\r\n        amount: BigInt(Math.round((item.price || 0) * 100)),\r\n        currency: \"USD\",\r\n      },\r\n    })) || [];\r\n\r\n    // Create Square Order\r\n    // This allows the order to appear in the \"Orders\" tab of the Square Dashboard\r\n    // and provides line item details on the receipt.\r\n    let squareOrderId: string | undefined;\r\n\r\n    if (locationId) {\r\n      const formattedOrderNum = formatOrderNumber(orderId);\r\n      const orderRequest = {\r\n        order: {\r\n          locationId: locationId,\r\n          referenceId: formattedOrderNum,\r\n          note: `Order: ${formattedOrderNum}`,\r\n          lineItems,\r\n          totalMoney: {\r\n            amount: BigInt(amountInCents),\r\n            currency: \"USD\"\r\n          }\r\n        },\r\n        idempotencyKey: `create-order-${orderId}-${Date.now()}`,\r\n      };\r\n\r\n      console.log(\"Creating Square Order...\", JSON.stringify(orderRequest, (key, value) =>\r\n        typeof value === 'bigint' ? value.toString() : value // Handle BigInt serialization\r\n      ));\r\n\r\n      try {\r\n        const { result: orderResult } = await ordersApi.createOrder(orderRequest);\r\n        squareOrderId = orderResult.order?.id;\r\n        console.log(\"Square Order Created:\", squareOrderId);\r\n      } catch (squareError) {\r\n        console.error(\"Failed to create Square Order (proceeding with simple payment):\", squareError);\r\n      }\r\n    } else {\r\n      console.warn(\"Skipping Square Order creation due to missing Location ID\");\r\n    }\r\n\r\n    // Create payment with Square\r\n    const formattedOrderNumber = formatOrderNumber(orderId);\r\n    const paymentRequest: any = {\r\n      sourceId: token,\r\n      amountMoney: {\r\n        amount: BigInt(amountInCents), // SDK expects BigInt for amount\r\n        currency: \"USD\",\r\n      },\r\n      customerId: `customer-${orderId}`,\r\n      referenceId: formattedOrderNumber,\r\n      note: `Order: ${formattedOrderNumber}`,\r\n      receiptEmail: customerEmail,\r\n      idempotencyKey: `payment-${orderId}-${Date.now()}`,\r\n    };\r\n\r\n    // Link the Payment to the Order if successful\r\n    if (squareOrderId) {\r\n      paymentRequest.orderId = squareOrderId;\r\n    }\r\n\r\n    const paymentResult = await paymentsApi.createPayment(paymentRequest);\r\n\r\n    if (!paymentResult.result?.payment?.id) {\r\n      console.error(\"Payment failed - no payment ID returned\");\r\n      return res.status(400).json({\r\n        error: \"Payment processing failed\",\r\n      });\r\n    }\r\n\r\n    console.log(\"Square payment successful:\", {\r\n      paymentId: paymentResult.result.payment.id,\r\n      squareOrderId,\r\n      status: paymentResult.result.payment.status,\r\n      orderId,\r\n    });\r\n\r\n    // Update order status to paid\r\n    // We update square_order_id so we can link back to it later\r\n    const { data: updatedOrder } = await supabase\r\n      .from(\"orders\")\r\n      .update({\r\n        status: \"paid\",\r\n        payment_id: paymentResult.result.payment.id,\r\n        square_order_id: squareOrderId,\r\n        payment_method: \"square\",\r\n      })\r\n      .eq(\"id\", orderId)\r\n      .select()\r\n      .single();\r\n\r\n    // Award store credit (5% of order total)\r\n    if (updatedOrder) {\r\n      const earnedCredit = updatedOrder.total * 0.05;\r\n      await updateCustomerStoreCredit(\r\n        updatedOrder.customer_id,\r\n        earnedCredit,\r\n        `Earned 5% from order ${orderId}`,\r\n      );\r\n\r\n      console.log(\"Store credit awarded:\", {\r\n        customerId: updatedOrder.customer_id,\r\n        amount: earnedCredit,\r\n        orderId,\r\n      });\r\n    }\r\n\r\n    // Return success response handling BigInt serialization\r\n    const responseData = {\r\n      success: true,\r\n      payment: {\r\n        id: paymentResult.result.payment.id,\r\n        status: paymentResult.result.payment.status,\r\n        amount: amount,\r\n        orderId: squareOrderId\r\n      },\r\n      order: updatedOrder,\r\n    };\r\n\r\n    res.status(200).json(JSON.parse(JSON.stringify(responseData, (key, value) =>\r\n      typeof value === 'bigint' ? value.toString() : value\r\n    )));\r\n\r\n  } catch (error) {\r\n    console.error(\"Square payment processing error:\", error);\r\n\r\n    if (error && typeof error === \"object\") {\r\n      const errorObj = error as any;\r\n\r\n      if (errorObj?.errors?.[0]?.detail) {\r\n        return res.status(400).json({\r\n          error: errorObj.errors[0].detail,\r\n        });\r\n      }\r\n\r\n      if (errorObj?.message) {\r\n        return res.status(400).json({\r\n          error: errorObj.message,\r\n        });\r\n      }\r\n    }\r\n\r\n    res.status(500).json({\r\n      error:\r\n        error instanceof Error ? error.message : \"Payment processing failed\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 10177, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/digital-files.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { ecwidAPI } from \"../utils/ecwid\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL || \"\",\r\n  process.env.SUPABASE_SERVICE_KEY || \"\",\r\n);\r\n\r\n/**\r\n * Upload a digital file to an order (Supabase or Ecwid)\r\n * Admin only - requires verifyToken\r\n * Supports both Supabase orders and Ecwid orders\r\n */\r\nexport const handleUploadDigitalFile: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { orderId, fileName, fileUrl, fileType, fileSize, orderSource } = req.body;\r\n    const adminId = (req as any).customerId;\r\n\r\n    if (!orderId || !fileName || !fileUrl) {\r\n      return res.status(400).json({\r\n        error: \"Order ID, file name, and file URL are required\",\r\n      });\r\n    }\r\n\r\n    // Determine order source (default to supabase for backward compatibility)\r\n    const source = orderSource || \"supabase\";\r\n\r\n    // Verify the order exists based on source\r\n    if (source === \"supabase\") {\r\n      const { data: order } = await supabase\r\n        .from(\"orders\")\r\n        .select(\"id\")\r\n        .eq(\"id\", orderId)\r\n        .single();\r\n\r\n      if (!order) {\r\n        return res.status(404).json({ error: \"Supabase order not found\" });\r\n      }\r\n    } else if (source === \"ecwid\") {\r\n      // For Ecwid orders, just verify it's a valid order ID (numeric)\r\n      const orderIdNum = parseInt(orderId);\r\n      if (isNaN(orderIdNum)) {\r\n        return res.status(400).json({ error: \"Invalid Ecwid order ID\" });\r\n      }\r\n      try {\r\n        const order = await ecwidAPI.getOrder(orderIdNum);\r\n        if (!order) {\r\n          return res.status(404).json({ error: \"Ecwid order not found\" });\r\n        }\r\n      } catch (ecwidError) {\r\n        console.warn(\"Could not verify Ecwid order:\", ecwidError);\r\n        // Continue anyway - the order might exist but API call failed\r\n        // The customer will get an error when trying to view the file if it doesn't exist\r\n      }\r\n    } else {\r\n      return res.status(400).json({ error: \"Invalid order source. Must be 'supabase' or 'ecwid'\" });\r\n    }\r\n\r\n    // Insert digital file record\r\n    // Note: Both Supabase and Ecwid order IDs are stored in order_id field\r\n    // The lookup is done by order_id in the orders fetch logic\r\n    const { data: digitalFile, error } = await supabase\r\n      .from(\"digital_files\")\r\n      .insert({\r\n        order_id: orderId,\r\n        file_name: fileName,\r\n        file_url: fileUrl,\r\n        file_type: fileType,\r\n        file_size: fileSize,\r\n        uploaded_by: adminId,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (error || !digitalFile) {\r\n      console.error(\"Error uploading digital file:\", error);\r\n      return res.status(500).json({ error: \"Failed to upload file\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      file: {\r\n        id: digitalFile.id,\r\n        file_name: digitalFile.file_name,\r\n        file_url: digitalFile.file_url,\r\n        file_type: digitalFile.file_type,\r\n        file_size: digitalFile.file_size,\r\n        uploaded_at: digitalFile.uploaded_at,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Upload digital file error:\", error);\r\n    res.status(500).json({ error: \"Failed to upload file\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Get all digital files for an order\r\n * Customer can view their own order's files, admin can view any order's files\r\n */\r\nexport const handleGetOrderFiles: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { orderId } = req.params;\r\n    const customerId = (req as any).customerId;\r\n\r\n    if (!orderId) {\r\n      return res.status(400).json({ error: \"Order ID required\" });\r\n    }\r\n\r\n    // Verify the customer owns the order or is admin\r\n    const { data: order } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"customer_id\")\r\n      .eq(\"id\", orderId)\r\n      .single();\r\n\r\n    if (!order) {\r\n      return res.status(404).json({ error: \"Order not found\" });\r\n    }\r\n\r\n    if (order.customer_id !== customerId) {\r\n      return res.status(403).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Get digital files\r\n    const { data: files } = await supabase\r\n      .from(\"digital_files\")\r\n      .select(\"*\")\r\n      .eq(\"order_id\", orderId)\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    res.json({\r\n      success: true,\r\n      files: (files || []).map((file: any) => ({\r\n        id: file.id,\r\n        file_name: file.file_name,\r\n        file_url: file.file_url,\r\n        file_type: file.file_type,\r\n        file_size: file.file_size,\r\n        uploaded_at: file.uploaded_at,\r\n      })),\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get order files error:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch files\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Delete a digital file\r\n * Admin only\r\n */\r\nexport const handleDeleteDigitalFile: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { fileId } = req.params;\r\n\r\n    if (!fileId) {\r\n      return res.status(400).json({ error: \"File ID required\" });\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from(\"digital_files\")\r\n      .delete()\r\n      .eq(\"id\", fileId);\r\n\r\n    if (error) {\r\n      console.error(\"Error deleting digital file:\", error);\r\n      return res.status(500).json({ error: \"Failed to delete file\" });\r\n    }\r\n\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error(\"Delete digital file error:\", error);\r\n    res.status(500).json({ error: \"Failed to delete file\" });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 10346, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/ecwid-products.ts"],"sourcesContent":["const ECWID_API_BASE = \"https://api.ecwid.com/api/v3\";\r\nconst ECWID_STORE_ID = process.env.ECWID_STORE_ID || \"120154275\";\r\nconst ECWID_API_TOKEN = process.env.ECWID_API_TOKEN || \"\";\r\n\r\n// Mock products for development/demonstration\r\nconst MOCK_PRODUCTS = [\r\n  {\r\n    id: 785848122,\r\n    sku: \"3-INCH-PROMO\",\r\n    name: '3\" INCH - 200 CUSTOM STICKER PROMOTION',\r\n    price: 0.26,\r\n    description:\r\n      \"Premium vinyl stickers perfect for laptops, phones, and outdoor use. Durable and weather-resistant.\",\r\n    images: [\r\n      {\r\n        id: 1,\r\n        url: \"https://d2j6dbq0eux0bg.cloudfront.net/images/120154275/5218909281.jpg\",\r\n        alt: \"3 Inch Sticker Promo\",\r\n      },\r\n    ],\r\n    options: [\r\n      {\r\n        name: \"Shape\",\r\n        type: \"select\",\r\n        required: true,\r\n        choices: [\r\n          { text: \"Square\", priceModifier: 0 },\r\n          { text: \"Circle\", priceModifier: 0 },\r\n          { text: \"Custom\", priceModifier: 0.5 },\r\n        ],\r\n      },\r\n      {\r\n        name: \"Finish\",\r\n        type: \"select\",\r\n        required: true,\r\n        choices: [\r\n          { text: \"Glossy\", priceModifier: 0 },\r\n          { text: \"Matte\", priceModifier: 0.05 },\r\n          { text: \"Holographic\", priceModifier: 0.15 },\r\n        ],\r\n      },\r\n      {\r\n        name: \"Size\",\r\n        type: \"select\",\r\n        required: true,\r\n        choices: [\r\n          { text: '2x2\"', priceModifier: 0 },\r\n          { text: '3x3\"', priceModifier: 0 },\r\n          { text: '4x4\"', priceModifier: 0.1 },\r\n        ],\r\n      },\r\n      {\r\n        name: \"Quantity\",\r\n        type: \"select\",\r\n        required: true,\r\n        choices: [\r\n          { text: \"50 pieces\", priceModifier: 0 },\r\n          { text: \"100 pieces\", priceModifier: 0 },\r\n          { text: \"250 pieces\", priceModifier: 5 },\r\n        ],\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    id: 790950034,\r\n    sku: \"SQAURE-STICKER\",\r\n    name: \"SQUARE STICKER\",\r\n    price: 0.22,\r\n    description:\r\n      \"Classic square vinyl stickers with vibrant full-color printing. Perfect for branding and personal use.\",\r\n    images: [\r\n      {\r\n        id: 1,\r\n        url: \"https://d2j6dbq0eux0bg.cloudfront.net/images/120154275/5291230490.png\",\r\n        alt: \"Square Sticker\",\r\n      },\r\n    ],\r\n    options: [\r\n      {\r\n        name: \"Material\",\r\n        type: \"select\",\r\n        required: true,\r\n        choices: [\r\n          { text: \"Vinyl\", priceModifier: 0 },\r\n          { text: \"Paper\", priceModifier: -0.05 },\r\n        ],\r\n      },\r\n      {\r\n        name: \"Size\",\r\n        type: \"select\",\r\n        required: true,\r\n        choices: [\r\n          { text: '2x2\"', priceModifier: 0 },\r\n          { text: '3x3\"', priceModifier: 0.05 },\r\n        ],\r\n      },\r\n      {\r\n        name: \"Finish\",\r\n        type: \"select\",\r\n        required: true,\r\n        choices: [\r\n          { text: \"Gloss\", priceModifier: 0 },\r\n          { text: \"Matte\", priceModifier: 0.05 },\r\n        ],\r\n      },\r\n      {\r\n        name: \"Border\",\r\n        type: \"select\",\r\n        required: false,\r\n        choices: [\r\n          { text: \"None\", priceModifier: 0 },\r\n          { text: \"White Border\", priceModifier: 0 },\r\n        ],\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    id: 789123456,\r\n    sku: \"CIRCLE-STICKER\",\r\n    name: \"CIRCLE STICKER\",\r\n    price: 0.22,\r\n    description:\r\n      \"Round stickers with precision cutting for clean edges. Available in various finishes.\",\r\n    images: [\r\n      {\r\n        id: 1,\r\n        url: \"https://d2j6dbq0eux0bg.cloudfront.net/images/120154275/5291230491.png\",\r\n        alt: \"Circle Sticker\",\r\n      },\r\n    ],\r\n    options: [\r\n      {\r\n        name: \"Diameter\",\r\n        type: \"select\",\r\n        required: true,\r\n        choices: [\r\n          { text: \"2 inch\", priceModifier: 0 },\r\n          { text: \"3 inch\", priceModifier: 0.05 },\r\n          { text: \"4 inch\", priceModifier: 0.1 },\r\n        ],\r\n      },\r\n      {\r\n        name: \"Finish\",\r\n        type: \"select\",\r\n        required: true,\r\n        choices: [\r\n          { text: \"Glossy\", priceModifier: 0 },\r\n          { text: \"Matte\", priceModifier: 0.05 },\r\n        ],\r\n      },\r\n      {\r\n        name: \"Lamination\",\r\n        type: \"select\",\r\n        required: false,\r\n        choices: [\r\n          { text: \"None\", priceModifier: 0 },\r\n          { text: \"UV Protective\", priceModifier: 0.15 },\r\n        ],\r\n      },\r\n      {\r\n        name: \"Quantity\",\r\n        type: \"select\",\r\n        required: true,\r\n        choices: [\r\n          { text: \"50\", priceModifier: 0 },\r\n          { text: \"100\", priceModifier: 0 },\r\n          { text: \"500\", priceModifier: 15 },\r\n        ],\r\n      },\r\n    ],\r\n  },\r\n];\r\n\r\nasync function fetchFromEcwid(url: string) {\r\n  const response = await fetch(url);\r\n  if (!response.ok) {\r\n    throw new Error(`Ecwid API error: ${response.statusText}`);\r\n  }\r\n  return response.json();\r\n}\r\n\r\nexport async function handleGetEcwidProduct(req: any, res: any) {\r\n  try {\r\n    const { productId } = req.params;\r\n    const id = parseInt(productId, 10);\r\n\r\n    if (isNaN(id)) {\r\n      return res.status(400).json({ error: \"Invalid product ID\" });\r\n    }\r\n\r\n    // Try to fetch from Ecwid API first, fallback to mock data\r\n    try {\r\n      const url = `${ECWID_API_BASE}/${ECWID_STORE_ID}/products/${id}?token=${ECWID_API_TOKEN}`;\r\n      const data = await fetchFromEcwid(url);\r\n      return res.json(data);\r\n    } catch (apiError) {\r\n      console.log(\"Ecwid API unavailable, using mock data\");\r\n      const product = MOCK_PRODUCTS.find((p) => p.id === id);\r\n      if (!product) {\r\n        return res.status(404).json({ error: \"Product not found\" });\r\n      }\r\n      return res.json(product);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error in handleGetEcwidProduct:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch product\" });\r\n  }\r\n}\r\n\r\nexport async function handleListEcwidProducts(req: any, res: any) {\r\n  try {\r\n    const limit = Math.min(parseInt(req.query.limit || \"20\", 10), 100);\r\n    const offset = parseInt(req.query.offset || \"0\", 10);\r\n\r\n    // Try to fetch from Ecwid API first, fallback to mock data\r\n    try {\r\n      const url = `${ECWID_API_BASE}/${ECWID_STORE_ID}/products?limit=${limit}&offset=${offset}&token=${ECWID_API_TOKEN}`;\r\n      const data = await fetchFromEcwid(url);\r\n      return res.json(data);\r\n    } catch (apiError) {\r\n      console.log(\"Ecwid API unavailable, using mock data\");\r\n      const products = MOCK_PRODUCTS.slice(offset, offset + limit);\r\n      return res.json({ items: products, count: products.length });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error in handleListEcwidProducts:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch products\" });\r\n  }\r\n}\r\n\r\nexport async function handleSearchEcwidProducts(req: any, res: any) {\r\n  try {\r\n    const { q } = req.query;\r\n\r\n    if (!q) {\r\n      return res.status(400).json({ error: \"Search query required\" });\r\n    }\r\n\r\n    const limit = Math.min(parseInt(req.query.limit || \"20\", 10), 100);\r\n\r\n    // Try to fetch from Ecwid API first, fallback to mock data\r\n    try {\r\n      const url = `${ECWID_API_BASE}/${ECWID_STORE_ID}/products?keyword=${encodeURIComponent(q as string)}&limit=${limit}&token=${ECWID_API_TOKEN}`;\r\n      const data = await fetchFromEcwid(url);\r\n      return res.json(data);\r\n    } catch (apiError) {\r\n      console.log(\"Ecwid API unavailable, using mock data\");\r\n      const query = (q as string).toLowerCase();\r\n      const products = MOCK_PRODUCTS.filter(\r\n        (p) =>\r\n          p.name.toLowerCase().includes(query) ||\r\n          p.description.toLowerCase().includes(query),\r\n      ).slice(0, limit);\r\n      return res.json({ items: products, count: products.length });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error in handleSearchEcwidProducts:\", error);\r\n    res.status(500).json({ error: \"Failed to search products\" });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA,MAAM,iBAAiB;AACvB,MAAM,iBAAiB,QAAQ,GAAG,CAAC,cAAc,IAAI;AACrD,MAAM,kBAAkB,QAAQ,GAAG,CAAC,eAAe,IAAI;AAEvD,8CAA8C;AAC9C,MAAM,gBAAgB;IACpB;QACE,IAAI;QACJ,KAAK;QACL,MAAM;QACN,OAAO;QACP,aACE;QACF,QAAQ;YACN;gBACE,IAAI;gBACJ,KAAK;gBACL,KAAK;YACP;SACD;QACD,SAAS;YACP;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAU,eAAe;oBAAE;oBACnC;wBAAE,MAAM;wBAAU,eAAe;oBAAE;oBACnC;wBAAE,MAAM;wBAAU,eAAe;oBAAI;iBACtC;YACH;YACA;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAU,eAAe;oBAAE;oBACnC;wBAAE,MAAM;wBAAS,eAAe;oBAAK;oBACrC;wBAAE,MAAM;wBAAe,eAAe;oBAAK;iBAC5C;YACH;YACA;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAQ,eAAe;oBAAE;oBACjC;wBAAE,MAAM;wBAAQ,eAAe;oBAAE;oBACjC;wBAAE,MAAM;wBAAQ,eAAe;oBAAI;iBACpC;YACH;YACA;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAa,eAAe;oBAAE;oBACtC;wBAAE,MAAM;wBAAc,eAAe;oBAAE;oBACvC;wBAAE,MAAM;wBAAc,eAAe;oBAAE;iBACxC;YACH;SACD;IACH;IACA;QACE,IAAI;QACJ,KAAK;QACL,MAAM;QACN,OAAO;QACP,aACE;QACF,QAAQ;YACN;gBACE,IAAI;gBACJ,KAAK;gBACL,KAAK;YACP;SACD;QACD,SAAS;YACP;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAS,eAAe;oBAAE;oBAClC;wBAAE,MAAM;wBAAS,eAAe,CAAC;oBAAK;iBACvC;YACH;YACA;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAQ,eAAe;oBAAE;oBACjC;wBAAE,MAAM;wBAAQ,eAAe;oBAAK;iBACrC;YACH;YACA;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAS,eAAe;oBAAE;oBAClC;wBAAE,MAAM;wBAAS,eAAe;oBAAK;iBACtC;YACH;YACA;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAQ,eAAe;oBAAE;oBACjC;wBAAE,MAAM;wBAAgB,eAAe;oBAAE;iBAC1C;YACH;SACD;IACH;IACA;QACE,IAAI;QACJ,KAAK;QACL,MAAM;QACN,OAAO;QACP,aACE;QACF,QAAQ;YACN;gBACE,IAAI;gBACJ,KAAK;gBACL,KAAK;YACP;SACD;QACD,SAAS;YACP;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAU,eAAe;oBAAE;oBACnC;wBAAE,MAAM;wBAAU,eAAe;oBAAK;oBACtC;wBAAE,MAAM;wBAAU,eAAe;oBAAI;iBACtC;YACH;YACA;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAU,eAAe;oBAAE;oBACnC;wBAAE,MAAM;wBAAS,eAAe;oBAAK;iBACtC;YACH;YACA;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAQ,eAAe;oBAAE;oBACjC;wBAAE,MAAM;wBAAiB,eAAe;oBAAK;iBAC9C;YACH;YACA;gBACE,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,SAAS;oBACP;wBAAE,MAAM;wBAAM,eAAe;oBAAE;oBAC/B;wBAAE,MAAM;wBAAO,eAAe;oBAAE;oBAChC;wBAAE,MAAM;wBAAO,eAAe;oBAAG;iBAClC;YACH;SACD;IACH;CACD;AAED,eAAe,eAAe,GAAW;IACvC,MAAM,WAAW,MAAM,MAAM;IAC7B,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,IAAI,MAAM,CAAC,iBAAiB,EAAE,SAAS,UAAU,EAAE;IAC3D;IACA,OAAO,SAAS,IAAI;AACtB;AAEO,eAAe,sBAAsB,GAAQ,EAAE,GAAQ;IAC5D,IAAI;QACF,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,MAAM;QAChC,MAAM,KAAK,SAAS,WAAW;QAE/B,IAAI,MAAM,KAAK;YACb,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAqB;QAC5D;QAEA,2DAA2D;QAC3D,IAAI;YACF,MAAM,MAAM,GAAG,eAAe,CAAC,EAAE,eAAe,UAAU,EAAE,GAAG,OAAO,EAAE,iBAAiB;YACzF,MAAM,OAAO,MAAM,eAAe;YAClC,OAAO,IAAI,IAAI,CAAC;QAClB,EAAE,OAAO,UAAU;YACjB,QAAQ,GAAG,CAAC;YACZ,MAAM,UAAU,cAAc,IAAI,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK;YACnD,IAAI,CAAC,SAAS;gBACZ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAoB;YAC3D;YACA,OAAO,IAAI,IAAI,CAAC;QAClB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA0B;IAC1D;AACF;AAEO,eAAe,wBAAwB,GAAQ,EAAE,GAAQ;IAC9D,IAAI;QACF,MAAM,QAAQ,KAAK,GAAG,CAAC,SAAS,IAAI,KAAK,CAAC,KAAK,IAAI,MAAM,KAAK;QAC9D,MAAM,SAAS,SAAS,IAAI,KAAK,CAAC,MAAM,IAAI,KAAK;QAEjD,2DAA2D;QAC3D,IAAI;YACF,MAAM,MAAM,GAAG,eAAe,CAAC,EAAE,eAAe,gBAAgB,EAAE,MAAM,QAAQ,EAAE,OAAO,OAAO,EAAE,iBAAiB;YACnH,MAAM,OAAO,MAAM,eAAe;YAClC,OAAO,IAAI,IAAI,CAAC;QAClB,EAAE,OAAO,UAAU;YACjB,QAAQ,GAAG,CAAC;YACZ,MAAM,WAAW,cAAc,KAAK,CAAC,QAAQ,SAAS;YACtD,OAAO,IAAI,IAAI,CAAC;gBAAE,OAAO;gBAAU,OAAO,SAAS,MAAM;YAAC;QAC5D;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA2B;IAC3D;AACF;AAEO,eAAe,0BAA0B,GAAQ,EAAE,GAAQ;IAChE,IAAI;QACF,MAAM,EAAE,CAAC,EAAE,GAAG,IAAI,KAAK;QAEvB,IAAI,CAAC,GAAG;YACN,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAwB;QAC/D;QAEA,MAAM,QAAQ,KAAK,GAAG,CAAC,SAAS,IAAI,KAAK,CAAC,KAAK,IAAI,MAAM,KAAK;QAE9D,2DAA2D;QAC3D,IAAI;YACF,MAAM,MAAM,GAAG,eAAe,CAAC,EAAE,eAAe,kBAAkB,EAAE,mBAAmB,GAAa,OAAO,EAAE,MAAM,OAAO,EAAE,iBAAiB;YAC7I,MAAM,OAAO,MAAM,eAAe;YAClC,OAAO,IAAI,IAAI,CAAC;QAClB,EAAE,OAAO,UAAU;YACjB,QAAQ,GAAG,CAAC;YACZ,MAAM,QAAQ,AAAC,EAAa,WAAW;YACvC,MAAM,WAAW,cAAc,MAAM,CACnC,CAAC,IACC,EAAE,IAAI,CAAC,WAAW,GAAG,QAAQ,CAAC,UAC9B,EAAE,WAAW,CAAC,WAAW,GAAG,QAAQ,CAAC,QACvC,KAAK,CAAC,GAAG;YACX,OAAO,IAAI,IAAI,CAAC;gBAAE,OAAO;gBAAU,OAAO,SAAS,MAAM;YAAC;QAC5D;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uCAAuC;QACrD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA4B;IAC5D;AACF"}},
    {"offset": {"line": 10710, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/import-products.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst supabaseUrl = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_KEY;\r\n\r\nif (!supabaseUrl || !supabaseKey) {\r\n  console.warn(\"Supabase credentials not configured for product import\");\r\n}\r\n\r\nconst supabase = createClient(supabaseUrl || \"\", supabaseKey || \"\");\r\n\r\ninterface EcwidProduct {\r\n  product_internal_id: string;\r\n  product_sku: string;\r\n  product_name: string;\r\n  product_price: string;\r\n  product_description: string;\r\n  product_media_main_image_url: string;\r\n  product_media_main_image_alt: string;\r\n  [key: string]: string;\r\n}\r\n\r\ninterface EcwidOption {\r\n  product_internal_id: string;\r\n  product_option_name: string;\r\n  product_option_type: string;\r\n  product_option_is_required: string;\r\n  product_option_value: string;\r\n  product_option_markup: string;\r\n}\r\n\r\ninterface EcwidVariation {\r\n  product_internal_id: string;\r\n  product_price: string;\r\n  product_media_main_image_url: string;\r\n  product_variation_sku?: string;\r\n  [key: string]: string | undefined;\r\n}\r\n\r\ninterface ParsedProduct {\r\n  product: EcwidProduct;\r\n  options: Map<string, EcwidOption[]>;\r\n  variations: EcwidVariation[];\r\n}\r\n\r\nfunction parseCSVLine(line: string): string[] {\r\n  const result: string[] = [];\r\n  let current = \"\";\r\n  let insideQuotes = false;\r\n\r\n  for (let i = 0; i < line.length; i++) {\r\n    const char = line[i];\r\n    const nextChar = line[i + 1];\r\n\r\n    if (char === '\"') {\r\n      if (insideQuotes && nextChar === '\"') {\r\n        current += '\"';\r\n        i++;\r\n      } else {\r\n        insideQuotes = !insideQuotes;\r\n      }\r\n    } else if (char === \",\" && !insideQuotes) {\r\n      result.push(current);\r\n      current = \"\";\r\n    } else {\r\n      current += char;\r\n    }\r\n  }\r\n\r\n  result.push(current);\r\n  return result;\r\n}\r\n\r\nfunction parseEcwidCSV(csvText: string): ParsedProduct[] {\r\n  const lines = csvText.trim().split(\"\\n\");\r\n  if (lines.length < 2) {\r\n    return [];\r\n  }\r\n\r\n  const headers = lines[0]\r\n    .split(\",\")\r\n    .map((h) => h.trim().toLowerCase().replace(/[\"\\s]/g, \"\"));\r\n\r\n  const productMap = new Map<string, ParsedProduct>();\r\n\r\n  for (let i = 1; i < lines.length; i++) {\r\n    const line = lines[i].trim();\r\n    if (!line) continue;\r\n\r\n    const values = parseCSVLine(line);\r\n    if (values.length === 0) continue;\r\n\r\n    const row: { [key: string]: string } = {};\r\n    headers.forEach((header, index) => {\r\n      if (values[index] !== undefined) {\r\n        row[header] = values[index].trim();\r\n      }\r\n    });\r\n\r\n    const type = row.type || \"\";\r\n    const productId = row.product_internal_id || \"\";\r\n\r\n    if (!productId) continue;\r\n\r\n    // Initialize product entry if not exists\r\n    if (!productMap.has(productId)) {\r\n      productMap.set(productId, {\r\n        product: row as EcwidProduct,\r\n        options: new Map(),\r\n        variations: [],\r\n      });\r\n    }\r\n\r\n    const parsed = productMap.get(productId)!;\r\n\r\n    if (type === \"product\") {\r\n      parsed.product = row as EcwidProduct;\r\n    } else if (type === \"product_option\") {\r\n      const optionName = row.product_option_name || \"\";\r\n      if (optionName) {\r\n        if (!parsed.options.has(optionName)) {\r\n          parsed.options.set(optionName, []);\r\n        }\r\n        parsed.options.get(optionName)!.push(row as EcwidOption);\r\n      }\r\n    } else if (type === \"product_variation\") {\r\n      parsed.variations.push(row as EcwidVariation);\r\n    }\r\n  }\r\n\r\n  return Array.from(productMap.values());\r\n}\r\n\r\nfunction buildProductFromEcwid(parsed: ParsedProduct): any {\r\n  const product = parsed.product;\r\n  const variations = parsed.variations;\r\n\r\n  // Calculate price range from variations\r\n  let basePrice = parseFloat(product.product_price) || 0;\r\n  let minPrice = basePrice;\r\n  let maxPrice = basePrice;\r\n\r\n  if (variations.length > 0) {\r\n    const prices = variations\r\n      .map((v) => parseFloat(v.product_price) || 0)\r\n      .filter((p) => p > 0);\r\n    if (prices.length > 0) {\r\n      minPrice = Math.min(...prices);\r\n      maxPrice = Math.max(...prices);\r\n      basePrice = minPrice;\r\n    }\r\n  }\r\n\r\n  // Build options array\r\n  const options: any[] = [];\r\n  parsed.options.forEach((optionItems, optionName) => {\r\n    const choices = optionItems\r\n      .filter((item) => item.product_option_value)\r\n      .map((item) => ({\r\n        text: item.product_option_value,\r\n        markup: item.product_option_markup || \"0\",\r\n      }));\r\n\r\n    if (choices.length > 0) {\r\n      options.push({\r\n        name: optionName,\r\n        type: optionItems[0]?.product_option_type || \"DROPDOWNLIST\",\r\n        required: optionItems[0]?.product_option_is_required === \"true\",\r\n        choices,\r\n      });\r\n    }\r\n  });\r\n\r\n  // Build variations array\r\n  const variationsFormatted = variations.map((v) => {\r\n    // Extract variation attribute values from the row\r\n    const variationAttributes: { [key: string]: string } = {};\r\n    Object.keys(v).forEach((key) => {\r\n      if (key.startsWith(\"product_variation_option_\")) {\r\n        const attrName = key\r\n          .replace(\"product_variation_option_\", \"\")\r\n          .replace(/[{}]/g, \"\");\r\n        const value = v[key];\r\n        if (value) {\r\n          variationAttributes[attrName] = value;\r\n        }\r\n      }\r\n    });\r\n\r\n    return {\r\n      id:\r\n        v.product_variation_sku ||\r\n        `var-${Object.keys(variationAttributes).join(\"-\")}`,\r\n      price: parseFloat(v.product_price) || 0,\r\n      image_url: v.product_media_main_image_url || \"\",\r\n      attributes: variationAttributes,\r\n    };\r\n  });\r\n\r\n  // Get main image - prefer variation image if available\r\n  let imageUrl = product.product_media_main_image_url || \"\";\r\n  if (!imageUrl && variationsFormatted.length > 0) {\r\n    imageUrl = variationsFormatted[0].image_url;\r\n  }\r\n\r\n  return {\r\n    ecwid_id: parseInt(product.product_internal_id, 10),\r\n    sku: product.product_sku || null,\r\n    name: product.product_name || \"\",\r\n    description: product.product_description || null,\r\n    price: basePrice,\r\n    base_price: basePrice,\r\n    min_price: minPrice,\r\n    max_price: maxPrice,\r\n    image_url: imageUrl,\r\n    options: options,\r\n    variations: variationsFormatted,\r\n    rating: 0,\r\n    reviews_count: 0,\r\n    is_active: true,\r\n  };\r\n}\r\n\r\nexport const handleImportProducts: RequestHandler = async (req, res) => {\r\n  try {\r\n    const csvData = req.body?.csv_data;\r\n\r\n    if (!csvData || typeof csvData !== \"string\") {\r\n      return res.status(400).json({\r\n        error:\r\n          \"CSV data is required. Send as POST with 'csv_data' (string) in the request body\",\r\n        received: typeof csvData,\r\n      });\r\n    }\r\n    const parsedProducts = parseEcwidCSV(csvData);\r\n\r\n    if (parsedProducts.length === 0) {\r\n      return res.status(400).json({\r\n        error: \"No valid products found in CSV\",\r\n      });\r\n    }\r\n\r\n    // Convert to database format\r\n    const productsToInsert = parsedProducts.map((parsed) =>\r\n      buildProductFromEcwid(parsed),\r\n    );\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"products\")\r\n      .insert(productsToInsert)\r\n      .select();\r\n\r\n    if (error) {\r\n      console.error(\"Import error:\", error);\r\n      return res.status(500).json({\r\n        error: error.message || \"Failed to import products\",\r\n      });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: `Successfully imported ${data?.length || 0} products`,\r\n      imported_count: data?.length || 0,\r\n      products: data,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Import products error:\", error);\r\n    res.status(500).json({\r\n      error:\r\n        error instanceof Error ? error.message : \"Failed to import products\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleGetProducts: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { limit = 20, offset = 0 } = req.query;\r\n\r\n    const { data, error, count } = await supabase\r\n      .from(\"products\")\r\n      .select(\"*\", { count: \"exact\" })\r\n      .eq(\"is_active\", true)\r\n      .order(\"created_at\", { ascending: false })\r\n      .range(\r\n        parseInt(offset as string) || 0,\r\n        (parseInt(offset as string) || 0) +\r\n          (parseInt(limit as string) || 20) -\r\n          1,\r\n      );\r\n\r\n    if (error) {\r\n      console.error(\"Fetch products error:\", error);\r\n      return res.status(500).json({\r\n        error: error.message || \"Failed to fetch products\",\r\n      });\r\n    }\r\n\r\n    res.json({\r\n      items: data || [],\r\n      count: count || 0,\r\n      limit: parseInt(limit as string) || 20,\r\n      offset: parseInt(offset as string) || 0,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get products error:\", error);\r\n    res.status(500).json({\r\n      error:\r\n        error instanceof Error ? error.message : \"Failed to fetch products\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleDeleteAllProducts: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"products\")\r\n      .delete()\r\n      .neq(\"id\", 0)\r\n      .select();\r\n\r\n    if (error) {\r\n      console.error(\"Delete error:\", error);\r\n      return res.status(500).json({\r\n        error: error.message || \"Failed to delete products\",\r\n      });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: `Deleted ${data?.length || 0} products`,\r\n      deleted_count: data?.length || 0,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Delete products error:\", error);\r\n    res.status(500).json({\r\n      error:\r\n        error instanceof Error ? error.message : \"Failed to delete products\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 10963, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/emails/generate-proof-email.ts"],"sourcesContent":["import { formatOrderNumber } from \"../utils/order\";\r\n\r\nexport function generateProofEmailHtml(params: {\r\n  customerName: string;\r\n  orderId?: number;\r\n  proofDescription: string;\r\n  proofFileUrl?: string;\r\n  approvalLink: string;\r\n  revisionLink: string;\r\n  referenceNumber?: string;\r\n}): string {\r\n  const {\r\n    customerName,\r\n    orderId,\r\n    proofDescription,\r\n    proofFileUrl,\r\n    approvalLink,\r\n    revisionLink,\r\n    referenceNumber,\r\n  } = params;\r\n\r\n  const formattedOrderNumber = orderId ? formatOrderNumber(orderId) : null;\r\n\r\n  const imageHtml = proofFileUrl\r\n    ? `\r\n        <div style=\"margin-bottom: 20px; border-radius: 6px; overflow: hidden; border: 1px solid #e5e7eb;\">\r\n          <img src=\"${proofFileUrl}\" alt=\"Design Proof\" style=\"width: 100%; height: auto; display: block;\" />\r\n        </div>\r\n      `\r\n    : \"\";\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Your Design Proof is Ready</title>\r\n  <style>\r\n    body {\r\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\r\n      margin: 0;\r\n      padding: 0;\r\n      background-color: #f9fafb;\r\n    }\r\n    .container {\r\n      max-width: 600px;\r\n      margin: 0 auto;\r\n      padding: 20px;\r\n    }\r\n    .header {\r\n      background-color: #ffffff;\r\n      padding: 30px;\r\n      border-radius: 8px 8px 0 0;\r\n      border-bottom: 2px solid #3b82f6;\r\n      margin-bottom: 20px;\r\n      text-align: center;\r\n    }\r\n    .header h1 {\r\n      margin: 0 0 10px 0;\r\n      color: #1f2937;\r\n      font-size: 28px;\r\n      font-weight: bold;\r\n    }\r\n    .header p {\r\n      margin: 5px 0 0 0;\r\n      color: #6b7280;\r\n      font-size: 14px;\r\n    }\r\n    .content {\r\n      background-color: #ffffff;\r\n      padding: 30px;\r\n      margin-bottom: 20px;\r\n      border-radius: 0 0 8px 8px;\r\n    }\r\n    .content p {\r\n      margin: 0 0 20px 0;\r\n      color: #374151;\r\n      font-size: 16px;\r\n      line-height: 1.6;\r\n    }\r\n    .proof-box {\r\n      background-color: #f0f9ff;\r\n      border: 1px solid #bfdbfe;\r\n      border-radius: 6px;\r\n      padding: 15px;\r\n      margin-bottom: 20px;\r\n    }\r\n    .proof-box-title {\r\n      margin: 0 0 10px 0;\r\n      color: #1e40af;\r\n      font-size: 14px;\r\n      font-weight: bold;\r\n    }\r\n    .proof-box-text {\r\n      margin: 0;\r\n      color: #374151;\r\n      font-size: 16px;\r\n      line-height: 1.6;\r\n      white-space: pre-wrap;\r\n    }\r\n    .buttons {\r\n      display: grid;\r\n      grid-template-columns: 1fr 1fr;\r\n      gap: 15px;\r\n      margin-bottom: 20px;\r\n    }\r\n    .button {\r\n      display: inline-block;\r\n      padding: 12px 24px;\r\n      color: #ffffff;\r\n      text-decoration: none;\r\n      border-radius: 6px;\r\n      font-weight: bold;\r\n      font-size: 14px;\r\n      text-align: center;\r\n      border: none;\r\n      cursor: pointer;\r\n    }\r\n    .button-approve {\r\n      background-color: #10b981;\r\n    }\r\n    .button-approve:hover {\r\n      background-color: #059669;\r\n    }\r\n    .button-revise {\r\n      background-color: #f59e0b;\r\n    }\r\n    .button-revise:hover {\r\n      background-color: #d97706;\r\n    }\r\n    .footer {\r\n      text-align: center;\r\n      padding: 20px;\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      border-top: 1px solid #e5e7eb;\r\n    }\r\n    .footer p {\r\n      margin: 0 0 10px 0;\r\n    }\r\n    .footer p:last-child {\r\n      margin: 0;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <!-- Header -->\r\n    <div class=\"header\">\r\n      <h1>üé® Your Design Proof is Ready</h1>\r\n      <p>Review your design and let us know what you think</p>\r\n    </div>\r\n\r\n    <!-- Main Content -->\r\n    <div class=\"content\">\r\n      <p>Hi <strong>${customerName}</strong>,</p>\r\n\r\n      <p>Great news! Your design proof${\r\n        referenceNumber\r\n          ? ` for <strong>${referenceNumber}</strong>`\r\n          : formattedOrderNumber\r\n            ? ` for <strong>Order ${formattedOrderNumber}</strong>`\r\n            : \"\"\r\n      } is ready for review.</p>\r\n\r\n      <!-- Proof Description -->\r\n      <div class=\"proof-box\">\r\n        <p class=\"proof-box-title\">Proof Details:</p>\r\n        <p class=\"proof-box-text\">${proofDescription}</p>\r\n      </div>\r\n\r\n      <!-- Preview Image -->\r\n      ${imageHtml}\r\n\r\n      <!-- Call to Action Buttons -->\r\n      <div class=\"buttons\">\r\n        <a href=\"${approvalLink}\" class=\"button button-approve\">‚úì Approve This Design</a>\r\n        <a href=\"${revisionLink}\" class=\"button button-revise\">‚úé Request Changes</a>\r\n      </div>\r\n\r\n      <p>If you have any questions about this design, please reply to this email and our team will get back to you as soon as possible.</p>\r\n    </div>\r\n\r\n    <!-- Footer -->\r\n    <div class=\"footer\">\r\n      <p>¬© 2024 Stickerland. All rights reserved.</p>\r\n      <p>This is an automated message. Please do not reply to this email address directly.</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,uBAAuB,MAQtC;IACC,MAAM,EACJ,YAAY,EACZ,OAAO,EACP,gBAAgB,EAChB,YAAY,EACZ,YAAY,EACZ,YAAY,EACZ,eAAe,EAChB,GAAG;IAEJ,MAAM,uBAAuB,UAAU,IAAA,sIAAiB,EAAC,WAAW;IAEpE,MAAM,YAAY,eACd,CAAC;;oBAEa,EAAE,aAAa;;MAE7B,CAAC,GACD;IAEJ,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;oBA6HU,EAAE,aAAa;;sCAEG,EAC9B,kBACI,CAAC,aAAa,EAAE,gBAAgB,SAAS,CAAC,GAC1C,uBACE,CAAC,mBAAmB,EAAE,qBAAqB,SAAS,CAAC,GACrD,GACP;;;;;kCAK2B,EAAE,iBAAiB;;;;MAI/C,EAAE,UAAU;;;;iBAID,EAAE,aAAa;iBACf,EAAE,aAAa;;;;;;;;;;;;;;EAc9B,CAAC;AACH"}},
    {"offset": {"line": 11140, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/proofs.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { Resend } from \"resend\";\r\nimport { generateProofEmailHtml } from \"../emails/generate-proof-email\";\r\nimport { formatOrderNumber } from \"../utils/order\";\r\nimport {\r\n  validatePublicAccessToken,\r\n  createPublicAccessToken,\r\n  revokeResourceTokens,\r\n} from \"../utils/public-access-tokens\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL || \"\",\r\n  process.env.SUPABASE_SERVICE_KEY || \"\",\r\n);\r\n\r\nconst resend = process.env.RESEND_API_KEY\r\n  ? new Resend(process.env.RESEND_API_KEY)\r\n  : null;\r\nconst PROOF_EMAIL_FROM = \"sticky@stickerland.com\";\r\n\r\ninterface ProofComment {\r\n  id: string;\r\n  proof_id: string;\r\n  customer_id?: number;\r\n  admin_id?: string;\r\n  admin_email?: string;\r\n  message: string;\r\n  created_at: string;\r\n}\r\n\r\ninterface ProofRow {\r\n  id: string;\r\n  order_id: number;\r\n  customer_id: number;\r\n  description?: string;\r\n  file_url?: string;\r\n  file_name?: string;\r\n  status: string;\r\n  revision_notes?: string;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\ninterface ProofDetail extends ProofRow {\r\n  comments: ProofComment[];\r\n}\r\n\r\n/**\r\n * Get all proofs for the logged-in customer (paginated)\r\n */\r\nexport const handleGetProofs: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\r\n    const limit = 5;\r\n    const offset = (page - 1) * limit;\r\n\r\n    if (!customerId) {\r\n      return res.status(401).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Get total count\r\n    const { count: totalCount, error: countError } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\", { count: \"exact\", head: true })\r\n      .eq(\"customer_id\", customerId);\r\n\r\n    if (countError) {\r\n      console.error(\"Error counting proofs:\", countError);\r\n      return res.status(500).json({ error: \"Failed to fetch proofs\" });\r\n    }\r\n\r\n    // Get paginated proofs\r\n    const { data: proofs, error } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\")\r\n      .eq(\"customer_id\", customerId)\r\n      .order(\"created_at\", { ascending: false })\r\n      .range(offset, offset + limit - 1);\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching proofs:\", error);\r\n      return res.status(500).json({ error: \"Failed to fetch proofs\" });\r\n    }\r\n\r\n    // Count unread notifications\r\n    const { data: notifications } = await supabase\r\n      .from(\"proof_notifications\")\r\n      .select(\"*\")\r\n      .eq(\"customer_id\", customerId)\r\n      .eq(\"is_read\", false);\r\n\r\n    const totalPages = Math.ceil((totalCount || 0) / limit);\r\n\r\n    res.json({\r\n      success: true,\r\n      proofs: proofs || [],\r\n      unreadNotifications: notifications?.length || 0,\r\n      pagination: {\r\n        currentPage: page,\r\n        pageSize: limit,\r\n        totalItems: totalCount || 0,\r\n        totalPages,\r\n        hasMore: page < totalPages,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get proofs error:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch proofs\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Get a single proof with its comments\r\n */\r\nexport const handleGetProofDetail: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n    const { proofId } = req.params;\r\n\r\n    if (!customerId || !proofId) {\r\n      return res.status(401).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Get proof\r\n    const { data: proof, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", proofId)\r\n      .single();\r\n\r\n    if (proofError || !proof) {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Verify customer owns this proof\r\n    if (proof.customer_id !== customerId) {\r\n      return res.status(403).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Get comments\r\n    const { data: comments, error: commentsError } = await supabase\r\n      .from(\"proof_comments\")\r\n      .select(\"*\")\r\n      .eq(\"proof_id\", proofId)\r\n      .order(\"created_at\", { ascending: true });\r\n\r\n    if (commentsError) {\r\n      console.error(\"Error fetching comments:\", commentsError);\r\n      return res.status(500).json({ error: \"Failed to fetch proof details\" });\r\n    }\r\n\r\n    // Mark notification as read\r\n    const { data: notification } = await supabase\r\n      .from(\"proof_notifications\")\r\n      .select(\"id\")\r\n      .eq(\"proof_id\", proofId)\r\n      .eq(\"customer_id\", customerId)\r\n      .eq(\"is_read\", false)\r\n      .single();\r\n\r\n    if (notification) {\r\n      await supabase\r\n        .from(\"proof_notifications\")\r\n        .update({ is_read: true, read_at: new Date().toISOString() })\r\n        .eq(\"id\", notification.id);\r\n    }\r\n\r\n    const proofDetail: ProofDetail = {\r\n      ...(proof as ProofRow),\r\n      comments: (comments || []) as ProofComment[],\r\n    };\r\n\r\n    res.json({\r\n      success: true,\r\n      proof: proofDetail,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get proof detail error:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch proof details\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Approve a proof\r\n */\r\nexport const handleApproveProof: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n    const { proofId } = req.params;\r\n\r\n    if (!customerId || !proofId) {\r\n      return res.status(401).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Get proof\r\n    const { data: proof, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", proofId)\r\n      .single();\r\n\r\n    if (proofError || !proof) {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Verify customer owns this proof\r\n    if (proof.customer_id !== customerId) {\r\n      return res.status(403).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Update proof status\r\n    const { error: updateError } = await supabase\r\n      .from(\"proofs\")\r\n      .update({\r\n        status: \"approved\",\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", proofId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Error approving proof:\", updateError);\r\n      return res.status(500).json({ error: \"Failed to approve proof\" });\r\n    }\r\n\r\n    // Create admin notification\r\n    const { data: customerData } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"email, first_name, last_name\")\r\n      .eq(\"id\", customerId)\r\n      .single();\r\n\r\n    await supabase.from(\"proof_notifications\").insert({\r\n      customer_id: customerId,\r\n      proof_id: proofId,\r\n      notification_type: \"customer_approved\",\r\n      message: `${customerData?.first_name} ${customerData?.last_name} has approved their proof for order #${proof.order_id}`,\r\n      is_read: false,\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Proof approved successfully\",\r\n      status: \"approved\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Approve proof error:\", error);\r\n    res.status(500).json({ error: \"Failed to approve proof\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Deny a proof (request revisions)\r\n */\r\nexport const handleDenyProof: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n    const { proofId } = req.params;\r\n    const { revisionNotes } = req.body;\r\n\r\n    if (!customerId || !proofId) {\r\n      return res.status(401).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Get proof\r\n    const { data: proof, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", proofId)\r\n      .single();\r\n\r\n    if (proofError || !proof) {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Verify customer owns this proof\r\n    if (proof.customer_id !== customerId) {\r\n      return res.status(403).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Update proof status\r\n    const { error: updateError } = await supabase\r\n      .from(\"proofs\")\r\n      .update({\r\n        status: \"revisions_requested\",\r\n        revision_notes: revisionNotes || \"\",\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", proofId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Error denying proof:\", updateError);\r\n      return res.status(500).json({ error: \"Failed to deny proof\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Proof denied, revisions requested\",\r\n      status: \"revisions_requested\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Deny proof error:\", error);\r\n    res.status(500).json({ error: \"Failed to deny proof\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Add a comment to a proof\r\n */\r\nexport const handleAddProofComment: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n    const { proofId } = req.params;\r\n    const { message } = req.body;\r\n\r\n    if (!customerId || !proofId || !message) {\r\n      return res.status(400).json({ error: \"Missing required fields\" });\r\n    }\r\n\r\n    // Get proof\r\n    const { data: proof, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", proofId)\r\n      .single();\r\n\r\n    if (proofError || !proof) {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Verify customer owns this proof\r\n    if (proof.customer_id !== customerId) {\r\n      return res.status(403).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    // Add comment\r\n    const { data: comment, error: commentError } = await supabase\r\n      .from(\"proof_comments\")\r\n      .insert({\r\n        proof_id: proofId,\r\n        customer_id: customerId,\r\n        message,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (commentError) {\r\n      console.error(\"Error adding comment:\", commentError);\r\n      return res.status(500).json({ error: \"Failed to add comment\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      comment,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Add comment error:\", error);\r\n    res.status(500).json({ error: \"Failed to add comment\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Get unread proof notifications for customer\r\n */\r\nexport const handleGetProofNotifications: RequestHandler = async (req, res) => {\r\n  try {\r\n    const customerId = (req as any).customerId;\r\n\r\n    if (!customerId) {\r\n      return res.status(401).json({ error: \"Unauthorized\" });\r\n    }\r\n\r\n    const { data: notifications, error } = await supabase\r\n      .from(\"proof_notifications\")\r\n      .select(\"*\")\r\n      .eq(\"customer_id\", customerId)\r\n      .eq(\"is_read\", false)\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching notifications:\", error);\r\n      return res.status(500).json({ error: \"Failed to fetch notifications\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      notifications: notifications || [],\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get notifications error:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch notifications\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Admin: Send proof to customer (standalone, not linked to orders)\r\n */\r\nexport const handleSendProofToCustomer: RequestHandler = async (req, res) => {\r\n  try {\r\n    const {\r\n      customerEmail,\r\n      description,\r\n      referenceNumber,\r\n      fileData,\r\n      fileName,\r\n      fileUrl,\r\n    } = req.body;\r\n\r\n    if (!description) {\r\n      return res.status(400).json({ error: \"Proof subject is required\" });\r\n    }\r\n\r\n    if (!customerEmail) {\r\n      return res.status(400).json({ error: \"Customer email is required\" });\r\n    }\r\n\r\n    // Find or create customer\r\n    let resolvedCustomerId: number;\r\n    const { data: existingCustomer } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"id\")\r\n      .eq(\"email\", customerEmail)\r\n      .maybeSingle();\r\n\r\n    if (existingCustomer) {\r\n      resolvedCustomerId = existingCustomer.id;\r\n    } else {\r\n      // Create new customer\r\n      const emailParts = customerEmail.split(\"@\");\r\n      const { data: newCustomer, error: createError } = await supabase\r\n        .from(\"customers\")\r\n        .insert({\r\n          email: customerEmail,\r\n          first_name: emailParts[0],\r\n          last_name: \"Customer\",\r\n        })\r\n        .select(\"id\")\r\n        .single();\r\n\r\n      if (!newCustomer) {\r\n        return res\r\n          .status(500)\r\n          .json({ error: \"Failed to create customer record\" });\r\n      }\r\n      resolvedCustomerId = newCustomer.id;\r\n    }\r\n\r\n    let finalFileUrl: string | undefined;\r\n    let storedFileName: string | undefined;\r\n\r\n    // If fileUrl is provided directly (from Cloudinary), use it\r\n    if (fileUrl) {\r\n      finalFileUrl = fileUrl;\r\n      storedFileName = fileName;\r\n      console.log(\"Using pre-uploaded file URL from Cloudinary:\", finalFileUrl);\r\n    }\r\n    // Otherwise, handle file upload if base64 data is provided\r\n    else if (fileData && fileName) {\r\n      try {\r\n        const buffer = Buffer.from(fileData, \"base64\");\r\n        const timestamp = Date.now();\r\n        const uniqueFileName = `proof-${timestamp}-${fileName}`;\r\n        const bucketPath = `proofs/${uniqueFileName}`;\r\n\r\n        const { error: uploadError } = await supabase.storage\r\n          .from(\"proofs\")\r\n          .upload(bucketPath, buffer, {\r\n            cacheControl: \"3600\",\r\n            upsert: false,\r\n            contentType: \"application/octet-stream\",\r\n          });\r\n\r\n        if (uploadError) {\r\n          console.error(\"Error uploading file:\", uploadError);\r\n          return res.status(500).json({ error: \"Failed to upload file\" });\r\n        }\r\n\r\n        const { data: publicUrlData } = supabase.storage\r\n          .from(\"proofs\")\r\n          .getPublicUrl(bucketPath);\r\n\r\n        finalFileUrl = publicUrlData.publicUrl;\r\n        storedFileName = fileName;\r\n        console.log(\"Uploaded file to Supabase Storage:\", finalFileUrl);\r\n      } catch (fileError) {\r\n        console.error(\"Error processing file:\", fileError);\r\n        return res.status(500).json({ error: \"Failed to process file\" });\r\n      }\r\n    }\r\n\r\n    // Create or find a placeholder order for this proof\r\n    // (database requires order_id, so we create a dummy one for standalone proofs)\r\n    let resolvedOrderId: number | null = null;\r\n\r\n    const { data: existingOrder } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"id\")\r\n      .eq(\"customer_id\", resolvedCustomerId)\r\n      .eq(\"status\", \"pending\")\r\n      .limit(1)\r\n      .maybeSingle();\r\n\r\n    if (existingOrder) {\r\n      resolvedOrderId = existingOrder.id;\r\n    } else {\r\n      // Create a placeholder order\r\n      const { data: newOrder } = await supabase\r\n        .from(\"orders\")\r\n        .insert({\r\n          customer_id: resolvedCustomerId,\r\n          status: \"pending\",\r\n          total: 0,\r\n          items: [],\r\n        })\r\n        .select(\"id\")\r\n        .single();\r\n\r\n      if (newOrder) {\r\n        resolvedOrderId = newOrder.id;\r\n      }\r\n    }\r\n\r\n    // Create proof record (independent of orders conceptually, but linked for DB constraint)\r\n    // Note: If using reference_number in the future, add it to the description for now\r\n    const proofPayload: any = {\r\n      customer_id: resolvedCustomerId,\r\n      description: referenceNumber\r\n        ? `${referenceNumber} - ${description}`\r\n        : description,\r\n      file_url: finalFileUrl,\r\n      file_name: storedFileName,\r\n      status: \"pending\",\r\n    };\r\n\r\n    // Include order_id if we have one\r\n    if (resolvedOrderId) {\r\n      proofPayload.order_id = resolvedOrderId;\r\n    }\r\n\r\n    const { data: proof, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .insert(proofPayload)\r\n      .select()\r\n      .single();\r\n\r\n    if (proofError) {\r\n      console.error(\"Error creating proof:\", proofError);\r\n      return res.status(500).json({ error: \"Failed to send proof\" });\r\n    }\r\n\r\n    // SECURITY: Generate secure one-time-use tokens for proof approval/revision\r\n    const approvalTokenResult = await createPublicAccessToken({\r\n      resourceType: \"proof\",\r\n      resourceId: proof.id,\r\n      expiresInHours: 72, // 3 days for email links\r\n      oneTimeUse: true,\r\n      createdBy: \"admin-proof-email\",\r\n    });\r\n\r\n    const revisionTokenResult = await createPublicAccessToken({\r\n      resourceType: \"proof\",\r\n      resourceId: proof.id,\r\n      expiresInHours: 72, // 3 days for email links\r\n      oneTimeUse: true,\r\n      createdBy: \"admin-proof-email\",\r\n    });\r\n\r\n    if (!approvalTokenResult.success || !revisionTokenResult.success) {\r\n      console.error(\"Failed to generate access tokens for proof email\");\r\n      return res.status(500).json({ error: \"Failed to send proof\" });\r\n    }\r\n\r\n    // Send proof email\r\n    if (process.env.RESEND_API_KEY && resend) {\r\n      try {\r\n        const baseUrl = process.env.FRONTEND_URL || \"https://stickerland.com\";\r\n        // SECURITY: Include tokens in email links\r\n        const approvalLink = `${baseUrl}/proofs/review?token=${approvalTokenResult.token}&action=approve`;\r\n        const revisionLink = `${baseUrl}/proofs/review?token=${revisionTokenResult.token}&action=revise`;\r\n\r\n        const { data: customer } = await supabase\r\n          .from(\"customers\")\r\n          .select(\"first_name, last_name\")\r\n          .eq(\"id\", resolvedCustomerId)\r\n          .single();\r\n\r\n        const customerName = customer?.first_name\r\n          ? `${customer.first_name}${customer.last_name ? \" \" + customer.last_name : \"\"}`\r\n          : \"Valued Customer\";\r\n\r\n        // Generate email HTML\r\n        const emailHtml = generateProofEmailHtml({\r\n          customerName,\r\n          proofDescription: description,\r\n          proofFileUrl: finalFileUrl,\r\n          approvalLink,\r\n          revisionLink,\r\n          referenceNumber,\r\n        });\r\n\r\n        // Send email via Resend\r\n        const emailResult = await resend.emails.send({\r\n          from: PROOF_EMAIL_FROM,\r\n          to: customerEmail,\r\n          subject: `Your Design Proof is Ready${referenceNumber ? ` - ${referenceNumber}` : \"\"}`,\r\n          html: emailHtml,\r\n        });\r\n\r\n        if (emailResult.error) {\r\n          console.error(\"Error sending proof email:\", emailResult.error);\r\n        } else {\r\n          console.log(\"Proof email sent successfully:\", emailResult.data);\r\n        }\r\n      } catch (emailError) {\r\n        console.error(\"Error preparing or sending proof email:\", emailError);\r\n      }\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      proof,\r\n      message: \"Proof sent to customer successfully\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Send proof error:\", error);\r\n    res.status(500).json({ error: \"Failed to send proof\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Admin: Get single proof detail\r\n */\r\nexport const handleGetAdminProofDetail: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { proofId } = req.params;\r\n\r\n    if (!proofId) {\r\n      return res.status(400).json({ error: \"Proof ID is required\" });\r\n    }\r\n\r\n    const { data: proof, error } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\r\n        `\r\n        *,\r\n        customers:customer_id (id, email, first_name, last_name),\r\n        comments:proof_comments (id, proof_id, customer_id, admin_id, admin_email, message, created_at)\r\n      `,\r\n      )\r\n      .eq(\"id\", proofId)\r\n      .single();\r\n\r\n    if (error || !proof) {\r\n      console.error(\"Error fetching proof detail:\", error);\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      proof,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get proof detail error:\", error);\r\n    res.status(500).json({ error: \"Failed to get proof details\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Admin: Get pending proofs for all customers with optional date and status filtering\r\n */\r\nexport const handleGetAdminProofs: RequestHandler = async (req, res) => {\r\n  try {\r\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\r\n    const sort = (req.query.sort as string) || \"newest\";\r\n    const limit = Math.max(\r\n      1,\r\n      Math.min(20, parseInt(req.query.limit as string) || 5),\r\n    );\r\n    const offset = (page - 1) * limit;\r\n    const dateFilter = (req.query.date as string) || null;\r\n    const statusFilter = (req.query.status as string) || null;\r\n\r\n    // Build the count query\r\n    let countQuery = supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\", { count: \"exact\", head: true });\r\n\r\n    // Get paginated proofs query\r\n    let proofQuery = supabase.from(\"proofs\").select(\r\n      `\r\n        *,\r\n        customers:customer_id (id, email, first_name, last_name)\r\n      `,\r\n    );\r\n\r\n    // Apply date filter if provided\r\n    if (dateFilter) {\r\n      const startOfDay = `${dateFilter}T00:00:00.000Z`;\r\n      const endOfDay = `${dateFilter}T23:59:59.999Z`;\r\n      countQuery = countQuery\r\n        .gte(\"created_at\", startOfDay)\r\n        .lte(\"created_at\", endOfDay);\r\n      proofQuery = proofQuery\r\n        .gte(\"created_at\", startOfDay)\r\n        .lte(\"created_at\", endOfDay);\r\n    }\r\n\r\n    // Apply status filter if provided\r\n    if (statusFilter) {\r\n      countQuery = countQuery.eq(\"status\", statusFilter);\r\n      proofQuery = proofQuery.eq(\"status\", statusFilter);\r\n    }\r\n\r\n    // Get total count\r\n    const { count: totalCount, error: countError } = await countQuery;\r\n\r\n    if (countError) {\r\n      console.error(\"Error counting admin proofs:\", countError);\r\n      return res.status(500).json({ error: \"Failed to fetch proofs\" });\r\n    }\r\n\r\n    // Get paginated proofs with their customer info\r\n    const sortAscending = sort === \"oldest\" ? true : false;\r\n    const { data: proofs, error } = await proofQuery\r\n      .order(\"created_at\", { ascending: sortAscending })\r\n      .range(offset, offset + limit - 1);\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching admin proofs:\", error);\r\n      return res.status(500).json({ error: \"Failed to fetch proofs\" });\r\n    }\r\n\r\n    // Get unread admin notifications\r\n    const { data: notifications } = await supabase\r\n      .from(\"proof_notifications\")\r\n      .select(\"*\")\r\n      .eq(\"is_read\", false);\r\n\r\n    const totalPages = Math.ceil((totalCount || 0) / limit);\r\n\r\n    res.json({\r\n      success: true,\r\n      proofs: (proofs || []).map((proof: any) => ({\r\n        id: proof.id,\r\n        orderId: proof.order_id,\r\n        customerId: proof.customer_id,\r\n        customerName: proof.customers\r\n          ? `${proof.customers.first_name || \"\"} ${proof.customers.last_name || \"\"}`.trim()\r\n          : \"Unknown\",\r\n        customerEmail: proof.customers?.email || \"N/A\",\r\n        status: proof.status,\r\n        thumbnailUrl: proof.file_url,\r\n        approvedAt: proof.updated_at,\r\n        createdAt: proof.created_at,\r\n      })),\r\n      unreadNotifications: notifications?.length || 0,\r\n      pagination: {\r\n        currentPage: page,\r\n        pageSize: limit,\r\n        totalItems: totalCount || 0,\r\n        totalPages,\r\n        hasMore: page < totalPages,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get admin proofs error:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch proofs\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Admin: Add comment to proof\r\n */\r\nexport const handleAddAdminProofComment: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { proofId } = req.params;\r\n    const { message, adminId, adminEmail } = req.body;\r\n\r\n    if (!proofId || !message || !adminId) {\r\n      return res.status(400).json({ error: \"Missing required fields\" });\r\n    }\r\n\r\n    // Get proof\r\n    const { data: proof, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", proofId)\r\n      .single();\r\n\r\n    if (proofError || !proof) {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Add comment\r\n    const { data: comment, error: commentError } = await supabase\r\n      .from(\"proof_comments\")\r\n      .insert({\r\n        proof_id: proofId,\r\n        admin_id: adminId,\r\n        admin_email: adminEmail,\r\n        message,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (commentError) {\r\n      console.error(\"Error adding admin comment:\", commentError);\r\n      return res.status(500).json({ error: \"Failed to add comment\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      comment,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Add admin comment error:\", error);\r\n    res.status(500).json({ error: \"Failed to add comment\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Get a single proof (public - requires secure access token)\r\n * SECURITY: Requires valid public access token instead of guessable proof ID\r\n * Prevents enumeration attacks and unauthorized access\r\n *\r\n * Usage: GET /api/proofs/public/:proofId?token=<secure-token>\r\n */\r\nexport const handleGetProofDetailPublic: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { token } = req.query;\r\n\r\n    if (!token || typeof token !== \"string\") {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // SECURITY: Validate token atomically (prevents enumeration)\r\n    const validation = await validatePublicAccessToken(token, \"proof\");\r\n    if (!validation.success) {\r\n      // Generic 404 - never reveal why token failed\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    const proofId = validation.resourceId;\r\n\r\n    // Get proof\r\n    const { data: proof, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", proofId)\r\n      .single();\r\n\r\n    if (proofError || !proof) {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Get comments\r\n    const { data: comments, error: commentsError } = await supabase\r\n      .from(\"proof_comments\")\r\n      .select(\"*\")\r\n      .eq(\"proof_id\", proofId)\r\n      .order(\"created_at\", { ascending: true });\r\n\r\n    if (commentsError) {\r\n      console.error(\"Error fetching comments:\", commentsError);\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      proof: {\r\n        ...proof,\r\n        comments: comments || [],\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get proof detail public error:\", error);\r\n    res.status(404).json({ error: \"Proof not found\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Approve a proof (public - requires secure access token)\r\n * SECURITY: Requires valid one-time-use public access token\r\n * Prevents unauthorized approval and enumeration attacks\r\n *\r\n * Usage: POST /api/proofs/:proofId/approve?token=<secure-token>\r\n */\r\nexport const handleApproveProofPublicNew: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { token } = req.query;\r\n\r\n    if (!token || typeof token !== \"string\") {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // SECURITY: Validate token atomically (prevents enumeration and reuse)\r\n    const validation = await validatePublicAccessToken(token, \"proof\");\r\n    if (!validation.success) {\r\n      // Generic 404 - never reveal why token failed\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    const proofId = validation.resourceId;\r\n\r\n    // Get proof\r\n    const { data: proof, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", proofId)\r\n      .single();\r\n\r\n    if (proofError || !proof) {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Update proof status\r\n    const { error: updateError } = await supabase\r\n      .from(\"proofs\")\r\n      .update({\r\n        status: \"approved\",\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", proofId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Error approving proof:\", updateError);\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Proof approved successfully\",\r\n      status: \"approved\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Approve proof public error:\", error);\r\n    res.status(500).json({ error: \"Failed to approve proof\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Request revisions on a proof (public - requires secure access token)\r\n * SECURITY: Requires valid one-time-use public access token\r\n * Prevents unauthorized revision requests and enumeration attacks\r\n *\r\n * Usage: POST /api/proofs/:proofId/revise?token=<secure-token>\r\n */\r\nexport const handleReviseProofPublicNew: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { token } = req.query;\r\n    const { revision_notes } = req.body;\r\n\r\n    if (!token || typeof token !== \"string\") {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // SECURITY: Validate token atomically (prevents enumeration and reuse)\r\n    const validation = await validatePublicAccessToken(token, \"proof\");\r\n    if (!validation.success) {\r\n      // Generic 404 - never reveal why token failed\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    const proofId = validation.resourceId;\r\n\r\n    // Get proof\r\n    const { data: proof, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", proofId)\r\n      .single();\r\n\r\n    if (proofError || !proof) {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Update proof status\r\n    const { error: updateError } = await supabase\r\n      .from(\"proofs\")\r\n      .update({\r\n        status: \"revisions_requested\",\r\n        revision_notes: revision_notes || \"\",\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", proofId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Error requesting revisions:\", updateError);\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Revision request submitted successfully\",\r\n      status: \"revisions_requested\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Revise proof public error:\", error);\r\n    res.status(404).json({ error: \"Proof not found\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Approve a proof (public - requires secure access token)\r\n * SECURITY: Requires valid one-time-use public access token\r\n * Prevents unauthorized approval and enumeration attacks\r\n *\r\n * Usage: POST /api/proofs/:proofId/approve?token=<secure-token>\r\n */\r\nexport const handleApproveProofPublic: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { token } = req.query;\r\n\r\n    if (!token || typeof token !== \"string\") {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // SECURITY: Validate token atomically (prevents enumeration and reuse)\r\n    const validation = await validatePublicAccessToken(token, \"proof\");\r\n    if (!validation.success) {\r\n      // Generic 404 - never reveal why token failed\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    const proofId = validation.resourceId;\r\n\r\n    // Get proof\r\n    const { data: proof, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", proofId)\r\n      .single();\r\n\r\n    if (proofError || !proof) {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Update proof status\r\n    const { error: updateError } = await supabase\r\n      .from(\"proofs\")\r\n      .update({\r\n        status: \"approved\",\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", proofId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Error approving proof:\", updateError);\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Create admin notification\r\n    const { data: customerData } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"email, first_name, last_name\")\r\n      .eq(\"id\", proof.customer_id)\r\n      .single();\r\n\r\n    await supabase.from(\"proof_notifications\").insert({\r\n      customer_id: proof.customer_id,\r\n      proof_id: proofId,\r\n      notification_type: \"customer_approved\",\r\n      message: `${customerData?.first_name} ${customerData?.last_name} has approved their proof for order #${proof.order_id}`,\r\n      is_read: false,\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Proof approved successfully\",\r\n      status: \"approved\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Approve proof public error:\", error);\r\n    res.status(404).json({ error: \"Proof not found\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Deny a proof - request revisions (public - requires secure access token)\r\n * SECURITY: Requires valid one-time-use public access token\r\n * Prevents unauthorized revision requests and enumeration attacks\r\n *\r\n * Usage: POST /api/proofs/:proofId/deny?token=<secure-token>\r\n */\r\nexport const handleDenyProofPublic: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { token } = req.query;\r\n    const { revision_notes } = req.body;\r\n\r\n    if (!token || typeof token !== \"string\") {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // SECURITY: Validate token atomically (prevents enumeration and reuse)\r\n    const validation = await validatePublicAccessToken(token, \"proof\");\r\n    if (!validation.success) {\r\n      // Generic 404 - never reveal why token failed\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    const proofId = validation.resourceId;\r\n\r\n    // Get proof\r\n    const { data: proof, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", proofId)\r\n      .single();\r\n\r\n    if (proofError || !proof) {\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Update proof status\r\n    const { error: updateError } = await supabase\r\n      .from(\"proofs\")\r\n      .update({\r\n        status: \"revisions_requested\",\r\n        revision_notes: revision_notes || \"\",\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", proofId);\r\n\r\n    if (updateError) {\r\n      console.error(\"Error requesting revisions:\", updateError);\r\n      return res.status(404).json({ error: \"Proof not found\" });\r\n    }\r\n\r\n    // Create admin notification\r\n    const { data: customerData } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"email, first_name, last_name\")\r\n      .eq(\"id\", proof.customer_id)\r\n      .single();\r\n\r\n    await supabase.from(\"proof_notifications\").insert({\r\n      customer_id: proof.customer_id,\r\n      proof_id: proofId,\r\n      notification_type: \"revision_requested\",\r\n      message: `${customerData?.first_name} ${customerData?.last_name} has requested revisions for their proof on order #${proof.order_id}`,\r\n      is_read: false,\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Revision request submitted successfully\",\r\n      status: \"revisions_requested\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Deny proof public error:\", error);\r\n    res.status(404).json({ error: \"Proof not found\" });\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA;AACA;AACA;AAEA;;;;;;;;;;;AAMA,MAAM,WAAW,IAAA,2OAAY,EAC3B,QAAQ,GAAG,CAAC,YAAY,IAAI,IAC5B,QAAQ,GAAG,CAAC,oBAAoB,IAAI;AAGtC,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc,GACrC,IAAI,mKAAM,CAAC,QAAQ,GAAG,CAAC,cAAc,IACrC;AACJ,MAAM,mBAAmB;AAgClB,MAAM,kBAAkC,OAAO,KAAK;IACzD,IAAI;QACF,MAAM,aAAa,AAAC,IAAY,UAAU;QAC1C,MAAM,OAAO,KAAK,GAAG,CAAC,GAAG,SAAS,IAAI,KAAK,CAAC,IAAI,KAAe;QAC/D,MAAM,QAAQ;QACd,MAAM,SAAS,CAAC,OAAO,CAAC,IAAI;QAE5B,IAAI,CAAC,YAAY;YACf,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAe;QACtD;QAEA,kBAAkB;QAClB,MAAM,EAAE,OAAO,UAAU,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SACpD,IAAI,CAAC,UACL,MAAM,CAAC,KAAK;YAAE,OAAO;YAAS,MAAM;QAAK,GACzC,EAAE,CAAC,eAAe;QAErB,IAAI,YAAY;YACd,QAAQ,KAAK,CAAC,0BAA0B;YACxC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,uBAAuB;QACvB,MAAM,EAAE,MAAM,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,eAAe,YAClB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC,QAAQ,SAAS,QAAQ;QAElC,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,0BAA0B;YACxC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,6BAA6B;QAC7B,MAAM,EAAE,MAAM,aAAa,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,uBACL,MAAM,CAAC,KACP,EAAE,CAAC,eAAe,YAClB,EAAE,CAAC,WAAW;QAEjB,MAAM,aAAa,KAAK,IAAI,CAAC,CAAC,cAAc,CAAC,IAAI;QAEjD,IAAI,IAAI,CAAC;YACP,SAAS;YACT,QAAQ,UAAU,EAAE;YACpB,qBAAqB,eAAe,UAAU;YAC9C,YAAY;gBACV,aAAa;gBACb,UAAU;gBACV,YAAY,cAAc;gBAC1B;gBACA,SAAS,OAAO;YAClB;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAyB;IACzD;AACF;AAKO,MAAM,uBAAuC,OAAO,KAAK;IAC9D,IAAI;QACF,MAAM,aAAa,AAAC,IAAY,UAAU;QAC1C,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,MAAM;QAE9B,IAAI,CAAC,cAAc,CAAC,SAAS;YAC3B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAe;QACtD;QAEA,YAAY;QACZ,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,SACT,MAAM;QAET,IAAI,cAAc,CAAC,OAAO;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,kCAAkC;QAClC,IAAI,MAAM,WAAW,KAAK,YAAY;YACpC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAe;QACtD;QAEA,eAAe;QACf,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,aAAa,EAAE,GAAG,MAAM,SACpD,IAAI,CAAC,kBACL,MAAM,CAAC,KACP,EAAE,CAAC,YAAY,SACf,KAAK,CAAC,cAAc;YAAE,WAAW;QAAK;QAEzC,IAAI,eAAe;YACjB,QAAQ,KAAK,CAAC,4BAA4B;YAC1C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAgC;QACvE;QAEA,4BAA4B;QAC5B,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,uBACL,MAAM,CAAC,MACP,EAAE,CAAC,YAAY,SACf,EAAE,CAAC,eAAe,YAClB,EAAE,CAAC,WAAW,OACd,MAAM;QAET,IAAI,cAAc;YAChB,MAAM,SACH,IAAI,CAAC,uBACL,MAAM,CAAC;gBAAE,SAAS;gBAAM,SAAS,IAAI,OAAO,WAAW;YAAG,GAC1D,EAAE,CAAC,MAAM,aAAa,EAAE;QAC7B;QAEA,MAAM,cAA2B;YAC/B,GAAI,KAAK;YACT,UAAW,YAAY,EAAE;QAC3B;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,OAAO;QACT;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAgC;IAChE;AACF;AAKO,MAAM,qBAAqC,OAAO,KAAK;IAC5D,IAAI;QACF,MAAM,aAAa,AAAC,IAAY,UAAU;QAC1C,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,MAAM;QAE9B,IAAI,CAAC,cAAc,CAAC,SAAS;YAC3B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAe;QACtD;QAEA,YAAY;QACZ,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,SACT,MAAM;QAET,IAAI,cAAc,CAAC,OAAO;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,kCAAkC;QAClC,IAAI,MAAM,WAAW,KAAK,YAAY;YACpC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAe;QACtD;QAEA,sBAAsB;QACtB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,UACL,MAAM,CAAC;YACN,QAAQ;YACR,YAAY,IAAI,OAAO,WAAW;QACpC,GACC,EAAE,CAAC,MAAM;QAEZ,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,0BAA0B;YACxC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA0B;QACjE;QAEA,4BAA4B;QAC5B,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,aACL,MAAM,CAAC,gCACP,EAAE,CAAC,MAAM,YACT,MAAM;QAET,MAAM,SAAS,IAAI,CAAC,uBAAuB,MAAM,CAAC;YAChD,aAAa;YACb,UAAU;YACV,mBAAmB;YACnB,SAAS,GAAG,cAAc,WAAW,CAAC,EAAE,cAAc,UAAU,qCAAqC,EAAE,MAAM,QAAQ,EAAE;YACvH,SAAS;QACX;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,SAAS;YACT,QAAQ;QACV;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA0B;IAC1D;AACF;AAKO,MAAM,kBAAkC,OAAO,KAAK;IACzD,IAAI;QACF,MAAM,aAAa,AAAC,IAAY,UAAU;QAC1C,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,MAAM;QAC9B,MAAM,EAAE,aAAa,EAAE,GAAG,IAAI,IAAI;QAElC,IAAI,CAAC,cAAc,CAAC,SAAS;YAC3B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAe;QACtD;QAEA,YAAY;QACZ,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,SACT,MAAM;QAET,IAAI,cAAc,CAAC,OAAO;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,kCAAkC;QAClC,IAAI,MAAM,WAAW,KAAK,YAAY;YACpC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAe;QACtD;QAEA,sBAAsB;QACtB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,UACL,MAAM,CAAC;YACN,QAAQ;YACR,gBAAgB,iBAAiB;YACjC,YAAY,IAAI,OAAO,WAAW;QACpC,GACC,EAAE,CAAC,MAAM;QAEZ,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,wBAAwB;YACtC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAuB;QAC9D;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,SAAS;YACT,QAAQ;QACV;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAuB;IACvD;AACF;AAKO,MAAM,wBAAwC,OAAO,KAAK;IAC/D,IAAI;QACF,MAAM,aAAa,AAAC,IAAY,UAAU;QAC1C,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,MAAM;QAC9B,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,IAAI;QAE5B,IAAI,CAAC,cAAc,CAAC,WAAW,CAAC,SAAS;YACvC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA0B;QACjE;QAEA,YAAY;QACZ,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,SACT,MAAM;QAET,IAAI,cAAc,CAAC,OAAO;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,kCAAkC;QAClC,IAAI,MAAM,WAAW,KAAK,YAAY;YACpC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAe;QACtD;QAEA,cAAc;QACd,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,SAClD,IAAI,CAAC,kBACL,MAAM,CAAC;YACN,UAAU;YACV,aAAa;YACb;QACF,GACC,MAAM,GACN,MAAM;QAET,IAAI,cAAc;YAChB,QAAQ,KAAK,CAAC,yBAAyB;YACvC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAwB;QAC/D;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sBAAsB;QACpC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAwB;IACxD;AACF;AAKO,MAAM,8BAA8C,OAAO,KAAK;IACrE,IAAI;QACF,MAAM,aAAa,AAAC,IAAY,UAAU;QAE1C,IAAI,CAAC,YAAY;YACf,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAe;QACtD;QAEA,MAAM,EAAE,MAAM,aAAa,EAAE,KAAK,EAAE,GAAG,MAAM,SAC1C,IAAI,CAAC,uBACL,MAAM,CAAC,KACP,EAAE,CAAC,eAAe,YAClB,EAAE,CAAC,WAAW,OACd,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM;QAE1C,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,iCAAiC;YAC/C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAgC;QACvE;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,eAAe,iBAAiB,EAAE;QACpC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAgC;IAChE;AACF;AAKO,MAAM,4BAA4C,OAAO,KAAK;IACnE,IAAI;QACF,MAAM,EACJ,aAAa,EACb,WAAW,EACX,eAAe,EACf,QAAQ,EACR,QAAQ,EACR,OAAO,EACR,GAAG,IAAI,IAAI;QAEZ,IAAI,CAAC,aAAa;YAChB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA4B;QACnE;QAEA,IAAI,CAAC,eAAe;YAClB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA6B;QACpE;QAEA,0BAA0B;QAC1B,IAAI;QACJ,MAAM,EAAE,MAAM,gBAAgB,EAAE,GAAG,MAAM,SACtC,IAAI,CAAC,aACL,MAAM,CAAC,MACP,EAAE,CAAC,SAAS,eACZ,WAAW;QAEd,IAAI,kBAAkB;YACpB,qBAAqB,iBAAiB,EAAE;QAC1C,OAAO;YACL,sBAAsB;YACtB,MAAM,aAAa,cAAc,KAAK,CAAC;YACvC,MAAM,EAAE,MAAM,WAAW,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SACrD,IAAI,CAAC,aACL,MAAM,CAAC;gBACN,OAAO;gBACP,YAAY,UAAU,CAAC,EAAE;gBACzB,WAAW;YACb,GACC,MAAM,CAAC,MACP,MAAM;YAET,IAAI,CAAC,aAAa;gBAChB,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;oBAAE,OAAO;gBAAmC;YACtD;YACA,qBAAqB,YAAY,EAAE;QACrC;QAEA,IAAI;QACJ,IAAI;QAEJ,4DAA4D;QAC5D,IAAI,SAAS;YACX,eAAe;YACf,iBAAiB;YACjB,QAAQ,GAAG,CAAC,gDAAgD;QAC9D,OAEK,IAAI,YAAY,UAAU;YAC7B,IAAI;gBACF,MAAM,SAAS,OAAO,IAAI,CAAC,UAAU;gBACrC,MAAM,YAAY,KAAK,GAAG;gBAC1B,MAAM,iBAAiB,CAAC,MAAM,EAAE,UAAU,CAAC,EAAE,UAAU;gBACvD,MAAM,aAAa,CAAC,OAAO,EAAE,gBAAgB;gBAE7C,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAAS,OAAO,CAClD,IAAI,CAAC,UACL,MAAM,CAAC,YAAY,QAAQ;oBAC1B,cAAc;oBACd,QAAQ;oBACR,aAAa;gBACf;gBAEF,IAAI,aAAa;oBACf,QAAQ,KAAK,CAAC,yBAAyB;oBACvC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;wBAAE,OAAO;oBAAwB;gBAC/D;gBAEA,MAAM,EAAE,MAAM,aAAa,EAAE,GAAG,SAAS,OAAO,CAC7C,IAAI,CAAC,UACL,YAAY,CAAC;gBAEhB,eAAe,cAAc,SAAS;gBACtC,iBAAiB;gBACjB,QAAQ,GAAG,CAAC,sCAAsC;YACpD,EAAE,OAAO,WAAW;gBAClB,QAAQ,KAAK,CAAC,0BAA0B;gBACxC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAyB;YAChE;QACF;QAEA,oDAAoD;QACpD,+EAA+E;QAC/E,IAAI,kBAAiC;QAErC,MAAM,EAAE,MAAM,aAAa,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,UACL,MAAM,CAAC,MACP,EAAE,CAAC,eAAe,oBAClB,EAAE,CAAC,UAAU,WACb,KAAK,CAAC,GACN,WAAW;QAEd,IAAI,eAAe;YACjB,kBAAkB,cAAc,EAAE;QACpC,OAAO;YACL,6BAA6B;YAC7B,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,UACL,MAAM,CAAC;gBACN,aAAa;gBACb,QAAQ;gBACR,OAAO;gBACP,OAAO,EAAE;YACX,GACC,MAAM,CAAC,MACP,MAAM;YAET,IAAI,UAAU;gBACZ,kBAAkB,SAAS,EAAE;YAC/B;QACF;QAEA,yFAAyF;QACzF,mFAAmF;QACnF,MAAM,eAAoB;YACxB,aAAa;YACb,aAAa,kBACT,GAAG,gBAAgB,GAAG,EAAE,aAAa,GACrC;YACJ,UAAU;YACV,WAAW;YACX,QAAQ;QACV;QAEA,kCAAkC;QAClC,IAAI,iBAAiB;YACnB,aAAa,QAAQ,GAAG;QAC1B;QAEA,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,UACL,MAAM,CAAC,cACP,MAAM,GACN,MAAM;QAET,IAAI,YAAY;YACd,QAAQ,KAAK,CAAC,yBAAyB;YACvC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAuB;QAC9D;QAEA,4EAA4E;QAC5E,MAAM,sBAAsB,MAAM,IAAA,iKAAuB,EAAC;YACxD,cAAc;YACd,YAAY,MAAM,EAAE;YACpB,gBAAgB;YAChB,YAAY;YACZ,WAAW;QACb;QAEA,MAAM,sBAAsB,MAAM,IAAA,iKAAuB,EAAC;YACxD,cAAc;YACd,YAAY,MAAM,EAAE;YACpB,gBAAgB;YAChB,YAAY;YACZ,WAAW;QACb;QAEA,IAAI,CAAC,oBAAoB,OAAO,IAAI,CAAC,oBAAoB,OAAO,EAAE;YAChE,QAAQ,KAAK,CAAC;YACd,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAuB;QAC9D;QAEA,mBAAmB;QACnB,IAAI,QAAQ,GAAG,CAAC,cAAc,IAAI,QAAQ;YACxC,IAAI;gBACF,MAAM,UAAU,QAAQ,GAAG,CAAC,YAAY,IAAI;gBAC5C,0CAA0C;gBAC1C,MAAM,eAAe,GAAG,QAAQ,qBAAqB,EAAE,oBAAoB,KAAK,CAAC,eAAe,CAAC;gBACjG,MAAM,eAAe,GAAG,QAAQ,qBAAqB,EAAE,oBAAoB,KAAK,CAAC,cAAc,CAAC;gBAEhG,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,aACL,MAAM,CAAC,yBACP,EAAE,CAAC,MAAM,oBACT,MAAM;gBAET,MAAM,eAAe,UAAU,aAC3B,GAAG,SAAS,UAAU,GAAG,SAAS,SAAS,GAAG,MAAM,SAAS,SAAS,GAAG,IAAI,GAC7E;gBAEJ,sBAAsB;gBACtB,MAAM,YAAY,IAAA,iKAAsB,EAAC;oBACvC;oBACA,kBAAkB;oBAClB,cAAc;oBACd;oBACA;oBACA;gBACF;gBAEA,wBAAwB;gBACxB,MAAM,cAAc,MAAM,OAAO,MAAM,CAAC,IAAI,CAAC;oBAC3C,MAAM;oBACN,IAAI;oBACJ,SAAS,CAAC,0BAA0B,EAAE,kBAAkB,CAAC,GAAG,EAAE,iBAAiB,GAAG,IAAI;oBACtF,MAAM;gBACR;gBAEA,IAAI,YAAY,KAAK,EAAE;oBACrB,QAAQ,KAAK,CAAC,8BAA8B,YAAY,KAAK;gBAC/D,OAAO;oBACL,QAAQ,GAAG,CAAC,kCAAkC,YAAY,IAAI;gBAChE;YACF,EAAE,OAAO,YAAY;gBACnB,QAAQ,KAAK,CAAC,2CAA2C;YAC3D;QACF;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT;YACA,SAAS;QACX;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAuB;IACvD;AACF;AAKO,MAAM,4BAA4C,OAAO,KAAK;IACnE,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,MAAM;QAE9B,IAAI,CAAC,SAAS;YACZ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAuB;QAC9D;QAEA,MAAM,EAAE,MAAM,KAAK,EAAE,KAAK,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,UACL,MAAM,CACL,CAAC;;;;MAIH,CAAC,EAEA,EAAE,CAAC,MAAM,SACT,MAAM;QAET,IAAI,SAAS,CAAC,OAAO;YACnB,QAAQ,KAAK,CAAC,gCAAgC;YAC9C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA8B;IAC9D;AACF;AAKO,MAAM,uBAAuC,OAAO,KAAK;IAC9D,IAAI;QACF,MAAM,OAAO,KAAK,GAAG,CAAC,GAAG,SAAS,IAAI,KAAK,CAAC,IAAI,KAAe;QAC/D,MAAM,OAAO,AAAC,IAAI,KAAK,CAAC,IAAI,IAAe;QAC3C,MAAM,QAAQ,KAAK,GAAG,CACpB,GACA,KAAK,GAAG,CAAC,IAAI,SAAS,IAAI,KAAK,CAAC,KAAK,KAAe;QAEtD,MAAM,SAAS,CAAC,OAAO,CAAC,IAAI;QAC5B,MAAM,aAAa,AAAC,IAAI,KAAK,CAAC,IAAI,IAAe;QACjD,MAAM,eAAe,AAAC,IAAI,KAAK,CAAC,MAAM,IAAe;QAErD,wBAAwB;QACxB,IAAI,aAAa,SACd,IAAI,CAAC,UACL,MAAM,CAAC,KAAK;YAAE,OAAO;YAAS,MAAM;QAAK;QAE5C,6BAA6B;QAC7B,IAAI,aAAa,SAAS,IAAI,CAAC,UAAU,MAAM,CAC7C,CAAC;;;MAGD,CAAC;QAGH,gCAAgC;QAChC,IAAI,YAAY;YACd,MAAM,aAAa,GAAG,WAAW,cAAc,CAAC;YAChD,MAAM,WAAW,GAAG,WAAW,cAAc,CAAC;YAC9C,aAAa,WACV,GAAG,CAAC,cAAc,YAClB,GAAG,CAAC,cAAc;YACrB,aAAa,WACV,GAAG,CAAC,cAAc,YAClB,GAAG,CAAC,cAAc;QACvB;QAEA,kCAAkC;QAClC,IAAI,cAAc;YAChB,aAAa,WAAW,EAAE,CAAC,UAAU;YACrC,aAAa,WAAW,EAAE,CAAC,UAAU;QACvC;QAEA,kBAAkB;QAClB,MAAM,EAAE,OAAO,UAAU,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM;QAEvD,IAAI,YAAY;YACd,QAAQ,KAAK,CAAC,gCAAgC;YAC9C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,gDAAgD;QAChD,MAAM,gBAAgB,SAAS,WAAW,OAAO;QACjD,MAAM,EAAE,MAAM,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,WACnC,KAAK,CAAC,cAAc;YAAE,WAAW;QAAc,GAC/C,KAAK,CAAC,QAAQ,SAAS,QAAQ;QAElC,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,gCAAgC;YAC9C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAyB;QAChE;QAEA,iCAAiC;QACjC,MAAM,EAAE,MAAM,aAAa,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,uBACL,MAAM,CAAC,KACP,EAAE,CAAC,WAAW;QAEjB,MAAM,aAAa,KAAK,IAAI,CAAC,CAAC,cAAc,CAAC,IAAI;QAEjD,IAAI,IAAI,CAAC;YACP,SAAS;YACT,QAAQ,CAAC,UAAU,EAAE,EAAE,GAAG,CAAC,CAAC,QAAe,CAAC;oBAC1C,IAAI,MAAM,EAAE;oBACZ,SAAS,MAAM,QAAQ;oBACvB,YAAY,MAAM,WAAW;oBAC7B,cAAc,MAAM,SAAS,GACzB,GAAG,MAAM,SAAS,CAAC,UAAU,IAAI,GAAG,CAAC,EAAE,MAAM,SAAS,CAAC,SAAS,IAAI,IAAI,CAAC,IAAI,KAC7E;oBACJ,eAAe,MAAM,SAAS,EAAE,SAAS;oBACzC,QAAQ,MAAM,MAAM;oBACpB,cAAc,MAAM,QAAQ;oBAC5B,YAAY,MAAM,UAAU;oBAC5B,WAAW,MAAM,UAAU;gBAC7B,CAAC;YACD,qBAAqB,eAAe,UAAU;YAC9C,YAAY;gBACV,aAAa;gBACb,UAAU;gBACV,YAAY,cAAc;gBAC1B;gBACA,SAAS,OAAO;YAClB;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAyB;IACzD;AACF;AAKO,MAAM,6BAA6C,OAAO,KAAK;IACpE,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,MAAM;QAC9B,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,UAAU,EAAE,GAAG,IAAI,IAAI;QAEjD,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,SAAS;YACpC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA0B;QACjE;QAEA,YAAY;QACZ,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,SACT,MAAM;QAET,IAAI,cAAc,CAAC,OAAO;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,cAAc;QACd,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,SAClD,IAAI,CAAC,kBACL,MAAM,CAAC;YACN,UAAU;YACV,UAAU;YACV,aAAa;YACb;QACF,GACC,MAAM,GACN,MAAM;QAET,IAAI,cAAc;YAChB,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAwB;QAC/D;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAwB;IACxD;AACF;AASO,MAAM,6BAA6C,OAAO,KAAK;IACpE,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,GAAG,IAAI,KAAK;QAE3B,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;YACvC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,6DAA6D;QAC7D,MAAM,aAAa,MAAM,IAAA,mKAAyB,EAAC,OAAO;QAC1D,IAAI,CAAC,WAAW,OAAO,EAAE;YACvB,8CAA8C;YAC9C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,MAAM,UAAU,WAAW,UAAU;QAErC,YAAY;QACZ,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,SACT,MAAM;QAET,IAAI,cAAc,CAAC,OAAO;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,eAAe;QACf,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,aAAa,EAAE,GAAG,MAAM,SACpD,IAAI,CAAC,kBACL,MAAM,CAAC,KACP,EAAE,CAAC,YAAY,SACf,KAAK,CAAC,cAAc;YAAE,WAAW;QAAK;QAEzC,IAAI,eAAe;YACjB,QAAQ,KAAK,CAAC,4BAA4B;YAC1C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,OAAO;gBACL,GAAG,KAAK;gBACR,UAAU,YAAY,EAAE;YAC1B;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kCAAkC;QAChD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAkB;IAClD;AACF;AASO,MAAM,8BAA8C,OAAO,KAAK;IACrE,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,GAAG,IAAI,KAAK;QAE3B,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;YACvC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,uEAAuE;QACvE,MAAM,aAAa,MAAM,IAAA,mKAAyB,EAAC,OAAO;QAC1D,IAAI,CAAC,WAAW,OAAO,EAAE;YACvB,8CAA8C;YAC9C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,MAAM,UAAU,WAAW,UAAU;QAErC,YAAY;QACZ,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,SACT,MAAM;QAET,IAAI,cAAc,CAAC,OAAO;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,sBAAsB;QACtB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,UACL,MAAM,CAAC;YACN,QAAQ;YACR,YAAY,IAAI,OAAO,WAAW;QACpC,GACC,EAAE,CAAC,MAAM;QAEZ,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,0BAA0B;YACxC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,SAAS;YACT,QAAQ;QACV;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA0B;IAC1D;AACF;AASO,MAAM,6BAA6C,OAAO,KAAK;IACpE,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,GAAG,IAAI,KAAK;QAC3B,MAAM,EAAE,cAAc,EAAE,GAAG,IAAI,IAAI;QAEnC,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;YACvC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,uEAAuE;QACvE,MAAM,aAAa,MAAM,IAAA,mKAAyB,EAAC,OAAO;QAC1D,IAAI,CAAC,WAAW,OAAO,EAAE;YACvB,8CAA8C;YAC9C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,MAAM,UAAU,WAAW,UAAU;QAErC,YAAY;QACZ,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,SACT,MAAM;QAET,IAAI,cAAc,CAAC,OAAO;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,sBAAsB;QACtB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,UACL,MAAM,CAAC;YACN,QAAQ;YACR,gBAAgB,kBAAkB;YAClC,YAAY,IAAI,OAAO,WAAW;QACpC,GACC,EAAE,CAAC,MAAM;QAEZ,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,SAAS;YACT,QAAQ;QACV;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAkB;IAClD;AACF;AASO,MAAM,2BAA2C,OAAO,KAAK;IAClE,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,GAAG,IAAI,KAAK;QAE3B,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;YACvC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,uEAAuE;QACvE,MAAM,aAAa,MAAM,IAAA,mKAAyB,EAAC,OAAO;QAC1D,IAAI,CAAC,WAAW,OAAO,EAAE;YACvB,8CAA8C;YAC9C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,MAAM,UAAU,WAAW,UAAU;QAErC,YAAY;QACZ,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,SACT,MAAM;QAET,IAAI,cAAc,CAAC,OAAO;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,sBAAsB;QACtB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,UACL,MAAM,CAAC;YACN,QAAQ;YACR,YAAY,IAAI,OAAO,WAAW;QACpC,GACC,EAAE,CAAC,MAAM;QAEZ,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,0BAA0B;YACxC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,4BAA4B;QAC5B,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,aACL,MAAM,CAAC,gCACP,EAAE,CAAC,MAAM,MAAM,WAAW,EAC1B,MAAM;QAET,MAAM,SAAS,IAAI,CAAC,uBAAuB,MAAM,CAAC;YAChD,aAAa,MAAM,WAAW;YAC9B,UAAU;YACV,mBAAmB;YACnB,SAAS,GAAG,cAAc,WAAW,CAAC,EAAE,cAAc,UAAU,qCAAqC,EAAE,MAAM,QAAQ,EAAE;YACvH,SAAS;QACX;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,SAAS;YACT,QAAQ;QACV;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAkB;IAClD;AACF;AASO,MAAM,wBAAwC,OAAO,KAAK;IAC/D,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,GAAG,IAAI,KAAK;QAC3B,MAAM,EAAE,cAAc,EAAE,GAAG,IAAI,IAAI;QAEnC,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;YACvC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,uEAAuE;QACvE,MAAM,aAAa,MAAM,IAAA,mKAAyB,EAAC,OAAO;QAC1D,IAAI,CAAC,WAAW,OAAO,EAAE;YACvB,8CAA8C;YAC9C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,MAAM,UAAU,WAAW,UAAU;QAErC,YAAY;QACZ,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,SACT,MAAM;QAET,IAAI,cAAc,CAAC,OAAO;YACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,sBAAsB;QACtB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,UACL,MAAM,CAAC;YACN,QAAQ;YACR,gBAAgB,kBAAkB;YAClC,YAAY,IAAI,OAAO,WAAW;QACpC,GACC,EAAE,CAAC,MAAM;QAEZ,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAkB;QACzD;QAEA,4BAA4B;QAC5B,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,aACL,MAAM,CAAC,gCACP,EAAE,CAAC,MAAM,MAAM,WAAW,EAC1B,MAAM;QAET,MAAM,SAAS,IAAI,CAAC,uBAAuB,MAAM,CAAC;YAChD,aAAa,MAAM,WAAW;YAC9B,UAAU;YACV,mBAAmB;YACnB,SAAS,GAAG,cAAc,WAAW,CAAC,EAAE,cAAc,UAAU,mDAAmD,EAAE,MAAM,QAAQ,EAAE;YACrI,SAAS;QACX;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,SAAS;YACT,QAAQ;QACV;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAkB;IAClD;AACF"}},
    {"offset": {"line": 12062, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/send-proof.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { Resend } from \"resend\";\r\nimport { randomUUID } from \"crypto\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL || \"\",\r\n  process.env.SUPABASE_SERVICE_KEY || \"\",\r\n);\r\n\r\nconst resend = process.env.RESEND_API_KEY\r\n  ? new Resend(process.env.RESEND_API_KEY)\r\n  : null;\r\n\r\nconst PROOF_EMAIL_FROM = \"sticky@stickerland.com\";\r\n\r\nexport const handleSendProofDirectly: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { email, subject, orderNumber, fileUrl, fileName } = req.body;\r\n\r\n    // Validation\r\n    if (!email) {\r\n      return res.status(400).json({ error: \"Customer email is required\" });\r\n    }\r\n\r\n    if (!subject) {\r\n      return res.status(400).json({ error: \"Proof subject is required\" });\r\n    }\r\n\r\n    if (!fileUrl) {\r\n      return res.status(400).json({ error: \"File URL is required\" });\r\n    }\r\n\r\n    // Generate unique proof ID using UUID\r\n    const proofId = randomUUID();\r\n\r\n    // Find or create customer record\r\n    let customerId: number | null = null;\r\n\r\n    // Try to find customer by email\r\n    const { data: existingCustomer, error: findError } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"id\")\r\n      .eq(\"email\", email)\r\n      .maybeSingle();\r\n\r\n    if (findError) {\r\n      console.error(\"Error finding customer:\", findError);\r\n    }\r\n\r\n    if (existingCustomer) {\r\n      customerId = existingCustomer.id;\r\n      console.log(\"Found existing customer:\", customerId);\r\n    } else {\r\n      // Create a temporary customer record for this email\r\n      const emailParts = email.split(\"@\");\r\n      const name = emailParts[0];\r\n\r\n      console.log(\"Creating new customer for email:\", email);\r\n\r\n      const { data: newCustomer, error: customerError } = await supabase\r\n        .from(\"customers\")\r\n        .insert({\r\n          email,\r\n          first_name: name,\r\n          last_name: \"Customer\",\r\n        })\r\n        .select(\"id\")\r\n        .single();\r\n\r\n      if (customerError) {\r\n        console.error(\"Error creating customer:\", customerError);\r\n        return res\r\n          .status(500)\r\n          .json({ error: \"Failed to create customer record\" });\r\n      }\r\n\r\n      if (newCustomer) {\r\n        customerId = newCustomer.id;\r\n        console.log(\"Created new customer with ID:\", customerId);\r\n      } else {\r\n        console.error(\"No customer data returned after insert\");\r\n        return res\r\n          .status(500)\r\n          .json({ error: \"Failed to create customer record\" });\r\n      }\r\n    }\r\n\r\n    // Create proof record in database\r\n    if (!customerId) {\r\n      console.error(\"Cannot create proof - no customer ID\");\r\n      return res.status(500).json({ error: \"Failed to resolve customer\" });\r\n    }\r\n\r\n    console.log(\"Creating proof record with customer ID:\", customerId);\r\n\r\n    // Build the proof record\r\n    let parsedOrderId: number | null = null;\r\n    if (orderNumber && !isNaN(parseInt(orderNumber))) {\r\n      parsedOrderId = parseInt(orderNumber);\r\n    } else {\r\n      // Use 0 as placeholder when no order number is provided\r\n      // This indicates a standalone proof not tied to a specific order\r\n      parsedOrderId = 0;\r\n    }\r\n\r\n    const proofRecordData = {\r\n      id: proofId,\r\n      order_id: parsedOrderId,\r\n      customer_id: customerId,\r\n      description: subject,\r\n      file_url: fileUrl,\r\n      file_name: fileName,\r\n      status: \"pending\",\r\n    };\r\n\r\n    console.log(\"Proof record data:\", JSON.stringify(proofRecordData));\r\n\r\n    const { data: proofRecord, error: proofError } = await supabase\r\n      .from(\"proofs\")\r\n      .insert(proofRecordData)\r\n      .select()\r\n      .single();\r\n\r\n    if (proofError) {\r\n      console.error(\"Error creating proof record:\", proofError);\r\n      return res\r\n        .status(500)\r\n        .json({ error: \"Failed to create proof record in database\" });\r\n    }\r\n\r\n    if (!proofRecord) {\r\n      console.error(\"No proof record returned after insert\");\r\n      return res.status(500).json({ error: \"Failed to create proof record\" });\r\n    }\r\n\r\n    console.log(\"Successfully created proof:\", proofId);\r\n\r\n    // Generate approval and revision links\r\n    const baseUrl = process.env.FRONTEND_URL || \"https://stickerland.app\";\r\n    const approvalLink = `${baseUrl}/proof/${proofId}/approve`;\r\n    const revisionLink = `${baseUrl}/proof/${proofId}/request-revisions`;\r\n\r\n    // Generate email HTML\r\n    const emailHtml = `\r\n    <!DOCTYPE html>\r\n    <html>\r\n      <head>\r\n        <meta charset=\"UTF-8\">\r\n        <style>\r\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n          .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n          .header { background-color: #000; color: #fff; padding: 20px; text-align: center; }\r\n          .content { background-color: #f9f9f9; padding: 20px; margin: 20px 0; }\r\n          .proof-image { max-width: 100%; height: auto; margin: 20px 0; border: 1px solid #ddd; border-radius: 8px; }\r\n          .button { display: inline-block; padding: 12px 24px; margin: 10px 5px; border-radius: 5px; text-decoration: none; font-weight: bold; }\r\n          .approve-btn { background-color: #22c55e; color: #fff; }\r\n          .revise-btn { background-color: #f59e0b; color: #fff; }\r\n          .footer { text-align: center; color: #666; font-size: 12px; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px; }\r\n        </style>\r\n      </head>\r\n      <body>\r\n        <div class=\"container\">\r\n          <div class=\"header\">\r\n            <h1>Your Design Proof is Ready</h1>\r\n          </div>\r\n          \r\n          <div class=\"content\">\r\n            <h2>${subject}</h2>\r\n            ${orderNumber ? `<p><strong>Order Reference:</strong> ${orderNumber}</p>` : \"\"}\r\n            \r\n            <p>We're excited to show you your design proof! Please review the image below.</p>\r\n            \r\n            <img src=\"${fileUrl}\" alt=\"Design Proof\" class=\"proof-image\" />\r\n            \r\n            <p><strong>What's next?</strong></p>\r\n            <p>Please let us know if you approve this design or if you'd like us to make any changes.</p>\r\n            \r\n            <div style=\"text-align: center; margin: 30px 0;\">\r\n              <a href=\"${approvalLink}\" class=\"button approve-btn\">‚úì Approve Design</a>\r\n              <a href=\"${revisionLink}\" class=\"button revise-btn\">‚úé Request Changes</a>\r\n            </div>\r\n          </div>\r\n          \r\n          <div class=\"footer\">\r\n            <p>&copy; 2026 Stickerland. All rights reserved.</p>\r\n            <p>Questions? Reply to this email or contact us at sticky@stickerland.com</p>\r\n          </div>\r\n        </div>\r\n      </body>\r\n    </html>\r\n    `;\r\n\r\n    // Send email via Resend\r\n    if (!resend) {\r\n      console.error(\"Resend API key not configured - cannot send email\");\r\n      return res.status(500).json({ error: \"Email service not configured\" });\r\n    }\r\n\r\n    console.log(\"Sending email to:\", email);\r\n\r\n    const emailResult = await resend.emails.send({\r\n      from: PROOF_EMAIL_FROM,\r\n      to: email,\r\n      subject: `Design Proof Ready: ${subject}`,\r\n      html: emailHtml,\r\n    });\r\n\r\n    if (emailResult.error) {\r\n      console.error(\"Error sending proof email:\", emailResult.error);\r\n      return res\r\n        .status(500)\r\n        .json({\r\n          error: \"Failed to send email: \" + JSON.stringify(emailResult.error),\r\n        });\r\n    }\r\n\r\n    console.log(\"Proof email sent successfully:\", emailResult.data?.id);\r\n\r\n    res.json({\r\n      success: true,\r\n      proofId,\r\n      message: \"Proof sent to customer successfully\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Send proof error:\", error);\r\n    res.status(500).json({ error: \"Failed to send proof\" });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 12269, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/emails/signup-confirmation.ts"],"sourcesContent":["export function generateSignupConfirmationEmail(params: {\r\n  customerName: string;\r\n  email: string;\r\n  verificationLink?: string;\r\n}): string {\r\n  const { customerName, email, verificationLink } = params;\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Welcome to Stickerland</title>\r\n  <style>\r\n    body {\r\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\r\n      margin: 0;\r\n      padding: 0;\r\n      background-color: #f9fafb;\r\n    }\r\n    .container {\r\n      max-width: 600px;\r\n      margin: 0 auto;\r\n      padding: 20px;\r\n    }\r\n    .header {\r\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n      color: white;\r\n      padding: 40px 20px;\r\n      border-radius: 8px 8px 0 0;\r\n      text-align: center;\r\n    }\r\n    .header h1 {\r\n      margin: 0 0 10px 0;\r\n      font-size: 32px;\r\n      font-weight: bold;\r\n    }\r\n    .header p {\r\n      margin: 0;\r\n      opacity: 0.9;\r\n      font-size: 16px;\r\n    }\r\n    .content {\r\n      background-color: #ffffff;\r\n      padding: 40px 30px;\r\n      margin-bottom: 20px;\r\n      border-radius: 0 0 8px 8px;\r\n    }\r\n    .content p {\r\n      margin: 0 0 20px 0;\r\n      color: #374151;\r\n      font-size: 16px;\r\n      line-height: 1.6;\r\n    }\r\n    .content h2 {\r\n      margin: 30px 0 15px 0;\r\n      color: #1f2937;\r\n      font-size: 20px;\r\n    }\r\n    .features {\r\n      background-color: #f3f4f6;\r\n      border-radius: 6px;\r\n      padding: 20px;\r\n      margin: 20px 0;\r\n    }\r\n    .feature-item {\r\n      margin: 10px 0;\r\n      padding-left: 25px;\r\n      position: relative;\r\n      color: #374151;\r\n    }\r\n    .feature-item:before {\r\n      content: \"‚úì\";\r\n      position: absolute;\r\n      left: 0;\r\n      color: #10b981;\r\n      font-weight: bold;\r\n      font-size: 18px;\r\n    }\r\n    .cta-button {\r\n      display: inline-block;\r\n      padding: 12px 30px;\r\n      background-color: #667eea;\r\n      color: white;\r\n      text-decoration: none;\r\n      border-radius: 6px;\r\n      font-weight: bold;\r\n      text-align: center;\r\n      margin: 20px 0;\r\n    }\r\n    .cta-button:hover {\r\n      background-color: #5568d3;\r\n    }\r\n    .footer {\r\n      text-align: center;\r\n      padding: 20px;\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      border-top: 1px solid #e5e7eb;\r\n    }\r\n    .footer p {\r\n      margin: 5px 0;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <!-- Header -->\r\n    <div class=\"header\">\r\n      <h1>üé® Welcome to Stickerland</h1>\r\n      <p>Your custom sticker design partner</p>\r\n    </div>\r\n\r\n    <!-- Content -->\r\n    <div class=\"content\">\r\n      <p>Hi <strong>${customerName}</strong>,</p>\r\n\r\n      <p>Welcome aboard! We're thrilled to have you join the Stickerland community. Your account has been successfully created, and you're ready to start designing amazing custom stickers.</p>\r\n\r\n      <h2>What you can do now:</h2>\r\n      <div class=\"features\">\r\n        <div class=\"feature-item\">Browse our product catalog</div>\r\n        <div class=\"feature-item\">Design your own custom stickers</div>\r\n        <div class=\"feature-item\">Track your orders in real-time</div>\r\n        <div class=\"feature-item\">Request design proofs and approvals</div>\r\n        <div class=\"feature-item\">Manage your account and preferences</div>\r\n        <div class=\"feature-item\">Build your design portfolio</div>\r\n      </div>\r\n\r\n      <p>Your account is associated with the email: <strong>${email}</strong></p>\r\n\r\n      ${\r\n        verificationLink\r\n          ? `\r\n      <p>Please confirm your email address to unlock all features:</p>\r\n      <a href=\"${verificationLink}\" class=\"cta-button\">Verify Email Address</a>\r\n      `\r\n          : \"\"\r\n      }\r\n\r\n      <p>If you have any questions or need assistance getting started, don't hesitate to reach out to our support team. We're here to help!</p>\r\n\r\n      <p>Happy designing!<br><strong>The Stickerland Team</strong></p>\r\n    </div>\r\n\r\n    <!-- Footer -->\r\n    <div class=\"footer\">\r\n      <p>¬© 2024 Stickerland. All rights reserved.</p>\r\n      <p>${email}</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,gCAAgC,MAI/C;IACC,MAAM,EAAE,YAAY,EAAE,KAAK,EAAE,gBAAgB,EAAE,GAAG;IAElD,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;oBA6GU,EAAE,aAAa;;;;;;;;;;;;;;4DAcyB,EAAE,MAAM;;MAE9D,EACE,mBACI,CAAC;;eAEE,EAAE,iBAAiB;MAC5B,CAAC,GACK,GACL;;;;;;;;;;SAUE,EAAE,MAAM;;;;;EAKf,CAAC;AACH"}},
    {"offset": {"line": 12424, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/emails/shipping-confirmation.ts"],"sourcesContent":["export function generateShippingConfirmationEmail(params: {\r\n  customerName: string;\r\n  orderNumber: string;\r\n  trackingNumber: string;\r\n  carrier: string;\r\n  trackingUrl: string;\r\n  estimatedDelivery: string;\r\n  orderLink: string;\r\n}): string {\r\n  const {\r\n    customerName,\r\n    orderNumber,\r\n    trackingNumber,\r\n    carrier,\r\n    trackingUrl,\r\n    estimatedDelivery,\r\n    orderLink,\r\n  } = params;\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Your Order Has Shipped - Stickerland</title>\r\n  <style>\r\n    body {\r\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\r\n      margin: 0;\r\n      padding: 0;\r\n      background-color: #f9fafb;\r\n    }\r\n    .container {\r\n      max-width: 600px;\r\n      margin: 0 auto;\r\n      padding: 20px;\r\n    }\r\n    .header {\r\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\r\n      color: white;\r\n      padding: 40px 20px;\r\n      border-radius: 8px 8px 0 0;\r\n      text-align: center;\r\n    }\r\n    .header h1 {\r\n      margin: 0 0 10px 0;\r\n      font-size: 32px;\r\n      font-weight: bold;\r\n    }\r\n    .header p {\r\n      margin: 0;\r\n      opacity: 0.9;\r\n      font-size: 16px;\r\n    }\r\n    .content {\r\n      background-color: #ffffff;\r\n      padding: 40px 30px;\r\n      margin-bottom: 20px;\r\n      border-radius: 0 0 8px 8px;\r\n    }\r\n    .content p {\r\n      margin: 0 0 20px 0;\r\n      color: #374151;\r\n      font-size: 16px;\r\n      line-height: 1.6;\r\n    }\r\n    .tracking-box {\r\n      background-color: #f0fdf4;\r\n      border: 2px solid #10b981;\r\n      border-radius: 6px;\r\n      padding: 20px;\r\n      margin: 20px 0;\r\n    }\r\n    .tracking-label {\r\n      color: #059669;\r\n      font-size: 12px;\r\n      font-weight: 600;\r\n      text-transform: uppercase;\r\n      margin-bottom: 8px;\r\n    }\r\n    .tracking-number {\r\n      color: #1f2937;\r\n      font-size: 24px;\r\n      font-weight: bold;\r\n      font-family: monospace;\r\n      margin-bottom: 15px;\r\n    }\r\n    .tracking-carrier {\r\n      color: #374151;\r\n      font-size: 14px;\r\n    }\r\n    .tracking-button {\r\n      display: inline-block;\r\n      padding: 10px 20px;\r\n      background-color: #10b981;\r\n      color: white;\r\n      text-decoration: none;\r\n      border-radius: 6px;\r\n      font-weight: bold;\r\n      text-align: center;\r\n      margin-top: 15px;\r\n      font-size: 14px;\r\n    }\r\n    .tracking-button:hover {\r\n      background-color: #059669;\r\n    }\r\n    .info-grid {\r\n      display: grid;\r\n      grid-template-columns: 1fr 1fr;\r\n      gap: 20px;\r\n      margin: 20px 0;\r\n    }\r\n    .info-item {\r\n      background-color: #f9fafb;\r\n      padding: 15px;\r\n      border-radius: 6px;\r\n      border-left: 4px solid #3b82f6;\r\n    }\r\n    .info-label {\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      font-weight: 600;\r\n      text-transform: uppercase;\r\n      margin-bottom: 5px;\r\n    }\r\n    .info-value {\r\n      color: #1f2937;\r\n      font-size: 16px;\r\n      font-weight: bold;\r\n    }\r\n    .cta-button {\r\n      display: inline-block;\r\n      padding: 12px 30px;\r\n      background-color: #3b82f6;\r\n      color: white;\r\n      text-decoration: none;\r\n      border-radius: 6px;\r\n      font-weight: bold;\r\n      text-align: center;\r\n      margin: 20px 0;\r\n    }\r\n    .cta-button:hover {\r\n      background-color: #2563eb;\r\n    }\r\n    .next-steps {\r\n      background-color: #fef3c7;\r\n      border-left: 4px solid #f59e0b;\r\n      padding: 15px;\r\n      margin: 20px 0;\r\n      border-radius: 4px;\r\n    }\r\n    .next-steps p {\r\n      color: #92400e;\r\n      margin: 0;\r\n      font-size: 14px;\r\n    }\r\n    .footer {\r\n      text-align: center;\r\n      padding: 20px;\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      border-top: 1px solid #e5e7eb;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <!-- Header -->\r\n    <div class=\"header\">\r\n      <h1>üì¶ Your Order Has Shipped!</h1>\r\n      <p>Your custom stickers are on their way</p>\r\n    </div>\r\n\r\n    <!-- Content -->\r\n    <div class=\"content\">\r\n      <p>Hi <strong>${customerName}</strong>,</p>\r\n\r\n      <p>Great news! Your order has been printed with care and shipped out. Your custom stickers are now on their way to you.</p>\r\n\r\n      <!-- Tracking Information -->\r\n      <div class=\"tracking-box\">\r\n        <div class=\"tracking-label\">Tracking Number</div>\r\n        <div class=\"tracking-number\">${trackingNumber}</div>\r\n        <div class=\"tracking-carrier\">Carrier: ${carrier}</div>\r\n        <a href=\"${trackingUrl}\" class=\"tracking-button\">Track Package ‚Üí</a>\r\n      </div>\r\n\r\n      <!-- Order Details -->\r\n      <div class=\"info-grid\">\r\n        <div class=\"info-item\">\r\n          <div class=\"info-label\">Order Number</div>\r\n          <div class=\"info-value\">#${orderNumber}</div>\r\n        </div>\r\n        <div class=\"info-item\">\r\n          <div class=\"info-label\">Estimated Delivery</div>\r\n          <div class=\"info-value\">${estimatedDelivery}</div>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- Next Steps -->\r\n      <div class=\"next-steps\">\r\n        <p>\r\n          <strong>What's next?</strong> Monitor your shipment using the tracking number above. \r\n          Your stickers should arrive within the estimated delivery window. If you have any issues, \r\n          our support team is here to help!\r\n        </p>\r\n      </div>\r\n\r\n      <a href=\"${orderLink}\" class=\"cta-button\">View Full Order Details</a>\r\n\r\n      <p style=\"margin-top: 30px; color: #6b7280; font-size: 14px;\">\r\n        Thank you for choosing Stickerland for your custom sticker needs. We hope you love your designs!\r\n      </p>\r\n    </div>\r\n\r\n    <!-- Footer -->\r\n    <div class=\"footer\">\r\n      <p>¬© 2024 Stickerland. All rights reserved.</p>\r\n      <p>Questions? Contact our support team anytime.</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,kCAAkC,MAQjD;IACC,MAAM,EACJ,YAAY,EACZ,WAAW,EACX,cAAc,EACd,OAAO,EACP,WAAW,EACX,iBAAiB,EACjB,SAAS,EACV,GAAG;IAEJ,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;oBA6JU,EAAE,aAAa;;;;;;;qCAOE,EAAE,eAAe;+CACP,EAAE,QAAQ;iBACxC,EAAE,YAAY;;;;;;;mCAOI,EAAE,YAAY;;;;kCAIf,EAAE,kBAAkB;;;;;;;;;;;;;eAavC,EAAE,UAAU;;;;;;;;;;;;;;;EAezB,CAAC;AACH"}},
    {"offset": {"line": 12641, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/emails/support-ticket-reply.ts"],"sourcesContent":["export function generateSupportTicketReplyEmail(params: {\r\n  customerName: string;\r\n  ticketNumber: string;\r\n  subject: string;\r\n  response: string;\r\n  viewLink: string;\r\n}): string {\r\n  const { customerName, ticketNumber, subject, response, viewLink } = params;\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Support Ticket Reply - Stickerland</title>\r\n  <style>\r\n    body {\r\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\r\n      margin: 0;\r\n      padding: 0;\r\n      background-color: #f9fafb;\r\n    }\r\n    .container {\r\n      max-width: 600px;\r\n      margin: 0 auto;\r\n      padding: 20px;\r\n    }\r\n    .header {\r\n      background-color: #ffffff;\r\n      padding: 30px;\r\n      border-radius: 8px 8px 0 0;\r\n      border-bottom: 3px solid #8b5cf6;\r\n      margin-bottom: 20px;\r\n    }\r\n    .header h1 {\r\n      margin: 0 0 10px 0;\r\n      color: #1f2937;\r\n      font-size: 24px;\r\n      font-weight: bold;\r\n    }\r\n    .header p {\r\n      margin: 0;\r\n      color: #6b7280;\r\n      font-size: 14px;\r\n    }\r\n    .content {\r\n      background-color: #ffffff;\r\n      padding: 30px;\r\n      margin-bottom: 20px;\r\n      border-radius: 8px;\r\n    }\r\n    .content p {\r\n      margin: 0 0 20px 0;\r\n      color: #374151;\r\n      font-size: 16px;\r\n      line-height: 1.6;\r\n    }\r\n    .ticket-info {\r\n      background-color: #f3f4f6;\r\n      padding: 15px;\r\n      border-radius: 6px;\r\n      margin: 20px 0;\r\n      border-left: 4px solid #8b5cf6;\r\n    }\r\n    .ticket-info-row {\r\n      display: grid;\r\n      grid-template-columns: 150px 1fr;\r\n      gap: 15px;\r\n      margin-bottom: 10px;\r\n      padding-bottom: 10px;\r\n      border-bottom: 1px solid #e5e7eb;\r\n    }\r\n    .ticket-info-row:last-child {\r\n      margin-bottom: 0;\r\n      padding-bottom: 0;\r\n      border-bottom: none;\r\n    }\r\n    .ticket-label {\r\n      font-weight: 600;\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      text-transform: uppercase;\r\n    }\r\n    .ticket-value {\r\n      color: #1f2937;\r\n      font-size: 14px;\r\n    }\r\n    .response-box {\r\n      background-color: #fef3c7;\r\n      border-left: 4px solid #f59e0b;\r\n      padding: 20px;\r\n      margin: 20px 0;\r\n      border-radius: 4px;\r\n    }\r\n    .response-box p {\r\n      color: #78350f;\r\n      margin: 0;\r\n      font-size: 15px;\r\n      line-height: 1.6;\r\n      white-space: pre-wrap;\r\n    }\r\n    .cta-button {\r\n      display: inline-block;\r\n      padding: 12px 30px;\r\n      background-color: #8b5cf6;\r\n      color: white;\r\n      text-decoration: none;\r\n      border-radius: 6px;\r\n      font-weight: bold;\r\n      text-align: center;\r\n      margin: 20px 0;\r\n    }\r\n    .cta-button:hover {\r\n      background-color: #7c3aed;\r\n    }\r\n    .reply-info {\r\n      background-color: #f0f9ff;\r\n      border-left: 4px solid #3b82f6;\r\n      padding: 15px;\r\n      margin: 20px 0;\r\n      border-radius: 4px;\r\n    }\r\n    .reply-info p {\r\n      color: #1e40af;\r\n      font-size: 13px;\r\n      margin: 5px 0;\r\n    }\r\n    .footer {\r\n      text-align: center;\r\n      padding: 20px;\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      border-top: 1px solid #e5e7eb;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <!-- Header -->\r\n    <div class=\"header\">\r\n      <h1>üí¨ Support Ticket Reply</h1>\r\n      <p>We've responded to your support request</p>\r\n    </div>\r\n\r\n    <!-- Content -->\r\n    <div class=\"content\">\r\n      <p>Hi <strong>${customerName}</strong>,</p>\r\n\r\n      <p>Thank you for reaching out to our support team. We've reviewed your inquiry and sent you a response. Please see the details below.</p>\r\n\r\n      <!-- Ticket Information -->\r\n      <div class=\"ticket-info\">\r\n        <div class=\"ticket-info-row\">\r\n          <div class=\"ticket-label\">Ticket #</div>\r\n          <div class=\"ticket-value\">${ticketNumber}</div>\r\n        </div>\r\n        <div class=\"ticket-info-row\">\r\n          <div class=\"ticket-label\">Subject</div>\r\n          <div class=\"ticket-value\">${subject}</div>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- Support Response -->\r\n      <p style=\"margin-top: 25px; color: #1f2937; font-weight: 600;\">Response from our team:</p>\r\n      <div class=\"response-box\">\r\n        <p>${response}</p>\r\n      </div>\r\n\r\n      <!-- Reply Information -->\r\n      <div class=\"reply-info\">\r\n        <p><strong>Want to respond?</strong> Click the button below to view your ticket and add a reply directly.</p>\r\n      </div>\r\n\r\n      <a href=\"${viewLink}\" class=\"cta-button\">View Ticket & Reply</a>\r\n\r\n      <p style=\"margin-top: 30px; color: #6b7280; font-size: 13px;\">\r\n        Thank you for your patience and for choosing Stickerland. \r\n        If you need further assistance, our support team is always here to help!\r\n      </p>\r\n    </div>\r\n\r\n    <!-- Footer -->\r\n    <div class=\"footer\">\r\n      <p>¬© 2024 Stickerland. All rights reserved.</p>\r\n      <p>Questions? Reply directly to this email or contact our support team.</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,gCAAgC,MAM/C;IACC,MAAM,EAAE,YAAY,EAAE,YAAY,EAAE,OAAO,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG;IAEpE,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;oBA0IU,EAAE,aAAa;;;;;;;;oCAQC,EAAE,aAAa;;;;oCAIf,EAAE,QAAQ;;;;;;;WAOnC,EAAE,SAAS;;;;;;;;eAQP,EAAE,SAAS;;;;;;;;;;;;;;;;EAgBxB,CAAC;AACH"}},
    {"offset": {"line": 12834, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/emails/order-status-update.ts"],"sourcesContent":["export function generateOrderStatusUpdateEmail(params: {\r\n  customerName: string;\r\n  orderNumber: string;\r\n  previousStatus: string;\r\n  currentStatus: string;\r\n  statusMessage: string;\r\n  nextSteps: string;\r\n  orderLink: string;\r\n}): string {\r\n  const {\r\n    customerName,\r\n    orderNumber,\r\n    previousStatus,\r\n    currentStatus,\r\n    statusMessage,\r\n    nextSteps,\r\n    orderLink,\r\n  } = params;\r\n\r\n  const getStatusColor = (status: string): { bgColor: string; textColor: string; emoji: string } => {\r\n    const statusLower = status.toLowerCase();\r\n    if (statusLower.includes(\"pending\") || statusLower.includes(\"received\")) {\r\n      return { bgColor: \"#fef3c7\", textColor: \"#92400e\", emoji: \"‚è≥\" };\r\n    }\r\n    if (statusLower.includes(\"confirmed\") || statusLower.includes(\"approved\")) {\r\n      return { bgColor: \"#dbeafe\", textColor: \"#1e40af\", emoji: \"‚úì\" };\r\n    }\r\n    if (statusLower.includes(\"processing\") || statusLower.includes(\"printing\")) {\r\n      return { bgColor: \"#fce7f3\", textColor: \"#831843\", emoji: \"‚öôÔ∏è\" };\r\n    }\r\n    if (statusLower.includes(\"shipped\") || statusLower.includes(\"dispatched\")) {\r\n      return { bgColor: \"#dcfce7\", textColor: \"#166534\", emoji: \"üì¶\" };\r\n    }\r\n    if (statusLower.includes(\"delivered\")) {\r\n      return { bgColor: \"#d1fae5\", textColor: \"#065f46\", emoji: \"‚úì\" };\r\n    }\r\n    if (statusLower.includes(\"cancelled\") || statusLower.includes(\"failed\")) {\r\n      return { bgColor: \"#fee2e2\", textColor: \"#7f1d1d\", emoji: \"‚úï\" };\r\n    }\r\n    return { bgColor: \"#f3f4f6\", textColor: \"#374151\", emoji: \"üìã\" };\r\n  };\r\n\r\n  const statusInfo = getStatusColor(currentStatus);\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Order Status Update - Stickerland</title>\r\n  <style>\r\n    body {\r\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\r\n      margin: 0;\r\n      padding: 0;\r\n      background-color: #f9fafb;\r\n    }\r\n    .container {\r\n      max-width: 600px;\r\n      margin: 0 auto;\r\n      padding: 20px;\r\n    }\r\n    .header {\r\n      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);\r\n      color: white;\r\n      padding: 40px 20px;\r\n      border-radius: 8px 8px 0 0;\r\n      text-align: center;\r\n    }\r\n    .header h1 {\r\n      margin: 0 0 10px 0;\r\n      font-size: 32px;\r\n      font-weight: bold;\r\n    }\r\n    .header p {\r\n      margin: 0;\r\n      opacity: 0.9;\r\n      font-size: 16px;\r\n    }\r\n    .content {\r\n      background-color: #ffffff;\r\n      padding: 40px 30px;\r\n      margin-bottom: 20px;\r\n      border-radius: 0 0 8px 8px;\r\n    }\r\n    .content p {\r\n      margin: 0 0 20px 0;\r\n      color: #374151;\r\n      font-size: 16px;\r\n      line-height: 1.6;\r\n    }\r\n    .status-box {\r\n      background-color: ${statusInfo.bgColor};\r\n      border: 2px solid ${statusInfo.textColor};\r\n      border-radius: 6px;\r\n      padding: 20px;\r\n      margin: 20px 0;\r\n    }\r\n    .status-label {\r\n      color: ${statusInfo.textColor};\r\n      font-size: 12px;\r\n      font-weight: 600;\r\n      text-transform: uppercase;\r\n      margin-bottom: 8px;\r\n    }\r\n    .status-value {\r\n      color: ${statusInfo.textColor};\r\n      font-size: 24px;\r\n      font-weight: bold;\r\n      margin-bottom: 8px;\r\n    }\r\n    .status-emoji {\r\n      font-size: 28px;\r\n      margin-right: 8px;\r\n      display: inline-block;\r\n    }\r\n    .status-message {\r\n      color: ${statusInfo.textColor};\r\n      font-size: 14px;\r\n      line-height: 1.5;\r\n      margin-top: 12px;\r\n    }\r\n    .status-transition {\r\n      background-color: #f3f4f6;\r\n      padding: 15px;\r\n      border-radius: 6px;\r\n      margin: 15px 0;\r\n      font-size: 13px;\r\n      color: #374151;\r\n    }\r\n    .info-grid {\r\n      display: grid;\r\n      grid-template-columns: 1fr 1fr;\r\n      gap: 20px;\r\n      margin: 20px 0;\r\n    }\r\n    .info-item {\r\n      background-color: #f9fafb;\r\n      padding: 15px;\r\n      border-radius: 6px;\r\n      border-left: 4px solid #3b82f6;\r\n    }\r\n    .info-label {\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      font-weight: 600;\r\n      text-transform: uppercase;\r\n      margin-bottom: 5px;\r\n    }\r\n    .info-value {\r\n      color: #1f2937;\r\n      font-size: 16px;\r\n      font-weight: bold;\r\n    }\r\n    .next-steps-box {\r\n      background-color: #eff6ff;\r\n      border-left: 4px solid #3b82f6;\r\n      padding: 15px;\r\n      margin: 20px 0;\r\n      border-radius: 4px;\r\n    }\r\n    .next-steps-box h4 {\r\n      margin: 0 0 10px 0;\r\n      color: #1e40af;\r\n      font-size: 14px;\r\n      font-weight: 600;\r\n    }\r\n    .next-steps-box p {\r\n      margin: 0;\r\n      color: #1e40af;\r\n      font-size: 14px;\r\n      line-height: 1.5;\r\n    }\r\n    .cta-button {\r\n      display: inline-block;\r\n      padding: 12px 30px;\r\n      background-color: #3b82f6;\r\n      color: white;\r\n      text-decoration: none;\r\n      border-radius: 6px;\r\n      font-weight: bold;\r\n      text-align: center;\r\n      margin: 20px 0;\r\n    }\r\n    .cta-button:hover {\r\n      background-color: #2563eb;\r\n    }\r\n    .footer {\r\n      text-align: center;\r\n      padding: 20px;\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      border-top: 1px solid #e5e7eb;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <!-- Header -->\r\n    <div class=\"header\">\r\n      <h1>üìã Order Status Update</h1>\r\n      <p>Your order status has changed</p>\r\n    </div>\r\n\r\n    <!-- Content -->\r\n    <div class=\"content\">\r\n      <p>Hi <strong>${customerName}</strong>,</p>\r\n\r\n      <p>We have an update on your order. Your current status is shown below:</p>\r\n\r\n      <!-- Status Box -->\r\n      <div class=\"status-box\">\r\n        <div class=\"status-label\">Current Order Status</div>\r\n        <div class=\"status-value\">\r\n          <span class=\"status-emoji\">${statusInfo.emoji}</span>\r\n          ${currentStatus}\r\n        </div>\r\n        <div class=\"status-message\">${statusMessage}</div>\r\n      </div>\r\n\r\n      <!-- Status Transition -->\r\n      <div class=\"status-transition\">\r\n        <strong>Status Changed:</strong> ${previousStatus} ‚Üí ${currentStatus}\r\n      </div>\r\n\r\n      <!-- Order Details -->\r\n      <div class=\"info-grid\">\r\n        <div class=\"info-item\">\r\n          <div class=\"info-label\">Order Number</div>\r\n          <div class=\"info-value\">#${orderNumber}</div>\r\n        </div>\r\n        <div class=\"info-item\">\r\n          <div class=\"info-label\">Status</div>\r\n          <div class=\"info-value\">${currentStatus}</div>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- Next Steps -->\r\n      <div class=\"next-steps-box\">\r\n        <h4>What's Next?</h4>\r\n        <p>${nextSteps}</p>\r\n      </div>\r\n\r\n      <a href=\"${orderLink}\" class=\"cta-button\">View Order Details</a>\r\n\r\n      <p style=\"margin-top: 30px; color: #6b7280; font-size: 14px;\">\r\n        <strong>Need help?</strong> If you have any questions about your order or its status, \r\n        please don't hesitate to reach out to our support team. We're here to help!\r\n      </p>\r\n    </div>\r\n\r\n    <!-- Footer -->\r\n    <div class=\"footer\">\r\n      <p>¬© 2024 Stickerland. All rights reserved.</p>\r\n      <p>Questions? Contact our support team anytime.</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,+BAA+B,MAQ9C;IACC,MAAM,EACJ,YAAY,EACZ,WAAW,EACX,cAAc,EACd,aAAa,EACb,aAAa,EACb,SAAS,EACT,SAAS,EACV,GAAG;IAEJ,MAAM,iBAAiB,CAAC;QACtB,MAAM,cAAc,OAAO,WAAW;QACtC,IAAI,YAAY,QAAQ,CAAC,cAAc,YAAY,QAAQ,CAAC,aAAa;YACvE,OAAO;gBAAE,SAAS;gBAAW,WAAW;gBAAW,OAAO;YAAI;QAChE;QACA,IAAI,YAAY,QAAQ,CAAC,gBAAgB,YAAY,QAAQ,CAAC,aAAa;YACzE,OAAO;gBAAE,SAAS;gBAAW,WAAW;gBAAW,OAAO;YAAI;QAChE;QACA,IAAI,YAAY,QAAQ,CAAC,iBAAiB,YAAY,QAAQ,CAAC,aAAa;YAC1E,OAAO;gBAAE,SAAS;gBAAW,WAAW;gBAAW,OAAO;YAAK;QACjE;QACA,IAAI,YAAY,QAAQ,CAAC,cAAc,YAAY,QAAQ,CAAC,eAAe;YACzE,OAAO;gBAAE,SAAS;gBAAW,WAAW;gBAAW,OAAO;YAAK;QACjE;QACA,IAAI,YAAY,QAAQ,CAAC,cAAc;YACrC,OAAO;gBAAE,SAAS;gBAAW,WAAW;gBAAW,OAAO;YAAI;QAChE;QACA,IAAI,YAAY,QAAQ,CAAC,gBAAgB,YAAY,QAAQ,CAAC,WAAW;YACvE,OAAO;gBAAE,SAAS;gBAAW,WAAW;gBAAW,OAAO;YAAI;QAChE;QACA,OAAO;YAAE,SAAS;YAAW,WAAW;YAAW,OAAO;QAAK;IACjE;IAEA,MAAM,aAAa,eAAe;IAElC,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;wBAiDc,EAAE,WAAW,OAAO,CAAC;wBACrB,EAAE,WAAW,SAAS,CAAC;;;;;;aAMlC,EAAE,WAAW,SAAS,CAAC;;;;;;;aAOvB,EAAE,WAAW,SAAS,CAAC;;;;;;;;;;;aAWvB,EAAE,WAAW,SAAS,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;oBAyFhB,EAAE,aAAa;;;;;;;;qCAQE,EAAE,WAAW,KAAK,CAAC;UAC9C,EAAE,cAAc;;oCAEU,EAAE,cAAc;;;;;yCAKX,EAAE,eAAe,GAAG,EAAE,cAAc;;;;;;;mCAO1C,EAAE,YAAY;;;;kCAIf,EAAE,cAAc;;;;;;;WAOvC,EAAE,UAAU;;;eAGR,EAAE,UAAU;;;;;;;;;;;;;;;;EAgBzB,CAAC;AACH"}},
    {"offset": {"line": 13115, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/email-preview.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { generateProofEmailHtml } from \"../emails/generate-proof-email\";\r\nimport { generateSignupConfirmationEmail } from \"../emails/signup-confirmation\";\r\nimport { generateOrderConfirmationEmail } from \"../emails/order-confirmation\";\r\nimport { generateShippingConfirmationEmail } from \"../emails/shipping-confirmation\";\r\nimport { generatePasswordResetEmail } from \"../emails/password-reset\";\r\nimport { generateSupportTicketReplyEmail } from \"../emails/support-ticket-reply\";\r\nimport { generateOrderStatusUpdateEmail } from \"../emails/order-status-update\";\r\nimport { formatOrderNumber } from \"../utils/order\";\r\nimport { Resend } from \"resend\";\r\n\r\nconst resend = process.env.RESEND_API_KEY\r\n  ? new Resend(process.env.RESEND_API_KEY)\r\n  : null;\r\nconst PROOF_EMAIL_FROM = \"sticky@stickerland.com\";\r\n\r\nexport const handleProofEmailPreview: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { email } = req.query;\r\n    const baseUrl = `${req.protocol}://${req.get(\"host\")}`;\r\n\r\n    const sampleHtml = generateProofEmailHtml({\r\n      customerName: \"John Doe\",\r\n      orderId: 12345,\r\n      proofDescription:\r\n        \"Custom sticker design with your company logo and tagline.\\n\\nThe design features:\\n- Vibrant color scheme\\n- High-resolution graphics\\n- Print-ready format\\n\\nPlease review and let us know if any changes are needed!\",\r\n      proofFileUrl:\r\n        \"https://images.unsplash.com/photo-1557821552-17105176677c?w=600&h=400&fit=crop\",\r\n      approvalLink: `${baseUrl}/proofs/sample_proof_123/approve`,\r\n      revisionLink: `${baseUrl}/proofs/sample_proof_123/request-revisions`,\r\n    });\r\n\r\n    // If email param is provided, send the email\r\n    if (email && typeof email === \"string\" && process.env.RESEND_API_KEY) {\r\n      try {\r\n        const result = await resend.emails.send({\r\n          from: PROOF_EMAIL_FROM,\r\n          to: email,\r\n          subject: \"Preview: Your Design Proof is Ready - Order #12345\",\r\n          html: sampleHtml,\r\n        });\r\n\r\n        if (result.error) {\r\n          console.error(\"Error sending preview email:\", result.error);\r\n          return res\r\n            .status(500)\r\n            .json({ error: \"Failed to send email\", details: result.error });\r\n        }\r\n\r\n        return res.json({\r\n          success: true,\r\n          message: `Preview email sent to ${email}`,\r\n          emailId: result.data?.id,\r\n        });\r\n      } catch (emailError) {\r\n        console.error(\"Error sending email:\", emailError);\r\n        return res.status(500).json({\r\n          error: \"Failed to send email\",\r\n          details:\r\n            emailError instanceof Error ? emailError.message : \"Unknown error\",\r\n        });\r\n      }\r\n    }\r\n\r\n    // Otherwise, return the HTML preview\r\n    res.setHeader(\"Content-Type\", \"text/html; charset=utf-8\");\r\n    res.send(sampleHtml);\r\n  } catch (error) {\r\n    console.error(\"Proof email preview error:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to process request\",\r\n      details: error instanceof Error ? error.message : \"Unknown error\",\r\n    });\r\n  }\r\n};\r\n\r\nexport const handleSignupConfirmationPreview: RequestHandler = (req, res) => {\r\n  const baseUrl = `${req.protocol}://${req.get(\"host\")}`;\r\n  const html = generateSignupConfirmationEmail({\r\n    customerName: \"Sarah Johnson\",\r\n    email: \"sarah@example.com\",\r\n    verificationLink: `${baseUrl}/verify?token=sample_verification_token_123`,\r\n  });\r\n  res.setHeader(\"Content-Type\", \"text/html; charset=utf-8\");\r\n  res.send(html);\r\n};\r\n\r\nexport const handleOrderConfirmationPreview: RequestHandler = (req, res) => {\r\n  const baseUrl = `${req.protocol}://${req.get(\"host\")}`;\r\n  const html = generateOrderConfirmationEmail({\r\n    customerName: \"John Smith\",\r\n    orderNumber: \"SS-2024-001\",\r\n    orderDate: \"December 15, 2024\",\r\n    items: [\r\n      {\r\n        name: \"Custom Circle Stickers (100 units)\",\r\n        quantity: 1,\r\n        price: 29.99,\r\n        designFileUrl:\r\n          \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2310b981' stroke='%23059669' stroke-width='2'/%3E%3Ctext x='50' y='50' font-size='20' fill='white' text-anchor='middle' dominant-baseline='central'%3EDESIGN%3C/text%3E%3C/svg%3E\",\r\n        options: [{ option_id: \"size\", option_value: \"3 inch\" }],\r\n      },\r\n      { name: \"Glossy Finish\", quantity: 1, price: 5.0, options: [] },\r\n    ],\r\n    subtotal: 34.99,\r\n    tax: 2.8,\r\n    shipping: 5.0,\r\n    total: 42.79,\r\n    estimatedDelivery: \"Dec 22, 2024\",\r\n    orderLink: `${baseUrl}/order-history/12345`,\r\n    shippingAddress: {\r\n      firstName: \"John\",\r\n      lastName: \"Smith\",\r\n      street: \"123 Main Street\",\r\n      street2: \"Apt 4B\",\r\n      city: \"New York\",\r\n      state: \"NY\",\r\n      postalCode: \"10001\",\r\n      country: \"United States\",\r\n    },\r\n    policies: {\r\n      returnAndRefund: true,\r\n      privacy: true,\r\n      gdpr: true,\r\n      ccpa: true,\r\n      terms: true,\r\n      shipping: true,\r\n    },\r\n  });\r\n  res.setHeader(\"Content-Type\", \"text/html; charset=utf-8\");\r\n  res.send(html);\r\n};\r\n\r\nexport const handleShippingConfirmationPreview: RequestHandler = (req, res) => {\r\n  const baseUrl = `${req.protocol}://${req.get(\"host\")}`;\r\n  const html = generateShippingConfirmationEmail({\r\n    customerName: \"John Smith\",\r\n    orderNumber: formatOrderNumber(1),\r\n    trackingNumber: \"1Z999AA10123456784\",\r\n    carrier: \"UPS\",\r\n    trackingUrl: \"https://www.ups.com/track?tracknum=1Z999AA10123456784\",\r\n    estimatedDelivery: \"December 22, 2024\",\r\n    orderLink: `${baseUrl}/order-history/12345`,\r\n  });\r\n  res.setHeader(\"Content-Type\", \"text/html; charset=utf-8\");\r\n  res.send(html);\r\n};\r\n\r\nexport const handlePasswordResetPreview: RequestHandler = (req, res) => {\r\n  const baseUrl = `${req.protocol}://${req.get(\"host\")}`;\r\n  const html = generatePasswordResetEmail({\r\n    customerName: \"Sarah Johnson\",\r\n    resetLink: `${baseUrl}/reset-password?token=sample_reset_token_abc123def456`,\r\n    expiresIn: \"1 hour\",\r\n  });\r\n  res.setHeader(\"Content-Type\", \"text/html; charset=utf-8\");\r\n  res.send(html);\r\n};\r\n\r\nexport const handleSupportTicketReplyPreview: RequestHandler = (req, res) => {\r\n  const baseUrl = `${req.protocol}://${req.get(\"host\")}`;\r\n  const html = generateSupportTicketReplyEmail({\r\n    customerName: \"Michael Chen\",\r\n    ticketNumber: \"TKT-2024-0042\",\r\n    subject: \"Question about sticker material options\",\r\n    response: `Hi Michael,\r\n\r\nThank you for reaching out! We're happy to help answer your question about our sticker materials.\r\n\r\nWe offer several options for your custom stickers:\r\n\r\n1. Vinyl (Standard): Durable and weather-resistant, perfect for outdoor use\r\n2. Glossy Finish: High-shine appearance with vibrant colors\r\n3. Matte Finish: Subtle, professional look with reduced glare\r\n4. Holographic: Eye-catching reflective surface for premium designs\r\n\r\nAll materials are high-quality and designed to last. The choice depends on your use case and aesthetic preferences.\r\n\r\nWould you like recommendations for your specific project? Feel free to share more details about what you're planning!\r\n\r\nBest regards,\r\nStickerland Support Team`,\r\n    viewLink: `${baseUrl}/my-tickets/TKT-2024-0042`,\r\n  });\r\n  res.setHeader(\"Content-Type\", \"text/html; charset=utf-8\");\r\n  res.send(html);\r\n};\r\n\r\nexport const handleOrderStatusUpdatePreview: RequestHandler = (req, res) => {\r\n  const baseUrl = `${req.protocol}://${req.get(\"host\")}`;\r\n  const html = generateOrderStatusUpdateEmail({\r\n    customerName: \"John Smith\",\r\n    orderNumber: formatOrderNumber(1),\r\n    previousStatus: \"Order Confirmed\",\r\n    currentStatus: \"Processing\",\r\n    statusMessage:\r\n      \"Your order is now being prepared for production. Our team is working on bringing your design to life with precision and care.\",\r\n    nextSteps:\r\n      \"Your custom stickers will be carefully printed and inspected for quality. Once approved, they will be packaged and shipped to you. You'll receive a notification as soon as your order ships.\",\r\n    orderLink: `${baseUrl}/order-history/12345`,\r\n  });\r\n  res.setHeader(\"Content-Type\", \"text/html; charset=utf-8\");\r\n  res.send(html);\r\n};\r\n\r\nexport const handleSendProofEmailPreview: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { email } = req.body;\r\n\r\n    if (!email) {\r\n      return res.status(400).json({ error: \"Email address is required\" });\r\n    }\r\n\r\n    if (!process.env.RESEND_API_KEY) {\r\n      return res.status(500).json({ error: \"Email service not configured\" });\r\n    }\r\n\r\n    const sampleHtml = generateProofEmailHtml({\r\n      customerName: \"John Doe\",\r\n      orderId: 12345,\r\n      proofDescription:\r\n        \"Custom sticker design with your company logo and tagline.\\n\\nThe design features:\\n- Vibrant color scheme\\n- High-resolution graphics\\n- Print-ready format\\n\\nPlease review and let us know if any changes are needed!\",\r\n      proofFileUrl:\r\n        \"https://images.unsplash.com/photo-1557821552-17105176677c?w=600&h=400&fit=crop\",\r\n      approvalLink:\r\n        \"https://51be3d6708344836a6f6586ec48b1e4b-476bca083d854b2a92cc8cfa4.fly.dev/proofs/preview123/approve\",\r\n      revisionLink:\r\n        \"https://51be3d6708344836a6f6586ec48b1e4b-476bca083d854b2a92cc8cfa4.fly.dev/proofs/preview123/request-revisions\",\r\n    });\r\n\r\n    const result = await resend.emails.send({\r\n      from: PROOF_EMAIL_FROM,\r\n      to: email,\r\n      subject: \"Preview: Your Design Proof is Ready - Order #12345\",\r\n      html: sampleHtml,\r\n    });\r\n\r\n    if (result.error) {\r\n      console.error(\"Error sending preview email:\", result.error);\r\n      return res.status(500).json({ error: \"Failed to send email\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: `Preview email sent to ${email}`,\r\n      emailId: result.data?.id,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Send preview email error:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to send email\",\r\n      message: error instanceof Error ? error.message : \"Unknown error\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 13392, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/admin-customers.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { supabase } from \"../utils/supabase\";\r\n\r\ninterface Customer {\r\n  id: number;\r\n  email: string;\r\n  firstName: string;\r\n  lastName: string;\r\n  phone?: string;\r\n  storeCredit: number;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n  orderCount: number;\r\n  totalSpent: number;\r\n  lastOrderDate?: string;\r\n}\r\n\r\n/**\r\n * Get all customers with their order information (admin only)\r\n * Returns a list of all customers who have signed up or placed orders\r\n * Includes order counts, total spending, and other metrics\r\n */\r\nexport const handleGetAllCustomers: RequestHandler = async (req, res) => {\r\n  try {\r\n    // Fetch all customers with their orders\r\n    const { data: customers, error: customersError } = await supabase\r\n      .from(\"customers\")\r\n      .select(\r\n        `\r\n        id,\r\n        email,\r\n        first_name,\r\n        last_name,\r\n        phone,\r\n        store_credit,\r\n        created_at,\r\n        updated_at,\r\n        orders (\r\n          id,\r\n          total,\r\n          status,\r\n          created_at\r\n        )\r\n      `,\r\n      )\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (customersError) {\r\n      console.error(\"Error fetching customers:\", customersError);\r\n      return res.status(500).json({ error: \"Failed to fetch customers\" });\r\n    }\r\n\r\n    // Format customers with aggregated data\r\n    const formattedCustomers: Customer[] = (customers || []).map(\r\n      (customer: any) => {\r\n        const orders = customer.orders || [];\r\n        const totalSpent = orders.reduce(\r\n          (sum: number, order: any) => sum + (order.total || 0),\r\n          0,\r\n        );\r\n        const lastOrder = orders.length > 0 ? orders[0] : null;\r\n\r\n        return {\r\n          id: customer.id,\r\n          email: customer.email,\r\n          firstName: customer.first_name || \"\",\r\n          lastName: customer.last_name || \"\",\r\n          phone: customer.phone,\r\n          storeCredit: customer.store_credit || 0,\r\n          createdAt: customer.created_at,\r\n          updatedAt: customer.updated_at,\r\n          orderCount: orders.length,\r\n          totalSpent,\r\n          lastOrderDate: lastOrder?.created_at,\r\n        };\r\n      },\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      customers: formattedCustomers,\r\n      count: formattedCustomers.length,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get all customers error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to fetch customers\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Get customer details with full order history (admin only)\r\n * Returns detailed information about a specific customer\r\n */\r\nexport const handleGetCustomerDetails: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { customerId } = req.params;\r\n\r\n    if (!customerId) {\r\n      return res.status(400).json({ error: \"Customer ID is required\" });\r\n    }\r\n\r\n    const { data: customer, error: customerError } = await supabase\r\n      .from(\"customers\")\r\n      .select(\r\n        `\r\n        id,\r\n        email,\r\n        first_name,\r\n        last_name,\r\n        phone,\r\n        store_credit,\r\n        created_at,\r\n        updated_at,\r\n        orders (\r\n          id,\r\n          total,\r\n          status,\r\n          created_at,\r\n          order_items (\r\n            id,\r\n            product_name,\r\n            quantity,\r\n            price\r\n          )\r\n        )\r\n      `,\r\n      )\r\n      .eq(\"id\", customerId)\r\n      .single();\r\n\r\n    if (customerError || !customer) {\r\n      return res.status(404).json({ error: \"Customer not found\" });\r\n    }\r\n\r\n    const orders = customer.orders || [];\r\n    const totalSpent = orders.reduce(\r\n      (sum: number, order: any) => sum + (order.total || 0),\r\n      0,\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      customer: {\r\n        id: customer.id,\r\n        email: customer.email,\r\n        firstName: customer.first_name || \"\",\r\n        lastName: customer.last_name || \"\",\r\n        phone: customer.phone,\r\n        company: customer.company,\r\n        storeCredit: customer.store_credit || 0,\r\n        createdAt: customer.created_at,\r\n        updatedAt: customer.updated_at,\r\n        orderCount: orders.length,\r\n        totalSpent,\r\n        orders: orders.map((order: any) => ({\r\n          id: order.id,\r\n          total: order.total,\r\n          status: order.status,\r\n          createdAt: order.created_at,\r\n          itemCount: (order.order_items || []).length,\r\n        })),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get customer details error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to fetch customer\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n\r\n/**\r\n * Search customers by name or email (admin only)\r\n */\r\nexport const handleSearchCustomers: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { query } = req.query;\r\n\r\n    if (!query || typeof query !== \"string\") {\r\n      return res.status(400).json({ error: \"Search query is required\" });\r\n    }\r\n\r\n    const searchTerm = `%${query}%`;\r\n\r\n    // Search customers by name or email\r\n    const { data: customers, error } = await supabase\r\n      .from(\"customers\")\r\n      .select(\r\n        `\r\n        id,\r\n        email,\r\n        first_name,\r\n        last_name,\r\n        phone,\r\n        store_credit,\r\n        created_at,\r\n        updated_at,\r\n        orders (\r\n          id,\r\n          total,\r\n          status,\r\n          created_at\r\n        )\r\n      `,\r\n      )\r\n      .or(\r\n        `email.ilike.${searchTerm},first_name.ilike.${searchTerm},last_name.ilike.${searchTerm}`,\r\n      );\r\n\r\n    if (error) {\r\n      console.error(\"Error searching customers:\", error);\r\n      return res.status(500).json({ error: \"Failed to search customers\" });\r\n    }\r\n\r\n    const formattedCustomers: Customer[] = (customers || []).map(\r\n      (customer: any) => {\r\n        const orders = customer.orders || [];\r\n        const totalSpent = orders.reduce(\r\n          (sum: number, order: any) => sum + (order.total || 0),\r\n          0,\r\n        );\r\n        const lastOrder = orders.length > 0 ? orders[0] : null;\r\n\r\n        return {\r\n          id: customer.id,\r\n          email: customer.email,\r\n          firstName: customer.first_name || \"\",\r\n          lastName: customer.last_name || \"\",\r\n          phone: customer.phone,\r\n          storeCredit: customer.store_credit || 0,\r\n          createdAt: customer.created_at,\r\n          updatedAt: customer.updated_at,\r\n          orderCount: orders.length,\r\n          totalSpent,\r\n          lastOrderDate: lastOrder?.created_at,\r\n        };\r\n      },\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      customers: formattedCustomers,\r\n      count: formattedCustomers.length,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Search customers error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to search customers\";\r\n    res.status(500).json({ error: message });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 13603, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/admin-analytics.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { supabase } from \"../utils/supabase\";\r\n\r\n// Removed local Supabase initialization in favor of shared client\r\n// const supabase = createClient(...)\r\n\r\ninterface AnalyticsData {\r\n  activeUsers: number;\r\n  totalPageViews: number;\r\n  totalRevenue: number;\r\n  totalOrders: number;\r\n  conversionRate: number;\r\n  avgOrderValue: number;\r\n  devices: {\r\n    mobile: number;\r\n    desktop: number;\r\n    tablet: number;\r\n  };\r\n  trafficSources: {\r\n    direct: number;\r\n    google: number;\r\n    facebook: number;\r\n    instagram: number;\r\n    other: number;\r\n  };\r\n  topPages: Array<{ path: string; views: number }>;\r\n  topProducts: Array<{\r\n    id: number;\r\n    name: string;\r\n    sales: number;\r\n    revenue: number;\r\n  }>;\r\n  topDesigns: Array<{ id: number; name: string; uses: number }>;\r\n  revenueByDay: Array<{ date: string; revenue: number; orders: number }>;\r\n  customerMetrics: {\r\n    totalCustomers: number;\r\n    newCustomersThisMonth: number;\r\n    repeatCustomers: number;\r\n    avgCustomerLifetimeValue: number;\r\n  };\r\n}\r\n\r\n/**\r\n * Get comprehensive analytics data from database\r\n */\r\nexport const handleGetAnalytics: RequestHandler = async (req, res) => {\r\n  try {\r\n    const thirtyDaysAgo = new Date();\r\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n\r\n    // Fetch page view events (with fallback if columns don't exist)\r\n    let pageViewEvents = null;\r\n    try {\r\n      const { data: events } = await supabase\r\n        .from(\"analytics_events\")\r\n        .select(\"event_type, created_at\", {\r\n          count: \"exact\",\r\n        })\r\n        .eq(\"event_type\", \"page_view\")\r\n        .gte(\"created_at\", thirtyDaysAgo.toISOString());\r\n      pageViewEvents = events;\r\n    } catch (analyticsError) {\r\n      // Analytics table may not be properly set up, continue without it\r\n      console.warn(\"Analytics query failed, continuing without analytics data\");\r\n    }\r\n\r\n    // Fetch orders data\r\n    const { data: orders } = await supabase\r\n      .from(\"orders\")\r\n      .select(\r\n        \"id, total, customer_id, created_at, order_items(product_name, quantity)\",\r\n      )\r\n      .gte(\"created_at\", thirtyDaysAgo.toISOString());\r\n\r\n    // Fetch customers\r\n    const { data: customers } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"id, created_at\");\r\n\r\n    // Calculate metrics\r\n    const totalPageViews = pageViewEvents?.length || 0;\r\n    // Count unique session_ids instead of page_path (which may not exist)\r\n    const uniqueUsers = pageViewEvents?.length || 0;\r\n\r\n    const totalRevenue =\r\n      orders?.reduce((sum, order) => sum + (order.total || 0), 0) || 0;\r\n    const totalOrders = orders?.length || 0;\r\n    const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;\r\n    const conversionRate =\r\n      totalPageViews > 0 ? (totalOrders / uniqueUsers) * 100 : 0;\r\n\r\n    // Device breakdown (columns don't exist yet - use placeholder data)\r\n    const devices = {\r\n      mobile: 0,\r\n      desktop: totalPageViews,\r\n      tablet: 0,\r\n    };\r\n\r\n    // Traffic sources (columns don't exist yet - use placeholder data)\r\n    const trafficSources = {\r\n      direct: Math.floor(totalPageViews * 0.3),\r\n      google: Math.floor(totalPageViews * 0.4),\r\n      facebook: Math.floor(totalPageViews * 0.2),\r\n      instagram: Math.floor(totalPageViews * 0.07),\r\n      other: Math.floor(totalPageViews * 0.03),\r\n    };\r\n\r\n    // Top pages (disabled - page_path column doesn't exist)\r\n    // TODO: Implement proper page tracking with session data\r\n    const topPages = [];\r\n\r\n    // Product sales (from order_items)\r\n    const productSales = new Map<\r\n      string,\r\n      { quantity: number; revenue: number }\r\n    >();\r\n    orders?.forEach((order) => {\r\n      order.order_items?.forEach((item: any) => {\r\n        const key = item.product_name;\r\n        const current = productSales.get(key) || { quantity: 0, revenue: 0 };\r\n        productSales.set(key, {\r\n          quantity: current.quantity + (item.quantity || 0),\r\n          revenue: current.revenue + (item.quantity || 0) * 0.5, // Placeholder calculation\r\n        });\r\n      });\r\n    });\r\n\r\n    const topProducts = Array.from(productSales.entries())\r\n      .map(([name], index) => ({\r\n        id: index,\r\n        name,\r\n        sales: productSales.get(name)?.quantity || 0,\r\n        revenue: productSales.get(name)?.revenue || 0,\r\n      }))\r\n      .sort((a, b) => b.sales - a.sales)\r\n      .slice(0, 5);\r\n\r\n    // Revenue by day\r\n    const revenueByDay = new Map<string, { revenue: number; orders: number }>();\r\n    orders?.forEach((order) => {\r\n      const date = new Date(order.created_at).toISOString().split(\"T\")[0];\r\n      const current = revenueByDay.get(date) || { revenue: 0, orders: 0 };\r\n      revenueByDay.set(date, {\r\n        revenue: current.revenue + (order.total || 0),\r\n        orders: current.orders + 1,\r\n      });\r\n    });\r\n\r\n    const revenueByDayArray = Array.from(revenueByDay.entries())\r\n      .map(([date, data]) => ({ date, ...data }))\r\n      .sort((a, b) => a.date.localeCompare(b.date));\r\n\r\n    // Customer metrics\r\n    const newCustomersThisMonth =\r\n      customers?.filter((c) => new Date(c.created_at) > thirtyDaysAgo).length ||\r\n      0;\r\n    const repeatCustomers = new Set(\r\n      orders?.filter((o) => o.customer_id).map((o) => o.customer_id),\r\n    ).size;\r\n    const totalCustomers = customers?.length || 0;\r\n    const avgCustomerLifetimeValue =\r\n      totalCustomers > 0 ? totalRevenue / totalCustomers : 0;\r\n\r\n    const analyticsData: AnalyticsData = {\r\n      activeUsers: uniqueUsers,\r\n      totalPageViews,\r\n      totalRevenue,\r\n      totalOrders,\r\n      conversionRate: parseFloat(conversionRate.toFixed(2)),\r\n      avgOrderValue: parseFloat(avgOrderValue.toFixed(2)),\r\n      devices,\r\n      trafficSources,\r\n      topPages,\r\n      topProducts,\r\n      topDesigns: [], // Placeholder for designs tracking\r\n      revenueByDay: revenueByDayArray,\r\n      customerMetrics: {\r\n        totalCustomers,\r\n        newCustomersThisMonth,\r\n        repeatCustomers,\r\n        avgCustomerLifetimeValue: parseFloat(\r\n          avgCustomerLifetimeValue.toFixed(2),\r\n        ),\r\n      },\r\n    };\r\n\r\n    return res.json(analyticsData);\r\n  } catch (error) {\r\n    console.error(\"Error fetching analytics:\", error);\r\n    return res.status(500).json({\r\n      error: \"Failed to fetch analytics data\",\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Track analytics event\r\n */\r\nexport const handleTrackEvent: RequestHandler = async (req, res) => {\r\n  try {\r\n    const {\r\n      event_type,\r\n      event_name,\r\n      session_id,\r\n      page_path,\r\n      referrer,\r\n      device_type,\r\n      browser,\r\n      country,\r\n      data,\r\n    } = req.body;\r\n    const token = req.headers.authorization?.split(\"Bearer \")[1];\r\n\r\n    if (!event_type || !event_name) {\r\n      return res.status(400).json({ error: \"Missing required fields\" });\r\n    }\r\n\r\n    // Respond immediately - don't block on database insert\r\n    res.json({ success: true });\r\n\r\n    // Process event asynchronously in background\r\n    (async () => {\r\n      try {\r\n        let userId: string | null = null;\r\n        if (token) {\r\n          const { data: userData } = await supabase.auth.getUser(token);\r\n          userId = userData.user?.id || null;\r\n        }\r\n\r\n        // Only insert fields that definitely exist in the table\r\n        // Note: Supabase schema cache may be stale, so we use minimal fields\r\n        const eventData: any = {\r\n          event_type,\r\n          event_name,\r\n          user_id: userId,\r\n        };\r\n\r\n        // Optionally add browser and country if provided (less likely to have schema issues)\r\n        if (browser) eventData.browser = browser;\r\n        if (country) eventData.country = country;\r\n        if (data) eventData.data = data;\r\n\r\n        // Skip optional fields that have schema cache issues: session_id, page_path, referrer, device_type\r\n\r\n        const { error } = await supabase\r\n          .from(\"analytics_events\")\r\n          .insert(eventData);\r\n\r\n        if (error) {\r\n          console.error(\"Error tracking event:\", error);\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Error processing analytics event:\", error);\r\n      }\r\n    })();\r\n  } catch (error) {\r\n    console.error(\"Error in analytics handler:\", error);\r\n    return res.status(400).json({ error: \"Invalid request\" });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 13783, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/admin-finance.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\n\r\ninterface FinanceStats {\r\n  totalRevenue: number;\r\n  monthlyRevenue: number;\r\n  averageOrderValue: number;\r\n  totalOrders: number;\r\n  revenueChange: number;\r\n  orderChange: number;\r\n}\r\n\r\n/**\r\n * Get finance data (mock data for now)\r\n * In a real implementation, this would fetch from your orders/payments database\r\n */\r\nexport const handleGetFinance: RequestHandler = async (req, res) => {\r\n  try {\r\n    // Mock finance data\r\n    // In production, this would be calculated from your orders and payment records\r\n    const financeData: FinanceStats = {\r\n      totalRevenue: 5847.32,\r\n      monthlyRevenue: 2145.67,\r\n      averageOrderValue: 127.45,\r\n      totalOrders: 46,\r\n      revenueChange: 12.5,\r\n      orderChange: 8.3,\r\n    };\r\n\r\n    return res.json(financeData);\r\n  } catch (error) {\r\n    console.error(\"Error fetching finance data:\", error);\r\n    return res.status(500).json({\r\n      error: \"Failed to fetch finance data\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;AAeO,MAAM,mBAAmC,OAAO,KAAK;IAC1D,IAAI;QACF,oBAAoB;QACpB,+EAA+E;QAC/E,MAAM,cAA4B;YAChC,cAAc;YACd,gBAAgB;YAChB,mBAAmB;YACnB,aAAa;YACb,eAAe;YACf,aAAa;QACf;QAEA,OAAO,IAAI,IAAI,CAAC;IAClB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAC1B,OAAO;QACT;IACF;AACF"}},
    {"offset": {"line": 13811, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/utils/shipstation.ts"],"sourcesContent":["const SHIPSTATION_API_V2_URL = \"https://api.shipstation.com\";\r\n\r\ninterface ShipmentDetails {\r\n  carrierCode: string;\r\n  serviceCode: string;\r\n  packageCode: string;\r\n  weight: {\r\n    value: number;\r\n    units: \"ounces\" | \"pounds\";\r\n  };\r\n  dimensions?: {\r\n    length: number;\r\n    width: number;\r\n    height: number;\r\n    units: \"inches\" | \"centimeters\";\r\n  };\r\n  insuranceOptions?: {\r\n    insured: boolean;\r\n    insureAmount?: number;\r\n  };\r\n  internationalOptions?: {\r\n    contents?: string;\r\n    nonDelivery?: string;\r\n  };\r\n}\r\n\r\ninterface ShippingAddress {\r\n  name: string;\r\n  street1: string;\r\n  street2?: string;\r\n  city: string;\r\n  state: string;\r\n  postalCode: string;\r\n  country: string;\r\n  phone?: string;\r\n}\r\n\r\ninterface CreateLabelPayload {\r\n  orderId: number;\r\n  shipmentDetails: ShipmentDetails;\r\n  toAddress: ShippingAddress;\r\n  testLabel?: boolean;\r\n}\r\n\r\ninterface LabelResponse {\r\n  labelDownload?: {\r\n    href: string;\r\n  };\r\n  labelId?: number;\r\n  tracking?: string;\r\n  error?: string;\r\n}\r\n\r\nexport class ShipStationAPI {\r\n  private apiKey: string;\r\n  private apiUrl: string;\r\n\r\n  constructor() {\r\n    this.apiKey = process.env.SHIPSTATION_API_KEY || \"\";\r\n    this.apiUrl = SHIPSTATION_API_V2_URL;\r\n    // Don't throw error on initialization - allow lazy initialization\r\n    // Error will be thrown when API methods are called if key is missing\r\n  }\r\n\r\n  private ensureApiKey(): void {\r\n    if (!this.apiKey) {\r\n      throw new Error(\"SHIPSTATION_API_KEY environment variable is not set\");\r\n    }\r\n  }\r\n\r\n  private getAuthHeader(): string {\r\n    // ShipStation v2 API uses Bearer token authentication\r\n    return `Bearer ${this.apiKey}`;\r\n  }\r\n\r\n  async createShippingLabel(\r\n    payload: CreateLabelPayload,\r\n  ): Promise<LabelResponse> {\r\n    this.ensureApiKey();\r\n    try {\r\n      const response = await fetch(`${this.apiUrl}/orders/createlabel`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          Authorization: this.getAuthHeader(),\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(payload),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const error = await response.json().catch(() => ({}));\r\n        console.error(\"ShipStation API error:\", error);\r\n        throw new Error(\r\n          error.message ||\r\n            `Failed to create shipping label: ${response.status}`,\r\n        );\r\n      }\r\n\r\n      const data = await response.json();\r\n      return data;\r\n    } catch (error) {\r\n      console.error(\"ShipStation API request failed:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async getCarriers(): Promise<any[]> {\r\n    // Return hardcoded common carriers\r\n    // ShipStation v2 API has different endpoints, so we'll use standard carriers\r\n    const carriers = [\r\n      { name: \"USPS\", code: \"usps\" },\r\n      { name: \"UPS\", code: \"ups\" },\r\n      { name: \"FedEx\", code: \"fedex\" },\r\n      { name: \"DHL Express\", code: \"dhl_express\" },\r\n      { name: \"OnTrac\", code: \"ontrac\" },\r\n    ];\r\n\r\n    console.log(\"Returning hardcoded carriers:\", carriers.length);\r\n    return carriers;\r\n  }\r\n\r\n  async getServices(carrierCode: string): Promise<any[]> {\r\n    // Return services based on carrier\r\n    const servicesByCarrier: Record<string, any[]> = {\r\n      usps: [\r\n        { name: \"USPS First Class Mail\", code: \"usps_first_class_mail\" },\r\n        { name: \"USPS Priority Mail\", code: \"usps_priority_mail\" },\r\n        {\r\n          name: \"USPS Priority Mail Express\",\r\n          code: \"usps_priority_mail_express\",\r\n        },\r\n        { name: \"USPS Media Mail\", code: \"usps_media_mail\" },\r\n        { name: \"USPS Parcel Select\", code: \"usps_parcel_select\" },\r\n      ],\r\n      ups: [\r\n        { name: \"UPS Ground\", code: \"ups_ground\" },\r\n        { name: \"UPS 3 Day Select\", code: \"ups_3_day_select\" },\r\n        { name: \"UPS 2nd Day Air\", code: \"ups_2nd_day_air\" },\r\n        { name: \"UPS Next Day Air\", code: \"ups_next_day_air\" },\r\n        { name: \"UPS Next Day Air Saver\", code: \"ups_next_day_air_saver\" },\r\n      ],\r\n      fedex: [\r\n        { name: \"FedEx Ground\", code: \"fedex_ground\" },\r\n        { name: \"FedEx Home Delivery\", code: \"fedex_home_delivery\" },\r\n        { name: \"FedEx 2Day\", code: \"fedex_2day\" },\r\n        { name: \"FedEx Overnight\", code: \"fedex_overnight\" },\r\n        { name: \"FedEx Priority Overnight\", code: \"fedex_priority_overnight\" },\r\n      ],\r\n      dhl_express: [\r\n        { name: \"DHL Express 12:00\", code: \"dhl_express_12_00\" },\r\n        { name: \"DHL Express Worldwide\", code: \"dhl_express_worldwide\" },\r\n      ],\r\n      ontrac: [\r\n        { name: \"OnTrac Ground\", code: \"ontrac_ground\" },\r\n        { name: \"OnTrac Plus\", code: \"ontrac_plus\" },\r\n      ],\r\n    };\r\n\r\n    const services = servicesByCarrier[carrierCode] || [];\r\n    console.log(\r\n      `Returning ${services.length} services for carrier: ${carrierCode}`,\r\n    );\r\n    return services;\r\n  }\r\n\r\n  async getRates(payload: any): Promise<any[]> {\r\n    // For now, return empty rates array\r\n    // In a full implementation, this would call ShipStation v2 rates API\r\n    console.log(\"Rates requested but returning empty array\");\r\n    return [];\r\n  }\r\n}\r\n\r\nexport const shipstationAPI = new ShipStationAPI();\r\n"],"names":[],"mappings":";;;;;;AAAA,MAAM,yBAAyB;AAqDxB,MAAM;IACH,OAAe;IACf,OAAe;IAEvB,aAAc;QACZ,IAAI,CAAC,MAAM,GAAG,QAAQ,GAAG,CAAC,mBAAmB,IAAI;QACjD,IAAI,CAAC,MAAM,GAAG;IACd,kEAAkE;IAClE,qEAAqE;IACvE;IAEQ,eAAqB;QAC3B,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;YAChB,MAAM,IAAI,MAAM;QAClB;IACF;IAEQ,gBAAwB;QAC9B,sDAAsD;QACtD,OAAO,CAAC,OAAO,EAAE,IAAI,CAAC,MAAM,EAAE;IAChC;IAEA,MAAM,oBACJ,OAA2B,EACH;QACxB,IAAI,CAAC,YAAY;QACjB,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,mBAAmB,CAAC,EAAE;gBAChE,QAAQ;gBACR,SAAS;oBACP,eAAe,IAAI,CAAC,aAAa;oBACjC,gBAAgB;gBAClB;gBACA,MAAM,KAAK,SAAS,CAAC;YACvB;YAEA,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,MAAM,QAAQ,MAAM,SAAS,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;gBACnD,QAAQ,KAAK,CAAC,0BAA0B;gBACxC,MAAM,IAAI,MACR,MAAM,OAAO,IACX,CAAC,iCAAiC,EAAE,SAAS,MAAM,EAAE;YAE3D;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,OAAO;QACT,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,mCAAmC;YACjD,MAAM;QACR;IACF;IAEA,MAAM,cAA8B;QAClC,mCAAmC;QACnC,6EAA6E;QAC7E,MAAM,WAAW;YACf;gBAAE,MAAM;gBAAQ,MAAM;YAAO;YAC7B;gBAAE,MAAM;gBAAO,MAAM;YAAM;YAC3B;gBAAE,MAAM;gBAAS,MAAM;YAAQ;YAC/B;gBAAE,MAAM;gBAAe,MAAM;YAAc;YAC3C;gBAAE,MAAM;gBAAU,MAAM;YAAS;SAClC;QAED,QAAQ,GAAG,CAAC,iCAAiC,SAAS,MAAM;QAC5D,OAAO;IACT;IAEA,MAAM,YAAY,WAAmB,EAAkB;QACrD,mCAAmC;QACnC,MAAM,oBAA2C;YAC/C,MAAM;gBACJ;oBAAE,MAAM;oBAAyB,MAAM;gBAAwB;gBAC/D;oBAAE,MAAM;oBAAsB,MAAM;gBAAqB;gBACzD;oBACE,MAAM;oBACN,MAAM;gBACR;gBACA;oBAAE,MAAM;oBAAmB,MAAM;gBAAkB;gBACnD;oBAAE,MAAM;oBAAsB,MAAM;gBAAqB;aAC1D;YACD,KAAK;gBACH;oBAAE,MAAM;oBAAc,MAAM;gBAAa;gBACzC;oBAAE,MAAM;oBAAoB,MAAM;gBAAmB;gBACrD;oBAAE,MAAM;oBAAmB,MAAM;gBAAkB;gBACnD;oBAAE,MAAM;oBAAoB,MAAM;gBAAmB;gBACrD;oBAAE,MAAM;oBAA0B,MAAM;gBAAyB;aAClE;YACD,OAAO;gBACL;oBAAE,MAAM;oBAAgB,MAAM;gBAAe;gBAC7C;oBAAE,MAAM;oBAAuB,MAAM;gBAAsB;gBAC3D;oBAAE,MAAM;oBAAc,MAAM;gBAAa;gBACzC;oBAAE,MAAM;oBAAmB,MAAM;gBAAkB;gBACnD;oBAAE,MAAM;oBAA4B,MAAM;gBAA2B;aACtE;YACD,aAAa;gBACX;oBAAE,MAAM;oBAAqB,MAAM;gBAAoB;gBACvD;oBAAE,MAAM;oBAAyB,MAAM;gBAAwB;aAChE;YACD,QAAQ;gBACN;oBAAE,MAAM;oBAAiB,MAAM;gBAAgB;gBAC/C;oBAAE,MAAM;oBAAe,MAAM;gBAAc;aAC5C;QACH;QAEA,MAAM,WAAW,iBAAiB,CAAC,YAAY,IAAI,EAAE;QACrD,QAAQ,GAAG,CACT,CAAC,UAAU,EAAE,SAAS,MAAM,CAAC,uBAAuB,EAAE,aAAa;QAErE,OAAO;IACT;IAEA,MAAM,SAAS,OAAY,EAAkB;QAC3C,oCAAoC;QACpC,qEAAqE;QACrE,QAAQ,GAAG,CAAC;QACZ,OAAO,EAAE;IACX;AACF;AAEO,MAAM,iBAAiB,IAAI"}},
    {"offset": {"line": 13995, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/shipping.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { shipstationAPI } from \"../utils/shipstation\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL || \"\",\r\n  process.env.SUPABASE_SERVICE_KEY || \"\",\r\n);\r\n\r\nexport const handleCreateLabel: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { orderId, carrier, service, weight, dimensions, testLabel } =\r\n      req.body;\r\n\r\n    if (!orderId || !carrier || !service || !weight) {\r\n      return res.status(400).json({\r\n        error:\r\n          \"Missing required fields: orderId, carrier, service, weight are required\",\r\n      });\r\n    }\r\n\r\n    // Fetch order from database\r\n    const { data: order, error: orderError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"*\")\r\n      .eq(\"id\", orderId)\r\n      .single();\r\n\r\n    if (orderError || !order) {\r\n      return res.status(404).json({ error: \"Order not found\" });\r\n    }\r\n\r\n    // Get shipping address from order\r\n    const shippingAddress = order.shipping_addresses?.[0];\r\n    if (!shippingAddress) {\r\n      return res.status(400).json({\r\n        error: \"Order does not have shipping address information\",\r\n      });\r\n    }\r\n\r\n    // Prepare shipment payload for ShipStation\r\n    const shipmentPayload = {\r\n      orderId: orderId.toString(),\r\n      carrierCode: carrier,\r\n      serviceCode: service,\r\n      packageCode: \"package\", // Default package code\r\n      weight: {\r\n        value: weight,\r\n        units: \"ounces\",\r\n      },\r\n      ...(dimensions && {\r\n        dimensions: {\r\n          length: dimensions.length || 0,\r\n          width: dimensions.width || 0,\r\n          height: dimensions.height || 0,\r\n          units: \"inches\",\r\n        },\r\n      }),\r\n      toAddress: {\r\n        name: `${shippingAddress.first_name} ${shippingAddress.last_name}`,\r\n        street1: shippingAddress.street_1,\r\n        street2: shippingAddress.street_2 || \"\",\r\n        city: shippingAddress.city,\r\n        state: shippingAddress.state_or_province,\r\n        postalCode: shippingAddress.postal_code,\r\n        country: shippingAddress.country_iso2 || \"US\",\r\n        phone: shippingAddress.phone || \"\",\r\n      },\r\n      ...(testLabel && { testLabel: true }),\r\n    };\r\n\r\n    // Create shipping label\r\n    const labelResponse =\r\n      await shipstationAPI.createShippingLabel(shipmentPayload);\r\n\r\n    // Store label info in database\r\n    if (labelResponse.labelDownload?.href || labelResponse.tracking) {\r\n      const { error: updateError } = await supabase\r\n        .from(\"orders\")\r\n        .update({\r\n          shipping_label_url: labelResponse.labelDownload?.href,\r\n          tracking_number: labelResponse.tracking || \"\",\r\n          tracking_carrier: carrier,\r\n          shipped_date: new Date().toISOString(),\r\n          status: \"in transit\",\r\n        })\r\n        .eq(\"id\", orderId);\r\n\r\n      if (updateError) {\r\n        console.error(\"Failed to update order with label info:\", updateError);\r\n      }\r\n    }\r\n\r\n    return res.status(200).json({\r\n      success: true,\r\n      labelId: labelResponse.labelId,\r\n      tracking: labelResponse.tracking,\r\n      labelUrl: labelResponse.labelDownload?.href,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to create shipping label:\", error);\r\n    const errorMessage =\r\n      error instanceof Error\r\n        ? error.message\r\n        : \"Failed to create shipping label\";\r\n    res.status(500).json({ error: errorMessage });\r\n  }\r\n};\r\n\r\nexport const handleGetRates: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { orderId, weight, dimensions } = req.body;\r\n\r\n    if (!orderId || !weight) {\r\n      return res\r\n        .status(400)\r\n        .json({ error: \"Missing required fields: orderId, weight\" });\r\n    }\r\n\r\n    // Fetch order\r\n    const { data: order, error: orderError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"*\")\r\n      .eq(\"id\", orderId)\r\n      .single();\r\n\r\n    if (orderError || !order) {\r\n      return res.status(404).json({ error: \"Order not found\" });\r\n    }\r\n\r\n    const shippingAddress = order.shipping_addresses?.[0];\r\n    if (!shippingAddress) {\r\n      return res.status(400).json({\r\n        error: \"Order does not have shipping address information\",\r\n      });\r\n    }\r\n\r\n    // Get rates from ShipStation\r\n    const ratesPayload = {\r\n      carrierCode: \"usps\",\r\n      fromPostalCode: \"90210\", // Default warehouse postal code\r\n      toState: shippingAddress.state_or_province,\r\n      toPostalCode: shippingAddress.postal_code,\r\n      toCountry: shippingAddress.country_iso2 || \"US\",\r\n      weight: {\r\n        value: weight,\r\n        units: \"ounces\",\r\n      },\r\n      ...(dimensions && {\r\n        dimensions: {\r\n          length: dimensions.length || 0,\r\n          width: dimensions.width || 0,\r\n          height: dimensions.height || 0,\r\n          units: \"inches\",\r\n        },\r\n      }),\r\n    };\r\n\r\n    const rates = await shipstationAPI.getRates(ratesPayload);\r\n\r\n    return res.status(200).json({ rates });\r\n  } catch (error) {\r\n    console.error(\"Failed to get rates:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to get rates\";\r\n    res.status(500).json({ error: errorMessage });\r\n  }\r\n};\r\n\r\nexport const handleGetCarriers: RequestHandler = async (req, res) => {\r\n  try {\r\n    const carriers = await shipstationAPI.getCarriers();\r\n    res.status(200).json({ carriers });\r\n  } catch (error) {\r\n    console.error(\"Failed to get carriers:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to get carriers\";\r\n    res.status(500).json({ error: errorMessage });\r\n  }\r\n};\r\n\r\nexport const handleGetServices: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { carrierCode } = req.query;\r\n\r\n    if (!carrierCode) {\r\n      return res.status(400).json({ error: \"carrierCode is required\" });\r\n    }\r\n\r\n    const services = await shipstationAPI.getServices(carrierCode as string);\r\n    res.status(200).json({ services });\r\n  } catch (error) {\r\n    console.error(\"Failed to get services:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to get services\";\r\n    res.status(500).json({ error: errorMessage });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 14191, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/shipping-public.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL || \"\",\r\n  process.env.SUPABASE_SERVICE_KEY || \"\",\r\n);\r\n\r\nexport const handleGetPublicShippingOptions: RequestHandler = async (\r\n  _req,\r\n  res,\r\n) => {\r\n  try {\r\n    console.log(\"Fetching public shipping options from Supabase...\");\r\n\r\n    const { data: options, error } = await supabase\r\n      .from(\"shipping_options\")\r\n      .select(\r\n        \"id, name, description, cost, processing_time_days, estimated_delivery_days_min, estimated_delivery_days_max\",\r\n      )\r\n      .eq(\"is_active\", true)\r\n      .order(\"display_order\", { ascending: true })\r\n      .order(\"created_at\", { ascending: true });\r\n\r\n    if (error) {\r\n      console.error(\"Supabase query error:\", error);\r\n      throw new Error(`Database error: ${error.message}`);\r\n    }\r\n\r\n    console.log(\"Successfully fetched shipping options:\", options?.length || 0);\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: options || [],\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch public shipping options:\", error);\r\n    const errorMessage =\r\n      error instanceof Error\r\n        ? error.message\r\n        : \"Failed to fetch shipping options\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;AACA;;;;;;AAEA,MAAM,WAAW,IAAA,2OAAY,EAC3B,QAAQ,GAAG,CAAC,YAAY,IAAI,IAC5B,QAAQ,GAAG,CAAC,oBAAoB,IAAI;AAG/B,MAAM,iCAAiD,OAC5D,MACA;IAEA,IAAI;QACF,QAAQ,GAAG,CAAC;QAEZ,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SACpC,IAAI,CAAC,oBACL,MAAM,CACL,+GAED,EAAE,CAAC,aAAa,MAChB,KAAK,CAAC,iBAAiB;YAAE,WAAW;QAAK,GACzC,KAAK,CAAC,cAAc;YAAE,WAAW;QAAK;QAEzC,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,yBAAyB;YACvC,MAAM,IAAI,MAAM,CAAC,gBAAgB,EAAE,MAAM,OAAO,EAAE;QACpD;QAEA,QAAQ,GAAG,CAAC,0CAA0C,SAAS,UAAU;QAEzE,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,MAAM,WAAW,EAAE;QACrB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4CAA4C;QAC1D,MAAM,eACJ,iBAAiB,QACb,MAAM,OAAO,GACb;QACN,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAa;IAC7D;AACF"}},
    {"offset": {"line": 14235, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/admin-shipping.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { z } from \"zod\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL || \"\",\r\n  process.env.SUPABASE_SERVICE_KEY || \"\",\r\n);\r\n\r\nconst ShippingOptionSchema = z.object({\r\n  name: z.string().min(1, \"Name is required\"),\r\n  description: z.string().optional(),\r\n  cost: z.number().min(0, \"Cost must be positive\"),\r\n  processing_time_days: z\r\n    .number()\r\n    .int()\r\n    .min(0, \"Processing time must be 0 or more\"),\r\n  estimated_delivery_days_min: z\r\n    .number()\r\n    .int()\r\n    .min(1, \"Min delivery days must be at least 1\"),\r\n  estimated_delivery_days_max: z\r\n    .number()\r\n    .int()\r\n    .min(1, \"Max delivery days must be at least 1\"),\r\n  is_active: z.boolean().optional(),\r\n  display_order: z.number().int().optional(),\r\n});\r\n\r\ntype ShippingOption = z.infer<typeof ShippingOptionSchema>;\r\n\r\nexport const handleGetShippingOptions: RequestHandler = async (_req, res) => {\r\n  try {\r\n    const { data: options, error } = await supabase\r\n      .from(\"shipping_options\")\r\n      .select(\"*\")\r\n      .order(\"display_order\", { ascending: true })\r\n      .order(\"created_at\", { ascending: true });\r\n\r\n    if (error) throw error;\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: options || [],\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch shipping options:\", error);\r\n    const errorMessage =\r\n      error instanceof Error\r\n        ? error.message\r\n        : \"Failed to fetch shipping options\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n\r\nexport const handleGetShippingOption: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const parsedId = parseInt(id, 10);\r\n\r\n    if (isNaN(parsedId)) {\r\n      return res\r\n        .status(400)\r\n        .json({ error: \"Invalid shipping option ID format\" });\r\n    }\r\n\r\n    const { data: option, error } = await supabase\r\n      .from(\"shipping_options\")\r\n      .select(\"*\")\r\n      .eq(\"id\", parsedId)\r\n      .single();\r\n\r\n    if (error || !option) {\r\n      return res.status(404).json({ error: \"Shipping option not found\" });\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: option,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch shipping option:\", error);\r\n    const errorMessage =\r\n      error instanceof Error\r\n        ? error.message\r\n        : \"Failed to fetch shipping option\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n\r\nexport const handleCreateShippingOption: RequestHandler = async (req, res) => {\r\n  try {\r\n    const validationResult = ShippingOptionSchema.safeParse(req.body);\r\n\r\n    if (!validationResult.success) {\r\n      return res.status(400).json({\r\n        error: \"Validation failed\",\r\n        details: validationResult.error.errors,\r\n      });\r\n    }\r\n\r\n    const optionData = validationResult.data;\r\n\r\n    // Validate that max >= min\r\n    if (\r\n      optionData.estimated_delivery_days_max <\r\n      optionData.estimated_delivery_days_min\r\n    ) {\r\n      return res.status(400).json({\r\n        error:\r\n          \"Max delivery days must be greater than or equal to min delivery days\",\r\n      });\r\n    }\r\n\r\n    const { data: option, error } = await supabase\r\n      .from(\"shipping_options\")\r\n      .insert([optionData])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) throw error;\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      data: option,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to create shipping option:\", error);\r\n    const errorMessage =\r\n      error instanceof Error\r\n        ? error.message\r\n        : \"Failed to create shipping option\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n\r\nexport const handleUpdateShippingOption: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const parsedId = parseInt(id, 10);\r\n\r\n    if (isNaN(parsedId)) {\r\n      return res\r\n        .status(400)\r\n        .json({ error: \"Invalid shipping option ID format\" });\r\n    }\r\n\r\n    const validationResult = ShippingOptionSchema.partial().safeParse(req.body);\r\n\r\n    if (!validationResult.success) {\r\n      return res.status(400).json({\r\n        error: \"Validation failed\",\r\n        details: validationResult.error.errors,\r\n      });\r\n    }\r\n\r\n    const updateData = validationResult.data;\r\n\r\n    // Validate that max >= min if both are provided\r\n    if (\r\n      updateData.estimated_delivery_days_max &&\r\n      updateData.estimated_delivery_days_min &&\r\n      updateData.estimated_delivery_days_max <\r\n        updateData.estimated_delivery_days_min\r\n    ) {\r\n      return res.status(400).json({\r\n        error:\r\n          \"Max delivery days must be greater than or equal to min delivery days\",\r\n      });\r\n    }\r\n\r\n    const { data: option, error } = await supabase\r\n      .from(\"shipping_options\")\r\n      .update({\r\n        ...updateData,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", parsedId)\r\n      .select()\r\n      .single();\r\n\r\n    if (error || !option) {\r\n      return res.status(404).json({ error: \"Shipping option not found\" });\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: option,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to update shipping option:\", error);\r\n    const errorMessage =\r\n      error instanceof Error\r\n        ? error.message\r\n        : \"Failed to update shipping option\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n\r\nexport const handleDeleteShippingOption: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const parsedId = parseInt(id, 10);\r\n\r\n    if (isNaN(parsedId)) {\r\n      return res\r\n        .status(400)\r\n        .json({ error: \"Invalid shipping option ID format\" });\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from(\"shipping_options\")\r\n      .delete()\r\n      .eq(\"id\", parsedId);\r\n\r\n    if (error) throw error;\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: \"Shipping option deleted successfully\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to delete shipping option:\", error);\r\n    const errorMessage =\r\n      error instanceof Error\r\n        ? error.message\r\n        : \"Failed to delete shipping option\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;AACA;AACA;;;;;;;;AAEA,MAAM,WAAW,IAAA,2OAAY,EAC3B,QAAQ,GAAG,CAAC,YAAY,IAAI,IAC5B,QAAQ,GAAG,CAAC,oBAAoB,IAAI;AAGtC,MAAM,uBAAuB,qJAAC,CAAC,MAAM,CAAC;IACpC,MAAM,qJAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACxB,aAAa,qJAAC,CAAC,MAAM,GAAG,QAAQ;IAChC,MAAM,qJAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACxB,sBAAsB,qJAAC,CACpB,MAAM,GACN,GAAG,GACH,GAAG,CAAC,GAAG;IACV,6BAA6B,qJAAC,CAC3B,MAAM,GACN,GAAG,GACH,GAAG,CAAC,GAAG;IACV,6BAA6B,qJAAC,CAC3B,MAAM,GACN,GAAG,GACH,GAAG,CAAC,GAAG;IACV,WAAW,qJAAC,CAAC,OAAO,GAAG,QAAQ;IAC/B,eAAe,qJAAC,CAAC,MAAM,GAAG,GAAG,GAAG,QAAQ;AAC1C;AAIO,MAAM,2BAA2C,OAAO,MAAM;IACnE,IAAI;QACF,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SACpC,IAAI,CAAC,oBACL,MAAM,CAAC,KACP,KAAK,CAAC,iBAAiB;YAAE,WAAW;QAAK,GACzC,KAAK,CAAC,cAAc;YAAE,WAAW;QAAK;QAEzC,IAAI,OAAO,MAAM;QAEjB,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,MAAM,WAAW,EAAE;QACrB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,MAAM,eACJ,iBAAiB,QACb,MAAM,OAAO,GACb;QACN,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAa;IAC7D;AACF;AAEO,MAAM,0BAA0C,OAAO,KAAK;IACjE,IAAI;QACF,MAAM,EAAE,EAAE,EAAE,GAAG,IAAI,MAAM;QACzB,MAAM,WAAW,SAAS,IAAI;QAE9B,IAAI,MAAM,WAAW;YACnB,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBAAE,OAAO;YAAoC;QACvD;QAEA,MAAM,EAAE,MAAM,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,oBACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,UACT,MAAM;QAET,IAAI,SAAS,CAAC,QAAQ;YACpB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA4B;QACnE;QAEA,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,MAAM;QACR;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oCAAoC;QAClD,MAAM,eACJ,iBAAiB,QACb,MAAM,OAAO,GACb;QACN,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAa;IAC7D;AACF;AAEO,MAAM,6BAA6C,OAAO,KAAK;IACpE,IAAI;QACF,MAAM,mBAAmB,qBAAqB,SAAS,CAAC,IAAI,IAAI;QAEhE,IAAI,CAAC,iBAAiB,OAAO,EAAE;YAC7B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS,iBAAiB,KAAK,CAAC,MAAM;YACxC;QACF;QAEA,MAAM,aAAa,iBAAiB,IAAI;QAExC,2BAA2B;QAC3B,IACE,WAAW,2BAA2B,GACtC,WAAW,2BAA2B,EACtC;YACA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OACE;YACJ;QACF;QAEA,MAAM,EAAE,MAAM,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,oBACL,MAAM,CAAC;YAAC;SAAW,EACnB,MAAM,GACN,MAAM;QAET,IAAI,OAAO,MAAM;QAEjB,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,MAAM;QACR;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,MAAM,eACJ,iBAAiB,QACb,MAAM,OAAO,GACb;QACN,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAa;IAC7D;AACF;AAEO,MAAM,6BAA6C,OAAO,KAAK;IACpE,IAAI;QACF,MAAM,EAAE,EAAE,EAAE,GAAG,IAAI,MAAM;QACzB,MAAM,WAAW,SAAS,IAAI;QAE9B,IAAI,MAAM,WAAW;YACnB,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBAAE,OAAO;YAAoC;QACvD;QAEA,MAAM,mBAAmB,qBAAqB,OAAO,GAAG,SAAS,CAAC,IAAI,IAAI;QAE1E,IAAI,CAAC,iBAAiB,OAAO,EAAE;YAC7B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS,iBAAiB,KAAK,CAAC,MAAM;YACxC;QACF;QAEA,MAAM,aAAa,iBAAiB,IAAI;QAExC,gDAAgD;QAChD,IACE,WAAW,2BAA2B,IACtC,WAAW,2BAA2B,IACtC,WAAW,2BAA2B,GACpC,WAAW,2BAA2B,EACxC;YACA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OACE;YACJ;QACF;QAEA,MAAM,EAAE,MAAM,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,oBACL,MAAM,CAAC;YACN,GAAG,UAAU;YACb,YAAY,IAAI,OAAO,WAAW;QACpC,GACC,EAAE,CAAC,MAAM,UACT,MAAM,GACN,MAAM;QAET,IAAI,SAAS,CAAC,QAAQ;YACpB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA4B;QACnE;QAEA,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,MAAM;QACR;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,MAAM,eACJ,iBAAiB,QACb,MAAM,OAAO,GACb;QACN,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAa;IAC7D;AACF;AAEO,MAAM,6BAA6C,OAAO,KAAK;IACpE,IAAI;QACF,MAAM,EAAE,EAAE,EAAE,GAAG,IAAI,MAAM;QACzB,MAAM,WAAW,SAAS,IAAI;QAE9B,IAAI,MAAM,WAAW;YACnB,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBAAE,OAAO;YAAoC;QACvD;QAEA,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,oBACL,MAAM,GACN,EAAE,CAAC,MAAM;QAEZ,IAAI,OAAO,MAAM;QAEjB,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,SAAS;QACX;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,MAAM,eACJ,iBAAiB,QACb,MAAM,OAAO,GACb;QACN,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAa;IAC7D;AACF"}},
    {"offset": {"line": 14425, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/blogs.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { v2 as cloudinary } from \"cloudinary\";\r\nimport { processImage } from \"../utils/image-processor\";\r\n\r\nconst supabaseUrl = process.env.SUPABASE_URL || \"\";\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_KEY || \"\";\r\n\r\n/**\r\n * SECURITY: Service Role Key is required for this route\r\n *\r\n * Justification:\r\n * - Blog management is admin-only (create/update/delete operations)\r\n * - RLS policies cannot enforce blog ownership (blogs are shared admin resource)\r\n * - Public read endpoints don't require auth, but admin writes need elevated access\r\n *\r\n * Mitigation:\r\n * - All admin endpoints verify authentication and admin status\r\n * - Audit logging should be added for blog modifications\r\n * - Public read endpoints (getPublishedBlogs) only return visible blogs\r\n *\r\n * See: docs/RLS_SCOPING.md for security architecture\r\n */\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\ninterface BlogFormData {\r\n  title: string;\r\n  content: string;\r\n  excerpt: string;\r\n  author: string;\r\n  featured_image_url?: string;\r\n  tags: string[];\r\n  visibility: \"visible\" | \"hidden\";\r\n  show_in_listing?: boolean;\r\n}\r\n\r\n/**\r\n * Get all published blogs (public endpoint)\r\n * SECURITY: Public endpoint - no authentication required\r\n * Filters to only visible blogs (visibility = 'visible' AND show_in_listing = true)\r\n * Service Role Key is used for read-only access to public data\r\n */\r\nexport const handleGetPublishedBlogs: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"blogs\")\r\n      .select(\"*\")\r\n      .eq(\"visibility\", \"visible\")\r\n      .eq(\"show_in_listing\", true)\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) throw error;\r\n\r\n    res.json({\r\n      blogs: data || [],\r\n    });\r\n  } catch (err) {\r\n    console.error(\"Error fetching published blogs:\", err);\r\n    res.status(500).json({ error: \"Failed to fetch blogs\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Get single blog by ID (public endpoint)\r\n * SECURITY: Public endpoint - no authentication required\r\n * Only returns blogs with visibility = 'visible'\r\n */\r\nexport const handleGetBlogById: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { blogId } = req.params;\r\n\r\n    const uuidPattern =\r\n      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n    if (!uuidPattern.test(blogId)) {\r\n      return res.status(400).json({ error: \"Invalid blog ID format\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"blogs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", blogId)\r\n      .single();\r\n\r\n    if (error) throw error;\r\n\r\n    if (!data || data.visibility !== \"visible\") {\r\n      return res.status(404).json({ error: \"Blog not found\" });\r\n    }\r\n\r\n    // Increment views\r\n    await supabase\r\n      .from(\"blogs\")\r\n      .update({ views: (data.views || 0) + 1 })\r\n      .eq(\"id\", blogId);\r\n\r\n    res.json(data);\r\n  } catch (err) {\r\n    console.error(\"Error fetching blog:\", err);\r\n    res.status(500).json({ error: \"Failed to fetch blog\" });\r\n  }\r\n};\r\n\r\n// Create blog (admin only)\r\nexport const handleCreateBlog: RequestHandler = async (req, res) => {\r\n  try {\r\n    const formData: BlogFormData = req.body;\r\n\r\n    // Validate required fields\r\n    if (!formData.title || !formData.content || !formData.excerpt) {\r\n      return res.status(400).json({ error: \"Missing required fields\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"blogs\")\r\n      .insert([\r\n        {\r\n          title: formData.title,\r\n          content: formData.content,\r\n          excerpt: formData.excerpt,\r\n          author: formData.author || \"Admin\",\r\n          featured_image_url: formData.featured_image_url,\r\n          tags: formData.tags || [],\r\n          visibility: formData.visibility || \"hidden\",\r\n          show_in_listing: formData.show_in_listing !== false,\r\n          views: 0,\r\n          created_at: new Date().toISOString(),\r\n        },\r\n      ])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) throw error;\r\n\r\n    res.status(201).json(data);\r\n  } catch (err) {\r\n    console.error(\"Error creating blog:\", err);\r\n    res.status(500).json({ error: \"Failed to create blog\" });\r\n  }\r\n};\r\n\r\n// Get all blogs (admin only)\r\nexport const handleGetAllBlogs: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"blogs\")\r\n      .select(\"*\")\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) throw error;\r\n\r\n    res.json({\r\n      blogs: data || [],\r\n    });\r\n  } catch (err) {\r\n    console.error(\"Error fetching blogs:\", err);\r\n    res.status(500).json({ error: \"Failed to fetch blogs\" });\r\n  }\r\n};\r\n\r\n// Get single blog by ID (admin only - can see any status)\r\nexport const handleGetAdminBlogById: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { blogId } = req.params;\r\n\r\n    const uuidPattern =\r\n      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n    if (!uuidPattern.test(blogId)) {\r\n      return res.status(400).json({ error: \"Invalid blog ID format\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"blogs\")\r\n      .select(\"*\")\r\n      .eq(\"id\", blogId)\r\n      .single();\r\n\r\n    if (error) throw error;\r\n\r\n    if (!data) {\r\n      return res.status(404).json({ error: \"Blog not found\" });\r\n    }\r\n\r\n    res.json(data);\r\n  } catch (err) {\r\n    console.error(\"Error fetching blog:\", err);\r\n    res.status(500).json({ error: \"Failed to fetch blog\" });\r\n  }\r\n};\r\n\r\n// Delete blog (admin only)\r\nexport const handleDeleteBlog: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { blogId } = req.params;\r\n\r\n    const uuidPattern =\r\n      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n    if (!uuidPattern.test(blogId)) {\r\n      return res.status(400).json({ error: \"Invalid blog ID format\" });\r\n    }\r\n\r\n    const { error } = await supabase.from(\"blogs\").delete().eq(\"id\", blogId);\r\n\r\n    if (error) throw error;\r\n\r\n    res.json({ message: \"Blog deleted successfully\" });\r\n  } catch (err) {\r\n    console.error(\"Error deleting blog:\", err);\r\n    res.status(500).json({ error: \"Failed to delete blog\" });\r\n  }\r\n};\r\n\r\n// Update blog (admin only)\r\nexport const handleUpdateBlog: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { blogId } = req.params;\r\n    const formData: Partial<BlogFormData> = req.body;\r\n\r\n    const uuidPattern =\r\n      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n    if (!uuidPattern.test(blogId)) {\r\n      return res.status(400).json({ error: \"Invalid blog ID format\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"blogs\")\r\n      .update({\r\n        ...(formData.title && { title: formData.title }),\r\n        ...(formData.content && { content: formData.content }),\r\n        ...(formData.excerpt && { excerpt: formData.excerpt }),\r\n        ...(formData.author && { author: formData.author }),\r\n        ...(formData.featured_image_url && {\r\n          featured_image_url: formData.featured_image_url,\r\n        }),\r\n        ...(formData.tags && { tags: formData.tags }),\r\n        ...(formData.visibility && { visibility: formData.visibility }),\r\n        ...(formData.show_in_listing !== undefined && {\r\n          show_in_listing: formData.show_in_listing,\r\n        }),\r\n      })\r\n      .eq(\"id\", blogId)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) throw error;\r\n\r\n    res.json(data);\r\n  } catch (err) {\r\n    console.error(\"Error updating blog:\", err);\r\n    res.status(500).json({ error: \"Failed to update blog\" });\r\n  }\r\n};\r\n\r\n// Upload image (admin only) - using Cloudinary\r\nexport const handleUploadBlogImage: RequestHandler = async (req, res) => {\r\n  try {\r\n    cloudinary.config({\r\n      cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\r\n      api_key: process.env.CLOUDINARY_API_KEY,\r\n      api_secret: process.env.CLOUDINARY_API_SECRET,\r\n    });\r\n\r\n    if (!req.file) {\r\n      return res.status(400).json({ error: \"No file provided\" });\r\n    }\r\n\r\n    // Compress image using sharp (falls back to original in serverless)\r\n    const compressedBuffer = await processImage(req.file.buffer, 1200, 800);\r\n\r\n    const b64 = compressedBuffer.toString(\"base64\");\r\n    const dataURI = `data:image/jpeg;base64,${b64}`;\r\n\r\n    const result = await cloudinary.uploader.upload(dataURI, {\r\n      folder: \"sticky-shuttle/blog\",\r\n      resource_type: \"auto\",\r\n    });\r\n\r\n    res.json({ imageUrl: result.secure_url });\r\n  } catch (err) {\r\n    console.error(\"Error uploading image:\", err);\r\n    res.status(500).json({ error: \"Failed to upload image\" });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 14689, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/admin-gallery.ts"],"sourcesContent":["import { Router, Request, Response } from \"express\";\r\n// import { createClient } from \"@supabase/supabase-js\";\r\nimport { verifyToken, requireAdmin } from \"../middleware/auth\";\r\n\r\nconst router = Router();\r\n\r\n// Initialize Supabase client\r\nimport { supabase } from \"../utils/supabase\";\r\n\r\n// Removed local Supabase initialization in favor of shared client\r\n// const supabaseUrl = process.env.SUPABASE_URL || \"\";\r\n// const supabaseKey = process.env.SUPABASE_SERVICE_KEY || \"\";\r\n// const supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\n// GET all gallery images (public)\r\nrouter.get(\"/gallery\", async (req: Request, res: Response) => {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"gallery_images\")\r\n      .select(\"*\")\r\n      .eq(\"is_active\", true)\r\n      .order(\"order_index\", { ascending: true });\r\n\r\n    if (error) throw error;\r\n\r\n    res.json(data || []);\r\n  } catch (error) {\r\n    console.error(\"Error fetching gallery images:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch gallery images\" });\r\n  }\r\n});\r\n\r\n// GET all gallery images (including inactive) - admin only\r\nrouter.get(\"/gallery/admin/all\", verifyToken, requireAdmin, async (req: Request, res: Response) => {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"gallery_images\")\r\n      .select(\"*\")\r\n      .order(\"order_index\", { ascending: true });\r\n\r\n    if (error) throw error;\r\n\r\n    res.json(data || []);\r\n  } catch (error) {\r\n    console.error(\"Error fetching gallery images:\", error);\r\n    res.status(500).json({ error: \"Failed to fetch gallery images\" });\r\n  }\r\n});\r\n\r\n// POST - Create new gallery image\r\nrouter.post(\"/gallery/admin\", verifyToken, requireAdmin, async (req: Request, res: Response) => {\r\n  try {\r\n    const { title, description, image_url, image_alt, order_index } = req.body;\r\n\r\n    if (!title || !image_url) {\r\n      return res.status(400).json({ error: \"Title and image_url are required\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"gallery_images\")\r\n      .insert([\r\n        {\r\n          title,\r\n          description,\r\n          image_url,\r\n          image_alt,\r\n          order_index: order_index || 0,\r\n          is_active: true,\r\n        },\r\n      ])\r\n      .select();\r\n\r\n    if (error) throw error;\r\n\r\n    res.status(201).json(data?.[0]);\r\n  } catch (error) {\r\n    console.error(\"Error creating gallery image:\", error);\r\n    res.status(500).json({ error: \"Failed to create gallery image\" });\r\n  }\r\n});\r\n\r\n// PUT - Update gallery image\r\nrouter.put(\"/gallery/admin/:id\", verifyToken, requireAdmin, async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { title, description, image_url, image_alt, order_index, is_active } =\r\n      req.body;\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"gallery_images\")\r\n      .update({\r\n        title,\r\n        description,\r\n        image_url,\r\n        image_alt,\r\n        order_index,\r\n        is_active,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", id)\r\n      .select();\r\n\r\n    if (error) throw error;\r\n\r\n    if (!data || data.length === 0) {\r\n      return res.status(404).json({ error: \"Gallery image not found\" });\r\n    }\r\n\r\n    res.json(data[0]);\r\n  } catch (error) {\r\n    console.error(\"Error updating gallery image:\", error);\r\n    res.status(500).json({ error: \"Failed to update gallery image\" });\r\n  }\r\n});\r\n\r\n// DELETE - Remove gallery image\r\nrouter.delete(\"/gallery/admin/:id\", verifyToken, requireAdmin, async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    const { error } = await supabase\r\n      .from(\"gallery_images\")\r\n      .delete()\r\n      .eq(\"id\", id);\r\n\r\n    if (error) throw error;\r\n\r\n    res.json({ message: \"Gallery image deleted successfully\" });\r\n  } catch (error) {\r\n    console.error(\"Error deleting gallery image:\", error);\r\n    res.status(500).json({ error: \"Failed to delete gallery image\" });\r\n  }\r\n});\r\n\r\n// PATCH - Reorder gallery images\r\nrouter.patch(\"/gallery/admin/reorder\", verifyToken, requireAdmin, async (req: Request, res: Response) => {\r\n  try {\r\n    const { images } = req.body;\r\n\r\n    if (!Array.isArray(images)) {\r\n      return res.status(400).json({ error: \"Images array is required\" });\r\n    }\r\n\r\n    // Update each image's order_index\r\n    const updates = images.map((img, index) => ({\r\n      id: img.id,\r\n      order_index: index,\r\n    }));\r\n\r\n    // Execute updates in sequence\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from(\"gallery_images\")\r\n        .update({ order_index: update.order_index })\r\n        .eq(\"id\", update.id);\r\n\r\n      if (error) throw error;\r\n    }\r\n\r\n    res.json({ message: \"Gallery images reordered successfully\" });\r\n  } catch (error) {\r\n    console.error(\"Error reordering gallery images:\", error);\r\n    res.status(500).json({ error: \"Failed to reorder gallery images\" });\r\n  }\r\n});\r\n\r\nexport default router;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 14852, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/legal-pages.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst supabaseUrl = process.env.SUPABASE_URL || \"\";\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_KEY || \"\";\r\n\r\n/**\r\n * SECURITY: Service Role Key is required for this route\r\n *\r\n * Justification:\r\n * - Legal page management is admin-only (create/update/delete operations)\r\n * - RLS policies cannot enforce page ownership (legal pages are shared resource)\r\n * - Public read endpoints don't require auth, but admin writes need elevated access\r\n *\r\n * Mitigation:\r\n * - All admin endpoints require verifyToken + requireAdmin middleware\r\n * - Public read endpoints only return visible pages\r\n * - No customer data is accessed (only shared legal content)\r\n *\r\n * See: docs/RLS_SCOPING.md for security architecture\r\n */\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\ninterface LegalPageFormData {\r\n  page_type:\r\n    | \"privacy\"\r\n    | \"terms\"\r\n    | \"shipping\"\r\n    | \"returns\"\r\n    | \"legal\"\r\n    | \"gdpr\"\r\n    | \"ccpa\";\r\n  title: string;\r\n  content: string;\r\n  visibility: \"visible\" | \"hidden\";\r\n}\r\n\r\n// Get all published legal pages (public)\r\nexport const handleGetPublishedLegalPages: RequestHandler = async (\r\n  req,\r\n  res,\r\n) => {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"legal_pages\")\r\n      .select(\"*\")\r\n      .eq(\"visibility\", \"visible\")\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) throw error;\r\n\r\n    res.json({\r\n      pages: data || [],\r\n    });\r\n  } catch (err) {\r\n    console.error(\"Error fetching legal pages:\", err);\r\n    res.status(500).json({ error: \"Failed to fetch legal pages\" });\r\n  }\r\n};\r\n\r\n// Get all legal pages (admin only)\r\nexport const handleGetAllLegalPages: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"legal_pages\")\r\n      .select(\"*\")\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) throw error;\r\n\r\n    res.json({\r\n      pages: data || [],\r\n    });\r\n  } catch (err) {\r\n    console.error(\"Error fetching legal pages:\", err);\r\n    res.status(500).json({ error: \"Failed to fetch legal pages\" });\r\n  }\r\n};\r\n\r\n// Get legal page by type (public)\r\nexport const handleGetLegalPageByType: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { pageType } = req.params;\r\n\r\n    const validTypes = [\r\n      \"privacy\",\r\n      \"terms\",\r\n      \"shipping\",\r\n      \"returns\",\r\n      \"legal\",\r\n      \"gdpr\",\r\n      \"ccpa\",\r\n    ];\r\n    if (!validTypes.includes(pageType)) {\r\n      return res.status(400).json({ error: \"Invalid page type\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"legal_pages\")\r\n      .select(\"*\")\r\n      .eq(\"page_type\", pageType)\r\n      .eq(\"visibility\", \"visible\")\r\n      .single();\r\n\r\n    if (error && error.code === \"PGRST116\") {\r\n      return res.status(404).json({ error: \"Page not found\" });\r\n    }\r\n\r\n    if (error) throw error;\r\n\r\n    res.json(data);\r\n  } catch (err) {\r\n    console.error(\"Error fetching legal page:\", err);\r\n    res.status(500).json({ error: \"Failed to fetch legal page\" });\r\n  }\r\n};\r\n\r\n// Get legal page by ID (admin only)\r\nexport const handleGetAdminLegalPageById: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { pageId } = req.params;\r\n\r\n    const uuidPattern =\r\n      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n    if (!uuidPattern.test(pageId)) {\r\n      return res.status(400).json({ error: \"Invalid page ID format\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"legal_pages\")\r\n      .select(\"*\")\r\n      .eq(\"id\", pageId)\r\n      .single();\r\n\r\n    if (error && error.code === \"PGRST116\") {\r\n      return res.status(404).json({ error: \"Page not found\" });\r\n    }\r\n\r\n    if (error) throw error;\r\n\r\n    res.json(data);\r\n  } catch (err) {\r\n    console.error(\"Error fetching legal page:\", err);\r\n    res.status(500).json({ error: \"Failed to fetch legal page\" });\r\n  }\r\n};\r\n\r\n// Create legal page (admin only)\r\nexport const handleCreateLegalPage: RequestHandler = async (req, res) => {\r\n  try {\r\n    const formData: LegalPageFormData = req.body;\r\n\r\n    // Validate required fields\r\n    if (!formData.page_type || !formData.title || !formData.content) {\r\n      return res.status(400).json({ error: \"Missing required fields\" });\r\n    }\r\n\r\n    const validTypes = [\r\n      \"privacy\",\r\n      \"terms\",\r\n      \"shipping\",\r\n      \"returns\",\r\n      \"legal\",\r\n      \"gdpr\",\r\n      \"ccpa\",\r\n    ];\r\n    if (!validTypes.includes(formData.page_type)) {\r\n      return res.status(400).json({ error: \"Invalid page type\" });\r\n    }\r\n\r\n    // Check if page type already exists\r\n    const { data: existingPage } = await supabase\r\n      .from(\"legal_pages\")\r\n      .select(\"id\")\r\n      .eq(\"page_type\", formData.page_type)\r\n      .single();\r\n\r\n    if (existingPage) {\r\n      return res.status(400).json({\r\n        error: `A ${formData.page_type} page already exists. Please edit the existing page instead.`,\r\n      });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"legal_pages\")\r\n      .insert([\r\n        {\r\n          page_type: formData.page_type,\r\n          title: formData.title,\r\n          content: formData.content,\r\n          visibility: formData.visibility || \"visible\",\r\n          created_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString(),\r\n        },\r\n      ])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) throw error;\r\n\r\n    res.status(201).json(data);\r\n  } catch (err) {\r\n    console.error(\"Error creating legal page:\", err);\r\n    res.status(500).json({ error: \"Failed to create legal page\" });\r\n  }\r\n};\r\n\r\n// Update legal page (admin only)\r\nexport const handleUpdateLegalPage: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { pageId } = req.params;\r\n    const formData: Partial<LegalPageFormData> = req.body;\r\n\r\n    const uuidPattern =\r\n      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n    if (!uuidPattern.test(pageId)) {\r\n      return res.status(400).json({ error: \"Invalid page ID format\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"legal_pages\")\r\n      .update({\r\n        ...(formData.title && { title: formData.title }),\r\n        ...(formData.content && { content: formData.content }),\r\n        ...(formData.visibility && { visibility: formData.visibility }),\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", pageId)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) throw error;\r\n\r\n    res.json(data);\r\n  } catch (err) {\r\n    console.error(\"Error updating legal page:\", err);\r\n    res.status(500).json({ error: \"Failed to update legal page\" });\r\n  }\r\n};\r\n\r\n// Delete legal page (admin only)\r\nexport const handleDeleteLegalPage: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { pageId } = req.params;\r\n\r\n    const uuidPattern =\r\n      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n    if (!uuidPattern.test(pageId)) {\r\n      return res.status(400).json({ error: \"Invalid page ID format\" });\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from(\"legal_pages\")\r\n      .delete()\r\n      .eq(\"id\", pageId);\r\n\r\n    if (error) throw error;\r\n\r\n    res.json({ message: \"Legal page deleted successfully\" });\r\n  } catch (err) {\r\n    console.error(\"Error deleting legal page:\", err);\r\n    res.status(500).json({ error: \"Failed to delete legal page\" });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 15087, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/admin-return-refund-policy.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { supabase } from \"../utils/supabase\";\r\n\r\ninterface PolicyContent {\r\n  guarantee_days: number;\r\n  return_conditions: string[];\r\n  how_to_return: string[];\r\n  defective_items_days: number;\r\n  refund_timeline: string;\r\n  non_returnable_items: string[];\r\n  contact_email: string;\r\n  full_policy: string;\r\n}\r\n\r\nconst DEFAULT_POLICY: PolicyContent = {\r\n  guarantee_days: 30,\r\n  return_conditions: [\r\n    \"Stickers must be unused and in original condition\",\r\n    \"Original packaging must be intact\",\r\n    \"Proof of purchase (order number) is required\",\r\n    \"Return shipping is the customer's responsibility\",\r\n  ],\r\n  how_to_return: [\r\n    \"Contact our support team at support@stickyhub.com with your order number\",\r\n    \"Provide a reason for your return request\",\r\n    \"We'll review your request and provide return shipping instructions\",\r\n    \"Ship the item back to us using the provided address\",\r\n    \"Once received and inspected, we'll process your refund (5-7 business days)\",\r\n  ],\r\n  defective_items_days: 7,\r\n  refund_timeline: \"5-7 business days after we receive and inspect your return\",\r\n  non_returnable_items: [\r\n    \"Used, applied, or partially used stickers\",\r\n    \"Items without original packaging\",\r\n    \"Items returned after 30 days\",\r\n    \"Wholesale or bulk orders (special terms apply)\",\r\n  ],\r\n  contact_email: \"support@stickyhub.com\",\r\n  full_policy: \"\",\r\n};\r\n\r\n// GET policy\r\nexport const getReturnRefundPolicy: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"return_refund_policies\")\r\n      .select(\"*\")\r\n      .eq(\"id\", \"default\")\r\n      .single();\r\n\r\n    // Table doesn't exist yet or no data found - return default\r\n    if (error || !data) {\r\n      return res.json({ policy: DEFAULT_POLICY });\r\n    }\r\n\r\n    res.json({ policy: data?.content || DEFAULT_POLICY });\r\n  } catch (error) {\r\n    console.error(\"Error fetching return/refund policy:\", error);\r\n    // Return default policy instead of erroring out\r\n    res.json({ policy: DEFAULT_POLICY });\r\n  }\r\n};\r\n\r\n// POST/UPDATE policy (admin only)\r\nexport const updateReturnRefundPolicy: RequestHandler = async (req, res) => {\r\n  try {\r\n    const policy: PolicyContent = req.body;\r\n\r\n    // Validate policy content\r\n    if (!policy.guarantee_days || !policy.contact_email) {\r\n      return res.status(400).json({\r\n        error: \"Invalid policy\",\r\n        message: \"Guarantee days and contact email are required\",\r\n      });\r\n    }\r\n\r\n    try {\r\n      const { data, error: upsertError } = await supabase\r\n        .from(\"return_refund_policies\")\r\n        .upsert(\r\n          {\r\n            id: \"default\",\r\n            content: policy,\r\n            updated_at: new Date().toISOString(),\r\n          },\r\n          { onConflict: \"id\" },\r\n        )\r\n        .select()\r\n        .single();\r\n\r\n      if (upsertError) throw upsertError;\r\n\r\n      return res.json({\r\n        success: true,\r\n        message: \"Policy updated successfully\",\r\n        policy: data?.content || policy,\r\n      });\r\n    } catch (dbError) {\r\n      console.error(\"Database error updating policy:\", dbError);\r\n      // If database operation fails, still return success with the provided policy\r\n      // (policy will be stored in memory or we can implement file-based storage later)\r\n      return res.json({\r\n        success: true,\r\n        message: \"Policy saved (database pending migration)\",\r\n        policy: policy,\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error updating return/refund policy:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to update policy\",\r\n      message: error instanceof Error ? error.message : \"Unknown error\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;;;AACA;;;;;;AAaA,MAAM,iBAAgC;IACpC,gBAAgB;IAChB,mBAAmB;QACjB;QACA;QACA;QACA;KACD;IACD,eAAe;QACb;QACA;QACA;QACA;QACA;KACD;IACD,sBAAsB;IACtB,iBAAiB;IACjB,sBAAsB;QACpB;QACA;QACA;QACA;KACD;IACD,eAAe;IACf,aAAa;AACf;AAGO,MAAM,wBAAwC,OAAO,KAAK;IAC/D,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,gIAAQ,CACnC,IAAI,CAAC,0BACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,WACT,MAAM;QAET,4DAA4D;QAC5D,IAAI,SAAS,CAAC,MAAM;YAClB,OAAO,IAAI,IAAI,CAAC;gBAAE,QAAQ;YAAe;QAC3C;QAEA,IAAI,IAAI,CAAC;YAAE,QAAQ,MAAM,WAAW;QAAe;IACrD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,gDAAgD;QAChD,IAAI,IAAI,CAAC;YAAE,QAAQ;QAAe;IACpC;AACF;AAGO,MAAM,2BAA2C,OAAO,KAAK;IAClE,IAAI;QACF,MAAM,SAAwB,IAAI,IAAI;QAEtC,0BAA0B;QAC1B,IAAI,CAAC,OAAO,cAAc,IAAI,CAAC,OAAO,aAAa,EAAE;YACnD,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,OAAO;gBACP,SAAS;YACX;QACF;QAEA,IAAI;YACF,MAAM,EAAE,IAAI,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,gIAAQ,CAChD,IAAI,CAAC,0BACL,MAAM,CACL;gBACE,IAAI;gBACJ,SAAS;gBACT,YAAY,IAAI,OAAO,WAAW;YACpC,GACA;gBAAE,YAAY;YAAK,GAEpB,MAAM,GACN,MAAM;YAET,IAAI,aAAa,MAAM;YAEvB,OAAO,IAAI,IAAI,CAAC;gBACd,SAAS;gBACT,SAAS;gBACT,QAAQ,MAAM,WAAW;YAC3B;QACF,EAAE,OAAO,SAAS;YAChB,QAAQ,KAAK,CAAC,mCAAmC;YACjD,6EAA6E;YAC7E,iFAAiF;YACjF,OAAO,IAAI,IAAI,CAAC;gBACd,SAAS;gBACT,SAAS;gBACT,QAAQ;YACV;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD;IACF;AACF"}},
    {"offset": {"line": 15192, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/emails/invoice-payment.ts"],"sourcesContent":["export function generateInvoiceEmailHtml(\r\n  customerName: string,\r\n  invoiceNumber: string,\r\n  total: string,\r\n  dueDate: string,\r\n  paymentLink: string,\r\n  invoiceDetails?: {\r\n    company?: string;\r\n    notes?: string;\r\n  },\r\n): string {\r\n  const formattedDueDate = new Date(dueDate).toLocaleDateString(\"en-US\", {\r\n    year: \"numeric\",\r\n    month: \"long\",\r\n    day: \"numeric\",\r\n  });\r\n\r\n  return `\r\n    <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; max-width: 600px; margin: 0 auto; color: #333;\">\r\n      <!-- Header -->\r\n      <div style=\"background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); padding: 40px 20px; text-align: center; border-radius: 8px 8px 0 0;\">\r\n        <h1 style=\"margin: 0; color: #000; font-size: 32px; font-weight: bold;\">Stickerland</h1>\r\n        <p style=\"margin: 10px 0 0 0; color: #333; font-size: 14px;\">Invoice Payment Required</p>\r\n      </div>\r\n\r\n      <!-- Main Content -->\r\n      <div style=\"background: #ffffff; padding: 40px 20px; border: 1px solid #e5e7eb; border-radius: 0 0 8px 8px;\">\r\n        <!-- Greeting -->\r\n        <p style=\"color: #374151; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\r\n          Hi ${customerName},\r\n        </p>\r\n\r\n        <p style=\"color: #374151; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;\">\r\n          We've prepared an invoice for you. Please review the details below and complete payment by the due date.\r\n        </p>\r\n\r\n        <!-- Invoice Details -->\r\n        <div style=\"background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin: 30px 0;\">\r\n          <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px;\">\r\n            <div>\r\n              <p style=\"color: #6b7280; font-size: 12px; margin: 0 0 5px 0; text-transform: uppercase; font-weight: 600;\">Invoice Number</p>\r\n              <p style=\"color: #1f2937; font-size: 16px; margin: 0; font-weight: 600;\">${invoiceNumber}</p>\r\n            </div>\r\n            <div>\r\n              <p style=\"color: #6b7280; font-size: 12px; margin: 0 0 5px 0; text-transform: uppercase; font-weight: 600;\">Due Date</p>\r\n              <p style=\"color: #1f2937; font-size: 16px; margin: 0; font-weight: 600;\">${formattedDueDate}</p>\r\n            </div>\r\n            <div style=\"grid-column: 1 / -1;\">\r\n              <p style=\"color: #6b7280; font-size: 12px; margin: 0 0 5px 0; text-transform: uppercase; font-weight: 600;\">Amount Due</p>\r\n              <p style=\"color: #059669; font-size: 28px; margin: 0; font-weight: bold;\">$${total}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        ${\r\n          invoiceDetails?.notes\r\n            ? `\r\n          <div style=\"background: #f0fdf4; border-left: 4px solid #059669; padding: 15px; margin: 20px 0; border-radius: 4px;\">\r\n            <p style=\"color: #6b7280; font-size: 12px; margin: 0 0 5px 0; text-transform: uppercase; font-weight: 600;\">Notes</p>\r\n            <p style=\"color: #1f2937; font-size: 14px; margin: 0; white-space: pre-wrap;\">${invoiceDetails.notes}</p>\r\n          </div>\r\n        `\r\n            : \"\"\r\n        }\r\n\r\n        <!-- CTA Button -->\r\n        <div style=\"text-align: center; margin: 30px 0;\">\r\n          <a href=\"${paymentLink}\" style=\"display: inline-block; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #000; text-decoration: none; padding: 15px 40px; border-radius: 6px; font-weight: 600; font-size: 16px; transition: transform 0.2s;\">\r\n            Pay Invoice Now\r\n          </a>\r\n        </div>\r\n\r\n        <p style=\"color: #6b7280; font-size: 14px; line-height: 1.6; margin: 20px 0; text-align: center;\">\r\n          Or copy and paste this link in your browser:\r\n          <br>\r\n          <span style=\"color: #3b82f6; word-break: break-all;\">${paymentLink}</span>\r\n        </p>\r\n\r\n        <!-- Footer -->\r\n        <div style=\"border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 30px; text-align: center;\">\r\n          <p style=\"color: #6b7280; font-size: 12px; margin: 0;\">\r\n            If you have any questions about this invoice, please reply to this email or contact our support team.\r\n          </p>\r\n          <p style=\"color: #9ca3af; font-size: 11px; margin: 10px 0 0 0;\">\r\n            ¬© ${new Date().getFullYear()} Stickerland. All rights reserved.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,yBACd,YAAoB,EACpB,aAAqB,EACrB,KAAa,EACb,OAAe,EACf,WAAmB,EACnB,cAGC;IAED,MAAM,mBAAmB,IAAI,KAAK,SAAS,kBAAkB,CAAC,SAAS;QACrE,MAAM;QACN,OAAO;QACP,KAAK;IACP;IAEA,OAAO,CAAC;;;;;;;;;;;;aAYG,EAAE,aAAa;;;;;;;;;;;;uFAY2D,EAAE,cAAc;;;;uFAIhB,EAAE,iBAAiB;;;;yFAIjB,EAAE,MAAM;;;;;QAKzF,EACE,gBAAgB,QACZ,CAAC;;;0FAG2E,EAAE,eAAe,KAAK,CAAC;;QAEzG,CAAC,GACK,GACL;;;;mBAIU,EAAE,YAAY;;;;;;;;+DAQ8B,EAAE,YAAY;;;;;;;;;cAS/D,EAAE,IAAI,OAAO,WAAW,GAAG;;;;;EAKvC,CAAC;AACH"}},
    {"offset": {"line": 15278, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/invoices.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { Request, Response, NextFunction } from \"express\";\r\nimport { supabase } from \"../utils/supabase\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\nimport crypto from \"crypto\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport { Resend } from \"resend\";\r\nimport { generateInvoiceEmailHtml } from \"../emails/invoice-payment\";\r\n\r\n// Initialize Resend for email sending\r\nconst resend = process.env.RESEND_API_KEY\r\n  ? new Resend(process.env.RESEND_API_KEY)\r\n  : null;\r\n\r\nconst INVOICE_EMAIL_FROM = \"invoices@stickerland.com\";\r\n\r\n// Middleware to verify JWT token for invoices (uses custom JWT format from system)\r\nexport const verifySupabaseToken = async (\r\n  req: Request,\r\n  res: Response,\r\n  next: NextFunction,\r\n): Promise<void> => {\r\n  try {\r\n    const JWT_SECRET = process.env.JWT_SECRET;\r\n\r\n    if (!JWT_SECRET) {\r\n      res.status(500).json({ error: \"Server configuration error\" });\r\n      return;\r\n    }\r\n\r\n    const authHeader = req.headers.authorization;\r\n    if (!authHeader || !authHeader.startsWith(\"Bearer \")) {\r\n      res.status(401).json({ error: \"No authorization token provided\" });\r\n      return;\r\n    }\r\n\r\n    const token = authHeader.substring(7);\r\n\r\n    // Verify the JWT token\r\n    const decoded = jwt.verify(token, JWT_SECRET) as {\r\n      customerId: number;\r\n      email: string;\r\n    };\r\n\r\n    // Store customer info in request\r\n    (req as any).customerId = decoded.customerId;\r\n    (req as any).email = decoded.email;\r\n\r\n    // Check if user is admin\r\n    try {\r\n      const { data: customer } = await supabase\r\n        .from(\"customers\")\r\n        .select(\"is_admin\")\r\n        .eq(\"id\", decoded.customerId)\r\n        .single();\r\n\r\n      if (!customer?.is_admin) {\r\n        res.status(403).json({ error: \"Admin access required\" });\r\n        return;\r\n      }\r\n\r\n      (req as any).isAdmin = true;\r\n    } catch (error) {\r\n      res.status(403).json({ error: \"Admin access required\" });\r\n      return;\r\n    }\r\n\r\n    next();\r\n  } catch (error) {\r\n    console.error(\"Token verification error:\", error);\r\n    res.status(401).json({ error: \"Invalid or expired token\" });\r\n  }\r\n};\r\n\r\n// Types\r\ninterface Invoice {\r\n  id: number;\r\n  invoice_number: string;\r\n  customer_name: string;\r\n  customer_email: string;\r\n  company?: string;\r\n  billing_address?: any;\r\n  invoice_type: \"Standard\" | \"ArtworkUpload\";\r\n  status: \"Draft\" | \"Sent\" | \"Unpaid\" | \"Paid\" | \"Overdue\" | \"Canceled\";\r\n  issue_date: string;\r\n  due_date: string;\r\n  notes?: string;\r\n  subtotal: number;\r\n  tax_rate: number;\r\n  tax_amount: number;\r\n  shipping: number;\r\n  discount_amount: number;\r\n  discount_type?: \"fixed\" | \"percentage\";\r\n  total: number;\r\n  sent_date?: string;\r\n  paid_date?: string;\r\n  canceled_date?: string;\r\n  cancellation_reason?: string;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\ninterface LineItem {\r\n  item_name: string;\r\n  description?: string;\r\n  quantity: number;\r\n  unit_price: number;\r\n  tax_enabled?: boolean;\r\n}\r\n\r\n// Helper: Generate invoice number\r\nconst generateInvoiceNumber = async (): Promise<string> => {\r\n  const date = new Date();\r\n  const year = date.getFullYear();\r\n  const month = String(date.getMonth() + 1).padStart(2, \"0\");\r\n\r\n  // Get count of invoices this month\r\n  const lastDay = new Date(year, date.getMonth() + 1, 0).getDate();\r\n  const { data, error } = await supabase\r\n    .from(\"invoices\")\r\n    .select(\"id\", { count: \"exact\" })\r\n    .gte(\"created_at\", `${year}-${month}-01`)\r\n    .lte(\"created_at\", `${year}-${month}-${lastDay}`);\r\n\r\n  const count = (data?.length || 0) + 1;\r\n  return `INV-${year}${month}-${String(count).padStart(4, \"0\")}`;\r\n};\r\n\r\n// Helper: Generate token for customer payment link\r\nconst generateInvoiceToken = (): string => {\r\n  return crypto.randomBytes(32).toString(\"hex\");\r\n};\r\n\r\n// Get all invoices (admin)\r\nexport const handleGetInvoices: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { status, type, sort_by, sort_order } = req.query;\r\n    const search = req.query.search as string | undefined;\r\n\r\n    let query = supabase.from(\"invoices\").select(\"*, invoice_line_items(*)\");\r\n\r\n    // Apply filters\r\n    if (status) {\r\n      query = query.eq(\"status\", status);\r\n    }\r\n    if (type) {\r\n      query = query.eq(\"invoice_type\", type);\r\n    }\r\n    if (search) {\n      // SECURITY: Sanitize search input to prevent SQL injection\n      // Escape special SQL LIKE characters (% and _)\n      const sanitizedSearch = search.replace(/[%_]/g, '\\\\$&');\n      query = query.or(\n        `customer_name.ilike.%${sanitizedSearch}%,customer_email.ilike.%${sanitizedSearch}%,invoice_number.ilike.%${sanitizedSearch}%`,\n      );\n    }\n\r\n    // Apply sorting\r\n    const orderBy = sort_by || \"created_at\";\r\n    const order = sort_order === \"asc\" ? \"asc\" : \"desc\";\r\n    query = query.order(orderBy, { ascending: order === \"asc\" });\r\n\r\n    const { data, error } = await query;\r\n\r\n    // Handle missing table gracefully\r\n    if (\r\n      error &&\r\n      (error.code === \"PGRST205\" ||\r\n        error.message.includes(\"Could not find the table\"))\r\n    ) {\r\n      console.log(\"Invoices table not yet created, returning empty list\");\r\n      return res.status(200).json({\r\n        success: true,\r\n        data: [],\r\n        stats: {\r\n          total_outstanding: 0,\r\n          paid_this_month: 0,\r\n          overdue_count: 0,\r\n          draft_count: 0,\r\n        },\r\n      });\r\n    }\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    // Calculate summary stats\r\n    const stats = {\r\n      total_outstanding: 0,\r\n      paid_this_month: 0,\r\n      overdue_count: 0,\r\n      draft_count: 0,\r\n    };\r\n\r\n    if (data) {\r\n      const now = new Date();\r\n      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);\r\n\r\n      data.forEach((inv: any) => {\r\n        if (inv.status === \"Unpaid\" || inv.status === \"Overdue\") {\r\n          stats.total_outstanding += inv.total;\r\n        }\r\n        if (inv.status === \"Paid\" && new Date(inv.paid_date) >= monthStart) {\r\n          stats.paid_this_month += inv.total;\r\n        }\r\n        if (inv.status === \"Overdue\") {\r\n          stats.overdue_count += 1;\r\n        }\r\n        if (inv.status === \"Draft\") {\r\n          stats.draft_count += 1;\r\n        }\r\n      });\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data,\r\n      stats,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get invoices error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error:\r\n        error instanceof Error ? error.message : \"Failed to fetch invoices\",\r\n    });\r\n  }\r\n};\r\n\r\n// Get single invoice (admin)\r\nexport const handleGetInvoice: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    const { data: invoice, error: invoiceError } = await supabase\r\n      .from(\"invoices\")\r\n      .select(\"*\")\r\n      .eq(\"id\", id)\r\n      .single();\r\n\r\n    // Handle missing table gracefully\r\n    if (\r\n      invoiceError &&\r\n      (invoiceError.code === \"PGRST205\" ||\r\n        invoiceError.message.includes(\"Could not find the table\"))\r\n    ) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Invoice not found\",\r\n      });\r\n    }\r\n\r\n    if (invoiceError || !invoice) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Invoice not found\",\r\n      });\r\n    }\r\n\r\n    const { data: lineItems } = await supabase\r\n      .from(\"invoice_line_items\")\r\n      .select(\"*\")\r\n      .eq(\"invoice_id\", id);\r\n\r\n    const { data: artwork } = await supabase\r\n      .from(\"invoice_artwork\")\r\n      .select(\"*\")\r\n      .eq(\"invoice_id\", id);\r\n\r\n    const { data: activity } = await supabase\r\n      .from(\"invoice_activity\")\r\n      .select(\"*\")\r\n      .eq(\"invoice_id\", id)\r\n      .order(\"timestamp\", { ascending: false });\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: {\r\n        ...invoice,\r\n        line_items: lineItems || [],\r\n        artwork: artwork || [],\r\n        activity: activity || [],\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get invoice error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: error instanceof Error ? error.message : \"Failed to fetch invoice\",\r\n    });\r\n  }\r\n};\r\n\r\n// Create invoice (admin)\r\nexport const handleCreateInvoice: RequestHandler = async (req, res) => {\r\n  try {\r\n    const {\r\n      customer_name,\r\n      customer_email,\r\n      company,\r\n      billing_address,\r\n      invoice_type,\r\n      issue_date,\r\n      due_date,\r\n      notes,\r\n      line_items,\r\n      tax_rate,\r\n      shipping,\r\n      discount_amount,\r\n      discount_type,\r\n    } = req.body;\r\n\r\n    // Generate invoice number\r\n    const invoice_number = await generateInvoiceNumber();\r\n\r\n    // Calculate totals\r\n    let subtotal = 0;\r\n    if (line_items && Array.isArray(line_items)) {\r\n      subtotal = line_items.reduce((sum: number, item: any) => {\r\n        return sum + item.quantity * item.unit_price;\r\n      }, 0);\r\n    }\r\n\r\n    const tax_amount = (subtotal * (tax_rate || 0)) / 100;\r\n    const total =\r\n      subtotal + tax_amount + (shipping || 0) - (discount_amount || 0);\r\n\r\n    // Create invoice\r\n    const { data: invoice, error: invoiceError } = await supabase\r\n      .from(\"invoices\")\r\n      .insert({\r\n        invoice_number,\r\n        customer_name,\r\n        customer_email,\r\n        customer_phone: null,\r\n        invoice_type,\r\n        due_date,\r\n        notes,\r\n        subtotal,\r\n        tax_rate,\r\n        tax_amount,\r\n        shipping: shipping || 0,\r\n        discount_amount: discount_amount || 0,\r\n        total,\r\n        status: \"Draft\",\r\n        metadata: {\r\n          company,\r\n          billing_address,\r\n          discount_type,\r\n          issue_date,\r\n        },\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (invoiceError) {\r\n      // Handle missing invoices table gracefully\r\n      if (\r\n        invoiceError.code === \"PGRST205\" ||\r\n        invoiceError.message.includes(\"Could not find the table\")\r\n      ) {\r\n        console.log(\"Invoices table not yet created\");\r\n        return res.status(503).json({\r\n          success: false,\r\n          error:\r\n            \"Invoicing system is not yet available. Please contact support.\",\r\n        });\r\n      }\r\n      throw invoiceError;\r\n    }\r\n\r\n    if (!invoice) {\r\n      throw new Error(\"Failed to create invoice\");\r\n    }\r\n\r\n    // Add line items\r\n    if (line_items && Array.isArray(line_items)) {\r\n      const itemsToInsert = line_items.map((item: LineItem) => ({\r\n        invoice_id: invoice.id,\r\n        item_name: item.item_name,\r\n        description: item.description,\r\n        quantity: item.quantity,\r\n        unit_price: item.unit_price,\r\n        amount: item.quantity * item.unit_price,\r\n      }));\r\n\r\n      const { error: itemsError } = await supabase\r\n        .from(\"invoice_line_items\")\r\n        .insert(itemsToInsert);\r\n\r\n      if (itemsError) {\r\n        console.warn(\"Failed to add invoice line items:\", itemsError);\r\n      }\r\n    }\r\n\r\n    // Log activity\r\n    const { error: activityError } = await supabase\r\n      .from(\"invoice_activity\")\r\n      .insert({\r\n        invoice_id: invoice.id,\r\n        action: \"created\",\r\n        description: \"Invoice created\",\r\n      });\r\n\r\n    if (activityError) {\r\n      console.warn(\"Failed to log invoice activity:\", activityError);\r\n    }\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      data: invoice,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Create invoice error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error:\r\n        error instanceof Error ? error.message : \"Failed to create invoice\",\r\n    });\r\n  }\r\n};\r\n\r\n// Update invoice (admin)\r\nexport const handleUpdateInvoice: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const {\r\n      customer_name,\r\n      customer_email,\r\n      company,\r\n      billing_address,\r\n      due_date,\r\n      notes,\r\n      line_items,\r\n      tax_rate,\r\n      shipping,\r\n      discount_amount,\r\n      discount_type,\r\n    } = req.body;\r\n\r\n    // Get existing invoice\r\n    const { data: existing, error: existingError } = await supabase\r\n      .from(\"invoices\")\r\n      .select(\"*\")\r\n      .eq(\"id\", id)\r\n      .single();\r\n\r\n    // Handle missing invoices table\r\n    if (\r\n      existingError &&\r\n      (existingError.code === \"PGRST205\" ||\r\n        existingError.message.includes(\"Could not find the table\"))\r\n    ) {\r\n      return res.status(503).json({\r\n        success: false,\r\n        error: \"Invoicing system is not yet available. Please contact support.\",\r\n      });\r\n    }\r\n\r\n    if (!existing) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Invoice not found\",\r\n      });\r\n    }\r\n\r\n    // Only allow edit if Draft\r\n    if (existing.status !== \"Draft\") {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Can only edit draft invoices\",\r\n      });\r\n    }\r\n\r\n    // Recalculate totals\r\n    let subtotal = 0;\r\n    if (line_items && Array.isArray(line_items)) {\r\n      subtotal = line_items.reduce((sum: number, item: any) => {\r\n        return sum + item.quantity * item.unit_price;\r\n      }, 0);\r\n    }\r\n\r\n    const tax_amount = (subtotal * (tax_rate || 0)) / 100;\r\n    const total =\r\n      subtotal + tax_amount + (shipping || 0) - (discount_amount || 0);\r\n\r\n    // Update invoice\r\n    const { data: updated, error } = await supabase\r\n      .from(\"invoices\")\r\n      .update({\r\n        customer_name,\r\n        customer_email,\r\n        company,\r\n        billing_address,\r\n        due_date,\r\n        notes,\r\n        subtotal,\r\n        tax_rate,\r\n        tax_amount,\r\n        shipping: shipping || 0,\r\n        discount_amount: discount_amount || 0,\r\n        discount_type,\r\n        total,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error || !updated) {\r\n      throw error || new Error(\"Failed to update invoice\");\r\n    }\r\n\r\n    // Update line items\r\n    await supabase.from(\"invoice_line_items\").delete().eq(\"invoice_id\", id);\r\n\r\n    if (line_items && Array.isArray(line_items)) {\r\n      const itemsToInsert = line_items.map((item: LineItem) => ({\r\n        invoice_id: id,\r\n        item_name: item.item_name,\r\n        description: item.description,\r\n        quantity: item.quantity,\r\n        unit_price: item.unit_price,\r\n        line_total: item.quantity * item.unit_price,\r\n        tax_enabled: item.tax_enabled || false,\r\n      }));\r\n\r\n      await supabase.from(\"invoice_line_items\").insert(itemsToInsert);\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: updated,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Update invoice error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error:\r\n        error instanceof Error ? error.message : \"Failed to update invoice\",\r\n    });\r\n  }\r\n};\r\n\r\n// Send invoice (admin)\r\nexport const handleSendInvoice: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { email_subject, email_message } = req.body;\r\n\r\n    // Get invoice\r\n    const { data: invoice } = await supabase\r\n      .from(\"invoices\")\r\n      .select(\"*\")\r\n      .eq(\"id\", id)\r\n      .single();\r\n\r\n    if (!invoice) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Invoice not found\",\r\n      });\r\n    }\r\n\r\n    // Generate payment token\r\n    const token = generateInvoiceToken();\r\n\r\n    // Save token\r\n    const { data: tokenData } = await supabase\r\n      .from(\"invoice_tokens\")\r\n      .insert({\r\n        invoice_id: id,\r\n        token,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    // Update invoice status to Sent\r\n    const { error: updateError } = await supabase\r\n      .from(\"invoices\")\r\n      .update({\r\n        status: \"Sent\",\r\n        sent_date: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", id);\r\n\r\n    if (updateError) {\r\n      throw updateError;\r\n    }\r\n\r\n    // Log activity\r\n    await supabase.from(\"invoice_activity\").insert({\r\n      invoice_id: id,\r\n      action: \"sent\",\r\n      description: \"Invoice sent to customer\",\r\n    });\r\n\r\n    // Generate payment link\r\n    const paymentLink = `https://stickerland.app/invoice/${token}`;\r\n\r\n    // Send email via Resend\r\n    let emailSent = false;\r\n    if (resend && process.env.RESEND_API_KEY) {\r\n      try {\r\n        const emailHtml = generateInvoiceEmailHtml(\r\n          invoice.customer_name,\r\n          invoice.invoice_number,\r\n          invoice.total.toFixed(2),\r\n          invoice.due_date,\r\n          paymentLink,\r\n          {\r\n            company: invoice.company,\r\n            notes: invoice.notes,\r\n          },\r\n        );\r\n\r\n        const emailResult = await resend.emails.send({\r\n          from: INVOICE_EMAIL_FROM,\r\n          to: invoice.customer_email,\r\n          subject: `Invoice ${invoice.invoice_number} from Stickerland - Payment Required`,\r\n          html: emailHtml,\r\n        });\r\n\r\n        if (emailResult.data?.id) {\r\n          emailSent = true;\r\n          console.log(\r\n            `Invoice email sent to ${invoice.customer_email} - Email ID: ${emailResult.data.id}`,\r\n          );\r\n        } else {\r\n          console.warn(\r\n            `Failed to send invoice email to ${invoice.customer_email}:`,\r\n            emailResult.error,\r\n          );\r\n        }\r\n      } catch (emailError) {\r\n        console.error(\r\n          `Error sending invoice email to ${invoice.customer_email}:`,\r\n          emailError,\r\n        );\r\n      }\r\n    } else {\r\n      console.warn(\r\n        \"Resend API key not configured. Invoice email not sent. Set RESEND_API_KEY environment variable to enable email sending.\",\r\n      );\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: {\r\n        invoice,\r\n        payment_link: paymentLink,\r\n        token,\r\n        email_sent: emailSent,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Send invoice error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: error instanceof Error ? error.message : \"Failed to send invoice\",\r\n    });\r\n  }\r\n};\r\n\r\n// Mark invoice as paid\r\nexport const handleMarkInvoicePaid: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"invoices\")\r\n      .update({\r\n        status: \"Paid\",\r\n        paid_date: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error || !data) {\r\n      throw error || new Error(\"Failed to update invoice\");\r\n    }\r\n\r\n    // Log activity\r\n    await supabase.from(\"invoice_activity\").insert({\r\n      invoice_id: id,\r\n      action: \"paid\",\r\n      description: \"Invoice marked as paid\",\r\n    });\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Mark paid error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error:\r\n        error instanceof Error ? error.message : \"Failed to mark invoice paid\",\r\n    });\r\n  }\r\n};\r\n\r\n// Cancel invoice\r\nexport const handleCancelInvoice: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { reason } = req.body;\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"invoices\")\r\n      .update({\r\n        status: \"Canceled\",\r\n        canceled_date: new Date().toISOString(),\r\n        cancellation_reason: reason,\r\n      })\r\n      .eq(\"id\", id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error || !data) {\r\n      throw error || new Error(\"Failed to cancel invoice\");\r\n    }\r\n\r\n    // Log activity\r\n    await supabase.from(\"invoice_activity\").insert({\r\n      invoice_id: id,\r\n      action: \"canceled\",\r\n      description: `Invoice canceled${reason ? `: ${reason}` : \"\"}`,\r\n    });\r\n\r\n    // TODO: Send cancellation email\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Cancel invoice error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error:\r\n        error instanceof Error ? error.message : \"Failed to cancel invoice\",\r\n    });\r\n  }\r\n};\r\n\r\n// Get or create payment token for invoice\r\nexport const handleGetPaymentToken: RequestHandler = async (req, res) => {\r\n  try {\r\n    const invoiceId = req.params.invoiceId as string;\r\n\r\n    // Try to get existing token (most recent one)\r\n    const { data: existingToken, error: fetchError } = await supabase\r\n      .from(\"invoice_tokens\")\r\n      .select(\"token\")\r\n      .eq(\"invoice_id\", invoiceId)\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(1)\r\n      .maybeSingle();\r\n\r\n    // Return existing token if found\r\n    if (existingToken && !fetchError) {\r\n      return res.status(200).json({\r\n        success: true,\r\n        data: {\r\n          token: existingToken.token,\r\n        },\r\n      });\r\n    }\r\n\r\n    // Create new token if one doesn't exist\r\n    const newToken = generateInvoiceToken();\r\n\r\n    const { data: createdToken, error } = await supabase\r\n      .from(\"invoice_tokens\")\r\n      .insert({\r\n        invoice_id: parseInt(invoiceId),\r\n        token: newToken,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (error || !createdToken) {\r\n      throw error || new Error(\"Failed to create payment token\");\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: {\r\n        token: newToken,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get payment token error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error:\r\n        error instanceof Error ? error.message : \"Failed to get payment token\",\r\n    });\r\n  }\r\n};\r\n\r\n// Get invoice by token (customer view)\r\nexport const handleGetInvoiceByToken: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { token } = req.params;\r\n\r\n    if (!token) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"No token provided\",\r\n      });\r\n    }\r\n\r\n    // Get token - handle gracefully if table doesn't exist\r\n    const { data: tokenData, error: tokenError } = await supabase\r\n      .from(\"invoice_tokens\")\r\n      .select(\"invoice_id, views\")\r\n      .eq(\"token\", token)\r\n      .maybeSingle();\r\n\r\n    if (tokenError) {\r\n      console.error(\"Error fetching token:\", tokenError);\r\n      // If table doesn't exist, return helpful error\r\n      if (\r\n        tokenError.code === \"PGRST204\" ||\r\n        tokenError.message.includes(\"Could not find the table\")\r\n      ) {\r\n        return res.status(503).json({\r\n          success: false,\r\n          error: \"Invoice system not yet initialized. Please contact support.\",\r\n        });\r\n      }\r\n      throw tokenError;\r\n    }\r\n\r\n    if (!tokenData) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Invalid invoice link\",\r\n      });\r\n    }\r\n\r\n    // Update view count (non-blocking - fire and forget)\r\n    const { error: viewError } = await supabase\r\n      .from(\"invoice_tokens\")\r\n      .update({\r\n        views: (tokenData.views || 0) + 1,\r\n        last_viewed_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"token\", token);\r\n\r\n    if (viewError) {\r\n      console.error(\"Error updating token views:\", viewError);\r\n    }\r\n\r\n    // Get invoice\r\n    const { data: invoice, error: invoiceError } = await supabase\r\n      .from(\"invoices\")\r\n      .select(\"*\")\r\n      .eq(\"id\", tokenData.invoice_id)\r\n      .maybeSingle();\r\n\r\n    if (invoiceError) {\r\n      console.error(\"Error fetching invoice:\", invoiceError);\r\n      throw invoiceError;\r\n    }\r\n\r\n    if (!invoice) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Invoice not found\",\r\n      });\r\n    }\r\n\r\n    // Get line items\r\n    const { data: lineItems, error: lineItemsError } = await supabase\r\n      .from(\"invoice_line_items\")\r\n      .select(\"*\")\r\n      .eq(\"invoice_id\", invoice.id);\r\n\r\n    if (lineItemsError) {\r\n      console.error(\"Error fetching line items:\", lineItemsError);\r\n      // Don't fail if line items can't be fetched, return empty array\r\n    }\r\n\r\n    // Get artwork if needed\r\n    let artwork = null;\r\n    if (invoice.invoice_type === \"ArtworkUpload\") {\r\n      const { data: artworkData, error: artworkError } = await supabase\r\n        .from(\"invoice_artwork\")\r\n        .select(\"*\")\r\n        .eq(\"invoice_id\", invoice.id);\r\n\r\n      if (artworkError) {\r\n        console.error(\"Error fetching artwork:\", artworkError);\r\n        // Don't fail if artwork can't be fetched, return empty array\r\n      } else {\r\n        artwork = artworkData;\r\n      }\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: {\r\n        ...invoice,\r\n        line_items: lineItems || [],\r\n        artwork: artwork || [],\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get invoice by token error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error:\r\n        error instanceof Error\r\n          ? error.message\r\n          : \"Failed to fetch invoice. Please try again later.\",\r\n    });\r\n  }\r\n};\r\n\r\n// Create Square payment link for invoice\r\nexport const handleCreateInvoicePaymentLink: RequestHandler = async (\r\n  req,\r\n  res,\r\n) => {\r\n  try {\r\n    const { token } = req.params;\r\n\r\n    // Get token and invoice\r\n    const { data: tokenData } = await supabase\r\n      .from(\"invoice_tokens\")\r\n      .select(\"invoice_id\")\r\n      .eq(\"token\", token)\r\n      .single();\r\n\r\n    if (!tokenData) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Invalid invoice token\",\r\n      });\r\n    }\r\n\r\n    // Get invoice details\r\n    const { data: invoice } = await supabase\r\n      .from(\"invoices\")\r\n      .select(\"*\")\r\n      .eq(\"id\", tokenData.invoice_id)\r\n      .single();\r\n\r\n    if (!invoice) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Invoice not found\",\r\n      });\r\n    }\r\n\r\n    // Check if invoice is already paid\r\n    if (invoice.status === \"Paid\") {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"Invoice has already been paid\",\r\n      });\r\n    }\r\n\r\n    // Get line items for description\r\n    const { data: lineItems } = await supabase\r\n      .from(\"invoice_line_items\")\r\n      .select(\"*\")\r\n      .eq(\"invoice_id\", invoice.id);\r\n\r\n    // Import Square utilities\r\n    const { createSquarePaymentLink } = await import(\"../utils/square\");\r\n\r\n    // Build description from line items\r\n    let description = `Invoice #${invoice.invoice_number}`;\r\n    if (lineItems && lineItems.length > 0) {\r\n      const itemNames = lineItems.slice(0, 3).map((item) => item.item_name);\r\n      description += ` - ${itemNames.join(\", \")}`;\r\n      if (lineItems.length > 3) {\r\n        description += ` + ${lineItems.length - 3} more`;\r\n      }\r\n    }\r\n\r\n    // Determine redirect URL\r\n    const baseUrl =\r\n      process.env.BASE_URL ||\r\n      (process.env.NODE_ENV === \"production\"\r\n        ? \"https://stickerland.app\"\r\n        : \"http://localhost:5173\");\r\n    const redirectUrl = `${baseUrl}/invoice/${token}`;\r\n\r\n    // Create Square payment link\r\n    const paymentLinkResult = await createSquarePaymentLink({\r\n      orderId: invoice.id.toString(),\r\n      amount: invoice.total,\r\n      currency: \"USD\",\r\n      description,\r\n      customerEmail: invoice.customer_email,\r\n      customerName: invoice.customer_name,\r\n      redirectUrl,\r\n      subtotal: invoice.subtotal,\r\n      tax: invoice.tax_amount,\r\n      shipping: invoice.shipping || 0,\r\n      discount: invoice.discount_amount || 0,\r\n      items: (lineItems || []).map((item) => ({\r\n        product_name: item.item_name,\r\n        quantity: item.quantity,\r\n        price: item.unit_price,\r\n      })),\r\n    });\r\n\r\n    if (!paymentLinkResult.success || !paymentLinkResult.paymentLinkUrl) {\r\n      console.error(\"Failed to create Square payment link:\", paymentLinkResult);\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: paymentLinkResult.error || \"Failed to create payment link\",\r\n      });\r\n    }\r\n\r\n    // Log activity\r\n    await supabase.from(\"invoice_activity\").insert({\r\n      invoice_id: invoice.id,\r\n      action: \"payment_initiated\",\r\n      description: \"Customer initiated Square payment\",\r\n    });\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: {\r\n        payment_link: paymentLinkResult.paymentLinkUrl,\r\n        invoice_number: invoice.invoice_number,\r\n        amount: invoice.total,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Create invoice payment link error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error:\r\n        error instanceof Error\r\n          ? error.message\r\n          : \"Failed to create payment link\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 16024, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/db-setup.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { supabase } from \"../utils/supabase\";\r\n\r\nexport const handleInitializeInvoicesDatabase: RequestHandler = async (req, res) => {\r\n  try {\r\n    console.log(\"Database setup endpoint called\");\r\n\r\n    // Create invoices table\r\n    const invoicesQuery = `\r\n      CREATE TABLE IF NOT EXISTS invoices (\r\n        id BIGSERIAL PRIMARY KEY,\r\n        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\r\n        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\r\n        invoice_number VARCHAR(50) UNIQUE NOT NULL,\r\n        customer_name VARCHAR(255) NOT NULL,\r\n        customer_email VARCHAR(255) NOT NULL,\r\n        customer_phone VARCHAR(20),\r\n        invoice_type VARCHAR(50) DEFAULT 'Standard' CHECK (invoice_type IN ('Standard', 'ArtworkUpload')),\r\n        status VARCHAR(50) DEFAULT 'Draft' CHECK (status IN ('Draft', 'Sent', 'Unpaid', 'Paid', 'Overdue', 'Canceled')),\r\n        subtotal NUMERIC(12, 2) DEFAULT 0,\r\n        tax_amount NUMERIC(12, 2) DEFAULT 0,\r\n        tax_rate NUMERIC(5, 2) DEFAULT 0,\r\n        shipping NUMERIC(12, 2) DEFAULT 0,\r\n        discount_amount NUMERIC(12, 2) DEFAULT 0,\r\n        total NUMERIC(12, 2) NOT NULL,\r\n        due_date DATE,\r\n        sent_date TIMESTAMP WITH TIME ZONE,\r\n        paid_date TIMESTAMP WITH TIME ZONE,\r\n        notes TEXT,\r\n        metadata JSONB DEFAULT '{}'::jsonb\r\n      );\r\n      \r\n      CREATE INDEX IF NOT EXISTS idx_invoices_customer_email ON invoices(customer_email);\r\n      CREATE INDEX IF NOT EXISTS idx_invoices_status ON invoices(status);\r\n      CREATE INDEX IF NOT EXISTS idx_invoices_created_at ON invoices(created_at DESC);\r\n      CREATE INDEX IF NOT EXISTS idx_invoices_invoice_number ON invoices(invoice_number);\r\n    `;\r\n\r\n    const invoicesLineItemsQuery = `\r\n      CREATE TABLE IF NOT EXISTS invoice_line_items (\r\n        id BIGSERIAL PRIMARY KEY,\r\n        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\r\n        invoice_id BIGINT NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,\r\n        item_name VARCHAR(255) NOT NULL,\r\n        description TEXT,\r\n        quantity NUMERIC(10, 2) NOT NULL DEFAULT 1,\r\n        unit_price NUMERIC(12, 2) NOT NULL,\r\n        amount NUMERIC(12, 2) NOT NULL,\r\n        metadata JSONB DEFAULT '{}'::jsonb\r\n      );\r\n      \r\n      CREATE INDEX IF NOT EXISTS idx_line_items_invoice_id ON invoice_line_items(invoice_id);\r\n    `;\r\n\r\n    const invoiceTokensQuery = `\r\n      CREATE TABLE IF NOT EXISTS invoice_tokens (\r\n        id BIGSERIAL PRIMARY KEY,\r\n        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\r\n        invoice_id BIGINT NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,\r\n        token VARCHAR(255) UNIQUE NOT NULL,\r\n        expires_at TIMESTAMP WITH TIME ZONE,\r\n        is_active BOOLEAN DEFAULT TRUE,\r\n        metadata JSONB DEFAULT '{}'::jsonb\r\n      );\r\n      \r\n      CREATE INDEX IF NOT EXISTS idx_tokens_token ON invoice_tokens(token);\r\n      CREATE INDEX IF NOT EXISTS idx_tokens_invoice_id ON invoice_tokens(invoice_id);\r\n    `;\r\n\r\n    const invoiceArtworkQuery = `\r\n      CREATE TABLE IF NOT EXISTS invoice_artwork (\r\n        id BIGSERIAL PRIMARY KEY,\r\n        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\r\n        invoice_id BIGINT NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,\r\n        file_name VARCHAR(255) NOT NULL,\r\n        file_url VARCHAR(1024) NOT NULL,\r\n        file_size BIGINT,\r\n        file_type VARCHAR(50),\r\n        original_file_name VARCHAR(255),\r\n        metadata JSONB DEFAULT '{}'::jsonb\r\n      );\r\n      \r\n      CREATE INDEX IF NOT EXISTS idx_artwork_invoice_id ON invoice_artwork(invoice_id);\r\n    `;\r\n\r\n    const invoiceActivityQuery = `\r\n      CREATE TABLE IF NOT EXISTS invoice_activity (\r\n        id BIGSERIAL PRIMARY KEY,\r\n        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,\r\n        invoice_id BIGINT NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,\r\n        action VARCHAR(50) NOT NULL,\r\n        actor_type VARCHAR(50) DEFAULT 'admin' CHECK (actor_type IN ('admin', 'customer', 'system')),\r\n        actor_id VARCHAR(255),\r\n        description TEXT,\r\n        metadata JSONB DEFAULT '{}'::jsonb\r\n      );\r\n      \r\n      CREATE INDEX IF NOT EXISTS idx_activity_invoice_id ON invoice_activity(invoice_id);\r\n      CREATE INDEX IF NOT EXISTS idx_activity_created_at ON invoice_activity(created_at DESC);\r\n    `;\r\n\r\n    const rlsQuery = `\r\n      ALTER TABLE IF EXISTS invoices ENABLE ROW LEVEL SECURITY;\r\n      ALTER TABLE IF EXISTS invoice_line_items ENABLE ROW LEVEL SECURITY;\r\n      ALTER TABLE IF EXISTS invoice_tokens ENABLE ROW LEVEL SECURITY;\r\n      ALTER TABLE IF EXISTS invoice_artwork ENABLE ROW LEVEL SECURITY;\r\n      ALTER TABLE IF EXISTS invoice_activity ENABLE ROW LEVEL SECURITY;\r\n      \r\n      DROP POLICY IF EXISTS \"admin_can_view_invoices\" ON invoices;\r\n      CREATE POLICY \"admin_can_view_invoices\" ON invoices\r\n        FOR SELECT USING (\r\n          auth.jwt() ->> 'role' = 'authenticated' AND\r\n          (auth.jwt() -> 'app_metadata' ->> 'is_admin')::boolean = true\r\n        );\r\n\r\n      DROP POLICY IF EXISTS \"admin_can_insert_invoices\" ON invoices;\r\n      CREATE POLICY \"admin_can_insert_invoices\" ON invoices\r\n        FOR INSERT WITH CHECK (\r\n          auth.jwt() ->> 'role' = 'authenticated' AND\r\n          (auth.jwt() -> 'app_metadata' ->> 'is_admin')::boolean = true\r\n        );\r\n\r\n      DROP POLICY IF EXISTS \"admin_can_update_invoices\" ON invoices;\r\n      CREATE POLICY \"admin_can_update_invoices\" ON invoices\r\n        FOR UPDATE USING (\r\n          auth.jwt() ->> 'role' = 'authenticated' AND\r\n          (auth.jwt() -> 'app_metadata' ->> 'is_admin')::boolean = true\r\n        );\r\n\r\n      DROP POLICY IF EXISTS \"admin_can_delete_invoices\" ON invoices;\r\n      CREATE POLICY \"admin_can_delete_invoices\" ON invoices\r\n        FOR DELETE USING (\r\n          auth.jwt() ->> 'role' = 'authenticated' AND\r\n          (auth.jwt() -> 'app_metadata' ->> 'is_admin')::boolean = true\r\n        );\r\n\r\n      DROP POLICY IF EXISTS \"admin_can_view_line_items\" ON invoice_line_items;\r\n      CREATE POLICY \"admin_can_view_line_items\" ON invoice_line_items\r\n        FOR SELECT USING (\r\n          auth.jwt() ->> 'role' = 'authenticated' AND\r\n          (auth.jwt() -> 'app_metadata' ->> 'is_admin')::boolean = true\r\n        );\r\n\r\n      DROP POLICY IF EXISTS \"admin_can_insert_line_items\" ON invoice_line_items;\r\n      CREATE POLICY \"admin_can_insert_line_items\" ON invoice_line_items\r\n        FOR INSERT WITH CHECK (\r\n          auth.jwt() ->> 'role' = 'authenticated' AND\r\n          (auth.jwt() -> 'app_metadata' ->> 'is_admin')::boolean = true\r\n        );\r\n\r\n      DROP POLICY IF EXISTS \"tokens_can_be_accessed_with_valid_token\" ON invoice_tokens;\r\n      CREATE POLICY \"tokens_can_be_accessed_with_valid_token\" ON invoice_tokens\r\n        FOR SELECT USING (true);\r\n\r\n      DROP POLICY IF EXISTS \"admin_can_view_artwork\" ON invoice_artwork;\r\n      CREATE POLICY \"admin_can_view_artwork\" ON invoice_artwork\r\n        FOR SELECT USING (\r\n          auth.jwt() ->> 'role' = 'authenticated' AND\r\n          (auth.jwt() -> 'app_metadata' ->> 'is_admin')::boolean = true\r\n        );\r\n\r\n      DROP POLICY IF EXISTS \"admin_can_insert_artwork\" ON invoice_artwork;\r\n      CREATE POLICY \"admin_can_insert_artwork\" ON invoice_artwork\r\n        FOR INSERT WITH CHECK (\r\n          auth.jwt() ->> 'role' = 'authenticated' AND\r\n          (auth.jwt() -> 'app_metadata' ->> 'is_admin')::boolean = true\r\n        );\r\n\r\n      DROP POLICY IF EXISTS \"admin_can_view_activity\" ON invoice_activity;\r\n      CREATE POLICY \"admin_can_view_activity\" ON invoice_activity\r\n        FOR SELECT USING (\r\n          auth.jwt() ->> 'role' = 'authenticated' AND\r\n          (auth.jwt() -> 'app_metadata' ->> 'is_admin')::boolean = true\r\n        );\r\n\r\n      DROP POLICY IF EXISTS \"admin_can_insert_activity\" ON invoice_activity;\r\n      CREATE POLICY \"admin_can_insert_activity\" ON invoice_activity\r\n        FOR INSERT WITH CHECK (\r\n          auth.jwt() ->> 'role' = 'authenticated' AND\r\n          (auth.jwt() -> 'app_metadata' ->> 'is_admin')::boolean = true\r\n        );\r\n    `;\r\n\r\n    const publicAccessTokensQuery = `\r\n      CREATE TABLE IF NOT EXISTS public_access_tokens (\r\n        id BIGSERIAL PRIMARY KEY,\r\n        token VARCHAR(64) UNIQUE NOT NULL,\r\n        \r\n        -- Resource identification\r\n        resource_type VARCHAR(50) NOT NULL CHECK (resource_type IN ('proof', 'order', 'invoice', 'design')),\r\n        resource_id VARCHAR(255) NOT NULL,\r\n        \r\n        -- Expiration and usage\r\n        expires_at TIMESTAMPTZ NOT NULL,\r\n        one_time_use BOOLEAN DEFAULT FALSE,\r\n        used_at TIMESTAMPTZ,\r\n        \r\n        -- Audit trail\r\n        created_at TIMESTAMPTZ DEFAULT NOW(),\r\n        created_by VARCHAR(255),\r\n        metadata JSONB,\r\n        \r\n        -- Constraints\r\n        CONSTRAINT token_not_too_long CHECK (LENGTH(token) = 64),\r\n        CONSTRAINT token_hex_format CHECK (token ~ '^[0-9a-f]{64}$')\r\n      );\r\n\r\n      -- INDEXES\r\n      CREATE INDEX IF NOT EXISTS idx_public_access_tokens_token \r\n        ON public_access_tokens(token) \r\n        WHERE used_at IS NULL;\r\n      \r\n      CREATE INDEX IF NOT EXISTS idx_public_access_tokens_resource \r\n        ON public_access_tokens(resource_type, resource_id);\r\n      \r\n      CREATE INDEX IF NOT EXISTS idx_public_access_tokens_expires \r\n        ON public_access_tokens(expires_at) \r\n        WHERE used_at IS NULL;\r\n\r\n      -- COMMENTS\r\n      COMMENT ON TABLE public_access_tokens IS 'Cryptographically secure access tokens for public endpoints. Replaces guessable ID-based access.';\r\n\r\n      -- PERMISSIONS\r\n      REVOKE ALL ON public_access_tokens FROM anon, authenticated;\r\n      GRANT USAGE ON SEQUENCE public_access_tokens_id_seq TO anon, authenticated;\r\n    `;\r\n\r\n    // Try to create tables using direct query execution\r\n    // Fallback: Return SQL for manual execution if RPC doesn't work\r\n    const errors = [];\r\n\r\n    try {\r\n      // Check if invoices table exists by trying a select query\r\n      const { error: checkError } = await supabase\r\n        .from(\"invoices\")\r\n        .select(\"id\", { count: \"exact\", head: true })\r\n        .limit(0);\r\n\r\n      if (!checkError) {\r\n        // Table exists already\r\n        console.log(\"Invoices table already exists\");\r\n        return res.status(200).json({\r\n          message: \"Database already initialized\",\r\n          tables_created: false,\r\n          status: \"ready\",\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.log(\"Tables do not exist yet, creating them...\");\r\n    }\r\n\r\n    // If tables don't exist, we need to provide instructions\r\n    // Since we can't execute raw SQL through the normal client,\r\n    // return instructions for manual creation\r\n    res.status(202).json({\r\n      message: \"Database initialization required\",\r\n      status: \"manual_setup_needed\",\r\n      instructions: {\r\n        method: \"Copy the SQL below and execute it in Supabase SQL Editor\",\r\n        sql_commands: {\r\n          invoices_table: invoicesQuery,\r\n          line_items_table: invoicesLineItemsQuery,\r\n          tokens_table: invoiceTokensQuery,\r\n          artwork_table: invoiceArtworkQuery,\r\n          activity_table: invoiceActivityQuery,\r\n          public_access_tokens_table: publicAccessTokensQuery,\r\n          rls_policies: rlsQuery,\r\n        },\r\n        url: \"https://app.supabase.com/project/nbzttuomtdtsfzcagfnh/sql/new\",\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Database initialization error:\", error);\r\n    res.status(500).json({\r\n      error: \"Failed to initialize database\",\r\n      details: error instanceof Error ? error.message : String(error),\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;AACA;;;;;;AAEO,MAAM,mCAAmD,OAAO,KAAK;IAC1E,IAAI;QACF,QAAQ,GAAG,CAAC;QAEZ,wBAAwB;QACxB,MAAM,gBAAgB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;IA4BvB,CAAC;QAED,MAAM,yBAAyB,CAAC;;;;;;;;;;;;;;IAchC,CAAC;QAED,MAAM,qBAAqB,CAAC;;;;;;;;;;;;;IAa5B,CAAC;QAED,MAAM,sBAAsB,CAAC;;;;;;;;;;;;;;IAc7B,CAAC;QAED,MAAM,uBAAuB,CAAC;;;;;;;;;;;;;;IAc9B,CAAC;QAED,MAAM,WAAW,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAgFlB,CAAC;QAED,MAAM,0BAA0B,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IA0CjC,CAAC;QAED,oDAAoD;QACpD,gEAAgE;QAChE,MAAM,SAAS,EAAE;QAEjB,IAAI;YACF,0DAA0D;YAC1D,MAAM,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,gIAAQ,CACzC,IAAI,CAAC,YACL,MAAM,CAAC,MAAM;gBAAE,OAAO;gBAAS,MAAM;YAAK,GAC1C,KAAK,CAAC;YAET,IAAI,CAAC,YAAY;gBACf,uBAAuB;gBACvB,QAAQ,GAAG,CAAC;gBACZ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAC1B,SAAS;oBACT,gBAAgB;oBAChB,QAAQ;gBACV;YACF;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,GAAG,CAAC;QACd;QAEA,yDAAyD;QACzD,4DAA4D;QAC5D,0CAA0C;QAC1C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,QAAQ;YACR,cAAc;gBACZ,QAAQ;gBACR,cAAc;oBACZ,gBAAgB;oBAChB,kBAAkB;oBAClB,cAAc;oBACd,eAAe;oBACf,gBAAgB;oBAChB,4BAA4B;oBAC5B,cAAc;gBAChB;gBACA,KAAK;YACP;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kCAAkC;QAChD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,OAAO;YACP,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;QAC3D;IACF;AACF"}},
    {"offset": {"line": 16312, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/invoice-artwork.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { supabase } from \"../utils/supabase\";\r\nimport cloudinary from \"cloudinary\";\r\nimport multer from \"multer\";\r\nimport { Readable } from \"stream\";\r\n\r\n// Configure Cloudinary\r\ncloudinary.v2.config({\r\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\r\n  api_key: process.env.CLOUDINARY_API_KEY,\r\n  api_secret: process.env.CLOUDINARY_API_SECRET,\r\n});\r\n\r\n// Multer middleware for file uploads\r\nconst upload = multer({\r\n  storage: multer.memoryStorage(),\r\n  limits: {\r\n    fileSize: 50 * 1024 * 1024, // 50MB limit\r\n  },\r\n  fileFilter: (req, file, cb) => {\r\n    const allowedMimes = [\r\n      \"image/jpeg\",\r\n      \"image/png\",\r\n      \"image/gif\",\r\n      \"image/webp\",\r\n      \"application/pdf\",\r\n      \"application/x-pdf\",\r\n    ];\r\n\r\n    if (allowedMimes.includes(file.mimetype)) {\r\n      cb(null, true);\r\n    } else {\r\n      cb(new Error(\"Invalid file type\"));\r\n    }\r\n  },\r\n});\r\n\r\n// Upload artwork to Cloudinary\r\nexport const handleUploadArtwork: RequestHandler = async (req, res) => {\r\n  try {\r\n    if (!req.file) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: \"No file provided\",\r\n      });\r\n    }\r\n\r\n    const { invoiceId } = req.params;\r\n\r\n    // Verify invoice exists\r\n    const { data: invoice } = await supabase\r\n      .from(\"invoices\")\r\n      .select(\"id\")\r\n      .eq(\"id\", invoiceId)\r\n      .single();\r\n\r\n    if (!invoice) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Invoice not found\",\r\n      });\r\n    }\r\n\r\n    // Upload to Cloudinary with high quality settings\r\n    const uploadPromise = new Promise((resolve, reject) => {\r\n      const uploadStream = cloudinary.v2.uploader.upload_stream(\r\n        {\r\n          folder: \"invoice-artwork\",\r\n          resource_type: \"auto\",\r\n          quality: \"auto:best\", // Maximum quality\r\n          flags: \"preserve_transparency\",\r\n          format: req.file?.mimetype === \"image/png\" ? \"png\" : \"jpg\",\r\n          fetch_format: \"auto\",\r\n          secure: true,\r\n        },\r\n        (error, result) => {\r\n          if (error) {\r\n            reject(error);\r\n          } else {\r\n            resolve(result);\r\n          }\r\n        }\r\n      );\r\n\r\n      // Stream the file buffer to Cloudinary\r\n      const bufferStream = Readable.from(Buffer.from(req.file!.buffer));\r\n      bufferStream.pipe(uploadStream);\r\n    });\r\n\r\n    const cloudinaryResult: any = await uploadPromise;\r\n\r\n    // Save artwork reference to database\r\n    const { data: artwork, error: dbError } = await supabase\r\n      .from(\"invoice_artwork\")\r\n      .insert({\r\n        invoice_id: invoiceId,\r\n        file_url: cloudinaryResult.secure_url,\r\n        file_name: req.file.originalname,\r\n        file_type: req.file.mimetype,\r\n        file_size: req.file.size,\r\n        cloudinary_public_id: cloudinaryResult.public_id,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (dbError) {\r\n      throw dbError;\r\n    }\r\n\r\n    // Log activity\r\n    await supabase.from(\"invoice_activity\").insert({\r\n      invoice_id: invoiceId,\r\n      activity_type: \"artwork_uploaded\",\r\n      description: `Artwork uploaded: ${req.file.originalname}`,\r\n    });\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: {\r\n        id: artwork.id,\r\n        file_url: artwork.file_url,\r\n        file_name: artwork.file_name,\r\n        cloudinary_public_id: artwork.cloudinary_public_id,\r\n        uploaded_at: artwork.uploaded_at,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Upload artwork error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: error instanceof Error ? error.message : \"Failed to upload artwork\",\r\n    });\r\n  }\r\n};\r\n\r\n// Get artwork for invoice\r\nexport const handleGetArtwork: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { invoiceId } = req.params;\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"invoice_artwork\")\r\n      .select(\"*\")\r\n      .eq(\"invoice_id\", invoiceId);\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: data || [],\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get artwork error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: error instanceof Error ? error.message : \"Failed to fetch artwork\",\r\n    });\r\n  }\r\n};\r\n\r\n// Delete artwork\r\nexport const handleDeleteArtwork: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { artworkId } = req.params;\r\n\r\n    // Get artwork to get Cloudinary public ID\r\n    const { data: artwork, error: fetchError } = await supabase\r\n      .from(\"invoice_artwork\")\r\n      .select(\"cloudinary_public_id, invoice_id\")\r\n      .eq(\"id\", artworkId)\r\n      .single();\r\n\r\n    if (fetchError || !artwork) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Artwork not found\",\r\n      });\r\n    }\r\n\r\n    // Delete from Cloudinary\r\n    if (artwork.cloudinary_public_id) {\r\n      try {\r\n        await cloudinary.v2.uploader.destroy(artwork.cloudinary_public_id);\r\n      } catch (cloudError) {\r\n        console.error(\"Cloudinary delete error:\", cloudError);\r\n        // Continue anyway - the DB record still needs to be deleted\r\n      }\r\n    }\r\n\r\n    // Delete from database\r\n    const { error: deleteError } = await supabase\r\n      .from(\"invoice_artwork\")\r\n      .delete()\r\n      .eq(\"id\", artworkId);\r\n\r\n    if (deleteError) {\r\n      throw deleteError;\r\n    }\r\n\r\n    // Log activity\r\n    await supabase.from(\"invoice_activity\").insert({\r\n      invoice_id: artwork.invoice_id,\r\n      activity_type: \"artwork_deleted\",\r\n      description: \"Artwork deleted\",\r\n    });\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: \"Artwork deleted successfully\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Delete artwork error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: error instanceof Error ? error.message : \"Failed to delete artwork\",\r\n    });\r\n  }\r\n};\r\n\r\nexport { upload as uploadMiddleware };\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 16507, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/debug.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL || \"\",\r\n  process.env.SUPABASE_SERVICE_KEY || \"\",\r\n);\r\n\r\n/**\n * DEBUG ENDPOINT: Get list of all orders (without PII)\n *\n * SECURITY:\n * - Requires authentication via verifyToken middleware\n * - Requires admin role via requireAdmin middleware\n * - Does NOT return PII (emails removed for security)\n * - Access is logged and audited\n *\n * USAGE:\n * - Development: Admin dashboard debugging\n * - Production: Admin troubleshooting only\n */\nexport const handleDebugOrdersList: RequestHandler = async (req, res) => {\n  try {\n    // Log access to debug endpoint\n    const adminId = (req as any).customerId;\n    console.log(\n      `[DEBUG ENDPOINT ACCESS] Admin ${adminId} accessed /api/debug/orders-list at ${new Date().toISOString()}`,\n    );\n\n    const { data: orders, error } = await supabase\n      .from(\"orders\")\n      .select(\n        `\n        id,\n        created_at,\n        status,\n        total,\n        customer_id\n      `,\n      )\n      .order(\"id\", { ascending: true });\n\n    if (error) {\n      console.error(\"Debug orders list query error:\", error);\n      return res.status(500).json({\n        success: false,\n        error: error.message,\n      });\n    }\n\n    // Return orders without PII (no email addresses)\n    const sanitizedOrders = (orders || []).map((order) => ({\n      id: order.id,\n      display_number: `SY-5${4001 + order.id}`,\n      created_at: order.created_at,\n      status: order.status,\n      total: order.total,\n      has_customer: !!order.customer_id,\n    }));\n\n    res.status(200).json({\n      success: true,\n      orders: sanitizedOrders,\n      total: orders?.length || 0,\n      _debug: {\n        endpoint: \"/api/debug/orders-list\",\n        protected_by: [\"verifyToken\", \"requireAdmin\"],\n        accessed_by_admin: adminId,\n        timestamp: new Date().toISOString(),\n      },\n    });\n  } catch (error) {\n    console.error(\"Debug orders list error:\", error);\n    res.status(500).json({\n      success: false,\n      error: error instanceof Error ? error.message : \"Internal server error\",\n      code: \"DEBUG_ENDPOINT_ERROR\",\n    });\n  }\n};\n\r\n/**\r\n * DEBUG ENDPOINT: Get system health and configuration status\r\n *\r\n * SECURITY:\r\n * - Requires authentication via verifyToken middleware\r\n * - Requires admin role via requireAdmin middleware\r\n * - Returns configuration status (safe, no secrets exposed)\r\n *\r\n * USAGE:\r\n * - Admin dashboard for troubleshooting\r\n * - Check if all services are properly configured\r\n */\r\nexport const handleDebugHealth: RequestHandler = async (req, res) => {\r\n  try {\r\n    const adminId = (req as any).customerId;\r\n    console.log(\r\n      `[DEBUG ENDPOINT ACCESS] Admin ${adminId} accessed /api/debug/health at ${new Date().toISOString()}`,\r\n    );\r\n\r\n    // Check database connectivity\r\n    const { data: dbCheck, error: dbError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"id\")\r\n      .limit(1);\r\n\r\n    const dbHealthy = !dbError && dbCheck !== null;\r\n\r\n    // Check environment configuration\r\n    const configured = {\r\n      SUPABASE_URL: !!process.env.SUPABASE_URL,\r\n      SUPABASE_SERVICE_KEY: !!process.env.SUPABASE_SERVICE_KEY,\r\n      JWT_SECRET: !!process.env.JWT_SECRET,\r\n      CLOUDINARY_CLOUD_NAME: !!process.env.CLOUDINARY_CLOUD_NAME,\r\n      SQUARE_APPLICATION_ID: !!process.env.SQUARE_APPLICATION_ID,\r\n      SQUARE_ACCESS_TOKEN: !!process.env.SQUARE_ACCESS_TOKEN,\r\n      RESEND_API_KEY: !!process.env.RESEND_API_KEY,\r\n      ECWID_API_TOKEN: !!process.env.ECWID_API_TOKEN,\r\n    };\r\n\r\n    const allConfigured = Object.values(configured).every((v) => v === true);\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      status: allConfigured && dbHealthy ? \"healthy\" : \"degraded\",\r\n      database: {\r\n        connected: dbHealthy,\r\n        error: dbError?.message || null,\r\n      },\r\n      configuration: configured,\r\n      node_env: process.env.NODE_ENV || \"not set\",\r\n      timestamp: new Date().toISOString(),\r\n      _debug: {\r\n        endpoint: \"/api/debug/health\",\r\n        protected_by: [\"verifyToken\", \"requireAdmin\"],\r\n        accessed_by_admin: adminId,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Debug health check error:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: error instanceof Error ? error.message : \"Internal server error\",\r\n      code: \"DEBUG_HEALTH_ERROR\",\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 16625, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/utils/ecwid-api.ts"],"sourcesContent":["const ECWID_API_BASE = \"https://api.ecwid.com/api/v3\";\r\nconst ECWID_STORE_ID = process.env.ECWID_STORE_ID || \"120154275\";\r\nconst ECWID_API_TOKEN = process.env.ECWID_API_TOKEN || \"\";\r\n\r\nexport interface EcwidProduct {\r\n  id: number;\r\n  sku: string;\r\n  name: string;\r\n  price: number;\r\n  description: string;\r\n  options: EcwidOption[];\r\n  images: EcwidImage[];\r\n  defaultImage?: EcwidImage;\r\n}\r\n\r\nexport interface EcwidOption {\r\n  name: string;\r\n  type: string;\r\n  required: boolean;\r\n  choices?: EcwidChoice[];\r\n}\r\n\r\nexport interface EcwidChoice {\r\n  text: string;\r\n  priceModifier?: number;\r\n}\r\n\r\nexport interface EcwidImage {\r\n  id: number;\r\n  url: string;\r\n  alt?: string;\r\n  width?: number;\r\n  height?: number;\r\n}\r\n\r\nexport async function fetchEcwidProduct(\r\n  productId: number,\r\n): Promise<EcwidProduct | null> {\r\n  try {\r\n    const response = await fetch(\r\n      `${ECWID_API_BASE}/${ECWID_STORE_ID}/products/${productId}?token=${ECWID_API_TOKEN}`,\r\n      {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      },\r\n    );\r\n\r\n    if (!response.ok) {\r\n      console.error(\r\n        `Failed to fetch product ${productId}:`,\r\n        response.statusText,\r\n      );\r\n      return null;\r\n    }\r\n\r\n    const data = await response.json();\r\n    return transformEcwidProduct(data);\r\n  } catch (error) {\r\n    console.error(`Error fetching Ecwid product ${productId}:`, error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function searchEcwidProducts(\r\n  query: string,\r\n  limit: number = 20,\r\n): Promise<EcwidProduct[]> {\r\n  try {\r\n    const response = await fetch(\r\n      `${ECWID_API_BASE}/${ECWID_STORE_ID}/products?keyword=${encodeURIComponent(query)}&limit=${limit}&token=${ECWID_API_TOKEN}`,\r\n      {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      },\r\n    );\r\n\r\n    if (!response.ok) {\r\n      console.error(\"Failed to search Ecwid products:\", response.statusText);\r\n      return [];\r\n    }\r\n\r\n    const data = await response.json();\r\n    return (data.items || []).map(transformEcwidProduct);\r\n  } catch (error) {\r\n    console.error(\"Error searching Ecwid products:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport async function fetchEcwidProducts(\r\n  limit: number = 20,\r\n  offset: number = 0,\r\n): Promise<EcwidProduct[]> {\r\n  try {\r\n    const response = await fetch(\r\n      `${ECWID_API_BASE}/${ECWID_STORE_ID}/products?limit=${limit}&offset=${offset}&token=${ECWID_API_TOKEN}`,\r\n      {\r\n        method: \"GET\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n      },\r\n    );\r\n\r\n    if (!response.ok) {\r\n      console.error(\"Failed to fetch Ecwid products:\", response.statusText);\r\n      return [];\r\n    }\r\n\r\n    const data = await response.json();\r\n    return (data.items || []).map(transformEcwidProduct);\r\n  } catch (error) {\r\n    console.error(\"Error fetching Ecwid products:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport interface EcwidCustomer {\r\n  id: number;\r\n  email: string;\r\n  billingPerson: {\r\n    name: string;\r\n    firstName?: string;\r\n    lastName?: string;\r\n    phone?: string;\r\n  };\r\n  createdDate: string;\r\n}\r\n\r\nexport interface EcwidOrder {\r\n  number: string;\r\n  id: number;\r\n  email: string;\r\n  total: number;\r\n  subtotal: number;\r\n  tax: number;\r\n  shipping: number;\r\n  status: string;\r\n  fulfillmentStatus: string;\r\n  trackingNumber?: string;\r\n  createdDate: string;\r\n  updatedDate: string;\r\n  customerEmail: string;\r\n}\r\n\r\nexport async function fetchAllEcwidCustomers(): Promise<EcwidCustomer[]> {\r\n  try {\r\n    const customers: EcwidCustomer[] = [];\r\n    let offset = 0;\r\n    const limit = 100;\r\n    let hasMore = true;\r\n\r\n    while (hasMore) {\r\n      const response = await fetch(\r\n        `${ECWID_API_BASE}/${ECWID_STORE_ID}/customers?limit=${limit}&offset=${offset}&token=${ECWID_API_TOKEN}`,\r\n        {\r\n          method: \"GET\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n          },\r\n        },\r\n      );\r\n\r\n      if (!response.ok) {\r\n        console.error(\r\n          \"Failed to fetch Ecwid customers:\",\r\n          response.statusText,\r\n        );\r\n        break;\r\n      }\r\n\r\n      const data = await response.json();\r\n      const items = data.items || [];\r\n\r\n      if (items.length === 0) {\r\n        hasMore = false;\r\n      } else {\r\n        customers.push(...items);\r\n        offset += limit;\r\n      }\r\n    }\r\n\r\n    return customers;\r\n  } catch (error) {\r\n    console.error(\"Error fetching Ecwid customers:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\nexport async function fetchAllEcwidOrders(): Promise<EcwidOrder[]> {\r\n  try {\r\n    const orders: EcwidOrder[] = [];\r\n    let offset = 0;\r\n    const limit = 100;\r\n    let hasMore = true;\r\n\r\n    while (hasMore) {\r\n      const response = await fetch(\r\n        `${ECWID_API_BASE}/${ECWID_STORE_ID}/orders?limit=${limit}&offset=${offset}&token=${ECWID_API_TOKEN}`,\r\n        {\r\n          method: \"GET\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n          },\r\n        },\r\n      );\r\n\r\n      if (!response.ok) {\r\n        console.error(\"Failed to fetch Ecwid orders:\", response.statusText);\r\n        break;\r\n      }\r\n\r\n      const data = await response.json();\r\n      const items = data.items || [];\r\n\r\n      if (items.length === 0) {\r\n        hasMore = false;\r\n      } else {\r\n        orders.push(...items);\r\n        offset += limit;\r\n      }\r\n    }\r\n\r\n    return orders;\r\n  } catch (error) {\r\n    console.error(\"Error fetching Ecwid orders:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\nfunction transformEcwidProduct(data: any): EcwidProduct {\r\n  const product: EcwidProduct = {\r\n    id: data.id,\r\n    sku: data.sku || \"\",\r\n    name: data.name || \"\",\r\n    price: data.price || 0,\r\n    description: data.description || \"\",\r\n    options: (data.options || []).map((opt: any) => ({\r\n      name: opt.name,\r\n      type: opt.type,\r\n      required: opt.required || false,\r\n      choices: (opt.choices || []).map((choice: any) => ({\r\n        text: choice.text,\r\n        priceModifier: choice.priceModifier || 0,\r\n      })),\r\n    })),\r\n    images: (data.images || []).map((img: any) => ({\r\n      id: img.id,\r\n      url: img.url,\r\n      alt: img.alt,\r\n      width: img.width,\r\n      height: img.height,\r\n    })),\r\n  };\r\n\r\n  if (product.images.length > 0) {\r\n    product.defaultImage = product.images[0];\r\n  }\r\n\r\n  return product;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 16796, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/ecwid-migration.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { supabase } from \"../utils/supabase\";\r\nimport {\r\n  fetchAllEcwidCustomers,\r\n  fetchAllEcwidOrders,\r\n} from \"../utils/ecwid-api\";\r\n\r\ninterface MigrationResult {\r\n  customersImported: number;\r\n  customersSkipped: number;\r\n  ordersImported: number;\r\n  ordersSkipped: number;\r\n  errors: string[];\r\n}\r\n\r\n/**\r\n * Migrate all customers and orders from Ecwid to Supabase\r\n * This is an admin-only endpoint that should be called once to import historical data\r\n */\r\nexport const handleEcwidMigration: RequestHandler = async (req, res) => {\r\n  try {\r\n    const result: MigrationResult = {\r\n      customersImported: 0,\r\n      customersSkipped: 0,\r\n      ordersImported: 0,\r\n      ordersSkipped: 0,\r\n      errors: [],\r\n    };\r\n\r\n    console.log(\"Starting Ecwid migration...\");\r\n\r\n    // Fetch all customers from Ecwid\r\n    console.log(\"Fetching customers from Ecwid...\");\r\n    const ecwidCustomers = await fetchAllEcwidCustomers();\r\n    console.log(`Found ${ecwidCustomers.length} customers in Ecwid`);\r\n\r\n    // Import customers\r\n    for (const ecwidCustomer of ecwidCustomers) {\r\n      try {\r\n        if (!ecwidCustomer.email) {\r\n          result.customersSkipped++;\r\n          continue;\r\n        }\r\n\r\n        const fullName =\r\n          ecwidCustomer.billingPerson?.name ||\r\n          `${ecwidCustomer.billingPerson?.firstName || \"\"} ${ecwidCustomer.billingPerson?.lastName || \"\"}`.trim();\r\n\r\n        // Check if customer already exists\r\n        const { data: existingCustomer } = await supabase\r\n          .from(\"customers\")\r\n          .select(\"id\")\r\n          .eq(\"email\", ecwidCustomer.email)\r\n          .single();\r\n\r\n        if (existingCustomer) {\r\n          result.customersSkipped++;\r\n          continue;\r\n        }\r\n\r\n        // Insert new customer\r\n        const { error: insertError } = await supabase.from(\"customers\").insert(\r\n          {\r\n            email: ecwidCustomer.email,\r\n            first_name: ecwidCustomer.billingPerson?.firstName || \"\",\r\n            last_name: ecwidCustomer.billingPerson?.lastName || \"\",\r\n            phone: ecwidCustomer.billingPerson?.phone,\r\n            created_at: ecwidCustomer.createdDate,\r\n            updated_at: new Date().toISOString(),\r\n            ecwid_customer_id: ecwidCustomer.id,\r\n          },\r\n        );\r\n\r\n        if (insertError) {\r\n          result.errors.push(\r\n            `Failed to import customer ${ecwidCustomer.email}: ${insertError.message}`,\r\n          );\r\n          result.customersSkipped++;\r\n        } else {\r\n          result.customersImported++;\r\n        }\r\n      } catch (error) {\r\n        const message =\r\n          error instanceof Error ? error.message : \"Unknown error\";\r\n        result.errors.push(`Error processing customer: ${message}`);\r\n        result.customersSkipped++;\r\n      }\r\n    }\r\n\r\n    console.log(\r\n      `Imported ${result.customersImported} customers, skipped ${result.customersSkipped}`,\r\n    );\r\n\r\n    // Fetch all orders from Ecwid\r\n    console.log(\"Fetching orders from Ecwid...\");\r\n    const ecwidOrders = await fetchAllEcwidOrders();\r\n    console.log(`Found ${ecwidOrders.length} orders in Ecwid`);\r\n\r\n    // Import orders\r\n    for (const ecwidOrder of ecwidOrders) {\r\n      try {\r\n        if (!ecwidOrder.customerEmail) {\r\n          result.ordersSkipped++;\r\n          continue;\r\n        }\r\n\r\n        // Find customer by email\r\n        const { data: customer, error: customerError } = await supabase\r\n          .from(\"customers\")\r\n          .select(\"id\")\r\n          .eq(\"email\", ecwidOrder.customerEmail)\r\n          .single();\r\n\r\n        if (customerError || !customer) {\r\n          result.errors.push(\r\n            `No customer found for order ${ecwidOrder.number} (email: ${ecwidOrder.customerEmail})`,\r\n          );\r\n          result.ordersSkipped++;\r\n          continue;\r\n        }\r\n\r\n        // Check if order already exists\r\n        const { data: existingOrder } = await supabase\r\n          .from(\"orders\")\r\n          .select(\"id\")\r\n          .eq(\"ecwid_order_number\", ecwidOrder.number)\r\n          .single();\r\n\r\n        if (existingOrder) {\r\n          result.ordersSkipped++;\r\n          continue;\r\n        }\r\n\r\n        // Insert new order\r\n        const { error: insertError } = await supabase.from(\"orders\").insert({\r\n          customer_id: customer.id,\r\n          ecwid_order_id: ecwidOrder.id,\r\n          ecwid_order_number: ecwidOrder.number,\r\n          status: ecwidOrder.fulfillmentStatus.toLowerCase() || \"pending\",\r\n          total: parseFloat(ecwidOrder.total.toString()),\r\n          subtotal: parseFloat(ecwidOrder.subtotal.toString()),\r\n          tax: parseFloat(ecwidOrder.tax.toString()),\r\n          shipping: parseFloat(ecwidOrder.shipping.toString()),\r\n          tracking_number: ecwidOrder.trackingNumber,\r\n          created_at: ecwidOrder.createdDate,\r\n          updated_at: ecwidOrder.updatedDate,\r\n        });\r\n\r\n        if (insertError) {\r\n          result.errors.push(\r\n            `Failed to import order ${ecwidOrder.number}: ${insertError.message}`,\r\n          );\r\n          result.ordersSkipped++;\r\n        } else {\r\n          result.ordersImported++;\r\n        }\r\n      } catch (error) {\r\n        const message =\r\n          error instanceof Error ? error.message : \"Unknown error\";\r\n        result.errors.push(`Error processing order: ${message}`);\r\n        result.ordersSkipped++;\r\n      }\r\n    }\r\n\r\n    console.log(\r\n      `Imported ${result.ordersImported} orders, skipped ${result.ordersSkipped}`,\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"Ecwid migration completed\",\r\n      result,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Ecwid migration error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Migration failed\";\r\n    res.status(500).json({\r\n      success: false,\r\n      error: message,\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Get migration status - returns count of customers and orders from both Ecwid and Supabase\r\n */\r\nexport const handleGetMigrationStatus: RequestHandler = async (req, res) => {\r\n  try {\r\n    // Fetch customer count from Supabase\r\n    const { count: supabaseCustomerCount, error: customerError } =\r\n      await supabase\r\n        .from(\"customers\")\r\n        .select(\"*\", { count: \"exact\", head: true });\r\n\r\n    // Fetch order count from Supabase\r\n    const { count: supabaseOrderCount, error: orderError } = await supabase\r\n      .from(\"orders\")\r\n      .select(\"*\", { count: \"exact\", head: true });\r\n\r\n    // Fetch counts from Ecwid\r\n    const ecwidCustomers = await fetchAllEcwidCustomers();\r\n    const ecwidOrders = await fetchAllEcwidOrders();\r\n\r\n    if (customerError || orderError) {\r\n      throw new Error(\"Failed to fetch migration status\");\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      ecwid: {\r\n        customers: ecwidCustomers.length,\r\n        orders: ecwidOrders.length,\r\n      },\r\n      supabase: {\r\n        customers: supabaseCustomerCount || 0,\r\n        orders: supabaseOrderCount || 0,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Get migration status error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to get status\";\r\n    res.status(500).json({\r\n      success: false,\r\n      error: message,\r\n    });\r\n  }\r\n};\r\n\r\ninterface CSVCustomer {\r\n  email: string;\r\n  firstName?: string;\r\n  lastName?: string;\r\n  phone?: string;\r\n  company?: string;\r\n}\r\n\r\n/**\r\n * Import customers from CSV file\r\n * Expected columns: email, firstName, lastName, phone, company\r\n */\r\nexport const handleCSVCustomerImport: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { csvData } = req.body;\r\n\r\n    if (!csvData || typeof csvData !== \"string\") {\r\n      return res.status(400).json({ error: \"CSV data is required\" });\r\n    }\r\n\r\n    const result: MigrationResult = {\r\n      customersImported: 0,\r\n      customersSkipped: 0,\r\n      ordersImported: 0,\r\n      ordersSkipped: 0,\r\n      errors: [],\r\n    };\r\n\r\n    // Parse CSV\r\n    const lines = csvData.trim().split(\"\\n\");\r\n    if (lines.length < 2) {\r\n      return res\r\n        .status(400)\r\n        .json({ error: \"CSV must have header row and at least one data row\" });\r\n    }\r\n\r\n    // Parse header - split first, then lowercase for matching\r\n    const headerLine = lines[0].trim();\r\n    const headers = headerLine.split(\",\").map((h) => h.trim().toLowerCase());\r\n\r\n    // Find email column - support both \"email\" and Ecwid's \"customer_primary_email\"\r\n    let emailIndex = headers.indexOf(\"email\");\r\n    if (emailIndex === -1) {\r\n      emailIndex = headers.indexOf(\"customer_primary_email\");\r\n    }\r\n\r\n    if (emailIndex === -1) {\r\n      return res\r\n        .status(400)\r\n        .json({\r\n          error: \"CSV must have an 'email' or 'customer_primary_email' column. Found columns: \" + headerLine\r\n        });\r\n    }\r\n\r\n    // Find name columns - support various formats\r\n    let firstNameIndex = headers.indexOf(\"firstname\");\r\n    let lastNameIndex = headers.indexOf(\"lastname\");\r\n    let fullNameIndex = headers.indexOf(\"customer_full_name\");\r\n\r\n    if (firstNameIndex === -1) {\r\n      firstNameIndex = headers.indexOf(\"first_name\");\r\n    }\r\n    if (lastNameIndex === -1) {\r\n      lastNameIndex = headers.indexOf(\"last_name\");\r\n    }\r\n\r\n    // Find phone column\r\n    let phoneIndex = headers.indexOf(\"phone\");\r\n    if (phoneIndex === -1) {\r\n      phoneIndex = headers.indexOf(\"customer_primary_phone_number\");\r\n    }\r\n    if (phoneIndex === -1) {\r\n      phoneIndex = headers.indexOf(\"phone_number\");\r\n    }\r\n\r\n    // Find company column\r\n    let companyIndex = headers.indexOf(\"company\");\r\n    if (companyIndex === -1) {\r\n      companyIndex = headers.indexOf(\"customer_group_name\");\r\n    }\r\n\r\n    // Parse data rows\r\n    const customers: CSVCustomer[] = [];\r\n    for (let i = 1; i < lines.length; i++) {\r\n      const line = lines[i].trim();\r\n      if (!line) continue;\r\n\r\n      const values = line.split(\",\").map((v) => v.trim());\r\n\r\n      const email = values[emailIndex];\r\n      if (!email) {\r\n        result.errors.push(`Row ${i + 1}: Missing email`);\r\n        result.customersSkipped++;\r\n        continue;\r\n      }\r\n\r\n      // Handle name - either separate first/last or combined full name\r\n      let firstName = firstNameIndex >= 0 ? values[firstNameIndex] : undefined;\r\n      let lastName = lastNameIndex >= 0 ? values[lastNameIndex] : undefined;\r\n\r\n      // If we have full name but no first/last, parse it\r\n      if (fullNameIndex >= 0 && !firstName && !lastName) {\r\n        const fullName = values[fullNameIndex] || \"\";\r\n        const nameParts = fullName.trim().split(/\\s+/);\r\n        if (nameParts.length > 0) {\r\n          firstName = nameParts[0];\r\n          if (nameParts.length > 1) {\r\n            lastName = nameParts.slice(1).join(\" \");\r\n          }\r\n        }\r\n      }\r\n\r\n      customers.push({\r\n        email,\r\n        firstName: firstName || undefined,\r\n        lastName: lastName || undefined,\r\n        phone: phoneIndex >= 0 ? values[phoneIndex] : undefined,\r\n        company: companyIndex >= 0 ? values[companyIndex] : undefined,\r\n      });\r\n    }\r\n\r\n    // Import customers\r\n    for (const customer of customers) {\r\n      try {\r\n        // Check if customer already exists\r\n        const { data: existingCustomer } = await supabase\r\n          .from(\"customers\")\r\n          .select(\"id\")\r\n          .eq(\"email\", customer.email)\r\n          .single();\r\n\r\n        if (existingCustomer) {\r\n          result.customersSkipped++;\r\n          continue;\r\n        }\r\n\r\n        // Insert new customer\r\n        const { error: insertError } = await supabase\r\n          .from(\"customers\")\r\n          .insert({\r\n            email: customer.email,\r\n            first_name: customer.firstName || \"\",\r\n            last_name: customer.lastName || \"\",\r\n            phone: customer.phone,\r\n            company: customer.company,\r\n            created_at: new Date().toISOString(),\r\n            updated_at: new Date().toISOString(),\r\n          });\r\n\r\n        if (insertError) {\r\n          result.errors.push(\r\n            `Failed to import customer ${customer.email}: ${insertError.message}`,\r\n          );\r\n          result.customersSkipped++;\r\n        } else {\r\n          result.customersImported++;\r\n        }\r\n      } catch (error) {\r\n        const message =\r\n          error instanceof Error ? error.message : \"Unknown error\";\r\n        result.errors.push(`Error processing customer ${customer.email}: ${message}`);\r\n        result.customersSkipped++;\r\n      }\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      message: \"CSV import completed\",\r\n      result,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"CSV import error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"CSV import failed\";\r\n    res.status(500).json({\r\n      success: false,\r\n      error: message,\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;;;;;AACA;AACA;;;;;;;AAiBO,MAAM,uBAAuC,OAAO,KAAK;IAC9D,IAAI;QACF,MAAM,SAA0B;YAC9B,mBAAmB;YACnB,kBAAkB;YAClB,gBAAgB;YAChB,eAAe;YACf,QAAQ,EAAE;QACZ;QAEA,QAAQ,GAAG,CAAC;QAEZ,iCAAiC;QACjC,QAAQ,GAAG,CAAC;QACZ,MAAM,iBAAiB,MAAM,IAAA,kJAAsB;QACnD,QAAQ,GAAG,CAAC,CAAC,MAAM,EAAE,eAAe,MAAM,CAAC,mBAAmB,CAAC;QAE/D,mBAAmB;QACnB,KAAK,MAAM,iBAAiB,eAAgB;YAC1C,IAAI;gBACF,IAAI,CAAC,cAAc,KAAK,EAAE;oBACxB,OAAO,gBAAgB;oBACvB;gBACF;gBAEA,MAAM,WACJ,cAAc,aAAa,EAAE,QAC7B,GAAG,cAAc,aAAa,EAAE,aAAa,GAAG,CAAC,EAAE,cAAc,aAAa,EAAE,YAAY,IAAI,CAAC,IAAI;gBAEvG,mCAAmC;gBACnC,MAAM,EAAE,MAAM,gBAAgB,EAAE,GAAG,MAAM,gIAAQ,CAC9C,IAAI,CAAC,aACL,MAAM,CAAC,MACP,EAAE,CAAC,SAAS,cAAc,KAAK,EAC/B,MAAM;gBAET,IAAI,kBAAkB;oBACpB,OAAO,gBAAgB;oBACvB;gBACF;gBAEA,sBAAsB;gBACtB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,gIAAQ,CAAC,IAAI,CAAC,aAAa,MAAM,CACpE;oBACE,OAAO,cAAc,KAAK;oBAC1B,YAAY,cAAc,aAAa,EAAE,aAAa;oBACtD,WAAW,cAAc,aAAa,EAAE,YAAY;oBACpD,OAAO,cAAc,aAAa,EAAE;oBACpC,YAAY,cAAc,WAAW;oBACrC,YAAY,IAAI,OAAO,WAAW;oBAClC,mBAAmB,cAAc,EAAE;gBACrC;gBAGF,IAAI,aAAa;oBACf,OAAO,MAAM,CAAC,IAAI,CAChB,CAAC,0BAA0B,EAAE,cAAc,KAAK,CAAC,EAAE,EAAE,YAAY,OAAO,EAAE;oBAE5E,OAAO,gBAAgB;gBACzB,OAAO;oBACL,OAAO,iBAAiB;gBAC1B;YACF,EAAE,OAAO,OAAO;gBACd,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;gBAC3C,OAAO,MAAM,CAAC,IAAI,CAAC,CAAC,2BAA2B,EAAE,SAAS;gBAC1D,OAAO,gBAAgB;YACzB;QACF;QAEA,QAAQ,GAAG,CACT,CAAC,SAAS,EAAE,OAAO,iBAAiB,CAAC,oBAAoB,EAAE,OAAO,gBAAgB,EAAE;QAGtF,8BAA8B;QAC9B,QAAQ,GAAG,CAAC;QACZ,MAAM,cAAc,MAAM,IAAA,+IAAmB;QAC7C,QAAQ,GAAG,CAAC,CAAC,MAAM,EAAE,YAAY,MAAM,CAAC,gBAAgB,CAAC;QAEzD,gBAAgB;QAChB,KAAK,MAAM,cAAc,YAAa;YACpC,IAAI;gBACF,IAAI,CAAC,WAAW,aAAa,EAAE;oBAC7B,OAAO,aAAa;oBACpB;gBACF;gBAEA,yBAAyB;gBACzB,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,aAAa,EAAE,GAAG,MAAM,gIAAQ,CAC5D,IAAI,CAAC,aACL,MAAM,CAAC,MACP,EAAE,CAAC,SAAS,WAAW,aAAa,EACpC,MAAM;gBAET,IAAI,iBAAiB,CAAC,UAAU;oBAC9B,OAAO,MAAM,CAAC,IAAI,CAChB,CAAC,4BAA4B,EAAE,WAAW,MAAM,CAAC,SAAS,EAAE,WAAW,aAAa,CAAC,CAAC,CAAC;oBAEzF,OAAO,aAAa;oBACpB;gBACF;gBAEA,gCAAgC;gBAChC,MAAM,EAAE,MAAM,aAAa,EAAE,GAAG,MAAM,gIAAQ,CAC3C,IAAI,CAAC,UACL,MAAM,CAAC,MACP,EAAE,CAAC,sBAAsB,WAAW,MAAM,EAC1C,MAAM;gBAET,IAAI,eAAe;oBACjB,OAAO,aAAa;oBACpB;gBACF;gBAEA,mBAAmB;gBACnB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,gIAAQ,CAAC,IAAI,CAAC,UAAU,MAAM,CAAC;oBAClE,aAAa,SAAS,EAAE;oBACxB,gBAAgB,WAAW,EAAE;oBAC7B,oBAAoB,WAAW,MAAM;oBACrC,QAAQ,WAAW,iBAAiB,CAAC,WAAW,MAAM;oBACtD,OAAO,WAAW,WAAW,KAAK,CAAC,QAAQ;oBAC3C,UAAU,WAAW,WAAW,QAAQ,CAAC,QAAQ;oBACjD,KAAK,WAAW,WAAW,GAAG,CAAC,QAAQ;oBACvC,UAAU,WAAW,WAAW,QAAQ,CAAC,QAAQ;oBACjD,iBAAiB,WAAW,cAAc;oBAC1C,YAAY,WAAW,WAAW;oBAClC,YAAY,WAAW,WAAW;gBACpC;gBAEA,IAAI,aAAa;oBACf,OAAO,MAAM,CAAC,IAAI,CAChB,CAAC,uBAAuB,EAAE,WAAW,MAAM,CAAC,EAAE,EAAE,YAAY,OAAO,EAAE;oBAEvE,OAAO,aAAa;gBACtB,OAAO;oBACL,OAAO,cAAc;gBACvB;YACF,EAAE,OAAO,OAAO;gBACd,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;gBAC3C,OAAO,MAAM,CAAC,IAAI,CAAC,CAAC,wBAAwB,EAAE,SAAS;gBACvD,OAAO,aAAa;YACtB;QACF;QAEA,QAAQ,GAAG,CACT,CAAC,SAAS,EAAE,OAAO,cAAc,CAAC,iBAAiB,EAAE,OAAO,aAAa,EAAE;QAG7E,IAAI,IAAI,CAAC;YACP,SAAS;YACT,SAAS;YACT;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0BAA0B;QACxC,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,OAAO;QACT;IACF;AACF;AAKO,MAAM,2BAA2C,OAAO,KAAK;IAClE,IAAI;QACF,qCAAqC;QACrC,MAAM,EAAE,OAAO,qBAAqB,EAAE,OAAO,aAAa,EAAE,GAC1D,MAAM,gIAAQ,CACX,IAAI,CAAC,aACL,MAAM,CAAC,KAAK;YAAE,OAAO;YAAS,MAAM;QAAK;QAE9C,kCAAkC;QAClC,MAAM,EAAE,OAAO,kBAAkB,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,gIAAQ,CACpE,IAAI,CAAC,UACL,MAAM,CAAC,KAAK;YAAE,OAAO;YAAS,MAAM;QAAK;QAE5C,0BAA0B;QAC1B,MAAM,iBAAiB,MAAM,IAAA,kJAAsB;QACnD,MAAM,cAAc,MAAM,IAAA,+IAAmB;QAE7C,IAAI,iBAAiB,YAAY;YAC/B,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,OAAO;gBACL,WAAW,eAAe,MAAM;gBAChC,QAAQ,YAAY,MAAM;YAC5B;YACA,UAAU;gBACR,WAAW,yBAAyB;gBACpC,QAAQ,sBAAsB;YAChC;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,OAAO;QACT;IACF;AACF;AAcO,MAAM,0BAA0C,OAAO,KAAK;IACjE,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,IAAI;QAE5B,IAAI,CAAC,WAAW,OAAO,YAAY,UAAU;YAC3C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAuB;QAC9D;QAEA,MAAM,SAA0B;YAC9B,mBAAmB;YACnB,kBAAkB;YAClB,gBAAgB;YAChB,eAAe;YACf,QAAQ,EAAE;QACZ;QAEA,YAAY;QACZ,MAAM,QAAQ,QAAQ,IAAI,GAAG,KAAK,CAAC;QACnC,IAAI,MAAM,MAAM,GAAG,GAAG;YACpB,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBAAE,OAAO;YAAqD;QACxE;QAEA,0DAA0D;QAC1D,MAAM,aAAa,KAAK,CAAC,EAAE,CAAC,IAAI;QAChC,MAAM,UAAU,WAAW,KAAK,CAAC,KAAK,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI,GAAG,WAAW;QAErE,gFAAgF;QAChF,IAAI,aAAa,QAAQ,OAAO,CAAC;QACjC,IAAI,eAAe,CAAC,GAAG;YACrB,aAAa,QAAQ,OAAO,CAAC;QAC/B;QAEA,IAAI,eAAe,CAAC,GAAG;YACrB,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBACJ,OAAO,iFAAiF;YAC1F;QACJ;QAEA,8CAA8C;QAC9C,IAAI,iBAAiB,QAAQ,OAAO,CAAC;QACrC,IAAI,gBAAgB,QAAQ,OAAO,CAAC;QACpC,IAAI,gBAAgB,QAAQ,OAAO,CAAC;QAEpC,IAAI,mBAAmB,CAAC,GAAG;YACzB,iBAAiB,QAAQ,OAAO,CAAC;QACnC;QACA,IAAI,kBAAkB,CAAC,GAAG;YACxB,gBAAgB,QAAQ,OAAO,CAAC;QAClC;QAEA,oBAAoB;QACpB,IAAI,aAAa,QAAQ,OAAO,CAAC;QACjC,IAAI,eAAe,CAAC,GAAG;YACrB,aAAa,QAAQ,OAAO,CAAC;QAC/B;QACA,IAAI,eAAe,CAAC,GAAG;YACrB,aAAa,QAAQ,OAAO,CAAC;QAC/B;QAEA,sBAAsB;QACtB,IAAI,eAAe,QAAQ,OAAO,CAAC;QACnC,IAAI,iBAAiB,CAAC,GAAG;YACvB,eAAe,QAAQ,OAAO,CAAC;QACjC;QAEA,kBAAkB;QAClB,MAAM,YAA2B,EAAE;QACnC,IAAK,IAAI,IAAI,GAAG,IAAI,MAAM,MAAM,EAAE,IAAK;YACrC,MAAM,OAAO,KAAK,CAAC,EAAE,CAAC,IAAI;YAC1B,IAAI,CAAC,MAAM;YAEX,MAAM,SAAS,KAAK,KAAK,CAAC,KAAK,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI;YAEhD,MAAM,QAAQ,MAAM,CAAC,WAAW;YAChC,IAAI,CAAC,OAAO;gBACV,OAAO,MAAM,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,IAAI,EAAE,eAAe,CAAC;gBAChD,OAAO,gBAAgB;gBACvB;YACF;YAEA,iEAAiE;YACjE,IAAI,YAAY,kBAAkB,IAAI,MAAM,CAAC,eAAe,GAAG;YAC/D,IAAI,WAAW,iBAAiB,IAAI,MAAM,CAAC,cAAc,GAAG;YAE5D,mDAAmD;YACnD,IAAI,iBAAiB,KAAK,CAAC,aAAa,CAAC,UAAU;gBACjD,MAAM,WAAW,MAAM,CAAC,cAAc,IAAI;gBAC1C,MAAM,YAAY,SAAS,IAAI,GAAG,KAAK,CAAC;gBACxC,IAAI,UAAU,MAAM,GAAG,GAAG;oBACxB,YAAY,SAAS,CAAC,EAAE;oBACxB,IAAI,UAAU,MAAM,GAAG,GAAG;wBACxB,WAAW,UAAU,KAAK,CAAC,GAAG,IAAI,CAAC;oBACrC;gBACF;YACF;YAEA,UAAU,IAAI,CAAC;gBACb;gBACA,WAAW,aAAa;gBACxB,UAAU,YAAY;gBACtB,OAAO,cAAc,IAAI,MAAM,CAAC,WAAW,GAAG;gBAC9C,SAAS,gBAAgB,IAAI,MAAM,CAAC,aAAa,GAAG;YACtD;QACF;QAEA,mBAAmB;QACnB,KAAK,MAAM,YAAY,UAAW;YAChC,IAAI;gBACF,mCAAmC;gBACnC,MAAM,EAAE,MAAM,gBAAgB,EAAE,GAAG,MAAM,gIAAQ,CAC9C,IAAI,CAAC,aACL,MAAM,CAAC,MACP,EAAE,CAAC,SAAS,SAAS,KAAK,EAC1B,MAAM;gBAET,IAAI,kBAAkB;oBACpB,OAAO,gBAAgB;oBACvB;gBACF;gBAEA,sBAAsB;gBACtB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,gIAAQ,CAC1C,IAAI,CAAC,aACL,MAAM,CAAC;oBACN,OAAO,SAAS,KAAK;oBACrB,YAAY,SAAS,SAAS,IAAI;oBAClC,WAAW,SAAS,QAAQ,IAAI;oBAChC,OAAO,SAAS,KAAK;oBACrB,SAAS,SAAS,OAAO;oBACzB,YAAY,IAAI,OAAO,WAAW;oBAClC,YAAY,IAAI,OAAO,WAAW;gBACpC;gBAEF,IAAI,aAAa;oBACf,OAAO,MAAM,CAAC,IAAI,CAChB,CAAC,0BAA0B,EAAE,SAAS,KAAK,CAAC,EAAE,EAAE,YAAY,OAAO,EAAE;oBAEvE,OAAO,gBAAgB;gBACzB,OAAO;oBACL,OAAO,iBAAiB;gBAC1B;YACF,EAAE,OAAO,OAAO;gBACd,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;gBAC3C,OAAO,MAAM,CAAC,IAAI,CAAC,CAAC,0BAA0B,EAAE,SAAS,KAAK,CAAC,EAAE,EAAE,SAAS;gBAC5E,OAAO,gBAAgB;YACzB;QACF;QAEA,IAAI,IAAI,CAAC;YACP,SAAS;YACT,SAAS;YACT;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,MAAM,UACJ,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC3C,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,SAAS;YACT,OAAO;QACT;IACF;AACF"}},
    {"offset": {"line": 17110, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/reviews.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { v2 as cloudinary } from \"cloudinary\";\r\nimport { processImage } from \"../utils/image-processor\";\r\n\r\nconst supabaseUrl = process.env.SUPABASE_URL || \"\";\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_KEY || \"\";\r\n\r\n/**\r\n * SECURITY: Service Role Key is required for this route\r\n *\r\n * Justification:\r\n * - Review management requires unrestricted access for moderation\r\n * - RLS policies would need to allow guests to write but only specific fields\r\n * - Admin needs ability to approve/reject reviews without customer-specific restrictions\r\n * - Alternative: Complex RLS policies with guest tokens would be harder to manage\r\n *\r\n * Mitigation:\r\n * - Review submissions have rate limiting applied in middleware\r\n * - Spam protection and validation on all fields (email, rating, content)\r\n * - All reviews require admin approval before display (hidden by default)\r\n * - No customer data is accessed (only user-submitted reviews)\r\n *\r\n * See: docs/RLS_SCOPING.md for security architecture\r\n */\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\ncloudinary.config({\r\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\r\n  api_key: process.env.CLOUDINARY_API_KEY,\r\n  api_secret: process.env.CLOUDINARY_API_SECRET,\r\n});\r\n\r\ninterface ReviewData {\r\n  product_id: string;\r\n  reviewer_name: string;\r\n  reviewer_email: string;\r\n  rating: number;\r\n  title?: string;\r\n  comment?: string;\r\n  image_base64?: string[];\r\n}\r\n\r\n/**\r\n * Submit a new product review with optional images\r\n * Allows guest submissions\r\n */\r\nexport const handleSubmitReview: RequestHandler = async (req, res) => {\r\n  try {\r\n    const {\r\n      product_id,\r\n      reviewer_name,\r\n      reviewer_email,\r\n      rating,\r\n      title,\r\n      comment,\r\n      images,\r\n    } = req.body as ReviewData & { images?: string[] };\r\n\r\n    // Validation\r\n    if (!product_id || !reviewer_name || !reviewer_email || !rating) {\r\n      return res.status(400).json({\r\n        error:\r\n          \"Missing required fields: product_id, reviewer_name, reviewer_email, rating\",\r\n      });\r\n    }\r\n\r\n    if (rating < 1 || rating > 5) {\r\n      return res.status(400).json({ error: \"Rating must be between 1 and 5\" });\r\n    }\r\n\r\n    // Email validation\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    if (!emailRegex.test(reviewer_email)) {\r\n      return res.status(400).json({ error: \"Invalid email address\" });\r\n    }\r\n\r\n    // Validate image sizes (max 15MB each)\r\n    const MAX_IMAGE_SIZE = 15 * 1024 * 1024; // 15MB\r\n    if (images && Array.isArray(images)) {\r\n      for (const imageBase64 of images) {\r\n        // Rough estimate: Base64 is ~33% larger than binary, so divide by 1.33\r\n        const estimatedSize = (imageBase64.split(\",\")[1]?.length || 0) * 0.75;\r\n        if (estimatedSize > MAX_IMAGE_SIZE) {\r\n          return res.status(400).json({\r\n            error: `Image size exceeds 15MB limit`,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Upload images to Cloudinary if provided\r\n    const image_urls: string[] = [];\r\n    if (images && Array.isArray(images) && images.length > 0) {\r\n      for (const imageBase64 of images.slice(0, 3)) {\r\n        // Max 3 images per review\r\n        try {\r\n          // If it's already a full data URI, use it; otherwise construct it\r\n          const dataUri = imageBase64.startsWith(\"data:\")\r\n            ? imageBase64\r\n            : `data:image/jpeg;base64,${imageBase64}`;\r\n\r\n          // Compress image before uploading\r\n          const buffer = Buffer.from(\r\n            dataUri.split(\",\")[1] || imageBase64,\r\n            \"base64\",\r\n          );\r\n          const compressedBuffer = await processImage(buffer, 600, 600);\r\n          const compressedDataUri = `data:image/jpeg;base64,${compressedBuffer.toString(\"base64\")}`;\r\n\r\n          const result = await cloudinary.uploader.upload(compressedDataUri, {\r\n            folder: \"sticky-slap/reviews\",\r\n            resource_type: \"auto\",\r\n            quality: \"auto\",\r\n          });\r\n\r\n          image_urls.push(result.secure_url);\r\n        } catch (imageError) {\r\n          console.error(\"Error uploading review image:\", imageError);\r\n          // Continue without this image if upload fails\r\n        }\r\n      }\r\n    }\r\n\r\n    // Insert review into Supabase\r\n    const { data, error } = await supabase\r\n      .from(\"product_reviews\")\r\n      .insert([\r\n        {\r\n          product_id,\r\n          reviewer_name: reviewer_name.trim(),\r\n          reviewer_email: reviewer_email.toLowerCase().trim(),\r\n          rating,\r\n          title: title?.trim() || null,\r\n          comment: comment?.trim() || null,\r\n          image_urls: image_urls,\r\n          status: \"pending\", // Require moderation\r\n        },\r\n      ])\r\n      .select();\r\n\r\n    if (error) {\r\n      console.error(\"Database error inserting review:\", error);\r\n      return res.status(500).json({ error: \"Failed to submit review\" });\r\n    }\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      message: \"Review submitted successfully and pending approval\",\r\n      review: data?.[0] || {},\r\n    });\r\n  } catch (err) {\r\n    console.error(\"Error submitting review:\", err);\r\n    res.status(500).json({ error: \"Failed to submit review\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Get all approved reviews for a product (public endpoint)\r\n */\r\nexport const handleGetProductReviews: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { productId } = req.params;\r\n\r\n    if (!productId) {\r\n      return res.status(400).json({ error: \"Product ID is required\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"product_reviews\")\r\n      .select(\r\n        \"id, product_id, reviewer_name, rating, title, comment, image_urls, helpful_count, created_at\",\r\n      )\r\n      .eq(\"product_id\", productId)\r\n      .eq(\"status\", \"approved\")\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching reviews:\", error);\r\n      return res.status(500).json({ error: \"Failed to fetch reviews\" });\r\n    }\r\n\r\n    // Calculate average rating\r\n    const reviews = data || [];\r\n    const averageRating =\r\n      reviews.length > 0\r\n        ? (\r\n            reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length\r\n          ).toFixed(1)\r\n        : 0;\r\n\r\n    res.json({\r\n      success: true,\r\n      reviews,\r\n      averageRating,\r\n      totalReviews: reviews.length,\r\n    });\r\n  } catch (err) {\r\n    console.error(\"Error getting product reviews:\", err);\r\n    res.status(500).json({ error: \"Failed to fetch reviews\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Mark a review as helpful (increment helpful count)\r\n */\r\nexport const handleMarkReviewHelpful: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { reviewId } = req.params;\r\n\r\n    if (!reviewId) {\r\n      return res.status(400).json({ error: \"Review ID is required\" });\r\n    }\r\n\r\n    const id = parseInt(reviewId, 10);\r\n    if (isNaN(id)) {\r\n      return res.status(400).json({ error: \"Invalid review ID format\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"product_reviews\")\r\n      .update({ helpful_count: supabase.rpc(\"increment_helpful\") })\r\n      .eq(\"id\", id)\r\n      .select();\r\n\r\n    if (error) {\r\n      console.error(\"Error marking review as helpful:\", error);\r\n      return res\r\n        .status(500)\r\n        .json({ error: \"Failed to mark review as helpful\" });\r\n    }\r\n\r\n    res.json({ success: true, review: data?.[0] || {} });\r\n  } catch (err) {\r\n    console.error(\"Error marking review as helpful:\", err);\r\n    res.status(500).json({ error: \"Failed to mark review as helpful\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Admin: Get all reviews (approved and pending) for moderation\r\n */\r\nexport const handleGetAdminReviews: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"product_reviews\")\r\n      .select(\"*\")\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching admin reviews:\", error);\r\n      return res.status(500).json({ error: \"Failed to fetch reviews\" });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      reviews: data || [],\r\n    });\r\n  } catch (err) {\r\n    console.error(\"Error getting admin reviews:\", err);\r\n    res.status(500).json({ error: \"Failed to fetch reviews\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Admin: Approve or reject a review\r\n */\r\nexport const handleUpdateReviewStatus: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { reviewId } = req.params;\r\n    const { status } = req.body;\r\n\r\n    if (!reviewId || !status) {\r\n      return res.status(400).json({\r\n        error: \"Review ID and status are required\",\r\n      });\r\n    }\r\n\r\n    if (![\"approved\", \"rejected\", \"pending\"].includes(status)) {\r\n      return res.status(400).json({\r\n        error: \"Invalid status. Must be 'approved', 'rejected', or 'pending'\",\r\n      });\r\n    }\r\n\r\n    const id = parseInt(reviewId, 10);\r\n    if (isNaN(id)) {\r\n      return res.status(400).json({ error: \"Invalid review ID format\" });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"product_reviews\")\r\n      .update({ status })\r\n      .eq(\"id\", id)\r\n      .select();\r\n\r\n    if (error) {\r\n      console.error(\"Error updating review status:\", error);\r\n      return res.status(500).json({ error: \"Failed to update review\" });\r\n    }\r\n\r\n    res.json({ success: true, review: data?.[0] || {} });\r\n  } catch (err) {\r\n    console.error(\"Error updating review status:\", err);\r\n    res.status(500).json({ error: \"Failed to update review\" });\r\n  }\r\n};\r\n\r\n/**\r\n * Admin: Delete a review\r\n */\r\nexport const handleDeleteReview: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { reviewId } = req.params;\r\n\r\n    if (!reviewId) {\r\n      return res.status(400).json({ error: \"Review ID is required\" });\r\n    }\r\n\r\n    const id = parseInt(reviewId, 10);\r\n    if (isNaN(id)) {\r\n      return res.status(400).json({ error: \"Invalid review ID format\" });\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from(\"product_reviews\")\r\n      .delete()\r\n      .eq(\"id\", id);\r\n\r\n    if (error) {\r\n      console.error(\"Error deleting review:\", error);\r\n      return res.status(500).json({ error: \"Failed to delete review\" });\r\n    }\r\n\r\n    res.json({ success: true, message: \"Review deleted successfully\" });\r\n  } catch (err) {\r\n    console.error(\"Error deleting review:\", err);\r\n    res.status(500).json({ error: \"Failed to delete review\" });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 17419, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/routes/discounts.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { z } from \"zod\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL || \"\",\r\n  process.env.SUPABASE_SERVICE_KEY || \"\",\r\n);\r\n\r\n// Validation schema for creating/updating discount codes\r\nconst DiscountCodeSchema = z.object({\r\n  code: z\r\n    .string()\r\n    .min(3, \"Code must be at least 3 characters\")\r\n    .max(50, \"Code must be at most 50 characters\")\r\n    .transform((val) => val.toUpperCase()),\r\n  description: z.string().optional().or(z.null()),\r\n  discount_type: z.enum([\"percentage\", \"fixed\"]),\r\n  discount_value: z.number().positive(\"Discount value must be positive\"),\r\n  min_order_value: z\r\n    .number()\r\n    .nonnegative(\"Min order value must be non-negative\")\r\n    .optional()\r\n    .default(0),\r\n  max_uses: z\r\n    .number()\r\n    .int()\r\n    .positive(\"Max uses must be positive\")\r\n    .optional()\r\n    .or(z.null()),\r\n  is_active: z.boolean().optional().default(true),\r\n  expires_at: z.string().datetime().optional().or(z.null()),\r\n});\r\n\r\ntype DiscountCode = z.infer<typeof DiscountCodeSchema>;\r\n\r\n// Get all discount codes (admin only)\r\nexport const handleGetDiscountCodes: RequestHandler = async (_req, res) => {\r\n  try {\r\n    const { data: codes, error } = await supabase\r\n      .from(\"discount_codes\")\r\n      .select(\"*\")\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (error) throw error;\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: codes || [],\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch discount codes:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to fetch discount codes\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n\r\n// Get single discount code (admin only)\r\nexport const handleGetDiscountCode: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const parsedId = parseInt(id, 10);\r\n\r\n    if (isNaN(parsedId)) {\r\n      return res.status(400).json({ error: \"Invalid discount code ID\" });\r\n    }\r\n\r\n    const { data: code, error } = await supabase\r\n      .from(\"discount_codes\")\r\n      .select(\"*\")\r\n      .eq(\"id\", parsedId)\r\n      .single();\r\n\r\n    if (error || !code) {\r\n      return res.status(404).json({ error: \"Discount code not found\" });\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: code,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch discount code:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to fetch discount code\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n\r\n// Create discount code (admin only)\r\nexport const handleCreateDiscountCode: RequestHandler = async (req, res) => {\r\n  try {\r\n    const validationResult = DiscountCodeSchema.safeParse(req.body);\r\n\r\n    if (!validationResult.success) {\r\n      return res.status(400).json({\r\n        error: \"Validation failed\",\r\n        details: validationResult.error.errors,\r\n      });\r\n    }\r\n\r\n    const codeData = validationResult.data;\r\n\r\n    // Check if code already exists\r\n    const { data: existingCode } = await supabase\r\n      .from(\"discount_codes\")\r\n      .select(\"id\")\r\n      .eq(\"code\", codeData.code)\r\n      .single();\r\n\r\n    if (existingCode) {\r\n      return res.status(409).json({ error: \"Discount code already exists\" });\r\n    }\r\n\r\n    const { data: newCode, error } = await supabase\r\n      .from(\"discount_codes\")\r\n      .insert([codeData])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) throw error;\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      data: newCode,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to create discount code:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to create discount code\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n\r\n// Update discount code (admin only)\r\nexport const handleUpdateDiscountCode: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const parsedId = parseInt(id, 10);\r\n\r\n    if (isNaN(parsedId)) {\r\n      return res.status(400).json({ error: \"Invalid discount code ID\" });\r\n    }\r\n\r\n    const validationResult = DiscountCodeSchema.partial().safeParse(req.body);\r\n\r\n    if (!validationResult.success) {\r\n      return res.status(400).json({\r\n        error: \"Validation failed\",\r\n        details: validationResult.error.errors,\r\n      });\r\n    }\r\n\r\n    const updates = validationResult.data;\r\n\r\n    // Check if updating code and if new code already exists\r\n    if (updates.code) {\r\n      const { data: existingCode } = await supabase\r\n        .from(\"discount_codes\")\r\n        .select(\"id\")\r\n        .eq(\"code\", updates.code)\r\n        .neq(\"id\", parsedId)\r\n        .single();\r\n\r\n      if (existingCode) {\r\n        return res.status(409).json({ error: \"Discount code already exists\" });\r\n      }\r\n    }\r\n\r\n    const { data: updatedCode, error } = await supabase\r\n      .from(\"discount_codes\")\r\n      .update({\r\n        ...updates,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", parsedId)\r\n      .select()\r\n      .single();\r\n\r\n    if (error || !updatedCode) {\r\n      return res.status(404).json({ error: \"Discount code not found\" });\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      data: updatedCode,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to update discount code:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to update discount code\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n\r\n// Delete discount code (admin only)\r\nexport const handleDeleteDiscountCode: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const parsedId = parseInt(id, 10);\r\n\r\n    if (isNaN(parsedId)) {\r\n      return res.status(400).json({ error: \"Invalid discount code ID\" });\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from(\"discount_codes\")\r\n      .delete()\r\n      .eq(\"id\", parsedId);\r\n\r\n    if (error) throw error;\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: \"Discount code deleted successfully\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to delete discount code:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to delete discount code\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n\r\n// Validate discount code for checkout (public endpoint)\r\nexport const handleValidateDiscountCode: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { code, orderTotal } = req.body;\r\n\r\n    if (!code || typeof code !== \"string\") {\r\n      return res.status(400).json({ error: \"Discount code is required\" });\r\n    }\r\n\r\n    if (orderTotal === undefined || orderTotal === null) {\r\n      return res.status(400).json({ error: \"Order total is required\" });\r\n    }\r\n\r\n    const upperCode = code.toUpperCase();\r\n\r\n    // Fetch the discount code\r\n    const { data: discountCode, error } = await supabase\r\n      .from(\"discount_codes\")\r\n      .select(\"*\")\r\n      .eq(\"code\", upperCode)\r\n      .eq(\"is_active\", true)\r\n      .single();\r\n\r\n    if (error || !discountCode) {\r\n      return res.status(400).json({ error: \"Invalid discount code\" });\r\n    }\r\n\r\n    // Check if code has expired\r\n    if (\r\n      discountCode.expires_at &&\r\n      new Date(discountCode.expires_at) < new Date()\r\n    ) {\r\n      return res.status(400).json({ error: \"Discount code has expired\" });\r\n    }\r\n\r\n    // Check if max uses reached\r\n    if (\r\n      discountCode.max_uses !== null &&\r\n      discountCode.used_count >= discountCode.max_uses\r\n    ) {\r\n      return res\r\n        .status(400)\r\n        .json({ error: \"Discount code usage limit reached\" });\r\n    }\r\n\r\n    // Check minimum order value\r\n    if (orderTotal < discountCode.min_order_value) {\r\n      return res.status(400).json({\r\n        error: `Order total must be at least $${discountCode.min_order_value.toFixed(2)} to use this discount`,\r\n      });\r\n    }\r\n\r\n    // Calculate discount amount\r\n    let discountAmount = 0;\r\n    if (discountCode.discount_type === \"percentage\") {\r\n      discountAmount = (orderTotal * discountCode.discount_value) / 100;\r\n    } else {\r\n      discountAmount = discountCode.discount_value;\r\n    }\r\n\r\n    // Cap discount at order total\r\n    discountAmount = Math.min(discountAmount, orderTotal);\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      discount: {\r\n        code: discountCode.code,\r\n        type: discountCode.discount_type,\r\n        value: discountCode.discount_value,\r\n        amount: parseFloat(discountAmount.toFixed(2)),\r\n        description: discountCode.description,\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to validate discount code:\", error);\r\n    const errorMessage =\r\n      error instanceof Error\r\n        ? error.message\r\n        : \"Failed to validate discount code\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n\r\n// Apply discount code to order (increment used_count)\r\nexport const handleApplyDiscountCode: RequestHandler = async (req, res) => {\r\n  try {\r\n    const { code } = req.body;\r\n\r\n    if (!code || typeof code !== \"string\") {\r\n      return res.status(400).json({ error: \"Discount code is required\" });\r\n    }\r\n\r\n    const upperCode = code.toUpperCase();\r\n\r\n    // Get the discount code\r\n    const { data: discountCode, error: selectError } = await supabase\r\n      .from(\"discount_codes\")\r\n      .select(\"*\")\r\n      .eq(\"code\", upperCode)\r\n      .single();\r\n\r\n    if (selectError || !discountCode) {\r\n      return res.status(400).json({ error: \"Invalid discount code\" });\r\n    }\r\n\r\n    // Increment used count\r\n    const { data: updatedCode, error: updateError } = await supabase\r\n      .from(\"discount_codes\")\r\n      .update({ used_count: discountCode.used_count + 1 })\r\n      .eq(\"id\", discountCode.id)\r\n      .select()\r\n      .single();\r\n\r\n    if (updateError || !updatedCode) {\r\n      throw updateError || new Error(\"Failed to update discount code\");\r\n    }\r\n\r\n    res.status(200).json({\r\n      success: true,\r\n      message: \"Discount code applied successfully\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Failed to apply discount code:\", error);\r\n    const errorMessage =\r\n      error instanceof Error ? error.message : \"Failed to apply discount code\";\r\n    res.status(500).json({ success: false, error: errorMessage });\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 17722, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/server/index.ts"],"sourcesContent":["// Load environment variables\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  // Use dynamic import for dotenv to avoid issues in ES modules\r\n  import(\"dotenv/config\").catch(() => {\r\n    // dotenv not available, that's okay - environment variables may be set another way\r\n  });\r\n}\r\nimport express from \"express\";\r\nimport cors from \"cors\";\r\nimport multer from \"multer\";\r\nimport { handleDemo } from \"./routes/demo\";\r\nimport { createAuthRouter } from \"./routes/auth.router\";\r\nimport { createCustomerRouter } from \"./routes/customer.router\";\r\nimport { createOrderRouter, createPublicOrderRouter } from \"./routes/order.router\";\r\nimport {\r\n  createProductRouter,\r\n  createAdminProductRouter,\r\n  createPublicProductRouter,\r\n  createStorefrontRouter,\r\n} from \"./routes/product.router\";\r\n// Additional route imports - will be refactored to routers in phase 2\r\nimport {\r\n  handleGetDesigns,\r\n  handleGetOrderDesigns,\r\n  handleUploadDesignFile,\r\n} from \"./routes/designs\";\r\nimport {\r\n  handleCreateCart,\r\n  handleGetCart,\r\n  handleAddToCart,\r\n  handleUpdateCartItem,\r\n  handleRemoveFromCart,\r\n  handleClearCart,\r\n} from \"./routes/cart\";\r\nimport { handleCheckout, handleGetCheckoutDetails } from \"./routes/checkout\";\r\nimport {\r\n  handleGetCustomerCredit,\r\n  handleGetAllCustomersCredit,\r\n  handleModifyStoreCredit,\r\n  handleGetCreditHistory,\r\n  handleApplyStoreCreditToOrder,\r\n} from \"./routes/store-credit\";\r\nimport {\r\n  handleSupportSubmit,\r\n  handleGetTickets,\r\n  handleGetTicketDetails,\r\n  handleAdminGetAllTickets,\r\n  handleAdminReplyToTicket,\r\n  handleUpdateTicketStatus,\r\n  handleCustomerReplyToTicket,\r\n} from \"./routes/support\";\r\nimport {\r\n  handleGetPaymentMethods,\r\n  handleProcessPayment,\r\n} from \"./routes/payments\";\r\nimport {\r\n  handleEcwidOrderWebhook,\r\n  handleWebhookHealth,\r\n  handleGetWebhookUrl,\r\n  handleEcwidDiagnostic,\r\n  handleTestWebhook,\r\n} from \"./routes/webhooks\";\r\nimport {\r\n  handleZapierEcwidWebhook,\r\n  handleZapierHealth,\r\n  handleGetZapierWebhookUrl,\r\n} from \"./routes/zapier\";\r\nimport {\r\n  handleSquarePayment,\r\n  handleGetSquareConfig,\r\n  handleGetSquareLocations,\r\n  handleTestSquareConfig,\r\n  handleCreateCheckoutSession,\r\n  handleConfirmCheckout,\r\n  handleSquareWebhook,\r\n  handleCreatePayment,\r\n  handleVerifyPendingPayment,\r\n} from \"./routes/square\";\r\nimport { processSquarePayment } from \"./routes/square-payment\";\r\nimport {\r\n  handleUploadDigitalFile,\r\n  handleGetOrderFiles,\r\n  handleDeleteDigitalFile,\r\n} from \"./routes/digital-files\";\r\nimport {\r\n  handleGetEcwidProduct,\r\n  handleListEcwidProducts,\r\n  handleSearchEcwidProducts,\r\n} from \"./routes/ecwid-products\";\r\nimport {\r\n  handleImportProducts,\r\n  handleGetProducts,\r\n  handleDeleteAllProducts,\r\n} from \"./routes/import-products\";\r\nimport {\r\n  handleGetProofs,\r\n  handleGetProofDetail,\r\n  handleApproveProof,\r\n  handleDenyProof,\r\n  handleAddProofComment,\r\n  handleGetProofNotifications,\r\n  handleSendProofToCustomer,\r\n  handleGetAdminProofs,\r\n  handleGetAdminProofDetail,\r\n  handleAddAdminProofComment,\r\n  handleGetProofDetailPublic,\r\n  handleApproveProofPublic,\r\n  handleDenyProofPublic,\r\n  handleApproveProofPublicNew,\r\n  handleReviseProofPublicNew,\r\n} from \"./routes/proofs\";\r\nimport { handleSendProofDirectly } from \"./routes/send-proof\";\r\nimport {\r\n  handleProofEmailPreview,\r\n  handleSendProofEmailPreview,\r\n  handleSignupConfirmationPreview,\r\n  handleOrderConfirmationPreview,\r\n  handleShippingConfirmationPreview,\r\n  handlePasswordResetPreview,\r\n  handleSupportTicketReplyPreview,\r\n  handleOrderStatusUpdatePreview,\r\n} from \"./routes/email-preview\";\r\nimport {\r\n  handleGetAdminPendingOrders,\r\n  handleUpdateOrderStatus,\r\n  handleGetAllAdminOrders,\r\n  handleGetOrderDetail,\r\n  handleUpdateShippingAddress,\r\n  handleUpdateOrderItemOptions,\r\n  handleTestAdminOrders,\r\n  handleDebugOrders,\r\n} from \"./routes/admin-orders\";\r\nimport {\r\n  handleGetAllCustomers,\r\n  handleGetCustomerDetails,\r\n  handleSearchCustomers,\r\n} from \"./routes/admin-customers\";\r\nimport { handleGetAnalytics, handleTrackEvent } from \"./routes/admin-analytics\";\r\nimport { handleGetFinance } from \"./routes/admin-finance\";\r\nimport {\r\n  handleCreateProduct,\r\n  handleUpdateProduct,\r\n  handleGetAdminProducts,\r\n  handleGetAdminProduct,\r\n  handleDeleteAdminProduct,\r\n  handleGetPublicProduct,\r\n  handleImportAdminProduct,\r\n  handleGetStorefrontProducts,\r\n  handleGetAdminProductPublic,\r\n  handleGetImportedProductPublic,\r\n} from \"./routes/admin-products\";\r\nimport {\r\n  handleCreateLabel,\r\n  handleGetRates,\r\n  handleGetCarriers,\r\n  handleGetServices,\r\n} from \"./routes/shipping\";\r\nimport { handleGetPublicShippingOptions } from \"./routes/shipping-public\";\r\nimport {\r\n  handleGetShippingOptions,\r\n  handleGetShippingOption,\r\n  handleCreateShippingOption,\r\n  handleUpdateShippingOption,\r\n  handleDeleteShippingOption,\r\n} from \"./routes/admin-shipping\";\r\nimport {\r\n  handleGetPublishedBlogs,\r\n  handleGetBlogById,\r\n  handleCreateBlog,\r\n  handleGetAllBlogs,\r\n  handleGetAdminBlogById,\r\n  handleDeleteBlog,\r\n  handleUpdateBlog,\r\n  handleUploadBlogImage,\r\n} from \"./routes/blogs\";\r\nimport adminGalleryRouter from \"./routes/admin-gallery\";\r\nimport {\r\n  handleGetPublishedLegalPages,\r\n  handleGetAllLegalPages,\r\n  handleGetLegalPageByType,\r\n  handleGetAdminLegalPageById,\r\n  handleCreateLegalPage,\r\n  handleUpdateLegalPage,\r\n  handleDeleteLegalPage,\r\n} from \"./routes/legal-pages\";\r\nimport {\r\n  getReturnRefundPolicy,\r\n  updateReturnRefundPolicy,\r\n} from \"./routes/admin-return-refund-policy\";\r\nimport {\r\n  handleGetInvoices,\r\n  handleGetInvoice,\r\n  handleCreateInvoice,\r\n  handleUpdateInvoice,\r\n  handleSendInvoice,\r\n  handleMarkInvoicePaid,\r\n  handleCancelInvoice,\r\n  handleGetInvoiceByToken,\r\n  handleGetPaymentToken,\r\n  handleCreateInvoicePaymentLink,\r\n  verifySupabaseToken,\r\n} from \"./routes/invoices\";\r\nimport { handleInitializeInvoicesDatabase } from \"./routes/db-setup\";\r\nimport {\r\n  handleUploadArtwork,\r\n  handleGetArtwork,\r\n  handleDeleteArtwork,\r\n  uploadMiddleware,\r\n} from \"./routes/invoice-artwork\";\r\nimport { handleDebugOrdersList, handleDebugHealth } from \"./routes/debug\";\r\nimport {\r\n  handleEcwidMigration,\r\n  handleGetMigrationStatus,\r\n  handleCSVCustomerImport,\r\n} from \"./routes/ecwid-migration\";\r\nimport {\r\n  handleSubmitReview,\r\n  handleGetProductReviews,\r\n  handleMarkReviewHelpful,\r\n  handleGetAdminReviews,\r\n  handleUpdateReviewStatus,\r\n  handleDeleteReview,\r\n} from \"./routes/reviews\";\r\nimport {\r\n  handleGetDiscountCodes,\r\n  handleGetDiscountCode,\r\n  handleCreateDiscountCode,\r\n  handleUpdateDiscountCode,\r\n  handleDeleteDiscountCode,\r\n  handleValidateDiscountCode,\r\n  handleApplyDiscountCode,\r\n} from \"./routes/discounts\";\r\nimport {\r\n  verifyToken,\r\n  optionalVerifyToken,\r\n  requireAdmin,\r\n} from \"./middleware/auth\";\r\nimport {\r\n  apiLimiter,\r\n  authLimiter,\r\n  paymentLimiter,\r\n  checkoutLimiter,\r\n  adminLimiter,\r\n} from \"./middleware/rate-limit\";\r\n\r\nexport function createServer() {\r\n  const app = express();\r\n\r\n  // CORS Configuration - Allow only trusted origins\r\n  const allowedOrigins = [\r\n    // Frontend URLs - Development\r\n    \"http://localhost:3000\",  // Next.js dev server\r\n    \"http://localhost:3001\",  // Next.js alt port\r\n    \"http://localhost:5173\",\r\n    \"http://localhost:5174\",\r\n    \"http://localhost:5175\",\r\n    \"http://localhost:8080\", // Vite dev server proxy\r\n    \"http://127.0.0.1:3000\",\r\n    \"http://127.0.0.1:3001\",\r\n    \"http://127.0.0.1:5173\",\r\n    \"http://127.0.0.1:5174\",\r\n    \"http://127.0.0.1:5175\",\r\n    \"http://127.0.0.1:8080\",\r\n    // Custom frontend URL\r\n    process.env.FRONTEND_URL || \"http://localhost:5173\",\r\n    \"https://stickershop.test\", // Local testing\r\n    // Production domains\r\n    \"https://stickerland.app\",\r\n    \"https://www.stickerland.app\",\r\n    // Add production domains here as environment variables\r\n    ...(process.env.ALLOWED_ORIGINS\r\n      ? process.env.ALLOWED_ORIGINS.split(\",\").map((o) => o.trim())\r\n      : []),\r\n  ];\r\n\r\n\r\n\r\n  // Allow www subdomain for production URLs\r\n  const allowWwwVariants = (url: string) => {\r\n    if (url.startsWith(\"https://\") && !url.includes(\"www.\")) {\r\n      const wwwUrl = url.replace(\"https://\", \"https://www.\");\r\n      if (!allowedOrigins.includes(wwwUrl)) {\r\n        allowedOrigins.push(wwwUrl);\r\n      }\r\n    }\r\n  };\r\n\r\n  // Add www variants for all https URLs\r\n  [\r\n    process.env.FRONTEND_URL,\r\n    ...(process.env.ALLOWED_ORIGINS\r\n      ? process.env.ALLOWED_ORIGINS.split(\",\")\r\n      : []),\r\n  ].forEach((url) => {\r\n    if (url) {\r\n      allowWwwVariants(url.trim());\r\n    }\r\n  });\r\n\r\n  const corsOptions = {\r\n    origin: (\r\n      origin: string | undefined,\r\n      callback: (err: Error | null, allow?: boolean) => void,\r\n    ) => {\r\n      // Reject requests with no origin in production (prevents CSRF)\r\n      if (!origin) {\r\n        if (process.env.NODE_ENV === 'production') {\r\n          console.warn(\"[SECURITY] CORS request with no origin blocked in production\");\r\n          return callback(new Error(\"Origin header required\"));\r\n        }\r\n        // Allow in development only\r\n        return callback(null, true);\r\n      }\r\n\r\n      if (allowedOrigins.includes(origin)) {\r\n        callback(null, true);\r\n      } else {\r\n        console.warn(`[SECURITY] CORS request blocked from origin: ${origin}`, {\r\n          allowedOrigins,\r\n          flyAppName: process.env.FLY_APP_NAME,\r\n          frontendUrl: process.env.FRONTEND_URL,\r\n        });\r\n        callback(new Error(\"Not allowed by CORS policy\"));\r\n      }\r\n    },\r\n    credentials: true,\r\n    optionsSuccessStatus: 200,\r\n    methods: [\"GET\", \"POST\", \"PUT\", \"PATCH\", \"DELETE\", \"OPTIONS\"],\r\n    allowedHeaders: [\"Content-Type\", \"Authorization\", \"X-Admin-Setup-Key\"],\r\n  };\r\n\r\n  console.log(\"‚úÖ CORS Configuration initialized:\", {\r\n    allowedOrigins,\r\n    frontendUrl: process.env.FRONTEND_URL,\r\n  });\r\n\r\n  // Phase 1: Environment & Config Verification\r\n  console.log(\"=== PHASE 1: Environment & Config Verification ===\");\r\n  console.log(\"‚úÖ SQUARE_APPLICATION_ID:\", process.env.SQUARE_APPLICATION_ID ? \"Loaded\" : \"‚ùå MISSING\");\r\n  console.log(\"‚úÖ SQUARE_ACCESS_TOKEN:\", process.env.SQUARE_ACCESS_TOKEN ? \"Loaded\" : \"‚ùå MISSING\");\r\n  console.log(\"‚úÖ RESEND_API_KEY:\", process.env.RESEND_API_KEY ? \"Loaded\" : \"‚ùå MISSING\");\r\n  console.log(\"=================================================\");\r\n\r\n  // Middleware\r\n  app.use(cors(corsOptions));\r\n\r\n  // Middleware to handle pre-parsed bodies (Vercel/serverless-http often parses JSON automatically)\r\n  app.use((req: any, _res, next) => {\r\n    // Check if body is a Buffer (happens in some serverless environments)\r\n    if (req.body && Buffer.isBuffer(req.body)) {\r\n      // Skip parsing if buffer is empty\r\n      if (req.body.length === 0) {\r\n        req.body = {};\r\n        return next();\r\n      }\r\n\r\n      try {\r\n        const bodyString = req.body.toString(\"utf8\");\r\n        // Only parse if string is valid JSON\r\n        if (bodyString.trim().startsWith('{') || bodyString.trim().startsWith('[')) {\r\n          req.body = JSON.parse(bodyString);\r\n          console.log(\"‚úÖ Parsed Buffer body to JSON successfully\");\r\n        }\r\n      } catch (error) {\r\n        console.error(\"‚ùå Failed to parse Buffer body:\", error);\r\n        // Don't error here, let express.json() or routes handle it\r\n      }\r\n    }\r\n    next();\r\n  });\r\n\r\n  app.use(express.json({ limit: \"50mb\" }));\r\n  app.use(express.urlencoded({ limit: \"50mb\", extended: true }));\r\n\r\n  // Apply rate limiting globally (only in production)\r\n  if (process.env.NODE_ENV === \"production\") {\r\n    app.use(apiLimiter);\r\n  }\r\n\r\n  // Multer configuration for file uploads\r\n  const upload = multer({\r\n    storage: multer.memoryStorage(),\r\n    limits: { fileSize: 50 * 1024 * 1024 }, // 50MB\r\n    fileFilter: (req, file, cb) => {\r\n      if (file.mimetype.startsWith(\"image/\")) {\r\n        cb(null, true);\r\n      } else {\r\n        cb(new Error(\"Only image files are allowed\"));\r\n      }\r\n    },\r\n  });\r\n\r\n  // Security headers for Square Web Payments SDK and general security\r\n  app.use((req, res, next) => {\r\n    // Content Security Policy for Square Web Payments SDK\r\n    // Allows Square's scripts and connections for payment processing\r\n    res.setHeader(\r\n      \"Content-Security-Policy\",\r\n      [\r\n        \"default-src 'self'\",\r\n        \"script-src 'self' 'unsafe-inline' 'unsafe-eval' https://web.squarecdn.com https://sandbox.web.squarecdn.com https://square.com https://connect.squareup.com https://*.ecwid.com https://*.google.com https://*.googleapis.com https://*.gstatic.com https://d34ikvsdm2rlij.cloudfront.net https://storefront.ecwid.dev:*\",\r\n        \"connect-src 'self' https://web.squarecdn.com https://sandbox.web.squarecdn.com https://square.com https://*.squareupsandbox.com https://*.squareup.com https://connect.squareup.com https://connect.squareupsandbox.com https://*.ecwid.com https://*.google.com https://*.googleapis.com https://*.gstatic.com https://d34ikvsdm2rlij.cloudfront.net https://storefront.ecwid.dev:* https://api.cloudinary.com https://res.cloudinary.com\",\r\n        \"frame-src 'self' https://web.squarecdn.com https://sandbox.web.squarecdn.com https://square.com https://*.squareupsandbox.com https://*.squareup.com https://*.ecwid.com https://d34ikvsdm2rlij.cloudfront.net https://storefront.ecwid.dev:*\",\r\n        \"img-src 'self' https: data: https://d34ikvsdm2rlij.cloudfront.net https://storefront.ecwid.dev:* https://res.cloudinary.com\",\r\n        \"style-src 'self' 'unsafe-inline' https://web.squarecdn.com https://sandbox.web.squarecdn.com https://fonts.googleapis.com https://*.ecwid.com https://d34ikvsdm2rlij.cloudfront.net https://storefront.ecwid.dev:*\",\r\n        \"font-src 'self' https://web.squarecdn.com https://sandbox.web.squarecdn.com https://fonts.googleapis.com https://*.gstatic.com https://d34ikvsdm2rlij.cloudfront.net https://storefront.ecwid.dev:*\",\r\n        \"object-src 'none'\",\r\n      ].join(\"; \"),\r\n    );\r\n\r\n    // HTTPS enforcement (Secure Context requirement)\r\n    // Redirect HTTP to HTTPS in production\r\n    if (\r\n      process.env.NODE_ENV === \"production\" &&\r\n      req.header(\"x-forwarded-proto\") !== \"https\"\r\n    ) {\r\n      return res.redirect(\r\n        301,\r\n        `https://${req.header(\"host\")}${req.originalUrl}`,\r\n      );\r\n    }\r\n\r\n    // Additional security headers for PCI DSS compliance\r\n    res.setHeader(\"X-Content-Type-Options\", \"nosniff\");\r\n    res.setHeader(\"X-Frame-Options\", \"SAMEORIGIN\");\r\n    res.setHeader(\"X-XSS-Protection\", \"1; mode=block\");\r\n    res.setHeader(\"Referrer-Policy\", \"strict-origin-when-cross-origin\");\r\n\r\n    // Strict Transport Security (HSTS) - Enforce HTTPS for 1 year\r\n    res.setHeader(\r\n      \"Strict-Transport-Security\",\r\n      \"max-age=31536000; includeSubDomains; preload\",\r\n    );\r\n\r\n    // Permissions Policy (formerly Feature Policy) - Restrict API access\r\n    res.setHeader(\r\n      \"Permissions-Policy\",\r\n      \"geolocation=(), microphone=(), camera=(), payment=self, usb=()\",\r\n    );\r\n\r\n    // Certificate Transparency - Enforce CT monitoring\r\n    res.setHeader(\r\n      \"Expect-CT\",\r\n      \"max-age=86400, enforce\",\r\n    );\r\n\r\n    // Prevent MIME sniffing for PCI security\r\n    res.setHeader(\"X-Content-Type-Options\", \"nosniff\");\r\n\r\n    // Additional cache control for sensitive pages\r\n    if (req.path.includes(\"/checkout\") || req.path.includes(\"/payment\")) {\r\n      res.setHeader(\r\n        \"Cache-Control\",\r\n        \"no-store, no-cache, must-revalidate, proxy-revalidate\",\r\n      );\r\n      res.setHeader(\"Pragma\", \"no-cache\");\r\n      res.setHeader(\"Expires\", \"0\");\r\n    }\r\n\r\n    next();\r\n  });\r\n\r\n  // Error handling for JSON parsing\r\n  app.use((err: any, _req: any, res: any, next: any) => {\r\n    if (err instanceof SyntaxError && \"body\" in err) {\r\n      console.error(\"JSON parsing error:\", {\r\n        message: err.message,\r\n        bodyPartial: (err as any).body?.substring?.(0, 200), // Log first 200 chars if available\r\n      });\r\n      return res.status(400).json({ error: \"Invalid JSON in request body\" });\r\n    }\r\n    if (err) {\r\n      console.error(\"Unhandled middleware error:\", err);\r\n      return next(err);\r\n    }\r\n    next();\r\n  });\r\n\r\n  // Health check endpoint\r\n  app.get(\"/health\", (_req, res) => {\r\n    res.status(200).json({ status: \"ok\", timestamp: new Date().toISOString() });\r\n  });\r\n\r\n  // Example API routes\r\n  app.get(\"/api/ping\", (_req, res) => {\r\n    const ping = process.env.PING_MESSAGE ?? \"ping\";\r\n    res.json({ message: ping });\r\n  });\r\n\r\n  // Health check endpoint - verify environment configuration\r\n  app.get(\"/api/health\", (_req, res) => {\r\n    const requiredEnvVars = [\r\n      \"SUPABASE_URL\",\r\n      \"SUPABASE_SERVICE_KEY\",\r\n      \"JWT_SECRET\",\r\n      \"SQUARE_APPLICATION_ID\",\r\n      \"SQUARE_ACCESS_TOKEN\",\r\n      \"SQUARE_LOCATION_ID\",\r\n    ];\r\n\r\n    const missingVars = requiredEnvVars.filter((v) => !process.env[v]);\r\n    const isHealthy = missingVars.length === 0;\r\n\r\n    const health = {\r\n      status: isHealthy ? \"healthy\" : \"degraded\",\r\n      timestamp: new Date().toISOString(),\r\n      environment: process.env.NODE_ENV,\r\n      configured: {\r\n        SUPABASE_URL: !!process.env.SUPABASE_URL,\r\n        SUPABASE_SERVICE_KEY: !!process.env.SUPABASE_SERVICE_KEY,\r\n        JWT_SECRET: !!process.env.JWT_SECRET,\r\n        FRONTEND_URL: !!process.env.FRONTEND_URL,\r\n        BASE_URL: !!process.env.BASE_URL,\r\n        SQUARE_APPLICATION_ID: !!process.env.SQUARE_APPLICATION_ID,\r\n        SQUARE_ACCESS_TOKEN: !!process.env.SQUARE_ACCESS_TOKEN,\r\n        SQUARE_LOCATION_ID: !!process.env.SQUARE_LOCATION_ID,\r\n        ECWID_API_TOKEN: !!process.env.ECWID_API_TOKEN,\r\n        CLOUDINARY_CLOUD_NAME: !!process.env.CLOUDINARY_CLOUD_NAME,\r\n      },\r\n      missingVars: process.env.NODE_ENV === \"development\" ? missingVars : [],\r\n    };\r\n\r\n    const statusCode = isHealthy ? 200 : 503;\r\n    res.status(statusCode).json(health);\r\n  });\r\n\r\n  app.get(\"/api/demo\", handleDemo);\r\n\r\n  // ===== Mount Routers =====\r\n  // Authentication routes\r\n  app.use(\"/api/auth\", createAuthRouter());\r\n\r\n  // Customer routes (protected)\r\n  app.use(\"/api/customers\", createCustomerRouter(upload));\r\n\r\n  // Order routes (customer and public only - admin routes are defined directly below)\r\n  app.use(\"/api/orders\", createOrderRouter());\r\n  app.use(\"/api/public/orders\", createPublicOrderRouter());\r\n\r\n  // Product routes (public, admin, storefront)\r\n  app.use(\"/api/products\", createProductRouter());\r\n  app.use(\"/api/admin/products\", createAdminProductRouter());\r\n  app.use(\"/api/public/products\", createPublicProductRouter());\r\n  app.use(\"/api/storefront\", createStorefrontRouter());\r\n\r\n  // ===== Debug Endpoints (Development Only) =====\r\n  // SECURITY: These endpoints are ONLY available in development environment\r\n  // They expose sensitive system information and should never be enabled in production\r\n  if (process.env.NODE_ENV !== 'production') {\r\n    app.get(\r\n      \"/api/debug/orders-list\",\r\n      verifyToken,\r\n      requireAdmin,\r\n      handleDebugOrdersList,\r\n    );\r\n    app.get(\"/api/debug/health\", verifyToken, requireAdmin, handleDebugHealth);\r\n    console.log(\"[SECURITY] Debug endpoints enabled for development\");\r\n  }\r\n\r\n  // ===== Design Routes (Protected) =====\r\n  app.get(\"/api/designs\", verifyToken, handleGetDesigns);\r\n  app.get(\"/api/orders/:orderId/designs\", verifyToken, handleGetOrderDesigns);\r\n  app.post(\"/api/designs/upload\", verifyToken, handleUploadDesignFile);\r\n\r\n  // ===== Cart Routes (Public) =====\r\n  app.post(\"/api/cart\", handleCreateCart);\r\n  app.get(\"/api/cart/:cartId\", handleGetCart);\r\n  app.post(\"/api/cart/:cartId/items\", handleAddToCart);\r\n  app.patch(\"/api/cart/:cartId/items/:itemIndex\", handleUpdateCartItem);\r\n  app.delete(\"/api/cart/:cartId/items/:itemIndex\", handleRemoveFromCart);\r\n  app.delete(\"/api/cart/:cartId\", handleClearCart);\r\n\r\n  // ===== Checkout Routes (Public - guest checkout supported) =====\r\n  app.post(\"/api/checkout\", checkoutLimiter, handleCheckout);\r\n  app.get(\"/api/checkout/:cartId\", handleGetCheckoutDetails);\r\n\r\n  // Product routes handled by createProductRouter() above\r\n\r\n  // ===== Product Reviews Routes (Public) =====\r\n  app.post(\"/api/reviews\", handleSubmitReview);\r\n  app.get(\"/api/reviews/:productId\", handleGetProductReviews);\r\n  app.post(\"/api/reviews/:reviewId/helpful\", handleMarkReviewHelpful);\r\n\r\n  // ===== Admin Reviews Routes (Protected - Admin only) =====\r\n  app.get(\r\n    \"/api/admin/reviews\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetAdminReviews,\r\n  );\r\n  app.patch(\r\n    \"/api/admin/reviews/:reviewId/status\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateReviewStatus,\r\n  );\r\n  app.delete(\r\n    \"/api/admin/reviews/:reviewId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleDeleteReview,\r\n  );\r\n\r\n  // ===== Ecwid Products Routes (Public) =====\r\n  // Note: Order matters! More specific routes first\r\n  app.get(\"/api/ecwid-products/search\", handleSearchEcwidProducts);\r\n  app.get(\"/api/ecwid-products/:productId\", handleGetEcwidProduct);\r\n  app.get(\"/api/ecwid-products\", handleListEcwidProducts);\r\n\r\n  // ===== Imported Products Routes =====\r\n  app.get(\"/api/imported-products\", handleGetProducts);\r\n  app.post(\r\n    \"/api/import-products\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleImportProducts,\r\n  );\r\n  app.delete(\r\n    \"/api/imported-products/all\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleDeleteAllProducts,\r\n  );\r\n\r\n  // Storefront Products Routes handled by createProductRouter() mounted at /api/storefront above\r\n\r\n  // ===== Payments Routes (Public) =====\r\n  app.get(\"/api/payments/methods\", handleGetPaymentMethods);\r\n  app.post(\"/api/payments/process\", paymentLimiter, handleProcessPayment);\r\n\r\n  // ===== Square Payment Routes (Public) =====\r\n  app.get(\"/api/square/config\", handleGetSquareConfig);\r\n  app.get(\"/api/square/locations\", handleGetSquareLocations);\r\n  app.get(\"/api/square/test\", handleTestSquareConfig);\r\n  app.post(\r\n    \"/api/square/checkout\",\r\n    checkoutLimiter,\r\n    handleCreateCheckoutSession,\r\n  );\r\n  app.post(\r\n    \"/api/square/confirm-checkout\",\r\n    paymentLimiter,\r\n    handleConfirmCheckout,\r\n  );\r\n  app.post(\"/api/square/pay\", paymentLimiter, handleSquarePayment);\r\n  app.post(\"/api/square/process-payment\", paymentLimiter, processSquarePayment);\r\n  app.post(\"/api/square/create-payment\", paymentLimiter, handleCreatePayment);\r\n  app.post(\"/api/webhooks/square\", handleSquareWebhook);\r\n  app.post(\r\n    \"/api/admin/verify-payment/:orderId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleVerifyPendingPayment,\r\n  );\r\n\r\n  // ===== Admin Routes (Protected - Admin only) =====\r\n  // Admin order detail route (direct - not using router)\r\n  app.get(\r\n    \"/api/admin/orders/:orderId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetOrderDetail,\r\n  );\r\n\r\n  // Other admin order status/shipping routes\r\n  app.put(\r\n    \"/api/admin/orders/:orderId/status\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateOrderStatus,\r\n  );\r\n  app.put(\r\n    \"/api/admin/orders/:orderId/shipping-address\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateShippingAddress,\r\n  );\r\n\r\n  app.get(\r\n    \"/api/admin/customers\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetAllCustomers,\r\n  );\r\n  app.get(\r\n    \"/api/admin/customers/search\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleSearchCustomers,\r\n  );\r\n  app.get(\r\n    \"/api/admin/customers/:customerId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetCustomerDetails,\r\n  );\r\n  app.get(\r\n    \"/api/admin/analytics\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetAnalytics,\r\n  );\r\n  app.post(\"/api/analytics/track\", handleTrackEvent);\r\n  app.get(\"/api/admin/finance\", verifyToken, requireAdmin, handleGetFinance);\r\n\r\n  // Admin product routes handled by createProductRouter() above\r\n\r\n  // ===== Store Credit Routes (Protected - admin only) =====\r\n  app.get(\r\n    \"/api/store-credit/customers\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetAllCustomersCredit,\r\n  );\r\n  app.get(\r\n    \"/api/store-credit/:customerId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetCustomerCredit,\r\n  );\r\n  app.get(\r\n    \"/api/store-credit/:customerId/history\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetCreditHistory,\r\n  );\r\n  app.post(\r\n    \"/api/store-credit/modify\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleModifyStoreCredit,\r\n  );\r\n  app.post(\r\n    \"/api/store-credit/apply-to-order\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleApplyStoreCreditToOrder,\r\n  );\r\n\r\n  // ===== Support Routes =====\r\n  app.post(\"/api/support/submit\", handleSupportSubmit);\r\n  app.get(\"/api/support/tickets\", verifyToken, handleGetTickets);\r\n  app.get(\r\n    \"/api/support/tickets/:ticketId\",\r\n    verifyToken,\r\n    handleGetTicketDetails,\r\n  );\r\n  app.post(\r\n    \"/api/support/tickets/:ticketId/reply\",\r\n    verifyToken,\r\n    handleCustomerReplyToTicket,\r\n  );\r\n  app.get(\r\n    \"/api/admin/tickets\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleAdminGetAllTickets,\r\n  );\r\n  app.post(\r\n    \"/api/admin/tickets/:ticketId/reply\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleAdminReplyToTicket,\r\n  );\r\n  app.patch(\r\n    \"/api/admin/tickets/:ticketId/status\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateTicketStatus,\r\n  );\r\n\r\n  // ===== Digital Files Routes =====\r\n  app.post(\"/api/orders/:orderId/files\", verifyToken, handleUploadDigitalFile);\r\n  app.get(\"/api/orders/:orderId/files\", verifyToken, handleGetOrderFiles);\r\n  app.delete(\"/api/files/:fileId\", verifyToken, handleDeleteDigitalFile);\r\n\r\n  // ===== Proofs Routes (Protected) =====\r\n  app.get(\"/api/proofs\", verifyToken, handleGetProofs);\r\n  app.get(\r\n    \"/api/proofs/notifications\",\r\n    verifyToken,\r\n    handleGetProofNotifications,\r\n  );\r\n  app.get(\"/api/proofs/:proofId\", verifyToken, handleGetProofDetail);\r\n  app.post(\"/api/proofs/:proofId/approve\", verifyToken, handleApproveProof);\r\n  app.post(\"/api/proofs/:proofId/deny\", verifyToken, handleDenyProof);\r\n  app.post(\"/api/proofs/:proofId/comments\", verifyToken, handleAddProofComment);\r\n  app.get(\"/api/proofs/public/:proofId\", handleGetProofDetailPublic);\r\n  app.post(\"/api/proofs/public/:proofId/approve\", handleApproveProofPublic);\r\n  app.post(\"/api/proofs/public/:proofId/deny\", handleDenyProofPublic);\r\n  // New proof routes for public approval page\r\n  app.get(\"/api/proofs/:proofId/public\", handleGetProofDetailPublic);\r\n  app.post(\"/api/proofs/:proofId/approve\", handleApproveProofPublicNew);\r\n  app.post(\"/api/proofs/:proofId/revise\", handleReviseProofPublicNew);\r\n  app.post(\r\n    \"/api/admin/proofs/send\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleSendProofToCustomer,\r\n  );\r\n  app.get(\"/api/admin/proofs\", verifyToken, requireAdmin, handleGetAdminProofs);\r\n  app.get(\r\n    \"/api/admin/proofs/:proofId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetAdminProofDetail,\r\n  );\r\n  app.post(\r\n    \"/api/admin/proofs/:proofId/comments\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleAddAdminProofComment,\r\n  );\r\n  app.post(\r\n    \"/api/send-proof\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleSendProofDirectly,\r\n  );\r\n  // SECURITY: Email preview endpoints require admin authentication\r\n  app.get(\"/api/email-preview/proof\", verifyToken, requireAdmin, handleProofEmailPreview);\r\n  app.post(\"/api/email-preview/send\", verifyToken, requireAdmin, handleSendProofEmailPreview);\r\n  app.get(\"/api/email-preview/signup\", verifyToken, requireAdmin, handleSignupConfirmationPreview);\r\n  app.get(\r\n    \"/api/email-preview/order-confirmation\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleOrderConfirmationPreview,\r\n  );\r\n  app.get(\"/api/email-preview/shipping\", verifyToken, requireAdmin, handleShippingConfirmationPreview);\r\n  app.get(\"/api/email-preview/password-reset\", verifyToken, requireAdmin, handlePasswordResetPreview);\r\n  app.get(\"/api/email-preview/support-reply\", verifyToken, requireAdmin, handleSupportTicketReplyPreview);\r\n  app.get(\r\n    \"/api/email-preview/order-status-update\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleOrderStatusUpdatePreview,\r\n  );\r\n\r\n  // ===== Admin Order Routes (Direct - these paths don't use the router) =====\r\n  // Note: These are separate from /api/admin/orders/* router-based routes\r\n  app.get(\r\n    \"/api/admin/pending-orders\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetAdminPendingOrders,\r\n  );\r\n  app.get(\r\n    \"/api/admin/all-orders\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetAllAdminOrders,\r\n  );\r\n  app.post(\r\n    \"/api/admin/update-order-item-options\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateOrderItemOptions,\r\n  );\r\n\r\n  // ===== Shipping Routes (Protected - admin only) =====\r\n  app.post(\"/api/shipping/label\", verifyToken, requireAdmin, handleCreateLabel);\r\n  app.post(\"/api/shipping/rates\", verifyToken, requireAdmin, handleGetRates);\r\n  app.get(\r\n    \"/api/shipping/carriers\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetCarriers,\r\n  );\r\n  app.get(\r\n    \"/api/shipping/services\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetServices,\r\n  );\r\n\r\n  // ===== Shipping Options Routes (Public - for checkout) =====\r\n  app.get(\"/api/shipping-options\", handleGetPublicShippingOptions);\r\n\r\n  // ===== Shipping Options Routes (Protected - admin only) =====\r\n  app.get(\r\n    \"/api/admin/shipping-options\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetShippingOptions,\r\n  );\r\n  app.get(\r\n    \"/api/admin/shipping-options/:id\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetShippingOption,\r\n  );\r\n  app.post(\r\n    \"/api/admin/shipping-options\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleCreateShippingOption,\r\n  );\r\n  app.put(\r\n    \"/api/admin/shipping-options/:id\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateShippingOption,\r\n  );\r\n  app.delete(\r\n    \"/api/admin/shipping-options/:id\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleDeleteShippingOption,\r\n  );\r\n\r\n  // ===== Discount Code Routes (Public validation) =====\r\n  app.post(\"/api/discounts/validate\", handleValidateDiscountCode);\r\n  app.post(\"/api/discounts/apply\", handleApplyDiscountCode);\r\n\r\n  // ===== Discount Code Routes (Protected - admin only) =====\r\n  app.get(\r\n    \"/api/admin/discounts\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetDiscountCodes,\r\n  );\r\n  app.get(\r\n    \"/api/admin/discounts/:id\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetDiscountCode,\r\n  );\r\n  app.post(\r\n    \"/api/admin/discounts\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleCreateDiscountCode,\r\n  );\r\n  app.put(\r\n    \"/api/admin/discounts/:id\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateDiscountCode,\r\n  );\r\n  app.delete(\r\n    \"/api/admin/discounts/:id\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleDeleteDiscountCode,\r\n  );\r\n\r\n  // ===== Webhook Routes =====\r\n  app.post(\"/api/webhooks/ecwid\", handleEcwidOrderWebhook);\r\n  app.get(\"/api/webhooks/health\", handleWebhookHealth);\r\n  app.get(\"/api/webhooks/url\", handleGetWebhookUrl);\r\n  app.get(\r\n    \"/api/webhooks/diagnostic\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleEcwidDiagnostic,\r\n  );\r\n  app.post(\"/api/webhooks/test\", verifyToken, requireAdmin, handleTestWebhook);\r\n\r\n  // ===== Zapier Integration Routes =====\r\n  app.post(\"/api/zapier/webhook\", handleZapierEcwidWebhook);\r\n  app.get(\"/api/zapier/health\", handleZapierHealth);\r\n  app.get(\"/api/zapier/webhook-url\", handleGetZapierWebhookUrl);\r\n\r\n  // ===== Ecwid Migration Routes (Protected - admin only) =====\r\n  app.post(\r\n    \"/api/admin/ecwid/migrate\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleEcwidMigration,\r\n  );\r\n  app.get(\r\n    \"/api/admin/ecwid/migration-status\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetMigrationStatus,\r\n  );\r\n  app.post(\r\n    \"/api/admin/ecwid/import-csv\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleCSVCustomerImport,\r\n  );\r\n\r\n  // ===== Blogs Routes =====\r\n  // Public routes\r\n  app.get(\"/api/blogs\", handleGetPublishedBlogs);\r\n  app.get(\"/api/blogs/:blogId\", handleGetBlogById);\r\n\r\n  // Admin routes (Protected - Admin only)\r\n  app.post(\"/api/admin/blogs\", verifyToken, requireAdmin, handleCreateBlog);\r\n  app.get(\"/api/admin/blogs\", verifyToken, requireAdmin, handleGetAllBlogs);\r\n  app.get(\r\n    \"/api/admin/blogs/:blogId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetAdminBlogById,\r\n  );\r\n  app.put(\r\n    \"/api/admin/blogs/:blogId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateBlog,\r\n  );\r\n  app.delete(\r\n    \"/api/admin/blogs/:blogId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleDeleteBlog,\r\n  );\r\n  app.post(\r\n    \"/api/admin/upload-image\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    upload.single(\"file\"),\r\n    handleUploadBlogImage,\r\n  );\r\n\r\n  // ===== Gallery Routes =====\r\n  app.use(\"/api\", adminGalleryRouter);\r\n\r\n  // Gallery image upload (with multer middleware)\r\n  app.post(\r\n    \"/api/gallery/upload\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    upload.single(\"file\"),\r\n    async (req: any, res: any) => {\r\n      try {\r\n        const { v2: cloudinary } = await import(\"cloudinary\");\r\n        const { processImage: processImageUtil } = await import(\r\n          \"../server/utils/image-processor\"\r\n        );\r\n\r\n        cloudinary.config({\r\n          cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\r\n          api_key: process.env.CLOUDINARY_API_KEY,\r\n          api_secret: process.env.CLOUDINARY_API_SECRET,\r\n        });\r\n\r\n        if (!req.file) {\r\n          return res.status(400).json({ error: \"No file provided\" });\r\n        }\r\n\r\n        // Compress and optimize image (uses sharp if available, falls back to original)\r\n        const compressedBuffer = await processImageUtil(\r\n          req.file.buffer,\r\n          1200,\r\n          800,\r\n        );\r\n\r\n        const b64 = compressedBuffer.toString(\"base64\");\r\n        const dataURI = `data:image/jpeg;base64,${b64}`;\r\n\r\n        const result = await cloudinary.uploader.upload(dataURI, {\r\n          folder: \"sticky-slap/gallery\",\r\n          resource_type: \"auto\",\r\n        });\r\n\r\n        res.json({ imageUrl: result.secure_url });\r\n      } catch (err) {\r\n        console.error(\"Error uploading gallery image:\", err);\r\n        res.status(500).json({ error: \"Failed to upload gallery image\" });\r\n      }\r\n    },\r\n  );\r\n\r\n  // ===== Legal Pages Routes =====\r\n  // Public routes\r\n  app.get(\"/api/legal-pages\", handleGetPublishedLegalPages);\r\n  app.get(\"/api/legal/:pageType\", handleGetLegalPageByType);\r\n\r\n  // Admin routes (Protected - Admin only)\r\n  app.post(\r\n    \"/api/admin/legal-pages\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleCreateLegalPage,\r\n  );\r\n  app.get(\r\n    \"/api/admin/legal-pages\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetAllLegalPages,\r\n  );\r\n  app.get(\r\n    \"/api/admin/legal-pages/:pageId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetAdminLegalPageById,\r\n  );\r\n  app.put(\r\n    \"/api/admin/legal-pages/:pageId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleUpdateLegalPage,\r\n  );\r\n  app.delete(\r\n    \"/api/admin/legal-pages/:pageId\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleDeleteLegalPage,\r\n  );\r\n\r\n  // ===== Return & Refund Policy Routes =====\r\n  // Public route\r\n  app.get(\"/api/return-refund-policy\", getReturnRefundPolicy);\r\n\r\n  // Admin routes (Protected - Admin only)\r\n  app.get(\r\n    \"/api/admin/return-refund-policy\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    getReturnRefundPolicy,\r\n  );\r\n  app.post(\r\n    \"/api/admin/return-refund-policy\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    updateReturnRefundPolicy,\r\n  );\r\n\r\n  // ===== Invoice Routes =====\r\n  // Admin routes (Protected - Admin only)\r\n  app.get(\"/api/admin/invoices\", verifySupabaseToken, handleGetInvoices);\r\n  app.get(\"/api/admin/invoices/:id\", verifySupabaseToken, handleGetInvoice);\r\n  app.post(\"/api/admin/invoices\", verifySupabaseToken, handleCreateInvoice);\r\n  app.put(\"/api/admin/invoices/:id\", verifySupabaseToken, handleUpdateInvoice);\r\n  app.post(\r\n    \"/api/admin/invoices/:id/send\",\r\n    verifySupabaseToken,\r\n    handleSendInvoice,\r\n  );\r\n  app.post(\r\n    \"/api/admin/invoices/:id/mark-paid\",\r\n    verifySupabaseToken,\r\n    handleMarkInvoicePaid,\r\n  );\r\n  app.post(\r\n    \"/api/admin/invoices/:id/cancel\",\r\n    verifySupabaseToken,\r\n    handleCancelInvoice,\r\n  );\r\n  app.get(\r\n    \"/api/admin/invoices/:invoiceId/payment-token\",\r\n    verifyToken,\r\n    requireAdmin,\r\n    handleGetPaymentToken,\r\n  );\r\n\r\n  // Artwork upload routes\r\n  app.post(\r\n    \"/api/admin/invoices/:invoiceId/artwork\",\r\n    verifySupabaseToken,\r\n    uploadMiddleware.single(\"file\"),\r\n    handleUploadArtwork,\r\n  );\r\n  app.get(\r\n    \"/api/admin/invoices/:invoiceId/artwork\",\r\n    verifySupabaseToken,\r\n    handleGetArtwork,\r\n  );\r\n  app.delete(\r\n    \"/api/admin/invoices/artwork/:artworkId\",\r\n    verifySupabaseToken,\r\n    handleDeleteArtwork,\r\n  );\r\n\r\n  // Public routes\r\n  app.get(\"/api/invoice/:token\", handleGetInvoiceByToken);\r\n  app.post(\r\n    \"/api/invoice/:token/create-payment-link\",\r\n    handleCreateInvoicePaymentLink,\r\n  );\r\n\r\n  // Database setup route\r\n  app.post(\r\n    \"/api/admin/setup/init-invoices\",\r\n    requireAdmin,\r\n    handleInitializeInvoicesDatabase,\r\n  );\r\n\r\n  // Global error handler - must be last\r\n  app.use((err: any, _req: any, res: any, _next: any) => {\r\n    console.error(\"Global error handler:\", err);\r\n    const statusCode = err.statusCode || err.status || 500;\r\n    const message = err.message || \"Internal server error\";\r\n    res.status(statusCode).json({\r\n      error: message,\r\n      details: process.env.NODE_ENV === \"development\" ? err.stack : undefined,\r\n    });\r\n  });\r\n\r\n  return app;\r\n}\r\n"],"names":[],"mappings":";;;;AAOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA,sEAAsE;AACtE;AAKA;AAQA;AACA;AAOA;AASA;AAIA;AAOA;AAKA;AAWA;AACA;AAKA;AAKA;AAKA;AAiBA;AACA;AAUA;AAUA;AAKA;AACA;AAaA;AAMA;AACA;AAOA;AAUA;AACA;AASA;AAIA;AAaA;AACA;AAMA;AACA;AAKA;AAQA;AASA;AAKA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA7OA,6BAA6B;AAC7B,wCAA2C;IACzC,8DAA8D;IAC9D,kIAAwB,KAAK,CAAC;IAC5B,mFAAmF;IACrF;AACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA+OO,SAAS;IACd,MAAM,MAAM,IAAA,gKAAO;IAEnB,kDAAkD;IAClD,MAAM,iBAAiB;QACrB,8BAA8B;QAC9B;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA,sBAAsB;QACtB,QAAQ,GAAG,CAAC,YAAY,IAAI;QAC5B;QACA,qBAAqB;QACrB;QACA;QACA,uDAAuD;WACnD,QAAQ,GAAG,CAAC,eAAe,GAC3B,QAAQ,GAAG,CAAC,eAAe,CAAC,KAAK,CAAC,KAAK,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI,MACxD,EAAE;KACP;IAID,0CAA0C;IAC1C,MAAM,mBAAmB,CAAC;QACxB,IAAI,IAAI,UAAU,CAAC,eAAe,CAAC,IAAI,QAAQ,CAAC,SAAS;YACvD,MAAM,SAAS,IAAI,OAAO,CAAC,YAAY;YACvC,IAAI,CAAC,eAAe,QAAQ,CAAC,SAAS;gBACpC,eAAe,IAAI,CAAC;YACtB;QACF;IACF;IAEA,sCAAsC;IACtC;QACE,QAAQ,GAAG,CAAC,YAAY;WACpB,QAAQ,GAAG,CAAC,eAAe,GAC3B,QAAQ,GAAG,CAAC,eAAe,CAAC,KAAK,CAAC,OAClC,EAAE;KACP,CAAC,OAAO,CAAC,CAAC;QACT,IAAI,KAAK;YACP,iBAAiB,IAAI,IAAI;QAC3B;IACF;IAEA,MAAM,cAAc;QAClB,QAAQ,CACN,QACA;YAEA,+DAA+D;YAC/D,IAAI,CAAC,QAAQ;gBACX;;gBAIA,4BAA4B;gBAC5B,OAAO,SAAS,MAAM;YACxB;YAEA,IAAI,eAAe,QAAQ,CAAC,SAAS;gBACnC,SAAS,MAAM;YACjB,OAAO;gBACL,QAAQ,IAAI,CAAC,CAAC,6CAA6C,EAAE,QAAQ,EAAE;oBACrE;oBACA,YAAY,QAAQ,GAAG,CAAC,YAAY;oBACpC,aAAa,QAAQ,GAAG,CAAC,YAAY;gBACvC;gBACA,SAAS,IAAI,MAAM;YACrB;QACF;QACA,aAAa;QACb,sBAAsB;QACtB,SAAS;YAAC;YAAO;YAAQ;YAAO;YAAS;YAAU;SAAU;QAC7D,gBAAgB;YAAC;YAAgB;YAAiB;SAAoB;IACxE;IAEA,QAAQ,GAAG,CAAC,qCAAqC;QAC/C;QACA,aAAa,QAAQ,GAAG,CAAC,YAAY;IACvC;IAEA,6CAA6C;IAC7C,QAAQ,GAAG,CAAC;IACZ,QAAQ,GAAG,CAAC,4BAA4B,QAAQ,GAAG,CAAC,qBAAqB,GAAG,WAAW;IACvF,QAAQ,GAAG,CAAC,0BAA0B,QAAQ,GAAG,CAAC,mBAAmB,GAAG,WAAW;IACnF,QAAQ,GAAG,CAAC,qBAAqB,QAAQ,GAAG,CAAC,cAAc,GAAG,WAAW;IACzE,QAAQ,GAAG,CAAC;IAEZ,aAAa;IACb,IAAI,GAAG,CAAC,IAAA,uJAAI,EAAC;IAEb,kGAAkG;IAClG,IAAI,GAAG,CAAC,CAAC,KAAU,MAAM;QACvB,sEAAsE;QACtE,IAAI,IAAI,IAAI,IAAI,OAAO,QAAQ,CAAC,IAAI,IAAI,GAAG;YACzC,kCAAkC;YAClC,IAAI,IAAI,IAAI,CAAC,MAAM,KAAK,GAAG;gBACzB,IAAI,IAAI,GAAG,CAAC;gBACZ,OAAO;YACT;YAEA,IAAI;gBACF,MAAM,aAAa,IAAI,IAAI,CAAC,QAAQ,CAAC;gBACrC,qCAAqC;gBACrC,IAAI,WAAW,IAAI,GAAG,UAAU,CAAC,QAAQ,WAAW,IAAI,GAAG,UAAU,CAAC,MAAM;oBAC1E,IAAI,IAAI,GAAG,KAAK,KAAK,CAAC;oBACtB,QAAQ,GAAG,CAAC;gBACd;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,kCAAkC;YAChD,2DAA2D;YAC7D;QACF;QACA;IACF;IAEA,IAAI,GAAG,CAAC,gKAAO,CAAC,IAAI,CAAC;QAAE,OAAO;IAAO;IACrC,IAAI,GAAG,CAAC,gKAAO,CAAC,UAAU,CAAC;QAAE,OAAO;QAAQ,UAAU;IAAK;IAE3D,oDAAoD;IACpD;;IAIA,wCAAwC;IACxC,MAAM,SAAS,IAAA,6JAAM,EAAC;QACpB,SAAS,6JAAM,CAAC,aAAa;QAC7B,QAAQ;YAAE,UAAU,KAAK,OAAO;QAAK;QACrC,YAAY,CAAC,KAAK,MAAM;YACtB,IAAI,KAAK,QAAQ,CAAC,UAAU,CAAC,WAAW;gBACtC,GAAG,MAAM;YACX,OAAO;gBACL,GAAG,IAAI,MAAM;YACf;QACF;IACF;IAEA,oEAAoE;IACpE,IAAI,GAAG,CAAC,CAAC,KAAK,KAAK;QACjB,sDAAsD;QACtD,iEAAiE;QACjE,IAAI,SAAS,CACX,2BACA;YACE;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACD,CAAC,IAAI,CAAC;QAGT,iDAAiD;QACjD,uCAAuC;QACvC,IACE,oDAAyB,gBACzB,IAAI,MAAM,CAAC,yBAAyB;;QAQtC,qDAAqD;QACrD,IAAI,SAAS,CAAC,0BAA0B;QACxC,IAAI,SAAS,CAAC,mBAAmB;QACjC,IAAI,SAAS,CAAC,oBAAoB;QAClC,IAAI,SAAS,CAAC,mBAAmB;QAEjC,8DAA8D;QAC9D,IAAI,SAAS,CACX,6BACA;QAGF,qEAAqE;QACrE,IAAI,SAAS,CACX,sBACA;QAGF,mDAAmD;QACnD,IAAI,SAAS,CACX,aACA;QAGF,yCAAyC;QACzC,IAAI,SAAS,CAAC,0BAA0B;QAExC,+CAA+C;QAC/C,IAAI,IAAI,IAAI,CAAC,QAAQ,CAAC,gBAAgB,IAAI,IAAI,CAAC,QAAQ,CAAC,aAAa;YACnE,IAAI,SAAS,CACX,iBACA;YAEF,IAAI,SAAS,CAAC,UAAU;YACxB,IAAI,SAAS,CAAC,WAAW;QAC3B;QAEA;IACF;IAEA,kCAAkC;IAClC,IAAI,GAAG,CAAC,CAAC,KAAU,MAAW,KAAU;QACtC,IAAI,eAAe,eAAe,UAAU,KAAK;YAC/C,QAAQ,KAAK,CAAC,uBAAuB;gBACnC,SAAS,IAAI,OAAO;gBACpB,aAAa,AAAC,IAAY,IAAI,EAAE,YAAY,GAAG;YACjD;YACA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA+B;QACtE;QACA,IAAI,KAAK;YACP,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO,KAAK;QACd;QACA;IACF;IAEA,wBAAwB;IACxB,IAAI,GAAG,CAAC,WAAW,CAAC,MAAM;QACxB,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,QAAQ;YAAM,WAAW,IAAI,OAAO,WAAW;QAAG;IAC3E;IAEA,qBAAqB;IACrB,IAAI,GAAG,CAAC,aAAa,CAAC,MAAM;QAC1B,MAAM,OAAO,QAAQ,GAAG,CAAC,YAAY,IAAI;QACzC,IAAI,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3B;IAEA,2DAA2D;IAC3D,IAAI,GAAG,CAAC,eAAe,CAAC,MAAM;QAC5B,MAAM,kBAAkB;YACtB;YACA;YACA;YACA;YACA;YACA;SACD;QAED,MAAM,cAAc,gBAAgB,MAAM,CAAC,CAAC,IAAM,CAAC,QAAQ,GAAG,CAAC,EAAE;QACjE,MAAM,YAAY,YAAY,MAAM,KAAK;QAEzC,MAAM,SAAS;YACb,QAAQ,YAAY,YAAY;YAChC,WAAW,IAAI,OAAO,WAAW;YACjC,WAAW;YACX,YAAY;gBACV,cAAc,CAAC,CAAC,QAAQ,GAAG,CAAC,YAAY;gBACxC,sBAAsB,CAAC,CAAC,QAAQ,GAAG,CAAC,oBAAoB;gBACxD,YAAY,CAAC,CAAC,QAAQ,GAAG,CAAC,UAAU;gBACpC,cAAc,CAAC,CAAC,QAAQ,GAAG,CAAC,YAAY;gBACxC,UAAU,CAAC,CAAC,QAAQ,GAAG,CAAC,QAAQ;gBAChC,uBAAuB,CAAC,CAAC,QAAQ,GAAG,CAAC,qBAAqB;gBAC1D,qBAAqB,CAAC,CAAC,QAAQ,GAAG,CAAC,mBAAmB;gBACtD,oBAAoB,CAAC,CAAC,QAAQ,GAAG,CAAC,kBAAkB;gBACpD,iBAAiB,CAAC,CAAC,QAAQ,GAAG,CAAC,eAAe;gBAC9C,uBAAuB,CAAC,CAAC,QAAQ,GAAG,CAAC,qBAAqB;YAC5D;YACA,aAAa,uCAAyC,cAAc;QACtE;QAEA,MAAM,aAAa,YAAY,MAAM;QACrC,IAAI,MAAM,CAAC,YAAY,IAAI,CAAC;IAC9B;IAEA,IAAI,GAAG,CAAC,aAAa,+HAAU;IAE/B,4BAA4B;IAC5B,wBAAwB;IACxB,IAAI,GAAG,CAAC,aAAa,IAAA,+IAAgB;IAErC,8BAA8B;IAC9B,IAAI,GAAG,CAAC,kBAAkB,IAAA,uJAAoB,EAAC;IAE/C,oFAAoF;IACpF,IAAI,GAAG,CAAC,eAAe,IAAA,iJAAiB;IACxC,IAAI,GAAG,CAAC,sBAAsB,IAAA,uJAAuB;IAErD,6CAA6C;IAC7C,IAAI,GAAG,CAAC,iBAAiB,IAAA,qJAAmB;IAC5C,IAAI,GAAG,CAAC,uBAAuB,IAAA,0JAAwB;IACvD,IAAI,GAAG,CAAC,wBAAwB,IAAA,2JAAyB;IACzD,IAAI,GAAG,CAAC,mBAAmB,IAAA,wJAAsB;IAEjD,iDAAiD;IACjD,0EAA0E;IAC1E,qFAAqF;IACrF,wCAA2C;QACzC,IAAI,GAAG,CACL,0BACA,oIAAW,EACX,qIAAY,EACZ,2IAAqB;QAEvB,IAAI,GAAG,CAAC,qBAAqB,oIAAW,EAAE,qIAAY,EAAE,uIAAiB;QACzE,QAAQ,GAAG,CAAC;IACd;IAEA,wCAAwC;IACxC,IAAI,GAAG,CAAC,gBAAgB,oIAAW,EAAE,wIAAgB;IACrD,IAAI,GAAG,CAAC,gCAAgC,oIAAW,EAAE,6IAAqB;IAC1E,IAAI,IAAI,CAAC,uBAAuB,oIAAW,EAAE,8IAAsB;IAEnE,mCAAmC;IACnC,IAAI,IAAI,CAAC,aAAa,qIAAgB;IACtC,IAAI,GAAG,CAAC,qBAAqB,kIAAa;IAC1C,IAAI,IAAI,CAAC,2BAA2B,oIAAe;IACnD,IAAI,KAAK,CAAC,sCAAsC,yIAAoB;IACpE,IAAI,MAAM,CAAC,sCAAsC,yIAAoB;IACrE,IAAI,MAAM,CAAC,qBAAqB,oIAAe;IAE/C,kEAAkE;IAClE,IAAI,IAAI,CAAC,iBAAiB,iJAAe,EAAE,uIAAc;IACzD,IAAI,GAAG,CAAC,yBAAyB,iJAAwB;IAEzD,wDAAwD;IAExD,8CAA8C;IAC9C,IAAI,IAAI,CAAC,gBAAgB,0IAAkB;IAC3C,IAAI,GAAG,CAAC,2BAA2B,+IAAuB;IAC1D,IAAI,IAAI,CAAC,kCAAkC,+IAAuB;IAElE,4DAA4D;IAC5D,IAAI,GAAG,CACL,sBACA,oIAAW,EACX,qIAAY,EACZ,6IAAqB;IAEvB,IAAI,KAAK,CACP,uCACA,oIAAW,EACX,qIAAY,EACZ,gJAAwB;IAE1B,IAAI,MAAM,CACR,gCACA,oIAAW,EACX,qIAAY,EACZ,0IAAkB;IAGpB,6CAA6C;IAC7C,kDAAkD;IAClD,IAAI,GAAG,CAAC,8BAA8B,2JAAyB;IAC/D,IAAI,GAAG,CAAC,kCAAkC,uJAAqB;IAC/D,IAAI,GAAG,CAAC,uBAAuB,yJAAuB;IAEtD,uCAAuC;IACvC,IAAI,GAAG,CAAC,0BAA0B,oJAAiB;IACnD,IAAI,IAAI,CACN,wBACA,oIAAW,EACX,qIAAY,EACZ,uJAAoB;IAEtB,IAAI,MAAM,CACR,8BACA,oIAAW,EACX,qIAAY,EACZ,0JAAuB;IAGzB,+FAA+F;IAE/F,uCAAuC;IACvC,IAAI,GAAG,CAAC,yBAAyB,gJAAuB;IACxD,IAAI,IAAI,CAAC,yBAAyB,gJAAc,EAAE,6IAAoB;IAEtE,6CAA6C;IAC7C,IAAI,GAAG,CAAC,sBAAsB,4IAAqB;IACnD,IAAI,GAAG,CAAC,yBAAyB,+IAAwB;IACzD,IAAI,GAAG,CAAC,oBAAoB,6IAAsB;IAClD,IAAI,IAAI,CACN,wBACA,iJAAe,EACf,kJAA2B;IAE7B,IAAI,IAAI,CACN,gCACA,gJAAc,EACd,4IAAqB;IAEvB,IAAI,IAAI,CAAC,mBAAmB,gJAAc,EAAE,0IAAmB;IAC/D,IAAI,IAAI,CAAC,+BAA+B,gJAAc,EAAE,sJAAoB;IAC5E,IAAI,IAAI,CAAC,8BAA8B,gJAAc,EAAE,0IAAmB;IAC1E,IAAI,IAAI,CAAC,wBAAwB,0IAAmB;IACpD,IAAI,IAAI,CACN,sCACA,oIAAW,EACX,qIAAY,EACZ,iJAA0B;IAG5B,oDAAoD;IACpD,uDAAuD;IACvD,IAAI,GAAG,CACL,8BACA,oIAAW,EACX,qIAAY,EACZ,oJAAoB;IAGtB,2CAA2C;IAC3C,IAAI,GAAG,CACL,qCACA,oIAAW,EACX,qIAAY,EACZ,uJAAuB;IAEzB,IAAI,GAAG,CACL,+CACA,oIAAW,EACX,qIAAY,EACZ,2JAA2B;IAG7B,IAAI,GAAG,CACL,wBACA,oIAAW,EACX,qIAAY,EACZ,wJAAqB;IAEvB,IAAI,GAAG,CACL,+BACA,oIAAW,EACX,qIAAY,EACZ,wJAAqB;IAEvB,IAAI,GAAG,CACL,oCACA,oIAAW,EACX,qIAAY,EACZ,2JAAwB;IAE1B,IAAI,GAAG,CACL,wBACA,oIAAW,EACX,qIAAY,EACZ,qJAAkB;IAEpB,IAAI,IAAI,CAAC,wBAAwB,mJAAgB;IACjD,IAAI,GAAG,CAAC,sBAAsB,oIAAW,EAAE,qIAAY,EAAE,iJAAgB;IAEzE,8DAA8D;IAE9D,2DAA2D;IAC3D,IAAI,GAAG,CACL,+BACA,oIAAW,EACX,qIAAY,EACZ,2JAA2B;IAE7B,IAAI,GAAG,CACL,iCACA,oIAAW,EACX,qIAAY,EACZ,uJAAuB;IAEzB,IAAI,GAAG,CACL,yCACA,oIAAW,EACX,qIAAY,EACZ,sJAAsB;IAExB,IAAI,IAAI,CACN,4BACA,oIAAW,EACX,qIAAY,EACZ,uJAAuB;IAEzB,IAAI,IAAI,CACN,oCACA,oIAAW,EACX,qIAAY,EACZ,6JAA6B;IAG/B,6BAA6B;IAC7B,IAAI,IAAI,CAAC,uBAAuB,2IAAmB;IACnD,IAAI,GAAG,CAAC,wBAAwB,oIAAW,EAAE,wIAAgB;IAC7D,IAAI,GAAG,CACL,kCACA,oIAAW,EACX,8IAAsB;IAExB,IAAI,IAAI,CACN,wCACA,oIAAW,EACX,mJAA2B;IAE7B,IAAI,GAAG,CACL,sBACA,oIAAW,EACX,qIAAY,EACZ,gJAAwB;IAE1B,IAAI,IAAI,CACN,sCACA,oIAAW,EACX,qIAAY,EACZ,gJAAwB;IAE1B,IAAI,KAAK,CACP,uCACA,oIAAW,EACX,qIAAY,EACZ,gJAAwB;IAG1B,mCAAmC;IACnC,IAAI,IAAI,CAAC,8BAA8B,oIAAW,EAAE,wJAAuB;IAC3E,IAAI,GAAG,CAAC,8BAA8B,oIAAW,EAAE,oJAAmB;IACtE,IAAI,MAAM,CAAC,sBAAsB,oIAAW,EAAE,wJAAuB;IAErE,wCAAwC;IACxC,IAAI,GAAG,CAAC,eAAe,oIAAW,EAAE,sIAAe;IACnD,IAAI,GAAG,CACL,6BACA,oIAAW,EACX,kJAA2B;IAE7B,IAAI,GAAG,CAAC,wBAAwB,oIAAW,EAAE,2IAAoB;IACjE,IAAI,IAAI,CAAC,gCAAgC,oIAAW,EAAE,yIAAkB;IACxE,IAAI,IAAI,CAAC,6BAA6B,oIAAW,EAAE,sIAAe;IAClE,IAAI,IAAI,CAAC,iCAAiC,oIAAW,EAAE,4IAAqB;IAC5E,IAAI,GAAG,CAAC,+BAA+B,iJAA0B;IACjE,IAAI,IAAI,CAAC,uCAAuC,+IAAwB;IACxE,IAAI,IAAI,CAAC,oCAAoC,4IAAqB;IAClE,4CAA4C;IAC5C,IAAI,GAAG,CAAC,+BAA+B,iJAA0B;IACjE,IAAI,IAAI,CAAC,gCAAgC,kJAA2B;IACpE,IAAI,IAAI,CAAC,+BAA+B,iJAA0B;IAClE,IAAI,IAAI,CACN,0BACA,oIAAW,EACX,qIAAY,EACZ,gJAAyB;IAE3B,IAAI,GAAG,CAAC,qBAAqB,oIAAW,EAAE,qIAAY,EAAE,2IAAoB;IAC5E,IAAI,GAAG,CACL,8BACA,oIAAW,EACX,qIAAY,EACZ,gJAAyB;IAE3B,IAAI,IAAI,CACN,uCACA,oIAAW,EACX,qIAAY,EACZ,iJAA0B;IAE5B,IAAI,IAAI,CACN,mBACA,oIAAW,EACX,qIAAY,EACZ,qJAAuB;IAEzB,iEAAiE;IACjE,IAAI,GAAG,CAAC,4BAA4B,oIAAW,EAAE,qIAAY,EAAE,wJAAuB;IACtF,IAAI,IAAI,CAAC,2BAA2B,oIAAW,EAAE,qIAAY,EAAE,4JAA2B;IAC1F,IAAI,GAAG,CAAC,6BAA6B,oIAAW,EAAE,qIAAY,EAAE,gKAA+B;IAC/F,IAAI,GAAG,CACL,yCACA,oIAAW,EACX,qIAAY,EACZ,+JAA8B;IAEhC,IAAI,GAAG,CAAC,+BAA+B,oIAAW,EAAE,qIAAY,EAAE,kKAAiC;IACnG,IAAI,GAAG,CAAC,qCAAqC,oIAAW,EAAE,qIAAY,EAAE,2JAA0B;IAClG,IAAI,GAAG,CAAC,oCAAoC,oIAAW,EAAE,qIAAY,EAAE,gKAA+B;IACtG,IAAI,GAAG,CACL,0CACA,oIAAW,EACX,qIAAY,EACZ,+JAA8B;IAGhC,6EAA6E;IAC7E,wEAAwE;IACxE,IAAI,GAAG,CACL,6BACA,oIAAW,EACX,qIAAY,EACZ,2JAA2B;IAE7B,IAAI,GAAG,CACL,yBACA,oIAAW,EACX,qIAAY,EACZ,uJAAuB;IAEzB,IAAI,IAAI,CACN,wCACA,oIAAW,EACX,qIAAY,EACZ,4JAA4B;IAG9B,uDAAuD;IACvD,IAAI,IAAI,CAAC,uBAAuB,oIAAW,EAAE,qIAAY,EAAE,0IAAiB;IAC5E,IAAI,IAAI,CAAC,uBAAuB,oIAAW,EAAE,qIAAY,EAAE,uIAAc;IACzE,IAAI,GAAG,CACL,0BACA,oIAAW,EACX,qIAAY,EACZ,0IAAiB;IAEnB,IAAI,GAAG,CACL,0BACA,oIAAW,EACX,qIAAY,EACZ,0IAAiB;IAGnB,8DAA8D;IAC9D,IAAI,GAAG,CAAC,yBAAyB,iKAA8B;IAE/D,+DAA+D;IAC/D,IAAI,GAAG,CACL,+BACA,oIAAW,EACX,qIAAY,EACZ,0JAAwB;IAE1B,IAAI,GAAG,CACL,mCACA,oIAAW,EACX,qIAAY,EACZ,yJAAuB;IAEzB,IAAI,IAAI,CACN,+BACA,oIAAW,EACX,qIAAY,EACZ,4JAA0B;IAE5B,IAAI,GAAG,CACL,mCACA,oIAAW,EACX,qIAAY,EACZ,4JAA0B;IAE5B,IAAI,MAAM,CACR,mCACA,oIAAW,EACX,qIAAY,EACZ,4JAA0B;IAG5B,uDAAuD;IACvD,IAAI,IAAI,CAAC,2BAA2B,oJAA0B;IAC9D,IAAI,IAAI,CAAC,wBAAwB,iJAAuB;IAExD,4DAA4D;IAC5D,IAAI,GAAG,CACL,wBACA,oIAAW,EACX,qIAAY,EACZ,gJAAsB;IAExB,IAAI,GAAG,CACL,4BACA,oIAAW,EACX,qIAAY,EACZ,+IAAqB;IAEvB,IAAI,IAAI,CACN,wBACA,oIAAW,EACX,qIAAY,EACZ,kJAAwB;IAE1B,IAAI,GAAG,CACL,4BACA,oIAAW,EACX,qIAAY,EACZ,kJAAwB;IAE1B,IAAI,MAAM,CACR,4BACA,oIAAW,EACX,qIAAY,EACZ,kJAAwB;IAG1B,6BAA6B;IAC7B,IAAI,IAAI,CAAC,uBAAuB,gJAAuB;IACvD,IAAI,GAAG,CAAC,wBAAwB,4IAAmB;IACnD,IAAI,GAAG,CAAC,qBAAqB,4IAAmB;IAChD,IAAI,GAAG,CACL,4BACA,oIAAW,EACX,qIAAY,EACZ,8IAAqB;IAEvB,IAAI,IAAI,CAAC,sBAAsB,oIAAW,EAAE,qIAAY,EAAE,0IAAiB;IAE3E,wCAAwC;IACxC,IAAI,IAAI,CAAC,uBAAuB,+IAAwB;IACxD,IAAI,GAAG,CAAC,sBAAsB,yIAAkB;IAChD,IAAI,GAAG,CAAC,2BAA2B,gJAAyB;IAE5D,8DAA8D;IAC9D,IAAI,IAAI,CACN,4BACA,oIAAW,EACX,qIAAY,EACZ,uJAAoB;IAEtB,IAAI,GAAG,CACL,qCACA,oIAAW,EACX,qIAAY,EACZ,2JAAwB;IAE1B,IAAI,IAAI,CACN,+BACA,oIAAW,EACX,qIAAY,EACZ,0JAAuB;IAGzB,2BAA2B;IAC3B,gBAAgB;IAChB,IAAI,GAAG,CAAC,cAAc,6IAAuB;IAC7C,IAAI,GAAG,CAAC,sBAAsB,uIAAiB;IAE/C,wCAAwC;IACxC,IAAI,IAAI,CAAC,oBAAoB,oIAAW,EAAE,qIAAY,EAAE,sIAAgB;IACxE,IAAI,GAAG,CAAC,oBAAoB,oIAAW,EAAE,qIAAY,EAAE,uIAAiB;IACxE,IAAI,GAAG,CACL,4BACA,oIAAW,EACX,qIAAY,EACZ,4IAAsB;IAExB,IAAI,GAAG,CACL,4BACA,oIAAW,EACX,qIAAY,EACZ,sIAAgB;IAElB,IAAI,MAAM,CACR,4BACA,oIAAW,EACX,qIAAY,EACZ,sIAAgB;IAElB,IAAI,IAAI,CACN,2BACA,oIAAW,EACX,qIAAY,EACZ,OAAO,MAAM,CAAC,SACd,2IAAqB;IAGvB,6BAA6B;IAC7B,IAAI,GAAG,CAAC,QAAQ,wIAAkB;IAElC,gDAAgD;IAChD,IAAI,IAAI,CACN,uBACA,oIAAW,EACX,qIAAY,EACZ,OAAO,MAAM,CAAC,SACd,OAAO,KAAU;QACf,IAAI;YACF,MAAM,EAAE,IAAI,UAAU,EAAE,GAAG;YAC3B,MAAM,EAAE,cAAc,gBAAgB,EAAE,GAAG;YAI3C,WAAW,MAAM,CAAC;gBAChB,YAAY,QAAQ,GAAG,CAAC,qBAAqB;gBAC7C,SAAS,QAAQ,GAAG,CAAC,kBAAkB;gBACvC,YAAY,QAAQ,GAAG,CAAC,qBAAqB;YAC/C;YAEA,IAAI,CAAC,IAAI,IAAI,EAAE;gBACb,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;oBAAE,OAAO;gBAAmB;YAC1D;YAEA,gFAAgF;YAChF,MAAM,mBAAmB,MAAM,iBAC7B,IAAI,IAAI,CAAC,MAAM,EACf,MACA;YAGF,MAAM,MAAM,iBAAiB,QAAQ,CAAC;YACtC,MAAM,UAAU,CAAC,uBAAuB,EAAE,KAAK;YAE/C,MAAM,SAAS,MAAM,WAAW,QAAQ,CAAC,MAAM,CAAC,SAAS;gBACvD,QAAQ;gBACR,eAAe;YACjB;YAEA,IAAI,IAAI,CAAC;gBAAE,UAAU,OAAO,UAAU;YAAC;QACzC,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,kCAAkC;YAChD,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAiC;QACjE;IACF;IAGF,iCAAiC;IACjC,gBAAgB;IAChB,IAAI,GAAG,CAAC,oBAAoB,2JAA4B;IACxD,IAAI,GAAG,CAAC,wBAAwB,uJAAwB;IAExD,wCAAwC;IACxC,IAAI,IAAI,CACN,0BACA,oIAAW,EACX,qIAAY,EACZ,oJAAqB;IAEvB,IAAI,GAAG,CACL,0BACA,oIAAW,EACX,qIAAY,EACZ,qJAAsB;IAExB,IAAI,GAAG,CACL,kCACA,oIAAW,EACX,qIAAY,EACZ,0JAA2B;IAE7B,IAAI,GAAG,CACL,kCACA,oIAAW,EACX,qIAAY,EACZ,oJAAqB;IAEvB,IAAI,MAAM,CACR,kCACA,oIAAW,EACX,qIAAY,EACZ,oJAAqB;IAGvB,4CAA4C;IAC5C,eAAe;IACf,IAAI,GAAG,CAAC,6BAA6B,yKAAqB;IAE1D,wCAAwC;IACxC,IAAI,GAAG,CACL,mCACA,oIAAW,EACX,qIAAY,EACZ,yKAAqB;IAEvB,IAAI,IAAI,CACN,mCACA,oIAAW,EACX,qIAAY,EACZ,4KAAwB;IAG1B,6BAA6B;IAC7B,wCAAwC;IACxC,IAAI,GAAG,CAAC,uBAAuB,4IAAmB,EAAE,0IAAiB;IACrE,IAAI,GAAG,CAAC,2BAA2B,4IAAmB,EAAE,yIAAgB;IACxE,IAAI,IAAI,CAAC,uBAAuB,4IAAmB,EAAE,4IAAmB;IACxE,IAAI,GAAG,CAAC,2BAA2B,4IAAmB,EAAE,4IAAmB;IAC3E,IAAI,IAAI,CACN,gCACA,4IAAmB,EACnB,0IAAiB;IAEnB,IAAI,IAAI,CACN,qCACA,4IAAmB,EACnB,8IAAqB;IAEvB,IAAI,IAAI,CACN,kCACA,4IAAmB,EACnB,4IAAmB;IAErB,IAAI,GAAG,CACL,gDACA,oIAAW,EACX,qIAAY,EACZ,8IAAqB;IAGvB,wBAAwB;IACxB,IAAI,IAAI,CACN,0CACA,4IAAmB,EACnB,mJAAgB,CAAC,MAAM,CAAC,SACxB,sJAAmB;IAErB,IAAI,GAAG,CACL,0CACA,4IAAmB,EACnB,mJAAgB;IAElB,IAAI,MAAM,CACR,0CACA,4IAAmB,EACnB,sJAAmB;IAGrB,gBAAgB;IAChB,IAAI,GAAG,CAAC,uBAAuB,gJAAuB;IACtD,IAAI,IAAI,CACN,2CACA,uJAA8B;IAGhC,uBAAuB;IACvB,IAAI,IAAI,CACN,kCACA,qIAAY,EACZ,4JAAgC;IAGlC,sCAAsC;IACtC,IAAI,GAAG,CAAC,CAAC,KAAU,MAAW,KAAU;QACtC,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM,aAAa,IAAI,UAAU,IAAI,IAAI,MAAM,IAAI;QACnD,MAAM,UAAU,IAAI,OAAO,IAAI;QAC/B,IAAI,MAAM,CAAC,YAAY,IAAI,CAAC;YAC1B,OAAO;YACP,SAAS,uCAAyC,IAAI,KAAK,GAAG;QAChE;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 18373, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/atrin/Desktop/PRODUCTS/cyan/prd/pages/api/%5B...slug%5D.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\r\nimport serverless from 'serverless-http';\r\nimport { createServer } from '../../server/index';\r\n\r\n// Initialize the Express app\r\nconst app = createServer();\r\n\r\n// Create the serverless handler\r\nconst handler = serverless(app);\r\n\r\n// Disable Next.js body parsing to let Express handle it\r\nexport const config = {\r\n    api: {\r\n        bodyParser: false,\r\n        externalResolver: true,\r\n    },\r\n};\r\n\r\nexport default async function (req: NextApiRequest, res: NextApiResponse) {\r\n    // Add protocol if missing (fix for some internal redirects)\r\n    if (!req.url?.startsWith('http')) {\r\n        // @ts-ignore\r\n        req.protocol = 'https';\r\n    }\r\n\r\n    return handler(req, res);\r\n}\r\n"],"names":[],"mappings":";;;;;;AACA;AACA;;;;;;;AAEA,6BAA6B;AAC7B,MAAM,MAAM,IAAA,wHAAY;AAExB,gCAAgC;AAChC,MAAM,UAAU,IAAA,iMAAU,EAAC;AAGpB,MAAM,SAAS;IAClB,KAAK;QACD,YAAY;QACZ,kBAAkB;IACtB;AACJ;AAEe,8CAAgB,GAAmB,EAAE,GAAoB;IACpE,4DAA4D;IAC5D,IAAI,CAAC,IAAI,GAAG,EAAE,WAAW,SAAS;QAC9B,aAAa;QACb,IAAI,QAAQ,GAAG;IACnB;IAEA,OAAO,QAAQ,KAAK;AACxB"}}]
}